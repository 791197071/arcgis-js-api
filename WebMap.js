// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/tsSupport/generatorHelper","./core/tsSupport/awaiterHelper","./core/tsSupport/paramHelper","./kernel","./Map","./Viewpoint","./core/arrayUtils","./core/asyncUtils","./core/Collection","./core/Error","./core/JSONSupport","./core/Loadable","./core/loadAll","./core/Logger","./core/maybe","./core/Promise","./core/promiseUtils","./core/urlUtils","./core/watchUtils","./core/accessorSupport/decorators","./core/accessorSupport/originUtils","./core/accessorSupport/read","./geometry/SpatialReference","./geometry/support/webMercatorUtils","./portal/Portal","./portal/PortalItem","./tasks/support/ProjectParameters","./webdoc/RangeInfo","./webdoc/Widgets","./webdoc/support/thumbnailUtils","./webdoc/support/writeUtils","./webmap/ApplicationProperties","./webmap/Bookmark","./webmap/InitialViewProperties","./webmap/Version","./webmap/background/ColorBackground","@dojo/framework/shim/Promise"],function(e,t,r,i,o,n,a,p,s,u,l,c,h,d,m,y,f,g,w,b,v,_,S,I,A,P,V,U,O,T,F,N,R,j,W,J,L,x,M,k,B){var C=new k.default(2,15),E=d.ofType(x),G=w.getLogger("esri.WebMap"),D=new Map;return D.set("image/jpeg","jpeg"),D.set("image/jpg","jpg"),D.set("image/png","png"),D.set("image/gif","gif"),function(t){function u(e){var r=t.call(this)||this;return r.applicationProperties=null,r.bookmarks=new E,r.initialViewProperties=new M,r.portalItem=null,r.presentation=null,r.sourceVersion=null,r.tables=null,r.widgets=null,r.authoringApp=r.authoringAppVersion=null,r._isAuthoringAppSetByUser=r._isAuthoringAppVersionSetByUser=!1,r}return i(u,t),u.prototype.initialize=function(){if(this.when().catch(function(e){G.error("#load()","Failed to load web map",e)}),this.resourceInfo){var e=void 0;try{e=this._validateJSON(this.resourceInfo)}catch(e){return void this.addResolvingPromise(_.reject(e))}this.read(e)}},Object.defineProperty(u.prototype,"authoringApp",{set:function(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)},enumerable:!0,configurable:!0}),u.prototype.writeAuthoringApp=function(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"},Object.defineProperty(u.prototype,"authoringAppVersion",{set:function(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)},enumerable:!0,configurable:!0}),u.prototype.writeAuthoringAppVersion=function(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=s.version},u.prototype.readInitialViewProperties=function(e,t){var r=new M;return t.background&&(r.background=B.fromJSON(t.background)),t.mapRangeInfo&&(r.rangeInfo=R.fromJSON(t.mapRangeInfo)),t.spatialReference&&(r.spatialReference=U.fromJSON(t.spatialReference)),r},u.prototype.writeInitialViewProperties=function(e,t,r,i){if(e){var o=e.background;o&&o.color&&(t.background=o.write(null,i)),e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(i)),e.spatialReference&&(t.spatialReference=e.spatialReference.write(null,i))}},u.prototype.writeLayers=function(e,t,i,o){var n=this;o=r({},o,{layerContainerType:"operational-layers"});var a=e.map(function(e){return J.getLayerJSON(e,n._getLayerJSONFromResourceInfo(e),o)}).filter(function(e){return!!e});t[i]=a.toArray()},u.prototype.readSourceVersion=function(e,t){var r=t.version.split("."),i=r[0],o=r[1];return new k.default(parseInt(i,10),parseInt(o,10))},u.prototype.writeSourceVersion=function(e,t,r){t[r]=C.major+"."+C.minor},Object.defineProperty(u.prototype,"thumbnailUrl",{get:function(){return this.portalItem&&this.portalItem.thumbnailUrl||null},set:function(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()},enumerable:!0,configurable:!0}),u.prototype.load=function(e){return this.addResolvingPromise(this._loadFromSource()),this.when()},u.prototype.loadAll=function(){var e=this;return h.safeCast(g.loadAll(this,function(t){t(e.ground,e.basemap,e.layers)}))},u.prototype.read=function(e,t){var i=this;t=r({},t,{origin:"web-map"});var o=this._getAuthoringPropsState(),n=arguments;V.readLoadable(this,e,function(t){return i.inherited(n,[e,t])},t),this._restoreAuthoringPropsFromState(o)},u.prototype.write=function(e,t){if("loaded"!==this.loadStatus){var i=new m("webmap:not-loaded","Web map must be loaded before it can be serialized");throw G.error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),i}return this._removeDanglingLayerRefs(),t=r({},t,{origin:"web-map",restrictedWebMapWriting:!0}),this.inherited(arguments,[e,t])},u.prototype.save=function(e){return a(this,void 0,void 0,function(){var t,r,i;return n(this,function(o){switch(o.label){case 0:return e=e||{},this._validateItem(),[4,this.load()];case 1:return o.sent(),[4,this._loadLayerContainers()];case 2:return o.sent(),t=this.portalItem,r={origin:"web-map",messages:[],writtenProperties:[],url:t.itemUrl&&S.urlToObject(t.itemUrl),portal:t.portal||T.getDefault()},i=this.write(null,r),this._validateJSONForWriting(r,e),[4,this._updateItemProperties(t)];case 3:return o.sent(),[4,this._updateItem(t,i,r)];case 4:return o.sent(),[4,this._updateItemThumbnail()];case 5:return o.sent(),[2,t]}})})},u.prototype.saveAs=function(e,t){return a(this,void 0,void 0,function(){var r,i,o;return n(this,function(n){switch(n.label){case 0:return t=t||{},e=this._getPortalItem(e),[4,this.load()];case 1:return n.sent(),[4,this._loadLayerContainers()];case 2:return n.sent(),r={origin:"web-map",messages:[],writtenProperties:[],url:null,portal:e.portal},i=this.write(null,r),this._validateJSONForWriting(r,t),[4,this._updateItemProperties(e)];case 3:return n.sent(),o=this._getThumbnailState(),[4,this._createItem(e,i,r,t)];case 4:return n.sent(),this._restoreThumbnailFromState(o),[4,this._updateItemThumbnail()];case 5:return n.sent(),[2,e]}})})},u.prototype.updateFrom=function(e,t){return a(this,void 0,void 0,function(){return n(this,function(r){switch(r.label){case 0:return t=t||{},[4,I.whenTrueOnce(e,"ready")];case 1:return r.sent(),this._updateInitialViewProperties(e,t),[4,this._updateThumbnailUrl(e,t)];case 2:return r.sent(),[2]}})})},u.prototype._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-map"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):_.resolve(null)},u.prototype._loadFromItem=function(e){var t=this;return e.load().catch(function(e){throw new m("webmap:load-portal-item","Failed to load portal item",{error:e})}).then(function(){if("Web Map"!==e.type)throw new m("webmap:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Map'",{type:e.type})}).then(function(){return e.fetchData()}).then(function(r){return t.resourceInfo=r,t._readAndLoadFromJSON(r,{origin:"web-map",portal:e.portal||T.getDefault()})}).then(function(){return h.safeCast(t._getInitialExtent())}).then(function(e){if(e){var r=t.initialViewProperties?t.initialViewProperties.clone():new M;r.viewpoint=new l,r.viewpoint.targetGeometry=e,t.initialViewProperties=r}})},u.prototype._readAndLoadFromJSON=function(e,t){var r=this._validateJSON(e);return this.read(r,t),this._loadFromJSON(r,t)},u.prototype._validateJSON=function(e){var t=k.default.parse(e.version||"","webmap");return C.validate(t),e.version=t.major+"."+t.minor,e},u.prototype._loadFromJSON=function(t,i){var o=this,n={context:r({},i,{layerContainerType:"operational-layers"})};return this.portalItem&&(n.context.portal=this.portalItem.portal||T.getDefault()),_.create(function(t){return e(["./portal/support/layersCreator"],t)}).then(function(e){var r=[],i=t.operationalLayers;return i&&i.length&&r.push(h.safeCast(e.populateOperationalLayers(o.layers,i,n))),_.eachAlways(r).then(function(){})})},u.prototype._getInitialExtent=function(){return a(this,void 0,void 0,function(){var t,r,i;return n(this,function(o){switch(o.label){case 0:return t=this.initialViewProperties&&this.initialViewProperties.spatialReference,r=this.portalItem&&this.portalItem.extent,t&&r?t.isWGS84?[2,r.clone()]:t.isWebMercator?[2,O.geographicToWebMercator(r)]:[4,new Promise(function(t,r){e(["./portal/support/geometryServiceUtils"],t,r)})]:[3,2];case 1:return i=o.sent(),[2,h.safeCast(i.create(this.portalItem)).then(function(e){var i=new N;return i.geometries=[r],i.outSpatialReference=t,e.project(i)}).then(function(e){return e[0]}).catch(function(e){return G.error("Error projecting item's extent:",e),null})];case 2:return[2,null]}})})},u.prototype._getLayerJSONFromResourceInfo=function(e){var t=this.get("resourceInfo.operationalLayers");return b.isSome(t)?c.find(t,function(t){return t.id===e.id}):null},u.prototype._removeDanglingLayerRefs=function(){var e=this,t=function(t){return!!e.allLayers.find(function(e){return e.id===t})},r=this.applicationProperties,i=r&&r.viewing&&r.viewing.search;i&&i.layers&&(i.layers=i.layers.filter(function(e){return t(e.id)}));var o=r&&r.editing&&r.editing.locationTracking;o&&o.info&&!t(o.info.layerId)&&(r.editing=null);var n=this.presentation&&this.presentation.slides;n&&n.forEach(function(e){e.visibleLayers&&(e.visibleLayers=e.visibleLayers.filter(function(e){return t(e.id)}))})},u.prototype._validateItem=function(){if(!this.portalItem)throw G.error("save: requires the portalItem property to be set"),new m("webmap:portal-item-not-set","Portal item to save to has not been set on the WebMap");this._validateItemType(this.portalItem)},u.prototype._validateItemType=function(e){if("Web Map"!==e.type)throw new m("webmap:portal-item-wrong-type",'Portal item needs to have type "Web Map"')},u.prototype._loadLayerContainers=function(){var e=[];return this.basemap&&e.push(this.basemap.load()),this.ground&&e.push(this.ground.load()),_.eachAlways(e).then(function(){})},u.prototype._validateJSONForWriting=function(e,t){var r=e.messages.filter(function(e){return"error"===e.type}).map(function(e){return new m(e.name,e.message,e.details)});if(t.ignoreUnsupported&&(r=r.filter(function(e){return"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name&&"symbol-layer:unsupported"!==e.name&&"property:unsupported"!==e.name&&"url:unsupported"!==e.name})),r.length>0)throw new m("webmap:save","Failed to save webmap due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})},u.prototype._updateItemProperties=function(e){return a(this,void 0,void 0,function(){var t;return n(this,function(r){switch(r.label){case 0:return t=e,[4,this._getWGS84Extent(this.initialViewProperties.viewpoint.targetGeometry)];case 1:return t.extent=r.sent(),this._updateTypeKeywords(e),[2]}})})},u.prototype._getWGS84Extent=function(t){return a(this,void 0,void 0,function(){var r,i,o,a,p;return n(this,function(n){switch(n.label){case 0:return r=t.spatialReference,r.isWGS84?[2,t.clone()]:r.isWebMercator?[2,O.webMercatorToGeographic(t)]:[4,new Promise(function(t,r){e(["./portal/support/geometryServiceUtils"],t,r)})];case 1:return i=n.sent(),[4,i.create(this.portalItem)];case 2:return o=n.sent(),a=new N,a.geometries=[t],a.outSpatialReference=U.WGS84,[4,o.project(a)];case 3:return p=n.sent(),[2,p[0]]}})})},u.prototype._updateTypeKeywords=function(e){this._addTypeKeyword(e,"ArcGIS API for JavaScript"),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(function(e,t,r){return r.indexOf(e)===t}))},u.prototype._addTypeKeyword=function(e,t){var r=e.typeKeywords;r?-1===r.indexOf(t)&&r.push(t):e.typeKeywords=[t]},u.prototype._updateItem=function(e,t,r){return a(this,void 0,void 0,function(){return n(this,function(i){switch(i.label){case 0:return[4,e.update({data:t})];case 1:return i.sent(),this._syncUpInstanceWithItem(e,t,r),[2]}})})},u.prototype._createItem=function(e,t,r,i){return a(this,void 0,void 0,function(){return n(this,function(o){switch(o.label){case 0:return[4,e.portal._signIn()];case 1:return o.sent(),[4,e.portal.user.addItem({item:e,folder:i.folder,data:t})];case 2:return o.sent(),this.portalItem=e,this._syncUpInstanceWithItem(e,t,r),[2]}})})},u.prototype._syncUpInstanceWithItem=function(e,t,r){y.JSONSupport.prototype.read.call(this,{version:t.version,authoringApp:t.authoringApp,authoringAppVersion:t.authoringAppVersion},{origin:"web-map",ignoreDefaults:!0,url:e.itemUrl&&S.urlToObject(e.itemUrl)}),P.updateOrigins(r),this.resourceInfo=t},u.prototype._updateItemThumbnail=function(){return a(this,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return this.thumbnailUrl&&this._isOverridden("thumbnailUrl")?[4,this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename})]:[3,2];case 1:e.sent(),this._clearThumbnailOverride(),e.label=2;case 2:return[2]}})})},u.prototype._getPortalItem=function(e){return e.id&&(e=e.clone(),e.id=null),e.type||(e.type="Web Map"),e.portal||(e.portal=T.getDefault()),this._validateItemType(e),e},u.prototype._updateInitialViewProperties=function(e,t){this.initialViewProperties.spatialReference=e.spatialReference.clone(),t.viewpointExcluded||(this.initialViewProperties.viewpoint=new l({targetGeometry:this._getViewExtent(e)}))},u.prototype._getViewExtent=function(e){var t,r=e.extent.clone().normalize();if(r.length>1)for(var i=0,o=r;i<o.length;i++){var n=o[i];t?n.width>t.width&&(t=n):t=n}else t=r[0];return t},u.prototype._updateThumbnailUrl=function(e,t){return a(this,void 0,void 0,function(){var r,i;return n(this,function(o){switch(o.label){case 0:return t.thumbnailExcluded?[2]:(r=W.getOptimalThumbnailSize(e,t.thumbnailSize),[4,e.takeScreenshot({format:"png",width:r.width,height:r.height})]);case 1:return i=o.sent(),this._setAutoGeneratedThumbnail(i.dataUrl),[2]}})})},u.prototype._setAutoGeneratedThumbnail=function(e){this.thumbnailUrl=e,this._thumbnailFilename=null},u.prototype._clearThumbnailOverride=function(){this._clearOverride("thumbnailUrl"),this._thumbnailFilename=null},u.prototype._generateCustomThumbnailFilename=function(e){if(S.isDataProtocol(e)){var t=S.dataComponents(e),r=t&&t.mediaType,i=r&&D.get(r.toLowerCase())||null,o="thumbnail"+Date.now();return i?o+"."+i:o}return null},u.prototype._getThumbnailState=function(){var e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:S.addQueryParameter(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}},u.prototype._restoreThumbnailFromState=function(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename},u.prototype._getAuthoringPropsState=function(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}},u.prototype._restoreAuthoringPropsFromState=function(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1},u.fromJSON=function(e){var t=e;if(!t)throw new m("webmap:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:t})},u.VERSION=C,o([A.property({type:L,json:{write:!0}})],u.prototype,"applicationProperties",void 0),o([A.property({type:String,json:{write:{allowNull:!0}}})],u.prototype,"authoringApp",null),o([A.writer("authoringApp")],u.prototype,"writeAuthoringApp",null),o([A.property({type:String,json:{write:{allowNull:!0}}})],u.prototype,"authoringAppVersion",null),o([A.writer("authoringAppVersion")],u.prototype,"writeAuthoringAppVersion",null),o([A.property({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],u.prototype,"basemap",void 0),o([A.property({type:E,json:{write:{overridePolicy:function(e){return{enabled:!!(e&&e.length>0)}}}}})],u.prototype,"bookmarks",void 0),o([A.property({type:M,nonNullable:!0,json:{read:{source:["background","mapRangeInfo","spatialReference"]},write:{target:{background:{type:B},mapRangeInfo:{type:R},spatialReference:{type:U}}}}})],u.prototype,"initialViewProperties",void 0),o([A.reader("initialViewProperties")],u.prototype,"readInitialViewProperties",null),o([A.writer("initialViewProperties")],u.prototype,"writeInitialViewProperties",null),o([A.property({json:{write:{target:"operationalLayers"}}})],u.prototype,"layers",void 0),o([A.writer("layers")],u.prototype,"writeLayers",null),o([A.property({type:F})],u.prototype,"portalItem",void 0),o([A.property({json:{write:!0}})],u.prototype,"presentation",void 0),o([A.property()],u.prototype,"resourceInfo",void 0),o([A.property({readOnly:!0,type:k.default,json:{read:{source:"version"},write:{allowNull:!0,target:"version",isRequired:!0}}})],u.prototype,"sourceVersion",void 0),o([A.reader("sourceVersion")],u.prototype,"readSourceVersion",null),o([A.writer("sourceVersion")],u.prototype,"writeSourceVersion",null),o([A.property()],u.prototype,"tables",void 0),o([A.property({dependsOn:["portalItem.thumbnailUrl"]})],u.prototype,"thumbnailUrl",null),o([A.property({type:j,json:{write:!0}})],u.prototype,"widgets",void 0),o([p(0,A.cast(F))],u.prototype,"saveAs",null),u=o([A.subclass("esri.WebMap")],u)}(A.declared(y.JSONSupportMixin(f.LoadableMixin(v.EsriPromiseMixin(u)))))});