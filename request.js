// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/awaiterHelper","./core/tsSupport/generatorHelper","@dojo/framework/shim/global","./config","./kernel","./core/Error","./core/has","./core/lang","./core/promiseUtils","./core/string","./core/urlUtils","@dojo/framework/shim/Promise"],function(e,r,t,n,s,o,a,i,u,c,l,d,h,p){function f(e,r){var t=d.createAbortController();return d.create(function(n,s){m(t.signal,e,r).then(n).catch(s)},function(){t.abort()})}function m(e,r,o){return n(this,void 0,void 0,function(){var n,i,u,l,h,f,m,b;return s(this,function(s){switch(s.label){case 0:return n=p.isDataProtocol(r),i=p.isBlobProtocol(r),i||n||(r=p.normalize(r)),u={url:r,requestOptions:t({},o)},l=p.getInterceptor(r),l?[4,x(l,u)]:[3,2];case 1:if(null!=(h=s.sent()))return[2,{data:h,getHeader:H,requestOptions:u.requestOptions,url:u.url}];l.after||l.error||(l=null),s.label=2;case 2:if(r=u.url,o=u.requestOptions,"image"===o.responseType){if(c("host-webworker")||c("host-node"))throw w("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),u)}else if(n)throw w("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+o.responseType),u);if("head"===o.method){if(o.body)throw w("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),u);if(n||i)throw w("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),u)}return[4,y()];case 3:return s.sent(),A?[2,A.execute(r,o)]:(f=d.createAbortController(),d.onAbort(e,function(){return f.abort()}),d.onAbort(o,function(){return f.abort()}),m={controller:f,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:l,params:u,redoRequest:!1,useIdentity:a.request.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},[4,L(m)]);case 4:return b=s.sent(),l&&l.after&&l.after(b),[2,b]}})})}function b(e){if(!p.isBlobProtocol(e)&&!p.isDataProtocol(e)){var r=p.getOrigin(e);r&&-1===f._corsServers.indexOf(r)&&f._corsServers.push(r)}}function g(e){var r=p.getOrigin(e);return!r||h.endsWith(r,".arcgis.com")||p.hasSameOrigin(r,p.appUrl)||-1!==f._corsServers.indexOf(r)||p.isTrustedServer(r)}function v(){var e;try{e=new DOMException("Aborted","AbortError")}catch(r){e=new Error("Aborted"),e.name="AbortError"}return e}function w(e,r,t,n){var s="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:H,ssl:!1};if(r instanceof u)return r.details?(r.details=l.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var a=n&&function(e){return n.headers.get(e)},i=n&&n.status,c=r.message;c&&(s=c),a&&(o.getHeader=a),o.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||i||0,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}var d=new u(e,s,o);return r&&"cancel"===r.dojoType&&(d.dojoType="cancel"),d}function y(){return n(this,void 0,void 0,function(){return s(this,function(r){switch(r.label){case 0:return c("host-webworker")?A?[3,2]:[4,new Promise(function(r,t){e(["./core/workers/request"],r,t)})]:[3,3];case 1:A=r.sent(),r.label=2;case 2:return[3,6];case 3:return U?[3,6]:c("esri-abortable-fetch")?(U=o.default.fetch,[3,6]):[3,4];case 4:return[4,new Promise(function(r,t){e(["whatwg-fetch"],r,t)})];case 5:U=r.sent().fetch,r.label=6;case 6:return[2]}})})}function q(){return n(this,void 0,void 0,function(){return s(this,function(r){switch(r.label){case 0:return i.id?[3,2]:[4,new Promise(function(r,t){e(["./identity/IdentityManager"],r,t)})];case 1:r.sent(),r.label=2;case 2:return[2]}})})}function O(e){return n(this,void 0,void 0,function(){var r,t,n,a,u,l,h,p,f;return s(this,function(s){switch(s.label){case 0:return r=e.params.url,(t=e.params.requestOptions,n=e.controller.signal,a=t.body,u=null,l=null,h=null,D&&"HTMLFormElement"in o.default&&(a instanceof FormData?u=a:a instanceof HTMLFormElement&&(l=a,u=new FormData(l))),"string"==typeof a&&(h=a),e.fetchOptions={cache:t.cacheBust&&c("esri-abortable-fetch")?"reload":"default",credentials:"same-origin",headers:t.headers||{},method:"head"===t.method?"HEAD":"GET",mode:"cors",redirect:"follow",signal:n},(u||h)&&(e.fetchOptions.body=u||h),"anonymous"===t.authMode&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(r)||t.query&&t.query.token||u&&u.get&&u.get("token")||l&&l.elements.token),!e.useIdentity||e.hasToken||e.credentialToken||T(r)||d.isAborted(n))?[3,11]:(p=void 0,"immediate"!==t.authMode?[3,3]:[4,q()]);case 1:return s.sent(),[4,i.id.getCredential(r,{signal:n})];case 2:return p=s.sent(),e.credential=p,[3,10];case 3:return"no-prompt"!==t.authMode?[3,9]:[4,q()];case 4:s.sent(),s.label=5;case 5:return s.trys.push([5,7,,8]),[4,i.id.checkSignInStatus(r)];case 6:return p=s.sent(),[3,8];case 7:return f=s.sent(),[3,8];case 8:return[3,10];case 9:i.id&&(p=i.id.findCredential(r)),s.label=10;case 10:p&&(e.credentialToken=p.token,e.useSSL=!!p.ssl),s.label=11;case 11:return[2]}})})}function T(e){return I.some(function(r){return r.test(e)})}function S(e){return n(this,void 0,void 0,function(){var r,n,o,u,l,h,f,m,v,y,q,O,T,S,x,L,P,A,R,j,I,H,M,B,F,_,N;return s(this,function(s){switch(s.label){case 0:if(r=e.params.url,n=e.params.requestOptions,o=e.fetchOptions,u=p.isBlobProtocol(r)||p.isDataProtocol(r),l=n.responseType||"json",h=u?0:null!=n.timeout?n.timeout:a.request.timeout,f=!1,!u){if(e.useSSL&&(r=p.toHTTPS(r)),n.cacheBust&&"default"===o.cache&&(r=p.addQueryParameter(r,"request.preventCache",Date.now())),m=t({},n.query),e.credentialToken&&(m.token=e.credentialToken),v=p.objectToQuery(m),c("esri-url-encodes-apostrophe")&&(v=v.replace(/'/g,"%27")),y=r.length+1+v.length,q=void 0,f="post"===n.method||!!n.body||y>a.request.maxUrlLength,O=n.useProxy||!!p.getProxyRule(r),O&&(T=p.getProxyUrl(r),q=T.path,!f&&q.length+1+y>a.request.maxUrlLength&&(f=!0),T.query&&(m=t({},T.query,m))),"HEAD"===o.method&&(f||O)){if(f){if(y>a.request.maxUrlLength)throw w("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params);throw w("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params)}if(O)throw w("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}f?(o.method="POST",n.body?r=p.addQueryParameters(r,m):(o.body=p.objectToQuery(m),o.headers["Content-Type"]="application/x-www-form-urlencoded")):r=p.addQueryParameters(r,m),O&&(e.useProxy=!0,r=q+"?"+r),m.token&&D&&o.body instanceof FormData&&(S=o.body,S.set?S.set("token",m.token):S.append("token",m.token)),n.hasOwnProperty("withCredentials")?e.withCredentials=n.withCredentials:p.isTrustedServer(r)?e.withCredentials=!0:i.id&&(x=i.id.findServerInfo(r))&&x.webTierAuth&&(e.withCredentials=!0),e.withCredentials&&(o.credentials="include")}L=0,P=!1,h>0&&(L=setTimeout(function(){P=!0,e.controller.abort()},h)),s.label=1;case 1:return s.trys.push([1,24,25,26]),"image"!==n.responseType||"default"!==o.cache||"GET"!==o.method||f||k(n.headers)||!u&&!e.useProxy&&a.request.proxyUrl&&!g(r)?[3,3]:[4,C(r,e)];case 2:return R=s.sent(),[3,23];case 3:return[4,U(r,o)];case 4:if(A=s.sent(),e.useProxy||b(r),!A.ok||"HEAD"===o.method)return[3,23];switch(j=l){case"array-buffer":return[3,5];case"blob":case"image":return[3,7];case"document":return[3,9];case"json":return[3,11];case"xml":return[3,13]}return[3,15];case 5:return[4,A.arrayBuffer()];case 6:return R=s.sent(),[3,17];case 7:return[4,A.blob()];case 8:return R=s.sent(),[3,17];case 9:return I=E,[4,A.text()];case 10:return R=I.apply(void 0,[s.sent(),"text/html"]),[3,17];case 11:return[4,A.text()];case 12:return H=s.sent(),R=JSON.parse(H||null),[3,17];case 13:return M=E,[4,A.text()];case 14:return R=M.apply(void 0,[s.sent(),"application/xml"]),[3,17];case 15:return[4,A.text()];case 16:return R=s.sent(),[3,17];case 17:if(L&&(clearTimeout(L),L=0),B=A.headers.get("Content-Type"),!/application\/json|text\/plain/i.test(B)||!(R instanceof ArrayBuffer&&R.byteLength<=750||R instanceof Blob&&R.size<=750))return[3,21];s.label=18;case 18:return s.trys.push([18,20,,21]),[4,new Response(R).json()];case 19:return F=s.sent(),F.error&&(R=F),[3,21];case 20:return _=s.sent(),[3,21];case 21:return"image"===l&&R instanceof Blob?[4,C(URL.createObjectURL(R),e,!0)]:[3,23];case 22:R=s.sent(),s.label=23;case 23:return[3,26];case 24:if(N=s.sent(),"AbortError"===N.name){if(P)throw new Error("Timeout exceeded");throw d.createAbortError("Request canceled")}if(!(!A&&N instanceof TypeError&&a.request.proxyUrl)||n.body||"post"===n.method||"head"===n.method||e.useProxy)throw N;return e.redoRequest=!0,p.addProxyRule({proxyUrl:a.request.proxyUrl,urlPrefix:p.removeFile(p.urlToObject(r).path)}),[3,26];case 25:return L&&clearTimeout(L),[7];case 26:return[2,[A,R]]}})})}function x(e,r){return n(this,void 0,void 0,function(){var n,o,a;return s(this,function(s){switch(s.label){case 0:if(null!=e.responseData)return[2,e.responseData];if(e.headers&&(r.requestOptions.headers=t({},r.requestOptions.headers,e.headers)),e.query&&(r.requestOptions.query=t({},r.requestOptions.query,e.query)),!e.before)return[3,5];n=void 0,o=void 0,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,e.before(r)];case 2:return o=s.sent(),[3,4];case 3:return a=s.sent(),n=w("request:interceptor",a,r),[3,4];case 4:if((o instanceof Error||o instanceof u)&&(n=w("request:interceptor",o,r)),n)throw e.error&&e.error(n),n;return[2,o];case 5:return[2]}})})}function k(e){if(e)for(var r=0,t=Object.getOwnPropertyNames(e);r<t.length;r++){var n=t[r];if(e[n])return!0}return!1}function E(e,r){var t;try{t=(new DOMParser).parseFromString(e,r)}catch(e){}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}function L(e){return n(this,void 0,void 0,function(){var r,t,n,o,u,c,l,d,h,f,m;return s(this,function(s){switch(s.label){case 0:return[4,O(e)];case 1:s.sent(),s.label=2;case 2:s.trys.push([2,8,,9]),s.label=3;case 3:return[4,S(e)];case 4:r=s.sent(),t=r[0],n=r[1],s.label=5;case 5:return[4,P(e,t,n)];case 6:if(!s.sent())return[3,3];s.label=7;case 7:return[3,9];case 8:throw o=s.sent(),u=w("request:server",o,e.params,t),u.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(u),u;case 9:return c=e.params.url,/\/sharing\/rest\/(accounts|portals)\/self/i.test(c)&&!e.hasToken&&!e.credentialToken&&n&&n.user&&n.user.username&&!p.isTrustedServer(c)&&(l=p.getOrigin(c,!0))&&a.request.trustedServers.push(l),d=e.credential,d&&i.id&&(h=i.id.findServerInfo(d.server),(f=h&&h.owningSystemUrl)&&(f=f.replace(/\/?$/,"/sharing"),(m=i.id.findCredential(f,d.userId))&&-1===i.id._getIdenticalSvcIdx(f,m)&&m.resources.unshift(f))),[2,{data:n,getHeader:t?function(e){return t.headers.get(e)}:H,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}]}})})}function P(e,r,t){return n(this,void 0,void 0,function(){var n,o,a,u,c;return s(this,function(s){switch(s.label){case 0:if(e.redoRequest)return e.redoRequest=!1,[2,!1];if(!r)return[2,!0];if(!r.ok)throw new Error("Unable to load "+r.url+" status: "+r.status);return t&&t.error&&(n=l.mixin(new Error,t.error)),n&&(o=Number(n.code),a=n.hasOwnProperty("subcode")?Number(n.subcode):null,u=n.messageCode,u=u&&u.toUpperCase()),403===o&&(4===a||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))?e.useSSL?[3,4]:(e.useSSL=!0,[2,!1]):[3,1];case 1:return e.useIdentity&&"no-prompt"!==e.params.requestOptions.authMode&&-1!==R.indexOf(o)&&!T(e.params.url)&&(403!==o||-1===j.indexOf(u)&&(null==a||2===a&&e.credentialToken))?[4,q()]:[3,4];case 2:return s.sent(),[4,i.id.getCredential(e.params.url,{error:w("request:server",n,e.params),signal:e.controller.signal,token:e.credentialToken})];case 3:return c=s.sent(),e.credential=c,e.credentialToken=c.token,e.useSSL=e.useSSL||c.ssl,[2,!1];case 4:if(n)throw n;return[2,!0]}})})}function C(e,r,t){return void 0===t&&(t=!1),d.create(function(n,s){var o=r.controller.signal;if(d.isAborted(o))return s(v());var a=new Image;r.withCredentials?a.crossOrigin="use-credentials":a.crossOrigin="anonymous";var i=function(){h(),s(new Error("Unable to load "+e))},u=function(){h(),n(a)},l=function(){h(),a.src="",s(v())},h=function(){c("esri-image-decode")||(a.removeEventListener("error",i),a.removeEventListener("load",u)),o.removeEventListener("abort",l),t&&URL.revokeObjectURL(e)};a.alt="",a.src=e,c("esri-image-decode")?a.decode().then(u,i):(a.addEventListener("error",i),a.addEventListener("load",u)),o.addEventListener("abort",l)})}var U,A,D="FormData"in o.default,R=[499,498,403,401],j=["COM_0056","COM_0057"],I=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],H=function(){return null};return f._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],f});