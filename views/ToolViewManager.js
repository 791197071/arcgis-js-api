// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/decorateHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/assignHelper","../core/Accessor","../core/Collection","../core/Handles","../core/Logger","../core/maybe","../core/screenUtils","../core/watchUtils","../core/accessorSupport/decorators","./input/ViewEvents","./interactive/interactiveToolUtils"],function(t,e,o,i,r,n,a,s,l,c,u,p,h,d,v,f,g){function _(t){return"touch"!==t}function y(t){return"mouse"!==t.pointerType||0===t.button}function b(t){var e=t.native;return!(!e.ctrlKey&&!e.metaKey)}function m(t){return!1!==t.visible&&!1!==t.editable&&(null==t.hasEditableFlag||t.hasEditableFlag(1))}var M=u.getLogger("esri.views.ToolViewManager");return function(t){function e(e){var o=t.call(this)||this;return o._handles=new c,o._ignorePopupEventId=null,o._ignoreClickEventId=null,o._stopDrag=!1,o._dragStartScreenPoints=new Map,o._dragPreviousScreenPoints=new Map,o._hoveredManipulators=new Map,o._grabbedManipulators=new Map,o._revertToActiveTool=null,o.tools=g.newToolCollection(),o.cursor=null,o}return i(e,t),e.prototype.initialize=function(){var t=this,e=this.view;this._handles.add(f.eventTypes.map(function(o){return e.on(o,function(e){t._handleInputEvent(e)})}).concat([this.tools.on("change",function(e){e.removed.forEach(function(e){t._clearManipulatorPointers(e)}),t._refreshToolWatchers()})]))},e.prototype.destroy=function(){this.tools.forEach(function(t){t.destroy&&t.destroy()}),this._handles.destroy(),this._handles=null},Object.defineProperty(e.prototype,"activeTool",{set:function(t){var e=this;if(p.isSome(t)&&!this.view.ready)return void M.error("#activeTool=","cannot set active tool while view is not ready");g.swap(this,t,function(t){e._set("activeTool",t),e.tools.forEach(function(t){var o=p.isNone(e.activeTool)||t===e.activeTool;t.setEditableFlag&&t.setEditableFlag(1,o),!p.isNone(e.activeTool)&&m(t)||e._clearManipulatorPointers(t)})})},enumerable:!0,configurable:!0}),e.prototype.createTool=function(t,e,o){return n(this,void 0,void 0,function(){var i;return r(this,function(r){switch(r.label){case 0:return[4,this.view.whenReady()];case 1:return r.sent(),o?[4,this.removeTool(o)]:[3,3];case 2:r.sent(),r.label=3;case 3:return i=new t(a({},e,{view:this.view})),this.tools.add(i),[2,i]}})})},e.prototype.removeTool=function(t){this.tools.remove(t)},e.prototype.attach=function(){var t=this;this.tools.forEach(function(t){t.attach&&t.attach()}),"3d"===this.view.type&&this._handles.add([this.view.state.watch("camera",function(e){t.tools.forEach(function(t){t.manipulators.forEach(function(t){var o=t.manipulator;null!=o.onCameraChange&&o.onCameraChange(e)})})}),this.view.elevationProvider.on("elevation-change",function(e){t.tools.forEach(function(t){t.manipulators.forEach(function(t){var o=t.manipulator;null!=o.onElevationChange&&o.onElevationChange(e)})})})],"manipulators")},e.prototype.detach=function(){this.tools.forEach(function(t){t.detach&&t.detach()}),this._handles.remove("manipulators")},e.prototype.handlesClickEvent=function(t){return p.isSome(this.activeTool)||t.eventId===this._ignorePopupEventId||p.isSome(this._intersectManipulator(h.createScreenPointFromEvent(t),t.pointerType))},e.prototype._handleInputEvent=function(t){var e=this.activeTool;if("click"===t.type&&t.eventId===this._ignoreClickEventId||"double-click"===t.type&&t.eventId===this._ignoreClickEventId+2)return void t.stopPropagation();p.isSome(this.activeTool)?(this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(t),"immediate-click"===t.type&&p.isNone(this.activeTool)&&(this._ignoreClickEventId=t.eventId)):this.tools.forEach(function(e){!1!==e.visible&&e.handleInputEvent&&e.handleInputEvent(t)}),this._handleManipulatorEvent(t)&&(t.stopPropagation(),this._setToolCursor()),p.isSome(e)&&"pointer-up"===t.type&&(this._ignorePopupEventId=t.eventId)},e.prototype._handleManipulatorEvent=function(t){var e=!1;switch(t.type){case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(t.stopPropagation(),"end"===t.action&&(this._stopDrag=!1));break;case"pointer-down":if(!y(t)||b(t))break;var o=h.createScreenPointFromEvent(t),i=this._intersectManipulator(o,t.pointerType);if(p.isNone(i))break;var r=this._findManipulatorByKey(i);p.isSome(r)&&r.interactive&&!r.grabbing&&(e=!0,this._grabbedManipulators.set(t.pointerId,i),this._dragStartScreenPoints.set(t.pointerId,o),this._dragPreviousScreenPoints.set(t.pointerId,o),1===this._grabbedManipulators.size&&(this._revertToActiveTool=this.activeTool,this.activeTool=i.tool),r.grabbing=!0,r.grab&&r.grab({screenPoint:o}));break;case"pointer-up":var n=this._findManipulatorByKey(this._grabbedManipulators.get(t.pointerId));p.isSome(n)&&(e=!0,n.grabbing=!1,1===this._grabbedManipulators.size&&(this.activeTool=this._revertToActiveTool,this._revertToActiveTool=null)),this._grabbedManipulators.delete(t.pointerId),this._dragStartScreenPoints.delete(t.pointerId),this._dragPreviousScreenPoints.delete(t.pointerId),this._updateHover(t)&&(e=!0);break;case"pointer-drag":if(!y(t))break;var a=this._grabbedManipulators.get(t.pointerId),n=this._findManipulatorByKey(a);if(p.isNone(n))break;var o=h.createScreenPointFromEvent(t);o.x=Math.max(0,Math.min(this.view.width,o.x)),o.y=Math.max(0,Math.min(this.view.height,o.y));var s={start:this._dragStartScreenPoints.get(t.pointerId),previous:this._dragPreviousScreenPoints.get(t.pointerId)};switch(t.action){case"start":case"update":n.dragging=!0,n.attemptDragTo({screenPoint:o},s);break;case"end":n.dragging=!1}this._dragPreviousScreenPoints.set(t.pointerId,o),e=!0;break;case"immediate-click":case"pointer-move":e=this._updateHover(t);break;case"click":var o=h.createScreenPointFromEvent(t),i=this._intersectManipulator(o,t.pointerType),r=this._findManipulatorByKey(i);if(b(t)||this.tools.forEach(function(t){t.manipulators&&t.manipulators.forEach(function(t){t.manipulator.selected=!1})}),p.isNone(r)||!r.interactive)break;r.selectable&&(r.selected=!0),r.click({screenPoint:o,button:t.button}),e=!0}return e},e.prototype._updateHover=function(t){if(!_(t.pointerType))return!1;var e=this._findManipulatorByKey(this._hoveredManipulators.get(t.pointerId)),o=this._intersectManipulator(h.createScreenPointFromEvent(t),t.pointerType),i=this._findManipulatorByKey(o);return e!==i&&(p.isSome(e)&&(e.hovering=!1),p.isSome(o)&&p.isSome(i)&&i.interactive?(i.hovering=!0,this._hoveredManipulators.set(t.pointerId,o)):this._hoveredManipulators.delete(t.pointerId),!0)},e.prototype._refreshToolWatchers=function(){var t=this;this._handles.remove("tools"),this._setToolCursor(),this.tools.forEach(function(e){if(e instanceof s){var o=d.watch(e,["cursor","visible","editable"],function(){m(e)||t._clearManipulatorPointers(e),t._setToolCursor()});t._handles.add(o,"tools")}e.manipulators&&t._handles.add(e.manipulators.on("change",function(o){o.removed.forEach(function(o){var i=o.id;t._clearManipulatorPointers(e,i)})}),"tools")})},e.prototype._clearManipulatorPointers=function(t,e){var o=this;this._hoveredManipulators.forEach(function(i,r){if(i.tool===t&&(p.isNone(e)||i.manipulatorId===e)){o._hoveredManipulators.delete(r);var n=o._findManipulatorByKey(i);p.isSome(n)&&(n.hovering=!1)}}),this._grabbedManipulators.forEach(function(i,r){if(i.tool===t&&(p.isNone(e)||i.manipulatorId===e)){o._grabbedManipulators.delete(r),o._dragStartScreenPoints.delete(r),o._dragPreviousScreenPoints.delete(r);var n=o._findManipulatorByKey(i);p.isSome(n)&&(n.grabbing=!1,n.dragging=!1)}}),this._setToolCursor()},e.prototype._setToolCursor=function(){for(var t=null,e=0;e<this.tools.length;e++){var o=this.tools.getItemAt(e);if(null!=o.cursor&&!1!==o.visible){t=o.cursor;break}}!t&&this._grabbedManipulators.size>0&&(t="grabbing"),!t&&this._hoveredManipulators.size>0&&(t="pointer"),this._set("cursor",t)},e.prototype._intersectManipulator=function(t,e){var o=null,i=this.tools.find(function(i){return!(null==i.manipulators||!m(i))&&(o=i.manipulators.intersect(t,e),p.isSome(o))});return p.applySome(o,function(t){return{tool:i,manipulatorId:t}})},e.prototype._findManipulatorByKey=function(t){if(p.isNone(t))return null;var e=null;return this.tools.some(function(o){return!(o!==t.tool||null==o.manipulators||!m(o))&&(e=o.manipulators.findById(t.manipulatorId),p.isSome(e))}),e},o([v.property({constructOnly:!0,nonNullable:!0})],e.prototype,"view",void 0),o([v.property({value:null})],e.prototype,"activeTool",null),o([v.property({readOnly:!0,type:l})],e.prototype,"tools",void 0),o([v.property({readOnly:!0})],e.prototype,"cursor",void 0),e=o([v.subclass("esri.views.ToolViewManager")],e)}(v.declared(s))});