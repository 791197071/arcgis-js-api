// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/decorateHelper","../../core/tsSupport/declareExtendsHelper","../../core/Accessor","../../core/Collection","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/accessorSupport/decorators","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec3","../../core/libs/gl-matrix-2/vec3f64","../../geometry/support/webMercatorUtils","../../symbols/support/defaults","../../views/3d/support/projectionUtils","../draw/support/drawUtils","../../views/support/drapedUtils"],function(e,t,r,o,i,n,s,l,c,a,p,u,h,y,d,g,f,b){Object.defineProperty(t,"__esModule",{value:!0});var m=s.getLogger("esri.views.interactive.GraphicManipulator"),v=function(e){function t(t){var r=e.call(this)||this;return r.layer=null,r.interactive=!0,r.selectable=!1,r.dragging=!1,r._handlers=new n,r._circleCollisionCache=null,r._originalSymbol=null,r}return o(t,e),Object.defineProperty(t.prototype,"graphic",{get:function(){return this._get("graphic")},set:function(e){if("mesh"===l.get(e.geometry,"type"))return void m.error("Mesh geometries are not supported");this._circleCollisionCache=null,this._originalSymbol=e.symbol,this._set("graphic",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusedSymbol",{set:function(e){e!==this._get("focusedSymbol")&&(this._set("focusedSymbol",e),this._updateGraphicSymbol(),this._circleCollisionCache=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grabbing",{set:function(e){if(e!==this._get("grabbing")){var t=this._focused;this._set("grabbing",e),this._updateGraphicSymbol(t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hovering",{set:function(e){if(e!==this._get("hovering")){var t=this._focused;this._set("hovering",e),this._updateGraphicSymbol(t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{set:function(e){e!==this._get("selected")&&(this._set("selected",e),this._updateGraphicSymbol())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){this._resetGraphicSymbol(),this._handlers.removeAll(),this._handlers=null,this._set("view",null)},t.prototype.intersectionDistance=function(e){var t=this._get("graphic"),r=this._get("focusedSymbol"),o=l.isSome(r)?r:t.symbol,i=t.geometry;if(l.isNone(i))return null;var n=this._get("view");return"2d"===n.type?this._intersect2D(e,n,i,o):this._intersect3D(e,n,t)},t.prototype.attemptDragTo=function(e,t){if(l.isNone(this.graphic.geometry))return!1;if("mesh"===this.graphic.geometry.type)return!1;var r=this.view.toMap(t.previous),o=this.view.toMap(e.screenPoint),i=e.screenPoint.x-t.previous.x,n=e.screenPoint.y-t.previous.y,s=0,c=0;if(!r||!o)return!1;var a=[0,0,0,0,0,0];if(g.bufferToBuffer([r.x,r.y,0,o.x,o.y,0],r.spatialReference,0,a,this.graphic.geometry.spatialReference,0,2),s=a[3]-a[0],c=a[4]-a[1],0===s&&0===c)return!0;this.graphic.geometry=f.move(this.graphic.geometry.clone(),s,c);var p={screenPoint:e.screenPoint,dxMap:s,dyMap:c,dx:i,dy:n};return this._handlers.forEach(function(e){var t=e.type,r=e.handler;"drag"===t&&r(p)}),!0},t.prototype.click=function(e){this._handlers.forEach(function(t){"click"===t.type&&t.handler(e)})},t.prototype.on=function(e,t){this._handlers.push({type:e,handler:t})},t.prototype.attach=function(){l.isNone(this.layer)||this.layer.add(this.graphic)},t.prototype.detach=function(){this._resetGraphicSymbol(),l.isNone(this.layer)||this.layer.remove(this.graphic)},t.prototype._updateGraphicSymbol=function(e){if(void 0===e&&(e=this._focused),e!==this._focused){var t=this.graphic.symbol;t!==this._originalSymbol&&t!==this.focusedSymbol&&(this._originalSymbol=t)}this.graphic.symbol=this._focused&&l.isSome(this.focusedSymbol)?this.focusedSymbol:this._originalSymbol},t.prototype._resetGraphicSymbol=function(){this.graphic.symbol=this._originalSymbol},t.prototype._intersect2D=function(e,t,r,o){if(o=o||d.getDefaultSymbol2D(r),l.isNone(o))return null;var i=this._circleCollisionCache;if("point"!==r.type||"simple-marker"!==o.type){var n=b.intersectsDrapedGeometry(e,r,t);return l.isSome(n)?1:null}if(l.isNone(i)||!i.originalPoint.equals(r)){var s=r,a=t.spatialReference;if(y.canProject(s,a)){var n=y.project(s,a);i={originalPoint:s.clone(),mapPoint:n,radiusPx:c.pt2px(o.size)},this._circleCollisionCache=i}}if(l.isSome(i)){var u=c.screenPointObjectToArray(e,S),h=t.state.toScreen(P,i.mapPoint.x,i.mapPoint.y),g=i.radiusPx;return p.vec2.squaredDistance(u,h)<g*g?1:null}return null},t.prototype._intersect3D=function(e,t,r){var o=t.toMap(e,{include:[r]});if(!o)return null;var i=_;return t.renderCoordsHelper.toRenderCoords(o,i)?u.vec3.distance(i,t.state.camera.eye):null},r([a.property({constructOnly:!0,nonNullable:!0})],t.prototype,"graphic",null),r([a.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),r([a.property({value:null})],t.prototype,"focusedSymbol",null),r([a.property({constructOnly:!0})],t.prototype,"layer",void 0),r([a.property()],t.prototype,"interactive",void 0),r([a.property()],t.prototype,"selectable",void 0),r([a.property({value:!1})],t.prototype,"grabbing",null),r([a.property()],t.prototype,"dragging",void 0),r([a.property()],t.prototype,"hovering",null),r([a.property({value:!1})],t.prototype,"selected",null),t=r([a.subclass("esri.views.interactive.GraphicManipulator")],t)}(a.declared(i));t.GraphicManipulator=v;var _=h.vec3f64.create(),S=c.createScreenPointArray(),P=c.createScreenPointArray()});