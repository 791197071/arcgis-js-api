// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/assignHelper","../../../core/Error","../../../core/events","../../../core/promiseUtils","../../../core/scheduling","../../../core/libs/gl-matrix-2/common","../../../core/libs/gl-matrix-2/mat2d","../../../core/libs/gl-matrix-2/mat2df64","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../webgl","./Container","./webgl/BitBlitRenderer","./webgl/enums","./webgl/Painter","./webgl/shaders/StencilPrograms","../../support/screenshotUtils"],function(e,t,r,i,a,s,n,l,o,h,c,d,p,u,_,b,m,f,g,F){Object.defineProperty(t,"__esModule",{value:!0});var v=(u.enums.TargetType,u.enums.DepthStencilTargetType,u.enums.PixelFormat,u.enums.PixelType,u.enums.DataType,u.enums.Usage,u.enums.PrimitiveType,u.enums.CompareFunction,u.enums.StencilOperation,u.enums.TextureType,u.enums.TextureSamplingMode,u.enums.TextureWrapMode,function(e){function t(t,r){void 0===r&&(r={});var i=e.call(this)||this;i._renderParameters={drawPhase:0,state:i.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1},i._renderRequested=!1,i._clipData=new Float32Array(8),i._upperLeft=p.vec2f64.create(),i._upperRight=p.vec2f64.create(),i._lowerLeft=p.vec2f64.create(),i._lowerRight=p.vec2f64.create(),i._mat2=c.mat2df64.create(),i._clipRendererInitialized=!1,i._supersampleScreenshots=!0,i.stage=i,i._stationary=!0,i.attached=!0;var n=r.canvas,o=void 0===n?document.createElement("canvas"):n,h=r.alpha,d=void 0===h||h,_=r.stencil,b=void 0===_||_,m=r.renderContext,g=void 0===m?"webgl":m,F=r.supersampleScreenshots,v=void 0===F||F,O=r.contextOptions,B=void 0===O?{}:O;i._canvas=o,o.setAttribute("style","width: 100%; height:100%; display:block;"),t.appendChild(o);var R={alpha:d,antialias:!1,depth:!0,stencil:b},y=u.createContextOrErrorHTML(o,R,g);return i.context=new u.RenderingContext(y,B),i.painter=new f.default(i.context),i._taskHandle=l.addFrameTask({render:function(){return i.renderFrame()}}),i._taskHandle.pause(),i._supersampleScreenshots=v,i._lostWebGLContextHandle=s.on(o,"webglcontextlost",function(){i.emit("webgl-error",{error:new a("webgl-context-lost")})}),i}return r(t,e),t.prototype.destroy=function(){this.removeAllChildren(),this.renderFrame(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO1=null),this._labelsFBO2&&(this._labelsFBO2.dispose(),this._labelsFBO2=null),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this.painter.dispose(),this.context.dispose(),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._canvas=null},Object.defineProperty(t.prototype,"background",{get:function(){return this._background},set:function(e){this._background=e,this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},set:function(e){this._state=e,this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stationary",{get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())},enumerable:!0,configurable:!0}),t.prototype.requestRender=function(){this._renderRequested=!0,this._taskHandle&&this._taskHandle.resume()},t.prototype.renderFrame=function(){this._renderRequested&&(this._renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this.processRender(this._renderParameters)),this._renderRequested||this._taskHandle.pause()},t.prototype.setHighlightOptions=function(e){this.painter.setHighlightOptions(e)},t.prototype.renderChildren=function(e){var t=this,r=t.context,i=t.children;this.beforeRenderChildren(e),e.drawPhase=m.WGLDrawPhase.MAP;for(var a=e.children?e.children:i,s=a.length,n=0;n<s;n++){var l=a[n];l.attached&&l.processRender(e)}var o=r.getBoundFramebufferObject();r.bindFramebuffer(this._labelsFBO2);var h=e.stationary;if(r.setClearColor(0,0,0,h?0:1),r.clear(r.gl.COLOR_BUFFER_BIT),h){e.drawPhase=m.WGLDrawPhase.LABEL_ALPHA,e.labelFBO=this._labelsFBO1;for(var n=0;n<s;n++){var l=a[n];l.attached&&l.processRender(e)}}r.bindFramebuffer(o),e.labelFBO=this._labelsFBO2,e.drawPhase=m.WGLDrawPhase.LABEL;for(var n=0;n<s;n++){var l=a[n];l.attached&&l.processRender(e)}var c=this._labelsFBO2;this._labelsFBO2=this._labelsFBO1,this._labelsFBO1=c,this.afterRenderChildren()},t.prototype.beforeRenderChildren=function(e){var t=this,r=t.context,i=t.painter,a=e.state,s=e.pixelRatio;if(i){r.enforceState();var n=a.size,l=a.rotation,c=Math.round(n[0]*s),p=Math.round(n[1]*s);this._boundFBO=r.getBoundFramebufferObject(),this._labelsFBO1&&this._labelsFBO1.width===c&&this._labelsFBO1.height===p||(this._labelsFBO1&&(this._labelsFBO1.dispose(),this._labelsFBO2.dispose()),this._labelsFBO1=u.FramebufferObject.createWithAttachments(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:c,height:p},{colorTarget:0,depthStencilTarget:0}),r.bindFramebuffer(this._labelsFBO1),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),r.setClearColor(0,0,0,0),r.setClearDepth(1),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),r.setDepthWriteEnabled(!1),r.bindFramebuffer(this._boundFBO),this._labelsFBO2=u.FramebufferObject.createWithAttachments(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:c,height:p},{colorTarget:0,depthStencilTarget:0}));if(!(a.spatialReference&&(a.spatialReference._isWrappable?a.spatialReference._isWrappable():a.spatialReference.isWrappable)))return void(this._clipFrame=!1);var _=o.common.toRadian(l),b=Math.abs(Math.cos(_)),m=Math.abs(Math.sin(_)),f=Math.round(c*b+p*m),g=Math.round(a.worldScreenWidth);if(f<=g)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===c&&this._clipFBO.height===p||(this._clipFBO=new u.FramebufferObject(r,{colorTarget:0,depthStencilTarget:3,width:c,height:p}));var F=.5*c,v=.5*p,O=1/c,B=1/p,R=c*m+p*b,y=.5*g*s,C=.5*R,w=this._upperLeft,x=this._upperRight,E=this._lowerLeft,S=this._lowerRight;d.vec2.set(w,-y,-C),d.vec2.set(x,y,-C),d.vec2.set(E,-y,C),d.vec2.set(S,y,C),h.mat2d.identity(this._mat2),h.mat2d.translate(this._mat2,this._mat2,[F,v]),0!==l&&h.mat2d.rotate(this._mat2,this._mat2,_),d.vec2.transformMat2d(w,w,this._mat2),d.vec2.transformMat2d(x,x,this._mat2),d.vec2.transformMat2d(E,E,this._mat2),d.vec2.transformMat2d(S,S,this._mat2);var T=this._clipData;T.set([2*E[0]*O-1,2*(p-E[1])*B-1,2*S[0]*O-1,2*(p-S[1])*B-1,2*w[0]*O-1,2*(p-w[1])*B-1,2*x[0]*O-1,2*(p-x[1])*B-1]),this._clipRendererInitialized||this._initializeClipRenderer(r),this._clipVBO.setData(T),this._boundFBO=r.getBoundFramebufferObject(),r.bindFramebuffer(this._clipFBO),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),r.setClearColor(0,0,0,0),r.setClearDepth(1),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),r.setDepthWriteEnabled(!1),this._clipFrame=!0}},t.prototype.afterRenderChildren=function(){var e=this.context;e.logIno(),this._clipFrame&&this._clipRendererInitialized&&(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.bindProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this._blitRenderer.render(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1))},t.prototype.doRender=function(t){var r=this.context,i=t.state,a=t.pixelRatio;if(this._resizeCanvas(t),this.context.enforceState(),r.setViewport(0,0,a*i.size[0],a*i.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),this.background&&this.background.color){var s=this.background.color,n=s.r,l=s.g,o=s.b,h=s.a;r.setClearColor(n/255,l/255,o/255,h)}else r.setClearColor(0,0,0,0);r.setClearDepth(1),r.setClearStencil(0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT|r.gl.STENCIL_BUFFER_BIT),r.setDepthWriteEnabled(!1),e.prototype.doRender.call(this,t)},t.prototype.takeScreenshot=function(e,t){var r=F.screenshotSuperSampleSettings(e,this._supersampleScreenshots),i=r.framebufferWidth,a=r.framebufferHeight,s=this.context,l=e.layers,o={drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:r.pixelRatio};if(null!=e.rotation){var h=o.state.viewpoint;h.rotation=e.rotation,o.state.viewpoint=h}l.length>0&&(o.children=[],l.forEach(function(e){var r=t.find(function(t){return t.layer.id===e.id});r&&r.container&&r.attached&&o.children.push(r.container)}));var c=u.FramebufferObject.create(s,{colorTarget:0,depthStencilTarget:3,width:i,height:a}),d=s.getBoundFramebufferObject(),p=s.getViewport();s.bindFramebuffer(c),s.setViewport(0,0,i,a);var _=s.gl;s.setClearColor(0,0,0,0),s.setClearDepth(1),s.setClearStencil(0),s.clear(_.COLOR_BUFFER_BIT|_.DEPTH_BUFFER_BIT|_.STENCIL_BUFFER_BIT),this.renderChildren(o);var b=this._readbackScreenshot(r);s.bindFramebuffer(d),s.setViewport(p.x,p.y,p.width,p.height),this.requestRender();var m=this._ensureScreenshotEncodeCanvas(),f=F.encodeResult(b,e,m,{flipY:!0,premultipliedAlpha:!0});return n.resolve(f)},t.prototype._ensureScreenshotEncodeCanvas=function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas},t.prototype._readbackScreenshot=function(e){var t=e.framebufferWidth,r=e.framebufferHeight,i=e.region,a=e.resample,s=this.context,n=s.gl;if(a){var l=F.createEmptyImageData(t,r,this._ensureScreenshotEncodeCanvas());n.readPixels(0,0,t,r,6408,5121,new Uint8Array(l.data.buffer));var o=F.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return F.resampleHermite(l,o,!0,a.region.x,r-(a.region.y+a.region.height),a.region.width,a.region.height)}var l=F.createEmptyImageData(i.width,i.height,this._ensureScreenshotEncodeCanvas());return n.readPixels(i.x,r-(i.y+i.height),i.width,i.height,6408,5121,new Uint8Array(l.data.buffer)),l},t.prototype._resizeCanvas=function(e){var t=this._canvas,r=t.style,i=e.state.size,a=e.pixelRatio,s=i[0],n=i[1],l=Math.round(s*a),o=Math.round(n*a);t.width===l&&t.height===o||(t.width=l,t.height=o),r.width=s+"px",r.height=n+"px"},t.prototype._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;this._blitRenderer=new b.BitBlitRenderer;var t=g.stencil.attributes,r=u.createProgram(e,g.stencil);if(!r)return!1;var i=u.BufferObject.createVertex(e,35040,32),a=new Uint16Array([0,1,2,2,1,3]),s=u.BufferObject.createIndex(e,35044,a),n={geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},l=new u.VertexArrayObject(e,t,n,{geometry:i},s);return this._clipStencilProgram=r,this._clipVBO=i,this._clipVAO=l,this._clipRendererInitialized=!0,!0},t}(_.Container));t.Stage=v});