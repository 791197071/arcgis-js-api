// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../../symbols/cim/enums","../../color","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],function(t,e,o,A,i,B,R,r,W,X,p,f,C,S,m,a,s,G){Object.defineProperty(e,"__esModule",{value:!0});var K=X.vec2f32.create(),O=r.mat2df32.create(),q=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate"),n=function(i){function r(t,r){var e=i.call(this,r)||this;e._cimMarkerLayer=r;var o=0;m.isFunction(r.color)||(o=f.premultiplyAlphaRGBA(r.color));e._dynamicPropertyMap.set("_fillColor",function(t,e,i){return m.isFunction(r.color)?f.premultiplyAlphaRGBA(r.color(t,e,i)):o});var a=0;m.isFunction(r.outlineColor)||(a=f.premultiplyAlphaRGBA(r.outlineColor));var s;e._dynamicPropertyMap.set("_outlineColor",function(t,e,i){return m.isFunction(r.outlineColor)?f.premultiplyAlphaRGBA(r.outlineColor(t,e,i)):a}),m.isFunction(r.size)||(s=B.pt2px(r.size));var n;e._dynamicPropertyMap.set("_size",function(t,e,i){return m.isFunction(r.size)?B.pt2px(r.size(t,e,i)):s}),m.isFunction(r.scaleX)||(n=r.scaleX);var c;e._dynamicPropertyMap.set("_scaleX",function(t,e,i){return m.isFunction(r.scaleX)?r.scaleX(t,e,i):n}),m.isFunction(r.offsetX)||(c=B.pt2px(r.offsetX));var l;e._dynamicPropertyMap.set("xOffset",function(t,e,i){return m.isFunction(r.offsetX)?B.pt2px(r.offsetX(t,e,i)):c}),m.isFunction(r.offsetY)||(l=B.pt2px(r.offsetY));var h;e._dynamicPropertyMap.set("yOffset",function(t,e,i){return m.isFunction(r.offsetY)?B.pt2px(r.offsetY(t,e,i)):l}),m.isFunction(r.outlineWidth)||(h=B.pt2px(r.outlineWidth));var u;e._dynamicPropertyMap.set("_outlineWidth",function(t,e,i){return m.isFunction(r.outlineWidth)?B.pt2px(r.outlineWidth(t,e,i)):h}),m.isFunction(r.rotation)||(u=r.rotation);return e._dynamicPropertyMap.set("_angle",function(t,e,i){return m.isFunction(r.rotation)?r.rotation(t,e,i):u}),e._bitSet=(r.alignment===p.Alignment.MAP?1:0)|(r.colorLocked?1:0)<<1|(r.scaleSymbolsProportionally?1:0)<<3,e._materialKey=S.createMaterialKey(e.geometryType,t,!1),e}return o(r,i),r.fromCIMMarker=function(t,e){return new r(t,e)},r.prototype.bindFeature=function(i,r,o){var a=this,t=this._dynamicPropertyMap;t&&t.forEach(function(t,e){a[e]=t(i,r,o)});var e=(0,this._cimMarkerLayer.materialHash)(i,r,o),s=this._materialCache.get(e);if(s&&G.ok(s.spriteMosaicItem)&&s.spriteMosaicItem){var n=s.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,l=n.width/n.height*this._scaleX,h=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,u=this._size,p=u*l,f=this.xOffset,m=this.yOffset,d=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/B.pt2px(this._cimMarkerLayer.frameHeight):1,y=this._outlineWidth*d,_=B.pt2px(this._cimMarkerLayer.referenceSize),M=0,g=0,v=this._cimMarkerLayer.anchorPoint;v&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(M=-v.x/(this._size*l),g=v.y/this._size):(M=v.x,g=v.y)),this._sizeOutlineWidth=C.i8888to32(Math.round(Math.sqrt(256*p)),Math.round(Math.sqrt(256*u)),Math.round(Math.sqrt(256*y)),Math.round(Math.sqrt(256*_))),R.mat2d.identity(O),R.mat2d.translate(O,O,X.vec2f32.fromValues(f,-m)),h&&R.mat2d.rotate(O,O,3.14159265359/180*h);var x=n.rect.x/4,L=n.rect.y/4,b=x+n.rect.width/4,k=L+n.rect.height/4;M=.5-((.5+M)*n.width+1)/n.rect.width,g=.5-((.5+g)*n.height+1)/n.rect.height,p*=c,u*=c;var F=Math.round(64*c),P=(M-.5)*(p*=n.rect.width/n.width),w=(g-.5)*(u*=n.rect.height/n.height);W.vec2.set(K,P,w),W.vec2.transformMat2d(K,K,O),this._offsetUpperLeft=C.i1616to32(16*K[0],16*K[1]),this._texUpperLeft=C.i8888to32(x,L,this._bitSet,F),W.vec2.set(K,P+p,w),W.vec2.transformMat2d(K,K,O),this._offsetUpperRight=C.i1616to32(16*K[0],16*K[1]),this._texUpperRight=C.i8888to32(b,L,this._bitSet,F),W.vec2.set(K,P,w+u),W.vec2.transformMat2d(K,K,O),this._offsetBottomLeft=C.i1616to32(16*K[0],16*K[1]),this._texBottomLeft=C.i8888to32(x,k,this._bitSet,F),W.vec2.set(K,P+p,w+u),W.vec2.transformMat2d(K,K,O),this._offsetBottomRight=C.i1616to32(16*K[0],16*K[1]),this._texBottomRight=C.i8888to32(b,k,this._bitSet,F);var z=S.MarkerMaterialKey.load(this._materialKey);z.sdf=n.sdf,z.pattern=!0,z.textureBinding=n.textureBinding,this._materialKey=z.data}else q.error(new A("mapview-cim","Encountered an error when binding feature"))},r}(a.default(s.default));e.default=n});