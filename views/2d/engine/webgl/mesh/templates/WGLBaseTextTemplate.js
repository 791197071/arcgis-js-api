// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../definitions","../../enums","../../number","../../TextShapingNew","../../WGLDisplayRecord","../../collisions/BoundingBox","../../materialKey/MaterialKey","./ComputedGlyph"],function(e,t,r,G,o,a,i,w,T,M,s,L,n,y,I,S,l){Object.defineProperty(t,"__esModule",{value:!0});var V=o.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),h=Math.PI/180,p=i.mat2df32.create(),u=T.vec2f32.create();t.default=function(e){return function(o){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=o.apply(this,e)||this;return r.geometryType=s.WGLGeometryType.TEXT,r}return r(e,o),e.prototype.bindTextInfo=function(e,t,r){var o=this._computeShaping(e,this._justify).getShaping(t,r);isNaN(this._decorationTop)||n.TextShaping.addDecoration(o,this._decorationTop),this._shapedGlyphs=o,this._shapedBox=n.TextShaping.getBox(o)},e.prototype.writeMesh=function(e,t,r,o,i){var a=this._computedGlyphs;if(a){var s,n,h=S.TextMaterialKey.load(this._materialKey),p=L.i8888to32(0,0,0,this._bitset);switch(r){case"esriGeometryPoint":for(var u=i.geometry,l=u.x,c=u.y,f=0,m=a;f<m.length;f++)(M=m[f]).anchorX=l,M.anchorY=c;return void this._writeVertices(e,t,o,a,h,p,0,0);case"esriGeometryPolygon":if(i.centroid){for(var g=i.centroid,d=(l=g.x,c=g.y,0),y=a;d<y.length;d++)(M=y[d]).anchorX=l,M.anchorY=c;return void this._writeVertices(e,t,o,a,h,p,0,0)}case"esriGeometryMultipoint":for(var v=c=l=0,_=i.geometry.points;v<_.length;v++){var x=_[v];l+=x[0],c+=x[1];for(var w=0,T=a;w<T.length;w++){var M;(M=T[w]).anchorX=l,M.anchorY=c}this._writeVertices(e,t,o,a,h,p,0,0)}return;default:s="Unable to handle geometryType: "+r,void 0===n&&(n="mapview-processing"),V.error(new G(n,s))}}},e.prototype._computeGlyphs=function(e,t){if(e&&0!==e.length){for(var r=new Array(e.length),o=this._computeGlyphTransform(t),i=S.MaterialKeyBase.load(this._materialKey),a=0;a<e.length;a++){var s=e[a],n=s.x,h=s.y,p=s.codePoint,u=s.glyphMosaicItem;i.textureBinding=u.textureBinding,r[a]=l.default.from(n,h,0,0,-1,0,25,u,p,i.data,o,this._size,this._haloSize,!1,!0)}this._computedGlyphs=r}},e.prototype._createBounds=function(e,t){var r,o,i=e.width/2,a=e.height/2,s=t[4],n=t[5];if(this._angle){var h=T.vec2f32.fromValues(-i,-a),p=T.vec2f32.fromValues(i,-a),u=T.vec2f32.fromValues(-i,a),l=T.vec2f32.fromValues(i,a);w.vec2.transformMat2d(h,h,t),w.vec2.transformMat2d(p,p,t),w.vec2.transformMat2d(u,u,t),w.vec2.transformMat2d(l,l,t);for(var c=1/0,f=1/0,m=0,g=0,d=0,y=[h,p,u,l];d<y.length;d++){var v=y[d];c=Math.min(v[0],c),m=Math.max(v[0],m),f=Math.min(v[1],f),g=Math.max(v[1],g)}r=m-c,o=g-f}else r=e.width*this._scale,o=e.height*this._scale;var _=r+M.COLLISION_BOX_PADDING,x=o+M.COLLISION_BOX_PADDING;return new I.default(s,n,_,x)},e.prototype._computeShaping=function(e,t){return new n.TextShaping([e],512,M.TEXT_LINE_HEIGHT,M.TEXT_SPACING,[0,.5*-M.TEXT_LINE_HEIGHT],.5*(1-this._xAlignD),0,t)},e.prototype._computeGlyphTransform=function(e){var t=this._scale,r=this._angle*h,o=a.mat2d.identity(p);a.mat2d.rotate(o,o,r),a.mat2d.translate(o,o,w.vec2.set(u,this._xOffset,-this._yOffset)),a.mat2d.scale(o,o,w.vec2.set(u,t,t));var i=this._baseline?25:e.y+(1-this._yAlignD)*e.height*.5;return a.mat2d.translate(o,o,w.vec2.set(u,-4,-4-i)),o},e.prototype._writeVertices=function(e,t,r,o,i,a,s,n){this._writeHalos(e,t,r,o,i,a,s,n),this._writeText(e,t,r,o,i,a,s,n)},e.prototype._writeHalos=function(e,t,r,o,i,a,s,n){var h=t.indexVector,p=t.getVector("geometry").vertexCount,u=0;if(this._haloSize)for(var l=0;l<o.length;l++,u+=4){var c=o[l],f=L.i1616to32(2*c.anchorX+1,2*c.anchorY),m=null==s?Math.floor(10*c.minZoom):s,g=null==n?Math.floor(10*c.maxZoom):n,d=new y(r,this.geometryType,c.materialKey,m,g);d.vertexFrom=p+u,d.indexFrom=h.length,this._writeVertex(d,t,r,f,this._haloColor,c,a,m,g),this._writeIndices(d,h,p+u),e.push(d)}},e.prototype._writeText=function(e,t,r,o,i,a,s,n){for(var h=t.indexVector,p=t.getVector("geometry").vertexCount,u=0,l=0;l<o.length;l++,u+=4){var c=o[l],f=L.i1616to32(2*c.anchorX,2*c.anchorY),m=null==s?Math.floor(10*c.minZoom):s,g=null==n?Math.floor(10*c.maxZoom):n,d=new y(r,this.geometryType,c.materialKey,m,g);d.vertexFrom=p+u,d.indexFrom=h.length,this._writeVertex(d,t,r,f,this._color,c,a,m,g),this._writeIndices(d,h,p+u),e.push(d)}},e.prototype._writeVertex=function(e,t,r,o,i,a,s,n,h){var p=t.get("geometry");p.push(o),p.push(r),p.push(i),p.push(a.vertexOffsetUpperLeft),p.push(a.texFontSizeUpperLeft),p.push(s),p.push(o),p.push(r),p.push(i),p.push(a.vertexOffsetUpperRight),p.push(a.texFontSizeUpperRight),p.push(s),p.push(o),p.push(r),p.push(i),p.push(a.vertexOffsetLowerLeft),p.push(a.texFontSizeLowerLeft),p.push(s),p.push(o),p.push(r),p.push(i),p.push(a.vertexOffsetLowerRight),p.push(a.texFontSizeLowerRight),p.push(s),e.vertexCount+=4},e.prototype._writeIndices=function(e,t,r){t.push(r+0),t.push(r+1),t.push(r+2),t.push(r+1),t.push(r+3),t.push(r+2),e.indexCount+=6},e}(e)}});