// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../core/asyncUtils","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/support/defaults","./WGLDynamicLineTemplate","./WGLDynamicMarkerTemplate","./WGLDynamicTextTemplate","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/BidiText","../../util/Lock","../../util/Result"],function(e,t,u,l,c,i,r,h,p,o,s,n,m,a,f,_,d,y,M,T){Object.defineProperty(t,"__esModule",{value:!0});var v=r.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),I=new Array;function b(t,e){var r=t.length;return t.push(null),e.then(function(e){return t[r]=e}),t}function g(e){return!!(1&e)}t.isDynamicId=g;var C=function(){function e(e){this._idCounter=0,this._templateIdCounter=0,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new M.default,this._fetchResource=e}return Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0}),e.prototype.createTemplateGroup=function(e,t,r,i){this._initErrorTemplates();var o=this._hashSymbol(e);if(!this._symbolToTemplate.has(o)){var s=new Array;t&&this._createMeshTemplates(s,t,r,i,!0),this._createMeshTemplates(s,e,r,i,!1);var n=this._createGroupId("cim"===e.type);this._idToTemplateGroup.set(n,s),this._symbolToTemplate.set(o,n)}return this._symbolToTemplate.get(o)},e.prototype.getCIMMosaicItem=function(e,t){var r=this,i=this._createTemplateId(),o=h.create(function(e){return r._idToResolver.set(i,e)});return this._fetchQueue.push({symbol:e,id:i,glyphIds:t}),o},e.prototype.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):I},e.prototype.getDynamicTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?(g(e)||v.error("mapview-template-store","Id "+e+" does not refer to a dynamic template"),this._idToTemplateGroup.get(e)):I},e.prototype.finalize=function(e){return this._fetchQueue.length||this._lock.isHeld()?M.withLock(this._lock,this._fetchAllQueuedResources.bind(this),e):h.resolve()},e.prototype._initErrorTemplates=function(){if(!this._errorTemplates){var e=this._createMeshTemplates([],o.errorPolygonSymbol2D,null,null,!1),t=this._createMeshTemplates([],o.errorPointSymbol2D,null,null,!1),r=this._createMeshTemplates([],o.errorPolylineSymbol2D,null,null,!1);this._errorTemplates={fill:e,marker:t,line:r}}},e.prototype._fetchAllQueuedResources=function(e){var n=this;if(!this._fetchQueue.length)return h.resolve();var t=this._fetchQueue,r=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],h.all(r).then(function(){return n._fetchResource(t,e).then(function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t],o=i.id,s=i.mosaicItem;n._idToResolver.get(o)(s),n._idToResolver.delete(o)}})}).catch(function(e){h.isAbortError(e)?n._fetchQueue=n._fetchQueue.concat(t):v.error(new i("mapview-template-store","Unable to fetch requested texture resources",e))})},e.prototype._createGroupId=function(e){return this._idCounter++<<1|(e?1:0)},e.prototype._createTemplateId=function(){return this._templateIdCounter++},e.prototype._getCodepoints=function(e){for(var t=y.bidiText(e.text)[0],r=[],i=0;i<t.length;i++)r.push(t.charCodeAt(i));return r},e.prototype._getMosaicItem=function(e){var t=this,r=this._createTemplateId(),i="text"===e.type&&this._getCodepoints(e),o=h.create(function(e){return t._idToResolver.set(r,e)});return this._fetchQueue.push({symbol:e.toJSON(),id:r,glyphIds:i}),o},e.prototype._hashSymbol=function(e){return e.id?e.id:JSON.stringify(e)},e.prototype._createSMS=function(r,i){return u(this,void 0,void 0,function(){var t;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().spriteMosaicItem,T.ok(t,v)?[2,_.default.fromSimpleMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createPMS=function(r,i){return u(this,void 0,void 0,function(){var t;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().spriteMosaicItem,T.ok(t,v)?[2,_.default.fromPictureMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createSFS=function(i,o,s){return u(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,T.ok(t,v)?[2,a.default.fromSimpleFill(o,r,t,s)]:[2,this._fillError]}})})},e.prototype._createPFS=function(i,o,s){return u(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,T.ok(t,v)?[2,a.default.fromPictureFill(o,r,t,s)]:[2,this._fillError]}})})},e.prototype._createSLS=function(i,o,s){return u(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,T.ok(t,v)?[2,f.default.fromSimpleLine(o,s,r,t)]:[2,this._lineError]}})})},e.prototype._createTS=function(r,i){return u(this,void 0,void 0,function(){var t;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().glyphMosaicItems,[2,d.default.fromText(i,r,t)]}})})},e.prototype._createCIMText=function(a,c){return u(this,void 0,void 0,function(){var t,r,i,o,s,n;return l(this,function(e){switch(e.label){case 0:if("function"==typeof a.materialHash)return[2,h.resolve(m.default.fromCIMText(c,a))];if(t=[],r=a.text)for(i=r.length,o=0;o<i;o++)s=r.charCodeAt(o),t.push(s);return a.cim.mosaicHash=a.materialHash,[4,this.getCIMMosaicItem(a.cim,t)];case 1:return n=e.sent().glyphMosaicItems,T.ok(n,v)?[2,d.default.fromCIMText(c,a,n)]:[2,this._textError]}})})},e.prototype._createCIMFill=function(r,i){return u(this,void 0,void 0,function(){var t;return l(this,function(e){switch(e.label){case 0:return r.materialHash,r.cim.mosaicHash=r.materialHash,[4,this.getCIMMosaicItem(r.cim)];case 1:return t=e.sent().spriteMosaicItem,T.ok(t,v)?[2,a.default.fromCIMFill(i,r,t,!1)]:[2,this._fillError]}})})},e.prototype._createCIMLine=function(r,i){return u(this,void 0,void 0,function(){var t;return l(this,function(e){switch(e.label){case 0:return"function"==typeof r.materialHash?[2,h.resolve(s.default.fromCIMLine(i,r))]:(r.cim.mosaicHash=r.materialHash,[4,this.getCIMMosaicItem(r.cim)]);case 1:return t=e.sent().spriteMosaicItem,T.ok(t,v)?[2,f.default.fromCIMLine(i,r,t,!1)]:[2,this._lineError]}})})},e.prototype._createCIMMarker=function(r,i){return u(this,void 0,void 0,function(){var t;return l(this,function(e){switch(e.label){case 0:return"function"==typeof r.materialHash?[2,h.resolve(n.default.fromCIMMarker(i,r))]:(r.cim.mosaicHash=r.materialHash,[4,this.getCIMMosaicItem(r.cim)]);case 1:return t=e.sent().spriteMosaicItem,T.ok(t,v)?[2,_.default.fromCIMMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createCIM=function(o,s){return u(this,void 0,void 0,function(){var t,r,i=this;return l(this,function(e){if(t=o.templateHash,this._cimTemplateCache.has(t))return[2,this._cimTemplateCache.get(t)];switch(o.type){case"marker":r=this._createCIMMarker(o,s);break;case"line":r=this._createCIMLine(o,s);break;case"fill":r=this._createCIMFill(o,s);break;case"text":r=this._createCIMText(o,s)}return r.then(function(e){return i._cimTemplateCache.set(t,e)}),[2,r]})})},e.prototype._getCIMSymbolLayers=function(n,a,c){return u(this,void 0,void 0,function(){var t,r,i,o,s;return l(this,function(e){switch(e.label){case 0:if(t=[],r=[],Array.isArray(n.data))for(i=0,o=n.data;i<o.length;i++)s=o[i],t.push(p.analyzeCIMSymbol(s,a,c,r));else t.push(p.analyzeCIMSymbol(n.data,a,c,r));return[4,h.all(t)];case 1:return e.sent(),[2,r]}})})},e.prototype._createCIMMeshTemplates=function(o,e,s,t){var n=this,r=s?s.fieldMap:null,i=e,a=this._getCIMSymbolLayers(i,r,t);this._cimAnalyses.push(c.safeCast(a.then(function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];b(o,n._createCIM(i,s))}})))},e.prototype._createMeshTemplates=function(e,t,r,i,o){if(-1!==t.type.indexOf("3d"))return v.error("3D symbols are not supported with MapView"),e;switch(t.type){case"cim":return this._createCIMMeshTemplates(e,t,r,i),e;case"simple-marker":return b(e,this._createSMS(t,r));case"picture-marker":return b(e,this._createPMS(t,r));case"simple-fill":var s=t;return b(e,this._createSFS(s,r,o)),s.outline&&b(e,this._createSLS(s.outline,r,!0)),e;case"picture-fill":var n=t;return b(e,this._createPFS(n,r,o)),n.outline&&b(e,this._createSLS(n.outline,r,!0)),e;case"simple-line":return b(e,this._createSLS(t,r,!1));case"text":return b(e,this._createTS(t,r));default:return v.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),e}},e}();t.WGLTemplateStore=C});