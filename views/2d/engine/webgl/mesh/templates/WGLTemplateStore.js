// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/support/defaults","./WGLDynamicLineTemplate","./WGLDynamicMarkerTemplate","./WGLDynamicTextTemplate","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/BidiText","../../util/Lock","../../util/Result"],function(e,t,p,m,i,r,u,s,o,n,a,l,c,h,f,_,d,y,M){Object.defineProperty(t,"__esModule",{value:!0});var T=r.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),v=new Array;function I(t,e){var r=t.length;return t.push(null),e.then(function(e){return t[r]=e}),t}function b(e){return!!(1&e)}t.isDynamicId=b;var g=function(){function e(e,t){this._idCounter=0,this._templateIdCounter=0,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new y.default,this._fetchResource=e,this._joinOnUTurn=t}return Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0}),e.prototype.createTemplateGroup=function(n,o,s,a){return p(this,void 0,void 0,function(){var t,r,i;return m(this,function(e){switch(e.label){case 0:return[4,this._initErrorTemplates()];case 1:return e.sent(),t=JSON.stringify(n),this._symbolToTemplate.has(t)?[2,this._symbolToTemplate.get(t)]:(r=new Array,o?[4,this._createMeshTemplates(r,o,s,a,!0)]:[3,3]);case 2:e.sent(),e.label=3;case 3:return[4,this._createMeshTemplates(r,n,s,a,!1)];case 4:return e.sent(),i=this._createGroupId("cim"===n.type),this._idToTemplateGroup.set(i,r),this._symbolToTemplate.set(t,i),[2,i]}})})},e.prototype.getCIMMosaicItem=function(e,t){var r=this,i=this._createTemplateId(),n=u.create(function(e){return r._idToResolver.set(i,e)});return this._fetchQueue.push({symbol:e,id:i,glyphIds:t}),n},e.prototype.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):v},e.prototype.getDynamicTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?(b(e)||T.error("mapview-template-store","Id "+e+" does not refer to a dynamic template"),this._idToTemplateGroup.get(e)):v},e.prototype.finalize=function(e){return this._fetchQueue.length||this._lock.isHeld()?y.withLock(this._lock,this._fetchAllQueuedResources.bind(this),e):u.resolve()},e.prototype._initErrorTemplates=function(){return p(this,void 0,void 0,function(){var t,r,i,n;return m(this,function(e){switch(e.label){case 0:return this._errorTemplates?[2]:(t=this._createMeshTemplates([],o.errorPolygonSymbol2D,null,null,!1),r=this._createMeshTemplates([],o.errorPointSymbol2D,null,null,!1),i=this._createMeshTemplates([],o.errorPolylineSymbol2D,null,null,!1),[4,u.all([t,r,i])]);case 1:return n=e.sent(),this._errorTemplates={fill:n[0],marker:n[1],line:n[2]},[2]}})})},e.prototype._fetchAllQueuedResources=function(e){var s=this;if(!this._fetchQueue.length)return u.resolve();var t=this._fetchQueue,r=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],u.all(r).then(function(){return s._fetchResource(t,e).then(function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t],n=i.id,o=i.mosaicItem;s._idToResolver.get(n)(o),s._idToResolver.delete(n)}})}).catch(function(e){u.isAbortError(e)?s._fetchQueue=s._fetchQueue.concat(t):T.error(new i("mapview-template-store","Unable to fetch requested texture resources",e))})},e.prototype._createGroupId=function(e){return this._idCounter++<<1|(e?1:0)},e.prototype._createTemplateId=function(){return this._templateIdCounter++},e.prototype._getCodepoints=function(e){for(var t=d.bidiText(e.text)[0],r=[],i=0;i<t.length;i++)r.push(t.charCodeAt(i));return r},e.prototype._getMosaicItem=function(e){var t=this,r=this._createTemplateId(),i="text"===e.type&&this._getCodepoints(e),n=u.create(function(e){return t._idToResolver.set(r,e)});return this._fetchQueue.push({symbol:e.toJSON(),id:r,glyphIds:i}),n},e.prototype._createSMS=function(r,i){return p(this,void 0,void 0,function(){var t;return m(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().spriteMosaicItem,M.ok(t,T)?[2,f.default.fromSimpleMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createPMS=function(r,i){return p(this,void 0,void 0,function(){var t;return m(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().spriteMosaicItem,M.ok(t,T)?[2,f.default.fromPictureMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createSFS=function(i,n,o){return p(this,void 0,void 0,function(){var t,r;return m(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,M.ok(t,T)?[2,c.default.fromSimpleFill(n,r,t,o)]:[2,this._fillError]}})})},e.prototype._createPFS=function(i,n,o){return p(this,void 0,void 0,function(){var t,r;return m(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,M.ok(t,T)?[2,c.default.fromPictureFill(n,r,t,o)]:[2,this._fillError]}})})},e.prototype._createSLS=function(i,n,o){return p(this,void 0,void 0,function(){var t,r;return m(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(i)];case 1:return t=e.sent().spriteMosaicItem,r=i,M.ok(t,T)?[2,h.default.fromSimpleLine(n,o,r,t,this._joinOnUTurn)]:[2,this._lineError]}})})},e.prototype._createTS=function(r,i){return p(this,void 0,void 0,function(){var t;return m(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(r)];case 1:return t=e.sent().glyphMosaicItems,[2,_.default.fromText(i,r,t)]}})})},e.prototype._createCIMText=function(a,c){return p(this,void 0,void 0,function(){var t,r,i,n,o,s;return m(this,function(e){switch(e.label){case 0:if("function"==typeof a.materialHash)return[2,u.resolve(l.default.fromCIMText(c,a))];if(t=[],r=a.text)for(i=r.length,n=0;n<i;n++)o=r.charCodeAt(n),t.push(o);return a.cim.mosaicHash=a.materialHash,[4,this.getCIMMosaicItem(a.cim,t)];case 1:return s=e.sent().glyphMosaicItems,M.ok(s,T)?[2,_.default.fromCIMText(c,a,s)]:[2,this._textError]}})})},e.prototype._createCIMFill=function(r,i){return p(this,void 0,void 0,function(){var t;return m(this,function(e){switch(e.label){case 0:return r.materialHash,r.cim.mosaicHash=r.materialHash,[4,this.getCIMMosaicItem(r.cim)];case 1:return t=e.sent().spriteMosaicItem,M.ok(t,T)?[2,c.default.fromCIMFill(i,r,t,!1)]:[2,this._fillError]}})})},e.prototype._createCIMLine=function(r,i){return p(this,void 0,void 0,function(){var t;return m(this,function(e){switch(e.label){case 0:return"function"==typeof r.materialHash?[2,u.resolve(n.default.fromCIMLine(i,r))]:(r.cim.mosaicHash=r.materialHash,[4,this.getCIMMosaicItem(r.cim)]);case 1:return t=e.sent().spriteMosaicItem,M.ok(t,T)?[2,h.default.fromCIMLine(i,r,t,!1,this._joinOnUTurn)]:[2,this._lineError]}})})},e.prototype._createCIMMarker=function(r,i){return p(this,void 0,void 0,function(){var t;return m(this,function(e){switch(e.label){case 0:return"function"==typeof r.materialHash?[2,u.resolve(a.default.fromCIMMarker(i,r))]:(r.cim.mosaicHash=r.materialHash,[4,this.getCIMMosaicItem(r.cim)]);case 1:return t=e.sent().spriteMosaicItem,M.ok(t,T)?[2,f.default.fromCIMMarker(i,r,t)]:[2,this._markerError]}})})},e.prototype._createCIM=function(n,o){return p(this,void 0,void 0,function(){var t,r,i=this;return m(this,function(e){if(t=n.templateHash,this._cimTemplateCache.has(t))return[2,this._cimTemplateCache.get(t)];switch(n.type){case"marker":r=this._createCIMMarker(n,o);break;case"line":r=this._createCIMLine(n,o);break;case"fill":r=this._createCIMFill(n,o);break;case"text":r=this._createCIMText(n,o)}return r.then(function(e){return i._cimTemplateCache.set(t,e)}),[2,r]})})},e.prototype._getCIMSymbolLayers=function(i,n,o){return p(this,void 0,void 0,function(){var t,r;return m(this,function(e){switch(e.label){case 0:return r=[],(t=[]).push(s.analyzeCIMSymbol(i.data,n,o,r)),[4,u.all(t)];case 1:return e.sent(),[2,r]}})})},e.prototype._createCIMMeshTemplates=function(c,u,l,h){return p(this,void 0,void 0,function(){var t,r,i,n,o,s,a;return m(this,function(e){switch(e.label){case 0:return r=(t=l)?t.fieldMap:null,i=u,[4,this._getCIMSymbolLayers(i,r,h)];case 1:for(n=e.sent(),o=0,s=n;o<s.length;o++)a=s[o],I(c,this._createCIM(a,l));return[2]}})})},e.prototype._createMeshTemplates=function(i,n,o,s,a){return p(this,void 0,void 0,function(){var t,r;return m(this,function(e){switch(e.label){case 0:if(-1!==n.type.indexOf("3d"))return T.error("3D symbols are not supported with MapView"),[2,i];switch(n.type){case"cim":return[3,1];case"simple-marker":return[3,3];case"picture-marker":return[3,4];case"simple-fill":return[3,5];case"picture-fill":return[3,6];case"simple-line":return[3,7];case"text":return[3,8]}return[3,9];case 1:return[4,this._createCIMMeshTemplates(i,n,o,s)];case 2:return e.sent(),[2,i];case 3:return[2,I(i,this._createSMS(n,o))];case 4:return[2,I(i,this._createPMS(n,o))];case 5:return t=n,I(i,this._createSFS(t,o,a)),t.outline&&I(i,this._createSLS(t.outline,o,!0)),[2,i];case 6:return r=n,I(i,this._createPFS(r,o,a)),r.outline&&I(i,this._createSLS(r.outline,o,!0)),[2,i];case 7:return[2,I(i,this._createSLS(n,o,!1))];case 8:return[2,I(i,this._createTS(n,o))];case 9:return T.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),[2,i]}})})},e}();t.WGLTemplateStore=g});