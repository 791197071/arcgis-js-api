// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/has","../../../../../../core/Logger","../../definitions","../../enums","../../number","../../TileClipper","../../TurboLine","../../WGLDisplayRecord","../../materialKey/MaterialKey"],function(t,e,i,d,r,s,n,f,o,_,c,h){Object.defineProperty(e,"__esModule",{value:!0});var p=r.getLogger("esri.views.2d.engine.webgl.WGLLineTemplateBase"),x=s.TILE_SIZE+8,y=31,v=new o.TileClipper(0,0,0,1,8);v.setExtent(s.TILE_SIZE);var g=0,m=0,C=0;d("esri-tiles-performance")&&setInterval(function(){console.log("New (FL)","feat="+C,"secs="+g,"tris="+m,"tris/sec="+Math.round(m/g))},1e4);var b=new Uint32Array(9),a=new Uint32Array(36),l=new Uint32Array(3),u=new Uint32Array(6);e.default=function(t){return function(r){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=r.apply(this,t)||this;return i._tessellationOptions={},i.geometryType=n.WGLGeometryType.LINE,i}return i(t,r),t.prototype.writeMesh=function(t,e,i,r,s){var n=e.indexVector,o=e.get("geometry"),h=new c(r,this.geometryType,this._materialKey),a=e.getVector("geometry").vertexCount;switch(h.vertexFrom=a,h.indexFrom=n.length,i){case"esriGeometryPolyline":var l=s.geometry.paths;if(0===(u=this._clipLines(l)).length)return;return this._write(h,n,o,a,r,u),void t.push(h);case"esriGeometryPolygon":var u,d=s.geometry.rings;if(0===(u=this._clipLines(d)).length)return;return this._write(h,n,o,a,r,u),void t.push(h);default:p.error("Unable to handle geometryType: "+i)}},t.prototype._clipLines=function(t){for(var e=[],i=!1,r=0;r<t.length;){var s=[],n=t[r];v.reset(2);var o=n[0],h=o[0],a=o[1];if(i)v.moveTo(h,a);else{if(h<-8||x<h||a<-8||x<a){i=!0;continue}s.push({x:h,y:a})}for(var l=!1,u=n.length,d=1;d<u;++d)if(h+=n[d][0],a+=n[d][1],i)v.lineTo(h,a);else{if(h<-8||x<h||a<-8||x<a){l=!0;break}s.push({x:h,y:a})}if(l)i=!0;else{if(i){var f=v.resultWithStarts();if(f)for(var _=0,c=f;_<c.length;_++){var p=c[_];e.push(p)}}else e.push({line:s,start:0});r++,i=!1}}return e},t.prototype._write=function(t,e,i,r,s,n){var o;d("esri-tiles-performance")&&(o=performance.now()),this.id=s,this.indexBuf=e,this.indexCount=0,this.geometryBuf=i,this.vertexCount=0,this.offset=r;for(var h=0,a=n;h<a.length;h++){var l=a[h],u=l.line;u.length<2||(this._tessellationOptions.initialDistance=l.start%65535,this._tessellationCallbacks instanceof _.StandardTessellationCallbacks&&(this._tessellationCallbacks.capType=this._capType,this._tessellationCallbacks.joinType=this._joinType),_.tessellate(u,this._tessellationOptions,this._tessellationCallbacks),d("esri-tiles-performance")&&C++)}t.vertexCount=this.vertexCount,t.indexCount=this.indexCount,t.zOrder=this._zOrder,d("esri-tiles-performance")&&(g+=(performance.now()-o)/1e3,m+=t.indexCount/3)},t.prototype._initializeTessellator=function(t){var e=h.LineMaterialKey.load(this._materialKey);if(this._tessellationOptions.trackDistance=this._isDashed||this._hasPattern,this._tessellationOptions.thin=!t&&this._halfWidth<s.THIN_LINE_THRESHOLD/2&&!(e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue),this._tessellationOptions.wrapDistance=65535,this._tessellationOptions.outerBisectorAutoSplitThreshold=1/3.8,this._tessellationOptions.enableOuterBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.innerBisectorAutoSplitThreshold=1/3.8,this._tessellationOptions.enableInnerBisectorSplit=this._isDashed||this._hasPattern,this._tessellationOptions.thin)this._tessellationCallbacks={vertex:this._thinVertex.bind(this),bridge:this._thinBridge.bind(this)};else{var i=new _.StandardTessellationCallbacks(this._thickWriteVertex.bind(this),this._thickWriteTriangle.bind(this));i.miterLimitCosine=this._miterLimitCosine,i.textured=this._isDashed||this._hasPattern,this._tessellationCallbacks=i}},t.prototype._thinVertex=function(t){t.entry0=this.offset+this.vertexCount++;var e=f.i1616to32(t.distance,y*this._halfWidth),i=f.i8888to32(Math.round(y*t.prevNormal.x),Math.round(y*t.prevNormal.y),Math.round(0),Math.round(-31)),r=f.i8888to32(0,0,0,this._bitset);a[0]=f.i1616to32(t.currentVertex.x,t.currentVertex.y),a[1]=this.id,a[2]=this._fillColor,a[3]=i,a[4]=e,a[5]=this._tl,a[6]=this._br,a[7]=r,a[8]=f.i1616to32(y*this._halfReferenceWidth,0),t.entry2=this.offset+this.vertexCount++,e=f.i1616to32(t.distance,y*this._halfWidth),i=f.i8888to32(Math.round(y*-t.prevNormal.x),Math.round(y*-t.prevNormal.y),Math.round(0),Math.round(31)),r=f.i8888to32(0,0,0,this._bitset),a[9]=f.i1616to32(t.currentVertex.x,t.currentVertex.y),a[10]=this.id,a[11]=this._fillColor,a[12]=i,a[13]=e,a[14]=this._tl,a[15]=this._br,a[16]=r,a[17]=f.i1616to32(y*this._halfReferenceWidth,0),t.exit0=this.offset+this.vertexCount++,e=f.i1616to32(t.distance,y*this._halfWidth),i=f.i8888to32(Math.round(y*t.nextNormal.x),Math.round(y*t.nextNormal.y),Math.round(0),Math.round(-31)),r=f.i8888to32(0,0,0,this._bitset),a[18]=f.i1616to32(t.currentVertex.x,t.currentVertex.y),a[19]=this.id,a[20]=this._fillColor,a[21]=i,a[22]=e,a[23]=this._tl,a[24]=this._br,a[25]=r,a[26]=f.i1616to32(y*this._halfReferenceWidth,0),t.exit2=this.offset+this.vertexCount++,e=f.i1616to32(t.distance,y*this._halfWidth),i=f.i8888to32(Math.round(y*-t.nextNormal.x),Math.round(y*-t.nextNormal.y),Math.round(0),Math.round(31)),r=f.i8888to32(0,0,0,this._bitset),a[27]=f.i1616to32(t.currentVertex.x,t.currentVertex.y),a[28]=this.id,a[29]=this._fillColor,a[30]=i,a[31]=e,a[32]=this._tl,a[33]=this._br,a[34]=r,a[35]=f.i1616to32(y*this._halfReferenceWidth,0),this.geometryBuf.writeRegion(a)},t.prototype._thinBridge=function(t){u[0]=t.leftExit0,u[1]=t.rightEntry0,u[2]=t.leftExit2,u[3]=t.rightEntry0,u[4]=t.rightEntry2,u[5]=t.leftExit2,this.indexCount+=6,this.indexBuf.writeRegion(u)},t.prototype._thickWriteVertex=function(t,e,i,r,s,n,o,h,a){var l=f.i1616to32(a,y*this._halfWidth),u=f.i8888to32(Math.round(y*s),Math.round(y*n),Math.round(y*o),Math.round(y*h)),d=f.i8888to32(y*i,y*r,0,this._bitset);return b[0]=f.i1616to32(t,e),b[1]=this.id,b[2]=this._fillColor,b[3]=u,b[4]=l,b[5]=this._tl,b[6]=this._br,b[7]=d,b[8]=f.i1616to32(y*this._halfReferenceWidth,0),this.geometryBuf.writeRegion(b),this.offset+this.vertexCount++},t.prototype._thickWriteTriangle=function(t,e,i){l[0]=t,l[1]=e,l[2]=i,this.indexCount+=3,this.indexBuf.writeRegion(l)},t}(t)}});