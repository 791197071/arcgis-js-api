// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/Error","../../../../../../core/has","../../../../../../core/Logger","../../../../../../core/maybe","../../../../../../core/promiseUtils","../../../../../../geometry/SpatialReference","../../../../../../geometry/support/jsonUtils","../../../../../../symbols/SimpleLineSymbol","../../definitions","../../enums","../../WGLDisplayObject","../MeshData","../VertexVector","../templates/WGLLabelTemplate","../templates/WGLLineTemplate","../templates/WGLMarkerTemplate","../templates/WGLTemplateStore"],function(e,t,r,g,o,i,v,l,f,d,a,w,n,L,s,S,p,y,m,u,c,D){Object.defineProperty(t,"__esModule",{value:!0});var b=l.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),h={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null,esriGeometryEnvelope:null};function T(t){var e=(t.attributes?Object.keys(t.attributes):[]).map(function(e){return{name:e,alias:e,type:"string"==typeof t.attributes[e]?"esriFieldTypeString":"esriFieldTypeDouble"}});return{geometryType:null!=t.centroid?"esriGeometryPolygon":w.getJsonType(t.geometry),spatialReference:a.fromJSON(t.geometry.spatialReference),fields:e}}var _=function(){function e(e,t,r,o,l,i){this._isDD=!1,this._labelsDebugTemplate=null,this._isDD=f.isSome(r)&&"dot-density"===r.type,this._geometryType=e,this._idField=t,this._templateStore=o,l&&this._validateLabelingInfo(l)&&(this._labelTemplates=l.map(function(e){return m.default.fromLabelClass(r,e,i)}))}return Object.defineProperty(e.prototype,"templates",{get:function(){return this._templateStore},enumerable:!0,configurable:!0}),e.prototype.createMeshData=function(e){var t=new Array(5),r=new Array,o=this._labelTemplates&&0<this._labelTemplates.length,l="esriGeometryPolyline"===this._geometryType?L.HEURISTIC_GLYPHS_PER_LINE:L.HEURISTIC_GLYPHS_PER_FEATURE;return t[s.WGLGeometryType.MARKER]=new y.VertexVectors(s.WGLGeometryType.MARKER,e),t[s.WGLGeometryType.FILL]=new y.VertexVectors(s.WGLGeometryType.FILL,e,this._isDD),t[s.WGLGeometryType.LINE]=new y.VertexVectors(s.WGLGeometryType.LINE,e),t[s.WGLGeometryType.TEXT]=new y.VertexVectors(s.WGLGeometryType.TEXT,e),t[s.WGLGeometryType.LABEL]=new y.VertexVectors(s.WGLGeometryType.LABEL,o?l:0),new p.MeshData(r,t)},e.prototype.analyze=function(m,u,c,b,h){return o(this,void 0,void 0,function(){var t,r,o,l,i,a,n,s,p,y;return g(this,function(e){switch(e.label){case 0:return t=m,d.isAborted(h)?[2,[]]:f.isSome(u)?[4,u.analyze(this._idField,m,c,b,h)]:[3,2];case 1:e.sent(),e.label=2;case 2:for(r=0,o=t;r<o.length;r++){if(l=o[r],i=-1,"symbol"in l?null!=l.symbol?(a=null,"cim"===l.symbol.type&&(a=T(l)),i=this._templateStore.createTemplateGroup(l.symbol,null,null,a)):f.isSome(u)&&(i=u.match(this._idField,l,null,null,b)):f.isSome(u)&&(i=u.match(this._idField,l,this._geometryType,c,b)),D.isDynamicId(i))for(n=this._templateStore.getDynamicTemplateGroup(i),s=0,p=n;s<p.length;s++)(y=p[s])&&y.analyze&&y.analyze(this._templateStore,l,c,b);l.groupId=i}return[2,this._templateStore.finalize(h).then(function(){return t})]}})})},e.prototype.write=function(e,t,r,o,l,i,a){var n=this._templateStore.getTemplateGroup(t.groupId),s=e,p=t.localId;if(null!=p){var y=new S(p),m=!!i&&!!this._labelTemplates&&i.has(p);if(D.isDynamicId(t.groupId))for(var u=0,c=n;u<c.length;u++){(L=c[u]).bindFeature(t,r,o)}if(n&&(t.geometry||t.centroid)){var b=y.displayRecords,h=t.insertAfter;void 0!==h&&(y.insertAfter=h);var g=this._geometryType;g||(g=null!=t.centroid?"esriGeometryPolygon":w.getJsonType(t.geometry));for(var f=0,d=n;f<d.length;f++){var L=d[f],T=s.get(L.geometryType);L.writeMesh(b,T,g,p,t)}if(m){var _=this._getLabelReference(n),G=i.get(p);this._writeLabelMesh(y,s,p,t,a,G,_,l,g)}s.pushDisplayObject(y)}}else v("esri-2d-debug")&&console.debug("Got null id for feature")},e.prototype._hasBadLabelClass=function(e,t){var r=e.labelPlacement,o=h[t];if(!e.symbol)return b.warn("No LabelClass symbol specified."),!0;if(!o)return b.error(new i("mapview-labeling:unsupported-geometry-type","Unable to create labels for Feature Layer, "+t+" is not supported")),!0;if(!o.some(function(e){return e===r})){var l=o[0];r&&b.warn("Found invalid label placement type "+r+" for "+t+". Defaulting to "+l),e.labelPlacement=l}return!1},e.prototype._validateLabelingInfo=function(e){var t=this;return!e.some(function(e){return t._hasBadLabelClass(e,t._geometryType)})},e.prototype._getLabelReference=function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];if(o instanceof c.default)return o}return null},e.prototype._writeLabelMesh=function(e,t,r,o,l,i,a,n,s){for(var p=e.displayRecords,y=[],m=0;m<i.length;m++){var u=i[m],c=u.id,b=u.text,h=u.rtl,g=this._labelTemplates[c],f=t.get(g.geometryType),d=l.get(g.symbolId).glyphMosaicItems;g.bindReferenceTemplate(a),g.bindTextInfo(d,b,h),g.writeMesh(p,f,s,r,o,n,y)}e.metrics=y,L.DEBUG_LABELS&&this._debugLabels(e,t)},e.prototype._debugLabels=function(e,t){for(var r=e.displayRecords,o=e.id,l=0,i=e.metrics;l<i.length;l++)for(var a=i[l],n=0,s=a.boxes?a.boxes.concat([a.bounds]):[a.bounds];n<s.length;n++){var p=s[n],y=a.anchor[0]+a.offsetX+p.center[0],m=a.anchor[1]+a.offsetY+p.center[1],u={geometry:{paths:[[[y-p.width/2,m+p.height/2],[0,-p.height],[p.width,0],[0,p.height],[-p.width,0]]]},attributes:{}},c=this._getLabelDebugTemplate(),b=t.get(c.geometryType);c.writeMesh(r,b,"esriGeometryPolyline",o,u)}},e.prototype._getLabelDebugTemplate=function(){return this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate()),this._labelsDebugTemplate},e.prototype._createLabelsDebugTemplate=function(){var e=new n({style:"solid",width:1,color:[255,0,0,1]});return u.default.fromSimpleLine(null,!1,e,null)},e}();t.WGLMeshFactory=_});