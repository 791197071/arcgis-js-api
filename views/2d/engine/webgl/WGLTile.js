// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../DisplayObject","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./Fader","./WGLBuffers","./WGLDisplayList","../../tiling/TileKey"],function(t,e,i,r,l,d,o,n,p,a,h,y,c,f,u,D,_,g){function m(t,e){return t.sortKey-e.sortKey}Object.defineProperty(e,"__esModule",{value:!0});var q=new Set,s=function(s){function t(t,e,i){void 0===i&&(i=!1);var a=s.call(this)||this;return a._data=null,a.hlDisplayList=null,a._displayList=null,a._wglBuffers=null,a._dirtyMap=new y.default,a.coords=[0,0],a.bounds=[0,0,0,0],a.dvsMat3=o.mat3f32.create(),a.tileMat3=o.mat3f32.create(),a.labelMat2d=l.mat2df32.create(),a._labelIndex=null,a._dirty=!0,a.fader=new u.default,a.key=g.pool.acquire(t),a.coords[0]=e[0],a.coords[1]=e[3],a.bounds=e,a._ensureCorrectZOrder=i,a}return i(t,s),Object.defineProperty(t.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canDisplay",{get:function(){return!!this.attached},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._dirty},set:function(t){(this._dirty=t)||this.isReady||this.ready(),this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),t.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},t.prototype.getDisplayList=function(t){switch(t){case f.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._displayList}},Object.defineProperty(t.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),t.prototype.setData=function(t,e,i){var a=t.addOrUpdate,s=t.remove;if(this.fader.reset(),(t.clear||!this.hasData)&&!t.addOrUpdate)return this.clear(),this.ready(),void this.emit("change");!t.clear&&this.hasData||!t.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:a,remove:s},e,i):(a.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new y.default,this._dispRecStore=c.default.fromTileData(a,this._dirtyMap),this._data=a,this._readyTileIfNoLabels(e,i),this._dirtyMap.markAllDirty(),this._displayList||(this._displayList=a.tileDisplayData.displayList.clone())),this.emit("change")},t.prototype.commitChanges=function(t){this.isDirty&&this._wglBuffers||(this._wglBuffers||(this._wglBuffers=new D.default(this.stage.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())},t.prototype.setTransform=function(t,e){var i=this.tileMat3,a=t.toScreenNoRotation([0,0],this.coords),s=a[0],r=a[1],l=e;d.mat3.set(this.tileMat3,l,0,0,0,l,0,s,r,1),d.mat3.multiply(this.dvsMat3,t.displayViewMat3,i)},t.prototype.setLabelTransform=function(t,e){var i=this.labelMat2d,a=t.getScreenTransform(i,e),s=p.vec2f32.create();n.vec2.transformMat2d(s,this.coords,a),r.mat2d.identity(i),r.mat2d.translate(i,i,s),r.mat2d.multiply(i,t.viewMat2d,i)},t.prototype.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},t.prototype.attach=function(){return!0},t.prototype.dispose=function(){this.clear()},t.prototype.doRender=function(t){if(this.isReady&&this.hasData){if(this.commitChanges(t),this.stage.context.setStencilFunction(514,this.stencilRef,255),t.drawPhase===f.WGLDrawPhase.MAP||t.drawPhase===f.WGLDrawPhase.LABEL||t.drawPhase===f.WGLDrawPhase.LABEL_ALPHA)this._displayList.replay(t,this);else for(var e=0,i=this.stage.painter.getBrushes(t.drawPhase);e<i.length;e++){i[e].draw(t,this)}this.fader.step()||this.requestRender()}},t.prototype.buildHLList=function(t){if(this.data)if(this.hlDisplayList&&this.hlDisplayList.clear(),t.isEmpty)this.requestRender();else{this.hlDisplayList||(this.hlDisplayList=new _);for(var e=0,i=this.data.tileDisplayData.displayObjects;e<i.length;e++){var a=i[e];if(t.has(a.id)){for(var s=[],r=0,l=a.displayRecords;r<l.length;r++){var d=l[r].copy();d.meshData=null,d.symbolLevel=0,d.zOrder=0,s.push(d)}s.sort(m),this.hlDisplayList.addToList(s)}}this.requestRender()}else this.requestRender()},t.prototype._readyTileIfNoLabels=function(t,e){this.isDirty=!(!t||!e)&&(this._rebuildLabelIndex(),!0)},t.prototype._doPatchData=function(t,e,i){this._patchData(t)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=c.default.fromTileData(this._data,this._dirtyMap)),this._readyTileIfNoLabels(e,i),this.requestRender()},t.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var t=0,e=this.displayObjects;t<e.length;t++)for(var i=0,a=e[t].metrics;i<a.length;i++){var s=a[i];this._insertIntoLabelIndex(s)}},t.prototype._insertIntoLabelIndex=function(t){-1!==t.xBucket&&this.labelIndex[t.yBucket][t.xBucket].push(t)},t.prototype._initLabelIndex=function(){for(var t=[],e=0;e<h.TILE_SIZE/h.COLLISION_BUCKET_SIZE;e++){t.push([]);for(var i=0;i<h.TILE_SIZE/h.COLLISION_BUCKET_SIZE;i++)t[e].push([])}return t},t.prototype._patchData=function(t){for(var e=!0,i=t.addOrUpdate&&t.addOrUpdate.tileDisplayData&&t.addOrUpdate.tileDisplayData.displayObjects||[],a=(t.remove||[]).slice(),s=0,r=i;s<r.length;s++){null!=(D=r[s]).insertAfter&&a.push(D.id)}for(var l=0,d=a;l<d.length;l++){var o=d[l];if(u=this._data.tileDisplayData.displayObjectRegistry.get(o)){this._data.tileDisplayData.displayList.removeFromList(u.displayRecords);for(var n=0,p=u.displayRecords;n<p.length;n++){var h=p[n];this._dispRecStore.delete(h)}this._data.tileDisplayData.displayObjectRegistry.delete(o);var y=this._data.tileDisplayData.displayObjects.indexOf(u);this._data.tileDisplayData.displayObjects.splice(y,1)}}for(var c=0,f=i;c<f.length;c++){var u,D=f[c],_=void 0;if(u=this._data.tileDisplayData.displayObjectRegistry.get(D.id)){var g=u.displayRecords;u.set(D),u.displayRecords=g;for(var m=u.displayRecords.length,b=0;b<m;++b){var L=u.displayRecords[b],v=D.displayRecords[b];(b>=D.displayRecords.length||L.geometryType!==v.geometryType||L.symbolLevel!==v.symbolLevel||L.zOrder!==v.zOrder||L.materialKey!==v.materialKey)&&(this._dispRecStore.delete(u.displayRecords[b]),b<D.displayRecords.length&&(u.displayRecords[b]=void 0))}u.displayRecords.length=D.displayRecords.length,u.metrics=D.metrics}else{(u=D.copy()).displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(D.id,u);var R=void 0,O=this._data.tileDisplayData.displayObjects;if(null!=u.insertAfter)if(_={},0<=u.insertAfter){var x=this._data.tileDisplayData.displayObjectRegistry.get(u.insertAfter);x&&(R=O.indexOf(x)+1)<O.length?O.splice(R,0,u):(O.push(u),R=O.length)}else O.unshift(u),R=0;else O.push(u),R=O.length;if(_){var I=void 0;if(this._data.tileDisplayData.displayList.unified)I=0<D.displayRecords.length?1:0;else{q.clear();for(var w=0,B=D.displayRecords;w<B.length;w++){var T=B[w],j=this._data.tileDisplayData.displayList.getDPInfoType(T.geometryType);q.add(j)}I=q.size}var M=0;for(b=R-1;0<=b&&M<I;--b)for(var P=O[b].displayRecords.length-1;0<=P&&M<I;--P){var S=O[b].displayRecords[P];_[j=this._data.tileDisplayData.displayList.getDPInfoType(S.geometryType)]||(_[j]=S,++M)}}}var A=D.displayRecords.length;for(b=0;b<A;++b){v=D.displayRecords[b];(L=u.displayRecords[b])?(L.meshData=v.meshData,L.materialKey=v.materialKey):((L=v.copy()).vertexFrom=void 0,L.indexFrom=void 0,u.displayRecords[b]=L);var E=v.geometryType,G=(j=this._data.tileDisplayData.displayList.getDPInfoType(E),t.addOrUpdate.tileBufferData.geometries[E]),U=G.vertexBuffer,C=G.indexBuffer,K=void 0;_&&(K=_[j]?this._data.tileDisplayData.displayList.splitAfter(_[j]):-1),e=this._dispRecStore.setMeshData(L,v,U,C,K)&&e,_&&null!=L.indexFrom&&null!=L.indexFrom&&(_[j]=L)}}return e},t}(a.DisplayObject);e.WGLTile=s});