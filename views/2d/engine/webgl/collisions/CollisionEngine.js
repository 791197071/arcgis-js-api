// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/array","@dojo/framework/shim/iterator","@dojo/framework/shim/Map","../../../../../core/mathUtils","../definitions","./CollisionBucket","./LayerCollisionInfo","../../../support/mathUtils"],function(e,t,y,i,r,a,l,o,d,c){Object.defineProperty(t,"__esModule",{value:!0});var x=l.TILE_SIZE/l.COLLISION_BUCKET_SIZE,B=x,n=function(){function e(e){this._layers=new r.default,this._collisionBuckets=new r.default,this._tilingScheme=e}return Object.defineProperty(e.prototype,"collisionInfos",{get:function(){var t=[];return i.forOf(this._layers.values(),function(e){return t.push(e)}),t},enumerable:!0,configurable:!0}),e.prototype.registerLayerView=function(e,t){if(!this._layers.has(e)){var i=d.default.create(e,t,this.collisionInfos,this._tilingScheme);this._layers.set(e,i),this._collisionBuckets.forEach(function(e){return e.onRegisterLayer(i.index)})}},e.prototype.unregisterLayerView=function(e){var r=this;if(this._layers.has(e)){var o=this._layers.get(e);d.default.delete(o.index,this.collisionInfos),this._layers.delete(e),this._collisionBuckets.forEach(function(e,t){var i=e.getTile(o.index);i&&(e.onUnregisterLayer(o.index),e.canDelete()&&r._collisionBuckets.delete(t),i.reference&&(i.reference.isDirty=!1))})}},e.prototype.addTile=function(e,t){var i=t.key.id;this._layers.has(e)&&(this._collisionBuckets.has(i)||this._collisionBuckets.set(i,new o.default(t.key,this._layers.size)),this._collisionBuckets.get(i).getTile(this._getIndex(e)).reference=t)},e.prototype.removeTile=function(e,t){if(this._layers.has(e)&&this._collisionBuckets.has(t)){var i=this._collisionBuckets.get(t).getTile(this._getIndex(e));i.dirty=!1,i.reference=null}},e.prototype.run=function(e,t){for(var i=y.from(this._collisionBuckets.values()).filter(function(e){return e.key.level===t}).sort(function(e,t){return e.key.compareRowMajor(t.key)}),r=this._checkRotation(e.rotation),o=0,n=i;o<n.length;o++){var s=n[o];r=r||s.isDirty;for(var a=0;a<this._layers.size;a++){var l=d.default.find(a,this.collisionInfos);s.computeNeighbors(this._collisionBuckets),s.reset(e,r,l)}}for(var c=0;c<this._layers.size;c++){l=d.default.find(c,this.collisionInfos);for(var f=0,u=i;f<u.length;f++){s=u[f];this._run(s,l,t)}}for(var h=0,_=i;h<_.length;h++){(s=_[h]).ready()}},e.prototype._run=function(e,t,i){var r=e.getReference(t.index);r&&r.isDirty&&r.hasData&&this._runVisibility(e,r,t,i)},e.prototype._checkLabelsVisible=function(e,t){var i=!t.filter||!!(e&l.FILTER_FLAG_0),r=!t.effect||t.effect.excludedLabelsVisible||!!(e&l.EFFECT_FLAG_0);return i&&r},e.prototype._runVisibility=function(e,t,i,r){for(var o=i.layerView.tileRenderer.featuresView.attributeView,n=0,s=t.displayObjects;n<s.length;n++){var a=s[n];if(a.metrics.length){for(var l=0,c=o.getFilterFlags(a.id),f=this._checkLabelsVisible(c,i.layerView),u=0;u<a.metrics.length;u++){var h=a.metrics[u],_=f?this._computeLabelVisibility(a,h,i.index,e,t,h.baseZoom,r):255;l=Math.max(_,l)}o.setLabelMinZoom(a.id,l);for(var y=0,d=a.metrics;y<d.length;y++){(h=d[y]).minZoom=l}}}},e.prototype._computeLabelVisibility=function(e,t,i,r,o,n,s){for(var a=n,l=t.xBucket,c=t.yBucket,f=t.xOverflow,u=t.yOverflow,h=l-f,_=l+f+1,y=c+u+1,d=c-u;d<y;d++)for(var p=h;p<_;p++)if(!(p<-x||d<-B||x<p||B<d))for(var g=0;g<=i;g++){var v=this._getRelativeSubBucket(g,r,o,p,d);if(v)for(var m=0,b=v;m<b.length;m++){var k=b[m];if(k.id!==e.id){var L=this._compareLabels(t,k,a,s);a=Math.max(L,a)}}}return a},e.prototype._compareLabels=function(e,t,i,r){var o=10*(r+l.COLLISION_MAX_ZOOM_DELTA);if(-1===t.minZoom||t.minZoom>o||t.minZoom>Math.floor(10*r))return i;var n=e.findCollisionDelta(t),s=a.clamp(Math.floor(10*(n+r)),0,255);return t.minZoom>=s?i:Math.max(i,s)},e.prototype._getNeighboringTile=function(e,t,i,r,o){var n=3*(1+o)+(1+r),s=t.neighbors[n];return s&&s.getTile(e)},e.prototype._getRelativeSubBucket=function(e,t,i,r,o){var n=c.sign(Math.floor(r/4)),s=c.sign(Math.floor(o/4)),a=this._getNeighboringTile(e,t,i,n,s);return a&&a.reference&&a.index&&a.reference.hasData?a.index[o-4*s][r-4*n]:null},e.prototype._checkRotation=function(e){if(!this._lastRotation)return this._lastRotation=e,!1;var t=e!==this._lastRotation;return this._lastRotation=e,t},e.prototype._getIndex=function(e){return this._layers.get(e).index},e}();t.CollisionEngine=n});