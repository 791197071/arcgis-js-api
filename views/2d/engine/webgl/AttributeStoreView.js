// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/has","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../webgl","./definitions","./Utils","./util/debug","../../../webgl/FramebufferObject"],function(t,e,r,n,x,a,i,g,o,f,s,y,u,d){Object.defineProperty(e,"__esModule",{value:!0});f.enums.TextureWrapMode,f.enums.PixelFormat,f.enums.PixelType,f.enums.TextureSamplingMode;var b=i.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),h=u.createDebugLogger(u.DEBUG_ATTR_UPDATES,b),p=!1,l=function(){function t(t,e,i){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;var r=t.buffer,n=t.pixelType,a=t.textureOnly,o=y.getPixelArrayCtor(n);this.shared=i,this.pixelType=n,this.size=e,(this.textureOnly=a)||(this.data=new o(g.expect(r))),this._resetRange()}return t.prototype.destroy=function(){g.andThen(this._texture,function(t){return t.dispose()});var t=function(e){g.andThen(i._fbos[e],function(t){"0"===e&&t.detachColorTexture(),t.dispose()}),i._fbos[e]=null},i=this;for(var e in this._fbos)t(e);this._texture=null},Object.defineProperty(t.prototype,"_textureDesc",{get:function(){return{target:3553,wrapMode:33071,pixelFormat:6408,dataType:this.pixelType,samplingMode:9728,width:this.size,height:this.size}},enumerable:!0,configurable:!0}),t.prototype.setData=function(t,e,i){var r=g.expect(this.data),n=t*this.texelSize+e;!r||n>=r.length?a("esri-2d-debug")&&!p&&(b.error(new x("mapview-attributeStore","Attempted to set out of bounds index")),p=!0):(r[n]=i,this.dirtyStart=Math.min(this.dirtyStart,t),this.dirtyEnd=Math.max(this.dirtyEnd,t))},t.prototype.getData=function(t,e){if(g.isNone(this.data))return null;var i=t*this.texelSize+e;return!this.data||i>=this.data.length?(a("esri-2d-debug")&&!p&&(b.error(new x("mapview-attributeStore","Attempted to read out of bounds index")),p=!0),null):this.data[i]},t.prototype.getTexture=function(t){var e=this;return g.unwrapOr(this._texture,function(){return e._initTexture(t)})},t.prototype.getFBO=function(t,e){if(void 0===e&&(e=0),g.isNone(this._fbos[e])){var i=0===e?this.getTexture(t):this._textureDesc;this._fbos[e]=d.createWithAttachments(t,i,{colorTarget:0,depthStencilTarget:0})}return this._fbos[e]},Object.defineProperty(t.prototype,"locked",{get:function(){return!(5121!==this.pixelType||!this.shared||this.textureOnly||!a("esri-atomics")||!this.data)&&1===Atomics.load(this.data,0)},enumerable:!0,configurable:!0}),t.prototype.updateTexture=function(t){if(!this.locked)try{var e=this.dirtyStart,i=this.dirtyEnd;if(i<e)return;this._resetRange();var r=g.expect(this.data).buffer,n=this.getTexture(t),a=(e-e%this.size)/this.size,o=(i-i%this.size)/this.size,s=a,u=this.size,d=o,h=a*this.size*4,p=4*(u+d*this.size)-h,l=y.getPixelArrayCtor(this.pixelType),T=l.BYTES_PER_ELEMENT;try{new l(r,h*T,p)}catch(t){console.debug(t)}var c=new l(r,h*T,p),f=this.size,_=d-s+1;if(_>this.size)return void b.error(new x("mapview-webgl","Out-of-bounds index when updating AttributeData"));n.updateData(0,0,s,f,_,c)}catch(t){console.debug(t)}},t.prototype.update=function(t){var e=t.data,i=t.start,r=t.end;if(g.isSome(e))for(var n=this.data,a=i*this.texelSize,o=0;o<e.length;o++){var s=1<<o%this.texelSize;t.layout&s&&(n[a+o]=e[o])}this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,r)},t.prototype.resize=function(t,e){var i=this.size;if(this.size=e,this.textureOnly)i!==this.size&&(this._lastTexture=this._texture,this._texture=null);else{var r=y.getPixelArrayCtor(this.pixelType);this.destroy(),this.data=new r(g.expect(t.buffer))}},t.prototype._resetRange=function(){this.dirtyStart=4294967295,this.dirtyEnd=0},t.prototype._initTexture=function(t){var e=new f.Texture(t,this._textureDesc,g.unwrapOr(this.data,void 0));if(g.isSome(this._lastTexture)&&this._fbos[0]){var i=this._lastTexture.descriptor.width,r=this._lastTexture.descriptor.height,n=this._lastTexture.descriptor.dataType,a=this._lastTexture.descriptor.pixelFormat,o=this.getFBO(t),s=y.getPixelBytes(n),u=new(y.getPixelArrayCtor(n))(new ArrayBuffer(i*r*s*this.texelSize)),d=t.getBoundFramebufferObject(),h=t.getViewport(),p=h.x,l=h.y,T=h.width,c=h.height;t.bindFramebuffer(o),o.readPixels(0,0,i,r,a,n,u),e.updateData(0,0,0,2*i,r/2,u),t.setViewport(p,l,T,c),t.bindFramebuffer(d)}return this.destroy(),this._texture=e,this._texture},t}(),T=function(){function t(){this._initialized=!1,this._forceNextUpload=!1,this._locked=!1}return t.prototype.initialize=function(t){var e=t.blocks,i=t.shared,r=t.size;if(this.shared=i,this.size=r,h("Initializing AttributeStoreView",t),g.isNone(this._data))this._data=g.mapMany(e,function(t){return new l(t,r,i)});else for(var n=0;n<this._data.length;n++){var a=this._data[n],o=e[n];g.isSome(o)&&(g.isNone(a)?this._data[n]=new l(o,r,i):a.resize(o,r))}this._initialized=!0},t.prototype.destroy=function(){g.andThen(this._data,function(t){return g.mapMany(t,function(t){return t.destroy()})}),g.andThen(this._defaultTexture,function(t){return t.dispose()})},t.prototype.getBlock=function(t){return g.isNone(this._data)?null:this._data[t]},t.prototype.setLabelMinZoom=function(t,e){this.setData(t,0,1,e)},t.prototype.getLabelMinZoom=function(t){return this.getData(t,0,1,255)},t.prototype.getFilterFlags=function(t){return this.getData(t,0,0,0)},t.prototype.getVVSize=function(t){return this.getData(t,s.ATTRIBUTE_DATA_VV,0,0)},t.prototype.getData=function(t,e,i,r){if(!this._data)return 0;var n=g.expect(this._data)[e];if(g.isNone(n))return 0;var a=n.getData(t,i);return g.isSome(a)?a:r},t.prototype.setData=function(t,e,i,r){var n=g.expect(this._data)[e];g.expect(n).setData(t,i,r)},t.prototype.lockTextureUpload=function(){this._locked=!0},t.prototype.unlockTextureUpload=function(){this._locked=!1},t.prototype.forceTextureUpload=function(){this._forceNextUpload=!0},t.prototype.requestUpdate=function(i){return n(this,void 0,void 0,function(){var e;return r(this,function(t){return this._pendingAttributeUpdate?(b.error(new x("mapview-webgl","Tried to update attribute data with a pending update")),[2]):(e=o.createResolver(),h("AttributeStoreView Update Requested",i),this._pendingAttributeUpdate={data:i,resolver:e},[2,e.promise])})})},t.prototype.update=function(){if(this._initialized&&g.isSome(this._pendingAttributeUpdate)){for(var t=this._pendingAttributeUpdate,r=t.data,e=t.resolver,n=g.expect(this._data),i=function(i){var t=r.blocks[i],e=n[i];g.andThen(e,function(e){return g.andThen(t,function(t){h("Updating block "+i,t),e.update(t)})})},a=0;a<r.blocks.length;a++)i(a);this._pendingAttributeUpdate=null,e()}},t.prototype.bindTextures=function(e){this.update();var t=this._getDefaultTexture(e);if(!this._initialized)return e.bindTexture(t,s.TEXTURE_BINDING_ATTRIBUTE_DATA_0),e.bindTexture(t,s.TEXTURE_BINDING_ATTRIBUTE_DATA_1),e.bindTexture(t,s.TEXTURE_BINDING_ATTRIBUTE_DATA_2),void e.bindTexture(t,s.TEXTURE_BINDING_ATTRIBUTE_DATA_3);var i=g.expect(this._data);this._locked&&!this._forceNextUpload||(g.forEachSome(i,function(t){return t.updateTexture(e)}),this._forceNextUpload=!1),e.bindTexture(g.mapOr(i[0],t,function(t){return t.getTexture(e)}),s.TEXTURE_BINDING_ATTRIBUTE_DATA_0),e.bindTexture(g.mapOr(i[1],t,function(t){return t.getTexture(e)}),s.TEXTURE_BINDING_ATTRIBUTE_DATA_1),e.bindTexture(g.mapOr(i[2],t,function(t){return t.getTexture(e)}),s.TEXTURE_BINDING_ATTRIBUTE_DATA_2),e.bindTexture(g.mapOr(i[3],t,function(t){return t.getTexture(e)}),s.TEXTURE_BINDING_ATTRIBUTE_DATA_3)},t.prototype._getDefaultTexture=function(t){if(g.isNone(this._defaultTexture)){this._defaultTexture=new f.Texture(t,{wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array(4))}return this._defaultTexture},t}();e.AttributeStoreView=T});