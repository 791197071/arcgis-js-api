// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/asyncUtils","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../support/arcadeOnDemand","../../../../../symbols/support/cimSymbolUtils","../../../arcade/utils"],function(t,e,r,M,f,p,n,h,T,x,o){Object.defineProperty(e,"__esModule",{value:!0});var l=n.getLogger("esri/views/2d/engine/webgl/util/Matcher"),i=function(){function l(){this._defaultResult=null}return l.fromBasicRenderer=function(i,a,o){return f(this,void 0,void 0,function(){var e,r,n;return M(this,function(t){switch(t.label){case 0:return[4,x.expandSymbols(i.getSymbols(),x.constructUrlFn)];case 1:return e=t.sent(),r=new l,e.length&&(n=a.createTemplateGroup(e[0],null,i,o),r.setDefault(n)),[2,r]}})})},l.prototype.size=function(){return 1},l.prototype.getDefault=function(){return this._defaultResult},l.prototype.setDefault=function(t){this._defaultResult=t},l.prototype.match=function(t,e,r,n,i){return this.getDefault()},l.prototype.analyze=function(t,e,r,n,i){return f(this,void 0,void 0,function(){return M(this,function(t){return[2]})})},l}(),a=function(a){function F(t,e,r,n){var i=a.call(this)||this;return i._intervals=[],i._isMaxInclusive=e,n?i._getValue=o.callWithFeature.bind(null,n):t&&t.length?i._getValue="function"==typeof t?(i._field=null,t):(i._field=t,i._normalizationInfo=r,i._getValueFromField.bind(i)):i._field=null,i}return r(F,a),F.fromCBRenderer=function(y,g,z){return f(this,void 0,void 0,function(){var e,r,n,i,a,o,l,u,s,c,f,p,h,d,m,_,v,b;return M(this,function(t){switch(t.label){case 0:return e=y.isMaxInclusive,r=y.normalizationField,n=y.normalizationTotal,i=y.normalizationType,a=y.field,o={normalizationField:r,normalizationTotal:n,normalizationType:i},l=y.valueExpression,(u=l)?[4,T.createRendererExpression(l,z.spatialReference,z.fields)]:[3,2];case 1:u=t.sent(),t.label=2;case 2:return s=new F(a,e,o,u),[4,x.expandSymbol(y.backgroundFillSymbol,x.constructUrlFn)];case 3:c=t.sent(),f=0,p=y.classBreakInfos,t.label=4;case 4:return f<p.length?(h=p[f],[4,x.expandSymbol(h.symbol,x.constructUrlFn)]):[3,7];case 5:d=t.sent(),m=g.createTemplateGroup(d,c,y,z),_={min:h.minValue,max:h.maxValue},s.add(_,m),t.label=6;case 6:return f++,[3,4];case 7:return[4,x.expandSymbol(y.defaultSymbol,x.constructUrlFn)];case 8:return(v=t.sent())&&(b=g.createTemplateGroup(v,c,y,z),s.setDefault(b)),[2,s]}})})},F.prototype.add=function(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort(function(t,e){return t.interval.min-e.interval.min})},F.prototype.size=function(){return a.prototype.size.call(this)+this._intervals.length},F.prototype.match=function(t,e,r,n,i){if(!this._getValue)return this.getDefault();var a=this._getValue(e,{$view:i},r,n);if(!a&&(null==a||isNaN(a)))return this.getDefault();for(var o=0;o<this._intervals.length;o++){var l=this._intervals[o],u=l.interval,s=l.result,c=a>=u.min,f=this._isMaxInclusive?a<=u.max:a<u.max;if(c&&f)return s}return this.getDefault()},F.prototype._needsNormalization=function(){var t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)},F.prototype._getValueFromField=function(t){var e=t.attributes[this._field];if(!this._needsNormalization())return e;var r=this._normalizationInfo,n=r.normalizationField,i=r.normalizationTotal,a=r.normalizationType,o=!!n&&t.attributes[n];if(a)switch(a){case"field":return o?e/o:void 0;case"log":return Math.log(e)*Math.LOG10E;case"percent-of-total":return e/i*100;default:return void l.error("Found unknown normalization type: "+a)}else l.error("Normalization is required, but no type was set!")},F}(e.FeatureMatcher=i);e.IntervalMatcher=a;var u=function(i){function v(t,e,r){var n=i.call(this)||this;return n._resultsMap=new Map,r?n._getValue=o.callWithFeature.bind(null,r):t&&t.length?"function"==typeof t[0]?(n._fields=null,n._getValue=t[0]):(n._fields=t,n._seperator=e||"",n._getValue=n._getValueFromFields.bind(n)):n._fields=null,n}return r(v,i),v.fromUVRenderer=function(d,m,_){return f(this,void 0,void 0,function(){var e,r,n,i,a,o,l,u,s,c,f,p,h;return M(this,function(t){switch(t.label){case 0:return e=d.uniqueValueInfos,r=d.fieldDelimiter,n=[d.field],i=d.valueExpression,d.field2&&n.push(d.field2),d.field3&&n.push(d.field3),[4,x.expandSymbol(d.backgroundFillSymbol,x.constructUrlFn)];case 1:return a=t.sent(),(o=i)?[4,T.createRendererExpression(i,_.spatialReference,_.fields)]:[3,3];case 2:o=t.sent(),t.label=3;case 3:l=new v(n,r,o),u=0,s=e,t.label=4;case 4:return u<s.length?(c=s[u],[4,x.expandSymbol(c.symbol,x.constructUrlFn)]):[3,7];case 5:f=t.sent(),p=m.createTemplateGroup(f,a,d,_),l.add(c.value,p),t.label=6;case 6:return u++,[3,4];case 7:return[4,x.expandSymbol(d.defaultSymbol,x.constructUrlFn)];case 8:return t.sent()&&(h=m.createTemplateGroup(d.defaultSymbol,a,d,_),l.setDefault(h)),[2,l]}})})},v.prototype.add=function(t,e){this._resultsMap.set(t.toString(),e)},v.prototype.size=function(){return i.prototype.size.call(this)+this._resultsMap.size},v.prototype.match=function(t,e,r,n,i){if(!this._getValue)return this.getDefault();var a=this._getValue(e,{$view:i},r,n);if(!a&&null==a)return this.getDefault();var o=a.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()},v.prototype._getValueFromFields=function(t){for(var e=[],r=0,n=this._fields;r<n.length;r++){var i=n[r],a=t.attributes[i];e.push(a)}return e.join(this._seperator)},v}(i);e.MapMatcher=u;var s=function(i){function a(t,e,r){var n=i.call(this)||this;return n._fidToAttributeHash=new Map,n._attributeHashToGroup=new Map,n._renderer=t,n._fieldMap=t.fieldMap,n._templates=e,n._info=r,n}return r(a,i),a.fromDictionaryRenderer=function(e,r,n){return f(this,void 0,void 0,function(){return M(this,function(t){return e.fetchResources(),[2,new a(e,r,n)]})})},a.prototype.analyze=function(u,s,t,e,c){return f(this,void 0,void 0,function(){var a,e,o,r,n,i,l=this;return M(this,function(t){switch(t.label){case 0:for(a=[],e=function(t){var e=t.attributes[u],r=o._fidToAttributeHash.get(e),n=o._hashAttributes(t);if(r===n)return"continue";if(o._fidToAttributeHash.set(e,n),!o._attributeHashToGroup.has(n)){var i=p.safeCast(o._renderer.fetchSymbol(t,c)).then(function(t){var e=l._templates.createTemplateGroup(t,null,l._renderer,l._info);l._attributeHashToGroup.set(n,e)});a.push(i)}},o=this,r=0,n=s;r<n.length;r++)i=n[r],e(i);return[4,h.all(a)];case 1:return t.sent(),[2]}})})},a.prototype.match=function(t,e,r,n,i){var a=e.attributes[t],o=this._fidToAttributeHash.get(a);return this._attributeHashToGroup.get(o)},a.prototype._hashAttributes=function(t){var e="";for(var r in this._fieldMap)e+=". "+t.attributes[this._fieldMap[r]];return e},a}(i);e.DictionaryMatcher=s});