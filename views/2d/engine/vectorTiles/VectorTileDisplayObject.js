// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/vec2f32","../../../../geometry/support/spatialReferenceUtils","../../../webgl","../../engine","./RenderBucket"],function(e,t,r,a,i,f,n,s,c,u){var o=(s.enums.CompareFunction,s.enums.Usage,function(e){function t(){for(var t,r=[],a=0;a<arguments.length;a++)r[a]=arguments[a];var n=e.call(this)||this;return n._renderBuckets=[],n._vectorTileData=null,n._symbolUpdateData=null,n._memoryUsed=l,n.coords=[0,0],n.bounds=[0,0,0,0],n.tileTransform={transform:i.mat4f32.create(),displayCoord:f.vec2f32.create()},n.stencilData={mask:0,reference:0},n._referenced=0,n.triangleCount=0,r.length>0&&(t=n.acquire).call.apply(t,[n].concat(r)),n}return r(t,e),Object.defineProperty(t.prototype,"stencilRef",{get:function(){return this.stencilData.reference},enumerable:!0,configurable:!0}),t.prototype.acquire=function(e,t,r,a){this.key=e,this._referenced=1,this._memoryUsed=l,this._symbolUpdateData=null,this._vectorTileData=null;var i=t.lodAt(e.level),f=null!==i?i.resolution:0,s=t.size[0]*f,c=t.origin,u=e.col*s,o=e.row*s,h=t.spatialReference,x=h&&(h._isWrappable?h._isWrappable():h.isWrappable),d=0;if(x){var D=n.getInfo(h);d=D.valid[1]-D.valid[0]}var B=e.world*d,y=c.x+u+B,b=c.y-o,p=y+s,v=b-s;this.coords[0]=y,this.coords[1]=b,this.bounds[0]=y,this.bounds[1]=b,this.bounds[2]=p,this.bounds[3]=v,this.widthInPixels=t.size[1],this.coordRange=4096,this.resolution=f,this.rotation=a,this.styleLayers=r,this.id=e.id},t.prototype.setData=function(e,t,r){this._vectorTileData=e,this.client=t,this.refKeys=r,this._memoryUsed=l},t.prototype.updateSymbolData=function(e){e&&(this._symbolUpdateData=e,this.requestRender())},t.prototype.updateTileData=function(e){this._vectorTileData=e,this.stage.requestRender(),this._memoryUsed=l},t.prototype.dispose=function(){for(var e=["fillVertexArrayObject","fillDDVertexArrayObject","outlineVertexArrayObject","lineVertexArrayObject","lineDDVertexArrayObject","iconVertexArrayObject","iconDDVertexArrayObject","textVertexArrayObject","textDDVertexArrayObject","circleVertexArrayObject","fillVertexBuffer","fillDDVertexBuffer","fillIndexBuffer","outlineVertexBuffer","outlineDDVertexBuffer","outlineIndexBuffer","lineVertexBuffer","lineDDVertexBuffer","lineIndexBuffer","iconVertexBuffer","iconDDVertexBuffer","iconIndexBuffer","textVertexBuffer","textDDVertexBuffer","textIndexBuffer","circleVertexBuffer","circleIndexBuffer","texture"],t=0,r=e;t<r.length;t++){var a=r[t];this[a]&&(this[a].dispose(),this[a]=null)}this._renderBuckets.length=0,this._memoryUsed=l},t.prototype.release=function(){return 0==--this._referenced&&(this.dispose(),this.attached=!1,this.stage=null,!0)},t.prototype.reference=function(){++this._referenced},Object.defineProperty(t.prototype,"referenced",{get:function(){return this._referenced},enumerable:!0,configurable:!0}),t.prototype.getMemoryUsage=function(){var e=this;return this._memoryUsed===l&&(this._memoryUsed=h.reduce(function(t,r){return e[r]?t+e[r].size:t},0),this.texture&&(this._memoryUsed+=this.texture.descriptor.width*this.texture.descriptor.height*4),this._vectorTileData&&this._vectorTileData.bufferData&&(this._memoryUsed+=this._vectorTileData.bufferData.reduce(function(e,t){return e+t.byteLength},0)+this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength)),this._memoryUsed/(this._referenced||1)},t.prototype.attach=function(){return!!this._vectorTileData&&(this.ready(),!0)},t.prototype.attachWithContext=function(e){this.stage={context:e},this.attached=this.attach()},t.prototype._commitChanges=function(){this._vectorTileData&&(this.dispose(),this._createRenderBuckets(),this._createBufferObjects(),this._vectorTileData=null,this._memoryUsed=l)},t.prototype._createRenderBuckets=function(){for(var e=new Uint32Array(this._vectorTileData.bucketDataInfo),t=e.length,r=0;r<t;){var a=e[r];switch(e[r+1]){case 0:var i=new u.BackgroundRenderBucket;i.layerID=a,this._renderBuckets.push(i),r+=2;break;case 1:var f=new u.FillRenderBucket;f.layerID=a,f.triangleElementStart=e[r+2],f.triangleElementCount=e[r+3],f.outlineElementStart=e[r+4],f.outlineElementCount=e[r+5],this._renderBuckets.push(f),r+=6;break;case 2:var n=new u.LineRenderBucket;n.layerID=a,n.triangleElementStart=e[r+2],n.triangleElementCount=e[r+3],this._renderBuckets.push(n),r+=4;break;case 3:var s=new u.SymbolRenderBucket;s.layerID=a,s.isSDF=0!==e[r+2];var c=r+3,o=e[c];c++;for(var l=0;l<o;l++){var h=e[c],x=e[c+1],d=e[c+2];s.markerPerPageElementsMap.set(h,[x,d]),c+=3}var D=c,B=e[D];D++;for(var l=0;l<B;l++){var h=e[D],x=e[D+1],d=e[D+2];s.glyphPerPageElementsMap.set(h,[x,d]),D+=3}this._renderBuckets.push(s),r+=5+3*o+3*B;break;case 4:var y=new u.CircleRenderBucket;y.layerID=a,y.triangleElementStart=e[r+2],y.triangleElementCount=e[r+3],this._renderBuckets.push(y),r+=4;break;default:console.error("Bad bucket type!"),r+=2}}},t._createBufferToObject=function(){var e=[];return e[1]={create:s.BufferObject.createVertex,var:"fillVertexBuffer"},e[2]={create:s.BufferObject.createVertex,var:"fillDDVertexBuffer"},e[3]={create:s.BufferObject.createIndex,var:"fillIndexBuffer"},e[4]={create:s.BufferObject.createVertex,var:"outlineVertexBuffer"},e[5]={create:s.BufferObject.createVertex,var:"outlineDDVertexBuffer"},e[6]={create:s.BufferObject.createIndex,var:"outlineIndexBuffer"},e[7]={create:s.BufferObject.createVertex,var:"lineVertexBuffer"},e[8]={create:s.BufferObject.createVertex,var:"lineDDVertexBuffer"},e[9]={create:s.BufferObject.createIndex,var:"lineIndexBuffer"},e[10]={create:s.BufferObject.createVertex,var:"iconVertexBuffer"},e[11]={create:s.BufferObject.createVertex,var:"iconDDVertexBuffer"},e[12]={create:s.BufferObject.createIndex,var:"iconIndexBuffer"},e[13]={create:s.BufferObject.createVertex,var:"textVertexBuffer"},e[14]={create:s.BufferObject.createVertex,var:"textDDVertexBuffer"},e[15]={create:s.BufferObject.createIndex,var:"textIndexBuffer"},e[16]={create:s.BufferObject.createVertex,var:"circleVertexBuffer"},e[17]={create:s.BufferObject.createIndex,var:"circleIndexBuffer"},e},t.prototype._createBufferObjects=function(){for(var e=this.stage.context,r=new Uint32Array(this._vectorTileData.bufferDataInfo),a=r.length,i=0;i<a;i+=2){var f=r[i+1],n=i/2;if(!(f<=0||0===this._vectorTileData.bufferData[n].byteLength)){var s=r[i],c=t.bufferToObject[s];c?this[c.var]?this[c.var].setData(this._vectorTileData.bufferData[n]):this[c.var]=c.create(e,35044,this._vectorTileData.bufferData[n]):console.error("Bad buffer type "+s)}}},t.prototype.detach=function(){this.isReady&&this.client&&this.client.invoke("destructTileData",this.id),this.dispose(),e.prototype.detach.call(this)},t.prototype.doRender=function(e){if(this.visible&&this.isReady){var t=this.stage.context,r=e.renderer;if(t&&r){this._commitChanges();var a=e.drawphase;this._symbolUpdateData&&(this._updateSymbolData(e,this._symbolUpdateData),this._symbolUpdateData=null),t.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var i=this.styleLayers,f=void 0!==e.layerOpacity?e.layerOpacity:1;if(0!==f){var n=this._renderBuckets.length;if(1===a)for(var s=n-1;s>=0;s--){var c=this._renderBuckets[s],u=i.layers[c.layerID];if(!c||!u)return;1!==c.type&&0!==c.type||!c.hasData()||(this.triangleCount+=r.renderBucket(t,c,e.displayLevel,e.requiredLevel,a,this,u,f))}else for(var s=0;s<n;s++){var c=this._renderBuckets[s],u=i.layers[c.layerID];if(!c||!u)return;c.hasData()&&(this.triangleCount+=r.renderBucket(t,c,e.displayLevel,e.requiredLevel,a,this,u,f))}}}}},t.prototype._updateSymbolData=function(e,t){if(!t||!t.bucketDataInfo)return!0;var r=new Uint32Array(t.bucketDataInfo),a=r.length;if(0===a)return!0;if(this._memoryUsed=l,!this.isReady)return this.requestRender(),!1;for(var i=this.stage.context,f=new Uint32Array(t.bufferDataInfo),n=f.length,c=0,o=0;o<n;o+=2,c++){switch(f[o]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconVertexBuffer=s.BufferObject.createVertex(i,35044,t.bufferData[c]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null),this.iconDDVertexBuffer=s.BufferObject.createVertex(i,35044,t.bufferData[c]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.iconIndexBuffer=s.BufferObject.createIndex(i,35044,t.bufferData[c]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textVertexBuffer=s.BufferObject.createVertex(i,35044,t.bufferData[c]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null),this.textDDVertexBuffer=s.BufferObject.createVertex(i,35044,t.bufferData[c]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=s.BufferObject.createIndex(i,35044,t.bufferData[c])}}for(var h=[],x=0;x<this._renderBuckets.length;x++)this._renderBuckets[x]instanceof u.SymbolRenderBucket||h.push(this._renderBuckets[x]);this._renderBuckets=h;for(var d,D=0;D<a;){var B=r[D];d=new u.SymbolRenderBucket,d.layerID=B,d.isSDF=0!==r[D+2],this.styleLayers.layers.length>d.layerID&&this.styleLayers.layers[d.layerID].type===d.type&&h.push(d);var y=D+3,b=r[y];y++;for(var p=0;p<b;p++){var v=r[y],V=r[y+1],m=r[y+2];d.markerPerPageElementsMap.set(v,[V,m]),y+=3}var _=y,O=r[_];_++;for(var p=0;p<O;p++){var v=r[_],V=r[_+1],m=r[_+2];d.glyphPerPageElementsMap.set(v,[V,m]),_+=3}D+=5+3*b+3*O}return this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null),!0},t.pool=new a(t),t.bufferToObject=t._createBufferToObject(),t}(c.DisplayObject)),l=-1,h=["fillVertexBuffer","fillDDVertexBuffer","fillIndexBuffer","outlineVertexBuffer","outlineDDVertexBuffer","outlineIndexBuffer","lineVertexBuffer","lineDDVertexBuffer","lineIndexBuffer","iconVertexBuffer","iconDDVertexBuffer","iconIndexBuffer","textVertexBuffer","textDDVertexBuffer","textIndexBuffer","circleVertexBuffer","circleIndexBuffer"];return o});