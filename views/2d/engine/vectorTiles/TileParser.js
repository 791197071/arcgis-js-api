// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/pbf","../../../../core/promiseUtils","./BackgroundBucket","./CircleBucket","./Feature","./FillBucket","./LineBucket","./SourceLayerData","./SymbolBucket","../webgl/TileClipper","../../tiling/enums"],function(e,t,r,i,n,l,s,a,u,o,c,f,h,p,_){var y=1;return function(){function e(e,t,r){this._pbfTiles={},this._tileClippers={},this._client=r,this._tile=t,this._layers=t.getLayers();var i=t.tileKey.split("/").map(parseFloat),l=i[0],s=i[1],a=i[2];this._level=l;for(var u=Math.max(8,Math.round(y*this._level)-8),o=0,c=Object.keys(e);o<c.length;o++){var f=c[o],h=e[f];this._pbfTiles[f]=new n(new Uint8Array(h.protobuff),new DataView(h.protobuff));if(h.refKey){var _=h.refKey.split("/").map(parseFloat)[0],v=l-_;if(v>0){var B=(1<<v)-1,x=s&B,g=a&B;this._tileClippers[f]=new p.TileClipper(v,x,g,8,u)}}this._tileClippers[f]||(this._tileClippers[f]=new p.SimpleBuilder)}}return e.prototype.parse=function(e){return i(this,void 0,void 0,function(){var t,i,n,s,a,o,c,f,h,p,y,v,B,x,g,k,y,d,D,m,w,b,I,C,V,F,L,S,T,z,O,j,H,K,H,M,v,g,d,A,E,U,W,q,G,N,R,y,J,P,Q,H,X,x,A,Y,Z,y,$,ee,y,te,re,ie,ne,le,se,ae,ue=this;return r(this,function(r){for(t=e&&e.signal,i=this._parseTileData(this._pbfTiles),n=this._layers,s=this._level,o=[],c=this._tileClippers,f={},h={},p=n.length-1;p>=0;p--)a=n[p],a.minzoom&&s<a.minzoom||a.maxzoom&&s>=a.maxzoom||a.layout&&a.layout.visibility&&"none"===a.layout.visibility||(0!==a.type?i[a.source]&&c[a.source]&&(v=i[a.source],B=c[a.source],x=a.sourceLayer,(g=v[x])&&(k=h[a.source],k||(k=h[a.source]=new Set),k.add(a.sourceLayer),(y=this._createBucket(a))&&(y.layerIndex=p,y.layerExtent=g.extent,y.tileClipper=B,d=f[a.source],d||(d=f[a.source]={}),D=d[x],D||(D=d[x]=[]),D.push(y)))):(y=this._createBucket(a),y.layerIndex=p,o.push(y)));for(m=10*this._level,w=10*(this._level+1),b=[],I=[],C=[],V=[],F=new Set,L={},S=[],T=[],z=function(e){h[e].forEach(function(t){S.push(t),T.push(e)})},O=0,j=Object.keys(h);O<j.length;O++)H=j[O],z(H);for(K=0;K<S.length&&(H=T[K],M=S[K],i[H]&&f[H])&&(v=i[H],g=v[M],d=f[H],(A=d[M])&&0!==A.length);K++){if(l.isAborted(t))return[2];for(E=g.getData();E.next(2);){if(U=new u(E.getMessage(),g),W=U.values){if((q=W._minzoom)&&q>=w)continue;if((G=W._maxzoom)&&G<=m)continue}for(N=0,R=A;N<R.length;N++)y=R[N],y.pushFeature(U)}}for(J=this._tile,P=0,Q=Object.keys(f);P<Q.length;P++){H=Q[P],X=f[H];for(x in X)for(A=X[x],Y=0,Z=A;Y<Z.length;Y++)y=Z[Y],y.hasFeatures()&&(3===y.layer.type?(b.push(y),J.addBucket(y)):y.layer.refLayerId?C.push(y):(I.push(y),V[y.layer.id]=y))}for($=0,ee=b;$<ee.length;$++)y=ee[$],te=y,te.getResources(te.tileClipper,F,L);if(this._tile.status===_.TileStatus.INVALID)return[2,l.resolve([])];re=[],ie=this._tile.getWorkerTileHandler(),F.size>0&&(ne=ie.fetchSprites(F,this._client,e),re.push(ne));for(se in L)ae=L[se],ae.size>0&&(le=ie.fetchGlyphs(this._tile.tileKey,se,ae,this._client,e),re.push(le));return[2,l.all(re).then(function(){for(var e=0,t=I;e<t.length;e++){var r=t[e];r.processFeatures(r.tileClipper,ue._tile),o.push(r)}for(var i=0,n=C;i<n.length;i++){var l=n[i],s=V[l.layer.refLayerId];s&&(s.assignBufferInfo(l),o.push(l))}for(var a=0,u=b;a<u.length;a++){var c=u[a];c.processFeatures(c.tileClipper,ue._tile),o.push(c)}return o.sort(function(e,t){return e.layerIndex-t.layerIndex}),o})]})})},e.prototype._parseTileData=function(e){for(var t={},r=0,i=Object.keys(e);r<i.length;r++){for(var n=i[r],l=e[n],s={};l.next();)switch(l.tag()){case 3:var a=new f(l.getMessage());s[a.name]=a;break;default:l.skip()}t[n]=s}return t},e.prototype._createBucket=function(e){switch(e.type){case 0:return this._createBackgroundBucket(e);case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 4:return this._createCircleBucket(e);case 3:return this._createSymbolBucket(e)}},e.prototype._createBackgroundBucket=function(e){return new s(e,this._level)},e.prototype._createFillBucket=function(e){var t=this._tile;return new o(e,this._level,e.hasDataDrivenFill?t.fillDDVertexBuffer:t.fillVertexBuffer,t.fillIndexBuffer,e.hasDataDrivenOutline?t.outlineDDVertexBuffer:t.outlineVertexBuffer,t.outlineIndexBuffer)},e.prototype._createLineBucket=function(e){var t=this._tile;return new c(e,this._level,e.hasDataDrivenLine?t.lineDDVertexBuffer:t.lineVertexBuffer,t.lineIndexBuffer)},e.prototype._createCircleBucket=function(e){var t=this._tile;return new a(e,this._level,t.circleVertexBuffer,t.circleIndexBuffer)},e.prototype._createSymbolBucket=function(e){var t=this._tile;return new h(e,this._level,e.hasDataDrivenIcon?t.iconDDVertexBuffer:t.iconVertexBuffer,t.iconIndexBuffer,e.hasDataDrivenText?t.textDDVertexBuffer:t.textVertexBuffer,t.textIndexBuffer,t.placementEngine,t.getWorkerTileHandler())},e}()});