// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/has","../../../../core/promiseUtils","../../../../core/scheduling","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/vec2f32","../../../../core/libs/gl-matrix-2/vec3f32","../../../webgl","../../engine","../../tiling","./GeometryUtils","./renderers/Renderer","../../tiling/TileCoverage"],function(e,t,i,r,s,a,o,l,n,d,c,h,p,f,u,y){function _(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col}var v=h.enums.WGLDrawPhase;c.enums.BlendFactor,c.enums.CompareFunction,c.enums.StencilOperation;return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._tileCoordinateScale=d.vec3f32.create(),t._orientationVec=d.vec3f32.fromValues(0,0,1),t._displayScale=d.vec3f32.create(),t._defaultTransform=l.mat4f32.create(),t._displayWidth=0,t._displayHeight=0,t._backgroundTile={tileTransform:{transform:l.mat4f32.create(),displayCoord:n.vec2f32.create()},coords:[0,0],key:p.TileKey.pool.acquire(),coordRange:4096},t._pointToCallbacks=new Map,t}return i(t,e),t.prototype.initialize=function(e,t,i,r){var s=this;this._spriteMosaicPromise=e,this._spriteMosaicPromise.then(function(i){s._spriteMosaicPromise===e&&(s._renderer=new u(i,t))}),this._tileInfoView=r,this._tileInfo=i},t.prototype.dispose=function(){this._renderer&&this._renderer.dispose(),p.TileKey.pool.release(this._backgroundTile.key),e.prototype.dispose.call(this)},t.prototype.hitTest=function(e,t){var i=this,r=[e,t];return s.create(function(e,t){i._pointToCallbacks.set(r,{resolve:e,reject:t}),i.requestRender()},function(){i._pointToCallbacks.has(r)&&i._pointToCallbacks.delete(r)})},t.prototype.renderChildren=function(t){var i=this;if(0!==this.children.length&&this._tileInfoView&&t&&t.state&&(t.drawPhase===v.MAP||t.drawPhase===v.HITTEST)){if(!this._renderer)return void this.requestRender();if(r("esri-vector-tiles-debug"))for(var s=0,o=this.children;s<o.length;s++){var l=o[s];l.triangleCount=0}var n=t.state,d=this.stage.context,c=this._renderer;c.initializeProgramCache(this.stage.context),c.setGlobalOpacity(d,t,this.opacity);var h=t;h.displayLevel=this._tileInfoView.scaleToLevel(n.scale),h.requiredLevel=this._tileInfoView.getSmallestInfoForScale(n.scale).level,h.renderer=this._renderer;var p=t.drawPhase===v.HITTEST?4:0;d.setDepthWriteEnabled(!1),d.setStencilTestEnabled(!1),this._renderBackgroundBuckets(h,this._styleRepository.backgroundBucketIds,p),d.setDepthWriteEnabled(!0),d.setStencilWriteMask(255),d.setClearDepth(1),d.setClearStencil(0),d.clear(d.gl.DEPTH_BUFFER_BIT|d.gl.STENCIL_BUFFER_BIT),d.setDepthWriteEnabled(!1),this.sortChildren(function(e,t){return _(e,t)});for(var f=this.children.length,u=1;u<=f;u++){var y=this.children[u-1];y.attached&&y.visible&&(y.stencilData.reference=u,y.stencilData.mask=255)}if(this._updateTilesTransform(h.state,h.requiredLevel,this.children),d.setDepthWriteEnabled(!0),this._renderer.setStateParams(h.state,h.pixelRatio,h.displayLevel),this._renderer.drawClippingMasks(d,this.children),d.setStencilWriteMask(0),d.setBlendFunctionSeparate(1,771,1,771),d.setStencilOp(7680,7680,7681),d.setDepthFunction(515),d.setBlendingEnabled(!1),d.setStencilTestEnabled(!0),d.setDepthTestEnabled(!0),d.setDepthWriteEnabled(!0),h.drawphase=1,e.prototype.renderChildren.call(this,h),d.setDepthWriteEnabled(!1),d.setBlendingEnabled(!0),h.drawphase=2,e.prototype.renderChildren.call(this,h),h.drawphase=3,e.prototype.renderChildren.call(this,h),d.setStencilTestEnabled(!1),d.setDepthTestEnabled(!1),c.applyGlobalOpacity(d,t,this.opacity),r("esri-vector-tiles-debug"))for(var m=0,g=this.children;m<g.length;m++){var l=g[m];l.attached&&l.visible&&this._renderer.renderTileInfo(d,l)}this._pointToCallbacks.size>0&&(this._pointToCallbacks.forEach(function(e,t){var r=i._hitTest(h,t[0],t[1]);a.schedule(function(){e.resolve(r)})}),this._pointToCallbacks.clear()),this._renderer.needsRedraw()&&this.requestRender()}},t.prototype.removeAllChildren=function(){for(var t=0;t<this.children.length;t++){this.children[t].dispose()}e.prototype.removeAllChildren.call(this)},t.prototype.setStyleRepository=function(e){this._styleRepository=e},t.prototype._hitTest=function(e,t,i){var r=this._tileInfoView.getSmallestInfoForScale(e.state.scale).level,s=[0,0];e.state.toMap(s,[t,i]);var a=e.state.clone(),o=a.viewpoint.clone(),l=o.targetGeometry;l.x=s[0],l.y=s[1],o.targetGeometry=l,a.viewpoint=o,a.size=[3,3],this._renderer.setStateParams(a,e.pixelRatio,e.displayLevel);var n={context:this.stage.context,drawPhase:0,pixelRatio:e.pixelRatio,stationary:e.stationary,globalOpacity:e.globalOpacity,displayLevel:e.displayLevel,requiredLevel:e.requiredLevel,renderer:e.renderer,layerOpacity:e.layerOpacity,state:a,drawphase:4},d=this._renderer.hitTest(n,t,i,this.children,r,3,this._updateTilesTransform.bind(this));return d&&0!==d.length?d[0]:null},t.prototype._updateTilesTransform=function(e,t,i){var r=1/e.size[0],s=1/e.size[1],a=[0,0];this._calculateRelativeViewProjMat(this._tileInfo.lodAt(t).resolution,e.resolution,e.rotation,this._tileInfo.size[1],4096,e.size[0],e.size[1],this._defaultTransform);for(var o=0,l=i;o<l.length;o++){var n=l[o];e.toScreen(a,n.coords),a[1]=e.size[1]-a[1],n.tileTransform.displayCoord[0]=2*a[0]*r-1,n.tileTransform.displayCoord[1]=2*a[1]*s-1,n.key.level===t&&4096===n.coordRange?n.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this._tileInfo.lodAt(n.key.level).resolution,e.resolution,e.rotation,this._tileInfo.size[1],n.coordRange,e.size[0],e.size[1],n.tileTransform.transform)}},t.prototype._calculateRelativeViewProjMat=function(e,t,i,r,s,a,l,n){var d=e/t,c=.125;512!==r&&4096!==s&&(c=r/s);var h=c*d;this._tileCoordinateScale.set([h,h,1]),a===this._displayWidth&&l===this._displayHeight||(this._displayScale.set([2/a,-2/l,1]),this._displayWidth=a,this._displayHeight=l),o.mat4.identity(n),o.mat4.scale(n,n,this._tileCoordinateScale),o.mat4.rotate(n,n,-i*f.C_DEG_TO_RAD,this._orientationVec),o.mat4.scale(n,n,this._displayScale),o.mat4.transpose(n,n)},t.prototype._renderBackgroundBuckets=function(e,t,i){if(t&&0!==t.length){var r=e.state,s=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),a=r.resolution,o=r.rotation,l=r.size,n=s.spans,d=s.lodInfo,c=d.level,h=this._tileInfo,p=this.stage.context,f=e.displayLevel,u=this._backgroundTile;this._calculateRelativeViewProjMat(h.lodAt(c).resolution,a,o,h.size[1],u.coordRange,l[0],l[1],u.tileTransform.transform);for(var _,v=[0,0],m=1/r.size[0],g=1/r.size[1],T=0,b=n;T<b.length;T++)for(var k=b[T],C=k.row,w=k.colFrom,S=k.colTo,R=w;R<=S;R++){var z=u.key;z.set(c,C,d.normalizeCol(R),d.getWorldForColumn(R)),this._tileInfoView.getTileCoords(u.coords,z),r.toScreen(v,u.coords),v[1]=r.size[1]-v[1],u.tileTransform.displayCoord[0]=2*v[0]*m-1,u.tileTransform.displayCoord[1]=2*v[1]*g-1;for(var I=0,E=t;I<E.length;I++){var x=E[I];_=this._styleRepository.layers[x],void 0!==_.minzoom&&_.minzoom>f+1e-6||void 0!==_.maxzoom&&_.maxzoom<=f-1e-6||this._renderer.renderBackGroundLayer(p,_,x,u,e.requiredLevel,i,1)}}y.pool.release(s)}},t}(h.Container)});