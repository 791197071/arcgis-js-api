// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","./Conflict","./GeometryUtils","../webgl/Geometry"],function(t,e,n,i,o){Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,i,o){void 0===n&&(n=0),void 0===i&&(i=-1),void 0===o&&(o=s),this.x=t,this.y=e,this.angle=n,this.segment=i,this.minzoom=o}return t}();e.Anchor=r;var a=function(){function t(t,e,n,o,r,a,l){void 0===r&&(r=!1),void 0===a&&(a=s),void 0===l&&(l=i.C_INFINITY),this.anchor=t,this.labelAngle=e,this.glyphAngle=n,this.page=o,this.upsideDown=r,this.minzoom=a,this.maxzoom=l}return t}(),l=function(){function t(t,e,n,i,o,r,a,l,h,s){this.tl=t,this.tr=e,this.bl=n,this.br=i,this.mosaicRect=o,this.labelAngle=r,this.anchor=a,this.minzoom=l,this.maxzoom=h,this.page=s}return t}();e.PlacedSymbol=l;var h=function(){function t(t,e){this.footprint=t,this.shapes=e}return t}();e.Placement=h;var s=.5,c=function(){function t(){this.mapAngle=0,this._conflictEngine=new n.ConflictEngine}return t.prototype.reset=function(){this._conflictEngine.reset()},t.prototype.setAngle=function(t){this.mapAngle=t,this._conflictEngine.setAngle(t)},t.prototype.getIconPlacement=function(t,e,r,a,c,p,g){var m=r.width/r.pixelRatio,f=r.height/r.pixelRatio,u=p.offset[0]-m/2,I=p.offset[1]-f/2,d=u+m,x=I+f,_=r.rect,w=2/r.pixelRatio,y=u-w,v=I-w,N=y+_.width/r.pixelRatio,P=v+_.height/r.pixelRatio,A=new o.Point(y,v),E=new o.Point(N,P),T=new o.Point(y,P),b=new o.Point(N,v),C=p.rotate*i.C_DEG_TO_RAD,M=1===p.rotationAlignment;if(t.segment>=0&&!M&&(C+=t.angle),0!==C){var z=Math.cos(C),F=Math.sin(C);A.rotate(z,F),E.rotate(z,F),T.rotate(z,F),b.rotate(z,F)}var Y=8*p.padding,B=new o.Point(t.x,t.y),G=new n.Footprint(this.mapAngle,Y,M);G.addBox(B,new n.Box(u,I,d,x),a,C,e,s,i.C_INFINITY);var R=new l(A,b,T,E,_,0,B,s,i.C_INFINITY,0),O=new h(G,[R]),D=s;return p.allowOverlap||(D=this._conflictEngine.getMinZoom(O.footprint,D,g,M)),G.minzoom=D,O},t.prototype.getTextPlacement=function(t,e,r,c,p,g,m,f){for(var u,I=new o.Point(t.x,t.y),d=m.rotate*i.C_DEG_TO_RAD,x=0===m.rotationAlignment,_=m.keepUpright,w=s,y=!x,v=y?0:t.angle,N=t.segment>=0&&x,P=8*m.padding,A=new n.Footprint(this.mapAngle,P,y),E=[],T=!N,b=Number.POSITIVE_INFINITY,C=Number.NEGATIVE_INFINITY,M=b,z=C,F=N?_:x&&_,Y=0,B=c;Y<B.length;Y++){var G=B[Y],R=G.glyphMosaicItem;if(R&&!R.rect.isEmpty){var O=R.rect,D=R.metrics,q=R.page;T&&(u&&u!==G.y&&(A.addBox(I,new n.Box(b,M,C,z),p,d,e,s,i.C_INFINITY),b=Number.POSITIVE_INFINITY,C=Number.NEGATIVE_INFINITY,M=b,z=C),u=G.y);var V=[];if(N){var S=.5*R.metrics.width,k=(r.x+G.x+D.left-4+S)*p;if(w=this._placeGlyph(t,w,k,g,t.segment,1,q,V),_&&(w=this._placeGlyph(t,w,k,g,t.segment,-1,q,V)),w>=2)break}else V.push(new a(I,v,v,q)),x&&_&&V.push(new a(I,v+i.C_PI,v+i.C_PI,q,!0));for(var U=G.x+r.x+D.left,Z=G.y+r.y-D.top,j=U+D.width,H=Z+D.height,J=new o.Point(U-4,Z-4),K=new o.Point(J.x+O.width,J.y+O.height),L=new o.Point(J.x,K.y),Q=new o.Point(K.x,J.y),W=0,X=V;W<X.length;W++){var $=X[W],tt=J.clone(),et=L.clone(),nt=Q.clone(),it=K.clone(),ot=Z,rt=H,at=$.glyphAngle+d;if(0!==at){var lt=Math.cos(at),ht=Math.sin(at);tt.rotate(lt,ht),it.rotate(lt,ht),et.rotate(lt,ht),nt.rotate(lt,ht)}E.push(new l(tt,nt,et,it,O,$.labelAngle,$.anchor,$.minzoom,$.maxzoom,$.page)),F&&!this._legible($.labelAngle)||(T?(U<b&&(b=U),ot<M&&(M=ot),j>C&&(C=j),rt>z&&(z=rt)):$.minzoom<2&&A.addBox($.anchor,new n.Box(U,ot,j,rt),p,at,e,$.minzoom,$.maxzoom))}}}if(w>=2)return null;T&&A.addBox(I,new n.Box(b,M,C,z),p,d,e,s,i.C_INFINITY);var st=new h(A,E);return m.allowOverlap||(w=this._conflictEngine.getMinZoom(st.footprint,w,f,y)),A.minzoom=w,st},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var e=i.radToByte(t);return e<65||e>=193},t.prototype._placeGlyph=function(t,e,n,r,l,h,s,c){var p=h,g=p<0?i.positiveMod(t.angle+i.C_PI,i.C_2PI):t.angle,m=this._legible(g),f=0;n<0&&(p*=-1,n*=-1,f=i.C_PI),p>0&&++l;var u=new o.Point(t.x,t.y),I=r[l],d=i.C_INFINITY;if(r.length<=l)return d;for(;;){var x=I.x-u.x,_=I.y-u.y,w=Math.sqrt(x*x+_*_),y=Math.max(n/w,e),v=x/w,N=_/w,P=i.positiveMod(Math.atan2(N,v)+f,i.C_2PI);if(c.push(new a(u,g,P,s,m,y,d)),y<=e)return y;u=I.clone();do{if(l+=p,r.length<=l||l<0)return y;I=r[l]}while(u.isEqual(I));var A=I.x-u.x,E=I.y-u.y,T=Math.sqrt(A*A+E*E);A*=w/T,E*=w/T,u.x-=A,u.y-=E,d=y}},t}();e.PlacementEngine=c});