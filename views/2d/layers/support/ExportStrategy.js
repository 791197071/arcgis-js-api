// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Extent","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","../../engine","../../viewStateUtils","../../tiling/TileInfoView","../../tiling/TileKey"],function(e,t,r,o,i,a,n,p,s,u,l,c,d,h,g,m,f,y){var x=c.create(),v=[0,0],S=new y(0,0,0,0),M={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};return function(e){function t(t){var r=e.call(this,t)||this;return r._imagePromise=null,r.hidpi=M.hidpi,r.imageMaxWidth=M.imageMaxWidth,r.imageMaxHeight=M.imageMaxHeight,r.imageRotationSupported=M.imageRotationSupported,r.imageNormalizationSupported=M.imageNormalizationSupported,r.update=s.debounce(function(e){return i(r,void 0,void 0,function(){var t,r,i,a,n,p,u,l,c,h=this;return o(this,function(o){return t=e.state,r=d.getInfo(t.spatialReference),i=this.hidpi?e.pixelRatio:1,!e.stationary||this.destroyed?[2]:(this.imageRotationSupported?(v[0]=t.size[0],v[1]=t.size[1]):m.getOuterSize(v,t),a=Math.floor(v[0]*i)>this.imageMaxWidth||Math.floor(v[1]*i)>this.imageMaxHeight,n=r&&(t.extent.xmin<r.valid[0]||t.extent.xmax>r.valid[1]),p=!this.imageNormalizationSupported&&n,u=!a&&!p,l=this.imageRotationSupported?t.rotation:0,u?this._imagePromise=this._singleExport(t,v,l,i):(c=Math.min(this.imageMaxWidth,this.imageMaxHeight),p&&(c=Math.min(t.worldScreenWidth,c)),this._imagePromise=this._tiledExport(t,c,l,i)),[2,this._imagePromise.then(function(e){h._imagePromise=null;var t=h.container.children.slice();h.container.removeAllChildren(),e.forEach(h.container.addChild,h.container),h.disposeSource&&t.forEach(function(e){h.disposeSource(e.source)},h)}).catch(function(e){if(h._imagePromise=null,!s.isAbortError(e))throw e})])})})}),r}return a(t,e),t.prototype.destroy=function(){},Object.defineProperty(t.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0}),t.prototype.updateExports=function(e){for(var t=0,r=this.container.children;t<r.length;t++){var o=r[t];if(!o.visible||!o.attached)return;e(o)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(o.invalidateTexture(),o.requestRender())}},t.prototype._export=function(e,t,r,o,i){var a=this;return s.resolve().then(function(){return a.fetchSource(e,Math.floor(t*i),Math.floor(r*i),{rotation:o,pixelRatio:i})}).then(function(r){var a=new g.Bitmap(r);return a.x=e.xmin,a.y=e.ymax,a.resolution=e.width/t,a.rotation=o,a.pixelRatio=i,a})},t.prototype._singleExport=function(e,t,r,o){m.getBBox(x,e.center,e.resolution,t);var i=new l(x[0],x[1],x[2],x[3],e.spatialReference);return this._export(i,t[0],t[1],r,o).then(function(e){return[e]})},t.prototype._tiledExport=function(e,t,r,o){var i=this,a=h.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),n=new f(a),p=n.getTileCoverage(e);if(!p)return null;var u=[];return p.forEach(function(a,p,s,c){S.set(a,p,s,c),n.getTileBounds(x,S);var d=new l(x[0],x[1],x[2],x[3],e.spatialReference);u.push(i._export(d,t,t,r,o))}),s.all(u)},n([u.property()],t.prototype,"_imagePromise",void 0),n([u.property()],t.prototype,"container",void 0),n([u.property()],t.prototype,"disposeSource",void 0),n([u.property()],t.prototype,"fetchSource",void 0),n([u.property()],t.prototype,"hidpi",void 0),n([u.property()],t.prototype,"imageMaxWidth",void 0),n([u.property()],t.prototype,"imageMaxHeight",void 0),n([u.property()],t.prototype,"imageRotationSupported",void 0),n([u.property()],t.prototype,"imageNormalizationSupported",void 0),n([u.property()],t.prototype,"requestUpdate",void 0),n([u.property({dependsOn:["_imagePromise"]})],t.prototype,"updating",null),t=n([u.subclass("esri.views.2d.layers.support.ExportStrategy")],t)}(u.declared(p))});