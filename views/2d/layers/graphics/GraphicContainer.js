// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Evented","../../../../core/Handles","../../../../core/promiseUtils","../../engine"],function(e,t,i,r,n,a,l,o,h,s){Object.defineProperty(t,"__esModule",{value:!0});var g=function(e){function t(t){var i=e.call(this)||this;return i._highlightMap=new Map,i._localToGlobalId=t,i}return r(t,e),Object.defineProperty(t.prototype,"isEmpty",{get:function(){return 0===this._highlightMap.size},enumerable:!0,configurable:!0}),t.prototype.has=function(e){var t=this._localToGlobalId(e);return this._highlightMap.has(t)},t.prototype.create=function(e){var t=this,i={remove:null,objectIds:e,objectIdSet:new Set};i.remove=function(){return t._delete(i)};for(var r=0,n=e;r<n.length;r++){var a=n[r];i.objectIdSet.add(a),this._highlightMap.has(a)||this._highlightMap.set(a,new Set),this._highlightMap.get(a).add(i)}return this.emit("change"),i},t.prototype._delete=function(e){for(var t=0,i=e.objectIds;t<i.length;t++){var r=i[t],n=this._highlightMap.get(r);n.delete(e),0===n.size&&this._highlightMap.delete(r)}this.emit("change")},t}(l),d=function(e){function t(t){var i=e.call(this)||this;return i._displayHeight=0,i._displayWidth=0,i._rendererInfo=new s.WGLRendererInfo,i._tileDataChangeHandles=new o,i.attributeView=new s.AttributeStoreView,i._tileDataChangeHandler=function(e){e.target.buildHLList(i._highlightManager)},i._highlightManagerChangeHandler=function(){for(var e=0,t=i.children;e<t.length;e++){t[e].buildHLList(i._highlightManager)}},i.tileInfoView=t.tileInfoView,i.getMaterialItems=i.getMaterialItems.bind(i),i._highlightManager=new g(t.localToGlobalId),i._highlightManagerChangeHandle=i._highlightManager.on("change",i._highlightManagerChangeHandler.bind(i)),i}return r(t,e),t.prototype.dispose=function(){this.removeAllChildren();for(var e=0,t=this.children;e<t.length;e++){t[e].dispose()}this._tileDataChangeHandles.removeAll(),this._highlightManagerChangeHandle.remove(),this.attributeView.destroy()},t.prototype.disposeWebGLResources=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].clear()}},t.prototype.highlight=function(e){return this._highlightManager.create(e)},t.prototype.displayWidth=function(){return this._displayWidth},Object.defineProperty(t.prototype,"displayHeight",{get:function(){return this._displayHeight},enumerable:!0,configurable:!0}),t.prototype.setVisibility=function(e,t){},t.prototype.getMaterialItems=function(e,t){var i=e;if(!i||0===i.length)return null;for(var r=[],n=this.stage.painter.textureManager,a=0,l=i;a<l.length;a++){var o=l[a];r.push(n.rasterizeItem(o.symbol,o.glyphIds,t))}return h.all(r).then(function(e){return e.map(function(e,t){return{id:i[t].id,mosaicItem:e}})})},t.prototype.addChild=function(t){e.prototype.addChild.call(this,t);var i=t.on("change",this._tileDataChangeHandler);return this._tileDataChangeHandles.add(i,t),t},t.prototype.removeChild=function(t){return e.prototype.removeChild.call(this,t),this._tileDataChangeHandles.remove(t),t},t.prototype.renderChildren=function(e){var t=this.stage.painter;if(this._updateTilesTransform(e.state,this.tileInfoView.getClosestInfoForScale(e.state.scale).level),e.drawPhase===s.enums.WGLDrawPhase.MAP){this.attributeView.update(this.stage.context),this.attributeView.bindTextures(this.stage.context);var r=this.tileInfoView.getClosestInfoForScale(e.state.scale).level,n=this.tileInfoView.tileInfo.scaleToZoom(e.state.scale),a=this._rendererInfo,l=i({},e,{rendererInfo:a,requiredLevel:r,displayLevel:n,context:this.stage.context,painter:t,attributeView:this.attributeView});this.sortChildren(function(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col});var o=l.drawPhase;t.draw(l,this.children,o,null),this._highlightManager.isEmpty||t.highlight(l,this.children)}},t.prototype._updateTilesTransform=function(e,t){for(var i=0,r=this.children;i<r.length;i++){var n=r[i],a=this.tileInfoView.tileInfo.lods[n.key.level].resolution,l=a/(e.resolution*e.pixelRatio);n.setTransform(e,l)}},t}(s.Container);t.default=d});