// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/intersects","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/spatialReferenceUtils","../../engine"],function(e,t,r,n,a,i,s,m,o,c,l,x,v,f,u,p,h){function g(e){if(v.isPolygon(e))for(var t=0,r=e.rings;t<r.length;t++){var n=r[t];n.length<3||(n[0][0]===n[n.length-1][0]&&n[0][1]===n[n.length-1][1]||n.push(n[0]))}}function d(e,t,r,n,a,i,s,m){if(!n||!r)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;var o=n;if(!v.isPoint(o)){l.getBoundsXY(e,o);var c=t[0];0===c&&(c=X(r,a),t[0]=c);var x=i*c,f=x/2;return e[0]-=f,e[1]-=f,e[2]+=f,e[3]+=f,e}var u=o.x,p=o.y;return"text"===r.type&&0===t[2]&&0===t[3]&&k(t,r,a),z(e,u,p,r,t,i,m),e}function y(e){return"simple-marker"===e||"picture-marker"===e||"text"===e}function M(e){switch(r.expect(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}function b(e,t,r,n){s.vec2.set(F,t,r);for(var a,i,m,o,c,l,x,v,f,u=e.paths,p=1/0,h=0;h<u.length;h++){var g=u[h];if(!(g.length<2))for(var d=1;d<g.length;d++)a=g[d-1][0],m=g[d-1][1],i=g[d][0],o=g[d][1],c=Math.min(a,i)-n,l=Math.min(m,o)-n,x=Math.max(a,i)+n,v=Math.max(m,o)+n,t<c||t>x||r<l||r>v||(s.vec2.set(Y,a,m),s.vec2.set(j,i,o),s.vec2.subtract(K,j,Y),s.vec2.subtract(Q,Y,F),s.vec2.scale(V,K,s.vec2.dot(K,Q)/s.vec2.dot(K,K)),s.vec2.subtract(Z,Q,V),f=s.vec2.dot(Z,Z),p>f&&(p=f))}return Math.sqrt(p)<=n}function I(e,t,r,i,m){var o,c,l=n.pt2px(r.xoffset),x=n.pt2px(r.yoffset),v=C*r.angle,f=C*m;switch(r.type){case"simple-marker":var u=r;o=c=n.pt2px(u.size);break;case"picture-marker":var p=r;o=n.pt2px(p.width),c=n.pt2px(p.height)}var h=a.mat2d.identity(q);a.mat2d.translate(h,h,s.vec2.set(J,e,t)),a.mat2d.rotate(h,h,f-v),a.mat2d.scale(h,h,s.vec2.set(J,i,-i)),a.mat2d.translate(h,h,s.vec2.set(J,l,-x));var g=[0,0];s.vec2.transformMat2d(g,s.vec2.set(J,-.5*o,-.5*c),h);var d=[0,0];s.vec2.transformMat2d(d,s.vec2.set(J,-.5*o,.5*c),h);var y=[0,0];s.vec2.transformMat2d(y,s.vec2.set(J,.5*o,-.5*c),h);var M=[0,0];return s.vec2.transformMat2d(M,s.vec2.set(J,.5*o,.5*c),h),{rings:[[g,y,M,d,g]]}}function T(e,t,r,i,m){var o=h.CIMSymbolHelper.getEnvelope(r.data);if(!o)return null;var c=n.pt2px(o.width),l=n.pt2px(o.height),x=n.pt2px(o.x),v=n.pt2px(o.y),f=0*C,u=C*m,p=a.mat2d.identity(q);a.mat2d.translate(p,p,s.vec2.set(J,e,t)),a.mat2d.rotate(p,p,u-f),a.mat2d.scale(p,p,s.vec2.set(J,i,-i)),a.mat2d.translate(p,p,s.vec2.set(J,x,-v));var g=[0,0];s.vec2.transformMat2d(g,s.vec2.set(J,-.5*c,-.5*l),p);var d=[0,0];s.vec2.transformMat2d(d,s.vec2.set(J,-.5*c,.5*l),p);var y=[0,0];s.vec2.transformMat2d(y,s.vec2.set(J,.5*c,-.5*l),p);var M=[0,0];return s.vec2.transformMat2d(M,s.vec2.set(J,.5*c,.5*l),p),{rings:[[g,y,M,d,g]]}}function S(e,t,r,i,m,o){var c=h.alignmentUtils.getYAnchorDirection(r.verticalAlignment||"baseline"),l="baseline"===(r.verticalAlignment||"baseline"),x=n.pt2px(r.xoffset),v=n.pt2px(r.yoffset),f=n.pt2px(r.font.size)/24,u=4*f,p=l?25*f:i[1]+(1+c)*i[3]*.5,g=C*r.angle,d=C*o,y=a.mat2d.identity(q);a.mat2d.translate(y,y,s.vec2.set(J,e,t)),a.mat2d.rotate(y,y,d-g),a.mat2d.scale(y,y,s.vec2.set(J,m,-m)),a.mat2d.translate(y,y,s.vec2.set(J,x,-v)),a.mat2d.translate(y,y,s.vec2.set(J,-u,-u-p));var M=[0,0];s.vec2.transformMat2d(M,s.vec2.set(J,i[0],i[1]),y);var b=[0,0];s.vec2.transformMat2d(b,s.vec2.set(J,i[0],i[1]+i[3]),y);var I=[0,0];s.vec2.transformMat2d(I,s.vec2.set(J,i[0]+i[2],i[1]),y);var T=[0,0];return s.vec2.transformMat2d(T,s.vec2.set(J,i[0]+i[2],i[1]+i[3]),y),{rings:[[M,I,T,b,M]]}}function w(e){var t,r,n,a,i,s,m,o,c=null;if(!e)return null;t=e.spatialReference,r=u.getInfo(t),n=t.isWebMercator,s=n?102100:4326,a=ee[s].maxX,i=ee[s].minX,m=ee[s].plus180Line,o=ee[s].minus180Line;var f,p=e.toJSON();if(!r)return p;if("mesh"===e.type)f=p;else if(v.isPoint(p))f=L(p,a,i);else if(v.isMultipoint(p))p.points=p.points.map(function(e){return L(e,a,i)}),f=p;else if(v.isExtent(p))f=U(p,r);else if(v.isPolygon(p)||v.isPolyline(p)){var h=O;l.getBoundsXY(h,p);var g={xmin:h[0],ymin:h[1],xmax:h[2],ymax:h[3]},d=E(g.xmin,i),y=d*(2*a),M=0===y?p:N(p,y);g.xmin+=y,g.xmax+=y,x.extentIntersectsPolyline(g,m)&&g.xmax!==a?c=M:x.extentIntersectsPolyline(g,o)&&g.xmin!==i?c=M:f=M}else f=e.clone();if(null!==c){return(new te).cut(c,a)}return f}function X(e,t){var r=0;switch(e.type){case"simple-fill":case"picture-fill":var n=e.outline;if(!n)return 0;r=n.width;break;case"simple-line":r=e.width;break;case"simple-marker":r=e.size;break;case"picture-marker":r=Math.max(e.width,e.height);break;case"text":var a=[0,0,0,0];k(a,e,t),r=Math.max(a[0],a[1]);break;case"cim":var i=h.CIMSymbolHelper.getEnvelope(e.data);r=Math.sqrt(i.width*i.width+i.height*i.height)}return r}function k(e,t,r){if(!r||0===r.glyphMosaicItems.length)return e;var a=h.bidiText(t.text),i=a[0],s=a[1],m=h.alignmentUtils.getJustification(t.horizontalAlignment||"center"),o=h.alignmentUtils.getXAnchorDirection(t.horizontalAlignment||"center"),c=r.glyphMosaicItems,l=new h.TextShapingNew([c],h.definitions.TEXT_MAX_WIDTH,h.definitions.TEXT_LINE_HEIGHT,h.definitions.TEXT_SPACING,[0,.5*-G],.5*(1-o),0,m),x=l.getShaping(i,s),v=h.fontUtils.getFontDecorationTop(t.font.decoration);isNaN(v)||h.TextShapingNew.addDecoration(x,v);var f=h.TextShapingNew.getBox(x),u=n.pt2px(t.font.size),p=u/$;return e[0]=p*f.x,e[1]=p*f.y,e[2]=p*f.width,e[3]=p*f.height,e}function P(e,t,r){var a=h.bidiText(t.text),i=a[0],s=a[1],m=h.alignmentUtils.getJustification(t.horizontalAlignment||"center"),o=h.alignmentUtils.getXAnchorDirection(t.horizontalAlignment||"center"),c=new h.TextShapingNew([],D,G,W,[0,.5*-G],.5*(1-o),0,m),l=c.getEstimatedShaping(i,s,r),x=h.TextShapingNew.getBox(l),v=n.pt2px(t.font.size),f=v/$;return e[0]=f*x.x,e[1]=f*x.y,e[2]=f*x.width,e[3]=f*x.height,e}function z(e,t,r,n,a,i,s){var m;switch(n.type){case"simple-marker":case"picture-marker":m=I(t,r,n,i,0);break;case"text":m=S(t,r,n,a,i,0);break;case"cim":m=T(t,r,n,i,0)}for(var o,c,l=0,x=0;x<m.rings[0].length-1;x++)c=m.rings[0][x],o=(t-c[0])*(t-c[0])+(r-c[1])*(r-c[1]),l=Math.max(l,o);l=Math.sqrt(l);var v=f.normalizeMapX(t-l,s),u=f.normalizeMapX(t+l,s);if(v>u){var h=p.getInfo(s);if(h){var g=h.valid,d=g[0],y=g[1];v=d,u=y}}return e[0]=v,e[1]=r-l,e[2]=u,e[3]=r+l,e}function A(e){return v.isPolygon(e)?e.rings:e.paths}function E(e,t){return Math.ceil((e-t)/(2*t))}function N(e,t){for(var r=A(e),n=0,a=r;n<a.length;n++)for(var i=a[n],s=0,m=i;s<m.length;s++){var o=m[s];o[0]+=t}return e}function U(e,t){if(!t)return e;var r=_(e,t).map(function(e){return e.extent});return r.length<2?r[0]||e:r.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:r.map(function(e){return[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]})}}function _(e,t){var r,n=[],a=e.ymin,i=e.ymax,s=e.xmax-e.xmin,m=e.xmin,o=e.xmax,c=t.valid,l=c[0],x=c[1];r=R(e.xmin,t);var v=r.x,f=r.frameId;r=R(e.xmax,t);var u=r.x,p=r.frameId,h=v===u&&s>0;if(s>2*x){var g={xmin:m<o?v:u,ymin:a,xmax:x,ymax:i},d={xmin:l,ymin:a,xmax:m<o?u:v,ymax:i},y={xmin:0,ymin:a,xmax:x,ymax:i},M={xmin:l,ymin:a,xmax:0,ymax:i},b=[],I=[];B(g,y)&&b.push(f),B(g,M)&&I.push(f),B(d,y)&&b.push(p),B(d,M)&&I.push(p);for(var T=f+1;T<p;T++)b.push(T),I.push(T);n.push({extent:g,frameIds:[f]},{extent:d,frameIds:[p]},{extent:y,frameIds:b},{extent:M,frameIds:I})}else v>u||h?n.push({extent:{xmin:v,ymin:a,xmax:x,ymax:i},frameIds:[f]},{extent:{xmin:l,ymin:a,xmax:u,ymax:i},frameIds:[p]}):n.push({extent:{xmin:v,ymin:a,xmax:u,ymax:i},frameIds:[f]});return n}function R(e,t){var r,n=t.valid,a=n[0],i=n[1],s=2*i,m=0;return e>i?(r=Math.ceil(Math.abs(e-i)/s),e-=r*s,m=r):e<a&&(r=Math.ceil(Math.abs(e-a)/s),e+=r*s,m=-r),{x:e,frameId:m}}function B(e,t){var r=t.xmin,n=t.ymin,a=t.xmax,i=t.ymax;return H(e,r,n)&&H(e,r,i)&&H(e,a,i)&&H(e,a,n)}function H(e,t,r){return t>=e.xmin&&t<=e.xmax&&r>=e.ymin&&r<=e.ymax}function L(e,t,r){if(Array.isArray(e)){var n=e[0];if(n>t){var a=E(n,t);e[0]=n+a*(-2*t)}else if(n<r){var a=E(n,r);e[0]=n+a*(-2*r)}}else{var n=e.x;if(n>t){var a=E(n,t);e.x+=a*(-2*t)}else if(n<r){var a=E(n,r);e.x+=a*(-2*r)}}return e}Object.defineProperty(t,"__esModule",{value:!0});var C=Math.PI/180,D=h.definitions.TEXT_MAX_WIDTH,G=h.definitions.TEXT_LINE_HEIGHT,W=h.definitions.TEXT_SPACING,q=i.mat2df32.create(),J=m.vec2f32.create(),O=c.create();t.ensureClosedRings=g,t.getBounds=d,t.isMarkerSymbol=y,t.graphicGeometryToNumber=M;var Y=m.vec2f32.create(),j=m.vec2f32.create(),F=m.vec2f32.create(),K=m.vec2f32.create(),Q=m.vec2f32.create(),V=m.vec2f32.create(),Z=m.vec2f32.create();t.isPointOnPolyline=b,t.getMarkerSymbolBounds=I,t.getCIMMarkerBounds=T,t.getTextSymbolBounds=S,t.normalizeCentralMeridian=w;var $=24;t.getTextSymbolSize=k,t.getTextSymbolEstimatedSize=P;var ee={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:o.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:o.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:o.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:o.WGS84}}},te=function(){function e(){}return e.prototype.cut=function(e,t){var r;if(e.rings)this.closed=!0,r=e.rings,this.minPts=4;else{if(!e.paths)return null;this.closed=!1,r=e.paths,this.minPts=2}for(var n=r.length,a=-2*t,i=0;i<n;i++){var s=r[i];if(s&&s.length>=this.minPts){for(var m=[],o=0,c=s;o<c.length;o++){var l=c[o];m.push([l[0]+a,l[1]])}r.push(m)}}return this.closed?e.rings=r:e.paths=r,e},e}()});