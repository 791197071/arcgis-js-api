// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Viewpoint","../../core/asyncUtils","../../core/Collection","../../core/maybe","../../core/promiseUtils","../../core/unitUtils","../../core/wgs84Constants","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],function(e,t,r,n,a,c,o,i,s,u,l,f,m,y,v,g,d,p,x,h,b,M,w){function S(e,t,r){var n=f.common.toDegree(t[0]/Y);return v.vec2.set(e,r?n:n-360*Math.floor((n+180)/360),f.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/Y))))}function R(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(f.common.toRadian(r)),v.vec2.set(e,f.common.toRadian(t[0])*Y,.5*Y*Math.log((1+r)/(1-r)))}function A(e,t,r,n){return n&&r&&!n.equals(r)&&M.canProject(n,r)&&n.isWebMercator?n.isWebMercator?R(e,t):S(e,t):v.vec2.copy(e,t)}function G(e){return e.wkid?e:e.spatialReference||h.WGS84}function P(e,t){return t.type?v.vec2.set(e,t.x,t.y):v.vec2.copy(e,t)}function j(e){return u.getMetersPerUnitForSR(e)}function T(e,t){return Math.max(e.width/t[0],e.height/t[1])*C(e.spatialReference)}function B(e,t,a,c){return n(this,void 0,void 0,function(){var n,u,l,f,m,y,v,g,h,b,w,S,R,A,G,P,j,T,z,g,O,k,V,q,F,N,W,I,U;return r(this,function(r){switch(r.label){case 0:if(!e)return[2,null];if(Array.isArray(e)&&!e.length)return[2,null];if(o.isCollection(e)&&(e=e.toArray()),!Array.isArray(e)||!e.length||"object"!=typeof e[0])return[3,7];if(u=e.every(function(e){return"attributes"in e}),l=e.some(function(e){return!e.geometry}),f=e,!(u&&l&&t&&t.allLayerViews))return[3,2];for(m=new Map,y=0,v=e;y<v.length;y++)g=v[y],h=g.layer,b=m.get(h)||[],w=g.attributes[h.objectIdField],null!=w&&b.push(w),m.set(h,b);return S=[],m.forEach(function(e,r){var n=t.allLayerViews.find(function(e){return e.layer.id===r.id});if("queryFeatures"in n){var a=r.createQuery();a.objectIds=e,a.returnGeometry=!0,S.push(n.queryFeatures(a))}}),[4,s.all(S)];case 1:for(R=r.sent(),A=[],G=0,P=R;G<P.length;G++)if((j=P[G])&&j.features&&j.features.length)for(T=0,z=j.features;T<z.length;T++)g=z[T],i.isSome(g.geometry)&&A.push(g.geometry);f=A,r.label=2;case 2:O=0,k=f,r.label=3;case 3:return O<k.length?(V=k[O],[4,B(V,t,a,c)]):[3,6];case 4:c=r.sent(),r.label=5;case 5:return O++,[3,3];case 6:return[2,c];case 7:return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]?(n=new x(e),[3,12]):[3,8];case 8:return e instanceof p?(n=e,[3,12]):[3,9];case 9:return"geometry"in e?e.geometry?(n=e.geometry,[3,12]):[3,10]:[3,12];case 10:return e.layer?(q=e.layer,"queryFeatures"in(F=t.allLayerViews.find(function(e){return e.layer.id===q.id}))?(N=q.createQuery(),N.objectIds=[e.attributes[q.objectIdField]],N.returnGeometry=!0,[4,F.queryFeatures(N)]):[3,12]):[3,12];case 11:W=r.sent(),n=i.get(W,"features",0,"geometry"),r.label=12;case 12:if(i.isNone(n))return[2,null];if(!(I="point"===n.type?new d({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent))return[2,null];if(U=M.canProject(I,a),!I.spatialReference.equals(a)&&U)I=M.project(I,a);else if(!U)return[2,null];return c=c?c.union(I):I.clone(),[2,c]}})})}function z(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale){var t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every(function(e){return"layer"in e})){for(var r=0,n=0,a=0,c=e;a<c.length;a++){var o=c[a],t=o.layer;t&&t.minScale&&t.maxScale&&(r=t.minScale<r?t.minScale:r,n=t.maxScale>n?t.maxScale:n)}return r&&n?{min:r,max:n}:null}}}function O(e,t){return n(this,void 0,void 0,function(){var n,c,o,i,s,u,l,f,m,y,v,p,h,b,S,R;return r(this,function(r){switch(r.label){case 0:return e&&t?(n=t.spatialReference,c=t.size,o=t.viewpoint,i=t.constraints,s=null,"esri.Viewpoint"===e.declaredClass?s=e:e.viewpoint?s=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(s=e.target),u=null,s&&s.targetGeometry?(u=s.targetGeometry,[3,10]):[3,1]):[2,new a({targetGeometry:new x,scale:0,rotation:0})];case 1:return e instanceof d?(u=e,[3,10]):[3,2];case 2:return e||e&&(e.hasOwnProperty("center")||e.hasOwnProperty("extent")||e.hasOwnProperty("target"))?[4,B(e.center,t,n)]:[3,10];case 3:return m=r.sent(),m?[3,5]:[4,B(e.extent,t,n)];case 4:m=r.sent(),r.label=5;case 5:return f=m,f?[3,7]:[4,B(e.target,t,n)];case 6:f=r.sent(),r.label=7;case 7:return l=f,l?[3,9]:[4,B(e,t,n)];case 8:l=r.sent(),r.label=9;case 9:u=l,r.label=10;case 10:return!u&&o&&o.targetGeometry?u=o.targetGeometry:!u&&t.extent&&(u=t.extent),(y=G(u),n||(n=G(t.spatialReference||t.extent||u)),w.canProject(u,n)||!y||y.equals(n))?(v=P(g.vec2f64.create(),u.center?u.center:u),p=new x(A(v,v,y,n),n),h=null,h=s&&s.targetGeometry&&"point"===s.targetGeometry.type?s.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&i&&i.effectiveLODs?i.zoomToScale(e.zoom):Array.isArray(u)||"point"===u.type||"extent"===u.type&&0===u.width&&0===u.height?t.extent&&M.canProject(t.extent,n)?T(M.project(t.extent,n),c):t.extent?T(t.extent,c):o.scale:M.canProject(u.extent,n)?T(M.project(u.extent,n),c):T(u.extent,c),b=z(e),b&&(b.min&&b.min>h?h=b.min:b.max&&b.max<h&&(h=b.max)),S=0,s?S=s.rotation:e.hasOwnProperty("rotation")?S=e.rotation:o&&(S=o.rotation),R=new a({targetGeometry:p,scale:h,rotation:S}),i&&(R=i.fit(R),i.rotationEnabled||(R.rotation=S)),[2,R]):[2,null]}})})}function k(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function V(e,t,r){return r?v.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):v.vec2.scale(e,t,.5)}function q(e,r,n,a,c){return t.centerAt(e,r,n.center),e.scale=T(n,a),c&&c.constraints&&c.constraints.constrain(e),e}function F(e,r,n,a){return t.getTransform(e,r,n,a),m.mat2d.invert(e,e)}function N(e,t,r){var n=U(t),a=Math.abs(Math.cos(n)),c=Math.abs(Math.sin(n));return v.vec2.set(e,Math.round(r[1]*c+r[0]*a),Math.round(r[1]*a+r[0]*c))}function W(e){return e.scale*I(e.targetGeometry.spatialReference)}function I(e){return b.isValid(e)?1/(j(e)*X*96):1}function U(e){return f.common.toRadian(e.rotation)||0}function C(e){return b.isValid(e)?j(e)*X*96:1}function E(e,t){return v.vec2.scale(e,t,.5)}function L(e){if(e.isWrappable){var t=b.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function D(e,t){return Math.round(L(e)/t)}function H(e,t){return c.safeCast(O(e,t))}function Q(e,t,r){return W(t)}function _(e,t,r){return k(e,t),e.rotation+=r,e}function J(e,t,r){return k(e,t),e.rotation=r,e}function K(e,t,r){return k(e,t),e.scale=r,e}Object.defineProperty(t,"__esModule",{value:!0});var X=39.37,Y=l.wgs84Radius,Z=180/Math.PI;t.extentToScale=T,t.create=O,t.copy=k,t.getAnchor=V,t.getExtent=function(){var e=g.vec2f64.create();return function(t,r,n){var a=r.targetGeometry;P(e,a);var c=.5*W(r);return t.xmin=e[0]-c*n[0],t.ymin=e[1]-c*n[1],t.xmax=e[0]+c*n[0],t.ymax=e[1]+c*n[1],t.spatialReference=a.spatialReference,t}}(),t.setExtent=q,t.getOuterExtent=function(){var e=g.vec2f64.create(),t=g.vec2f64.create();return function(r,n,a){P(e,n.targetGeometry),N(t,n,a);var c=.5*W(n),o=e[0]-c*t[0],i=e[1]-c*t[1],s=e[0]+c*t[0],u=e[1]+c*t[1],l=n.targetGeometry.spatialReference;return r.set({xmin:o,ymin:i,xmax:s,ymax:u,spatialReference:l}),r}}(),t.getOuterSize=N,t.getPaddingScreenTranslation=function(){var e=g.vec2f64.create();return function(t,r,n){return v.vec2.sub(t,E(t,r),V(e,r,n))}}(),t.getPaddingMapTranslation=function(){var e=y.mat2df64.create(),r=g.vec2f64.create();return function(n,a,c,o){var i=W(a),s=U(a);return v.vec2.set(r,i,i),m.mat2d.fromScaling(e,r),m.mat2d.rotate(e,e,s),m.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,o)),m.mat2d.translate(e,e,[0,o.top-o.bottom]),v.vec2.set(n,e[4],e[5])}}(),t.getResolution=W,t.getResolutionToScaleFactor=C,t.getMatrix=function(){var e=g.vec2f64.create(),t=g.vec2f64.create(),r=g.vec2f64.create();return function(n,a,c,o,i,s){return v.vec2.negate(e,a),v.vec2.scale(t,c,.5*s),v.vec2.set(r,1/o*s,-1/o*s),m.mat2d.identity(n),m.mat2d.translate(n,n,t),i&&m.mat2d.rotate(n,n,i),m.mat2d.scale(n,n,r),m.mat2d.translate(n,n,e),n}}(),t.getTransform=function(){var e=g.vec2f64.create();return function(r,n,a,c){var o=W(n),i=U(n);return P(e,n.targetGeometry),t.getMatrix(r,e,a,o,i,c)}}(),t.getTransformNoRotation=function(){var e=g.vec2f64.create();return function(r,n,a,c){var o=W(n);return P(e,n.targetGeometry),t.getMatrix(r,e,a,o,0,c)}}(),t.getWorldWidth=L,t.getWorldScreenWidth=D,t.createAsync=H,t.angleBetween=function(){var e=g.vec2f64.create(),t=g.vec2f64.create(),r=[0,0,0];return function(n,a,c){v.vec2.subtract(e,n,a),v.vec2.normalize(e,e),v.vec2.subtract(t,n,c),v.vec2.normalize(t,t),v.vec2.cross(r,e,t);var o=Math.acos(v.vec2.dot(e,t)/(v.vec2.length(e)*v.vec2.length(t)))*Z;return r[2]<0&&(o=-o),isNaN(o)&&(o=0),o}}(),t.addPadding=function(){var e=g.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return k(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x+=e[0],o.y+=e[1],r}}(),t.removePadding=function(){var e=g.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return k(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x-=e[0],o.y-=e[1],r}}(),t.centerAt=function(){var e=g.vec2f64.create();return function(t,r,n){k(t,r);var a=t.targetGeometry,c=G(n),o=G(a);return P(e,n),A(e,e,c,o),a.x=e[0],a.y=e[1],t}}(),t.pixelSizeAt=Q,t.resize=function(){var e=g.vec2f64.create();return function(r,n,a,c,o){o||(o="center"),v.vec2.sub(e,a,c),v.vec2.scale(e,e,.5);var i=e[0],s=e[1];switch(o){case"center":v.vec2.set(e,0,0);break;case"left":v.vec2.set(e,-i,0);break;case"top":v.vec2.set(e,0,s);break;case"right":v.vec2.set(e,i,0);break;case"bottom":v.vec2.set(e,0,-s);break;case"top-left":v.vec2.set(e,-i,s);break;case"bottom-left":v.vec2.set(e,-i,-s);break;case"top-right":v.vec2.set(e,i,s);break;case"bottom-right":v.vec2.set(e,i,-s)}return t.translateBy(r,n,e),r}}(),t.rotateBy=_,t.rotateTo=J,t.scaleBy=function(){var e=g.vec2f64.create();return function(r,n,a,c,o){return k(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,o),r.scale=n.scale*a,t.toScreen(e,e,r,o),t.translateBy(r,r,v.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=K,t.scaleAndRotateBy=function(){var e=g.vec2f64.create();return function(r,n,a,c,o,i){return k(r,n),isNaN(a)||0===a||(t.toMap(e,o,n,i),r.scale=n.scale*a,r.rotation+=c,t.toScreen(e,e,r,i),t.translateBy(r,r,v.vec2.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=function(){var e=g.vec2f64.create(),r=g.vec2f64.create();return function(n,a,c,o,i,s,u){return t.getPaddingScreenTranslation(r,s,u),v.vec2.add(e,i,r),o?t.scaleAndRotateBy(n,a,c,o,e,s):t.scaleBy(n,a,c,e,s)}}(),t.toMap=function(){var e=y.mat2df64.create();return function(t,r,n,a){return v.vec2.transformMat2d(t,r,F(e,n,a,1))}}(),t.toScreen=function(){var e=y.mat2df64.create();return function(r,n,a,c){return v.vec2.transformMat2d(r,n,t.getTransform(e,a,c,1))}}(),t.translateBy=function(){var e=g.vec2f64.create(),t=y.mat2df64.create();return function(r,n,a){k(r,n);var c=W(n),o=r.targetGeometry;return m.mat2d.fromRotation(t,U(n)),m.mat2d.scale(t,t,g.vec2f64.fromValues(c,c)),v.vec2.transformMat2d(e,a,t),o.x+=e[0],o.y+=e[1],r}}()});