// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Set","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/support/fieldUtils","../../layers/support/timeUtils","../../support/arcadeOnDemand","../../tasks/support/Query","./RefreshableLayerView","./support/FeatureEffect","./support/FeatureFilter","./support/popupUtils"],function(e,t,r,i,o,n,l,u,s,a,p,c,d,f,y,h,m,F,v,b,g,w,x){var E=p.getLogger("esri.views.layers.FeatureLayerView");return function(e){function t(t){var r=e.call(this,t)||this;return r.effect=null,r.filter=null,r.layer=null,r.requiredFields=null,r.view=null,r}return r(t,e),t.prototype.initialize=function(){var e=this;f.init(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","filter","effect","layer.timeInfo","timeExtent"],function(){return e._updateRequiredFields()})},Object.defineProperty(t.prototype,"availableFields",{get:function(){var e=this,t=e.layer,r=e.layer.fields,i=e.requiredFields;return"outFields"in t&&t.outFields?h.fixFields(r,h.unpackFieldNames(r,t.outFields).concat(i)):h.fixFields(r,i)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(e){E.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype.highlight=function(e,t){return void 0===t&&(t={}),this.inherited(arguments)},t.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=c.isSome(this.filter)?this.filter.createQuery(e):new v(e);return this.timeExtent&&(t.timeExtent=t.timeExtent?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t},t.prototype.queryFeatures=function(e,t){return this.inherited(arguments)},t.prototype.queryObjectIds=function(e,t){return this.inherited(arguments)},t.prototype.queryFeatureCount=function(e,t){return this.inherited(arguments)},t.prototype.queryExtent=function(e,t){return this.inherited(arguments)},t.prototype._updateRequiredFields=function(){return l(this,void 0,void 0,function(){var e,t,r,i,o,l,a,p,f,y,m,F,v;return n(this,function(n){switch(n.label){case 0:return this.layer&&this.view?(e="3d"===this.view.type,t=this,r=t.layer,i=t.layer,o=i.fields,l=i.objectIdField,a=i.renderer,p=new s.default,[4,d.eachAlways([a?a.collectRequiredFields(p,o):null,h.collectLabelingFields(p,r),e?h.collectElevationFields(p,r):null,c.isSome(this.filter)?h.collectFilterFields(p,r,this.filter):null,this.effect?h.collectFilterFields(p,r,this.effect.filter):null])]):[2];case 1:for(f=n.sent(),r.timeInfo&&this.timeExtent&&h.collectFields(p,r.fields,[r.timeInfo.startField,r.timeInfo.endField]),y=0,m=f;y<m.length;y++)F=m[y],F.error&&E.error(F.error);return h.collectField(p,o,l),v=u.from(p).sort(),this._set("requiredFields",v),[2]}})})},t.prototype.validateFetchPopupFeatures=function(e){var t=this,r=t.layer;return t.layer.popupEnabled?x.getFetchPopupTemplate(this.layer,e)?void 0:new a("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:r}):new a("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r})},t.prototype.fetchClientPopupFeatures=function(e){return l(this,void 0,void 0,function(){var t,r,i,o,l,u,s,a,p,f,y,m;return n(this,function(n){switch(n.label){case 0:return(t=c.isSome(e)?e.clientGraphics:null)&&0!==t.length?(r=[],i=[],o=this.layer,l=x.getFetchPopupTemplate(o,e),c.isSome(l)?[4,F.loadArcade()]:[2,d.resolve([])]):[2,d.resolve([])];case 1:return u=n.sent().arcadeUtils,s=u.hasGeometryOperations(l),[4,this.createPopupQuery(e)];case 2:for(a=n.sent(),p=h.unpackFieldNames(o.fields,a.outFields),f=0,y=t;f<y.length;f++)m=y[f],s||!h.featureHasFields(p,m)?i.push(m):r.push(m);return 0===i.length?[2,d.resolve(r)]:(a.objectIds=i.map(function(e){return e.attributes[o.objectIdField]}),[2,o.queryFeatures(a).then(function(e){return r.concat(e.features)}).catch(function(){return i})])}})})},t.prototype.createPopupQuery=function(e){return l(this,void 0,void 0,function(){var t,r,i;return n(this,function(o){switch(o.label){case 0:return t=this.layer,r=t.createQuery(),r.returnGeometry=!0,r.returnZ=!0,r.returnM=!0,i=r,[4,x.getRequiredFields(this.layer,x.getFetchPopupTemplate(this.layer,e))];case 1:return i.outFields=o.sent(),r.outSpatialReference=this.view.spatialReference,[2,r]}})})},i([y.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],t.prototype,"availableFields",null),i([y.property({type:g})],t.prototype,"effect",void 0),i([y.property({type:w})],t.prototype,"filter",void 0),i([y.property(m.combinedViewLayerTimeExtentProperty)],t.prototype,"timeExtent",void 0),i([y.property()],t.prototype,"layer",void 0),i([y.property({type:Number})],t.prototype,"maximumNumberOfFeatures",null),i([y.property({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),i([y.property({readOnly:!0})],t.prototype,"requiredFields",void 0),i([y.property()],t.prototype,"view",void 0),t=i([y.subclass("esri.views.layers.FeatureLayerView")],t)}(y.declared(b))});