// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/generatorHelper","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/Logger","../../../../core/now","../../../../core/promiseUtils","../../../../core/scheduling","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../tasks/support/QuantizationParameters","../../../../tasks/support/Query","./featureReference","./FeatureTile","./featureTileQuery3D","../../../support/QueueProcessor"],function(e,t,r,i,s,a,u,n,o,l,c,p,h,d,f,y,m,g,F,v,T,b,x,R){function C(e){return"dummy-tile-full-extent"===e.id}function E(e){for(var t=0,r=0,i=e;r<i.length;r++){var s=i[r];s.features&&s.features.length>0&&s.alive&&(t=Math.max(t,s.descriptor.lij[0]))}return t}Object.defineProperty(t,"__esModule",{value:!0});var M=T.SingleFeatureReference,O=T.MultiFeatureReference,_=c.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D"),w=function(e){function t(t){var r=e.call(this,t)||this;return r.useTileCount=!1,r.updating=!1,r.updatingTotal=0,r.updatingRemaining=0,r.expectedFeatureDiff=0,r.maximumNumberOfFeaturesExceeded=!1,r.maximumNumberOfFeaturesExceededThrottle=1e3,r.maximumNumberOfFeaturesExceededNext=0,r._fullRatio=1,r._farRatio=1,r.changes={updates:{adds:[],removes:[]},adds:[],removes:[]},r.handles=new l,r._dirty=!1,r.idToFeatureTile=new Map,r.displayingFeatureReferences=new Map,r.numDisplayingFeatureReferences=0,r.suspended=!0,r.pendingEdits=null,r}return r(t,e),Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this.maximumFeaturesUpdated(t,e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"memoryForUnusedFeatures",{get:function(){var e=0;return this.forEachFeatureTile(function(t){return e+=t.estimatedUnusedSize}),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalVertices",{get:function(){var e=0;return this.forEachFeatureTile(function(t){return e+=t.numVertices}),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalFeatures",{get:function(){var e=0;return this.forEachFeatureTile(function(t){return e+=t.numFeatures}),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filterExtent",{set:function(e){if(e&&this.tilingScheme&&!e.spatialReference.equals(this.tilingScheme.spatialReference))return void _.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");var t=this._get("filterExtent");if(!(t===e||t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("filterExtent",r),this.reclip(r,t)}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.capabilities=this.calculateCapabilities(),this.fetchQueue=this.createFetchQueue();var t=this.layerView.layer;this.handles.add(f.on(this,"tileDescriptors","change",function(){return e.setDirty()},function(){return e.setDirty()})),this.handles.add(t.watch("hasService",function(){return e._initMemCache()})),f.init(t,"hasService",function(){return e._initMemCache()}),this.objectIdField=t.objectIdField,this.FeatureReferenceClass=this.capabilities.supportsMultipleResolutions?O:M,this.featureTileQuery=x.createFeatureTileQuery3D(t);var r=this.layerView.view.resourceController.scheduler;this.handles.add(r.registerTask(2,function(t){return e.update(t)},function(){return e._dirty||e.maximumNumberOfFeaturesExceededNext>0})),this.setDirty()},t.prototype.destroy=function(){var e=this;this.handles&&(this.handles.destroy(),this.handles=null),this.forEachFeatureTile(function(t){e.cancelFetchTile(t),e.removeTile(t)}),this.idToFeatureTile.clear(),this.displayingFeatureReferences.clear(),this.fetchQueue.destroy(),this.fetchQueue=null,this.featureTileQuery=null,this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null),this._memCache&&this._memCache.destroy(),this._memCache=null},Object.defineProperty(t.prototype,"paused",{get:function(){return this.suspended||!!this.pendingEdits},enumerable:!0,configurable:!0}),t.prototype.filtersChanged=function(){var e=this;this.fetchQueue.clear(),this._memCache&&this._memCache.clear(),this.forEachFeatureTile(function(t){e.resetFetchTile(t),e.queueFetchTile(t)}),this.setDirty()},t.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())},t.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.unpause())},t.prototype.pause=function(){this.paused&&(this.fetchQueue.pause(),this.fetchQueue.reset(),this.updated())},t.prototype.unpause=function(){this.paused||(this.setDirty(),this.fetchQueue.resume(),this.updated())},t.prototype.getFeatureTileById=function(e){return this.idToFeatureTile.get(e)||null},t.prototype.forEachFeatureTile=function(e){this.idToFeatureTile.forEach(e)},t.prototype.applyEdits=function(e){var t=this;this.pendingEdits||(this.pendingEdits={edits:h.resolve(),count:0,controller:h.createAbortController()},this.pause()),this.pendingEdits.count++;var r=this.pendingEdits.edits.then(function(){return e.result.catch(function(e){if(h.isAbortError(e))throw e;return null}).then(function(e){return e?(t.applyEditsDeleteFeatures(e.deletedFeatures),o.safeCast(t.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,t.pendingEdits.controller.signal).then(function(){return e}))):e}).then(function(e){return 0==--t.pendingEdits.count&&(t.pendingEdits=null,t._memCache&&t._memCache.clear(),t.unpause(),t.updated()),e})});return this.pendingEdits.edits=r,this.updated(),r},t.prototype.applyEditsDeleteFeatures=function(e){var t=this;if(0!==e.length){var r=new Set;e.forEach(function(e){return r.add(e.objectId)}),this.forEachFeatureTile(function(e){if(e.features){var i=e.features.filter(function(e){return!r.has(g.getObjectId(e,t.objectIdField))});i.length!==e.features.length&&(e.setFeatures(i,0),t.invalidateCounts())}})}},t.prototype.applyEditsAddUpdateFeatures=function(e,t,r){return a(this,void 0,void 0,function(){var i,s,a,n=this;return u(this,function(u){switch(u.label){case 0:return i=[],(s=new Set,e.forEach(function(e){return i.push(e.objectId)}),t.forEach(function(e){i.push(e.objectId),s.add(e.objectId)}),0===i.length)?[2]:(a=[],this.forEachFeatureTile(function(e){var t=o.safeCast(n.applyEditsAddUpdateTile(e,i,s,r));t&&a.push(t)}),[4,h.eachAlways(a)]);case 1:return u.sent(),[2]}})})},t.prototype.applyEditsAddUpdateTile=function(e,t,r,i){return a(this,void 0,void 0,function(){var s,a,n,o,l,c,p,h=this;return u(this,function(u){switch(u.label){case 0:return e.features?(s=this.createQuery(e),s.resultType=void 0,s.cacheHint=!1,s.objectIds=t,[4,this.queryFeatures(s,i)]):[2];case 1:if(a=u.sent(),n=null,r.size>0&&(o=e.features.filter(function(e){return!r.has(g.getObjectId(e,h.objectIdField))}),o.length!==e.features.length&&(n=o)),a.features.length>0)for(n||(n=e.features.slice()),this.verticalScale.adjust(a.features),l=0,c=a.features;l<c.length;l++)p=c[l],n.push(p);return n&&(e.setFeatures(n,0),this.invalidateCounts()),[2]}})})},t.prototype.queryFeatures=function(e,t){return this.featureTileQuery.queryFeaturesDehydrated(e,{signal:t,timeout:q})},t.prototype.calculateCapabilities=function(){var e=this.layerView.layer,t=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsPagination),r=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsResultType),i=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization),s=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantizationEditMode),a=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsMaxRecordCountFactor),u=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsFormatPBF),n=!!(e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsCacheHint);return{supportsMultipleResolutions:this.calculateSupportsMultipleResolutions(),supportsPagination:t,supportsResultType:r,supportsCacheHint:n,supportsQuantization:i,supportsQuantizationEditMode:s,supportsMaxRecordCountFactor:a,supportsFormatPBF:u}},t.prototype.calculateSupportsMultipleResolutions=function(){var e=this.layerView.layer;switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}},t.prototype.createFetchQueue=function(){var e=this;return new R.QueueProcessor({concurrency:6,priority:2,scheduler:this.layerView.view.resourceController.scheduler,peeker:function(t){return e.highestPriorityTile(t)},process:function(t,r){return e.fetchTile(t,r)}})},t.prototype.highestPriorityTile=function(e){return e.reduce(function(e,t){return e&&e.descriptor.loadPriority<=t.descriptor.loadPriority?e:t},null)},t.prototype._initMemCache=function(){var e=this.layerView.layer;"hasService"in e&&e.hasService?this._memCache||(this._memCache=this.layerView.view.resourceController.memoryController.getMemCache(e.uid)):this._memCache&&(this._memCache.destroy(),this._memCache=null)},t.prototype.setDirty=function(){this._dirty=!0,this.updated()},t.prototype.update=function(e){var t=this;if(this.maximumNumberOfFeaturesExceededNext&&p()>=this.maximumNumberOfFeaturesExceededNext&&this.updateMaximumNumberOfFeaturesExceeded(),this._dirty&&this.constructed){this._dirty=!1;var r=this.getListOfTiles();this.markTilesNotAlive(r),this.addTiles(r),this.filterExtentTiles(r),this.removeTiles(r);var i=this.sortTiles(r);e.run(function(){return t.displayTiles(i,e)})&&e.run(function(){return t.queueFetchTiles(i,e)})&&e.run(function(){return t.updateMemoryEstimates(i,e)})||this.setDirty(),this.updated()}},t.prototype.markTilesNotAlive=function(e){for(var t=0,r=e;t<r.length;t++){r[t].alive=!1}},t.prototype.addTiles=function(e){var t=this;this.suspended||this.tileDescriptors.forEach(function(r){var i=t.getFeatureTileById(r.id);i?i.alive=!0:e.push(t.addTile(r))})},t.prototype.filterExtentTiles=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&this.clearTile(i))}},t.prototype.removeTiles=function(e){for(var t=e.length-1;t>=0;t--){var r=e[t];r.alive||(this.removeTile(r),t!==e.length-1&&(e[t]=e[e.length-1]),e.pop())}},t.prototype.sortTiles=function(e){return e.sort(function(e,t){return e.descriptor.loadPriority-t.descriptor.loadPriority}),e},t.prototype.displayTiles=function(e,t){for(var r=this,i=this.updateRatio(e),s=function(e){var t=r._fullRatio<1?i(e)*r._farRatio:1;return e.reduceFeatures(t,r.objectIdField)&&r.setDirty(),r.showTile(e)},a=this,u=0,n=e;u<n.length;u++){var o=n[u];if("break"===function(e){if(!t.run(function(){return s(e)}))return a.setDirty(),"break"}(o))break}return t.hasProgressed},t.prototype.queueFetchTiles=function(e,t){for(var r=this,i=this,s=0,a=e;s<a.length;s++){var u=a[s],n=function(e){if(!t.run(function(){return r.queueFetchTile(e)}))return i.setDirty(),{value:!0}}(u);if("object"==typeof n)return n.value}return t.hasProgressed},t.prototype.updateMemoryEstimates=function(e,t){var r=this;return e.some(function(e){if(!t.run(function(){return e.updateMemoryEstimates()}))return r.setDirty(),!0}),t.hasProgressed},t.prototype.reclip=function(e,t){var r=this;this.constructed&&(this.forEachFeatureTile(function(i){i.displayingFeatures&&0!==i.displayingFeatures.length&&(i.intersection(t,Q),i.intersection(e,P),m.equals(Q,P)||r.hideTileFeatures(i))}),this.forEachFeatureTile(function(e){return r.showTile(e)}),this.updated())},t.prototype.updated=function(){var e=this,t=this._dirty||this.fetchQueue.length>0||!!this.pendingEdits;if(this._set("updating",t),t){var r=0,i=0,s=0,a=0,u=0,n=0,o=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.forEachFeatureTile(function(t){if(++s,t.isFetching&&t.hasPreciseFeatureCount){var r=e.maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),l=t.displayingFeatures?t.displayingFeatures.length*o:0;n+=r-l}t.needsFetching?++u:t.numFeatures>0&&(++a,i+=t.numFeatures)}),u+=this.fetchQueue?this.fetchQueue.length:0;var l=u;i?(l=u*i/a,r=i+l):r=s,n=Math.min(this.maximumNumberOfFeatures-this.features.length,n),this._set("updatingTotal",r),this._set("updatingRemaining",l),this._set("expectedFeatureDiff",n)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update(),this.updating||(this.maximumNumberOfFeaturesExceededNext=this.maximumNumberOfFeaturesExceededNext||p()+this.maximumNumberOfFeaturesExceededThrottle)},t.prototype.updateMaximumNumberOfFeaturesExceeded=function(){if(!this.updating){var e=!1;this.forEachFeatureTile(function(t){e=e||t.perTileMaximumNumberOfFeaturesExceeded}),this.maximumNumberOfFeaturesExceededNext=0,this._set("maximumNumberOfFeaturesExceeded",e)}},t.prototype.updateRatio=function(e){for(var t=E(e),r=function(e){return 1/(1<<t-e.descriptor.lij[0])},i=0,s=0,a=0,u=e;a<u.length;a++){var n=u[a],o=n.numFeatures;i+=o,s+=o*r(n)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/i),this._farRatio=this.maximumNumberOfFeatures/s,this.scheduleUpdated(),r},t.prototype.maximumFeaturesUpdated=function(e,t){var r=this;e!==t&&(t>e&&this.forEachFeatureTile(function(e){if(e.featuresMissing){var t=r.maximumFeaturesForTile(e);e.features&&(e.features.length>=t||5===e.fetchStatus)||(r.cancelFetchTile(e),r.resetFetchTile(e))}}),this.setDirty())},t.prototype.addTile=function(e){var t=new b(e);return this.idToFeatureTile.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t},t.prototype.referenceDisplayingFeaturesFromRelatedTiles=function(e){var t=this,r=e.descriptor.resolution;this.forEachFeatureTile(function(i){if(i.displayingFeatures&&t.tilesAreRelated(e,i)){e.displayingFeatures=e.displayingFeatures||[];for(var s=0,a=i.displayingFeatures;s<a.length;s++){var u=a[s];e.displayingFeatures.push(u);var n=t.displayingFeatureReferences.get(g.getObjectId(u,t.objectIdField));n.ref(r,n.feature),t.numDisplayingFeatureReferences++}}}),e.featureLimit=e.displayingFeatures?e.displayingFeatures.length:0},t.prototype.tilesAreRelated=function(e,t){if(e===t)return!1;var r=e.descriptor.lij,i=t.descriptor.lij;if(!r||!i)return!0;var s=r[0]<i[0],a=s?r:i,u=s?i:r,n=u[0]-a[0];if(0===n)return!1;var o=1<<n;return Math.floor(u[1]/o)===a[1]&&Math.floor(u[2]/o)===a[2]},t.prototype.removeTile=function(e){this.clearTile(e),this.idToFeatureTile.delete(e.id)},t.prototype.resetFetchTile=function(e){e.intersects(this.filterExtent)?(e.fetchStatus=0,e.filtered=!1):(e.needsFetching&&(e.fetchStatus=4),e.filtered=!0)},t.prototype.cancelFetchTile=function(e){e.fetchRequest&&(e.fetchRequest=null,e.fetchStatus=0,this.fetchQueue.abort(e))},t.prototype.fetchTile=function(e,t){return a(this,void 0,void 0,function(){var r,i,s,a,n,o,l,c,p,d,f,y;return u(this,function(u){switch(u.label){case 0:if(!this.needsNumFeatures(e))return[3,4];u.label=1;case 1:return u.trys.push([1,3,,4]),r=e,[4,this.fetchCount(e,t)];case 2:return r.numFeatures=u.sent(),this.updateRatio(this.getListOfTiles()),[3,4];case 3:return i=u.sent(),h.isAbortError(i)?[2]:[3,4];case 4:return s=this.maximumFeaturesForTile(e),(a=this.getMaxRecordCount(e),n=Math.ceil(s/a),C(e)||!this.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=s&&n>v.MAX_MAX_RECORD_COUNT_FACTOR)?[2,this.fetchPagedTile(e,t)]:(o=this.createQuery(e),o.maxRecordCountFactor=Math.ceil(s/a),e.isRefetching&&e.features&&e.features.length>0&&(l=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/a),o.maxRecordCountFactor=Math.max(l+1,o.maxRecordCountFactor)),[4,this.queryFeatures(o,t)]);case 5:return c=u.sent(),p=c.features,d=c.exceededTransferLimit,f=d?o.maxRecordCountFactor>=v.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5,e.featuresMissing=p.length<e.numFeatures||d,y=this._removeEmptyFeatures(p),this.verticalScale.adjust(p),e.setFeatures(p,y),this.invalidateCounts(),[2,f]}})})},t.prototype.fetchCount=function(e,t){return a(this,void 0,void 0,function(){return u(this,function(r){return[2,this.layerView.layer.queryFeatureCount(this.createFeatureCountQuery(e),{signal:t})]})})},t.prototype.fetchPagedTile=function(e,t){return a(this,void 0,void 0,function(){var r,i,s,a,n,o,l,c,p,h,d;return u(this,function(u){switch(u.label){case 0:r=0,i=0,a=0,n=this.maximumFeaturesForTile(e)-a,o=this.getMaxRecordCount(e),u.label=1;case 1:return l=this.createQuery(e),c=this.setPagingParameters(l,r,n,o),[4,this.queryFeatures(l,t)];case 2:return p=u.sent(),h=p.features,d=p.exceededTransferLimit,r+=l.num,a+=h.length,i+=this._removeEmptyFeatures(h),this.verticalScale.adjust(h),e.featuresMissing=r<e.numFeatures||d,s=s?s.concat(h):h,e.setFeatures(s,i),this.invalidateCounts(),this.setDirty(),n=this.maximumFeaturesForTile(e)-a,!c||!d||n<=0?[2,d?4:5]:[3,1];case 3:return[2]}})})},t.prototype.createFeatureCountQuery=function(e){var t=this.createQuery(e);return this.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t},t.prototype.createQuery=function(e){var t=this.layerView.layer.createQuery();t.outFields=this.layerView.availableFields,t.returnZ=this.hasZ,t.returnM=this.hasM;var r=this.tilingScheme.spatialReference;t.outSpatialReference=r;var i=e.descriptor.extent;return i&&(t.geometry=m.toExtent(i,r)),this.setResolutionParams(t,e),this.useTileQuery(e)?t.resultType="tile":this.capabilities.supportsCacheHint&&(t.cacheHint=!0),t},t.prototype.setPagingParameters=function(e,t,r,i){return!!this.capabilities.supportsPagination&&(e.start=t,r>0&&this.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)},t.prototype.getEffectiveTileResolution=function(e){if(null==e.descriptor.resolution)return null;var t="global"===this.viewingMode?this.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)*j},t.prototype.setResolutionParams=function(e,t){if(this.capabilities.supportsMultipleResolutions){var r=this.layerView.layer;if("point"!==r.geometryType){var i=this.getEffectiveTileResolution(t);null!=i&&(this.capabilities.supportsQuantization?e.quantizationParameters=new F.default({mode:"view",originPosition:"upper-left",tolerance:i,extent:r.fullExtent}):"polyline"===r.geometryType&&(e.maxAllowableOffset=i))}}},t.prototype._removeEmptyFeatures=function(e){for(var t=e.length,r=0;r<e.length;){var i=e[r];g.hasVertices(i.geometry)?++r:(e[r]=e[e.length-1],--e.length)}return t-e.length},t.prototype.needsNumFeatures=function(e){return this.useTileCount&&!e.hasPreciseFeatureCount&&!C(e)},t.prototype.getMaxRecordCount=function(e){var t=this.layerView.layer;return this.useTileQuery(e)&&t&&"tileMaxRecordCount"in t&&t.tileMaxRecordCount>0&&this.capabilities.supportsResultType?t.tileMaxRecordCount:t&&"maxRecordCount"in t&&t.maxRecordCount>0?t.maxRecordCount:D},t.prototype.useTileQuery=function(e){return(!C(e)||!this.capabilities.supportsCacheHint)&&this.capabilities.supportsResultType},t.prototype.queueFetchTile=function(e){var t=this;if(!e.needsFetching)return!1;var r=this._memCache&&this._memCache.pop(e.id);if(r)return e.loadCache(r),this.setDirty(),this.scheduleUpdated(),!0;e.fetchStatus=e.needsRefetching?3:2;var i=this.fetchQueue.push(e),s=!1,a=!1,u=i.then(function(t){e.fetchRequest=null,e.fetchStatus=t}).catch(function(r){e.fetchRequest===u&&(e.fetchRequest=null,e.fetchStatus=4),h.isAbortError(r)?s=!0:(e.setFeatures([],0),t.invalidateCounts(),e.featuresMissing=!1,_.error("#fetchTile()",t.layerView.layer,r&&r.message?r.message:r))}).then(function(){a=!0,s||t.setDirty(),t.scheduleUpdated()});return a||(e.fetchRequest=u),!0},t.prototype.scheduleUpdated=function(){var e=this;this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(d.schedule(function(){e.handles.remove("scheduleUpdated"),e.updated()}),"scheduleUpdated")},t.prototype.showTile=function(e){if(e.displayingFeatures&&!e.needsDisplayUpdate)return!1;if(0===e.featureLimit||!e.features){var t=e.displayingFeatures&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],t}for(var r=e.descriptor.resolution,i=this.changes.updates,s=this.changes.adds,a=0;a<e.featureLimit;++a){var u=e.features[a],n=g.getObjectId(u,this.objectIdField),o=this.displayingFeatureReferences.get(n);if(o){var l=o.ref(r,u);l.oldVersion!==l.newVersion&&(i.removes.push(l.oldVersion),i.adds.push(l.newVersion))}else this.displayingFeatureReferences.set(n,new this.FeatureReferenceClass(r,u)),s.push(u);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=e.features.slice(0,e.featureLimit),!0},t.prototype.hideTile=function(e){this.cancelFetchTile(e),this.hideTileFeatures(e)},t.prototype.hideTileFeatures=function(e){if(e.displayingFeatures){for(var t=this.changes.updates,r=this.changes.removes,i=0,s=e.displayingFeatures;i<s.length;i++){var a=s[i],u=g.getObjectId(a,this.objectIdField),n=this.displayingFeatureReferences.get(u);if(n){var o=n.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,o?o.oldVersion!==o.newVersion&&(null==o.newVersion?(this.displayingFeatureReferences.delete(u),r.push(o.oldVersion)):(t.adds.push(o.newVersion),t.removes.push(o.oldVersion))):console.error("Hiding unreferenced feature")}}this.applyChanges(),e.displayingFeatures=null}},t.prototype.applyChanges=function(){var e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this.changes.adds,r=this.changes.removes,i=Math.min(t.length,r.length),s=0;s<i;){var a=Math.min(s+N,i);this.features.addMany(t.slice(s,a)),this.features.removeMany(r.slice(s,a)),s=a}t.length>i&&this.features.addMany(0===s?t:t.slice(s)),r.length>i&&this.features.removeMany(0===s?r:r.slice(s)),t.length=0,r.length=0},t.prototype.clearTile=function(e){if(this.hideTile(e),e.features&&this._memCache){var t=16+e.estimatedSize;this._memCache.put(e.id,e.cacheItem,t)}e.setFeatures(null,0),this.invalidateCounts()},t.prototype.invalidateCounts=function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")},t.prototype.getListOfTiles=function(){var e=new Array(this.idToFeatureTile.size),t=0;return this.forEachFeatureTile(function(r){return e[t++]=r}),e},Object.defineProperty(t.prototype,"storedFeatures",{get:function(){return this.getListOfTiles().reduce(function(e,t){return e+(t.features?t.features.length:0)},0)},enumerable:!0,configurable:!0}),t.prototype.maximumFeaturesForTile=function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:this.maximumNumberOfFeatures,r=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(t*r/(1-e.emptyFeatureRatio)),t)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{update:function(t){e.fetchQueue.test.update(t),e.update(t)}}},enumerable:!0,configurable:!0}),i([y.property({constructOnly:!0})],t.prototype,"features",void 0),i([y.property()],t.prototype,"tileDescriptors",void 0),i([y.property({constructOnly:!0})],t.prototype,"tilingScheme",void 0),i([y.property({value:1/0})],t.prototype,"maximumNumberOfFeatures",null),i([y.property()],t.prototype,"useTileCount",void 0),i([y.property({constructOnly:!0})],t.prototype,"layerView",void 0),i([y.property({readOnly:!0})],t.prototype,"updating",void 0),i([y.property({readOnly:!0})],t.prototype,"updatingTotal",void 0),i([y.property({readOnly:!0})],t.prototype,"updatingRemaining",void 0),i([y.property({readOnly:!0})],t.prototype,"expectedFeatureDiff",void 0),i([y.property({readOnly:!0})],t.prototype,"memoryForUnusedFeatures",null),i([y.property({readOnly:!0})],t.prototype,"maximumNumberOfFeaturesExceeded",void 0),i([y.property({constructOnly:!0})],t.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),i([y.property({readOnly:!0})],t.prototype,"totalVertices",null),i([y.property({readOnly:!0})],t.prototype,"totalFeatures",null),i([y.property()],t.prototype,"filterExtent",null),i([y.property({constructOnly:!0})],t.prototype,"verticalScale",void 0),i([y.property({constructOnly:!0})],t.prototype,"viewingMode",void 0),i([y.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i([y.property({constructOnly:!0})],t.prototype,"hasM",void 0),t=i([y.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],t)}(y.declared(n));t.FeatureTileFetcher3D=w;var D=2e3,Q=m.create(),P=m.create(),q=6e5,N=200,j=1/3;t.default=w});