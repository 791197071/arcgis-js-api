// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Color","../../../Graphic","../../../core/asyncUtils","../../../core/Collection","../../../core/has","../../../core/iteratorUtils","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/requireUtils","../../../core/scheduling","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/watchUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../layers/graphics/controllers/I3SOnDemandController","../../../renderers/visualVariables/support/visualVariableUtils","../../../support/arcadeUtils","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SElevationProvider","./i3s/I3SProjectionUtil","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/edgeUtils","./support/layerViewUpdatingProperties","./support/symbolColorUtils","../support/debugFlags","../support/orientedBoundingBox","../support/projectionUtils","../support/buffer/glUtil","../webgl-engine/lib/Geometry","../webgl-engine/lib/Layer","../webgl-engine/lib/Object3D","../webgl-engine/lib/PreinterleavedGeometryData","../webgl-engine/lib/Texture","../webgl-engine/lib/Util","../webgl-engine/lib/TextureBackedBuffer/BufferManager","../webgl-engine/materials/component/index","module","@dojo/framework/shim/Promise"],function(e,t,r,n,i,a,o,s,l,d,u,c,h,p,g,f,y,m,_,b,v,x,I,C,S,O,w,M,D,T,E,j,R,V,A,P,F,N,G,B,U,L,H,k,q,K,z,W,J,X,Q,Y,Z,$,ee,te,re){function ne(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function ie(e,t,r){if(f.isNone(e))return null;for(var n=0;n<e.length;n++){var i=e[n];if(f.isSome(i)&&0!=(i.usage&r))return t[n].id}return null}function ae(e){return f.isSome(e)&&b.isArrayBuffer(e.data)}function oe(e,t){for(var r=1024,n=0,i=e;n<i.length;n++){var a=i[n];r+=a.interleavedVertexData.byteLength+(a.indices?a.indices.byteLength:0),r+=a.positionData.data.byteLength+a.positionData.indices.byteLength}if(f.isSome(t))for(var o=0,s=t;o<s.length;o++){var l=s[o];f.isSome(l)&&b.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function se(e,t){return t.byteSize>ce?(le.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}Object.defineProperty(t,"__esModule",{value:!0});var le=p.getLogger("esri.views.3d.layers.SceneLayerView3D"),de=[1,1,1,1],ue=function(){function e(){}return e}(),ce=104857600;t.I3SMeshView3D=function(t){return function(t){function s(){var e=null!==t&&t.apply(this,arguments)||this;return e._layerUid="",e._highlights=new P(e),e._elevationProvider=null,e._worker=new V,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new B.IDBCache("esri-scenelayer-cache","geometries"),e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._layerUrl="",e._cacheKeySuffix=null,e._tmpAttributeOnlyGraphic=new l(null,null,{}),e}return n(s,t),Object.defineProperty(s.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"rendererTextureUsage",{get:function(){return G.rendererNeedsTextures(this._currentRenderer)?31:12},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=v.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=R.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!c("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),s.prototype.initialize=function(){var t=this;if(I.open(m.getAbsMid("./SceneLayerWorker",e,re)).then(function(e){t.destroyed?e.close():t._workerThread=e}),G.checkSceneLayerValid(this.layer),G.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUid=this.layer.uid,this._layerUrl=this.layer.parsedUrl.path,this._controller=new D({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(e){return t._deleteNodeStageData(e)}),this._addThisLayerToStage(),this._elevationProvider=new F({layerView:this,stageLayer:this._stageLayer}),this.updatingHandles.add(this,"view.clippingArea",function(){return t._clippingAreaChanged()},2),this.updatingHandles.add(this,"fullOpacity",function(e){return t._opacityChange(e)}),this.updatingHandles.add(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),this.updatingHandles.add(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),this.updatingHandles.add(this,"filter",function(){return t._filterChange()},2),this.view.watch("qualitySettings.physicallyBasedRenderingEnabled",function(e){return t._enablePhysicalBasedRendering(e)});var n=function(){t._reloadAll(),t._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",n),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",n),this.updatingHandles.add(this,"suspended",function(e){return t._suspendedChange(e)},2),this.handles.add(x.init(q,"I3S_TREE_SHOW_TILES",function(r){if(r&&!t._treeDebugger){var n=t._controller.crsIndex;new Promise(function(t,r){e(["./support/I3STreeDebugger"],t,r)}).then(function(e){var r=e.I3STreeDebugger;!t._treeDebugger&&q.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new r({lv:t,view:t.view,nodeSR:n}))})}else r||!t._treeDebugger||q.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)})),this._cacheKeySuffix=G.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch(function(e){return le.warn("Failed to initialize IndexedDB cache: "+e)}),this._componentColorManager=this._hasSymbolColors?new ee.BufferManager(this._stage.renderView.renderingContext):null},s.prototype.destroy=function(){this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},s.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},s.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},s.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage();return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},s.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage();this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},s.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},s.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},s.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0},s.prototype.ignoresMemoryFactor=function(){return!1},s.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider)):this.view.elevationProvider.register(this._elevationContext,this._elevationProvider)},s.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},s.prototype._addThisLayerToStage=function(){var e=""+this.layer.uid,t=new X(e,{},e);this._stageLayer=t,this._stage.add(0,t),this._stage.addToViewContent([t.id])},s.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;this._removeAllNodeDataFromStage(),$.verify(0===this._nodeId2Meta.size),e.remove(0,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},s.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},s.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},s.prototype.setAttributeData=function(e,t){var r=this._nodeId2Meta.get(e);r&&(r.attributeInfo=t,r.cachedRendererVersion=this._getInvalidRendererVersion(),r.filteredIds=null,this._updateEngineObject(r))},s.prototype.getLoadedNodeIds=function(){var e=[];return this._nodeId2Meta.forEach(function(t){return e.push(t.node.id)}),e.sort()},s.prototype.getLoadedNodes=function(){var e=new Array;return this._nodeId2Meta.forEach(function(t){return e.push(t.node)}),e},s.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach(function(t,r){return e.push(r)})},s.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){if(void 0===t&&(t=!1),void 0===r&&(r=!1),this._isIntegratedMesh)return{baseColorOpacity:1,layerOpacity:1,forceTransparency:!1};var n=this.fullOpacity,i=g.clamp(e.metallicRoughness.baseColorFactor[3],0,1);return{baseColorOpacity:i,layerOpacity:n,forceTransparency:i<1||n<1||!t&&"blend"===e.alphaMode||r}},s.prototype._getMaterialParameters=function(e,t,n){var i=e.metallicRoughness.baseColorFactor,a=this._isIntegratedMesh,o=this._calcEngineMaterialTransparencyParams(e),s=this.rendererTextureUsage,l=function(e){return 0!=(e&s)?ie(t,n,e):null};return r({usePBR:!a&&(!e.isSchematic||this.view.qualitySettings.physicallyBasedRenderingEnabled),baseColor:[i[0],i[1],i[2]],metallicFactor:e.metallicRoughness.metallicFactor,roughnessFactor:e.metallicRoughness.roughnessFactor,emissiveFactor:e.emissiveFactor,reflectanceFactor:e.isSchematic?.2:.5,baseColorTexture:l(1),metallicRoughnessTexture:l(2),normalTexture:l(4),emissiveTexture:l(16),occlusionTexture:l(8),doubleSidedShading:e.doubleSided,cullFace:e.cullFace,writeStencil:a,receiveSSAO:!a,normals:a?"ground":"vertex"},o)},s.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture,textureCoordinateRegions:e.hasTexture&&e.hasRegions,colors:this._hasVertexColors,componentData:this._hasSymbolColors,normals:this._isIntegratedMesh?"none":e.hasNormals?"compressed":"screen-space"}},s.prototype._createTexture=function(e,t,r,n){if(f.isNone(r)||null==r.data)return null;var i,a=r.data,o=r.encoding,s=t.wrapTextures,l=1&r.usage?"opaque"===t.alphaMode?3:4:3,d=!0;if(o===G.DDS_ENCODING_STRING)i=Z.DDS_ENCODING;else{var u=a;d=g.isPowerOfTwo(u.width)&&g.isPowerOfTwo(u.height)}var c=n,h=(c?this._enableAtlasMipMaps:this._enableMipMaps)&&d,p=c||!s,y=c&&h&&this._disableAtlasAnisotropy,m=p?{s:33071,t:33071}:{s:10497,t:10497},_={mipmap:h,wrap:m,disableAnisotropy:y,encoding:i,noUnpackFlip:!0,components:l},b=new Z(a,e.id+"/"+r.id,_);return this._stage.add(4,b),e.memory+=this.memEstimateTextureAdded(b),b},s.prototype._getVertexBufferLayout=function(e,t){var r=e.params.material,n={hasTexture:ne(r),hasNormals:null!=t.vertexAttributes.normal,hasRegions:null!=t.vertexAttributes.region};return W.glLayout(te.ComponentMaterial.vertexBufferLayout(this._getGeometryParameters(n)))},s.prototype._createEngineMaterial=function(e,t,r,n){var i=this,a=t.params.material,o=n.some(function(e){return"region"===e.name}),s=f.isSome(r)?r.map(function(t){return i._createTexture(e,a,t,o)}):[],l=n.some(function(e){return"normalCompressed"===e.name}),d=ne(a),u=this._getMaterialParameters(a,r,s),c=this._getGeometryParameters({hasTexture:d,hasRegions:o,hasNormals:l}),h=te.ComponentMaterial.create(u,c,""+e.id);return h.metadata={material:a,textures:s,isSchematic:a.isSchematic},h},s.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},s.prototype._findGraphicNodeAndIndex=function(e){var t=U.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return h.everyMap(this._nodeId2Meta,function(e,n){var i=e.featureIds.indexOf(t);return-1===i||(r={node:e.node,index:i},!1)}),r},s.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(!r)return[];for(var n=[],i=this._getObjectIdField(),a=0,o=t;a<o.length;a++){var s=o[a],l=U.attributeLookup(s.attributes,i),d=r.featureIds.indexOf(l);-1!==d&&n.push(d)}return n},s.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return y.reject();var r=this._nodeId2Meta.get(t.node.index).engineObject,n=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(z.bufferToBuffer(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8)){var i=M.empty();return M.expandWithBuffer(i,n,0,8),y.resolve({boundingBox:i,screenSpaceObjects:[]})}},s.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(e){for(var t=new Map,n=[],i=0,a=e;i<a.length;i++){var o=a[i],s=r._findGraphicNodeAndIndex(o),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},n.push(l)),l.indices.push(s.index),l.graphics.push(o)}return n};return G.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,n,{ignoreUnavailableFields:!0,populateObjectId:!0})},s.prototype.getGraphicFromStageObject=function(e,t){if(this._isIntegratedMesh)return null;var r=this._getMetadata(e),n=e.getComponentFromTriangleNr(0,t);return null!=n&&null!=r.featureIds&&n<r.featureIds.length?this._createGraphic(n,r):null},s.prototype.hasStageObject=function(e){var t=e.getMetadata(),r=this._nodeId2Meta.get(t.nodeIndex);return r&&r.engineObject===e},s.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.nodeIndex)},s.prototype._getCacheKey=function(e){return this._layerUrl+"/v6/"+e.id+this._cacheKeySuffix},s.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},s.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},s.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},s.prototype.loadMissingTextures=function(e,t,r,n){var i=this,a=e.filter(function(e,r){if(0==(e.usage&i.rendererTextureUsage))return!1;if(f.isNone(t))return!0;var n=G.selectEncoding(e.encodings,i.useCompressedTextures),a=t[r];return!!(f.isNone(a)||null==a.data||n&&a.encoding!==n.encoding)});return 0===a.length?y.resolve(!1):r(a,n).then(function(r){for(var n=0,i=0;i<e.length;i++)n<r.length&&r[n].id===e[i].id&&(t[i]=r[n],n++);return!0})},s.prototype.loadCachedNodeData=function(e,t,r){var n=this;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e),t).then(function(i){return null==i?null:i.nodeVersion!==e.version?(n._idbCache.remove(n._getCacheKey(e)),null):(e.obb||(e.obb=K.clone(i.nodeObb),n._controller.updateVisibility(e.index)),n.loadMissingTextures(i.requiredTextures,i.textureData,r,t).then(function(r){return r&&n._idbCache.initialized&&f.isSome(i.textureData)&&(i.byteSize=oe(i.transformedGeometries,i.textureData),i.textureData.every(ae)&&se(e,i)&&n._idbCache.put(n._getCacheKey(e),i).catch(function(t){return le.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)})),y.throwIfAborted(t),i}))}):y.resolve(null)},s.prototype.addNodeData=function(e,t){var n=this;return 0===t.allGeometryData.length||0===t.allGeometryData[0].geometries.length?y.resolve():(1!==t.allGeometryData.length&&console.warn("Node with",t.allGeometryData.length,"geometries is unsupported"),this._addData(e,t.attributeDataInfo,function(){return n._transformNode(e,t).then(function(t){return n._controller.reschedule(e.index,t)}).then(function(i){e.obb||(e.obb=i.obb,n._controller.updateVisibility(e.index)),t.allGeometryData[0].componentOffsets=i.componentOffsets,i.featureIds&&(t.allGeometryData[0].featureIds=Array.prototype.slice.call(i.featureIds));var a={geometryData:t.allGeometryData[0],transformedGeometries:i.transformedGeometries,requiredTextures:t.requiredTextures,textureData:t.textureData,nodeVersion:e.version,nodeObb:e.obb,byteSize:n._cachingEnabled()?oe(i.transformedGeometries,t.textureData):0};if(se(e,a)&&n._idbCache.initialized){var o=f.isSome(a.textureData)?a.textureData.map(function(e){return ae(e)?e:null}):null;n._idbCache.put(n._getCacheKey(e),r({},a,{textureData:o})).catch(function(t){return le.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return n._addCachedNodeData(e,a)})}))},s.prototype._transformNode=function(e,t){for(var r=this,n=t.allGeometryData[0].geometries,i=new Array(n.length),a=0;a<n.length;++a)i[a]=this._getVertexBufferLayout(n[a],t.geometryIndex);var o={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData[0],geometryIndex:t.geometryIndex,layouts:i,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",o,{transferList:[t.geometryBuffer]}):V.ensureDracoDecoder(o).then(function(){return r._controller.reschedule(e.index,o).then(function(e){return r._worker.transform(e)})})},s.prototype.addCachedGPUData=function(e,t,r){if(!this._controller.isGeometryVisible(e)){var n=this._controller.indexDepth-e.level;return void this._memCache.put(this._getMemCacheKey(e.index),t,e.memory,n)}this._nodeId2Meta.set(e.index,t),this.updateNodeStatus(e.index,r),t.engineObject.setHidden(t.engineObject.geometryRecords[0],!1);for(var i=0,a=t.engineObject.geometryRecords;i<a.length;i++){var o=a[i],s=o.material;s.updateParameters({slicePlaneEnabled:this.slicePlaneEnabled,usePBR:!this._isIntegratedMesh&&(!s.metadata.isSchematic||this.view.qualitySettings.physicallyBasedRenderingEnabled)})}this._updateEngineObject(t),this._highlights.objectCreated(t.engineObject),this._treeDebugger&&this._treeDebugger.update()},s.prototype.addCachedNodeData=function(e,t,r){var n=this;return this._addData(e,r,function(){return n._addCachedNodeData(e,t)})},s.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return y.resolve();var n=t.geometryData,i=t.transformedGeometries,a=f.isSome(t.textureData)?t.textureData.filter(function(e){return f.isSome(e)&&0!=(e.usage&r.rendererTextureUsage)}):null,o=new Map;o.set(1,{}),o.set(2,{}),o.set(3,{});var s=0,l=!1;e.memory=0;var d=n.componentOffsets,u=n.geometries,c=n.featureIds,h=null,p=null;if(this._hasSymbolColors){h=this._componentColorManager.getBuffer(c.length),p=new Uint16Array(c.length);for(var g=0;g<c.length;g++)p[g]=h.acquireIndex()}for(var m,_=e.id+"|"+c[0],b=new Array,v=new Array,x=new Array,I=new Array,C=this.view,O=0,w=u;O<w.length;O++){var M=w[O],D=i[s++],T=this._createEngineMaterial(e,M,a,D.layout);m=D.corMatrices.globalTrafo,l=l||D.hasColors;var E=new Y(new Float32Array(D.interleavedVertexData),D.layout,D.positionData,d||Y.DefaultOffsets,D.indices||Y.DefaultIndices);this._hasSymbolColors&&this._setComponentIndices(E,p);var j=null!=M.transformation?S.mat4f64.clone(M.transformation):he,R=b.length,V=_+(R>0?"_"+R:""),A=new J(E,V),P=C.renderSpatialReference;b.push(A),x.push(j),I.push(T);var F=N.createOrigin(e.mbs,this.elevationOffset,this._controller.crsIndex,P);v.push(F),e.memory+=this.memEstimateGeometryAdded(A.data),o.get(3)[T.id]=T,o.get(2)[A.id]=A}var G={nodeIndex:e.index,layerUid:this._layerUid},B=new Q({idHint:e.id,geometries:b,materials:I,transformations:x,origins:v,castShadow:!0,metadata:G});B.objectTransformation=m,o.get(1)[B.id]=B;var U=this._addTasks.get(e.index),L=new ue;L.node=e,L.engineObject=B,L.featureIds=c,L.componentColorBuffer=h,L.componentIndices=p,L.cachedRendererVersion=this._getInvalidRendererVersion(),L.cachedSymbolInfos=[],L.attributeInfo=U.attributeInfo,!this._hasTextures&&t.requiredTextures.some(function(e){return 0!=(19&e.usage)})&&(this._hasTextures=!0),this._hasColors||(this._hasColors=l),this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors");var H=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(L).then(function(){var t=r._stageLayer,n=r._stage,i=o.get(1);for(var a in i)i.hasOwnProperty(a)&&t.addObject(i[a]);if(o.forEach(function(e,t){for(var r in e)e.hasOwnProperty(r)&&null==n.getContent(t,r)&&n.add(t,e[r])}),r._nodeId2Meta.has(e.index)&&(le.warn("Removing duplicated node"),r._deleteNodeStageData(r._nodeId2Meta.get(e.index))),r._nodeId2Meta.set(e.index,L),r.suspended)return void r._removeNodeStageData(e.index,r.elevationOffset);L.attributeInfo=U.attributeInfo,L.cachedRendererVersion===r._rendererVersion&&H===r.slicePlaneEnabled||r._addOrUpdateEdgeRendering(L),r._setObjectSymbology(L),r._applyFiltersToNode(L)&&r._updateEdgeRendering(L),r.visibleGeometryChanged(B),r._highlights.objectCreated(B);for(var s=0,l=L.engineObject.geometryRecords;s<l.length;s++){l[s].material.updateParameters({slicePlaneEnabled:r.slicePlaneEnabled})}r._markParentsAsHole(e.index),r._treeDebugger&&r._treeDebugger.update()})},s.prototype._addData=function(e,t,n){var i=this,a=this._addTasks.get(e.index);return a?a.attributeInfo=t:(a=r({},y.createResolver(),{attributeInfo:t}),this._addTasks.set(e.index,a),n().then(a.resolve,a.reject).then(function(){return i._addTasks.delete(e.index)}).catch(function(t){throw i._addTasks.delete(e.index),t})),a.promise},s.prototype._markParentsAsHole=function(e){if(this._isIntegratedMesh)for(var t=this._controller,r=t.getParentIndex(e);r;r=t.getParentIndex(r))this.updateNodeStatus(r,"hole")},s.prototype._clippingAreaChanged=function(){var e=M.create();z.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},s.prototype._filterChange=function(){this._applyFilters(!1)},s.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e.engineObject))})},s.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)}),t},s.prototype.addSqlFilter=function(e,t,r,n){var i=this;t&&r&&e.push(function(e,a){return i._sqlFilter(e,a,t,r,n)})},s.prototype._sqlFilter=function(e,t,r,n,i){var a={},o=this._createLayerGraphic(a),s=this.layer.objectIdField,l=t.featureIds,d=t.attributeInfo.attributeData;n.every(function(e){return null!=d[e]||e===s})&&G.filterInPlace(e,l,function(e){a[s]=l[e];for(var t=0,u=n;t<u.length;t++){var c=u[t];c!==s&&(a[c]=G.getCachedAttributeValue(d[c],e))}try{return r.testFeature(o)}catch(e){return i(e),!1}})},s.prototype._boundingboxNodeTest=function(e,t){return z.mbsToMbs(e.node.mbs,this._controller.crsIndex,_e,this.view.renderSpatialReference),G.intersectBoundingBoxWithMbs(t,_e)},s.prototype._boundingboxFeatureTest=function(e,t,r){var n=e.engineObject.geometryRecords[0].geometry;return M.intersects(r,n.getComponentAABB(t,fe))},s.prototype._boundingboxFilter=function(e,t,r){var n=this,i=this._boundingboxNodeTest(t,r);if(3!==i){if(0===i)return void(e.length=0);if(t.engineObject.geometryRecords[0].geometry.componentCount===t.featureIds.length){var a=G.getClipAABB(r,t.engineObject);G.filterInPlace(e,t.featureIds,function(e){return n._boundingboxFeatureTest(t,e,a)})}}},s.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return y.resolve();var r=e.engineObject,n=this._edgeView.hasObject(r),i=this._extractObjectEdgeMaterials(e),a=i.hasEdges,o=i.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};if(a){var l=!r.isHidden(r.geometryRecords[0]);if(n)this._edgeView.updateAllComponentMaterials(r,o,s,t),this._edgeView.updateObjectVisibility(r,l);else if(l)return d.safeCast(this._edgeView.addObject(r,o,s,!1))}else n&&this._edgeView.removeObject(r);return y.resolve()},s.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._edgeView.removeObject(e.engineObject)},s.prototype._applyFiltersToNode=function(e){var t=e.engineObject,r=t.areAllComponentsVisible();if(t.unhideAllComponents(),0===this._filters.length)return!r;var n=e.featureIds;null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters);var i=e.filteredIds;if(i===n)return!r;for(var a=t.geometryRecords[0],o=0,s=0;s<n.length;s++){var l=n[s];o>=i.length||i[o]!==l?t.setComponentVisibility(a,s,!1):o++}return!0},s.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,n=this._filters;r<n.length;r++){(0,n[r])(t,e)}return t.length===e.featureIds.length?e.featureIds:t},s.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,n){return t._removeNodeStageData(n,e)})},s.prototype.removeNodeData=function(e,t){for(var r=this.elevationOffset;e.length>0&&!t.done;){var n=e.pop();this._removeNodeStageData(n,r),t.madeProgress()}},s.prototype._removeNodeStageData=function(e,t){var r=this._nodeId2Meta.get(e);if(r){var n=r.engineObject;n.setHidden(n.geometryRecords[0],!0),this.visibleGeometryChanged(n),this._removeEdgeRendering(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(n);var i=this._controller.indexDepth-r.node.level+1;this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory,i),this._treeDebugger&&this._treeDebugger.update()}},s.prototype._deleteNodeStageData=function(e){var t=this._stage,r=this._stageLayer,n=e.engineObject;this._edgeView&&this._edgeView.removeObject(n),r.removeObject(n);for(var i=0,a=n.geometryRecords;i<a.length;i++){var o=a[i];this.memEstimateGeometryRemoved(o.geometry.data),t.remove(2,o.geometry.id),this._removeMaterial(o.material,t)}if(e.componentIndices){for(var s=0;s<e.componentIndices.length;s++)e.componentColorBuffer.releaseIndex(e.componentIndices[s]);this._componentColorManager.garbageCollect()}t.remove(1,n.id)},s.prototype._removeMaterial=function(e,t){t.remove(3,e.id);for(var r=0,n=e.metadata.textures;r<n.length;r++){var i=n[r];i&&(this.memEstimateTextureRemoved(i),t.remove(4,i.id))}},s.prototype.updateNodeStatus=function(e,t){var r=this._nodeId2Meta.get(e);if(r)for(var n="hole"===t,i=0,a=r.engineObject.geometryRecords;i<a.length;i++){var o=a[i],s=o.material;s.updateParameters({polygonOffsetEnabled:n})}},s.prototype._getInvalidRendererVersion=function(){return G.addWraparound(this._rendererVersion,-1)},s.prototype._rendererChange=function(e){return o(this,void 0,void 0,function(){var t,r,n,i,o,s,l,d;return a(this,function(a){switch(a.label){case 0:return this._currentRenderer=e,(this.notifyChange("rendererTextureUsage"),this._rendererVersion=G.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e)?(t=this,r=G.findFieldsCaseInsensitive,[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,[a.sent(),this.layer.fields]),a.label=2;case 2:if(e&&"visualVariables"in e&&e.visualVariables)for(n=0,i=e.visualVariables;n<i.length;n++)o=i[n],"color"===o.type?this._colorVariable=o:"opacity"===o.type?this._opacityVariable=o:le.warn("Unsupported visual variable type for 3D Object Scene Services: "+o.type);if(e)for(s=0,l=e.getSymbols();s<l.length;s++)d=l[s],"mesh-3d"!==d.type&&le.error("Symbols of type '"+d.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}})})},s.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},s.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolColors},s.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r={},n=this._tmpAttributeOnlyGraphic;n.attributes=r;var i=this._currentRenderer,a=e.attributeInfo.attributeData,o=null!=e.featureIds?this.layer.objectIdField:null,s=null!=a?this._rendererFields:null;null==e.cachedSymbolColors&&(e.cachedSymbolColors=new Uint8Array(4*e.featureIds.length));for(var l=e.cachedSymbolColors,d=!0,u=0;u<t;u++){if(null!=o&&(r[o]=e.featureIds[u]),null!=s)for(var c=0,h=s;c<h.length;c++){var p=h[c];a[p]&&(r[p]=G.getCachedAttributeValue(a[p],u))}var g=i&&i.getSymbol(n,{arcadeUtils:E}),f=null;g instanceof j&&(this._symbolInfos.has(g.id)||this._symbolInfos.set(g.id,G.getSymbolInfo(g)),f=this._symbolInfos.get(g.id)),e.cachedSymbolInfos[u]=f;var y=null,m=null,_=!0,b=!0;if(i&&"visualVariables"in i){if(this._colorVariable){var v=T.getColor(this._colorVariable,n,{color:me});v&&(y=ye,y[0]=v.r/255,
y[1]=v.g/255,y[2]=v.b/255,this._opacityVariable||null===v.a||(m=v.a))}this._opacityVariable&&(m=T.getOpacity(this._opacityVariable,n))}if(f&&f.material){var x=f.material;y=null==y||null==m?A.overrideColor(y,m,x.color,x.alpha,de,ye):A.overrideColor(y,m,null,null,de,ye),k.encodeSymbolColor(y,x.colorMixMode,l,4*u),_=f.castShadows}else k.encodeSymbolColor(null,null,l,4*u),_=!0;if(u>0&&d){for(var I=4*(u-1);I<4*u;I++)l[I]!==l[I+4]&&(d=!1);_!==b&&(d=!1)}b=_}e.uniformSymbolColor=d}},s.prototype._extractObjectEdgeMaterials=function(e){var t=e.engineObject,r=e.featureIds?e.featureIds.length:1,n=new Array(r),i=L.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),a={opacity:this.fullOpacity,objectTransparency:2};if(e.engineObject.geometryRecords.length>0){var o=e.engineObject.geometryRecords[0].material;a.objectTransparency=o.isVisible()?o.hasTransparency?1:2:0}for(var s=!1,l=null,d=null,u=this._getSymbolInfos(e),c=0;c<r;c++){var h=u[c];t.getComponentVisibility(t.geometryRecords[0],c)&&h?(d!==h&&(d=h,(l=L.createMaterialFromEdges(h.edges,a))&&(s=!0)),n[c]=f.isSome(l)?l:i):n[c]=i}return{hasEdges:s,perFeatureEdgeMaterials:n}},s.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){var t=e.featureIds?e.featureIds.length:1,r=this._getSymbolColors(e);if(e.uniformSymbolColor){var n=k.decodeSymbolColor(r,0),i=n.color,a=n.colorMixMode,o=!0;e.cachedSymbolInfos[0]&&(o=e.cachedSymbolInfos[0].castShadows);for(var s=0,l=e.engineObject.geometryRecords;s<l.length;s++){var d=l[s],u=d.material;u.updateParameters({componentData:{castShadows:o,externalColor:i,externalColorMixMode:a}})}var c=i[3]<1,h=!c&&"replace"===a;this._updateObjectOpacity(e.engineObject,h,c)}else{for(var p=e.componentColorBuffer.textureBuffer,g=!0,f=!0,y=!0,m=0;m<t;m++){var _=4*m,b=e.componentIndices[m],v=1;e.cachedSymbolInfos[m]&&(v=!0===e.cachedSymbolInfos[m].castShadows?1:0),p.setData(b,0,r[_],r[_+1],254&r[_+2]|v,r[_+3]);var x=k.isOpaqueSymbolColor(r,_);g=g&&x,f=f&&!x;var a=k.decodeSymbolColorMixMode(r,_);y=y&&2===a}for(var I=0,C=e.engineObject.geometryRecords;I<C.length;I++){var d=C[I],u=d.material,S=u.metadata.material,O="blend"!==S.alphaMode,w=!g&&!f,M=w&&O;u.updateParameters({componentData:{textureBuffer:p},useVertexTransparencyDiscards:M})}var D=g&&y;this._updateObjectOpacity(e.engineObject,D,!g),this._stage.renderView.setNeedsRender()}this._updateEdgeRendering(e)}},s.prototype._setComponentIndices=function(e,t){for(var r=e.getAttribute($.VertexAttrConstants.COMPONENTINDEX),n=r.data,i=r.offsetIdx,a=r.strideIdx,o=e.getIndices($.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],d=e.componentOffsets[s+1],u=l;u<d;u++){var c=i+o[u]*a;n[c]=t[s]}},s.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},s.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._updateEdgeRendering(e)})},s.prototype._updateObjectOpacity=function(e,t,r){for(var n=0,i=e.geometryRecords;n<i.length;n++){var a=i[n],o=a.material,s=o.metadata;void 0!==t&&(s.allSymbolsOpaqueReplace=t),void 0!==r&&(s.someSymbolsTransparent=r);var l=this._calcEngineMaterialTransparencyParams(s.material,s.allSymbolsOpaqueReplace,s.someSymbolsTransparent);o.updateParameters(l)}},s.prototype._updateEngineObject=function(e){this._setObjectSymbology(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e.engineObject)},s.prototype._slicePlaneEnabledChange=function(e){var t=this,r={slicePlaneEnabled:e};this._stageLayer.isSliceable=e,this._nodeId2Meta.forEach(function(e){for(var n=0,i=e.engineObject.geometryRecords;n<i.length;n++){i[n].material.updateParameters(r)}t._updateEdgeRendering(e,!1)})},s.prototype._enablePhysicalBasedRendering=function(e){var t=this,r={usePBR:!0};this._nodeId2Meta.forEach(function(e){for(var n=0,i=e.engineObject.geometryRecords;n<i.length;n++){var a=i[n],o=a.material;r.usePBR=!t._isIntegratedMesh&&(!o.metadata.isSchematic||t.view.qualitySettings.physicallyBasedRenderingEnabled),o.updateParameters(r)}})},s.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.engineObject)&&this._addOrUpdateEdgeRendering(e,t)},s.prototype._forAllFeatures=function(e,t,r){var n=this;void 0===r&&(r=0),h.everyMap(this._nodeId2Meta,function(i,a){if(f.isSome(t)){switch(t(i)){case 0:return!1;case 2:return!0}}return 0!==n._forAllFeaturesOfNode(i,e,r)})},s.prototype._forAllFeaturesOfNode=function(e,t,r){void 0===r&&(r=0);var n=e.featureIds,i=e.engineObject.geometryRecords[0],a=2===r&&this._clippingArea?G.getClipAABB(this._clippingArea,e.engineObject):null,o=a?this._boundingboxNodeTest(e,this._clippingArea):3;if(0===o)return 1;for(var s=0;s<n.length;s++){if(e.engineObject.getComponentVisibility(i,s)||1===r||2===r&&(3===o||this._boundingboxFeatureTest(e,s,a))){var l=n[s],d=t(l,s,e,i);switch(d){case 0:return d}}}return 1},s.prototype._createGraphic=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var n=t.attributeInfo.attributeData;if(null!=n)for(var i=0,a=Object.keys(n);i<a.length;i++){var o=a[i];r[o]=G.getCachedAttributeValue(n[o],e)}return this._createLayerGraphic(r)},s.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].getComponentAABB(e,ge),i=0;i<8;++i)pe[0]=1&i?n[0]:n[3],pe[1]=2&i?n[1]:n[4],pe[2]=4&i?n[2]:n[5],O.vec3.transformMat4(pe,pe,t.objectTransformation),r[3*i]=pe[0],r[3*i+1]=pe[1],r[3*i+2]=pe[2];return r},s.prototype.highlight=function(e,t){var r=this;void 0===t&&(t={});var n=this._highlights;if("number"==typeof e?e=[e]:e instanceof l?e=[e]:e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof l){var i=e,a=i.map(function(e){return U.attributeLookup(e.attributes,r._getObjectIdField())}),o=n.acquireSet(t),s=o.set,d=o.handle;return n.setFeatureIds(s,a),d}if("number"==typeof e[0]){var a=e,c=n.acquireSet(t),s=c.set,d=c.handle;return n.setFeatureIds(s,a),d}}return be},s.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=_.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},s.prototype.test=function(){var e=this;return{controller:this._controller,get visibleObjectIds(){var t=[];return e._forAllFeatures(function(e,r,n,i){return n.engineObject.isHidden(i)||n.engineObject.areAllComponentsHidden()||!n.engineObject.getComponentVisibility(i,r)||t.push(e),1}),t.sort(function(e,t){return e-t}),t},get numNodes(){return e._nodeId2Meta.size}}},i([C.property()],s.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),i([C.property()],s.prototype,"view",void 0),i([C.property()],s.prototype,"layer",void 0),i([C.property()],s.prototype,"_controller",void 0),i([C.property({dependsOn:["updatingMeshView3D"]})],s.prototype,"updating",void 0),i([C.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle"]})],s.prototype,"updatingMeshView3D",null),i([C.property({dependsOn:["_controller.rootNodeVisible"]})],s.prototype,"suspended",void 0),i([C.property(H.updatingPercentage)],s.prototype,"updatingPercentage",void 0),i([C.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],s.prototype,"updatingPercentageValue",void 0),i([C.property({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),i([C.property({readOnly:!0})],s.prototype,"rendererTextureUsage",null),i([C.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],s.prototype,"elevationOffset",null),i([C.property({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),i([C.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],s.prototype,"uncompressedTextureDownsamplingEnabled",null),i([C.property({dependsOn:["layer.version"]})],s.prototype,"useCompressedTextures",null),s=i([C.subclass("esri.views.3d.layers.I3SMeshView3D")],s)}(C.declared(t))};var he=S.mat4f64.create(),pe=w.vec3f64.create(),ge=M.create(),fe=M.create(),ye=[0,0,0,0],me=new s([0,0,0,0]),_e=[0,0,0,0],be={remove:function(){},pause:function(){},resume:function(){}}});