// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,n,i,o,a,l,s,c,d,p,u,h,f,y,v,g,m,b){function x(e,t,r){e&&e.forEach(function(e){var n=t(e);n&&r(n,e.graphic)})}Object.defineProperty(t,"__esModule",{value:!0});var S=[0,0,1],O=function(e){function t(t,r,n,i){var o=e.call(this,t,r,n,i)||this;return o._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},o}return r(t,e),t.prototype.doLoad=function(){return i(this,void 0,void 0,function(){var e;return n(this,function(t){if(!this._isPropertyDriven("size")&&(e=f.validateSymbolLayerSize(this.symbolLayer.size)))throw new o("graphics3dtextsymbollayer:invalid-size",e);return this._createTextRenderParameters(),[2]})})},t.prototype._createTextRenderParameters=function(){var e=this._context.layerView.view.pixelRatio;this._textRenderParameters=g.default.fromSymbol(this.symbolLayer,e)},t.prototype.destroy=function(){e.prototype.destroy.call(this)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic,r=u.placePointOnGeometry(t.geometry);if(a.isNone(r))return this.logger.warn("unsupported geometry type for text symbol: "+t.geometry.type),null;var n=this.symbolLayer.text;if(!n)return null;var i=c.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,r,n,i)},t.prototype.createLabel=function(e,t,r,n){var i=e.graphic,o=u.placePointOnGeometry(i.geometry);if(a.isNone(o))return this.logger.warn("unsupported geometry type for label: "+i.geometry.type),null;var l=t.text;return l?this._createAs3DShape(i,o,l,t,t,r,n):null},t.prototype.getGraphicElevationContext=function(t,r){void 0===r&&(r=0);var n=e.prototype.getGraphicElevationContext.call(this,t);return n.addOffsetRenderUnits(r),n},t.prototype.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},t.prototype.layerElevationInfoChanged=function(e,t){var r=this;return x(e,t,function(e,t){r.updateGraphicElevationContext(t,e)}),!0},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return x(e,t,function(e){for(var t=0,n=e.stageObject.geometryRecords;t<n.length;t++){n[t].material.setParameterValues({slicePlaneEnabled:r._context.slicePlaneEnabled})}}),!0},t.prototype.pixelRatioChanged=function(e,t){return!1},t.prototype.updateGraphicElevationContext=function(e,t){var r=this.getGraphicElevationContext(e,t.metadata.elevationOffset);t.elevationContext.set(r),t.needsElevationUpdates=u.needsElevationUpdates2D(r.mode)||"absolute-height"===r.mode},t.prototype._defaultElevationInfoNoZ=function(){return P},t.prototype._createAs3DShape=function(e,t,r,n,i,o,c){void 0===i&&(i=E);var h=this.getGraphicElevationContext(e,i.elevationOffset),g=this._context.layer.id+"_label_"+e.uid,x="polyline"===a.get(e.geometry,"type"),O=e.uid,P=this._context.stage.renderView.renderingContext,_=i.anchor in f.namedAnchorToHUDMaterialAnchorPos?i.anchor:"center",w=f.namedAnchorToHUDMaterialAnchorPos[_],G=a.isNone(c)?new m(P,r,this._textRenderParameters,g):null,D={occlusionTest:!0,screenOffset:i.screenOffset,anchorPos:w,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:i.centerOffsetUnits,debugDrawBorder:i.debugDrawBorder,drawInSecondSlot:!0};if(a.isSome(G)&&(D.textureId=G.id,D.texCoordScale=G.texcoordScale),a.isSome(c)&&(D.textureId=c.textureId),a.isSome(n)&&a.isSome(n.verticalOffset)){var C=n.verticalOffset,L=C.screenLength,U=C.minWorldLength,T=C.maxWorldLength;D.verticalOffset={screenLength:l.pt2px(L),minWorldLength:U||0,maxWorldLength:null!=T?T:1/0}}if(this._context.screenSizePerspectiveEnabled){var z=this._context.sharedResources,A=z.screenSizePerspectiveSettings,R=z.screenSizePerspectiveSettingsLabels;D.screenSizePerspective=R.overridePadding(this._textRenderParameters.haloSize),D.screenSizePerspectiveAlignment=A}x&&(D.shaderPolygonOffset=1e-4),D.slicePlaneEnabled=this._context.slicePlaneEnabled;var H=null,j=JSON.stringify(D);a.isSome(o)?null==(H=o.getMaterial(j))&&(H=new b(D,g),o.addMaterial(j,H)):H=new b(D,g);var W=[H],I=v.createPointGeometry(S,i.translation,void 0,a.isSome(G)?[G.displayWidth,G.displayHeight]:[0,0],i.centerOffset,a.isSome(c)?[0,0]:null),M=[new y(I,g)],N=this._context.layer.uid,V=u.createStageObjectForPoint(this._context,t,M,W,null,null,h,g,N,O,!0);if(null===V)return null;var B=d.perObjectElevationAligner,q=new p(this,V.object,M,a.isNone(o)?W:null,a.isSome(G)?[G]:null,B,h);q.alignedTerrainElevation=V.terrainElevation,q.needsElevationUpdates=u.needsElevationUpdates2D(h.mode)||"absolute-height"===h.mode;var F=a.isSome(G)?G:i,J=F.displayWidth,Z=F.displayHeight;q.getScreenSize=function(e){return void 0===e&&(e=s.vec2f64.create()),e[0]=J,e[1]=Z,e};var k={labelText:r,elevationOffset:i.elevationOffset};return q.metadata=k,u.extendPointGraphicElevationContext(q,t,this._context.elevationProvider),q},t}(h.default);t.Graphics3DTextSymbolLayer=O;var P={mode:"relative-to-ground",offset:0},E={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};t.default=O});