// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/lang","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f32","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./lineUtils","../support/FastSymbolUpdates","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/shaders/RibbonLinePrograms"],function(e,t,r,a,i,n,s,o,l,p,d,c,h,y,u,v,g,m,f,b,x,_,A,E,C,U,T,D,S){Object.defineProperty(t,"__esModule",{value:!0});var I=function(e){function t(t,r,a,i){var n=e.call(this,t,r,a,i)||this;return n._lineWidthLOD=1,n}return r(t,e),t.prototype.doLoad=function(){return i(this,void 0,void 0,function(){var e,t,r,i;return a(this,function(a){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=E.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},e=this._getCombinedOpacityAndColor(l.get(this.symbolLayer,"material","color")),t=e[3],r={width:1,color:e,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:t<1||this._isPropertyDriven("opacity"),slicePlaneEnabled:this._context.slicePlaneEnabled},this._isPropertyDriven("size"))this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(r.width=p.pt2px(1));else{if((i=null!=this.symbolLayer.size?this.symbolLayer.size:p.px2pt(1))<0)throw new n("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");r.width=p.pt2px(i),"round"===r.join&&(this._lineWidthLOD=1.863798+-2.0062872/Math.pow(1+i/18.2313,.8856294))}return this._fastUpdates&&this._fastUpdates.visualVariables&&s.mixin(r,this._fastUpdates.materialParameters,{}),this._material=new D(r,this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._material),[2]})})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)},t.prototype.getDrivenSize=function(e){var t=new Float32Array(1);return this._isPropertyDriven("size")&&e.size?t[0]=p.pt2px(g.getDriverAxisSizeValue(e.size)):t[0]=1,t},t.prototype.getSizeFeatureAttribute=function(e){var t=new Float32Array(1);return t[0]=_.getAttributeValue(this._fastUpdates.visualVariables.size.field,e),t},t.prototype.getDrivenColor=function(e,t){var r=u.vec4f32.fromValues(1,1,1,1);return this._isPropertyDriven("color")&&e.color&&(r[0]=e.color[0],r[1]=e.color[1],r[2]=e.color[2],e.color.length>0&&(r[3]=e.color[3])),this._isPropertyDriven("opacity")&&e.opacity&&(r[3]=e.opacity),r},t.prototype.getColorFeatureAttribute=function(e){var t=new Float32Array(1);return t[0]=_.getAttributeValue(this._fastUpdates.visualVariables.color.field,e),t},t.prototype.getOpacityFeatureAttribute=function(e){var t=new Float32Array(1);return t[0]=_.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,e),t},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic,a=r.geometry;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(a))return null;var i="polygon"===a.type||"extent"===a.type?"rings":"paths",n="graphic"+r.uid,s=this.getGraphicElevationContext(r);return"on-the-ground"===s.mode?this._createAsOverlay(e,i,s,n,this._context.layer.uid):this._createAs3DShape(e,i,s,n,r.uid)},t.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!E.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.layerOpacityChanged=function(){var e=this._material.getParameters().color,t=l.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t),a=r<1||this._isPropertyDriven("opacity"),i=[e[0],e[1],e[2],r];return this._material.setParameterValues({color:i,transparent:a}),!0},t.prototype.layerElevationInfoChanged=function(e,r,a){var i=this._elevationContext.mode,n=x.elevationModeChangeUpdateType(t.elevationModeChangeTypes,a,i);if(n!==x.SymbolUpdateType.UPDATE)return n;var s=x.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,r,function(){return s})},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.physicalBasedRenderingChanged=function(e,t){return!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype._createAs3DShape=function(e,t,r,a,i){var n=e.graphic,s=x.getGeometryAsPoly(n.geometry),o=s[t],l=[],p=[],h=[],u=y.vec3f64.create(),v=new Array(6),g=x.getGeometryVertexData3D(o,s.hasZ,s.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(g,o,t,"LineSymbol3DLayer"),o.length>0){for(var f=g.geometryData.outlines,_=g.eleVertexData,A=g.vertexData,E=0;E<f.length;++E){var T=f[E];if(!(T.count<=1)){var D=T.index,S=T.count;if(!this._context.clippingExtent||(x.computeBoundingBox(_,D,S,v),!x.boundingBoxClipped(v,this._context.clippingExtent))){x.applyOrigin(A,D,S,u);var I=new Float64Array(_.buffer,3*D*_.BYTES_PER_ELEMENT,3*S),V=new Float64Array(A.buffer,3*D*A.BYTES_PER_ELEMENT,3*S),O=this._createGeometryData(e,V,I,"rings"===t),P=new C(O,a+"path"+E);P.singleUse=!0,l.push(P),p.push(this._material);var R=c.mat4f64.create();d.mat4.translate(R,R,u),h.push(R)}}}if(l.length>0){var w=new U({geometries:l,materials:p,transformations:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i},idHint:a}),G=m.perVertexElevationAligner,L=new b(this,w,l,null,null,G,r);return L.alignedTerrainElevation=g.terrainElevation,L.needsElevationUpdates=x.needsElevationUpdates2D(r.mode),L}}return null},t.prototype._createGeometryData=function(e,t,r,a){var i=A.createPolylineGeometryData(t,r,a);if("round"===this._material.getParameters().join){var n=i.vertexAttributes[S.VertexAttrConstants.POSITION].data,s=n.length/3,l=new Float32Array(s),p=V,d=O;h.vec3.set(p,0,0,0);for(var c=0;c<s-1;++c){var y=c+1;h.vec3.set(d,n[3*y+0]-n[3*c+0],n[3*y+1]-n[3*c+1],n[3*y+2]-n[3*c+2]),h.vec3.normalize(d,d);var u=Math.PI-o.acosClamped(h.vec3.dot(p,d)),v=u*P,g=1*v*this._lineWidthLOD;l[c]=Math.max(Math.floor(g),0),h.vec3.scale(p,d,-1)}i.vertexAttributes[S.VertexAttrConstants.SUBDIVISIONS]={size:1,data:l,offsetIdx:0,strideIdx:1},i.indices[S.VertexAttrConstants.SUBDIVISIONS]=i.indices[S.VertexAttrConstants.POSITION]}var m=new Uint32Array(i.vertexAttributes[S.VertexAttrConstants.POSITION].data.length);return i.indices[S.VertexAttrConstants.SIZE]=m,this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?(i.vertexAttributes[S.VertexAttrConstants.SIZEFEATUREATTRIBUTE]={size:1,data:this.getSizeFeatureAttribute(e.graphic),offsetIdx:0,strideIdx:1},i.indices[S.VertexAttrConstants.SIZEFEATUREATTRIBUTE]=m):(i.vertexAttributes[S.VertexAttrConstants.SIZE]={size:1,data:this.getDrivenSize(e.renderingInfo),offsetIdx:0,strideIdx:1},i.indices[S.VertexAttrConstants.SIZE]=m),this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?(i.vertexAttributes[S.VertexAttrConstants.COLORFEATUREATTRIBUTE]={size:1,data:this.getColorFeatureAttribute(e.graphic),offsetIdx:0,strideIdx:1},i.indices[S.VertexAttrConstants.COLORFEATUREATTRIBUTE]=m):(i.vertexAttributes[S.VertexAttrConstants.COLOR]={size:4,data:this.getDrivenColor(e.renderingInfo,e.graphic),offsetIdx:0,strideIdx:4},i.indices[S.VertexAttrConstants.COLOR]=m),this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity&&(i.vertexAttributes[S.VertexAttrConstants.OPACITYFEATUREATTRIBUTE]={size:1,data:this.getOpacityFeatureAttribute(e.graphic),offsetIdx:0,strideIdx:1},i.indices[S.VertexAttrConstants.OPACITYFEATUREATTRIBUTE]=m),i},t.prototype._createAsOverlay=function(e,t,r,a,i){var n=e.graphic,s=x.getGeometryAsPoly(n.geometry),o=s[t];this._material.renderPriority=this._symbolLayerOrder;var l=[],p=new Array(6),h=v.empty(),u=y.vec3f64.create(),g=x.getGeometryVertexDataDraped(o,s.spatialReference,this._context.overlaySR);if(this._logGeometryCreationWarnings(g,o,t,"LineSymbol3DLayer"),o.length>0){for(var m=g.vertexData,b=g.geometryData.outlines,_=0;_<b.length;++_){var A=b[_],E=A.index,C=A.count;if(x.computeBoundingBox(m,E,C,p),!x.boundingBoxClipped(p,this._context.clippingExtent)){v.expand(h,p),x.applyOrigin(m,E,C,u),x.setZ(m,E,C,this._getDrapedZ());var U=new Float64Array(m.buffer,3*E*m.BYTES_PER_ELEMENT,3*C),D=c.mat4f64.create();d.mat4.translate(D,D,u);var S=this._createGeometryData(e,U,null,"rings"===t),I=new T(S);I.data.layerUid=i,I.data.graphicUid=n.uid,I.material=this._material,I.center=[.5*(p[0]+p[3]),.5*(p[1]+p[4]),0],I.bsRadius=.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1])),I.transformation=D,I.name=a,I.uniqueName=a+"#"+S.id,l.push(I)}}return new f(this,l,h)}return null},t.validGeometryTypes=["polyline","polygon","extent"],t.elevationModeChangeTypes={definedChanged:x.SymbolUpdateType.RECREATE,staysOnTheGround:x.SymbolUpdateType.NONE,onTheGroundChanged:x.SymbolUpdateType.RECREATE},t}(_.Graphics3DSymbolLayer);t.Graphics3DLineSymbolLayer=I;var V=y.vec3f64.create(),O=y.vec3f64.create(),P=4/Math.PI;t.default=I});