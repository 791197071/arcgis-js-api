// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./featureExpressionInfoUtils","../../support/projectionUtils"],function(t,e,i,r,o,n,a,s,h,c,p,u,l,y,f){function d(t,e){for(var i=new Array(t),r=0;r<i.length;r++)i[r]=new Array(e);return i}var g=new a(Array,function(t){return c.set(t,c.ZERO)},null,10,5),b=p.create();return function(){function t(t,e,i,r){this._labelGraphics=[],this._auxiliaryGraphics=[],this._visibilityFlags=d(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this.extent=null,this.isElevationSource=!1,++e.referenced,this.graphics3DSymbol=e,this.graphic=t,this._graphics=i,this._featureExpressionFeature=y.createFeature(t,r);for(var o=0,a=this._graphics;o<a.length;o++){var s=a[o];n.isSome(s)&&(this.isElevationSource=this.isElevationSource||s.isElevationSource)}}return t.prototype.initialize=function(t,e){var i=this;this._layer=t,this._stage=e,this.forEachSymbolLayerGraphic(function(r){r.initialize(t,e),r.setVisibility(i.isVisible())})},t.prototype.destroy=function(){this.forEachSymbolLayerGraphic(function(t){return t.destroy()}),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},Object.defineProperty(t.prototype,"destroyed",{get:function(){return null==this._graphics},enumerable:!0,configurable:!0}),t.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic(function(t){return t.destroy()}),this._labelGraphics.length=0},t.prototype.addLabelGraphic=function(t,e,i){this._labelGraphics.push(t),t.initialize(e,i),t.setVisibility(this.isVisible(1))},t.prototype.addAuxiliaryGraphic=function(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._layer,this._stage),t.setVisibility(this.isVisible()))},t.prototype.isDraped=function(){var t=!1;return this.forEachSymbolLayerGraphic(function(e){"draped"===e.type&&(t=!0)}),t},t.prototype.isVisible=function(t,e){void 0===t&&(t=0);for(var i=0;i<=t;i++)for(var r=this._visibilityFlags[i],o=0;o<r.length;++o)if(!1===r[o]&&o!==e)return!1;return!0},t.prototype.hasVisibilityFlag=function(t,e){return null!=this._visibilityFlags[e][t]},t.prototype.setVisibilityFlag=function(t,e,i){var r=this.isVisible(i);this._visibilityFlags[i][t]=e;var o=this.isVisible(i);if(r===o)return!1;if(1===i)this.forEachLabelGraphic(function(t){return t.setVisibility(o)});else{this.forEachSymbolLayerGraphic(function(t){return t.setVisibility(o)});var n=this.isVisible(1);this.forEachLabelGraphic(function(t){return t.setVisibility(n)})}return!0},t.prototype.clearVisibilityFlag=function(t,e){return void 0===e&&(e=0),this.setVisibilityFlag(t,void 0,e)},t.prototype.getBSRadius=function(){var t=0;return this.forEachSymbolLayerGraphic(function(e){t=Math.max(t,e.getBSRadius())}),t},t.prototype.getCenterObjectSpace=function(t){void 0===t&&(t=s.vec3f64.create());var e=this._graphics[0];return n.isSome(e)?e.getCenterObjectSpace(t):t},t.prototype.computeExtent=function(t){if(!this.extent){this.extent=p.create();var e=this.graphic.geometry;if(n.isNone(e))return this.extent=null,!1;var i=e.spatialReference;if(u.computeAABR(e,this.extent),!i.equals(t)&&!f.boundingRectToBoundingRect(this.extent,i,this.extent,t))return this.extent=null,!1}return!0},t.prototype.getAsOptimizedGeometry=function(t,e){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===t&&this._optimizedGeometry.hasM===e?this._optimizedGeometry.geometry:(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,t,e),this._optimizedGeometry.hasZ=t,this._optimizedGeometry.hasM=e,this._optimizedGeometry.geometry)},t.prototype._convertGraphicToOptimizedGeometry=function(t,e,i){var r=t.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=h.fromExtent("mesh"===r.type?r.extent:r)),l.convertFromGeometry(r,e,i)},Object.defineProperty(t.prototype,"usedMemory",{get:function(){var t=this,e=u.estimateAttributesObjectSize(this.graphic.attributes);return this.forEachSymbolLayerGraphic(function(i){var r=i.graphics3DSymbolLayer.complexity,o="draped"===i.type?r.memory.draped:r.memory;e+=o.bytesPerFeature,o.bytesPerCoordinate&&(e+=u.numVertices(t.graphic.geometry)*o.bytesPerCoordinate)}),e},enumerable:!0,configurable:!0}),t.prototype.getProjectedBoundingBox=function(t,e,a,s,h){return r(this,void 0,void 0,function(){var u=this;return i(this,function(l){switch(l.label){case 0:return h||(h={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),h.boundingBox?c.empty(h.boundingBox):h.boundingBox=c.empty(),h.requiresDrapedElevation=!1,[4,o.forEach(this._graphics,function(o){return r(u,void 0,void 0,function(){var r,p,u;return i(this,function(i){switch(i.label){case 0:return n.isNone(o)?[2]:(r="draped"===o.type?e:t,p=g.acquire(),[4,o.getProjectedBoundingBox(r,a,h.screenSpaceObjects,s,p)]);case 1:return u=i.sent(),isFinite(u[2])&&isFinite(u[5])||(h.requiresDrapedElevation=!0),u&&c.expand(h.boundingBox,p),g.release(p),[2]}})})})];case 1:return l.sent(),c.allFinite(h.boundingBox)||p.allFinite(c.toRect(h.boundingBox,b))?[2,h]:[2,null]}})})},t.prototype.needsElevationUpdates=function(){for(var t=0,e=this._graphics;t<e.length;t++){var i=e[t];if(n.isSome(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0}for(var r=0,o=this._labelGraphics;r<o.length;r++){var i=o[r];if(i&&i.needsElevationUpdates)return!0}return!1},t.prototype.alignWithElevation=function(t,e,i){var r=this;this.forEachRenderedGraphic(function(o){"object3d"!==o.type&&"lod-instance"!==o.type||o.alignWithElevation(t,e,r._featureExpressionFeature,i)})},t.prototype.addHighlight=function(t,e){this.forEachSymbolLayerGraphic(function(i){return i.addHighlight(t,e)})},t.prototype.removeHighlight=function(t){this.forEachSymbolLayerGraphic(function(e){return e.removeHighlight(t)})},t.prototype.forEachGraphicList=function(t,e){t.forEach(function(t,i){return t&&e(t,i)})},t.prototype.forEachSymbolLayerGraphic=function(t){this.forEachGraphicList(this._graphics,t),this.forEachGraphicList(this._auxiliaryGraphics,t)},t.prototype.forEachLabelGraphic=function(t){this.forEachGraphicList(this._labelGraphics,t)},t.prototype.forEachRenderedGraphic=function(t){this.forEachSymbolLayerGraphic(t),this.forEachLabelGraphic(t)},t}()});