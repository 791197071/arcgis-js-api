// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/mathUtils","../../../../core/maybe","../../../../core/string","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../glTF/DefaultLoadingContext","../../glTF/esriProvidedModelParameters","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../support/buffer/BufferView","../../support/buffer/math","../../support/buffer/utils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,o,i,s,a,u,n,l,c,f,d,m,p,x,g,v,h,b,w,B,M,T,S,V){function y(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,function(){var r,i,a,u,n,l,c,f,d,m;return o(this,function(o){switch(o.label){case 0:return r=R(e),"wosr"!==r.fileType?[3,2]:[4,h.load(r.url,t)];case 1:return i=o.sent(),[2,{lods:[i],referenceBoundingBox:i.boundingBox}];case 2:return a=new p.DefaultLoadingContext(t.streamDataRequester),[4,g.load(a,r.url,t)];case 3:return u=o.sent(),(A(u),I(u),n=s({},t.materialParamsMixin,{treeRendering:u.customMeta.esriTreeRendering}),null!=r.specifiedLodIndex)?(l=C(u,n,r.specifiedLodIndex),c=l[0].boundingBox,0!==r.specifiedLodIndex&&(f=C(u,n,r.specifiedLodIndex),c=f[0].boundingBox),[2,{lods:l,referenceBoundingBox:c}]):(d=C(u,n),m=d[0].boundingBox,[2,{lods:d,referenceBoundingBox:m}])}})})}function R(e){var t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function C(e,t,r){var o=e.model,i=c.mat4f64.create(),a=new Array,n=new Map,f=new Map;return o.lods.forEach(function(c,d){if(void 0===r||d===r){var p=0,x={stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:u.isSome(c.lodThreshold)?c.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:m.empty()};a.push(x),c.parts.forEach(function(r){var a=r.material+(r.attributes.normal?"_normal":"")+(r.attributes.color?"_color":"")+(r.attributes.texCoord0?"_texCoord0":"")+(r.attributes.tangent?"_tangent":""),d=o.materials.get(r.material),g=u.isSome(r.attributes.texCoord0),v=u.isSome(r.attributes.normal);if(!n.has(a)){if(g){if(u.isSome(d.textureColor)&&!f.has(d.textureColor)){var h=o.textures.get(d.textureColor),y=s({},h.parameters,{preMultiplyAlpha:!0});f.set(d.textureColor,new S(h.data,d.textureColor,y))}if(u.isSome(d.textureNormal)&&!f.has(d.textureNormal)){var h=o.textures.get(d.textureNormal),y=s({},h.parameters,{preMultiplyAlpha:!0});f.set(d.textureNormal,new S(h.data,d.textureNormal,y))}if(u.isSome(d.textureOcclusion)&&!f.has(d.textureOcclusion)){var h=o.textures.get(d.textureOcclusion),y=s({},h.parameters,{preMultiplyAlpha:!0});f.set(d.textureOcclusion,new S(h.data,d.textureOcclusion,y))}if(u.isSome(d.textureEmissive)&&!f.has(d.textureEmissive)){var h=o.textures.get(d.textureEmissive),y=s({},h.parameters,{preMultiplyAlpha:!0});f.set(d.textureEmissive,new S(h.data,d.textureEmissive,y))}if(u.isSome(d.textureMetallicRoughness)&&!f.has(d.textureMetallicRoughness)){var h=o.textures.get(d.textureMetallicRoughness),y=s({},h.parameters,{preMultiplyAlpha:!0});f.set(d.textureMetallicRoughness,new S(h.data,d.textureMetallicRoughness,y))}}var R=V.COLOR_GAMMA,C=Math.pow(d.color[0],1/R),L=Math.pow(d.color[1],1/R),A=Math.pow(d.color[2],1/R),I=Math.pow(d.emissiveFactor[0],1/R),F=Math.pow(d.emissiveFactor[1],1/R),N=Math.pow(d.emissiveFactor[2],1/R);n.set(a,new V(s({transparent:"BLEND"===d.alphaMode,textureAlphaMode:E(d.alphaMode),textureAlphaCutoff:d.alphaCutoff,diffuse:[C,L,A],ambient:[C,L,A],opacity:d.opacity,doubleSided:d.doubleSided,doubleSidedType:"winding-order",vertexColors:!!r.attributes.color,vertexTangents:!!r.attributes.tangent,normals:v?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:u.isSome(d.textureColor)&&g?f.get(d.textureColor).id:void 0,colorMixMode:d.colorMixMode,normalTextureId:u.isSome(d.textureNormal)&&g?f.get(d.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:u.isSome(d.textureOcclusion)&&g?f.get(d.textureOcclusion).id:void 0,emissiveTextureId:u.isSome(d.textureEmissive)&&g?f.get(d.textureEmissive).id:void 0,metallicRoughnessTextureId:u.isSome(d.textureMetallicRoughness)&&g?f.get(d.textureMetallicRoughness).id:void 0,emissiveFactor:[I,F,N],metallicFactor:d.metallicFactor,roughnessFactor:d.roughnessFactor,usePBR:!e.meta.isEsriSymbolResource},t),a))}var _=O(r.indices||r.attributes.position.count,r.primitiveType),D={},P={},z=r.attributes.position.count,U=B.createBuffer(b.BufferViewVec3f,z);if(w.vec3.transformMat4(U,r.attributes.position,r.transform),P.position={data:U.typedBuffer,size:U.elementCount},D.position=_,u.isSome(r.attributes.normal)){var H=B.createBuffer(b.BufferViewVec3f,z);l.mat4.invert(i,r.transform),l.mat4.transpose(i,i),w.vec3.transformMat4(H,r.attributes.normal,i),P.normal={data:H.typedBuffer,size:H.elementCount},D.normal=_}if(u.isSome(r.attributes.tangent)){var j=B.createBuffer(b.BufferViewVec4f,z);l.mat4.invert(i,r.transform),l.mat4.transpose(i,i),w.vec4.transformMat4(j,r.attributes.tangent,i),P.aTangent={data:j.typedBuffer,size:j.elementCount},D.aTangent=_}if(u.isSome(r.attributes.texCoord0)){var q=B.createBuffer(b.BufferViewVec2f,z);B.vec2.normalizeIntegerBuffer(q,r.attributes.texCoord0),P.uv0={data:q.typedBuffer,size:q.elementCount},D.uv0=_}if(u.isSome(r.attributes.color)){var G=B.createBuffer(b.BufferViewVec4u8,z);if(4===r.attributes.color.elementCount)r.attributes.color instanceof b.BufferViewVec4f?w.vec4.scale(G,r.attributes.color,255):r.attributes.color instanceof b.BufferViewVec4u8?B.vec4.copy(G,r.attributes.color):r.attributes.color instanceof b.BufferViewVec4u16&&w.vec4.scale(G,r.attributes.color,1/256);else{B.vec4.fill(G,255,255,255,255);var k=new b.BufferViewVec3u8(G.buffer,0,4);r.attributes.color instanceof b.BufferViewVec3f?w.vec3.scale(k,r.attributes.color,255):r.attributes.color instanceof b.BufferViewVec3u8?B.vec3.copy(k,r.attributes.color):r.attributes.color instanceof b.BufferViewVec3u16&&w.vec3.scale(k,r.attributes.color,1/256)}P.color={data:G.typedBuffer,size:G.elementCount},D.color=_}var $=new M(new T(P,D),"gltf_"+c.name+"_"+p++);x.stageResources.geometries.push($),x.stageResources.materials.push(n.get(a)),g&&(u.isSome(d.textureColor)&&x.stageResources.textures.push(f.get(d.textureColor)),u.isSome(d.textureNormal)&&x.stageResources.textures.push(f.get(d.textureNormal)),u.isSome(d.textureOcclusion)&&x.stageResources.textures.push(f.get(d.textureOcclusion)),u.isSome(d.textureEmissive)&&x.stageResources.textures.push(f.get(d.textureEmissive)),u.isSome(d.textureMetallicRoughness)&&x.stageResources.textures.push(f.get(d.textureMetallicRoughness))),x.numberOfVertices+=z;var K=$.boundingInfo;m.expand(x.boundingBox,K.getBBMin()),m.expand(x.boundingBox,K.getBBMax())})}}),a}function E(e){switch(e){case"BLEND":return"blend";case"MASK":return"mask";case"OPAQUE":return"opaque";default:return"blend"}}function O(e,t){switch(t){case 4:return v.trianglesToTriangles(e);case 5:return v.triangleStripToTriangles(e);case 6:return v.triangleFanToTriangles(e)}}function L(e,t){void 0===e&&(e=""),void 0===t&&(t="");var r=n.endsWith(e,"Imposter"),o=e.split("__")[0];if(-1!==t.indexOf("/RealisticTrees/")){var i=x.treeParamsTable[o];if(i)return{crownCenter:i.center,crownDimensions:i.radius,imposter:r}}}function A(e){if(e.meta.isEsriSymbolResource){var t=function(e,t){var r=e.attributes.normal,o=e.attributes.position,i=o.count;if(!u.isNone(r)){for(var s=d.vec3f64.create(),n=d.vec3f64.create(),m=d.vec3f64.create(),p=B.createBuffer(b.BufferViewVec4u8,i),x=B.createBuffer(b.BufferViewVec3f,i),g=l.mat4.invert(c.mat4f64.create(),e.transform),v=f.vec3.transformMat4(d.vec3f64.create(),t.crownCenter,g),h=f.vec3.transformMat4(d.vec3f64.create(),t.crownDimensions,g),w=0;w<i;w++){o.getVec(w,n),r.getVec(w,s),f.vec3.subtract(m,n,v),f.vec3.divide(m,m,h);var M=a.clamp(f.vec3.length(m),0,1),T=.6+.4*M*M;f.vec3.lerp(m,m,s,.2),x.setVec(w,m),p.set(w,0,255*T),p.set(w,1,255*T),p.set(w,2,255*T),p.set(w,3,255)}e.attributes.normal=x,e.attributes.color=p}};e.model.lods.forEach(function(r){var o=L(r.name,e.meta.uri);o&&(e.customMeta.esriTreeRendering=!0,r.parts.forEach(function(e){t(e,o)}))})}}function I(e){var t=e.model.lods.length;e.meta.isEsriSymbolResource&&e.model.lods.forEach(function(e){if(!u.isSome(e.lodThreshold)){var r=(e.name||"").replace("Imposter","Realistic_LOD0"),o=r.split("_LOD")[0],i=e.parts.reduce(function(e,t){return e+t.attributes.position.count},0);e.lodThreshold=F(o,i,t)}})}function F(e,t,r){if(void 0===e&&(e=""),1===r)return null;if(e in x.lodThresholdLUT){var o=x.lodThresholdLUT[e].vertexCounts,i=x.lodThresholdLUT[e].thresholds,s=o.length,a=t;if(s<=1)return null;if(a<=o[0]){var u=(o[1]-o[0])/(i[1]-i[0]),n=a-o[0];return Math.max(0,i[0]+n*u)}if(a>=o[s-1]){var u=(o[s-1]-o[s-2])/(i[s-1]-i[s-2]),n=a-o[s-1];return i[s-1]+n*u}for(var l=1;l<o.length;++l){var c=o[l-1],f=o[l],d=i[l-1],m=i[l];if(a<f){var p=(a-c)/(f-c);return d*(1-p)+m*p}}}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=y,t.parseUrl=R,t.gltfToEngineResources=C});