// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","./constants","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/RibbonLineMaterial"],function(e,t,a,r,i,n,o,l,s,u,c,p,d,h,y,m,g,_,f,v,x,E,b,O,D,G,P,M){Object.defineProperty(t,"__esModule",{value:!0});var T=function(e){function t(t,a,r,i){return e.call(this,t,a,r,i)||this}return a(t,e),t.prototype.doLoad=function(){return i(this,void 0,void 0,function(){return r(this,function(e){return this._prepareFillResources(),this._prepareOutlineResources(),[2]})})},t.prototype._prepareFillResources=function(){var e=o.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=new G({color:t,transparent:t[3]<1||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},this._getIdHint("_colormat")),this._context.stage.add(3,this._material)},t.prototype._prepareOutlineResources=function(){var e=this,t=this.symbolLayer.outline;if(this._hasOutline=!!(o.isSome(t)&&t.size&&t.size>0&&o.isSome(t.color)),this._hasOutline){this._outlineMaterial=function(t){return t>=1.5?new M({width:t,color:e._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:e._context.slicePlaneEnabled},e._getIdHint("_outline_ribbonlinemat")):new P({color:e._getOutlineColor(),slicePlaneEnabled:e._context.slicePlaneEnabled},e._getIdHint("_outline_nativelinemat"))}(l.pt2px(o.isSome(t)?t.size:0)),this._context.stage.add(3,this._outlineMaterial)}},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null),this._outlineMaterial&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var a=e.graphic;if(!this._validateGeometryType(a.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(a.geometry))return null;var r="graphic"+a.uid,i=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),n=this.getGraphicElevationContext(a);return"on-the-ground"===n.mode?this._createAsOverlay(a,i,n,r):this._createAs3DShape(a,i,n,r,a.uid)},t.prototype.layerOpacityChanged=function(){var e=this._material.getParameters().color,t=o.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(t);if(this._material.setParameterValues({color:[e[0],e[1],e[2],a],transparent:a<1||this._isPropertyDriven("opacity")}),this._outlineMaterial){var r=this._outlineMaterial.getParameters().color;this._outlineMaterial.setParameterValues({color:[r[0],r[1],r[2],this._getOutlineOpacity()]})}return!0},t.prototype.layerElevationInfoChanged=function(e,a,r){var i=this._elevationContext.mode,n=_.elevationModeChangeUpdateType(t.elevationModeChangeTypes,r,i);if(n!==_.SymbolUpdateType.UPDATE)return n;var o=_.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,a,function(){return o})},t.prototype.slicePlaneEnabledChanged=function(e,t){if(this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._outlineMaterial){var a={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(a)}return!0},t.prototype.physicalBasedRenderingChanged=function(e,t){return!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype.setDrawOrder=function(e,t,a){this.updateSymbolLayerOrder(e,t),this._material&&(this._material.renderPriority=e+t/2,a.add(this._material.id)),this._outlineMaterial&&(this._outlineMaterial.renderPriority=e,a.add(this._outlineMaterial.id))},t.prototype._createAs3DShape=function(e,t,a,r,i){var n=_.getGeometryAsPolygon(e.geometry),o=_.getGeometryVertexData3D(n.rings,n.hasZ,n.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,a);S.idHint=r,S.color=t,S.data=o;var l;if(this._hasOutline&&(l=new Float64Array(o.vertexData)),S.outNum=0,S.outGeometries=[],S.outTransforms=[],S.outMaterials=[],this._createAs3DShapeFill(S),S.data.vertexData=l,this._createAs3DShapeOutline(S),this._logGeometryCreationWarnings(S.data,n.rings,"rings","FillSymbol3DLayer"),0===S.outNum)return null;var s=new O({geometries:S.outGeometries,materials:S.outMaterials,transformations:S.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i},idHint:r}),u=y.perVertexElevationAligner,c=new g(this,s,S.outGeometries,null,null,u,a);return c.alignedTerrainElevation=o.terrainElevation,c.needsElevationUpdates=_.needsElevationUpdates2D(a.mode),c},t.prototype._createAs3DShapeFill=function(e){for(var t=e.data.geometryData.polygons,a=e.data.eleVertexData,r=e.data.vertexData,i=this,n=0;n<t.length;++n)!function(n){var o=t[n],l=o.count,p=o.index;if(i._context.clippingExtent&&(_.computeBoundingBox(a,p,l,C),_.boundingBoxClipped(C,i._context.clippingExtent)))return"continue";var d=new Float64Array(a.buffer,3*p*a.BYTES_PER_ELEMENT,3*l),h=o.holeIndices.map(function(e){return e-p}),y=s(d,h,3);if(0===y.length)return"continue";_.applyOrigin(r,p,l,A);var m=new Uint32Array(y),g=new Float64Array(r.buffer,3*p*r.BYTES_PER_ELEMENT,3*l),f=E.createPolygonGeometryData({indices:m,vertices:g,color:e.color,eleVertices:d}),v=new b(f,e.idHint);v.singleUse=!0;var x=c.mat4f64.create();u.mat4.translate(x,x,A),e.outGeometries.push(v),e.outMaterials.push(i._material),e.outTransforms.push(x),e.outNum++}(n)},t.prototype._createAs3DShapeOutline=function(e){if(this._hasOutline)for(var t=e.data.geometryData.outlines,a=e.data.eleVertexData,r=e.data.vertexData,i=0;i<t.length;++i){var n=t[i],o=n.index,l=n.count;if(!this._context.clippingExtent||(_.computeBoundingBox(a,o,l,C),!_.boundingBoxClipped(C,this._context.clippingExtent))){_.applyOrigin(r,o,l,A);var s=new Float64Array(a.buffer,3*o*a.BYTES_PER_ELEMENT,3*l),p=new Float64Array(r.buffer,3*o*r.BYTES_PER_ELEMENT,3*l),d=x.createPolylineGeometry(p,s,!1,h.WHITE,1),y=new b(d,e.idHint+"outline"+i);y.singleUse=!0;var m=c.mat4f64.create();u.mat4.translate(m,m,A),e.outGeometries.push(y),e.outMaterials.push(this._outlineMaterial),e.outTransforms.push(m),e.outNum++}}},t.prototype._createAsOverlay=function(e,t,a,r){var i=_.getGeometryAsPolygon(e.geometry);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2,this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);var n=_.getGeometryVertexDataDraped(i.rings,i.spatialReference,this._context.overlaySR);S.idHint=r,S.color=t,S.data=n;var o;return this._hasOutline&&(o=new Float64Array(n.vertexData)),S.outNum=0,S.outGeometries=[],S.outBoundingBox=d.empty(),S.layerUid=this._context.layer.uid,S.graphicsUid=e.uid,this._createAsOverlayFill(S),S.data.vertexData=o,this._createAsOverlayOutline(S),this._logGeometryCreationWarnings(S.data,i.rings,"rings","FillSymbol3DLayer"),S.outNum>0?new m(this,S.outGeometries,S.outBoundingBox):null},t.prototype._createAsOverlayFill=function(e){for(var t=e.data.vertexData,a=e.data.geometryData.polygons,r=this,i=0;i<a.length;++i)!function(i){var n=a[i],o=n.count,l=n.index;if(_.computeBoundingBox(t,l,o,C),_.boundingBoxClipped(C,r._context.clippingExtent))return"continue";var p=new Float64Array(t.buffer,3*l*t.BYTES_PER_ELEMENT,3*o),h=n.holeIndices.map(function(e){return e-l}),y=s(p,h,3);if(0===y.length)return"continue";d.expand(e.outBoundingBox,C),_.applyOrigin(t,l,o,A),_.setZ(t,l,o,r._getDrapedZ());for(var m=new Uint32Array(y.length),g=0;g<y.length;g++)m[g]=y[g]+l;var f=E.createPolygonGeometryData({indices:m,vertices:t,color:e.color}),v=new D(f);v.data.layerUid=e.layerUid,v.data.graphicUid=e.graphicsUid,v.material=r._material;var x=C;v.center=[.5*(x[0]+x[3]),.5*(x[1]+x[4]),0],v.bsRadius=.5*Math.sqrt((x[3]-x[0])*(x[3]-x[0])+(x[4]-x[1])*(x[4]-x[1]));var b=c.mat4f64.create();u.mat4.translate(b,b,A),v.transformation=b,v.name=e.idHint,v.uniqueName=e.idHint+"#"+f.id,e.outGeometries.push(v),e.outNum++}(i)},t.prototype._createAsOverlayOutline=function(e){if(this._hasOutline)for(var t=e.data.vertexData,a=e.data.geometryData.outlines,r=0;r<a.length;++r){var i=a[r],n=i.index,o=i.count;if(_.computeBoundingBox(t,n,o,C),!_.boundingBoxClipped(C,this._context.clippingExtent)){d.expand(e.outBoundingBox,C),_.applyOrigin(t,n,o,A),_.setZ(t,n,o,this._getDrapedZ());var l=new Float64Array(t.buffer,3*n*t.BYTES_PER_ELEMENT,3*o),s=x.createPolylineGeometry(l,null,!0,h.WHITE,1),p=new D(s);p.data.layerUid=e.layerUid,p.data.graphicUid=e.graphicsUid,p.material=this._outlineMaterial;var y=C;p.center=[.5*(y[0]+y[3]),.5*(y[1]+y[4]),0],p.bsRadius=.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]));var m=c.mat4f64.create();u.mat4.translate(m,m,A),p.transformation=m,p.name=e.idHint+"outline",p.uniqueName=e.idHint+"outline#"+s.id,e.outGeometries.push(p),e.outNum++}}},t.prototype._getOutlineOpacity=function(){var e=o.get(this.symbolLayer,"outline","color");return this._getLayerOpacity()*(o.isSome(e)?e.a:0)},t.prototype._getOutlineColor=function(){var e=o.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return v.mixinColorAndOpacity(o.isSome(e)?n.toUnitRGB(e):null,t)},t.validGeometryTypes=["polyline","polygon","extent"],t.elevationModeChangeTypes={definedChanged:_.SymbolUpdateType.RECREATE,staysOnTheGround:_.SymbolUpdateType.NONE,onTheGroundChanged:_.SymbolUpdateType.RECREATE},t}(f.default);t.Graphics3DPolygonFillSymbolLayer=T;var C=d.create(),A=p.vec3f64.create(),S={idHint:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null,color:null};t.default=T});