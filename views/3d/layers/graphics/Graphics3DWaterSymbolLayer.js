// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../core/maybe","../../../../core/unitUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Util","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],function(e,t,r,a,i,o,n,l,s,u,d,c,p,h,m,y,g,v,f,_,x,b,E,w,D,M,G,S,P,C,T,A,O){Object.defineProperty(t,"__esModule",{value:!0});var L=function(e){function t(t,r,a,i){return e.call(this,t,r,a,i)||this}return a(t,e),t.prototype.doLoad=function(){return o(this,void 0,void 0,function(){var e,t;return i(this,function(a){return e=O.waterParameterDefaultsLocal,t=r({},e),this._updateMaterialParameters(t),t.isDraped=!0,this._drapedMaterial=new A.WaterMaterial(t,"waterDraped"),this._context.stage.add(M.ModelContentType.MATERIAL,this._drapedMaterial),this._updateMaterialParameters(e),this._material=new A.WaterMaterial(e,"water"),this._context.stage.add(M.ModelContentType.MATERIAL,this._material),[2]})})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(M.ModelContentType.MATERIAL,this._material.id),this._material=null),this._drapedMaterial&&(this._context.stage.remove(M.ModelContentType.MATERIAL,this._drapedMaterial.id),this._drapedMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic,r=t.geometry.type;if("polyline"!==r&&"polygon"!==r&&"extent"!==r)return this.logger.warn("unsupported geometry type for water symbol: "+r),null;if(!this._validateGeometry(t.geometry))return null;var a="graphic"+t.uid,i=this.getGraphicElevationContext(t);return"on-the-ground"===i.mode?this._createAsOverlay(t,a):this._createAs3DShape(t,i,a,t.uid)},t.prototype.layerOpacityChanged=function(){var e=this._material.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});return this._material.color=[e[0],e[1],e[2],t],this._material.setTransparent(t<1||this._isPropertyDriven("opacity")),this._drapedMaterial.color=[e[0],e[1],e[2],t],this._drapedMaterial.setTransparent(t<1||this._isPropertyDriven("opacity")),!0},t.prototype.layerElevationInfoChanged=function(e,t,r){var a=this._elevationContext.mode;if(null==r||null==a)return!1;if("on-the-ground"===r&&"on-the-ground"===a)return!0;if(r!==a&&("on-the-ground"===r||"on-the-ground"===a))return!1;var i=w.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,t,function(){return i})},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._drapedMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype.setDrawOrder=function(e,t,r){this.updateSymbolLayerOrder(e,t),this._material&&(this._material.renderPriority=e+t/2,r.add(this._material.id)),this._drapedMaterial&&(this._drapedMaterial.renderPriority=e+t/2,r.add(this._drapedMaterial.id))},t.prototype._createAs3DShape=function(e,t,r,a){var i=this._getPolyGeometry(e),o=i.rings,n=this._getOutlineGeometry(o),l=w.getGeometryVertexData3D(n,i.hasZ,i.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,t),s=l.vertexData.length/3;if(l.uvCoords=new Float64Array(2*s),I.idHint=r,I.data=l,I.outNum=0,I.outGeometries=[],I.outTransforms=[],I.outMaterials=[],this._create3DShapeGeometries(I),0===I.outNum)return null;this._createUVCoordsFromVertices(I.data.uvCoords,I.data.eleVertexData,s,this._context.elevationProvider.spatialReference);var u=new P({geometries:I.outGeometries,materials:I.outMaterials,transformations:I.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:r}),d=x.perVertexElevationAligner,c=new E(this,u,I.outGeometries,null,null,d,t);return c.alignedTerrainElevation=l.terrainElevation,c.needsElevationUpdates=w.needsElevationUpdates2D(t.mode),c},t.prototype._createUVCoordsFromVertices=function(e,r,a,i){var o=s.getMetersPerUnitForSR(i);_.empty(V);for(var n=0;n<a;n++)p.vec2.set(B,r[3*n+0],r[3*n+1]),_.expandPointInPlace(V,B);y.vec4.scale(V,V,o);var l=V[0]%t.unitSizeOfTexture,u=V[1]%t.unitSizeOfTexture;R[0]=V[0]-l,R[1]=V[1]-u;for(var n=0;n<a;n++)e[2*n+0]=(r[3*n+0]*o-R[0])/t.unitSizeOfTexture,e[2*n+1]=(r[3*n+1]*o-R[1])/t.unitSizeOfTexture},t.prototype._create3DShapeGeometries=function(e){for(var t=e.data.geometryData.polygons,r=e.data.eleVertexData,a=e.data.vertexData,i=e.data.uvCoords,o=this,n=0;n<t.length;++n)!function(n){var l=t[n],s=l.count,p=l.index;if(o._context.clippingExtent&&(w.computeBoundingBox(r,p,s,U),w.boundingBoxClipped(U,o._context.clippingExtent)))return"continue";var h=new Float64Array(r.buffer,3*p*r.BYTES_PER_ELEMENT,3*s),m=new Float64Array(a.buffer,3*p*a.BYTES_PER_ELEMENT,3*s),y=new Float64Array(i.buffer,2*p*i.BYTES_PER_ELEMENT,2*s),g=l.holeIndices.map(function(e){return e-p}),v=u(h,g,3);if(0===v.length)return"continue";w.applyOrigin(a,p,s,N);var f=o._createWaterGeometry(v,m,y,h),_=new G(f,e.idHint);_.singleUse=!0;var x=c.mat4f64.create();d.mat4.translate(x,x,N),e.outGeometries.push(_),e.outMaterials.push(o._material),e.outTransforms.push(x),e.outNum++}(n)},t.prototype._createWaterGeometry=function(e,t,r,a){for(var i=e.length,o=new Uint32Array(i),n=0;n<i;n++)o[n]=e[n];var l={},s={};return l[T.VertexAttrConstants.POSITION]=o,l[T.VertexAttrConstants.UV0]=o,s[T.VertexAttrConstants.POSITION]={size:3,data:t},s[T.VertexAttrConstants.UV0]={size:2,data:r},a&&(s.mapPos={size:3,data:a},l.mapPos=o),new S(s,l)},t.prototype._updateMaterialParameters=function(e){var r=this.symbolLayer.color;l.isSome(r)&&(e.color=n.toUnitRGBA(r));var a=this._getCombinedOpacity(r,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],a],e.transparent=a<1||this._isPropertyDriven("opacity"),e.waveDirection=l.isSome(this.symbolLayer.waveDirection)?t.headingVectorFromAngle(this.symbolLayer.waveDirection):h.vec2f64.fromValues(0,0);var i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,o=O.wavePresets[i];e.waveStrength=o.waveStrength,e.waveTextureRepeat=o.textureRepeat,e.waveVelocity=o.waveVelocity,e.flowStrength=o.perturbationStrength},t.prototype._createAsOverlay=function(e,t){var r=this._getPolyGeometry(e),a=r.rings,i=this._getOutlineGeometry(a);this._drapedMaterial.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;var o=w.getGeometryVertexDataDraped(i,r.spatialReference,this._context.overlaySR);I.idHint=t,I.data=o;var n=o.vertexData.length/3;return o.uvCoords=new Float64Array(2*n),I.outNum=0,I.outGeometries=[],I.outBoundingBox=f.empty(),I.layerUid=this._context.layer.uid,I.graphicsUid=e.uid,this._createAsOverlayWater(I),0===I.outNum?null:(this._createUVCoordsFromVertices(I.data.uvCoords,I.data.vertexData,n,r.spatialReference),this._logGeometryCreationWarnings(I.data,a,"rings","WaterSymbol3DLayer"),I.outNum>0?new b(this,I.outGeometries,I.outBoundingBox):null)},t.prototype._createAsOverlayWater=function(e){for(var t=e.data.vertexData,r=e.data.uvCoords,a=e.data.geometryData.polygons,i=this,o=0,n=a;o<n.length;o++){var l=n[o];!function(a){var o=a.count,n=a.index,l=new Float64Array(t.buffer,3*n*t.BYTES_PER_ELEMENT,3*o),s=new Float64Array(r.buffer,2*n*r.BYTES_PER_ELEMENT,2*o),p=a.holeIndices.map(function(e){return e-n}),h=u(l,p,3);if(0===h.length)return"continue";if(w.computeBoundingBox(t,n,o,U),w.boundingBoxClipped(U,i._context.clippingExtent))return"continue";f.expand(e.outBoundingBox,U),w.applyOrigin(t,n,o,N),w.setZ(t,n,o,i._getDrapedZ());var m=c.mat4f64.create();d.mat4.translate(m,m,N);var y=i._createWaterGeometry(h,l,s,null),g=new C(y);g.data.layerUid=e.layerUid,g.data.graphicUid=e.graphicsUid,g.material=i._drapedMaterial;var v=U;g.center=[.5*(v[0]+v[3]),.5*(v[1]+v[4]),0],g.bsRadius=.5*Math.sqrt((v[3]-v[0])*(v[3]-v[0])+(v[4]-v[1])*(v[4]-v[1])),g.transformation=m,g.name=e.idHint,g.uniqueName=e.idHint+"#"+y.id,e.outGeometries.push(g),e.outNum++}(l)}},t.prototype._getOutlineGeometry=function(e){return e},t.prototype._getPolyGeometry=function(e){var t=e.geometry;return"extent"===t.type?v.fromExtent(t):t},t.headingVectorFromAngle=function(e){var t=h.vec2f64.create(),r=g.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},t.unitSizeOfTexture=100,t}(D.default);t.Graphics3DWaterSymbolLayer=L;var R=h.vec2f64.create(),V=_.create(),B=h.vec2f64.create(),U=f.create(),N=m.vec3f64.create(),I={idHint:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};t.default=L});