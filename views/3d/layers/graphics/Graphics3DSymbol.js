// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayerFactory","./Loadable","./symbolComplexity"],function(e,r,t,s,o,a,n,i,y,l,c,h,u){return function(e){function r(r,t,s){var o=e.call(this)||this;return o._symbol=r,o._context=t,o._backgroundLayers=s,o._destroyed=!1,o.symbolLayers=[],o.referenced=0,o}return t(r,e),Object.defineProperty(r.prototype,"symbol",{get:function(){return this._symbol},set:function(e){if(this._symbol=e,this.symbolLayers)for(var r=0;r<e.symbolLayers.length;r++){var t=this.symbolLayers[r];n.isNone(t)||(t.symbol=e,t.symbolLayer=e.symbolLayers.items[r])}},enumerable:!0,configurable:!0}),r.prototype.doLoad=function(e){return o(this,void 0,void 0,function(){var r,t,y,l,h,u,p=this;return s(this,function(f){switch(f.label){case 0:for(r=this._symbol.symbolLayers,this._backgroundLayers&&(r=this._backgroundLayers.concat(r)),t=r.length,this.symbolLayers.length=r.length,y=this._context.layerOrder,l=function(s){var o=r.getItemAt(s);if(!1===o.enabled)return"continue";h._context.layerOrder=y+(1-(1+s)/t),h._context.layerOrderDelta=1/t;var a=c.make(h.symbol,o,h._context,o._ignoreDrivers);i.onAbortOrThrow(e,function(){return a.destroy()}),h.symbolLayers[s]=a},h=this,u=0;u<t;u++)l(u);return this._context.layerOrder=y,[4,a.forEach(this.symbolLayers,function(e,r){return o(p,void 0,void 0,function(){var t;return s(this,function(s){switch(s.label){case 0:if(!n.isSome(e))return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,e.load()];case 2:return s.sent(),[3,4];case 3:return t=s.sent(),this.symbolLayers[r]=null,[3,4];case 4:return[2]}})})})];case 1:if(f.sent(),this.symbolLayers.length&&!this.symbolLayers.some(function(e){return!!e}))throw new Error;return[2]}})})},r.prototype.whenSymbolLayerSize=function(e){return o(this,void 0,void 0,function(){var r,t;return s(this,function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),[4,this.load()];case 1:return s.sent(),[3,3];case 2:return r=s.sent(),[3,3];case 3:return t=this.symbolLayers[e],[2,n.isSome(t)?t.getCachedSize():null]}})})},r.prototype.createGraphics3DGraphic=function(e,r){for(var t=e.graphic,s=new Array(this.symbolLayers.length),o=0;o<this.symbolLayers.length;o++){var a=this.symbolLayers[o];n.isSome(a)&&(s[o]=a.createGraphics3DGraphic(e))}return new y(t,r||this,s,e.layer)},Object.defineProperty(r.prototype,"complexity",{get:function(){return u.totalSymbolComplexities(this.symbolLayers.map(function(e){return n.isSome(e)&&e.complexity}))},enumerable:!0,configurable:!0}),r.prototype.globalPropertyChanged=function(e,r){for(var t=this.symbolLayers.length,s=this,o=0;o<t;o++){var a=function(t){var o=s.symbolLayers[t],a=function(e){var r=e._graphics[t];return r instanceof l?r:null};if(n.isSome(o)&&!o.globalPropertyChanged(e,r,a))return{value:!1}}(o);if("object"==typeof a)return a.value}return!0},r.prototype.applyRendererDiff=function(e,r){return 1===this.loadStatus&&this.symbolLayers.reduce(function(t,s,o){return t&&(n.isNone(s)||s.applyRendererDiff(e,r))},!0)},r.prototype.prepareSymbolPatch=function(e){if(2!==this.loadStatus&&"partial"===e.diff.type){var r=e.diff.diff;if(r.symbolLayers&&"partial"===r.symbolLayers.type){var t=r.symbolLayers.diff;this.symbolLayers.forEach(function(r,s){var o;if(!n.isNone(r)){var a=t[s];if(a){var i={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(i),(o=e.symbolStatePatches).push.apply(o,i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(function(e,r){var t=e._graphics[s];i.graphics3DGraphicPatches.forEach(function(e){return e(t,r)})})}}})}}},r.prototype.updateGeometry=function(e,r){for(var t=0;t<this.symbolLayers.length;t++){var s=this.symbolLayers[t];if(!n.isNone(s)&&!s.updateGeometry(e._graphics[t],r))return!1}return!0},r.prototype.getFastUpdateStatus=function(){var e=0,r=0,t=0;return this.symbolLayers.forEach(function(s){n.isNone(s)||(0===s.loadStatus?e++:s.isFastUpdatesEnabled()?t++:r++)}),{loading:e,slow:r,fast:t}},r.prototype.setDrawOrder=function(e,r){for(var t=this.symbolLayers.length,s=1/t,o=0;o<t;o++){var a=this.symbolLayers[o];if(n.isSome(a)){var i=e+(1-(1+o)/t);a.setDrawOrder(i,s,r)}}},r.prototype.destroy=function(){if(this.destroyed)return void console.error("Graphics3DSymbol.destroy called when already destroyed!");this.abortLoad();for(var e=0,r=this.symbolLayers;e<r.length;e++){var t=r[e];n.isSome(t)&&t.destroy()}this.symbolLayers.length=0,this._destroyed=!0},Object.defineProperty(r.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!0,configurable:!0}),r}(h.Loadable)});