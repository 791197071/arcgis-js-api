// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/PooledArray","../../../../core/accessorSupport/decorators","../../../../geometry/support/aaBoundingRect"],function(e,t,i,r,n,s,a,o,h,p){var d=function(){function e(){this.extents=new o({allocator:function(e){return e||p.create()}}),this.tempExtent=p.create(),this.dirty=!1}return Object.defineProperty(e.prototype,"length",{get:function(){return this.extents.length},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this.extents.clear()},e.prototype.add=function(e){this.contains(e)||(this.removeContained(e),p.set(this.extents.pushNew(),e),this.dirty=!0)},e.prototype.pop=function(){return this.dirty&&(this.mergeTight(),this.dirty=!1),this.extents.pop()},e.prototype.mergeTight=function(){for(var e=this.extents,t=this.tempExtent,i=!1;!i;){i=!0;for(var r=0;r<e.length;++r)if(function(i){for(var r=e.data[i],n=p.area(r),s=!1,a=e.length-1;a>i;--a){var o=e.data[a],h=p.area(o);p.expand(r,o,t);var d=n+h;(p.area(t)-d)/d<.05&&(p.set(r,t),n=p.area(r),e.swapElements(a,e.length-1),e.pop(),s=!0)}return s}(r)){i=!1;break}}},e.prototype.contains=function(e){return this.extents.some(function(t){return p.contains(t,e)})},e.prototype.removeContained=function(e){for(var t=this.extents.length-1;t>=0;--t)p.contains(e,this.extents.data[t])&&this.extents.removeUnorderedIndex(t)},e}();return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.dirtyExtents=new d,t.globalDirty=!1,t.dirtyGraphicsQueue=new o({deallocator:null}),t.dirtyGraphicsSet=new Set,t.handles=new a,t.updateElevation=!1,t.layerView=null,t.graphicsCore=null,t.events=new s,t}return i(t,e),Object.defineProperty(t.prototype,"updating",{get:function(){return this.needsUpdate()},enumerable:!0,configurable:!0}),t.prototype.setup=function(e,t,i,r){var n=this;this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;var s=this.layerView.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",function(e){return n.elevationUpdateHandler(e)}),this.layerView.watch("suspended",function(){return n.suspendedChange()}),s.registerTask(12,function(e){return n.update(e)},function(){return n.needsUpdate()})])},t.prototype.destroy=function(){this.dirtyGraphicsQueue=null,this.dirtyGraphicsSet=null,this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null},t.prototype.clear=function(){this.dirtyGraphicsQueue.clear(),this.dirtyGraphicsSet.clear(),this.notifyChange("updating")},t.prototype.suspendedChange=function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))},t.prototype.elevationInfoChange=function(){this.globalDirty=!0,this.notifyChange("updating")},t.prototype.needsUpdate=function(){return this.dirtyGraphicsQueue.length>0||this.dirtyExtents.length>0||this.globalDirty},t.prototype.update=function(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress());this.needsUpdate()&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")},t.prototype._updateDirtyGraphics=function(e){for(var t=this.layerView.view,i=this.graphicsCore.stageLayer.id,r=this.layerView.labeling;this.dirtyGraphicsQueue.length>0&&!e.done;){for(var n=Math.min(this.dirtyGraphicsQueue.length,100);n--&&!e.done;){var s=this.dirtyGraphicsQueue.pop(),a=this.graphicsCore.getGraphics3DGraphicById(s);this.dirtyGraphicsSet.delete(s),a&&a.alignWithElevation(this.elevationProvider,t.renderCoordsHelper),e.madeProgress()}t._stage.processDirtyLayer(i),r&&r.processStageDirty()}},t.prototype._updateDirtyExtents=function(e){for(var t=this;this.dirtyExtents.length>0&&this.dirtyGraphicsQueue.length<100&&!e.done;){var i=this.dirtyExtents.pop();this.events.hasEventListener("invalidate-elevation")&&this.events.emit("invalidate-elevation",{extent:i,spatialReference:this.spatialReference}),this.queryGraphicUIDsInExtent(i,this.spatialReference,function(e){var i=t.graphicsCore.getGraphics3DGraphicById(e);!t.dirtyGraphicsSet.has(e)&&i&&i.needsElevationUpdates()&&(t.dirtyGraphicsQueue.push(e),t.dirtyGraphicsSet.add(e))}),e.madeProgress()}},t.prototype.markAllGraphicsElevationDirty=function(){var e=this;this.dirtyExtents.clear(),this.dirtyGraphicsQueue.clear(),this.graphicsCore.graphics3DGraphics.forEach(function(t,i){e.dirtyGraphicsQueue.push(i),e.dirtyGraphicsSet.add(i)})},t.prototype.elevationUpdateHandler=function(e){var t=e.extent;if(this.layerView.suspended){if(!this.updateElevation){var i=this.graphicsCore.computedExtent;i&&t[2]>i.xmin&&t[0]<i.xmax&&t[3]>i.ymin&&t[1]<i.ymax&&(this.updateElevation=!0)}}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.spatialReference=e.spatialReference,this.notifyChange("updating")},r([h.property({readOnly:!0})],t.prototype,"updating",null),t=r([h.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],t)}(h.declared(n))});