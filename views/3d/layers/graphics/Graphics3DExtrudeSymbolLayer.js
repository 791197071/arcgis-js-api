// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/maybe","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Polygon","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../support/projectionUtils","../../support/buffer/BufferView","../../support/buffer/math/vec3","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,a,n,i,o,s,l,c,p,u,d,h,f,g,y,v,m,b,_,E,x,S,w,A,C,L,O,P){function M(e,t,r,a,n,i,o,s,l,c,p,u,d,h){var f=r.length/3,g=0;p+=2*a.count,D(e,t,a.index,a.count,r,0,f,n,i,o,s,l,c,p,u,d,h),l+=2*a.count,p+=2*f,p-=2*a.count+2*f,z(n,i,s,o,g,a.pathLengths[0],a.count,l,c,p,u),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],g+=a.pathLengths[0];for(var y=1;y<a.pathLengths.length;++y)z(n,i,s,o,g,a.pathLengths[y],a.count,l,c,p,u),l+=4*a.pathLengths[y],p+=2*a.pathLengths[y],g+=a.pathLengths[y]}function D(e,t,r,a,n,i,o,s,l,c,p,u,h,f,g,y,v){d.vec3.copy(I,y);for(var m=g>0?1:-1,b=3*r,_=u,E=3*_,x=u+a,S=3*x,w=0;w<a;++w)v&&(I[0]=e[b+0],I[1]=e[b+1],I[2]=e[b+2],d.vec3.normalize(I,I)),s[E+0]=e[b+0],s[E+1]=e[b+1],s[E+2]=e[b+2],l[E+0]=t[b+0],l[E+1]=t[b+1],l[E+2]=t[b+2],c[E+0]=-m*I[0],c[E+1]=-m*I[1],c[E+2]=-m*I[2],p[_]=0,s[S+0]=e[b+0]+g*I[0],s[S+1]=e[b+1]+g*I[1],s[S+2]=e[b+2]+g*I[2],l[S+0]=t[b+0],l[S+1]=t[b+1],l[S+2]=t[b+2],c[S+0]=m*I[0],c[S+1]=m*I[1],c[S+2]=m*I[2],p[x]=g,E+=3,S+=3,b+=3,_+=1,x+=1;b=3*i,E=3*f,S=3*(f+o);E=3*(f+o),S=3*f;var A=j,C=B;g<0&&(A=B,C=j);for(var w=0;w<o;++w)h[E+0]=n[b+A[0]],h[E+1]=n[b+A[1]],h[E+2]=n[b+A[2]],h[S+0]=n[b+C[0]]+a,h[S+1]=n[b+C[1]]+a,h[S+2]=n[b+C[2]]+a,E+=3,S+=3,b+=3}function V(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function z(e,t,r,a,n,i,o,s,l,c,p){var u=n,d=n+1,h=n+o,f=n+o+1,g=s,y=s+1,v=s+2*i,m=s+2*i+1;p<0&&(u=n+o+1,f=n),c*=3;for(var b=0;b<i;++b)b===i-1&&(p>0?(d=n,f=n+o):(d=n,u=n+o)),T(e,u,d,h,H),V(e,t,a,r,H,g,u),V(e,t,a,r,H,y,d),V(e,t,a,r,H,v,h),V(e,t,a,r,H,m,f),l[c++]=g,l[c++]=v,l[c++]=m,l[c++]=g,l[c++]=m,l[c++]=y,u++,d++,h++,f++,g+=2,y+=2,v+=2,m+=2}function T(e,t,r,a,n){t*=3,r*=3,a*=3,d.vec3.set(Y,e[t++],e[t++],e[t++]),d.vec3.set(Z,e[r++],e[r++],e[r++]),d.vec3.set(k,e[a++],e[a++],e[a++]),d.vec3.subtract(q,Z,Y),d.vec3.subtract(W,k,Y),d.vec3.cross(n,W,q),d.vec3.normalize(n,n)}function R(e,t,r,a){U.spatialReference=r.spatialReference;for(var n=e.getGeometryRecords(),i=n.length,o="absolute-height"!==t.mode,s=0,l=e.objectTransformation,c=p.mat4.invert(u.mat4f64.create(),l),h=0;h<i;h++){var f=n[h].geometry;f.invalidateBoundingInfo();for(var g=f.data.getVertexAttr(),y=g[O.VertexAttrConstants.POSITION].data,m=g[O.VertexAttrConstants.SIZE].data,b=g.mapPos.data,_=y.length/3,E=0,x=0,S=!1,w=0,A=0;A<_;A++){U.x=b[x],U.y=b[x+1],U.z=b[x+2],J[0]=y[E],J[1]=y[E+1],J[2]=y[E+2];var C=v.computeElevation(r,U,t,a,o?F:null);o&&(w+=F.terrainElevation),d.vec3.set(G,y[E+0],y[E+1],y[E+2]),d.vec3.transformMat4(G,G,l),a.setAltitude(C+m[E/3],G),d.vec3.transformMat4(G,G,c),y[E]=G[0],y[E+1]=G[1],y[E+2]=G[2];var L=.01/a.unitInMeters;(Math.abs(J[0]-y[E])>L||Math.abs(J[1]-y[E+1])>L||Math.abs(J[2]-y[E+2])>L)&&(S=!0),x+=3,E+=3}S&&e.geometryVertexAttrsUpdated(h),s+=w/_}return s/i}Object.defineProperty(t,"__esModule",{value:!0});var G=h.vec3f64.create(),I=h.vec3f64.create(),j=[0,2,1],B=[0,1,2],U=g.makeDehydratedPoint(0,0,0,null),F={verticalDistanceToGround:0,terrainElevation:0},N=function(e){function t(t,r,a,n){var i=e.call(this,t,r,a,n)||this;return i._edgeStageObjects=new Set,i}return r(t,e),t.prototype.doLoad=function(){return n(this,void 0,void 0,function(){var e,t,r,n,s,l,c;return a(this,function(a){if(!this._isPropertyDriven("size")&&(e=b.validateSymbolLayerSize(this._getSymbolSize())))throw new i("graphics3dextrudesymbollayer:invalid-size",e);return t=this._getStageIdHint(),r=o.get(this.symbolLayer,"material","color"),n=this._getCombinedOpacityAndColor(r),s=h.vec3f64.fromArray(n),l=n[3],c={diffuse:s,ambient:s,opacity:l,transparent:l<1||this._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},this._material=new P(c,t+"_3dlinemat"),this._context.stage.add(w.ModelContentType.MATERIAL,this._material),[2]})})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&this._context.stage.remove(w.ModelContentType.MATERIAL,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,a=r.geometry;if("polygon"!==a.type&&"extent"!==a.type)return this.logger.warn("unsupported geometry type for extrude symbol: "+a.type),null;if(!this._validateGeometry(a))return null;var n="graphic"+r.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this.getGraphicElevationContext(r);return this._createAs3DShape(a,t,i,o,n,r.uid)},t.prototype.layerOpacityChanged=function(){var e=o.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),r=t<1||this._isPropertyDriven("opacity");if(this._material.setParameterValues({opacity:t,transparent:r}),this._edgeStageObjects.size>0){var a=this._context.stage.renderView.ensureEdgeView(),n=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){return a.updateAllComponentOpacities(e,[n])})}return!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;if(this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._edgeStageObjects.size>0){var a=this._context.stage.renderView.ensureEdgeView(),n=this._createEdgeMaterial(a);if(o.isSome(n)){var i=[n];this._edgeStageObjects.forEach(function(e){return a.updateAllComponentMaterials(e,i,{slicePlaneEnabled:r._context.slicePlaneEnabled},!1)})}}return!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?v.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbolLayer.size||1},t.prototype._createAs3DShape=function(e,t,r,a,n,i){var d=this,g="extent"===e.type?f.fromExtent(e):e,m=g.rings,_=[],w=[],C=[],O=new Array(6),P=this._context.renderSpatialReference===E.SphericalECEFSpatialReference,D=this._getExtrusionSize(t),V=h.vec3f64.create();P||this._context.renderCoordsHelper.worldUpAtPosition(null,V);var z=v.getGeometryVertexData3D(m,g.hasZ,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,a);if(this._logGeometryCreationWarnings(z,m,"rings","ExtrudeSymbol3DLayer"),0===m.length||!m.some(function(e){return e.length>0}))return null;var T=b.computeCentroid(g);if(o.isNone(T))return null;var G=u.mat4f64.create();E.computeLinearTransformation(g.spatialReference,[T.x,T.y,0],G,this._context.renderSpatialReference);var I=u.mat4f64.create();p.mat4.invert(I,G);var j=c.mat3f64.create();l.mat3.normalFromMat4(j,I);for(var B=z.geometryData.polygons,U=z.eleVertexData,F=z.vertexData,N=F.length/3,H=new Float64Array(3*N*6),Y=new Float64Array(3*N*6),Z=new Float64Array(3*N*6),k=new Float64Array(1*N*6),q=0,W=this,J=0;J<B.length;++J)!function(e){var t=B[e],a=t.count,i=t.index;if(W._context.clippingExtent&&(v.computeBoundingBox(U,i,a,O),v.boundingBoxClipped(O,W._context.clippingExtent)))return"continue";var o=new Float64Array(U.buffer,3*i*H.BYTES_PER_ELEMENT,3*a),l=t.holeIndices.map(function(e){return e-i}),c=s(o,l,3);if(0===c.length)return"continue";var p=3*a*2+2*c.length,d=new Uint32Array(p),h=6*a,f=3*H.BYTES_PER_ELEMENT,g=new x.BufferViewVec3f64(H.buffer,q*f,f,(q+h)*f),y=3*Y.BYTES_PER_ELEMENT,m=new x.BufferViewVec3f64(Y.buffer,q*y,y,(q+h)*y),b=new Float64Array(Z.buffer,3*q*Z.BYTES_PER_ELEMENT,3*h),E=new Float64Array(k.buffer,1*q*k.BYTES_PER_ELEMENT,1*h);M(F,U,c,t,g.typedBuffer,b,m.typedBuffer,E,0,d,0,D,V,P),S.transformMat4(g,g,I),S.transformMat3(m,m,j),q+=6*a;var L=W._createExtrudeGeometry(d,{positions:g.typedBuffer,elevation:b,normals:m.typedBuffer,heights:E},r),z=new A(L,n+"path"+e);z.singleUse=!0,_.push(z),w.push(W._material),C.push(u.mat4f64.create())}(J);if(0===_.length)return null;var K=new L({geometries:_,materials:w,transformations:C,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:i},idHint:n});K.objectTransformation=G;var Q=function(e){var t=d._context.stage.renderView.ensureEdgeView();t.removeObject(e),d._edgeStageObjects.delete(e);var r=d._createEdgeMaterial(t);o.isSome(r)&&(d._edgeStageObjects.add(e),t.addObject(e,[r],{slicePlaneEnabled:d._context.slicePlaneEnabled},!d._context.isAsync))};Q(K);var X=function(e,t,r,a){var n=R(e.stageObject,t,r,a);return Q(K),n},$=new y(this,K,_,null,null,X,a);return $.alignedTerrainElevation=z.terrainElevation,$.needsElevationUpdates=v.needsElevationUpdates3D(a.mode),$},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[O.VertexAttrConstants.POSITION]=n,s[O.VertexAttrConstants.NORMAL]=n,s[O.VertexAttrConstants.COLOR]=i,l[O.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[O.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[O.VertexAttrConstants.COLOR]={size:4,data:r},l[O.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new C(l,s)},t.prototype._createEdgeMaterial=function(e){var t={opacity:this._getLayerOpacity()};return _.createMaterial(e,this.symbolLayer,t)},t}(m.default);t.Graphics3DExtrudeSymbolLayer=N;var H=h.vec3f64.create(),Y=h.vec3f64.create(),Z=h.vec3f64.create(),k=h.vec3f64.create(),q=h.vec3f64.create(),W=h.vec3f64.create(),J=h.vec3f64.create();t.default=N});