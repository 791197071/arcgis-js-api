// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/lang","../../../../core/maybe","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/FastSymbolUpdates","../../support/mathUtils","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial"],function(e,t,r,a,i,o,s,n,l,c,p,h,d,u,v,f,m,y,g,b,_,x,S,w,D,P,C,E){function V(e,t,r,a,i,o,s,n){switch(t){case"world":for(var l=0,c=e.vertices;l<c.length;l++){var p=c[l];h.vec3.add(H,p.pos,e.offset),r.worldUpAtPosition(H,j),p.setFrameFromUpVector(j),p.computeRotationAxisAndAngleFromUpVector()}break;case"terrain":for(var d=0,u=e.vertices;d<u.length;d++){var p=u[d];R(p,e.offset,a,i,r,o,s,n,H),p.setFrameFromUpVector(H),p.computeRotationAxisAndAngleFromUpVector()}break;case"path":h.vec3.add(H,e.vertices[0].pos,e.offset),r.worldUpAtPosition(H,j),P.computeMinimumRotationTangentFrame(e,j);for(var v=0,f=e.vertices;v<f.length;v++){var p=f[v],m=_.sign(h.vec3.dot(p.frame.right,p.vRight));h.vec3.cross(p.rotationFrame.up,p.vRight,p.vLeft),h.vec3.scale(p.rotationFrame.up,p.rotationFrame.up,m),h.vec3.normalize(p.rotationFrame.up,p.rotationFrame.up);var y=h.vec3.dot(p.rotationFrame.up,p.frame.up),g=h.vec3.dot(p.rotationFrame.up,p.frame.right);h.vec3.scale(H,p.frame.up,-g),h.vec3.scale(O,p.frame.right,y),h.vec3.add(H,H,O),h.vec3.normalize(p.rotationFrame.right,H),h.vec3.negate(H,p.vLeft),p.rotationAngle=-m*(Math.PI-_.acos(h.vec3.dot(H,p.vRight)));var b=Math.PI-p.rotationAngle;p.maxStretchDistance=Math.abs(Math.min(p.vLeftLength,p.vRightLength)/Math.cos(.5*b))}}}function A(e,t,r){switch(e){case"symbolValue":return r;case"proportional":return t;default:return e}}function z(e,t,r,a){for(var i=0,o=0,s=e.vertices;o<s.length;o++){var n=s[o];M.x=n.posES[0],M.y=n.posES[1],M.z=n.posES[2];var l=m.computeElevation(r,M,t,a,Z);i+=Z.terrainElevation,h.vec3.add(j,n.pos,e.offset),a.setAltitude(l,j),h.vec3.subtract(n.pos,j,e.offset)}return e.updatePathVertexInformation(),i/e.vertices.length}function R(e,t,r,a,i,o,s,n,l){h.vec3.set(j,e.posGS[0]+n,e.posGS[1],e.posGS[2]),L(j,r,a,i,o,s,q),h.vec3.set(j,e.posGS[0],e.posGS[1]+n,e.posGS[2]),L(j,r,a,i,o,s,N),h.vec3.add(j,e.pos,t),h.vec3.subtract(I,q,j),h.vec3.normalize(I,I),h.vec3.subtract(B,N,j),h.vec3.normalize(B,B),h.vec3.cross(T,I,B),h.vec3.copy(l,T)}function L(e,t,r,a,i,o,s){x.bufferToBuffer(e,i,0,j,o,0,1),x.bufferToBuffer(j,o,0,s,a.spatialReference,0,1),M.x=j[0],M.y=j[1],M.z=j[2];var n=m.computeElevation(r,M,t,a,null);a.setAltitude(n,s)}function U(e,t,r,a){var i=e.stageObject,o=i.getGeometryRecords(),s=o.length,n=0;M.spatialReference=r.spatialReference;var l=r.spatialReference;F.spatialReference=a.spatialReference;for(var c=0;c<s;c++){var p=o[c],h=p.geometry,d=h.metadata,u=d.pathGeometry,v=u.builder.path,f=d.geometrySR;k.spatialReference=f,n+=z(v,t,r,a),"world"!==v.upVector&&V(v,d.upVectorAlignment,a,t,r,f,l,d.stencilWidth),u.onPathChanged(),h.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(c)}return n/s}Object.defineProperty(t,"__esModule",{value:!0});var G=function(e){function t(t,r,a,i){var o=e.call(this,t,r,a,i)||this;return o._intrinsicSize=p.vec2f64.fromValues(1,1),o.upVectorAlignment="path",o.stencilWidth=.1,o}return r(t,e),t.prototype.doLoad=function(){return o(this,void 0,void 0,function(){var e,t,r,a,o,p,h,d,v,f,m,y,_,x;return i(this,function(i){switch(e=l.isSome(this.symbolLayer.width)?this.symbolLayer.width:l.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,t=l.isSome(this.symbolLayer.height)?this.symbolLayer.height:e,this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=b.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},r=this.symbolLayer.anchor||"center",this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world"),a=this.symbolLayer.profile||"circle"){case"circle":default:this._profile=P.Profile.circle(W);break;case"quad":this._profile=P.Profile.rect()}switch(o=[0,0],"center"!==r&&(o={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(o[0],o[1])),p=this.symbolLayer.join||"simple"){case"round":this._extruder=new P.MiterExtruder(0,3);break;case"bevel":this._extruder=new P.MiterExtruder(0,1);break;case"miter":this._extruder=new P.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new P.SimpleExtruder}switch(h=this.symbolLayer.cap||"butt"){case"none":this._startCap=new P.NoCapBuilder,this._endCap=new P.NoCapBuilder;break;case"butt":default:this._startCap=new P.TriangulationCapBuilder(this._profile,0),this._endCap=new P.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new P.TriangulationCapBuilder(this._profile,-.5),this._endCap=new P.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":d="quad"===a,this._startCap=new P.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:d}),this._endCap=new P.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:d})}if(v=this._getStageIdHint(),f=l.get(this.symbolLayer,"material","color"),m=this._getCombinedOpacityAndColor(f),y=u.vec3f64.fromArray(m),_=m[3],x={diffuse:y,ambient:y,opacity:_,transparent:_<1||this._isPropertyDriven("opacity"),vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===h?"none":void 0},!this._isPropertyDriven("size")&&(c.vec2.set(this._intrinsicSize,e,t),!g.isValidSize(this._intrinsicSize[0])||!g.isValidSize(this._intrinsicSize[1])))throw new s("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||c.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(n.mixin(x,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new E(x,v+"_pathmat")):(x.vertexColors=this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),this._material=new C(x,v+"_pathmat")),this._context.stage.add(S.ModelContentType.MATERIAL,this._material),[2]})})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(S.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("polyline"!==t.geometry.type)return this.logger.warn("unsupported geometry type for path symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,a=this.getGraphicElevationContext(t),i=e.renderingInfo;return this._createAs3DShape(t,i,a,r,t.uid)},t.prototype.layerOpacityChanged=function(){var e=l.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),r=t<1||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:t,transparent:r}),!0},t.prototype.layerElevationInfoChanged=function(e,t,r){var a=this;return e.forEach(function(e){var r=t(e);if(r){var i=e.graphic,o=a.getGraphicElevationContext(i);r.needsElevationUpdates=m.needsElevationUpdates3D(o.mode),r.elevationContext.set(o)}}),!0},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.pixelRatioChanged=function(e,t){return!0},t.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!b.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.getVertexData=function(e){for(var t=0,r=e.paths,a=[],i=e.spatialReference,o=this._context.elevationProvider.spatialReference,s=this._context.renderSpatialReference,n=0,l=r;n<l.length;n++){var c=l[n];t+=c.length}for(var p=new Float64Array(3*t),h=new Float64Array(3*t),d=new Float64Array(3*t),u=0,v=0,f=r;v<f.length;v++){var c=f[v];a.push({index:u,numVertices:c.length});for(var y=0,g=c;y<g.length;y++){var b=g[y];p[u++]=b[0],p[u++]=b[1],p[u++]=e.hasZ?b[2]:0}}var _=!0;return i.equals(o)?m.copyVertices(p,0,h,0,t):_=m.reproject(p,0,i,h,0,o,t),o.equals(s)?m.copyVertices(h,0,d,0,t):m.reproject(h,0,o,d,0,s,t),{pathVertexDataInfos:a,vertexDataGS:p,vertexDataES:h,vertexDataRS:d,projectionSuccess:_,terrainElevation:0}},t.prototype._createAs3DShape=function(e,t,r,a,i){var o=e.geometry,s=[],n=[],l=[],c=o.spatialReference,p=this._context.elevationProvider.spatialReference,d=new Array(6),u=this._context.renderCoordsHelper;k.spatialReference=c,M.spatialReference=p;var v=this.getVertexData(o);if(!v.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(v.pathVertexDataInfos.length>0){for(var g=0;g<v.pathVertexDataInfos.length;++g){var b=v.pathVertexDataInfos[g],_=b.index,x=b.numVertices;if(x<2)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else if(!this._context.clippingExtent||(m.computeBoundingBox(v.vertexDataES,_,x,d),!m.boundingBoxClipped(d,this._context.clippingExtent))){for(var S=[],C=_;C<_+3*x;){var E=C++,z=C++,R=C++,L=new P.PathVertex;h.vec3.set(L.posGS,v.vertexDataGS[E],v.vertexDataGS[z],v.vertexDataGS[R]),h.vec3.set(L.posES,v.vertexDataES[E],v.vertexDataES[z],v.vertexDataES[R]),M.x=L.posES[0],M.y=L.posES[1],M.z=L.posES[2];var G=m.computeElevation(this._context.elevationProvider,M,r,u,null);h.vec3.set(j,v.vertexDataRS[E],v.vertexDataRS[z],v.vertexDataRS[R]),u.setAltitude(G,j),h.vec3.set(L.pos,j[0],j[1],j[2]),S.push(L)}var F=new P.Path(S);V(F,this.upVectorAlignment,this._context.renderCoordsHelper,r,this._context.elevationProvider,c,p,this.stencilWidth);var I=new P.Builder(F,this._profile,this._extruder,this._startCap,this._endCap),B=null;if(this._fastUpdates.enabled){var T=this._fastUpdates.visualVariables,H=T.size?y.getAttributeValue(T.size.field,e):0,O=T.color?y.getAttributeValue(T.color.field,e):0,q=T.opacity?y.getAttributeValue(T.opacity.field,e):0;B=new P.FastUpdatePathGeometry(I,H,O,q)}else{var N=[this._intrinsicSize[0],this._intrinsicSize[1]];this._isPropertyDriven("size")&&(N[0]*=A(t.size[0],t.size[2],this.symbolLayer.width),N[1]*=A(t.size[2],t.size[0],this.symbolLayer.height));var W=null;this._isPropertyDriven("color")&&(W=t.color),this._isPropertyDriven("opacity")&&null!=t.opacity&&(W=W?[W[0],W[1],W[2],t.opacity]:[1,1,1,t.opacity]);var Z=new P.StaticPathGeometry(I);Z.bakeVertexPositions(N),W&&Z.bakeVertexColors(W),Z.computeNormals(),B=Z}var J=B.createGeometryData(),K=new w(J,a+"path"+g),Q={pathGeometry:B,geometrySR:c,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};K.singleUse=!0,K.metadata=Q,s.push(K),n.push(this._material),l.push(B.xform)}}var X={layerUid:this._context.layer.uid,graphicUid:i};if(s.length>0){var Y=new D({geometries:s,materials:n,transformations:l,castShadow:!0,metadata:X,idHint:a}),$=U,ee=new f(this,Y,s,null,null,$,r);return ee.alignedTerrainElevation=v.terrainElevation,ee.needsElevationUpdates=m.needsElevationUpdates3D(r.mode),ee}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null},t}(y.Graphics3DSymbolLayer);t.Graphics3DPathSymbolLayer=G;var F=v.makeDehydratedPoint(0,0,0,null),M=v.makeDehydratedPoint(0,0,0,null),k=v.makeDehydratedPoint(0,0,0,null),I=u.vec3f64.create(),B=u.vec3f64.create(),T=u.vec3f64.create(),j=u.vec3f64.create(),H=d.vec3f32.create(),O=d.vec3f32.create(),q=u.vec3f64.create(),N=u.vec3f64.create(),W=10,Z={verticalDistanceToGround:0,terrainElevation:0};t.default=G});