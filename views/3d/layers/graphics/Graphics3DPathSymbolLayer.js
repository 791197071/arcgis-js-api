// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/lang","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat2","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/FastSymbolUpdates","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(e,t,r,a,i,o,s,n,l,c,h,p,d,u,m,v,f,y,g,_,b,S,x,D,w,P,R,U){function C(e,t,r){switch(t){case"world":for(var a=0,i=e.vertices;a<i.length;a++){var o=i[a];u.vec3.add(N,o.pos,e.offset),r.worldUpAtPosition(N,M),o.setFrameFromUpVector(M),o.computeRotationAxisAndAngleFromUpVector()}break;case"path":u.vec3.add(N,e.vertices[0].pos,e.offset),r.worldUpAtPosition(N,M),w.computeMinimumRotationTangentFrame(e,M);for(var s=0,n=e.vertices;s<n.length;s++){var o=n[s],c=l.sign(u.vec3.dot(o.frame.right,o.vRight));u.vec3.cross(o.rotationFrame.up,o.vRight,o.vLeft),u.vec3.scale(o.rotationFrame.up,o.rotationFrame.up,c),u.vec3.normalize(o.rotationFrame.up,o.rotationFrame.up);var p=u.vec3.dot(o.rotationFrame.up,o.frame.up),d=u.vec3.dot(o.rotationFrame.up,o.frame.right);if(u.vec3.scale(N,o.frame.up,-d),u.vec3.scale(G,o.frame.right,p),u.vec3.add(N,N,G),u.vec3.normalize(o.rotationFrame.right,N),w.vertexSpaceToProfileSpace(o.rotationRight,o.frame,o.rotationFrame.right),u.vec3.negate(N,o.vLeft),o.rotationAngle=-c*(Math.PI-l.acosClamped(u.vec3.dot(N,o.vRight))),Math.abs(o.rotationAngle)>0){var m=1/Math.cos(.5*o.rotationAngle);h.mat2.set(o.miterStretch,1+(m-1)*o.rotationRight[0]*o.rotationRight[0],(m-1)*o.rotationRight[0]*o.rotationRight[1],(m-1)*o.rotationRight[0]*o.rotationRight[1],1+(m-1)*o.rotationRight[1]*o.rotationRight[1])}var v=Math.PI-o.rotationAngle;o.maxStretchDistance=Math.abs(Math.min(o.vLeftLength,o.vRightLength)/Math.cos(.5*v))}}}function E(e,t,r){switch(e){case"symbolValue":return r;case"proportional":return t;default:return e}}function V(e,t,r,a){for(var i=0,o=0,s=e.vertices;o<s.length;o++){var n=s[o];z.x=n.posES[0],z.y=n.posES[1],z.z=n.posES[2];var l=g.computeElevation(r,z,t,a,B);i+=B.terrainElevation,u.vec3.add(M,n.pos,e.offset),a.setAltitude(l,M),u.vec3.subtract(n.pos,M,e.offset)}return e.updatePathVertexInformation(),i/e.vertices.length}function I(e,t,r,a){var i=e.stageObject,o=i.geometryRecords,s=o.length,n=0;z.spatialReference=r.spatialReference,A.spatialReference=a.spatialReference;for(var l=0;l<s;l++){var c=o[l],h=c.geometry,p=h.metadata,d=p.pathGeometry,u=d.builder.path,m=p.geometrySR;O.spatialReference=m,n+=V(u,t,r,a),"world"!==u.upVector&&C(u,p.upVectorAlignment,a),d.onPathChanged(),h.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(l)}return n/s}Object.defineProperty(t,"__esModule",{value:!0});var L=function(e){function a(t,r,a,i){var o=e.call(this,t,r,a,i)||this;return o._intrinsicSize=d.vec2f64.fromValues(1,1),o.upVectorAlignment="path",o.stencilWidth=.1,o}return r(a,e),a.prototype.doLoad=function(){return o(this,void 0,void 0,function(){var e,r,a,o,l,h,d,u,m,f,y,g,_,x;return i(this,function(i){switch(e=c.isSome(this.symbolLayer.width)?this.symbolLayer.width:c.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,r=c.isSome(this.symbolLayer.height)?this.symbolLayer.height:e,this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=S.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},a=this.symbolLayer.anchor||"center",this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world"),o=this.symbolLayer.profile||"circle"){case"circle":default:this._profile=w.Profile.circle(t.NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case"quad":this._profile=w.Profile.rect()}switch(l=[0,0],"center"!==a&&(l={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[a],this._profile.translate(l[0],l[1])),h=this.symbolLayer.join||"simple"){case"round":this._extruder=new w.MiterExtruder(0,t.NUM_ROUND_JOIN_SUBDIVISIONS);break;case"bevel":this._extruder=new w.MiterExtruder(0,1);break;case"miter":this._extruder=new w.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new w.SimpleExtruder}switch(d=this.symbolLayer.cap||"butt"){case"none":this._startCap=new w.NoCapBuilder,this._endCap=new w.NoCapBuilder;break;case"butt":default:this._startCap=new w.TriangulationCapBuilder(this._profile,0),this._endCap=new w.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new w.TriangulationCapBuilder(this._profile,-.5),this._endCap=new w.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":u="quad"===o,this._startCap=new w.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:u,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new w.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:u,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}if(m=this._getIdHint(),f=c.get(this.symbolLayer,"material","color"),y=this._getCombinedOpacityAndColor(f),g=v.vec3f64.fromArray(y),_=y[3],x={diffuse:g,ambient:g,opacity:_,transparent:_<1||this._isPropertyDriven("opacity"),vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===d?"none":void 0,offsetTransparentBackfaces:!0},!this._isPropertyDriven("size")&&(p.vec2.set(this._intrinsicSize,e,r),!b.isValidSize(this._intrinsicSize[0])||!b.isValidSize(this._intrinsicSize[1])))throw new s("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||p.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(n.mixin(x,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new R(x,m+"_pathmat")):(x.vertexColors=this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),this._material=new P(x,m+"_pathmat")),this._material.setParameterValues(U.returnDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled)),this._context.stage.add(3,this._material),[2]})})},a.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)},a.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometryType(t.geometry,a.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,i=this.getGraphicElevationContext(t),o=e.renderingInfo;return this._createAs3DShape(t,o,i,r,t.uid)},a.prototype.layerOpacityChanged=function(){var e=c.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),r=t<1||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:t,transparent:r}),!0},a.prototype.layerElevationInfoChanged=function(e,t,r){var a=this;return e.forEach(function(e){var r=t(e);if(c.isSome(r)){var i=e.graphic,o=a.getGraphicElevationContext(i);r.needsElevationUpdates=g.needsElevationUpdates3D(o.mode),r.elevationContext.set(o)}}),g.SymbolUpdateType.UPDATE},a.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},a.prototype.physicalBasedRenderingChanged=function(e,t){return this._material.setParameterValues(U.returnDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled)),!0},a.prototype.pixelRatioChanged=function(e,t){return!0},a.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!S.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},a.prototype.getVertexData=function(e){for(var t=0,r=e.paths,a=[],i=e.spatialReference,o=this._context.elevationProvider.spatialReference,s=this._context.renderSpatialReference,n=0,l=r;n<l.length;n++){var c=l[n];t+=c.length}for(var h=new Float64Array(3*t),p=new Float64Array(3*t),d=new Float64Array(3*t),u=0,m=0,v=r;m<v.length;m++){var c=v[m];a.push({index:u,numVertices:c.length});for(var f=0,y=c;f<y.length;f++){var _=y[f];h[u++]=_[0],h[u++]=_[1],h[u++]=e.hasZ?_[2]:0}}var b=!0;return i.equals(o)?g.copyVertices(h,0,p,0,t):b=g.reproject(h,0,i,p,0,o,t),o.equals(s)?g.copyVertices(p,0,d,0,t):g.reproject(p,0,o,d,0,s,t),{pathVertexDataInfos:a,vertexDataGS:h,vertexDataES:p,vertexDataRS:d,projectionSuccess:b,terrainElevation:0}},a.prototype._createAs3DShape=function(e,t,r,a,i){var o=e.geometry,s=[],n=[],l=[],c=o.spatialReference,h=this._context.elevationProvider.spatialReference,p=new Array(6),d=this._context.renderCoordsHelper;O.spatialReference=c,z.spatialReference=h;var m=this.getVertexData(o);if(!m.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(m.pathVertexDataInfos.length>0){for(var v=0;v<m.pathVertexDataInfos.length;++v){var f=m.pathVertexDataInfos[v],b=f.index,S=f.numVertices;if(S<2)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else if(!this._context.clippingExtent||(g.computeBoundingBox(m.vertexDataES,b,S,p),!g.boundingBoxClipped(p,this._context.clippingExtent))){for(var P=[],R=b;R<b+3*S;){var U=R++,V=R++,L=R++,A=new w.PathVertex;u.vec3.set(A.posGS,m.vertexDataGS[U],m.vertexDataGS[V],m.vertexDataGS[L]),u.vec3.set(A.posES,m.vertexDataES[U],m.vertexDataES[V],m.vertexDataES[L]),z.x=A.posES[0],z.y=A.posES[1],z.z=A.posES[2];var N=g.computeElevation(this._context.elevationProvider,z,r,d,null);u.vec3.set(M,m.vertexDataRS[U],m.vertexDataRS[V],m.vertexDataRS[L]),d.setAltitude(N,M),u.vec3.set(A.pos,M[0],M[1],M[2]),P.push(A)}var G=new w.Path(P);C(G,this.upVectorAlignment,this._context.renderCoordsHelper);var B=new w.Builder(G,this._profile,this._extruder,this._startCap,this._endCap),F=null;if(this._fastUpdates.enabled){var T=this._fastUpdates.visualVariables,k=T.size?_.getAttributeValue(T.size.field,e):0,j=T.color?_.getAttributeValue(T.color.field,e):0,H=T.opacity?_.getAttributeValue(T.opacity.field,e):0;F=new w.FastUpdatePathGeometry(B,k,j,H)}else{var q=[this._intrinsicSize[0],this._intrinsicSize[1]];this._isPropertyDriven("size")&&(q[0]*=E(t.size[0],t.size[2],this.symbolLayer.width),q[1]*=E(t.size[2],t.size[0],this.symbolLayer.height));var W=null;this._isPropertyDriven("color")&&(W=t.color),this._isPropertyDriven("opacity")&&null!=t.opacity&&(W=W?[W[0],W[1],W[2],t.opacity]:[1,1,1,t.opacity]);var X=new w.StaticPathGeometry(B);X.bake(q),W&&X.bakeVertexColors(W),F=X}var J=F.createGeometryData(),Z=new x(J,a+"path"+v),K={pathGeometry:F,geometrySR:c,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};Z.singleUse=!0,Z.metadata=K,s.push(Z),n.push(this._material),l.push(F.xform)}}var Q={layerUid:this._context.layer.uid,graphicUid:i};if(s.length>0){var Y=new D({geometries:s,materials:n,transformations:l,castShadow:!0,metadata:Q,idHint:a}),$=I,ee=new y(this,Y,s,null,null,$,r);return ee.alignedTerrainElevation=m.terrainElevation,ee.needsElevationUpdates=g.needsElevationUpdates3D(r.mode),ee}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null},a.validGeometryTypes=["polyline"],a}(_.Graphics3DSymbolLayer);t.Graphics3DPathSymbolLayer=L;var A=f.makeDehydratedPoint(0,0,0,null),z=f.makeDehydratedPoint(0,0,0,null),O=f.makeDehydratedPoint(0,0,0,null),M=v.vec3f64.create(),N=m.vec3f32.create(),G=m.vec3f32.create();t.NUM_ROUND_JOIN_SUBDIVISIONS=3,t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3,t.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var B={verticalDistanceToGround:0,terrainElevation:0};t.default=L});