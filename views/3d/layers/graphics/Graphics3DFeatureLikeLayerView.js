// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Graphic","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/Handles","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../geometry/support/webMercatorUtils","../../../../renderers/support/diffUtils","../../../../tasks/support/Query","./constants","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFilterVisibility","./Graphics3DFrustumVisibility","./Graphics3DHighlights","./Graphics3DScaleVisibility","./graphicUtils","../support/attributeUtils","../../../support/WatchUpdatingTracking"],function(t,e,i,s,r,n,a,l,o,p,h,u,c,d,g,y,f,b,m,v,w,E,V,x,C,R){var U=function(t){function e(e){var i=t.call(this)||this;return i._handles=new h,i.highlights=new E,i.watchUpdatingTracking=new R.WatchUpdatingTracking,i.suspendResumeExtentMode="computed",i.dataExtent=null,i.suspendResumeExtent=null,i}return i(e,t),Object.defineProperty(e.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updating",{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)},enumerable:!0,configurable:!0}),e.prototype.normalizeCtorArgs=function(t){var e=t.frustumVisibilityEnabled?new w:null,i=t.scaleVisibilityEnabled?new V:null,s=(t.filterVisibilityEnabled||t.timeExtentVisibilityEnabled)&&"multipatch"!==t.layer.geometryType?new v.Graphics3DFilterVisibility:null,r=t.elevationAlignmentEnabled?new m:null;return{graphicsCore:new b({owner:t.owner,layer:t.layer,preferredUpdatePolicy:t.preferredUpdatePolicy,elevationFeatureExpressionEnabled:t.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.owner.hasZ,hasM:t.owner.hasM}),frustumVisibility:e,scaleVisibility:i,filterVisibility:s,elevationAlignment:r,updateClippingExtent:t.updateClippingExtent,suspendResumeExtentMode:t.suspendResumeExtentMode,dataExtent:t.dataExtent}},e.prototype.initialize=function(){var t=this;this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",function(){return t.scaleVisibility.layerMinMaxScaleChangeHandler()}),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",function(){return t.filterVisibility.filterChanged()}),this.watchUpdatingTracking.add(this.owner,"timeExtent",function(){return t.filterVisibility.filterChanged()})),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",function(e,i){g.diff(e,i)&&t.graphicsCore.elevationInfoChange()}),this.watchUpdatingTracking.add(this.layer,"labelsVisible",function(){return t.graphicsCore.updateVisibilityInfo()}),this.watchUpdatingTracking.add(this.layer,"labelingInfo",function(e,i){g.diff(e,i)&&t.graphicsCore.updateLabelingInfo()})},e.prototype.setup=function(){return n(this,void 0,void 0,function(){var t,e,i,s,n=this;return r(this,function(r){switch(r.label){case 0:return this.frustumVisibility&&this.frustumVisibility.setup(this.owner),t=this.owner,e=this.owner.view.basemapTerrain,i=function(t,e,i){return n.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,e,i)},this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,i,this.graphicsCore,e),this.filterVisibility&&("filter"in t||"timeExtent"in t)&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment&&(s=t.view.elevationProvider,this.elevationAlignment.setup(t,i,this.graphicsCore,s)),this.highlights&&this.highlights.setup(this.graphicsCore),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),[4,o.result(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,highlights:this.highlights}))];case 1:return r.sent(),this._handles.add([this.layer.watch("renderer",function(t){return n.graphicsCore.rendererChange(t)}),t.watch("fullOpacity",function(){return n.graphicsCore.opacityChange()})]),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this._handles.add(t.view.watch("clippingArea",function(){return n._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled?[4,o.result(this.graphicsCore.updateLabelingInfo())]:[3,3];case 2:r.sent(),r.label=3;case 3:return[2]}})})},e.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var t=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","highlights","graphicsCore"],e=0,i=t;e<i.length;e++){var s=i[e],r=this[s];r&&(r.destroy(),this._set(s,null))}this._set("layer",null),this._set("owner",null)},e.prototype.highlight=function(t,e,i){var s=this;if(t instanceof y){var r=this.highlights.acquireSet(e,i),n=r.set,l=r.handle;return this.owner.queryObjectIds(t).then(function(t){return s.highlights.setObjectIds(n,t)}),l}if("number"==typeof t)return this.highlight([t],e,i);if(t instanceof a)return this.highlight([t],e,i);if("toArray"in t&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof a){var o=t;if(!i||!o[0].attributes||null===C.attributeLookup(o[0].attributes,i)){var p=o.map(function(t){return t.uid}),h=this.highlights.acquireSet(e,null),u=h.set,l=h.handle;return this.highlights.setUids(u,p),l}t=o.map(function(t){return C.attributeLookup(t.attributes,i)})}if("number"==typeof t[0]){var c=t,d=this.highlights.acquireSet(e,i),u=d.set,l=d.handle;return this.highlights.setObjectIds(u,c),l}}return S},e.prototype._updateClippingExtent=function(){var t=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.owner.view.spatialReference)&&(this.updateClippingExtent(t)||this.graphicsCore.recreateAllGraphics())},e.prototype.setupSuspendResumeExtent=function(){var t=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(u.init(this,"suspendResumeExtentMode",function(){switch(t._handles.remove(O),t.suspendResumeExtentMode){case"computed":t._handles.add(u.init(t.graphicsCore,"computedExtent",function(e){return t.updateSuspendResumeExtent(e)}),O);break;case"data":t._handles.add(u.init(t,"dataExtent",function(e){return t.updateSuspendResumeExtent(e)}),O);break;default:p.neverReached(t.suspendResumeExtentMode)}}))},e.prototype.updateSuspendResumeExtent=function(t){t?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(t,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)},e.prototype.extentToSuspendResumeRect=function(t,e){var i=this.owner.view.spatialReference;if(!t.spatialReference.equals(i)){if(!d.canProject(t,i))return;t=d.project(t,i)}return x.enlargeExtent(t,e,f.SUSPEND_RESUME_EXTENT_OPTIMISM)},e.prototype.suspendResumeExtentChanged=function(t){this.frustumVisibility&&this.frustumVisibility.setExtent(t),this.scaleVisibility&&this.scaleVisibility.setExtent(t)},s([c.property({aliasOf:"graphicsCore.layer"})],e.prototype,"layer",void 0),s([c.property({aliasOf:"graphicsCore.owner"})],e.prototype,"owner",void 0),s([c.property({constructOnly:!0})],e.prototype,"updateClippingExtent",void 0),s([c.property({constructOnly:!0})],e.prototype,"graphicsCore",void 0),s([c.property({constructOnly:!0})],e.prototype,"scaleVisibility",void 0),s([c.property({constructOnly:!0})],e.prototype,"filterVisibility",void 0),s([c.property({constructOnly:!0})],e.prototype,"elevationAlignment",void 0),s([c.property({constructOnly:!0})],e.prototype,"frustumVisibility",void 0),s([c.property({readOnly:!0})],e.prototype,"deconfliction",void 0),s([c.property({readOnly:!0})],e.prototype,"labeling",void 0),s([c.property({readOnly:!0})],e.prototype,"highlights",void 0),s([c.property({readOnly:!0})],e.prototype,"watchUpdatingTracking",void 0),s([c.property()],e.prototype,"suspendResumeExtentMode",void 0),s([c.property()],e.prototype,"dataExtent",void 0),s([c.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],e.prototype,"suspended",null),s([c.property({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],e.prototype,"updating",null),e=s([c.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],e)}(c.declared(l)),O="suspendResumeExtentMode",S={remove:function(){},pause:function(){},resume:function(){}};return U});