// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/Handles","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../layers/graphics/dehydratedFeatures","../../../../layers/support/labelFormatUtils","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./graphicSymbolUtils","./labelPlacement","../../support/debugFlags","../../webgl-engine/Stage","../../webgl-engine/lib/Layer","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextRenderer","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTextureAtlas"],function(e,t,a,r,l,s,i,n,o,c,h,u,b,p,d,y,f,g,v,C,x,T,m,L,D){Object.defineProperty(t,"__esModule",{value:!0});var G=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.idHint="__labeler",t._dirty=!1,t.labels={},t.labelsToAdd={},t.labelsToRemove={},t.labelingContexts=[],t}return a(t,e),t.prototype.setup=function(){var e=this;this.handles||(this.handles=new o,this.handles.add([this.view.watch("state.camera",function(){return e.setDirty()}),this.view.watch("pixelRatio",function(){return e.resetAllLabels()})])),this.textTextureAtlas||(this.textTextureAtlas=new D.default({idHint:this.idHint+"_atlas",view:this.view}),this.hudMaterialCollection=new T(this.view._stage),this.calloutMaterialCollection=new T(this.view._stage));var t=this.view.resourceController.scheduler;this.handles.add(t.registerTask(8,function(t){return e.update(t)},function(){return e.needsUpdate()}))},t.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null),this.calloutMaterialCollection&&(this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null),this.labelingContexts=[],this.labels={},this.labelsToAdd={},this.labelsToRemove={}},t.prototype.isActiveLabelingContext=function(e){return e.active&&this.labelsEnabled(e)},t.prototype.activateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]=a,a.graphics3DGraphic.setVisibilityFlag(0,!0,1)}e.active=!0},t.prototype.deactivateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];a.graphics3DGraphic.setVisibilityFlag(0,!1,1),a.rendered&&(this.labelsToRemove[t]=e.labels[t]),delete this.labels[t],delete this.labelsToAdd[t]}e.active=!1},t.prototype.addLabelTextureToAtlas=function(e){for(var t=0;t<e.graphics3DGraphic._labelGraphics.length;t++){var a=e.graphics3DGraphic._labelGraphics[t];if(a._labelClass){var r=e.textRenderers[a._labelIndex];r&&this.textTextureAtlas.addTextTexture(r,a.stageObject)}}e.rendered=!0},t.prototype.removeLabelTextureFromAtlas=function(e){for(var t=e.graphics3DGraphic,a=0;a<t._labelGraphics.length;a++){var r=t._labelGraphics[a];if(r._labelClass){var l=e.textRenderers[r._labelIndex];l&&this.textTextureAtlas.removeTextTexture(l,t._labelGraphics[a].stageObject)}}e.rendered=!1},t.prototype.needsUpdate=function(){return this.view.ready&&this.isDirty},t.prototype.update=function(e){this._dirty=!1;for(var t=!1,a=0,r=this.labelingContexts;a<r.length;a++){var l=r[a];if(this.isActiveLabelingContext(l)){if(!this.hasValidLabelClassContext(l)){if(this.hasInvalidLabelClassContext(l)){this.deactivateLabelingContext(l);continue}if(this.createLabelClassContext(l),this.hasPendingLabelClassContext(l)){this._dirty=!0;continue}if(!this.hasValidLabelClassContext(l))continue}for(var s in l.labelsToInitialize){var i=l.labelsToInitialize[s];if(this.ensureGraphics3DResources(i)&&(this.labels[s]=i,t=!0),(i.visible&&i.hasTextTextureResources||!i.visible&&i.hasGraphics3DResources)&&delete l.labelsToInitialize[s],e&&(e.madeProgress(),e.done))return void(this._dirty=!0)}}}e&&t&&this.view.deconflictor.setDirty();for(var s in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[s]),delete this.labelsToRemove[s];for(var s in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[s]),delete this.labelsToAdd[s];this._dirty||this.notifyChange("updating")},t.prototype.hasPendingLabelClassContext=function(e){return e.labelClassPromise&&!!e.labelClassAbortController},t.prototype.hasValidLabelClassContext=function(e){return e.labelClassContexts&&e.labelClassContexts.length},t.prototype.hasInvalidLabelClassContext=function(e){return null===e.labelClassContexts},t.prototype.createLabelClassContextAsync=function(e){return s(this,void 0,void 0,function(){var t,a,r,i,o=this;return l(this,function(c){switch(c.label){case 0:return t=e.labelClassAbortController.signal,[4,e.layer.when()];case 1:return c.sent(),(h.throwIfAborted(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive(),a=e.graphics3DCore,(r=a.layer.labelingInfo&&a.layer.labelingInfo.filter(function(e){return!!e.symbol}))&&0!==r.length)?(i=new Array(r.length),[4,n.forEach(r,function(r,c){return s(o,void 0,void 0,function(){var s,o,u,b;return l(this,function(l){switch(l.label){case 0:return s=r.symbol,o=f.getGraphics3DSymbol(a.getOrCreateGraphics3DSymbol(s)),[4,o.load()];case 1:return l.sent(),(h.throwIfAborted(t),u=null,d.isCalloutSupport(s)&&s.hasVisibleCallout())?(u=y.make(s,a.symbolCreationContext),[4,u.load()]):[3,3];case 2:l.sent(),h.throwIfAborted(t),l.label=3;case 3:return[4,n.result(p.createLabelFunction(r,e.layer.fields.map(function(e){return e.toJSON()}),this.view.spatialReference))];case 4:return b=l.sent(),h.throwIfAborted(t),!0===b.ok&&(i[c]={labelClass:r,labelFunction:b.value,graphics3DSymbol:o,graphics3DCalloutSymbolLayer:u,calloutSymbolLayerIndex:0,textRenderParameters:this.createTextRenderParameters(o.symbol)}),[2]}})})})]):[2];case 2:return c.sent(),h.throwIfAborted(t),e.labelClassContexts=i,[2]}})})},t.prototype.createLabelClassContext=function(e){return s(this,void 0,void 0,function(){var t=this;return l(this,function(a){return e.labelClassPromise||(e.labelClassPromise=this.createLabelClassContextAsync(e).catch(function(t){if(h.isAbortError(t))throw t;e.labelClassContexts=null}).then(function(){e.labelClassAbortController=null,t.notifyChange("updating")}),this.notifyChange("updating")),[2,e.labelClassPromise]})})},t.prototype.createTextRenderParameters=function(e){var t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?L.default.fromSymbol(t,this.view.pixelRatio):null},t.prototype.destroyLabelClassContext=function(e){for(var t=0,a=e.labelClassContexts;t<a.length;t++){var r=a[t];--r.graphics3DSymbol.referenced,r.graphics3DSymbol=null}var l=e.labelClassAbortController;e.labelClassAbortController=h.createAbortController(),l&&l.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")},t.prototype.createTextSymbolGraphic=function(e,t,a,r,l){var s={text:e.text,centerOffset:a.centerOffset,translation:a.translation,elevationOffset:a.elevationOffset,screenOffset:a.screenOffset,anchor:a.anchor,centerOffsetUnits:a.centerOffsetUnits,verticalOffset:a.verticalOffset,debugDrawBorder:v.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return A.graphic=t,A.renderingInfo=null,A.layer=r,l.createLabel(A,s,this.hudMaterialCollection,this.textTextureAtlas)},t.prototype.createLineCalloutGraphic=function(e,t,a,r,l){var s={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};return A.graphic=e,A.renderingInfo=s,A.layer=l,a.createGraphics3DGraphic(A)},t.prototype.ensureGraphics3DResources=function(e){var t=e.graphics3DGraphic;if(t.destroyed)return!1;if(e.hasGraphics3DResources)return!1;this.ensureTextTextureResources(e);var a=e.labelingContext,r=!1,l=t.graphic,s=a.labelClassContexts,i=a.layer,n=this.labelsEnabled(a);if(!s||0===s.length||!t._graphics[0])return!1;for(var o=0;o<s.length;o++){var h=s[o],u=h.labelClass,b=e.textRenderers[o];if(b){var p=h.graphics3DSymbol,d=null;p.symbol&&"label-3d"===p.symbol.type&&(d=p.symbol);var y=p.symbolLayers[0],f=g.get({graphics3DGraphic:t,labelSymbol:d,labelClass:h.labelClass});if(y&&!c.isNone(f)){var v=this.createTextSymbolGraphic(b,l,f,i,y);if(!v)return!1;if(v._labelClass=u,v._labelIndex=o,t.addLabelGraphic(v,a.stageLayer,this.view._stage),t.setVisibilityFlag(0,n,1),t.clearVisibilityFlag(1,1),t.setVisibilityFlag(3,!1,1),r=!0,h.graphics3DCalloutSymbolLayer&&f.hasLabelVerticalOffset){var C=this.createLineCalloutGraphic(l,d,h.graphics3DCalloutSymbolLayer,f,i);C&&(h.calloutSymbolLayerIndex=t._labelGraphics.length,t.addLabelGraphic(C,a.stageLayer,this.view._stage))}break}}}return a.scaleVisibility&&r&&a.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},t.prototype.destroyGraphics3DResources=function(e){e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},t.prototype.ensureTextTextureResources=function(e){if(!e.hasTextTextureResources){var t=e.labelingContext,a=e.graphics3DGraphic,r=t.labelClassContexts,l=a.graphic;if(r&&0!==r.length){for(var s=0;s<r.length;s++){var i=r[s];if(e.textRenderers[s]=null,i.textRenderParameters){var n=i.labelFunction,o=void 0;if("arcade"===n.type){var h=b.hydrateGraphic(l,t.layer);try{o=n.evaluate(h)}catch(e){o=null}}else o=n.evaluate(l);c.isNone(o)||""===o||(e.textRenderers[s]=new m.default(o,i.textRenderParameters))}}e.hasTextTextureResources=!0}}},t.prototype.destroyTextTextureResources=function(e){e.textRenderers=[],e.hasTextTextureResources=!1},t.prototype.addGraphic=function(e,t){var a={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textRenderers:[]},r=t.graphic.uid;e.labels[r]=a,this.isActiveLabelingContext(e)&&this.hasValidLabelClassContext(e)&&this.ensureGraphics3DResources(a)?this.labels[r]=a:e.labelsToInitialize[r]=a;var l=e.graphics3DCore.asyncUpdates;this.setDirty(l),this.view.deconflictor.setDirty()},t.prototype.removeGraphic=function(e,t){var a=t.graphic.uid,r=e.labels[a];if(r){this.labels[a]&&(this.removeLabelTextureFromAtlas(r),delete this.labels[a],delete this.labelsToAdd[a],delete this.labelsToRemove[a]),r.hasTextTextureResources&&this.destroyTextTextureResources(r),r.hasGraphics3DResources&&this.destroyGraphics3DResources(r),delete e.labels[a],delete e.labelsToInitialize[a];var l=e.graphics3DCore.asyncUpdates;this.setDirty(l),this.view.deconflictor.setDirty()}},t.prototype.labelsEnabled=function(e){return!0===e.layer.labelsVisible&&null!=e.layer.labelingInfo&&e.layer.labelingInfo.length>0},t.prototype.labelingInfoChange=function(e,t){return s(this,void 0,void 0,function(){var a,r,s,i;return l(this,function(l){if(t){for(a=0,r=t;a<r.length;a++)s=r[a],(i=e.labels[s])&&(this.removeGraphic(e,i.graphics3DGraphic),this.addGraphic(e,i.graphics3DGraphic));return[2]}return this.visibilityInfoChange(e),this.resetLabels(e),[2,this.createLabelClassContext(e)]})})},t.prototype.globalPropertyChanged=function(e,t){for(var a=0,r=t.labelClassContexts;a<r.length;a++){var l=r[a];!function(a){var r=new Map;for(var l in t.labels){var s=t.labels[l],i=s.graphics3DGraphic;r.set(i.graphic.uid,i)}var n=function(e){return e._labelGraphics[0]};if(c.expect(a.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,n),a.graphics3DCalloutSymbolLayer){var o=function(e){return e._labelGraphics[a.calloutSymbolLayerIndex]};a.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,o)}}(l)}},t.prototype.visibilityInfoChange=function(e){var t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e);var a=e.graphics3DCore.asyncUpdates;this.setDirty(a)},t.prototype.resetAllLabels=function(){for(var e=0,t=this.labelingContexts;e<t.length;e++){var a=t[e];this.resetLabels(a)}},t.prototype.resetLabels=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]&&(this.removeLabelTextureFromAtlas(a),delete this.labels[t],delete this.labelsToAdd[t],delete this.labelsToRemove[t]),a.hasTextTextureResources&&this.destroyTextTextureResources(a),a.hasGraphics3DResources&&this.destroyGraphics3DResources(a),a.visible=!1,a.rendered=!1,e.labelsToInitialize[t]=a}this.destroyLabelClassContext(e);var r=e.graphics3DCore.asyncUpdates;this.setDirty(r),this.view.deconflictor.setDirty()},t.prototype.findLabelingContext=function(e){for(var t=0,a=this.labelingContexts;t<a.length;t++){var r=a[t];if(r.graphics3DCore===e)return r}return null},t.prototype.addGraphicsOwner=function(e,t){var a=this;if(!this.findLabelingContext(e)){var r=e.layer,l={graphics3DCore:e,layer:r,scaleVisibility:t,active:e.layer.labelsVisible,labelClassPromise:null,labelClassAbortController:h.createAbortController(),labelClassContexts:[],labels:{},labelsToInitialize:{},stageLayer:new x(this.idHint+"_"+r.uid,{isPickable:!0},r.uid)};return this.view._stage.add(C.ModelContentType.LAYER,l.stageLayer),this.view._stage.addToViewContent([l.stageLayer.id]),this.labelingContexts.push(l),this.setDirty(),{addGraphic:function(e){return a.addGraphic(l,e)},removeGraphic:function(e){return a.removeGraphic(l,e)},featureReductionChange:function(){},layerLabelsEnabled:function(){return a.labelsEnabled(l)},labelingInfoChange:function(e){return a.labelingInfoChange(l,e)},elevationInfoChange:function(){return a.globalPropertyChanged("elevationInfo",l)},slicePlaneEnabledChange:function(){return a.globalPropertyChanged("slicePlaneEnabled",l)},visibilityInfoChange:function(){return a.visibilityInfoChange(l)},reset:function(){return a.resetLabels(l)},clear:function(){},processStageDirty:function(){return a.view._stage.processDirtyLayer(l.stageLayer.id)}}}},t.prototype.removeGraphicsOwner=function(e){var t=this.findLabelingContext(e);if(t){var a=this.labelingContexts.indexOf(t);this.labelingContexts.splice(a,1);for(var r in t.labels)this.removeGraphic(t,t.labels[r].graphics3DGraphic);var l=t.stageLayer.id;this.view._stage.removeFromViewContent([l]),this.view._stage.remove(C.ModelContentType.LAYER,l),t.stageLayer=null,this.setDirty()}},t.prototype.setLabelGraphicVisibility=function(e,t){var a=e.graphic.uid,r=this.labels[a];if(r){t&&!r.rendered?(this.labelsToAdd[a]=r,r.hasTextTextureResources||(r.labelingContext.labelsToInitialize[a]=r)):!t&&r.rendered&&(this.labelsToRemove[a]=r),r.visible=t;var l=r.labelingContext.graphics3DCore.asyncUpdates;this.setDirty(l)}},Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(e){void 0===e&&(e=!0);var t=this._dirty;this._dirty||(this._dirty=!0),e||this.update(null),t!==this._dirty&&this.notifyChange("updating")},Object.defineProperty(t.prototype,"updating",{get:function(){var e=this;return this._dirty||this.textTextureAtlas&&this.textTextureAtlas.updating||this.labelingContexts.some(function(t){return e.hasPendingLabelClassContext(t)})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{textTextureAtlas:this.textTextureAtlas}},enumerable:!0,configurable:!0}),r([u.property({constructOnly:!0})],t.prototype,"view",void 0),r([u.property()],t.prototype,"textTextureAtlas",void 0),r([u.property({type:Boolean,readOnly:!0,dependsOn:["textTextureAtlas.updating"]})],t.prototype,"updating",null),t=r([u.subclass("esri.views.3d.layers.graphics.Labeler")],t)}(u.declared(i));t.Labeler=G;var A={graphic:null,renderingInfo:null,layer:null}});