// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Set","../../../geometry","../../../Graphic","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/sql/WhereClause","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/webMercatorUtils","../../../layers/support/fieldUtils","../../../tasks/support/Query","./I3SMeshView3D","./LayerView3D","./i3s/I3SGeometryUtil","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../support/projectionUtils","../../layers/support/FeatureFilter"],function(e,t,r,i,n,o,s,a,l,u,p,d,c,y,f,h,g,_,F,m,v,E,b,I,S,w,j,x,R,L,O,Q,C,q,M,G,P){var N=y.getLogger("esri.views.3d.layers.SceneLayerView3D"),V=C.defineFieldProperties(),A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t.lodFactor=1,t.progressiveLoadFactor=1,t._elevationContext="scene",t._isIntegratedMesh=!1,t._asyncModuleLoading=0,t._projectionEngineLoaded=!1,t}return i(t,e),Object.defineProperty(t.prototype,"filter",{set:function(e){if(f.isNone(e))return void this._set("filter",null);var t=["contains","intersects","disjoint"];e.timeExtent?(N.warn("Filters with a timeExtent are not supported for mesh scene layers"),this._set("filter",null)):e.spatialRelationship&&-1===t.indexOf(e.spatialRelationship)?(N.warn("Filters with spatialRelationship other than "+t.join(", ")+" are not supported for mesh scene layers"),this._set("filter",null)):this._set("filter",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedFilterWhereClause",{get:function(){var e=f.isSome(this.filter)?this.filter.where:null;if(!e)return null;try{return F.WhereClause.create(e,this.layer.fieldsIndex)}catch(e){N.error("Failed to parse filter where clause: "+e)}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedFilterGeometry",{get:function(){var e=this;if(f.isNone(this.filter))return null;var t=this.filter,r=t.geometry,i=t.distance,n=t.units;if(!i)return r;if(!this._geometryEngine)return null;var o=n||h.getUnitString(r.spatialReference);if(r.spatialReference.isWGS84)return this._geometryEngine.geodesicBuffer(r,i,o);if(E.canProject(r,u.SpatialReference.WGS84))return E.project(this._geometryEngine.geodesicBuffer(E.project(r,u.SpatialReference.WGS84),i,o),r.spatialReference);if(!m.isSupported())return N.error("Filter by geodesic buffer (distance) unsupported due to lack of projection support."),null;if(!this._projectionEngineLoaded&&(this._loadAsyncModule(m.load()).then(function(){e._set("_projectionEngineLoaded",!0)}),!this._projectionEngineLoaded))return null;var s=null;try{s=m.project(r,u.SpatialReference.WGS84)}catch(e){}if(s)try{s=m.project(this._geometryEngine.geodesicBuffer(s,i,o),r.spatialReference)}catch(e){s=null}return s||N.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry ("+r.spatialReference.wkid+") to WGS84."),s},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.handles.add([g.init(this,["layer.renderer","definitionExpressionFields","filter"],function(){return e._updateRequiredFields()}),g.init(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)}),g.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),this.watch(["parsedDefinitionExpression","layer.objectIdFilter","filter","parsedFilterWhereClause","parsedFilterGeometry"],function(){return e._filterChange()})])},t.prototype.destroy=function(){},t.prototype._updateRequiredFields=function(){return s(this,void 0,void 0,function(){var e,t,r,i,n,s,u,p;return o(this,function(o){switch(o.label){case 0:return e=this,t=e.layer,r=e.layer,i=r.fields,n=r.renderer,s=e.definitionExpressionFields,u=e.filter,p=new l.default,n?[4,n.collectRequiredFields(p,i)]:[3,2];case 1:o.sent(),o.label=2;case 2:return f.isSome(u)?[4,b.collectFilterFields(p,t,u)]:[3,4];case 3:o.sent(),o.label=4;case 4:return b.collectFields(p,i,s),this._set("requiredFields",a.from(p).sort()),[2]}})})},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&N.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return f.isSome(this.filter)?this.filter.createQuery(e):new I(e)},t.prototype.queryExtent=function(e){return c.safeCast(this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e)))},t.prototype.queryFeatureCount=function(e){return c.safeCast(this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e)))},t.prototype.queryFeatures=function(e){return c.safeCast(this._ensureQueryEngine().executeQuery(this._ensureQuery(e)))},t.prototype.queryObjectIds=function(e){return c.safeCast(this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e)))},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t=this._createGetFeatureExtent();return new x.default({layerView:this,priority:4,spatialIndex:new L.default({featureAdapter:new R.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:t}),forAllFeatures:function(t,r){return e._forAllFeatures(function(e,r,i){return t({id:e,index:r,meta:i})},r,2)},getFeatureExtent:t,sourceSpatialReference:O.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})},t.prototype._createGetFeatureExtent=function(){var e=this,t=new Float64Array(24),r=this.view.renderSpatialReference,i=this.view.spatialReference;return function(n){if(!n.meta.featureExtents){var o=new Float64Array(6*n.meta.featureIds.length);n.meta.featureExtents=o;for(var s=0;s<o.length;s+=6)o[s]=Number.POSITIVE_INFINITY}var a=n.meta.featureExtents,l=new Float64Array(a.buffer,6*n.index*Float64Array.BYTES_PER_ELEMENT,6);return l[0]===Number.POSITIVE_INFINITY?(e._boundingBoxCornerPoints(n.index,n.meta.engineObject,t),G.bufferToBuffer(t,r,0,t,i,0,8)?v.expandWithBuffer(v.NEGATIVE_INFINITY,t,0,8,l):v.set(l,v.ZERO)):l}},t.prototype.highlight=function(e,t){void 0===t&&(t={});var r=this._highlights;if(e instanceof I){var i=r.acquireSet(t),n=i.set,o=i.handle;return this.queryObjectIds(e).then(function(e){return r.setFeatureIds(n,e)}),o}return this.inherited(arguments)},t.prototype._createLayerGraphic=function(e){var t=new p(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)||this._asyncModuleLoading>0},t.prototype.getFilters=function(){var e=this,t=this.inherited(arguments);if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t){return e._objectIdFilter(r,i,t)})}if(this.addSqlFilter(t,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError),f.isSome(this.filter)){if(f.isSome(this.parsedFilterGeometry)){var n=this.parsedFilterGeometry;t.push(function(t,r){return e._maskFilter(t,r,n)})}if(this.filter.objectIds){var o=new Float64Array(this.filter.objectIds);o.sort(),t.push(function(t){return e._objectIdFilter(o,!0,t)})}}return f.isSome(this.parsedFilterWhereClause)&&this.addSqlFilter(t,this.parsedFilterWhereClause,this.parsedFilterWhereClause.fieldNames,this.logError),t},t.prototype._maskFilter=function(e,t,r){if(!f.isNone(this.filter)){var i=r,n=i.spatialReference||this.view.spatialReference;G.mbsToMbs(t.node.mbs,this._controller.crsIndex,W,n);var o=this.filter.spatialRelationship,s=j.acquireMaskFilterContext(o,this.view,i,t.engineObject),a=j.intersectMaskWithMbs(s,W);switch(j.getIntersectRelation(s,a)){case 1:return void(e.length=0);case 0:return}t.engineObject.getGeometryRecords()[0].geometry.componentCount===t.featureIds.length&&O.filterInPlace(e,t.featureIds,function(e){return j.filterMask(e,s)})}},t.prototype._filterChange=function(){var e=this;!f.isSome(this.filter)||!this.filter.geometry||this._geometryEngine?this.inherited(arguments):this._loadAsyncModule(j.loadGeometryEngine()).then(function(t){e.destroyed||(e._set("_geometryEngine",t),e._applyFilters(!0))})},t.prototype._loadAsyncModule=function(e){var t=this;this._set("_asyncModuleLoading",this._asyncModuleLoading+1);var r=function(){return t._set("_asyncModuleLoading",t._asyncModuleLoading-1)};return e.then(function(e){return r(),e},function(e){throw r(),e})},t.prototype._objectIdFilter=function(e,t,r){for(var i=0,n=0;i<r.length;){d.binaryIndexOf(e,r[i])>=0===t&&(r[n]=r[i],n++),i++}r.length=n},t.prototype._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(f.isNone(e)?this.createQuery():I.from(e))},n([_.property()],t.prototype,"layer",void 0),n([_.property({dependsOn:["_controller.updating","_asyncModuleLoading"]})],t.prototype,"updating",void 0),n([_.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),n([_.property(q.updatingPercentage)],t.prototype,"updatingPercentage",void 0),n([_.property({type:P})],t.prototype,"filter",null),n([_.property({readOnly:!0,dependsOn:["filter.where"]})],t.prototype,"parsedFilterWhereClause",null),n([_.property({readOnly:!0,dependsOn:["filter.geometry","filter.distance","filter.units","_geometryEngine","_projectionEngineLoaded"]})],t.prototype,"parsedFilterGeometry",null),n([_.property(V.requiredFields)],t.prototype,"requiredFields",void 0),n([_.property(V.availableFields)],t.prototype,"availableFields",void 0),n([_.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],t.prototype,"lodFactor",void 0),n([_.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),n([_.property({readOnly:!0})],t.prototype,"_asyncModuleLoading",void 0),n([_.property({readOnly:!0})],t.prototype,"_geometryEngine",void 0),n([_.property({readOnly:!0})],t.prototype,"_projectionEngineLoaded",void 0),t=n([_.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(_.declared(w,S.I3SMeshView3D,M.PopupSceneLayerView,Q.DefinitionExpressionSceneLayerView)),W=[0,0,0,0];return A});