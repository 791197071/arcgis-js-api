// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../geometry","../../../Graphic","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/iteratorUtils","../../../core/Logger","../../../core/maybe","../../../core/unitUtils","../../../core/accessorSupport/decorators","../../../core/sql/WhereClause","../../../geometry/projection","../../../geometry/support/aaBoundingBox","../../../geometry/support/webMercatorUtils","../../../layers/support/fieldUtils","../../../tasks/support/Query","./I3SMeshView3D","./LayerView3D","./i3s/I3SGeometryUtil","./i3s/I3SQueryEngine","./i3s/I3SQueryFeatureAdapter","./i3s/I3SQueryFeatureStore","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../support/projectionUtils","../../layers/LayerView","../../layers/support/FeatureFilter","../../support/index"],function(e,t,r,i,n,o,s,a,l,u,p,d,c,y,f,h,g,_,F,v,E,m,I,b,S,w,x,j,R,L,O,Q,C,q,M,V,G){var N=c.getLogger("esri.views.3d.layers.SceneLayerView3D"),P=O.defineFieldProperties(),A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t.lodFactor=1,t.progressiveLoadFactor=1,t._elevationContext="scene",t._isIntegratedMesh=!1,t._asyncModuleLoading=0,t._projectionEngineLoaded=!1,t}return i(t,e),Object.defineProperty(t.prototype,"filter",{set:function(e){if(y.isNone(e))return void this._set("filter",null);var t=["contains","intersects","disjoint"];e.timeExtent?(N.warn("Filters with a timeExtent are not supported for mesh scene layers"),this._set("filter",null)):e.spatialRelationship&&-1===t.indexOf(e.spatialRelationship)?(N.warn("Filters with spatialRelationship other than "+t.join(", ")+" are not supported for mesh scene layers"),this._set("filter",null)):this._set("filter",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedFilterWhereClause",{get:function(){var e=y.isSome(this.filter)?this.filter.where:null;if(!e)return null;try{return g.WhereClause.create(e,this.layer.fieldsIndex)}catch(e){N.error("Failed to parse filter where clause: "+e)}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedFilterGeometry",{get:function(){var e=this;if(y.isNone(this.filter))return null;var t=this.filter,r=t.geometry,i=t.distance,n=t.units;if(!i)return r;if(!this._geometryEngine)return null;var o=n||f.getUnitString(r.spatialReference);if(r.spatialReference.isWGS84)return this._geometryEngine.geodesicBuffer(r,i,o);if(v.canProject(r,a.SpatialReference.WGS84))return v.project(this._geometryEngine.geodesicBuffer(v.project(r,a.SpatialReference.WGS84),i,o),r.spatialReference);if(!_.isSupported())return N.error("Filter by geodesic buffer (distance) unsupported due to lack of projection support."),null;if(!this._projectionEngineLoaded&&(this._loadAsyncModule(_.load()).then(function(){e._set("_projectionEngineLoaded",!0)}),!this._projectionEngineLoaded))return null;var s=null;try{s=_.project(r,a.SpatialReference.WGS84)}catch(e){}if(s)try{s=_.project(this._geometryEngine.geodesicBuffer(s,i,o),r.spatialReference)}catch(e){s=null}return s||N.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry ("+r.spatialReference.wkid+") to WGS84."),s},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){for(var e=this,t=0,r=["layer.renderer","definitionExpressionFields","filter"];t<r.length;t++){var i=r[t];this.updatingHandles.add(this,i,function(){return e._updateRequiredFields()})}this._updateRequiredFields(),this.updatingHandles.add(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)},2),this.updatingHandles.add(this.layer,"renderer",function(t){return e._rendererChange(t)},2);for(var n=0,o=["parsedDefinitionExpression","layer.objectIdFilter","filter","parsedFilterWhereClause","parsedFilterGeometry"];n<o.length;n++){var i=o[n];this.updatingHandles.add(this,i,function(){return e._filterChange()})}},t.prototype.destroy=function(){},t.prototype._updateRequiredFields=function(){return s(this,void 0,void 0,function(){var e,t,r,i,n,s,a,l;return o(this,function(o){switch(o.label){case 0:return e=this,t=e.layer,r=e.layer,i=r.fields,n=r.renderer,s=e.definitionExpressionFields,a=e.filter,l=new Set,n?[4,n.collectRequiredFields(l,i)]:[3,2];case 1:o.sent(),o.label=2;case 2:return y.isSome(a)?[4,E.collectFilterFields(l,t,a)]:[3,4];case 3:o.sent(),o.label=4;case 4:return E.collectFields(l,i,s),this._set("requiredFields",d.valuesOfSet(l).sort()),[2]}})})},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&N.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return y.isSome(this.filter)?this.filter.createQuery(e):new m(e)},t.prototype.queryExtent=function(e){return p.safeCast(this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e)))},t.prototype.queryFeatureCount=function(e){return p.safeCast(this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e)))},t.prototype.queryFeatures=function(e){return p.safeCast(this._ensureQueryEngine().executeQuery(this._ensureQuery(e)))},t.prototype.queryObjectIds=function(e){return p.safeCast(this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e)))},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t=this._createGetFeatureExtent();return new w.default({layerView:this,task:G.Task.FEATURE_QUERY_ENGINE,spatialIndex:new j.default({featureAdapter:new x.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:t}),forAllFeatures:function(t,r){return e._forAllFeatures(function(e,r,i){return t({id:e,index:r,meta:i})},r,2)},getFeatureExtent:t,sourceSpatialReference:R.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})},t.prototype._createGetFeatureExtent=function(){var e=this,t=new Float64Array(24),r=this.view.renderSpatialReference,i=this.view.spatialReference;return function(n){if(!n.meta.featureExtents){var o=new Float64Array(6*n.meta.featureIds.length);n.meta.featureExtents=o;for(var s=0;s<o.length;s+=6)o[s]=Number.POSITIVE_INFINITY}var a=n.meta.featureExtents,l=new Float64Array(a.buffer,6*n.index*Float64Array.BYTES_PER_ELEMENT,6);return l[0]===Number.POSITIVE_INFINITY?(e._boundingBoxCornerPoints(n.index,n.meta.engineObject,t),q.bufferToBuffer(t,r,0,t,i,0,8)?F.expandWithBuffer(F.NEGATIVE_INFINITY,t,0,8,l):F.set(l,F.ZERO)):l}},t.prototype.highlight=function(e,t){void 0===t&&(t={});var r=this._highlights;if(e instanceof m){var i=r.acquireSet(t),n=i.set,o=i.handle;return this.queryObjectIds(e).then(function(e){return r.setFeatureIds(n,e)}),o}return this.inherited(arguments)},t.prototype._createLayerGraphic=function(e){var t=new l(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this.updatingMeshView3D||this._asyncModuleLoading>0},t.prototype.getFilters=function(){var e=this,t=this.inherited(arguments);if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t){return e._objectIdFilter(r,i,t)})}if(this.addSqlFilter(t,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError),y.isSome(this.filter)){if(y.isSome(this.parsedFilterGeometry)){var n=this.parsedFilterGeometry;t.push(function(t,r){return e._maskFilter(t,r,n)})}if(this.filter.objectIds){var o=new Float64Array(this.filter.objectIds);o.sort(),t.push(function(t){return e._objectIdFilter(o,!0,t)})}}return y.isSome(this.parsedFilterWhereClause)&&this.addSqlFilter(t,this.parsedFilterWhereClause,this.parsedFilterWhereClause.fieldNames,this.logError),t},t.prototype._maskFilter=function(e,t,r){if(!y.isNone(this.filter)){var i=r,n=i.spatialReference||this.view.spatialReference;q.mbsToMbs(t.node.mbs,this._controller.crsIndex,U,n);var o=this.filter.spatialRelationship,s=S.acquireMaskFilterContext(o,this.view,i,t.engineObject),a=S.intersectMaskWithMbs(s,U);switch(S.getIntersectRelation(s,a)){case 1:return void(e.length=0);case 0:return}t.engineObject.geometryRecords[0].geometry.componentCount===t.featureIds.length&&R.filterInPlace(e,t.featureIds,function(e){return S.filterMask(e,s)})}},t.prototype._filterChange=function(){var e=this;!y.isSome(this.filter)||!this.filter.geometry||this._geometryEngine?this.inherited(arguments):this._loadAsyncModule(S.loadGeometryEngine()).then(function(t){e.destroyed||(e._set("_geometryEngine",t),e._applyFilters(!0))})},t.prototype._loadAsyncModule=function(e){var t=this;this._set("_asyncModuleLoading",this._asyncModuleLoading+1);var r=function(){return t._set("_asyncModuleLoading",t._asyncModuleLoading-1)};return e.then(function(e){return r(),e},function(e){throw r(),e})},t.prototype._objectIdFilter=function(e,t,r){for(var i=0,n=0;i<r.length;){u.binaryIndexOf(e,r[i])>=0===t&&(r[n]=r[i],n++),i++}r.length=n},t.prototype._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(y.isNone(e)?this.createQuery():m.from(e))},n([h.property()],t.prototype,"layer",void 0),n([h.property({dependsOn:["updatingMeshView3D","_asyncModuleLoading"]})],t.prototype,"updating",void 0),n([h.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),n([h.property(Q.updatingPercentage)],t.prototype,"updatingPercentage",void 0),n([h.property({type:V})],t.prototype,"filter",null),n([h.property({readOnly:!0,dependsOn:["filter.where"]})],t.prototype,"parsedFilterWhereClause",null),n([h.property({readOnly:!0,dependsOn:["filter.geometry","filter.distance","filter.units","_geometryEngine","_projectionEngineLoaded"]})],t.prototype,"parsedFilterGeometry",null),n([h.property(P.requiredFields)],t.prototype,"requiredFields",void 0),n([h.property(P.availableFields)],t.prototype,"availableFields",void 0),n([h.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],t.prototype,"lodFactor",void 0),n([h.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),n([h.property({readOnly:!0})],t.prototype,"_asyncModuleLoading",void 0),n([h.property({readOnly:!0})],t.prototype,"_geometryEngine",void 0),n([h.property({readOnly:!0})],t.prototype,"_projectionEngineLoaded",void 0),t=n([h.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(h.declared(I.I3SMeshView3D(L.DefinitionExpressionSceneLayerView(C.PopupSceneLayerView(b.LayerView3D(M)))))),U=[0,0,0,0];return A});