// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","../../../core/Error","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/quat","../../../core/libs/gl-matrix-2/quatf32","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/SpatialReference","../../../geometry/support/meshUtils/deduplicate","../../../libs/draco/DracoDecoder","./i3s/I3SBinaryReader","./i3s/I3SGeometryUtil","./i3s/I3SProjectionUtil","./i3s/I3SUtil","../support/orientedBoundingBox","../support/projectionUtils","../webgl-engine/lib/PreinterleavedGeometryData","../webgl-engine/lib/Util"],function(e,t,r,a,n,o,i,s,f,u,l,d,c,v,A,m,b,y,g,I,p,x,h,O){function w(e){return null==e.geometryIndex.header}function S(e,t){var r=new Array,a=e.layouts[0],i=e.geometryBuffer,f=new L.DecoderBuffer;f.Init(new Int8Array(i),i.byteLength);var u=new L.Decoder,l=new L.Mesh,d=u.DecodeBufferToMesh(f,l);if(!d.ok())throw L.destroy(l),L.destroy(u),L.destroy(f),new o("draco:decode_error","Error while decoding draco geometry",{message:d.error_msg()});var c=new L.DracoInt32Array,A=new L.MetadataQuerier,m=u.GetAttributeIdByMetadataEntry(l,"i3s-attribute-type","feature-index"),b=u.GetAttributeMetadata(l,m);A.GetIntEntryArray(b,"i3s-feature-ids",c);var I=c.size(),p=L._malloc(4*I);if(!c.GetArray(p,I))throw"GetArray failed";var x=new Uint32Array(L.HEAPU8.buffer,p,I).slice();L._free(p);var w=l.num_points(),S=3*l.num_faces(),R=w<65536;if(p=L._malloc(S*(R?2:4)),!(R?u.GetTrianglesUInt16Array(l,p,S):u.GetTrianglesUInt32Array(l,p,S)))throw"GetTrianglesArray failed";var D=R?new Uint16Array(L.HEAPU8.buffer,p,S).slice():new Uint32Array(L.HEAPU8.buffer,p,S).slice();L._free(p);var G=C(w,u,l,m),V=P(D,G),T=a[0].stride/Float32Array.BYTES_PER_ELEMENT,_=new Float32Array(T*w),B=new h(_,a,null,V,D),q=u.GetAttributeId(l,L.POSITION),H=E(3*w,u,l,q),z=B.getAttribute(O.VertexAttrConstants.POSITION),J=u.GetAttributeMetadata(l,q),j=A.GetDoubleEntry(J,"i3s-scale_x"),X=A.GetDoubleEntry(J,"i3s-scale_y");j=j<=0?1:j,X=X<=0?1:X;for(var k=B.getAttribute(O.VertexAttrConstants.COLOR),Y=u.GetAttributeId(l,L.COLOR),Q=-1!==Y,K=Q?N(4*w,u,l,Y):n.fill(new Array(4*w),255),W=0;W<w;W++){var Z=W*z.strideIdx+z.offsetIdx;z.data[Z]=H[3*W]*j,z.data[Z+1]=H[3*W+1]*X,z.data[Z+2]=H[3*W+2];var $=W*k.strideIdx+k.offsetIdx;k.data[$]=K[4*W],k.data[$+1]=K[4*W+1],k.data[$+2]=K[4*W+2],k.data[$+3]=K[4*W+3]}var ee=u.GetAttributeId(l,L.NORMAL),te=B.getAttribute(O.VertexAttrConstants.NORMAL);if(-1!==ee&&te)for(var re=E(3*w,u,l,ee),W=0;W<w;W++){var ae=W*te.strideIdx+te.offsetIdx;te.data[ae]=re[3*W],te.data[ae+1]=re[3*W+1],te.data[ae+2]=re[3*W+2]}else e.needNormals&&te&&y.computeCompressedNormals({normals:B.getAttribute(O.VertexAttrConstants.NORMALCOMPRESSED),positions:B.getAttribute(O.VertexAttrConstants.POSITION),normalInd:B.getIndices(O.VertexAttrConstants.NORMALCOMPRESSED),positionInd:B.getIndices(O.VertexAttrConstants.POSITION)});var ne=u.GetAttributeId(l,L.TEX_COORD),oe=B.getAttribute(O.VertexAttrConstants.UV0);if(-1!==ne&&oe)for(var ie=E(2*w,u,l,ne),W=0;W<w;W++){var ae=W*oe.strideIdx+oe.offsetIdx;oe.data[ae]=ie[2*W],oe.data[ae+1]=ie[2*W+1]}var se=u.GetAttributeIdByMetadataEntry(l,"i3s-attribute-type","uv-region"),fe=B.getAttribute(O.VertexAttrConstants.REGION);if(-1!==se&&fe)for(var ue=M(4*w,u,l,se),W=0;W<w;W++){var ae=W*fe.strideIdx+fe.offsetIdx;fe.data[ae]=ue[4*W],fe.data[ae+1]=ue[4*W+1],fe.data[ae+2]=ue[4*W+2],fe.data[ae+3]=ue[4*W+3]}var le=B.getAttribute(O.VertexAttrConstants.COMPONENTINDEX);le&&U(le,V),L.destroy(A),L.destroy(c),L.destroy(l),L.destroy(u),L.destroy(f);var de=e.mbs,ce=e.elevationOffset,ve=v.fromJSON(e.indexSR),Ae=v.fromJSON(e.vertexSR),me=v.fromJSON(e.renderSR),be=g.computeGlobalTransformation(de,ce,ve,me);s.mat4.invert(F,be);var ye=B.getAttribute(O.VertexAttrConstants.POSITION),ge={globalTrafo:be},Ie=_.buffer;g.reprojectPoints(ye,de,F,ce,ve,Ae,me);var pe=y.extractPositionData(Ie,a,D);return r.push({layout:a,interleavedVertexData:Ie,indices:D,corMatrices:ge,hasColors:Q,positionData:pe}),t&&(t.push(Ie),t.push(D.buffer)),{geometryBuffer:i,componentOffsets:V,featureIds:x,transformedGeometries:r,obb:null}}function E(e,t,r,a){var n=4*e,i=L._malloc(n),s=t.GetAttribute(r,a);if(!t.GetAttributeFloatArrayForAllPoints(r,s,i,e))throw new o("draco:decode_error","Error while getting attribute values",{attributeId:a});var f=new Float32Array(L.HEAPU8.buffer,i,e).slice();return L._free(i),f}function C(e,t,r,a){var n=4*e,i=L._malloc(n),s=t.GetAttribute(r,a);if(!t.GetAttributeUInt32ArrayForAllPoints(r,s,i,e))throw new o("draco:decode_error","Error while getting attribute values",{attributeId:a});var f=new Uint32Array(L.HEAPU8.buffer,i,e).slice();return L._free(i),f}function M(e,t,r,a){var n=2*e,i=L._malloc(n),s=t.GetAttribute(r,a);if(!t.GetAttributeUInt16ArrayForAllPoints(r,s,i,e))throw new o("draco:decode_error","Error while getting attribute values",{attributeId:a});var f=new Uint16Array(L.HEAPU8.buffer,i,e).slice();return L._free(i),f}function N(e,t,r,a){var n=e,i=L._malloc(n),s=t.GetAttribute(r,a);if(!t.GetAttributeUInt8ArrayForAllPoints(r,s,i,e))throw new o("draco:decode_error","Error while getting attribute values",{attributeId:a});var f=new Uint8Array(L.HEAPU8.buffer,i,e).slice();return L._free(i),f}function P(e,t){for(var r=new Array,a=0;a<e.length;++a){for(var n=e[a],o=t[n];r.length<=o;)r.push(new Array);r[o].push(n)}for(var i=0,s=new Uint32Array(r.length+1),a=0;a<r.length;++a){var f=r[a];s[a]=i;for(var u=0,l=f;u<l.length;u++){var n=l[u];e[i++]=n}}return s[r.length]=i,s}function R(e,t){var r=e.geometryData,a=e.geometryIndex,n=e.layouts,o=e.mbs,i=e.elevationOffset,f=v.fromJSON(e.indexSR),u=v.fromJSON(e.renderSR),l=g.computeGlobalTransformation(o,i,f,u);s.mat4.invert(F,l);var c=e.geometryBuffer,m=V(r,c,a),b=m.componentOffsets,I=m.featureIds;t&&(I&&t.push(I.buffer),b&&t.push(b.buffer));var w=e.obb?null:p.create([0,0,0],[-1,-1,-1],[0,0,0,1]);d.vec3.copy(q,o),q[2]+=i,d.vec3.copy(H,q);for(var S=!1,E=0,C=new Array,M=0,N=r.geometries;M<N.length;M++){var P=N[M],R=n[E];++E;var _=e.geometryBuffer,B=[{name:O.VertexAttrConstants.COLOR,byteValue:255}],L=[O.VertexAttrConstants.NORMAL,O.VertexAttrConstants.NORMALCOMPRESSED,O.VertexAttrConstants.SYMBOLCOLOR,O.VertexAttrConstants.COMPONENTINDEX],z=y.interleaveGeometryBuffer(P,_,R,B,L),J=new h(new Float32Array(z),R),j=J.getAttribute(O.VertexAttrConstants.POSITION),X=e.mbs,k=e.elevationOffset,Y=v.fromJSON(e.indexSR),Q=v.fromJSON(e.vertexSR),K=v.fromJSON(e.renderSR);g.reprojectPoints(j,X,F,k,Y,Q,K),w&&D(w,j,l);var W=J.getAttribute(O.VertexAttrConstants.NORMALCOMPRESSED);if(e.needNormals&&W){var Z={normals:W,positions:j,normalInd:J.getIndices(O.VertexAttrConstants.NORMALCOMPRESSED),positionInd:J.getIndices(O.VertexAttrConstants.POSITION)},$=e.normalReferenceFrame;y.processAndInterleaveNormals($,P,_,l,Z)}var ee=J.getAttribute(O.VertexAttrConstants.COMPONENTINDEX);ee&&U(ee,b);var te=J.getAttribute(O.VertexAttrConstants.COLOR);te&&!S&&(S=G(te));var re={globalTrafo:l},ae=R[0].stride,ne=1-.8*ae/(ae+4),oe=A.default(z,ae/4,null,ne);if(null!=oe){var ie=oe.uniqueCount<T?new Uint16Array(oe.indices):oe.indices,se=y.extractPositionData(oe.buffer,R,ie);C.push({layout:R,interleavedVertexData:oe.buffer,indices:ie,corMatrices:re,hasColors:S,positionData:se}),t&&(t.push(oe.buffer),t.push(ie.buffer),t.push(se.data.buffer),t.push(se.indices.buffer))}else{var se=y.extractPositionData(z,R);C.push({layout:R,interleavedVertexData:z,corMatrices:re,hasColors:S,positionData:se}),t&&(t.push(z),t.push(se.data.buffer),t.push(se.indices.buffer))}w&&(d.vec3.transformMat4(w.center,w.center,l),x.vectorToVector(w.center,K,w.center,Y),w.center[2]-=e.elevationOffset)}return{geometryBuffer:c,componentOffsets:b,featureIds:I,transformedGeometries:C,obb:w}}function D(e,t,r){if(e.halfSize[0]>0){d.vec3.subtract(q,e.center,e.halfSize),d.vec3.add(H,e.center,e.halfSize);for(var a=t.offsetIdx;a<t.data.length;a+=t.strideIdx)q[0]=Math.min(q[0],t.data[a]),q[1]=Math.min(q[1],t.data[a+1]),q[2]=Math.min(q[2],t.data[a+2]),H[0]=Math.max(H[0],t.data[a]),H[1]=Math.max(H[1],t.data[a+1]),H[2]=Math.max(H[2],t.data[a+2]);d.vec3.subtract(e.halfSize,H,q),d.vec3.scale(e.halfSize,e.halfSize,.5),d.vec3.add(e.center,q,H),d.vec3.scale(e.center,e.center,.5)}else{p.compute(t,e);var n=2*Math.sqrt(1+r[0]+r[5]+r[10]);z[0]=(r[9]-r[6])/n,z[1]=(r[2]-r[8])/n,z[2]=(r[4]-r[1])/n,z[3]=.25*n,u.quat.conjugate(z,z),u.quat.multiply(e.quaternion,z,e.quaternion)}}function G(e){for(var t=e.data,r=e.size,a=e.offsetIdx,n=e.strideIdx,o=a;o<t.length;o+=n)for(var i=0;i<r;i++)if(255!==t[o+i])return!0;return!1}function U(e,t){for(var r=e.data,a=e.offsetIdx,n=e.strideIdx,o=r.length/n,i=0,s=a,f=0;f<o;f++)f>=t[i+1]&&i++,r[s]=i,s+=n}function V(e,t,r){e.geometries[0].params.vertexAttributes=r.vertexAttributes;var a,n,o=r.featureAttributes;if(o){if(o.faceRange){var i=b.createTypedView(t,o.faceRange),s=o.faceRange.valuesPerElement,f=o.faceRange.count;a=I.convertFlatRangesToOffsets(i,f,s)}var u=o.id;if(u){n=new Uint32Array(u.count);var l=1,d=b.valueType2TypedArrayClassMap[u.valueType];"UInt64"===u.valueType&&(d=Uint32Array,l=2);for(var c=new d(t,u.byteOffset,u.count*u.valuesPerElement*l),v=0;v<u.count;v++){var A=v*u.valuesPerElement*l;if(n[v]=c[A],2===l&&0!==c[A+1])throw new Error("ID exceeded maximum range supported (2^32))")}}}return{componentOffsets:a,featureIds:n}}var T=65536,_=function(){function e(){}return e.prototype.process=function(t){return a(this,void 0,void 0,function(){var a,n;return r(this,function(r){switch(r.label){case 0:return[4,e.ensureDracoDecoder(t)];case 1:return r.sent(),a=[t.geometryBuffer],n=this.transform(t,a),[2,{result:n,transferList:a}]}})})},e.prototype.transform=function(e,t){return w(e)?S(e,t):R(e,t)},e}();!function(e){function t(e){return L&&L.DecoderBuffer||e&&!w(e)?i.resolve():(B||(B=m.getDecoderModule().then(function(e){return L=e,B=null,L})),B.then(function(){}))}e.ensureDracoDecoder=t}(_||(_={}));var B,L,F=f.mat4f64.create(),q=c.vec3f64.create(),H=c.vec3f64.create(),z=l.quatf32.create();return _});