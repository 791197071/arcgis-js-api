// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/vec2f32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/meshUtils/deduplicate","./I3SBinaryReader","../../support/projectionUtils","../../webgl-engine/lib/Util"],function(e,t,r,n,a,s,o,i,c,u,f,l,d){function v(e,t,r,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var s=e.params.vertexAttributes,o=s.position.count;if(!g(r[0].stride))throw w("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var i=r[0].stride/Uint32Array.BYTES_PER_ELEMENT,c=new Uint32Array(i*o);r=r.slice(0).sort(function(e,t){return e.offset-t.offset});for(var u=0,f=r;u<f.length;u++){var l=f[u];!function(e){if(-1!==a.indexOf(e.name))return"continue";var r=s[e.name],i=y(e.type),u=void 0,f=!1;if(null==r){var l=n.filter(function(t){return t.name===e.name})[0];if(!l)throw w("Geometry definition is missing attribute");r={valueType:m(e.type),byteOffset:0,count:o,valuesPerElement:e.count};for(var d=0;d<N.length;d++)N[d]=l.byteValue;u=N.buffer,f=!0}else u=t;if(m(e.type)!==r.valueType)throw w("Geometry definition type must match attribute type");if(!h(r.byteOffset)||!h(e.offset))throw w(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!g(r.valuesPerElement*i.BYTES_PER_ELEMENT)||!g(e.count*i.BYTES_PER_ELEMENT))throw w(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var v=new Uint32Array(u),b=r.byteOffset/Uint32Array.BYTES_PER_ELEMENT,I=r.valuesPerElement*i.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,T=e.offset/Uint32Array.BYTES_PER_ELEMENT,A=e.stride/Uint32Array.BYTES_PER_ELEMENT;f?p(v[0],I,c,T,A,o):E(v,b,I,c,T,A,o)}(l)}return c.buffer}function E(e,t,r,n,a,s,o){switch(r){case 1:for(var i=0;i<o;i++)n[a]=e[t],t+=1,a+=s;break;case 2:for(var i=0;i<o;i++)n[a]=e[t],n[a+1]=e[t+1],t+=2,a+=s;break;case 3:for(var i=0;i<o;i++)n[a]=e[t],n[a+1]=e[t+1],n[a+2]=e[t+2],t+=3,a+=s;break;case 4:for(var i=0;i<o;i++)n[a]=e[t],n[a+1]=e[t+1],n[a+2]=e[t+2],n[a+3]=e[t+3],t+=4,a+=s;break;default:throw w("Unhandled stride size "+r)}}function p(e,t,r,n,a,s){switch(t){case 1:for(var o=0;o<s;o++)r[n]=e,n+=a;break;case 2:for(var o=0;o<s;o++)r[n]=e,r[n+1]=e,n+=a;break;case 3:for(var o=0;o<s;o++)r[n]=e,r[n+1]=e,r[n+2]=e,n+=a;break;case 4:for(var o=0;o<s;o++)r[n]=e,r[n+1]=e,r[n+2]=e,r[n+3]=e,n+=a;break;default:throw w("Unhandled stride size "+t)}}function y(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function m(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function h(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function g(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function w(e){return new Error("I3SGeometryUtil processing failed: "+e)}function b(e,t,r,n,a){if("none"===e)I(a);else{var s=f.createTypedView(r,t.params.vertexAttributes.normal),o="earth-centered"===e?n:null;T(s,a.normals,o)}}function I(e){var t=e.normals,r=e.positions,n=e.normalInd,a=e.positionInd;d.assert(e.normalInd.length===e.positionInd.length);for(var c=i.vec3f32.create(),u=i.vec3f32.create(),f=s.vec2f32.create(),l=r.data,v=r.offsetIdx,E=r.strideIdx,p=t.data,y=t.offsetIdx,m=t.strideIdx,h=0;h<a.length;h+=3){var g=a[h],w=v+E*g,b=l[w],I=l[w+1],T=l[w+2];g=a[h+1],w=v+E*g,c[0]=l[w]-b,c[1]=l[w+1]-I,c[2]=l[w+2]-T,g=a[h+2],w=v+E*g,u[0]=l[w]-b,u[1]=l[w+1]-I,u[2]=l[w+2]-T,o.vec3.cross(c,c,u),d.encodeNormal(c,f);for(var A=0;A<3;A++){var _=n[h+A],U=y+m*_;p[U]=d.encodeInt16(f[0]),p[U+1]=d.encodeInt16(f[1])}}}function T(e,t,r){var n=e.length/3,a=t.data,s=t.offsetIdx,o=t.strideIdx;if(null!=r)for(var i=r,c=i[0],u=i[1],f=i[2],l=i[4],v=i[5],E=i[6],p=i[8],y=i[9],m=i[10],h=0;h<n;h++){var g=e[3*h],w=e[3*h+1],b=e[3*h+2];O[0]=c*g+u*w+f*b,O[1]=l*g+v*w+E*b,O[2]=p*g+y*w+m*b,d.encodeNormal(O,V),a[s+h*o]=d.encodeInt16(V[0]),a[s+h*o+1]=d.encodeInt16(V[1])}else for(var h=0;h<n;h++)O[0]=e[3*h],O[1]=e[3*h+1],O[2]=e[3*h+2],d.encodeNormal(O,V),a[s+h*o]=d.encodeInt16(V[0]),a[s+h*o+1]=d.encodeInt16(V[1])}function A(e,t,r){var n=t[0];if(null==n||"position"!==n.name||5126!==n.type)return null;for(var a=new Float32Array(e),s=n.stride/4,o=n.offset/4,i=3*a.length/s,c=new Float32Array(i),f=0;f<i/3;f++)c[3*f]=a[f*s+o],c[3*f+1]=a[f*s+o+1],c[3*f+2]=a[f*s+o+2];var l=u.default(c.buffer,3,r);return l.uniqueCount<P?{data:new Float32Array(l.buffer),indices:new Uint16Array(l.indices)}:{data:new Float32Array(l.buffer),indices:l.indices}}function _(){return!!B}function U(){return n(this,void 0,void 0,function(){return r(this,function(t){switch(t.label){case 0:return _()?[2,B]:[4,a.create(function(t,r){return e(["../../../../geometry/geometryEngine"],t)})];case 1:return B=t.sent(),[2,B]}})})}function M(e,t,r,n){var a=r.spatialReference||t.spatialReference,s=t.renderSpatialReference,o={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a};o.rings[0][4]=o.rings[0][0];var i=n.objectTransformation,c=n.getGeometryRecords()[0].geometry,u={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:a};u.rings[0][3]=u.rings[0][0];var f=B[e];return f||(console.error("Spatial relationship",e,"not supported"),f=function(){return!0}),{type:e,mask:r,maskSR:a,renderSR:s,aabb:o,transform:i,geometry:c,triangle:u,testFunction:f}}function R(e,t){switch(t){case 0:switch(e.type){case"intersects":case"contains":case"crosses":case"envelope-intersects":case"overlaps":case"touches":case"within":return 1;case"disjoint":return 0}break;case 2:switch(e.type){case"intersects":case"contains":case"envelope-intersects":case"within":return 0;case"disjoint":case"crosses":case"overlaps":case"touches":return 1}break;case 1:switch(e.type){case"envelope-intersects":return 0}}return 2}function S(e,t){var r={x:t[0],y:t[1],hasZ:!1,hasM:!1,type:"point",spatialReference:e.maskSR};return x(e,B.buffer(r,t[3],1,!0))}function x(e,t){return B.contains(e.mask,t)?2:B.intersects(e.mask,t)?1:0}function k(e,t){var r=t.type,n=t.mask,a=t.transform,s=t.renderSR,i=t.maskSR,c=t.geometry,u=t.triangle,f=t.testFunction,v=t.aabb;c.getComponentAABB(e,Y);var E=[v.rings[0][0],v.rings[0][1],v.rings[0][2],v.rings[0][3]];o.vec3.set(E[0],Y[0],Y[1],0),o.vec3.set(E[1],Y[0],Y[4],0),o.vec3.set(E[2],Y[3],Y[4],0),o.vec3.set(E[3],Y[3],Y[1],0);for(var p=0;p<4;++p)o.vec3.transformMat4(E[p],E[p],a),l.vectorToVector(E[p],s,E[p],i);switch(delete v._geVersion,R(t,x(t,v))){case 1:return!1;case 0:return!0}var y,m=u.rings[0][0],h=u.rings[0][1],g=u.rings[0][2],w=c.data.getIndices(d.VertexAttrConstants.POSITION),b=c.data.componentOffsets,I=c.data.getAttribute(d.VertexAttrConstants.POSITION),T=I.data,A=I.offsetIdx,_=I.strideIdx,U=b.length?b[e]:0,M=b.length?b[e+1]:w.length;switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":y=function(){return f(n,u)?0:2};break;case"contains":case"disjoint":case"within":default:y=function(){return f(n,u)?2:1}}for(var p=U;p<M;p+=3){var S=A+_*w[p+0],k=A+_*w[p+1],N=A+_*w[p+2];o.vec3.set(m,T[S+0],T[S+1],T[S+2]),o.vec3.set(h,T[k+0],T[k+1],T[k+2]),o.vec3.set(g,T[N+0],T[N+1],T[N+2]),o.vec3.transformMat4(m,m,a),o.vec3.transformMat4(h,h,a),o.vec3.transformMat4(g,g,a),l.vectorToVector(m,s,m,i),l.vectorToVector(h,s,h,i),l.vectorToVector(g,s,g,i);var P=h[0]-m[0],B=h[1]-m[1],O=g[0]-m[0],V=g[1]-m[1];if(!(Math.abs(P*V-B*O)<L))switch(delete u._geVersion,y()){case 1:return!1;case 0:return!0}}switch(r){case"intersects":case"crosses":case"envelope-intersects":case"index-intersects":case"overlaps":case"touches":return!1;case"contains":case"disjoint":case"within":default:return!0}}Object.defineProperty(t,"__esModule",{value:!0});var N=new Uint8Array(64);t.interleaveGeometryBuffer=v,t.processAndInterleaveNormals=b,t.computeCompressedNormals=I;var P=65536;t.extractPositionData=A;var B;t.isGeometryEngineLoaded=_,t.loadGeometryEngine=U,t.acquireMaskFilterContext=M,t.getIntersectRelation=R,t.intersectMaskWithMbs=S;var L=Math.pow(2,-32);t.filterMask=k;var Y=c.create(),O=i.vec3f32.create(),V=s.vec2f32.create()});