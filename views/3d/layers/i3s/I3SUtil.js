// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../request","../../../../core/arrayUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/quat","../../../../core/libs/gl-matrix-2/quatf32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/webMercatorUtils","../../../../tasks/QueryTask","../../../../tasks/support/Query","./I3SBinaryReader","../../support/projectionUtils","../../support/stack"],function(e,r,t,n,a,o,i,l,u,s,c,f,h,p,d,g,m,v,y,b,S,w){function x(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function R(e,t){if(t)for(var n=0;n<e.length;n++)if(e[n].encoding===r.DDS_ENCODING_STRING)return e[n];for(var n=0;n<e.length;n++)if(r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[n].encoding)>-1)return e[n];return null}function I(e,r,t,n,a,o){a.traverse(t,function(t){var a=t.mbs;r!==n&&(a=ne,S.mbsToMbs(t.mbs,n,a,r));var i=T(e,a);if(0!==i)return o(t,i),!0})}function C(e,r,t){for(var n=0,a=0,o=0;o<r.length&&n<e.length;o++)e[n]===r[o]&&(t(o)&&(e[a]=e[n],a++),n++);e.length=a}function M(e,r){var t=u.mat4.copy(w.sm4d.get(),r.objectTransformation),n=r.geometryRecords[0].getShaderTransformation();if(u.mat4.multiply(t,t,n),0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&0===t[11]&&1===t[15])return te[0]=(e[0]-t[12])/t[0],te[1]=(e[1]-t[13])/t[5],te[2]=(e[2]-t[14])/t[10],te[3]=(e[3]-t[12])/t[0],te[4]=(e[4]-t[13])/t[5],te[5]=(e[5]-t[14])/t[10],te}function T(e,r){var t=r[0],n=r[1],a=r[2],o=r[3],i=e[0]-t,l=t-e[3],u=e[1]-n,s=n-e[4],c=e[2]-a,f=a-e[5],h=Math.max(i,l,0),p=Math.max(u,s,0),d=Math.max(c,f,0),g=h*h+p*p+d*d;return g>o*o?0:g>0?1:-Math.max(i,l,u,s,c,f)>o?3:2}function q(e,r,t){for(var n=[],a=t&&t.missingFields,o=t&&t.originalFields,i=0,l=e;i<l.length;i++){for(var u=l[i],s=u.toLowerCase(),c=!1,f=0,h=r;f<h.length;f++){var p=h[f];if(s===p.name.toLowerCase()){n.push(p.name),c=!0,o&&o.push(u);break}}!c&&a&&a.push(u)}return n}function A(e,r,t,o,l,u){var s=!0===(u&&u.populateObjectId),c=u.ignoreUnavailableFields?void 0:[],f=1===o.length&&"*"===o[0];!f&&s&&(o=k(o,t));var h=f?o:q(o,e.fields,{missingFields:c});if(c&&0!==c.length)return i.reject(new a("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:c}));if(0===r.length)return i.resolve(r);var p=e.associatedLayer,d=e.attributeStorageInfo,g=f?e.fields.map(function(e){return e.name}):h;if(p)return E(p,r,t,g);var m=G(g,r[0]);if(0===m.length)return i.resolve(r);if(d){var v=l(r);if(!v)return i.reject(new a("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var y=e.parsedUrl.path;return i.all(v.map(function(e){return N(y,d,e.node,e.indices,m,u).then(function(r){for(var t=0;t<e.graphics.length;t++){var n=e.graphics[t],a=r[t];for(var o in n.attributes)o in a||(a[o]=n.attributes[o]);n.attributes=a}return e.graphics})})).then(n.flatten)}return i.reject(new a("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))}function k(e,r){return e.filter(function(e){return e.toLowerCase()!==r.toLowerCase()}).concat([r])}function E(e,r,t,n){r.sort(function(e,r){return e.attributes[t]-r.attributes[t]});var a=r.map(function(e){return e.attributes[t]}),o=[],i=q(n,e.fields,{originalFields:o});return F(e,a,i).then(function(e){for(var t=0;t<r.length;t++){var n=r[t],a=e[t],l={};for(var u in n.attributes)l[u]=n.attributes[u];for(var s=0;s<o.length;s++)l[o[s]]=a[i[s]];n.attributes=l}return r})}function G(e,r){for(var t=[],n=0,a=e;n<a.length;n++){var o=a[n];o in r.attributes||t.push(o)}return t}function F(e,r,t){if(null!=e.maxRecordCount&&r.length>e.maxRecordCount){var n=j(r,e.maxRecordCount);return i.all(n.map(function(r){return F(e,r,t)})).then(_)}var o=new y({objectIds:r,outFields:t,orderByFields:[e.objectIdField]});return new v(e.parsedUrl.path).execute(o).then(function(e){return e&&e.features&&e.features.length===r.length?e.features.map(function(e){return e.attributes}):i.reject(new a("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function N(e,r,n,o,l,u){for(var s=[],c=0,f=r;c<f.length;c++){var h=f[c];if(h&&-1!==l.indexOf(h.name)){var p=e+"/nodes/"+n.resources.attributes+"/attributes/"+h.key+"/0";s.push({url:p,storageInfo:h})}}return i.eachAlways(s.map(function(e){return t(e.url,{responseType:"array-buffer"}).then(function(r){return b.readBinaryAttribute(e.storageInfo,r.data)})})).then(function(e){var r=[];if(!u.ignoreUnavailableFields&&e.some(function(e){return null==e.value})){for(var t=[],n=0;n<e.length;n++)null==e[n].value&&t.push({name:s[n].storageInfo.name,error:e[n].error});return i.reject(new a("scenelayer:attribute-request-failed","Request for scene layer attributes failed",{failedAttributes:t}))}for(var l=0,c=o;l<c.length;l++){for(var f=c[l],h={},n=0;n<e.length;n++)null!=e[n].value&&(h[s[n].storageInfo.name]=O(e[n].value,f));r.push(h)}return r})}function O(e,r){if(!e)return null;var t=e[r];return l.isInt16Array(e)?t===ae?null:t:l.isInt32Array(e)?t===oe?null:t:t!==t?null:t}function j(e,r){for(var t=e.length,n=Math.ceil(t/r),a=[],o=0;o<n;o++){var i=Math.floor(t*o/n),l=Math.floor(t*(o+1)/n);a.push(e.slice(i,l))}return a}function _(e){for(var r=[],t=0,n=e;t<n.length;t++){var a=n[t];r=r.concat(a)}return r}function L(e,r,t){for(var n=null!=r?r:e.length/t,o=new Uint32Array(n+1),i=0;i<n;i++){var l=e[i*t],u=3*l;o[i]=u;var s=(i-1)*t+1;if(s>=0&&l-1!==e[s])throw new a("Face ranges are not continuous")}var c=e[(n-1)*t+1],f=3*(c+1);return o[o.length-1]=f,o}function B(e){var r=new d(x(e.store.indexCRS||e.store.geographicCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function U(e){var r=new d(x(e.store.vertexCRS||e.store.projectedCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function P(e,r){return r===S.SphericalECEFSpatialReference?"@ECEF":e.equals(r)?"":null!=r.wkid?"@"+r.wkid:null}function D(e,r,t){if(!m.canProject(e,r))throw new a("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===t&&e.isGeographic)throw new a("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function W(e,r,t){var n=B(e),a=U(e);D(n,r,t),D(a,r,t)}function V(e){return(null==e.geometryType||"triangles"===e.geometryType)&&((null==e.topology||"PerAttributeArray"===e.topology)&&(null!=e.vertexAttributes&&null!=e.vertexAttributes.position))}function z(e){if(null==e.store||null==e.store.defaultGeometrySchema||!V(e.store.defaultGeometrySchema))throw new a("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})}function Q(e,r){W(e,r.spatialReference,r.viewingMode)}function K(e){return null!=e.geometryType&&"points"===e.geometryType&&((null==e.topology||"PerAttributeArray"===e.topology)&&((null==e.encoding||""===e.encoding||"lepcc-xyz"===e.encoding)&&(null!=e.vertexAttributes&&null!=e.vertexAttributes.position)))}function H(e){if(null==e.store||null==e.store.defaultGeometrySchema||!K(e.store.defaultGeometrySchema))throw new a("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function J(e,r){D(e.spatialReference,r.spatialReference,r.viewingMode)}function X(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}function Y(e){return"mesh-3d"===e.type}function Z(e){if(null==e||!X(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var r=e.getSymbols();if(0===r.length)return!0;for(var t=0,n=r;t<n.length;t++){var a=n[t];if(!Y(a)||0===a.symbolLayers.length)return!0;for(var i=0,l=a.symbolLayers.items;i<l.length;i++){var u=l[i];if("fill"!==u.type||o.isNone(u.material)||o.isNone(u.material.color)||"replace"!==u.material.colorMixMode)return!0}}return!1}function $(e){for(var r=new ie,t=!1,n=!1,a=0,i=e.symbolLayers.items;a<i.length;a++){var l=i[a];if("fill"===l.type&&l.enabled){var u=l.material,s=l.edges;if(o.isSome(u)&&!t){var c=u.color,f=u.colorMixMode;o.isSome(c)?r.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:f}:r.material={color:[1,1,1],alpha:1,colorMixMode:"multiply"},r.castShadows=l.castShadows,t=!0}o.isSome(s)&&!n&&(r.edges=s,n=!0)}}return r.material||(r.material={color:[1,1,1],alpha:1,colorMixMode:"multiply"}),r}function ee(e,r){return(0|e)+(0|r)|0}function re(e,r,t,n,a){if(void 0===a&&(a=0),h.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+a),r.isGeographic||n!==S.SphericalECEFSpatialReference)c.quat.copy(t.quaternion,e.quaternion),h.vec3.copy(t.halfSize,e.halfSize);else{S.computeLinearTransformation(r,t.center,le,n);var o=2*Math.sqrt(1+le[0]+le[5]+le[10]);ue[0]=(le[6]-le[9])/o,ue[1]=(le[8]-le[2])/o,ue[2]=(le[1]-le[4])/o,ue[3]=.25*o,c.quat.multiply(t.quaternion,ue,e.quaternion),h.vec3.copy(t.halfSize,e.halfSize)}S.bufferToBuffer(t.center,r,0,t.center,n,0,1)}Object.defineProperty(r,"__esModule",{value:!0}),r.DDS_ENCODING_STRING="image/vnd-ms.dds",r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],r.extractWkid=x,r.selectEncoding=R,r.findIntersectingNodes=I,r.filterInPlace=C;var te=g.create();r.getClipAABB=M;var ne=p.vec4f64.create();r.intersectBoundingBoxWithMbs=T,r.findFieldsCaseInsensitive=q,r.whenGraphicAttributes=A;var ae=-Math.pow(2,15),oe=-Math.pow(2,31);r.getCachedAttributeValue=O,r.convertFlatRangesToOffsets=L,r.getIndexCrs=B,r.getVertexCrs=U,r.getCacheKeySuffix=P,r.checkSpatialReference=D,r.checkSpatialReferences=W,r.checkSceneLayerValid=z,r.checkSceneLayerCompatibleWithView=Q,r.checkPointCloudLayerValid=H,r.checkPointCloudLayerCompatibleWithView=J,r.rendererNeedsTextures=Z;var ie=function(){function e(){this.edges=null,this.material=null,this.castShadows=!0}return e}();r.SymbolInfo=ie,r.getSymbolInfo=$,r.addWraparound=ee,r.transformObb=re;var le=s.mat4f64.create(),ue=f.quatf32.create()});