// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f32","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../geometry/support/aaBoundingBox","./PointHighlights","../../support/geometryUtils","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/lib/ComponentUtils","../../webgl-engine/lib/intersectorUtils","../../webgl-engine/lib/ProgramRepository","../../webgl-engine/materials/internal/MaterialUtil","../../webgl-engine/shaders/PointRendererPrograms","../../../webgl/BufferObject","../../../webgl/renderState","../../../webgl/VertexArrayObject"],function(e,t,i,r,n,s,o,a,l,h,c,u,p,d,g,m,f,_,v,P,b,S,x){function y(e){return e?256:64}function z(e,t,i,r,n){if(i.drawScreenSpace)return i.fixedSize*t*r;var s=y(n)*t*r;return i.drawFixedSize?Math.min(i.fixedSize/2,s):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*r,e/2),s):Math.min(e/2,s)}function R(e,t,i,r,n){return i.drawScreenSpace?0:z(e,t,i,r,n)}function w(e,t,i){return null==i&&(i=l.vec3f64.create()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}Object.defineProperty(t,"__esModule",{value:!0});var H=s.mat4f64.create(),M={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]},E=function(){function e(e){var t=this;this._params=e,this._highlights=new u.PointHighlights({forEachNode:function(e){return t.forEachNode(e)},addHighlight:function(e,i,r,n){return t.addHighlight(e,i,r,n)},removeHighlight:function(e,i){return t.removeHighlight(e,i)}}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=c.create(c.POSITIVE_INFINITY),this._programRep=null,this._recreatePrograms=!0,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this._programWorldHighlight=null,this._programScreenHighlight=null,this.tempMatrix4=n.mat4f32.create(),this.tempVec3=a.vec3f32.create(),this.nodes=[]}return Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!0,configurable:!0}),e.prototype.initializeRenderContext=function(e){this._initContext=e;var t=e.rctx;this._programRep=new _(t),e.requestRender(),this._recreatePrograms=!0},e.prototype.uninitializeRenderContext=function(e){this._programRep.dispose(),this._programRep=null,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this._programWorldHighlight=null,this._programScreenHighlight=null},e.prototype.intersect=function(e,t,i,r){var n=this,s=l.vec3f64.create(),a=l.vec3f64.create(),u=l.vec3f64.create(),m=l.vec3f64.create(),_=d.plane.create(),v=e.camera.perScreenPixelRatio/2,P=e.camera.near,b=this._getSizeParams();o.vec3.subtract(a,r,i);var S=1/o.vec3.length(a);o.vec3.scale(a,a,S),o.vec3.negate(u,a),h.vec4.set(_,a[0],a[1],a[2],-o.vec3.dot(a,i));var x=function(){function e(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}return e}(),y=new x,M=new x,E=[],F=c.create(),U=c.create(this._clipBox);c.offset(U,-i[0],-i[1],-i[2],U);for(var I=this,W=0,O=this.nodes;W<O.length;W++){var q=O[W];!function(l){var h=l.splatSize*I._scaleFactor,p=g.minimumDistancePlane(l.obb,_),d=g.maximumDistancePlane(l.obb,_);p-=R(h,p+P,b,v,l.isLeaf),d-=R(h,d+P,b,v,l.isLeaf);var f=d<0,H=null!=y.dist&&null!=M.dist&&y.dist<p*S&&M.dist>d*S;if(f||H)return"continue";var W=z(h,d+P,b,v,l.isLeaf);if(!g.intersectLine(l.obb,i,a,W))return"continue";var O=W*W;g.toAaBoundingBox(l.obb,F),c.offset(F,-i[0],-i[1],-i[2],F);var q=!c.contains(U,F);o.vec3.subtract(m,l.origin,i);for(var V=l.coordinates.length/3,j=0;j<V;j++)!function(p){if(s[0]=m[0]+l.coordinates[3*p],s[1]=m[1]+l.coordinates[3*p+1],s[2]=m[2]+l.coordinates[3*p+2],q&&!c.containsPoint(U,s))return"continue";var d=o.vec3.dot(s,a),g=o.vec3.squaredLength(s)-d*d;if(g>O)return"continue";var f=d+P,_=R(h,f,b,v,l.isLeaf);if(d-_<0)return"continue";f-=_;var H=z(h,f,b,v,l.isLeaf);if(g>H*H)return"continue";var F=(d-_)*S,I=function(e){e.point=w(l,p,e.point),e.dist=F,e.normal=u,e.node=l,e.pointId=p,e.layerUid=n.layerUid};if((null==y.dist||F<y.dist)&&(null==t||t(i,r,F))&&I(y),(null==M.dist||F>M.dist)&&(null==t||t(i,r,F))&&I(M),(null==t||t(i,r,F))&&e.enable.storeAll){var W=new x;I(W),E.push(W)}}(j)}(q)}var V=function(e){var t=e.layerUid,i=e.node,r=e.pointId;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:function(){return n._params.createGraphic(i,r,e.point)}}}},j=function(e,t){var i=V(t),r=t.layerUid+"/"+t.node.id+"/"+t.pointId;e.set(i,r,t.dist,t.normal,H,void 0),e.intersector="PointRenderer"};if(null!=y.dist){var N=e.results.min;(null==N.dist||y.dist<N.dist)&&j(N,y)}if(null!=M.dist){var D=e.results.max;(null==D.dist||M.dist>D.dist)&&j(D,M)}if(e.enable.storeAll)for(var B=p.ray.fromPoints(i,r),C=0,A=E;C<A.length;C++){var T=A[C],L=new f.IntersectorResult(B);j(L,T),e.results.all.push(L)}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass&&4!==e.pass)return!1;for(var t=1===e.pass,i=e.rctx,n=0,s=this.nodes;n<s.length;n++){var a=s[n];null==a.vao&&this._initNode(e,a)}this._ensurePrograms();var l=this._getSizeParams(),h=this._selectProgram(e.pass,l);if(null==h||0===this.nodes.length)return!0;var u=this._clipBox,p=!c.equals(u,c.POSITIVE_INFINITY,function(e,t){return e===t});if(p||(o.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),h.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,1/0,1/0,1/0),h.setUniform3fv("uClipMax",this.tempVec3)),i.bindProgram(h),i.setPipelineState(this._pipelineState),h.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&h.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass){var d={viewport:e.camera.fullViewport,highlightDepthTexture:e.highlightDepthTexture};v.bindHighlightRendering(i,d,h)}var g=e.camera.pixelRatio;l.drawFixedSize&&h.setUniform2f("uPointScale",l.fixedSize*g,e.camera.fullHeight);for(var m=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,f=0,_=this.nodes;f<_.length;f++){var a=_[f];if(0!==a.coordinates.length&&(!e.isHighlightPass||a.highlights)){if(h.setUniform2f("uScreenMinMaxSize",l.screenMinSize*g,y(a.isLeaf)*g),!l.drawFixedSize){var P=a.splatSize*this._scaleFactor;h.setUniform2f("uPointScale",P*g,e.camera.fullHeight/g)}var b=a.origin;p&&(o.vec3.set(this.tempVec3,u[0]-b[0],u[1]-b[1],u[2]-b[2]),h.setUniform3fv("uClipMin",this.tempVec3),o.vec3.set(this.tempVec3,u[3]-b[0],u[4]-b[1],u[5]-b[2]),h.setUniform3fv("uClipMax",this.tempVec3)),r.mat4.identity(this.tempMatrix4),r.mat4.translate(this.tempMatrix4,this.tempMatrix4,b),r.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),h.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),m&&v.bindSlicePlane(b,m,h),i.bindVAO(a.vao),e.isHighlightPass?this._renderHighlightFragments(i,a):i.drawArrays(0,0,a.coordinates.length/3)}}return!0},e.prototype._renderHighlightFragments=function(e,t){var r=t.highlights;if(r){for(var n=i.unwrap(r[0].component),s=n+1,o=1;o<r.length;o++){var a=i.unwrap(r[o].component);if(a!==s){var l=s-n;l>0&&e.drawArrays(0,n,l),n=a}s=a+1}var h=s-n;h>0&&e.drawArrays(0,n,h)}},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){c.set(this._clipBox,e||c.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender(),this._recreatePrograms=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},e.prototype.removeNode=function(e){var t=this,i=null;return this.nodes=this.nodes.filter(function(r){return r.id!==e||(i=r,r.vao&&(r.vao.dispose(!0),r.vao=null),t._highlights.nodeRemoved(r),!1)}),this._requestRender(),i},e.prototype.forEachNode=function(e){this.nodes.forEach(e)},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this._highlights.removeAll(),this.nodes=[],this._requestRender()},e.prototype.highlight=function(e,t){return this._highlights.add(e,t)},e.prototype.addHighlight=function(e,t,i,r){e.highlights=m.addHighlight(e.highlights,t,i,r),this._requestRender()},e.prototype.removeHighlight=function(e,t){e.highlights=m.removeHighlight(e.highlights,t),this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new x(i,P.program.attributes,M,{positions:b.createVertex(i,35044,t.coordinates),colors:b.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,r=this._minSizePx;return e&&(r=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:r}},e.prototype._selectProgram=function(e,t){var i=t.drawScreenSpace;switch(e){case 1:return i?this._programScreenDepth:this._programWorldDepth;case 4:return i?this._programScreenHighlight:this._programWorldHighlight;default:return i?this._programScreen:this._programWorld}},e.prototype._ensurePrograms=function(){this._recreatePrograms&&(this._recreatePrograms=!1,this._programWorld=this._programRep.getProgram(P.program,{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(P.program,{drawScreenSize:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(P.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(P.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldHighlight=this._programRep.getProgram(P.program,{highlightPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenHighlight=this._programRep.getProgram(P.program,{drawScreenSize:!0,highlightPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._pipelineState=S.makePipelineState({depthTest:{func:513},depthWrite:S.defaultDepthWriteParams,colorWrite:S.defaultColorWriteParams}))},e}();t.PointRenderer=E,function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(E=t.PointRenderer||(t.PointRenderer={})),t.PointRenderer=E});