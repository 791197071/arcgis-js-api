// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../libs/draco/DracoDecoder","./I3SBinaryReader","./I3SMaterialUtil","./I3SUtil"],function(e,t,r,n,i,o,a,s,u,l,d,f){function c(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&(e=o.clone(e),delete e.vertexAttributes.region),e}function m(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var n=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==n)return r;for(var o=0;o<n.length;o++)if(null==n[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=n[o];else if("draco"===n[o].compressedAttributes.encoding&&u.isSupported()&&!i("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=n[o],r;return r}function h(e){for(var t={},r=0,n=e;r<n.length;r++){var i=n[r];p[i]&&(t[p[i]]={valueType:null})}return{header:null,byteOffset:0,byteCount:0,vertexAttributes:t}}var g=function(){function e(e,t,r,n,i,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=i,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map(function(e){return d.getMaterialAndTextures(a,e)})}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(n,"binary",r).then(function(e){return l.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t,r){var n=this;return a.eachAlways(t.map(function(t){return n.loadAttribute(e,t.attributeStorageInfo,r)})).then(function(r){for(var i={},o=0;o<t.length;++o)r[o].value?i[t[o].name]=r[o].value:a.isAbortError(r[o].error)||n.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'");return i})},e.prototype.loadNodeData=function(e,t){return n(this,void 0,void 0,function(){var n,i,o,s,u,f,g,p,y,b,v,D,x,A,T,I,S,F,w,G,U;return r(this,function(r){switch(r.label){case 0:return n=null!=this.requiredAttributes&&e.resources.attributes?this.loadAttributes(e,this.requiredAttributes,t):a.resolve({}),i=m(this.geometryDefinitions,e),o=i.bufferDefinition,s=i.bufferIndex,u=e.resources.geometry?this.loadGeometry(e,s,t):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return g=r.sent(),[3,3];case 2:g=null,r.label=3;case 3:return f=g,p=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=f?d.getMaterialAndTexturesFromShared(f):null,y=p&&p.material,b=p&&p.textures,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return D=r.sent(),[3,6];case 5:D=null,r.label=6;case 6:return v=D,x=this.options.loadFeatureData?this.collectGeometries(v):this.meshPyramidGeometryData(e,y),A=null!=b&&b.length>0?this.loadTextures(e,b,t):null,T=null,I=null,u?[4,u]:[3,8];case 7:T=r.sent(),S=c(this.defaultGeometrySchema,f),F=!(!o||!o.compressedAttributes||"draco"!==o.compressedAttributes.encoding),I=F?h(o.compressedAttributes.attributes):o?l.createGeometryIndexFromDefinition(o,e.vertexCount,e.numFeatures):l.createGeometryIndexFromSchema(T,S),r.label=8;case 8:return[4,A];case 9:return w=r.sent(),[4,n];case 10:return G=r.sent(),U=G?{attributeData:G,loadedAttributes:this.requiredAttributes}:null,[2,{allGeometryData:x,attributeDataInfo:U,geometryBuffer:T,geometryIndex:I,requiredTextures:b,textureData:w}]}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var n=0,i=Object.keys(r);n<i.length;n++)for(var o=i[n],a=0,u=r[o].images;a<u.length;a++){var l=u[a];Array.isArray(l.href)?l.hrefConcat=l.href.map(function(e){return s.makeAbsolute(e,t)}):l.hrefConcat=s.makeAbsolute(l.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var n=t[r];if(Array.isArray(n.encoding))for(var i=0;i<n.encoding.length;i++){var o=n.encoding[i];"data:"===o.substring(0,5)&&(n.encoding[i]=o.substring(5))}else{var o=n.encoding;"data:"===o.substring(0,5)&&(n.encoding=o.substring(5))}}},e.prototype.loadShared=function(t,r){var n=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(n,"json",r).then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,n),t})},e.prototype.loadTexture=function(e,t,r,n,i,o){return i===f.DDS_ENCODING_STRING?this.load(e,"binary",o).then(function(e){return{id:t,usage:r,data:e,encoding:i}}):this.load(e,"image",o).then(function(e){var o=e;if(n&&e.width*e.height>=4096){var a=Math.ceil(e.width/2),s=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=a,u.height=s;u.getContext("2d").drawImage(e,0,0,a,s),o=u}return{id:t,usage:r,data:o,encoding:i}})},e.prototype.loadTextures=function(t,r,n){var i=this,o=this.options.textureFormat===e.TextureFormat.Compressed,s=this.options.textureFormat===e.TextureFormat.Downsampled,u=this.options.textureUsageMask;return a.all(r.map(function(e){if(0==(e.usage&u))return null;var r=f.selectEncoding(e.encodings,o);if(null==r)return i.logger.error("No known encoding for texture found on node "+t.id),a.reject();var l=t.resources.texture||t.id,d=i.layerUrl+"/nodes/"+l+"/textures/"+r.name;return i.loadTexture(d,e.id,e.usage,s,r.encoding,n)}))},e.prototype.meshPyramidGeometryData=function(e,t){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:t}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e){for(var t=new Array,r=0,n=e.featureData;r<n.length;r++){var i=n[r],o=i.geometries;if(null!=o)for(var a=0,s=o;a<s.length;a++){var u=s[a];t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:[u]})}else null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:null})}return t},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(n,"binary",r)},e}(),p={position:"position",normal:"normal",uv0:"uv0",uv1:"uv1",color:"color","uv-region":"region"};return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(g||(g={})),g});