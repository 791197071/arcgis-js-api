// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../libs/draco/DracoDecoder","./I3SBinaryReader","./I3SUtil","../../webgl-engine/lib/Util"],function(e,t,r,n,i,o,a,s,u,l,d,f,c){function m(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&(e=o.clone(e),delete e.vertexAttributes.region),e}function h(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var n=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==n)return r;for(var o=0;o<n.length;o++)if(null==n[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=n[o];else if("draco"===n[o].compressedAttributes.encoding&&l.isSupported()&&!i("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=n[o],r;return r}function g(e,t){var r=[];return t&&t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture&&function(t){var n=a.isSome(e)&&e[t]&&e[t].formats;n&&r.push({id:""+t,encodings:n.map(function(e){var t=e.name,r=e.format;return{name:t,encoding:v[r]}})})}(t.pbrMetallicRoughness.baseColorTexture.textureSetDefinitionId),r}function p(e,t){var r,n=g(e,t),i=n[0]&&n[0].id,o=a.isSome(e)&&e[i]&&e[i].atlas,s="opaque"!==t.alphaMode,u=i?(r={},r[i]={encoding:n[0].encodings.map(function(e){return e.encoding}),wrap:["none","none"],atlas:o,channels:s?"rgba":"rgb",images:[{id:i,size:0,href:n[0].encodings.map(function(e){return"../textures/"+e.name}),byteOffset:0,length:0}]},r):{},l=t.pbrMetallicRoughness,d=l&&l.baseColorFactor;return{textureDefinitions:u,materialDefinitions:{mat:{type:"standard",params:{diffuse:d?d.slice(0,3):[1,1,1],specular:[1,1,1,1],vertexRegions:o,doubleSided:t.doubleSided,cullFace:t.cullFace,transparency:d?1-d[3]:0,useVertexColorAlpha:s}}}}}function b(e){for(var t={},r=0,n=e;r<n.length;r++){var i=n[r];x[i]&&(t[x[i]]={valueType:null})}return{header:null,byteOffset:0,byteCount:0,vertexAttributes:t}}var y=function(){function e(e,t,r,n,i,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=i,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialTextures=e.materialDefinitions.map(function(e){return g(a,e)}),this.materialShared=e.materialDefinitions.map(function(e){return p(a,e)})}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(n,"binary",r).then(function(e){return d.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t,r){var n=this;return s.eachAlways(t.map(function(t){return n.loadAttribute(e,t.attributeStorageInfo,r)})).then(function(r){for(var i={},o=0;o<t.length;++o)r[o].value?i[t[o].name]=r[o].value:s.isAbortError(r[o].error)||n.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'");return i})},e.prototype.loadNodeData=function(e,t){return n(this,void 0,void 0,function(){var n,i,o,a,u,l,f,c,g,p,y,v,x,D,A,T,S,I,F;return r(this,function(r){switch(r.label){case 0:return n=null!=this.requiredAttributes&&e.resources.attributes?this.loadAttributes(e,this.requiredAttributes,t):s.resolve({}),i=h(this.geometryDefinitions,e),o=i.bufferDefinition,a=i.bufferIndex,u=e.resources.geometry?this.loadGeometry(e,a,t):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return f=r.sent(),[3,3];case 2:f=this.materialShared&&e.resources.materialDefinition>=0?this.materialShared[e.resources.materialDefinition]:null,r.label=3;case 3:return l=f,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return g=r.sent(),[3,6];case 5:g=null,r.label=6;case 6:return c=g,p=this.options.loadFeatureData?this.collectGeometries(c):this.meshPyramidGeometryData(e,l),y=this.materialTextures&&e.resources.materialDefinition>=0?this.materialTextures[e.resources.materialDefinition]:this.getRequiredTexturesFromShared(p,l),v=this.options.loadTextureData?this.loadTextures(e,y,t):null,x=null,D=null,u?[4,u]:[3,8];case 7:x=r.sent(),A=m(this.defaultGeometrySchema,l),T=!(!o||!o.compressedAttributes||"draco"!==o.compressedAttributes.encoding),D=T?b(o.compressedAttributes.attributes):o?d.createGeometryIndexFromDefinition(o,e.vertexCount,e.numFeatures):d.createGeometryIndexFromSchema(x,A),r.label=8;case 8:return[4,v];case 9:return S=r.sent(),[4,n];case 10:return I=r.sent(),F=null,I&&(F={attributeData:I,loadedAttributes:this.requiredAttributes}),[2,{allGeometryData:p,attributeDataInfo:F,geometryBuffer:x,geometryIndex:D,sharedResource:l,requiredTextures:y,textureData:S}]}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var n=0,i=Object.keys(r);n<i.length;n++)for(var o=i[n],a=0,s=r[o].images;a<s.length;a++){var l=s[a];Array.isArray(l.href)?l.hrefConcat=l.href.map(function(e){return u.makeAbsolute(e,t)}):l.hrefConcat=u.makeAbsolute(l.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var n=t[r];if(Array.isArray(n.encoding))for(var i=0;i<n.encoding.length;i++){var o=n.encoding[i];"data:"===o.substring(0,5)&&(n.encoding[i]=o.substring(5))}else{var o=n.encoding;"data:"===o.substring(0,5)&&(n.encoding=o.substring(5))}}},e.prototype.loadShared=function(t,r){var n=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(n,"json",r).then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,n),t})},e.prototype.loadTexture=function(e,t,r,n,i){return n===f.DDS_ENCODING_STRING?this.load(e,"binary",i).then(function(e){return{i3sTexId:t,data:e,encoding:n}}):this.load(e,"image",i).then(function(e){var i=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),a=Math.ceil(e.height/2),s=document.createElement("canvas");s.width=o,s.height=a;s.getContext("2d").drawImage(e,0,0,o,a),i=s}return{i3sTexId:t,data:i,encoding:n}})},e.prototype.loadTextures=function(t,r,n){var i=this,o=this.options.textureFormat===e.TextureFormat.Compressed,a=this.options.textureFormat===e.TextureFormat.Downsampled;return s.all(r.map(function(e){var r=f.selectEncoding(e.encodings,o);if(null==r)return i.logger.error("No known encoding for texture found on node "+t.id),s.reject();var u=t.resources.texture||t.id,l=i.layerUrl+"/nodes/"+u+"/textures/"+r.name;return i.loadTexture(l,e.id,a,r.encoding,n)}))},e.prototype.getRequiredTexturesFromShared=function(e,t){for(var r=[],n=0;n<e.length;n++){var i=e[n].geometries;if(null!=i)for(var o=this,a=0,s=i;a<s.length;a++){var u=s[a];!function(e){var n=e.params.textureID||"none";if("none"!==n){null!=t.textureDefinitions&&null!=t.textureDefinitions[n]||o.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+n);var i=t.textureDefinitions[n];if(c.assert(void 0!==i,"geometry wants unknown texture "+n),0===i.images.length)return"continue";var a=i.images.length-1,s=i.images[a],u=function(e){return e&&e.split("/").pop()},l=Array.isArray(i.encoding)?i.encoding.map(function(e,t){return{name:u(s.href[t]),encoding:e}}):[{name:u(s.href),encoding:i.encoding}];r.push({id:n,encodings:l})}}(u)}}return r},e.prototype.meshPyramidGeometryData=function(e,t){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:t&&t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,textureID:t&&t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e){for(var t=new Array,r=0,n=e.featureData;r<n.length;r++){var i=n[r],o=i.geometries;if(null!=o)for(var a=0,s=o;a<s.length;a++){var u=s[a];t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:[u]})}else null!=i.position&&t.push({featureIds:[i.id],featureDataPosition:i.position,geometries:null})}return t},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var n=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(n,"binary",r)},e}(),v={jpg:"image/jpeg",png:"image/png",dds:"image/vnd-ms.dds","ktx-etc2":"image/ktx"},x={position:"position",normal:"normal",uv0:"uv0",uv1:"uv1",color:"color","uv-region":"region"};return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(y||(y={})),y});