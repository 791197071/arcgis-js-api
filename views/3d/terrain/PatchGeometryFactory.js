// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../support/earthUtils","../support/buffer/BufferPool","../support/buffer/InterleavedLayout","./ElevationData","./TerrainConst","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil"],function(e,r,t,n,a,o,i,u,f,s,c,v,m,l){function g(){S.clear(),V.clear()}function p(e){S.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}function I(e,r,n,a,f,s,m){var l=f[0],g=f[1],p=f[2],I=f[3],E=.1*u.earthRadius*(I-g),y=e.numVertsPerRow-1,P=e.numVertsPerRow-1,T=e.numVertsPerRow*e.numVertsPerRow,h=2*y+2*P,M=S.acquire(T+h),V=M.position.typedBuffer,_=M.uv0.typedBuffer,D=a.geometryInfo.boundingBox;i.empty(D);for(var C=r[2]-r[0],L=r[3]-r[1],X=p-l,k=n[0],G=n[1],U=n[2],N=0;N<=y;N++){var H=N/y,Y=l+H*X;b[N]=Math.sin(Y),x[N]=Math.cos(Y),O[N]=H,B[N]=r[0]+H*C}for(var q=s&&!!(1&m),j=s&&!!(2&m),W=0,z=0;z<=P;z++){var F=z/P,J=t.lerp(g,I,F),K=Math.cos(J),Q=Math.sin(J),Z=void 0;s?(Z=u.halfEarthRadius*Math.log((1+Q)/(1-Q)),F=(Z-r[1])/L):Z=180*J/Math.PI;for(var N=0;N<=y;N++){var H=O[N],$=b[N],ee=x[N],re=u.earthRadius;e.samplerData&&(re+=c.sample(B[N],Z,e.samplerData)||0);var te=ee*K*re,ne=$*K*re,ae=Q*re,oe=te-k,ie=ne-G,ue=ae-U;d(oe,ie,ue,D);var fe=v.GEOMETRY_VERTEX_STRIDE*W;V[fe+0]=oe,V[fe+1]=ie,V[fe+2]=ue,_[fe+0]=H,_[fe+1]=F;var se=A(N,z,y,P);if(se>-1){var ce=v.GEOMETRY_VERTEX_STRIDE*(T+se),ve=q&&0===z?-1:j&&z===P?1:0,me=0===ve?oe:-k,le=0===ve?ie:-G,ge=0===ve?ue:u.earthRadius*ve-U;V[ce+0]=me,V[ce+1]=le,V[ce+2]=ge,_[ce+0]=0===ve?w(H,F):H,_[ce+1]=0===ve?E:F,0!==ve&&d(me,le,ge,D)}++W}}a.geometryInfo.numVertsPerRow=e.numVertsPerRow,a.geometryInfo.vertexAttributes=M,a.geometryInfo.skirtLength=E,o.vec4.set(a.geometryInfo.uvOffsetAndScale,0,0,1,1),R(a.geometryInfo,e.numVertsPerRow,s?m:0,e.wireframe)}function E(e,r,t,n){var a=r[0],u=r[1],f=r[2]-a,s=r[3]-u,m=e.clippingArea,l=m?Math.max(0,(m[0]-r[0])/f):0,g=m?Math.max(0,(m[1]-r[1])/s):0,p=m?Math.min(1,(m[2]-r[0])/f):1,I=m?Math.min(1,(m[3]-r[1])/s):1,E=p>l?1/(p-l):1,y=I>g?1/(I-g):1,P=-l*E,T=-g*y,h=.1*f,M=e.numVertsPerRow-1,V=e.numVertsPerRow-1,_=e.numVertsPerRow*e.numVertsPerRow,b=2*M+2*V,x=S.acquire(_+b),O=x.position.typedBuffer,B=x.uv0.typedBuffer,D=n.geometryInfo.boundingBox;i.empty(D);for(var C=0,L=0;L<=V;L++){var X=L/V,k=T+X*y,G=u+X*s;m&&(G<m[1]?(G=m[1],k=0):G>m[3]&&(G=m[3],k=1));for(var U=0;U<=M;U++){var N=U/M,H=P+N*E,Y=a+N*f;m&&(Y<m[0]?(Y=m[0],H=0):Y>m[2]&&(Y=m[2],H=1));var q=e.samplerData?c.sample(Y,G,e.samplerData)||0:0,j=Y-t[0],W=G-t[1],z=q-t[2];d(j,W,z,D);var F=v.GEOMETRY_VERTEX_STRIDE*C;O[F+0]=j,O[F+1]=W,O[F+2]=z,B[F+0]=H,B[F+1]=k;var J=A(U,L,M,M);if(J>-1){var K=v.GEOMETRY_VERTEX_STRIDE*(_+J);O[K+0]=j,O[K+1]=W,O[K+2]=z,B[K+0]=w(H,k),B[K+1]=h}++C}}n.geometryInfo.numVertsPerRow=e.numVertsPerRow,n.geometryInfo.vertexAttributes=x,n.geometryInfo.skirtLength=h,o.vec4.set(n.geometryInfo.uvOffsetAndScale,l,g,p-l,I-g),R(n.geometryInfo,e.numVertsPerRow,0,e.wireframe)}function R(e,r,t,n){var a=(2&t)>0,o=r+(n?1024:0)+(a?2048:0),i=V.get(o);i||(i=y(r,a,n),V.set(o,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(t?6*(r-1)*(n?2:1):0)}function y(e,r,t){var n=e-1,a=e-1,o=e*e,i=2*n+2*a,u=n*a*2*3,f=6*i,s=6*(2*n+a-1);t&&(u*=2,f*=2,s*=2);for(var c,v,m,l,g=o+i>M?new Uint32Array(u+f):new Uint16Array(u+f),p=0,I=0,E=u,R=0,y=0;y<=a;y++){r&&(R=0===y?s:y===a?-s:0),E+=R;for(var d=0;d<=n;d++){var w=A(d,y,n,a);if(w>-1){var T=P(d,y,n,a);0!==T&&(c=p,v=o+w,m=o+(0===d&&1===y?0:w+1),l=p+T,t?(g[E+0]=c,g[E+1]=v,g[E+2]=v,g[E+3]=m,g[E+4]=m,g[E+5]=c,g[E+6]=m,g[E+7]=l,g[E+8]=l,g[E+9]=c,g[E+10]=c,g[E+11]=m,E+=12):(g[E+0]=c,g[E+1]=v,g[E+2]=m,g[E+3]=m,g[E+4]=l,g[E+5]=c,E+=6))}++p,d<n&&y<a&&(c=y*(n+1)+d,v=c+1,m=v+(n+1),l=m-1,t?(g[I+0]=c,g[I+1]=v,g[I+2]=v,g[I+3]=m,g[I+4]=m,g[I+5]=c,g[I+6]=m,g[I+7]=l,g[I+8]=l,g[I+9]=c,g[I+10]=c,g[I+11]=m,I+=12):(g[I+0]=c,g[I+1]=v,g[I+2]=m,g[I+3]=m,g[I+4]=l,g[I+5]=c,I+=6))}E-=R}return{values:g,numSurfaceIndices:u,numSkirtIndices:f}}function d(e,r,t,n){e<n[0]&&(n[0]=e),e>n[3]&&(n[3]=e),r<n[1]&&(n[1]=r),r>n[4]&&(n[4]=r),t<n[2]&&(n[2]=t),t>n[5]&&(n[5]=t)}function w(e,r){var t=r>e?1:0;return 2+4*t+(1-2*t)*(e+r)}function A(e,r,t,n){return 0===r?e:e===t?t+r:r===n?t+n+(t-e):0===e&&r>0?2*t+n+(n-r):-1}function P(e,r,t,n){return 0===r&&e!==t?1:e===t&&r!==n?t+1:r===n&&0!==e?-1:0===e&&0!==r?-(t+1):0}function T(e,r,t,a,o,i,u,f){for(var s=i.position,c=i.uv0,v=e[0],m=e[1],g=e[2],p=r[0],I=r[1],E=r[2],R=p-v,y=I-m,d=E-g,w=t;w<a;w++){var A=3*w,P=3*w+1,T=3*w+2,h=s.get(o[A],0),S=s.get(o[A],1),M=s.get(o[A],2),V=s.get(o[P],0),b=s.get(o[P],1),x=s.get(o[P],2),O=s.get(o[T],0),B=s.get(o[T],1),L=s.get(o[T],2),X=c.get(o[A],0),k=c.get(o[P],0),G=c.get(o[T],0);X>=2&&(n.vec3.set(D,h,S,M),u(D),h+=D[0],S+=D[1],M+=D[2]),k>=2&&(n.vec3.set(D,V,b,x),u(D),V+=D[0],b+=D[1],x+=D[2]),G>=2&&(n.vec3.set(D,O,B,L),u(D),O+=D[0],B+=D[1],L+=D[2]);var U=V-h,N=b-S,H=x-M,Y=O-h,q=B-S,j=L-M,W=y*j-q*d,z=d*Y-j*R,F=R*q-Y*y,J=U*W+N*z+H*F,K=v-h,Q=m-S,Z=g-M,$=Q*H-N*Z,ee=Z*U-H*K,re=K*N-U*Q;if(J>_){var te=K*W+Q*z+Z*F;if(te<0||te>J)continue;var ne=R*$+y*ee+d*re;if(ne<0||te+ne>J)continue}else{if(!(J<-_))continue;var te=K*W+Q*z+Z*F;if(te>0||te<J)continue;var ne=R*$+y*ee+d*re;if(ne>0||te+ne<J)continue}var ae=(Y*$+q*ee+j*re)/J;if(ae>=0){f(ae,l.computeNormal(U,N,H,Y,q,j,C),w)}}}Object.defineProperty(r,"__esModule",{value:!0});var h=s.newLayout().vec3f(m.VertexAttrConstants.POSITION).vec2f(m.VertexAttrConstants.UV0),S=new f.BufferPool(function(e){return h.createBuffer(e)},function(e){return e.count});r.clearCaches=g,r.releaseGeometry=p;var M=65536;r.createSphericalGlobePatch=I,r.createPlanarGlobePatch=E;var V=new Map,_=Math.pow(2,-52);r.intersectSkirts=T;var b=new Array(v.MAX_PATCH_TESSELATION+1),x=new Array(v.MAX_PATCH_TESSELATION+1),O=new Array(v.MAX_PATCH_TESSELATION+1),B=new Array(v.MAX_PATCH_TESSELATION+1),D=a.vec3f64.create(),C=a.vec3f64.create()});