// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec4","../../2d/engine/vectorTiles/tileRendererHelper3D","../../2d/engine/vectorTiles/VectorTileDisplayObject","./terrainUtils","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../webgl-engine/shaders/MiscPrograms","../../webgl/FramebufferObject","../../webgl/renderState","../../webgl/Texture","../../webgl/Util"],function(e,t,r,a,i,n,o,s,l,c,u,d,f,p,h,y){function x(e){var t=e&&e.sourceLayerInfo&&e.sourceLayerInfo.data;return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement}function _(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof s}function b(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof h}function g(e){var t=r.nextHighestPowerOfTwo(e),a=t*t,i=e*e;if(a===i)return e;var n=t/2;return a-i<i-n*n?t:n}function m(e,t,r){var i=e.layerInfo[1][t];if(r.layerIndex=t,i.data)return a.vec2.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;if(!i.upsampleFromTile)return null;var n=i.upsampleFromTile,o=n.tile.layerInfo[1][t];return r.tile=n.tile,a.vec2.copy(r.offset,n.offset),r.scale=n.scale,r.sourceLod=n.tile.lij,r.sourceLayerInfo=o,r}var T=function(){function e(e,t,r,a){this._context=e,this.tileSize=t,this._setNeedsRender=a,this._backgroundTexture=null,this._blackTex=null,this._context.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,this._context.parameters.maxMaxAnisotropy)),this._vaoQuad=u.createQuadVAO(this._context,c.Pos3Tex),this._blendLayersProgram=r.getProgram(d.blendLayers),this._blendLayersPipelineState=p.makePipelineState({blending:p.simpleBlendingParams(1,771),colorWrite:p.defaultColorWriteParams}),this._applyOpacityPipelineState=p.makePipelineState({blending:p.simpleBlendingParams(0,770),colorWrite:p.defaultColorWriteParams}),this._blackTex=u.createColorTexture(this._context,[0,0,0,1])}return e.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),this._backgroundTexture&&(this._backgroundTexture.dispose(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.dispose(),this._blackTex=null),this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null)},e.prototype.updateTileTexture=function(e){for(var t=e.layerInfo[1],r=0,a=t;r<a.length;r++){a[r].pendingUpdates&=-33}if(e.renderData){var i,n=e.surface,o=n.baseOpacity,s=0,c=this.tileSize,u=!1,d=t.length;for(i=0;i<t.length&&!u;i++){var f=n.layerViewByIndex(i,1),p=f.fullOpacity;v[i]=p,this._isBaseLayer(f.layer)&&d>=t.length&&(d=i),0!==p&&m(e,i,L)&&(l.isVectorTileLayerView(f)?c=Math.max(c,this.tileSize*f.view.pixelRatio):f.isOpaque&&1===o&&1===p&&(u=!0),s++)}c=g(c);var h=c/this.tileSize,y=i-1;0===s&&this._backgroundTexture?this._useBackgroundTexture(e):1===s&&u?this._useLayerTexture(e,y):this._composeMapLayers(e,y,d,u,v,c,h),this._setNeedsRender()}},e.prototype.setBackground=function(e){e instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(e):this._backgroundTexture=u.createColorTexture(this._context,e)},e.prototype._buildTexture=function(e){var t,r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._context;if("number"==typeof e)r.width=r.height=e,t=new h(a,r);else try{t=new h(a,r,e)}catch(e){t=u.createEmptyTexture(a),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return a.bindTexture(t),t.generateMipmap(),t},e.prototype._bindFBO=function(e,t,r,a){return e&&e.width===t&&e.height===r||(e&&e.dispose(),e=f.create(this._context,{colorTarget:0,depthStencilTarget:a?1:0,width:t,height:r})),this._context.bindFramebuffer(e),e},e.prototype._drawRasterData=function(e,t,r,a){void 0===a&&(a=1);var i=this._context,n=this._blendLayersProgram,o=this._vaoQuad;i.bindProgram(n),i.bindVAO(o),y.assertCompatibleVertexAttributeLocations(o,n),i.bindTexture(e,0),n.setUniform1i("tex",0),n.setUniform1f("scale",t),n.setUniform2f("offset",r[0],r[1]),n.setUniform1f("opacity",a),i.drawArrays(5,0,y.vertexCount(o,"geometry"))},e.prototype._drawVectorData=function(e,t,r){var a=this._context,i=e.tile.surface.layerViewByIndex(e.layerIndex,1),n=e.sourceLayerInfo,s=n.data;o.renderVectorTile(a,e.sourceLod,s,i.renderer,i.layer.styleRepository,i.schemaHelper,Math.round(1/e.scale),e.offset,this.tileSize,t,r)},e.prototype._useBackgroundTexture=function(e){e.renderData.opacity=e.surface.baseOpacity,e.renderData.textureReference=this._backgroundTexture,n.vec4.set(e.renderData.texOffsetAndScale,0,0,1,1)},e.prototype._useLayerTexture=function(e,t){var r=m(e,t,L);if(this._dataToTexture(r)){e.renderData.textureReference=r.sourceLayerInfo.data;var a=r.offset;n.vec4.set(e.renderData.texOffsetAndScale,a[0],a[1],r.scale,r.scale)}e.renderData.opacity=e.surface.baseOpacity},e.prototype._composeMapLayers=function(e,t,r,a,o,s,l){var c=this,u=e.renderData.ensureTexture(s,function(){return c._buildTexture(s)}),d=this._context;this._fbo=this._bindFBO(this._fbo,u.descriptor.width,u.descriptor.height,!0),d.setViewport(0,0,s,s),d.setClearColor(0,0,0,0),d.setClearDepth(1),d.clearSafe(16640);var f=!1;!a&&this._backgroundTexture&&(d.setPipelineState(this._blendLayersPipelineState),this._drawRasterData(this._backgroundTexture,1,i.vec2f64.ZEROS));for(var p=e.surface.baseOpacity,h=!1,y=t;y>=0;y--){var x=m(e,y,L);x&&(y<r&&p<1&&!h&&(d.setPipelineState(this._applyOpacityPipelineState),this._drawRasterData(this._blackTex,1,i.vec2f64.ZEROS,p),h=!0),0!==o[y]&&(_(x)?(f&&d.clearSafe(256),d.setPipelineState(this._blendLayersPipelineState),this._drawVectorData(x,l,o[y]),f=!0):this._dataToTexture(x)&&(d.setPipelineState(this._blendLayersPipelineState),this._drawRasterData(x.sourceLayerInfo.data,x.scale,x.offset,o[y]))))}d.bindTexture(u);var b=u.descriptor;d.gl.copyTexImage2D(d.gl.TEXTURE_2D,0,b.pixelFormat,0,0,b.width,b.height,0),u.generateMipmap(),d.bindFramebuffer(null),e.renderData.opacity=h?1:p,e.renderData.textureReference=u,n.vec4.set(e.renderData.texOffsetAndScale,0,0,1,1)},e.prototype._dataToTexture=function(e){return!_(e)&&(x(e)&&(this._rasterDataToTexture(e),e.tile.setMemoryDirty()),b(e))},e.prototype._rasterDataToTexture=function(e){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data)},e.prototype._isBaseLayer=function(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1},Object.defineProperty(e.prototype,"test",{get:function(){return{fbo:this._fbo}},enumerable:!0,configurable:!0}),e}(),v=new Array,L={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return T});