// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/decorateHelper","../../../Color","../../../core/Accessor","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/imageUtils","../support/buffer/BufferView","./PatchGeometryFactory","./PatchRenderData","./TileRenderer","./tileUtils","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/tracer","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/TerrainRendererPrograms","../../webgl/renderState","../../webgl/Util"],function(e,t,r,i,n,a,s,l,o,d,c,u,h,p,f,g,v,b,m,y,x,R,P,T,S,_,O,D,w,E,I,k,U,B){function L(e,t,r){return 0===e.patches.length?-r:0===t.patches.length?r:S.compareTiles(e.patches.data[0],t.patches.data[0],r)}function M(e,t,r){var i=e[0]*t[2]+t[0],n=e[1]*t[3]+t[1],a=e[2]*t[2],s=e[3]*t[3];v.vec4.set(r,i,n,a,s)}var N=E.assert,z=h.mat4f64.create(),A=p.vec2f64.create(),C=m.create(),G=b.vec4f64.create(),Q=b.vec4f64.create(),j=b.vec4f64.create(),V=function(){function e(){this.extent=b.vec4f64.create(),this.minLevel=0,this.maxLevel=0,this.callback=null}return e}(),q=function(e){function t(t){var r=e.call(this,t)||this;return r.tileSize=256,r.rctx=null,r.renderDataPool=new o(P.PatchRenderData),r.patchGroups=new d({allocator:function(e){return e||{root:null,origin:null,patches:new d}},deallocator:function(e){return e.root=null,e.origin=null,e.patches.clear(),e}}),r.patchGroupsDirty=!0,r.patchGroupsMap=new Map,r.tileIterator=new S.IteratorPreorder,r.highestVisibleLODTile=null,r.visible=!0,r.debugScreenSizePerspective=!1,r._opaque=!0,r._skirtScale=1,r._renderPatchBorders=!1,r._renderingDisabled=!1,r.backfaceCullingEnabled=!1,r._renderOrder=1,r._velvetOvergroundEnabled=!0,r.hasOverlays=!1,r._slicePlaneEnabled=!1,r._wireframeEnabled=!1,r.castShadows=!0,r.receiveShadows=!1,r.emptyTex=null,r.tileRenderer=null,r.tileBackgroundInitialized=!1,r.stencilEnabledLayerExtents=[],r.numTrianglesRendered=0,r.numTilesRendered=0,r.numTilesCulled=0,r.numOriginsRendered=0,r.clippingExtent=null,r.needsHighlight=!1,r.visibleScaleRangeQueries=new d({initialSize:10}),r.visibleScaleRangeQueriesInvPtr=0,r.visibleScaleRangeQueryQueue=new d({initialSize:30}),r.visibleScaleRangeQueryPool=new o(V,!1),r}return r(t,e),t.prototype.destroy=function(){R.clearCaches()},t.prototype.install=function(e){e.addRenderPlugin([4,9],this),this.drapedRenderer=e.renderView.getDrapedRenderer()},t.prototype.uninstall=function(e){e.removeRenderPlugin(this)},Object.defineProperty(t.prototype,"updating",{get:function(){return!this.tileBackgroundInitialized},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"canRender",{get:function(){return this.visible&&!!this.rootTiles&&this.tileBackgroundInitialized&&!this._renderingDisabled},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderingDisabled",{set:function(e){this._renderingDisabled=!!e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opaque",{get:function(){return this._opaque&&!this._slicePlaneEnabled},set:function(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skirtScale",{set:function(e){this._skirtScale=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderPatchBorders",{set:function(e){this._renderPatchBorders!==e&&(this._renderPatchBorders=e,this._updatePrograms())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cullBackFaces",{set:function(e){this.backfaceCullingEnabled=e,this._updatePrograms(),this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderOrder",{get:function(){return this._renderOrder},set:function(e){this._renderOrder=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"velvetOvergroundEnabled",{set:function(e){this._velvetOvergroundEnabled!==e&&(this._velvetOvergroundEnabled=e,this._updatePrograms())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"intersectionHandlerId",{get:function(){return O.TERRAIN_ID},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._updatePrograms())},enumerable:!0,configurable:!0}),t.prototype.setRootTiles=function(e){this.rootTiles=e,this.setNeedsRender()},t.prototype.setNeedsHighlight=function(e){this.needsHighlight=e,this.setNeedsRender()},t.prototype.setStencilEnabledLayerExtents=function(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()},t.prototype.setTileSize=function(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()},t.prototype.loadCachedElevationData=function(e){N(null===e.renderData);var t=S.tile2str(e),r=this.memCache.pop(t);if(r){e.renderData=r.renderData,e.renderData.tile=e,e.renderData.localOrigin=this._getLocalOriginOfTile(e);for(var i=0;i<r.upsampleLIJs.length;i++){var n=r.upsampleLIJs[i],a=S.findParentByLIJ(e,n);e.layerInfo[0][i].setUpsampleInfo(e,a)}}return null!=r},t.prototype.loadTile=function(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e),this.updateTileGeometry(e)),this.updateTileTexture(e)},t.prototype.queryVisibleLevelRange=function(e,t,r,i){var n=this.visibleScaleRangeQueryPool.acquire();v.vec4.copy(n.extent,e),n.minLevel=t||-Number.MAX_VALUE,n.maxLevel=null!=r?r:Number.MAX_VALUE,n.callback=i,this.visibleScaleRangeQueryQueue.push(n),this.setNeedsRender()},t.prototype.updateTileTexture=function(e){this.tileRenderer&&this.tileBackgroundInitialized&&(this.tileRenderer.updateTileTexture(e),e.resetPendingUpdate(32))},t.prototype.updateTileGeometry=function(e){for(var t=0,r=e.layerInfo[0];t<r.length;t++){r[t].pendingUpdates&=-17}e.renderData.updateGeometry(this.rctx,this._wireframeEnabled)&&this.setNeedsRender()},t.prototype.unloadTile=function(e,t){if(e.renderData){if(e.renderData.releaseTexture(),t){for(var r={renderData:e.renderData,upsampleLIJs:[]},i=0,n=e.layerInfo[0];i<n.length;i++){var a=n[i],s=a.upsampleFromTile.tile.lij;r.upsampleLIJs.push([s[0],s[1],s[2]])}this.memCache.put(S.tile2str(e),r,e.renderData.estimatedGeometryMemoryUsage)}else this.releaseTileGeometry(e.renderData);e.renderData=null,e.setMemoryDirty(),this.setNeedsRender()}},t.prototype._getLocalOriginOfTile=function(e){var t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if("spherical"===this.manifold&&0===t)return g.vec3f64.ZEROS;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel},t.prototype.setVisibility=function(e){this.visible=e,this.setNeedsRender()},t.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}},t.prototype.setDebugScreenSizePerspective=function(e){e!==this.debugScreenSizePerspective&&(this.debugScreenSizePerspective=e,this._updatePrograms())},t.prototype.setWireframe=function(e){var t=this;this._wireframeEnabled!==e&&(this._wireframeEnabled=e,this.rootTiles&&(S.traverseTilesPreorder(this.rootTiles,function(r){r.renderData&&r.renderData.updateGeometry(t.rctx,e)}),this.setNeedsRender()))},t.prototype.setNeedsRender=function(e){void 0===e&&(e=1),this.patchGroupsDirty=!0,this._initContext.requestRender(e)},t.prototype.setTileBackground=function(e){this.tileBackground=e,this._updateTileBackground()},t.prototype.initializeRenderContext=function(e){var t=this;this._initContext=e,this.rctx=e.rctx;var r=this.programRep=e.programRep;this._updatePrograms(),this.tileRenderer=new T(this.rctx,this.tileSize,r,function(){return t.setNeedsRender()}),this.tileBackground&&this._updateTileBackground(),this.emptyTex=_.createEmptyTexture(this.rctx)},t.prototype.uninitializeRenderContext=function(e){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)},t.prototype.intersect=function(e,t,r,i,n){if(this.rootTiles&&(!e.enable.selectOpaqueTerrainOnly||!e.enable.selectionMode||this._opaque)){var a=J,s=Z;f.vec3.subtract(a,i,r),f.vec3.set(s,1/a[0],1/a[1],1/a[2]);var o=e.results.min,d=e.results.max,c=e.results.terrain,u=null,h=this.clippingExtent,p=this.tileIterator;p.reset(this.rootTiles);for(var g=this;!p.done;)!function(){var n=p.next();if(null===n.renderData)return"continue";if(e.enable.invisibleTerrain){if(!n.visible&&h&&!n.intersectsExtent(h))return"continue"}else if(!n.visible)return"continue";var v=n.renderData.geometryInfo,b=-g._skirtScale*v.skirtLength;if(0!==b){var y=n.up;m.offset(v.boundingBox,b*y[0],b*y[1],b*y[2],C),m.expandWithBuffer(C,v.boundingBox,0,2)}var P=0===b?v.boundingBox:C,T=n.renderData.localOrigin;if(f.vec3.subtract(X,r,T),!I.intersectAabbInvDir(P,X,s,e.tolerance))return"continue";var _=function(e,t,r,i){e.set(void 0,S.tile2str(t),r,i,z,void 0),e.intersector=K,e.target=$},D=function(s,h,p){if(s>=0&&(e.enable.backfacesTerrain||f.vec3.dot(h,a)<0)&&(e.enable.invisibleTerrain||!e.enable.selectionMode||null==t||t(r,i,s))){if((null==c.dist||s<c.dist)&&_(c,n,s,h),!e.enable.storeTerrainResults)return;e.enable.storeAll&&(l.isNone(u)?(u=new O.IntersectorResult(e.ray),_(u,n,s,h),e.results.all.push(u)):s<u.dist&&_(u,n,s,h)),(null==o.dist||s<o.dist)&&_(o,n,s,h),(null==d.dist||s>d.dist)&&_(d,n,s,h)}},w=Y;f.vec3.subtract(w,i,T);var E=v.indices,k=v.vertexAttributes,U=k.getField("position",x.BufferViewVec3f),B={data:U.typedBuffer,size:3,offsetIdx:0,strideIdx:k.stride/4},L=v.numWithoutSkirtIndices/3;if(I.intersectTriangles(X,w,0,L,E,B,null,D),0!==b){var M="spherical"===g.manifold?function(e){return f.vec3.scale(e,e,b/f.vec3.length(e))}:function(e){return f.vec3.set(e,0,0,b)},N=E.length/3;R.intersectSkirts(X,w,L,N,E,k,M,D)}}()}},t.prototype.render=function(e){var t=this.opaque?4:9;if(e.slot!==t)return!1;w.trace("# BEGIN RENDER TERRAIN");var r=e.pass,i=1===e.scenelightingData.globalFactor,n=this._updatePatchGroups();switch(F.overlayEnabled=!1,F.used=!0,r){case 0:F.overlayEnabled=!0,F.used=!1;var a=e.shadowMap&&e.shadowMap.enabled;this.receiveShadows!==a&&(this.receiveShadows=a,this._updatePrograms());var s=!this.drapedRenderer.isEmpty();s!==this.hasOverlays&&(this.hasOverlays=s,this._updatePrograms()),this._renderMaterialPass(e,this.programs.color,n,F);break;case 3:this.castShadows&&i&&this._renderAuxiliaryPass(e,this.programs.depthShadowMap,n,F);break;case 1:this._renderAuxiliaryPass(e,this.programs.depth,n,F);break;case 2:this._renderAuxiliaryPass(e,this.programs.normal,n,F);break;case 4:this.needsHighlight&&(F.overlayEnabled=!0,this._renderAuxiliaryPass(e,this.programs.highlight,n,F),e.rctx.clearSafe(256))}return w.trace("# END RENDER TERRAIN"),0!==this.visibleScaleRangeQueryQueue.length&&this.setNeedsRender(),!0},t.prototype._renderMaterialPass=function(e,t,r,i){var n=this,a=e.rctx,s=e.camera;a.bindProgram(t),e.shadowMap&&e.shadowMap.bind(t),e.ssaoHelper&&e.ssaoHelper.setUniforms(t),t.setUniform1i("tex",0),this._bindOverlayUniforms(t),t.setUniformMatrix4fv("viewNormal",s.viewInverseTransposeMatrix),t.setUniformMatrix4fv("proj",s.projectionMatrix),e.scenelightingData.setUniforms(t,!0);var l=s.viewMatrix;f.vec3.set(W,l[12],l[13],l[14]),f.vec3.normalize(W,W),t.setUniform3fv("viewDirection",W),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.opaque?this._renderPatchGroups(e,t,r,i):e.offscreenRenderingHelper.renderToTargets(function(){return n._renderPatchGroups(e,t,r,i)},e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries()},t.prototype._renderAuxiliaryPass=function(e,t,r,i){if(e.rctx.bindProgram(t),4===e.pass){var n=e.offscreenRenderingHelper;e.rctx.bindTexture(n.depthTexture,5),t.setUniform1i("depthTex",5),t.setUniform4f("highlightViewportPixelSz",0,0,1/n.width,1/n.height)}else t.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),1!==e.pass&&3!==e.pass||(A[0]=e.camera.near,A[1]=e.camera.far,t.setUniform2fv("nearFar",A));this._renderPatchGroupsAuxiliary(e,t,r,i)},t.prototype._updateTileBackground=function(){var e=this;if(this.tileRenderer){var t=function(){e.tileBackgroundInitialized=!0,e.rootTiles&&S.traverseTilesPreorder(e.rootTiles,function(t){return e.tileRenderer.updateTileTexture(t)}),e.setNeedsRender()};if("string"==typeof this.tileBackground){var r=this.tileBackground;y.requestImage(r).then(function(i){r===e.tileBackground&&e.tileRenderer&&(e.tileRenderer.setBackground(i),t())})}else{var i=this.tileBackground?a.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(i),t()}}},t.prototype._updatePatchGroups=function(){var e=this,t=this.patchGroups;if(!this.patchGroupsDirty)return t;if(this.highestVisibleLODTile=null,this._renderCollectOrigins(t),0!==this.renderOrder){for(var r=0;r<t.length;r++)S.sortTiles(this.renderOrder,t.data[r].patches);t.sort(function(t,r){return L(t,r,e.renderOrder)})}return this.patchGroupsDirty=!1,t},t.prototype._renderCollectOrigins=function(e){var t=this.rootTiles,r="spherical"===this.manifold;e.clear();for(var i=0,n=t;i<n.length;i++){var a=n[i],s=e.pushNew();s.root=a,s.origin=r?g.vec3f64.ZEROS:a.centerAtSeaLevel,s.patches.clear(),this._renderCollectOriginsForRoot(e,s)}},t.prototype._renderCollectOriginsForRoot=function(e,t){var r=this.tileIterator;r.resetOne(t.root);var i=this.patchGroupsMap;for(i.clear(),i.set(t.origin,t);!r.done;){var n=r.next(),a=n.renderData;if(!a||n.visible){if(n.lij[0]%7==0){var s=e.pushNew();s.root=n,s.origin=n.centerAtSeaLevel,i.set(n.centerAtSeaLevel,s),s.patches.clear()}if(n.rendered){if(a){var s=i.get(a.localOrigin);s&&s.patches.push(n),(!this.highestVisibleLODTile||n.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=n),r.skipSubtree()}}else this.numTilesCulled++}else this.numTilesCulled++,r.skipSubtree()}},t.prototype._scaleQueriesForTile=function(e){for(var t=e.extent,r=e.lij[0],i=0;i<this.visibleScaleRangeQueriesInvPtr;){var n=this.visibleScaleRangeQueries.data[i],a=n.extent;r>=n.minLevel&&r<=n.maxLevel&&a[0]<=t[2]&&a[2]>=t[0]&&a[1]<=t[3]&&a[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(i,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):i++}},t.prototype._tileIntersectsStencilEnabledLayer=function(e){for(var t=this.stencilEnabledLayerExtents,r=0;r<t.length;r++)if(e.intersectsExtent(t[r]))return!0;return!1},t.prototype._renderPatchGroupsAuxiliary=function(e,t,r,i){e.rctx.setPipelineState(this.defaultPipelineState);var n=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),i.overlayEnabled&&this._bindOverlayUniforms(t);for(var a=0;a<r.length;a++){var s=r.data[a];this._bindViewForPatchGroup(t,s,e.camera.eye,e.camera.viewMatrix);for(var l=0;l<s.patches.length;l++)this._renderPatch(e.rctx,t,s.patches.data[l],4,n,i)}e.rctx.bindVAO(null)},t.prototype._renderPatchGroups=function(e,t,r,i){var n=e.rctx,a=e.camera,s=a.viewMatrix;if(n.setPipelineState(this.defaultPipelineState),this.debugScreenSizePerspective&&this.pointsOfInterest){var l=D.getSettings("spherical"===this.manifold?"global":"local"),o=this.pointsOfInterest.centerOnSurfaceFrequent.distance;l.update({distance:o,fovY:a.fovY}),I.bindScreenSizePerspective(l,t,"screenSizePerspective")}var d=this.stencilEnabledLayerExtents.length>0;t.setUniform1f("skirtScale",this._skirtScale);for(var c=this._wireframeEnabled?1:4,u=0;u<r.length;u++){var h=r.data[u],p=h.patches;if(0!==p.length){this._bindViewForPatchGroup(t,h,a.eye,s);var f=e.sliceHelper&&e.sliceHelper.plane;f&&I.bindSlicePlane(h.origin,f,t),e.shadowMap&&e.shadowMap.bindView(t,h.origin),this.numOriginsRendered++;for(var g=0;g<p.length;g++){var v=p.data[g];w.trace("# RENDER TILE "+S.tile2str(v)+", screenDepth:"+v.screenDepth),M(v.renderData.geometryInfo.uvOffsetAndScale,v.renderData.texOffsetAndScale,j),t.setUniform4fv("texOffsetAndScale",j),n.bindTexture(v.renderData.textureReference,0),t.setUniform1f("opacity",v.renderData.opacity);var b=this._renderPatch(n,t,v,c,d,i);v.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=b/3,this._scaleQueriesForTile(v)}}}n.bindVAO(null)},t.prototype._renderPatch=function(e,t,r,i,n,a){a.overlayEnabled&&(this._bindOverlayTextures(t,r.renderData.overlays,a.used),t.setUniform1f("overlayOpacity",r.renderData.overlayOpacity)),n&&e.setPipelineState(this._tileIntersectsStencilEnabledLayer(r)?this.stencilPipelineState:this.defaultPipelineState);var s=0===this._skirtScale?r.renderData.geometryInfo.numWithoutSkirtIndices:r.renderData.vao.indexBuffer.size;return e.bindVAO(r.renderData.vao),B.assertCompatibleVertexAttributeLocations(r.renderData.vao,t),e.drawElements(i,s,r.renderData.vao.indexBuffer.indexType,0),s},t.prototype._bindViewForPatchGroup=function(e,t,r,i){e.setUniform3fv("origin",t.origin),u.mat4.translate(H,i,t.origin),e.setUniformMatrix4fv("view",H),e.setUniform3f("camPos",r[0]-t.origin[0],r[1]-t.origin[1],r[2]-t.origin[2])},t.prototype._bindOverlayUniforms=function(e){e.setUniform1i("ovInnerColorTex",1),e.setUniform1i("ovOuterColorTex",2),e.setUniform1i("ovInnerWaterTex",3),e.setUniform1i("ovOuterWaterTex",4)},t.prototype._bindOverlayTextures=function(e,t,r){for(var i=0;i<2;i++){var n=2*i,a=t[i],s=r?a.highlightRenderTargetId:a.renderTargetId;if(s){G[n]=a.texOffset[0],G[n+1]=a.texOffset[1],Q[n]=a.texScale[0],Q[n+1]=a.texScale[1];var l=this.drapedRenderer.getRenderTargetTexture(s);this.rctx.bindTexture(l,1+i);var o=a.waterMaskRenderTargetId;if(o){var d=this.drapedRenderer.getRenderTargetTexture(o);this.rctx.bindTexture(d,3+i)}else this.rctx.bindTexture(this.emptyTex,3+i)}else G[n]=0,G[n+1]=0,Q[n]=0,Q[n+1]=0,this.rctx.bindTexture(this.emptyTex,1+i),this.rctx.bindTexture(this.emptyTex,3+i)}e.setUniform4fv("overlayTexOffset",G),e.setUniform4fv("overlayTexScale",Q)},t.prototype._updatePrograms=function(){var e="spherical"===this.manifold,t=this.programRep;this.programs={color:t.getProgram(k.colorPass,{overlay:this.hasOverlays,atmosphere:e&&this._velvetOvergroundEnabled,tileBorders:this._renderPatchBorders,receiveShadows:this.receiveShadows,screenSizePerspective:this.debugScreenSizePerspective,slice:this._slicePlaneEnabled}),normal:t.getProgram(k.normalPass,{alphaZero:!0}),depth:t.getProgram(k.depthPass,{shadowMap:!1}),depthShadowMap:t.getProgram(k.depthPass,{shadowMap:!0}),highlight:t.getProgram(k.highlightPass,{})},this.defaultPipelineState=U.makePipelineState({culling:this.backfaceCullingEnabled&&U.backFaceCullingParams,depthTest:{func:513},depthWrite:U.defaultDepthWriteParams,colorWrite:U.defaultColorWriteParams}),this.stencilPipelineState=U.makePipelineState(i({},this.defaultPipelineState,{stencilTest:{function:{func:517,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7680}}})),this.setNeedsRender()},t.prototype.releaseTileGeometry=function(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)},t.prototype._prepareScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;e.length<e.data.length&&t.length>0;){var r=t.pop();e.push(r)}this.visibleScaleRangeQueriesInvPtr=e.length},t.prototype._processScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool,r=0;r<e.length;r++){var i=e.data[r];t.release(i),i.callback(r>=this.visibleScaleRangeQueriesInvPtr),i.callback=null}e.clear()},Object.defineProperty(t.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0}),n([c.property()],t.prototype,"tileBackgroundInitialized",void 0),n([c.property({constructOnly:!0})],t.prototype,"manifold",void 0),n([c.property({constructOnly:!0})],t.prototype,"memCache",void 0),n([c.property({readOnly:!0,dependsOn:["tileBackgroundInitialized"]})],t.prototype,"updating",null),t=n([c.subclass("esri.views.3d.terrain.TerrainRenderer")],t)}(c.declared(s)),F={overlayEnabled:!1,used:!0},H=h.mat4f64.create(),W=g.vec3f64.create(),J=g.vec3f64.create(),Z=g.vec3f64.create(),X=g.vec3f64.create(),Y=g.vec3f64.create(),K="TerrainRenderer",$={type:"external"};return q});