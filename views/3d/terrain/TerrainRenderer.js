// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/assignHelper","../../../Color","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingBox","../support/imageUtils","../support/buffer/BufferView","./PatchGeometryFactory","./PatchRenderData","./TerrainConst","./TileRenderer","./tileUtils","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/intersectorUtils","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/tracer","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/TerrainRendererPrograms","../../webgl/renderState","../../webgl/Util"],function(e,t,r,i,a,n,s,l,o,d,c,h,u,p,f,g,v,m,b,y,x,R,P,T,S,O,_,w,D,E,I,U){function k(e,t,r){return 0===e.patches.length?-r:0===t.patches.length?r:P.compareTiles(e.patches.data[0],t.patches.data[0],r)}function L(e,t,r){var i=e[0]*t[2]+t[0],a=e[1]*t[3]+t[1],n=e[2]*t[2],s=e[3]*t[3];p.vec4.set(r,i,a,n,s)}var M=w.assert,B=d.mat4f64.create(),N=c.vec2f64.create(),A=g.create(),G=f.vec4f64.create(),z=f.vec4f64.create(),C=f.vec4f64.create(),Q=function(){function e(){this.extent=f.vec4f64.create(),this.minLevel=0,this.maxLevel=0,this.callback=null}return e}(),V=function(){function e(e,t){this._memCache=t,this.tileSize=256,this.rctx=null,this.renderDataPool=new s(y.PatchRenderData),this.patchGroups=new l({allocator:function(e){return e||{root:null,origin:null,patches:new l}},deallocator:function(e){return e.root=null,e.origin=null,e.patches.clear(),e}}),this.patchGroupsDirty=!0,this.patchGroupsMap=new Map,this.tileIterator=new P.IteratorPreorder,this.highestVisibleLODTile=null,this.visible=!0,this.debugScreenSizePerspective=!1,this.wireframe=D.copyParameters(j),this._opaque=!0,this._skirtScale=1,this._renderPatchBorders=!1,this._renderingDisabled=!1,this.backfaceCullingEnabled=!1,this._renderOrder=x.RenderOrder.FRONT_TO_BACK,this._velvetOvergroundEnabled=!0,this.hasOverlays=!1,this._slicePlaneEnabled=!1,this.castShadows=!0,this.receiveShadows=!1,this.emptyTex=null,this.tileRenderer=null,this.tileBackgroundInitialized=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.clippingExtent=null,this.loaded=null,this._loaded=!1,this.needsRender=!1,this.needsHighlight=!1,this.visibleScaleRangeQueries=new l({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new l({initialSize:30}),this.visibleScaleRangeQueryPool=new s(Q,!1),this.manifold=e}return e.prototype.destroy=function(e){this.uninstall(e),b.clearCaches()},e.prototype.install=function(e){e.addRenderPlugin([4,9],this),this.drapedRenderer=e.renderView.getDrapedRenderer()},e.prototype.uninstall=function(e){e.removeRenderPlugin(this)},Object.defineProperty(e.prototype,"renderingDisabled",{set:function(e){this._renderingDisabled=!!e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"opaque",{set:function(e){this._opaque=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skirtScale",{set:function(e){this._skirtScale=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderPatchBorders",{set:function(e){this._renderPatchBorders!==e&&(this._renderPatchBorders=e,this._updatePrograms())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cullBackFaces",{set:function(e){this.backfaceCullingEnabled=e,this._updatePrograms(),this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderOrder",{get:function(){return this._renderOrder},set:function(e){this._renderOrder=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"velvetOvergroundEnabled",{set:function(e){this._velvetOvergroundEnabled!==e&&(this._velvetOvergroundEnabled=e,this._updatePrograms())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return S.TERRAIN_ID},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._updatePrograms())},enumerable:!0,configurable:!0}),e.prototype.setRootTiles=function(e){this.rootTiles=e,this.setNeedsRender()},e.prototype.setNeedsHighlight=function(e){this.needsHighlight=e,this.setNeedsRender()},e.prototype.setStencilEnabledLayerExtents=function(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()},e.prototype.setTileSize=function(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()},e.prototype.loadCachedElevationData=function(e){M(null===e.renderData);var t=P.tile2str(e),r=this._memCache.pop(t);if(r){e.renderData=r.renderData,e.renderData.tile=e,e.renderData.localOrigin=this._getLocalOriginOfTile(e);for(var i in r.upsampleLIJs){var a=r.upsampleLIJs[i],n=P.findParentByLIJ(e,a);e.layerInfo[x.LayerClass.ELEVATION][i].setUpsampleInfo(e,n)}}return null!=r},e.prototype.loadTile=function(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e),this.updateTileGeometry(e)),this.updateTileTexture(e)},e.prototype.queryVisibleLevelRange=function(e,t,r,i){var a=this.visibleScaleRangeQueryPool.acquire();p.vec4.copy(a.extent,e),a.minLevel=t||-Number.MAX_VALUE,a.maxLevel=null!=r?r:Number.MAX_VALUE,a.callback=i,this.visibleScaleRangeQueryQueue.push(a),this.setNeedsRender()},e.prototype.updateTileTexture=function(e){this.tileRenderer&&this.tileBackgroundInitialized&&this.tileRenderer.updateTileTexture(e)},e.prototype.updateTileGeometry=function(e){for(var t=0,r=e.layerInfo[x.LayerClass.ELEVATION];t<r.length;t++){r[t].pendingUpdates&=~x.TileUpdate.GEOMETRY}e.renderData.updateGeometry(this.rctx,"debug"===this.wireframe.mode)&&this.setNeedsRender()},e.prototype.unloadTile=function(e,t){if(e.renderData){if(e.renderData.releaseTexture(),t){for(var r={renderData:e.renderData,upsampleLIJs:[]},i=0,a=e.layerInfo[x.LayerClass.ELEVATION];i<a.length;i++){var n=a[i],s=n.upsampleFromTile.tile.lij;r.upsampleLIJs.push([s[0],s[1],s[2]])}this._memCache.put(P.tile2str(e),r,e.renderData.estimatedGeometryMemoryUsage)}else this.releaseTileGeometry(e.renderData);e.renderData=null,e.updateMemoryUsed()}},e.prototype._getLocalOriginOfTile=function(e){var t=Math.max(0,7*Math.floor((e.lij[0]-3)/7));if("spherical"===this.manifold&&0===t)return u.vec3f64.ZEROS;for(;e.parent&&e.lij[0]>t;)e=e.parent;return e.centerAtSeaLevel},e.prototype.setVisibility=function(e){this.visible=e,this.setNeedsRender()},e.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}},e.prototype.getWireframeEnabled=function(){return"shader"===this.wireframe.mode},e.prototype.setDebugScreenSizePerspective=function(e){e!==this.debugScreenSizePerspective&&(this.debugScreenSizePerspective=e,this._updatePrograms())},e.prototype.setWireframe=function(e){var t=this;!1!==e&&!0!==e||(e={mode:e?"shader":"none"});var r=this.wireframe;if(void 0!==e.mode&&r.mode!==e.mode){var i="debug"===r.mode,a="debug"===e.mode;r.mode=e.mode,this._updatePrograms(),i!==a&&this.rootTiles&&(P.traverseTilesPreorder(this.rootTiles,function(e){e.renderData&&e.renderData.updateGeometry(t.rctx,a)}),this.setNeedsRender())}for(var n in e)r.hasOwnProperty(n)&&(r[n]=e[n]),this.setNeedsRender();r.resolution&&(r.resolution=Math.min(r.resolution,this.tileSize),r.resolution=1<<Math.round(Math.log(r.resolution)/Math.LN2))},e.prototype.setNeedsRender=function(){this.needsRender=!0,this.patchGroupsDirty=!0},e.prototype.isOpaqueExcludingSlice=function(){var e=this.wireframe,t="shader"===e.mode&&(e.wireOpacity<1||e.surfaceOpacity<1);return this._opaque&&!t},e.prototype.isOpaque=function(){return this.isOpaqueExcludingSlice()&&!this._slicePlaneEnabled},e.prototype.setTileBackground=function(e){this.tileBackground=e,this._updateTileBackground()},e.prototype.initializeRenderContext=function(e){var t=this,r=this.rctx=e.rctx,i=this.programRep=e.programRep;this._updatePrograms(),this.tileRenderer=new R(r,this.tileSize,i,function(){return t.setNeedsRender()}),this.tileBackground&&this._updateTileBackground(),this.emptyTex=T.createEmptyTexture(r)},e.prototype.uninitializeRenderContext=function(e){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)},e.prototype.intersect=function(e,t,r,i,a){if(this.rootTiles&&(!e.enable.selectOpaqueTerrainOnly||!e.enable.selectionMode||this.isOpaqueExcludingSlice())){var s=J,l=Y;h.vec3.subtract(s,i,r),h.vec3.set(l,1/s[0],1/s[1],1/s[2]);var o=e.results.min,d=e.results.max,c=e.results.terrain,u=null,p=this.clippingExtent,f=this.tileIterator;f.reset(this.rootTiles);for(var v=this;!f.done;)!function(){var a=f.next();if(null===a.renderData)return"continue";if(e.enable.invisibleTerrain){if(!a.visible&&p&&!a.intersectsExtent(p))return"continue"}else if(!a.visible)return"continue";var y=a.renderData.geometryInfo,x=-v._skirtScale*y.skirtLength;if(0!==x){var R=a.up;g.offset(y.boundingBox,x*R[0],x*R[1],x*R[2],A),g.expandWithBuffer(A,y.boundingBox,0,2)}var T=0===x?y.boundingBox:A,O=a.renderData.localOrigin;if(h.vec3.subtract(Z,r,O),!D.intersectAabbInvDir(T,Z,l,e.tolerance))return"continue";var _=function(e,t,r,i){e.set(void 0,P.tile2str(t),r,i,B,void 0),e.intersector=K,e.target=$},w=function(l,p,f){if(l>=0&&(e.enable.backfacesTerrain||h.vec3.dot(p,s)<0)&&(e.enable.invisibleTerrain||!e.enable.selectionMode||null==t||t(r,i,l))){if((null==c.dist||l<c.dist)&&_(c,a,l,p),!e.enable.storeTerrainResults)return;e.enable.storeAll&&(n.isNone(u)?(u=new S.IntersectorResult(e.ray),_(u,a,l,p),e.results.all.push(u)):l<u.dist&&_(u,a,l,p)),(null==o.dist||l<o.dist)&&_(o,a,l,p),(null==d.dist||l>d.dist)&&_(d,a,l,p)}},E=X;h.vec3.subtract(E,i,O);var I=y.indices,U=y.vertexAttributes,k=U.getField("position",m.BufferViewVec3f),L={data:k.typedBuffer,size:3,offsetIdx:0,strideIdx:U.stride/4},M=y.numWithoutSkirtIndices/3;if(D.intersectTriangles(Z,E,0,M,I,L,null,w),0!==x){var N="spherical"===v.manifold?function(e){return h.vec3.scale(e,e,x/h.vec3.length(e))}:function(e){return h.vec3.set(e,0,0,x)},G=I.length/3;b.intersectSkirts(Z,E,M,G,I,U,N,w)}}()}},e.prototype.render=function(e){var t=e.rctx;if(this._renderingDisabled||!this.visible||!this.rootTiles||!this.tileBackgroundInitialized)return!1;var r=this.isOpaque()?4:9;if(e.slot!==r)return!1;_.trace("# BEGIN RENDER TERRAIN");var i=e.pass,a=1===e.lightingData.helper.globalFactor;switch(q.overlayEnabled=!1,q.used=!0,i){case 0:q.overlayEnabled=!0,q.used=!1;var n=e.shadowMap&&e.shadowMap.enabled;this.receiveShadows!==n&&(this.receiveShadows=n,this._updatePrograms());var s=!this.drapedRenderer.isEmpty();s!==this.hasOverlays&&(this.hasOverlays=s,this._updatePrograms()),this._renderMaterialPass(e,this.programs.color,this._updatePatchGroupsData(),q);break;case 3:this.castShadows&&a&&this._renderAuxiliaryPass(e,this.programs.depthShadowMap,this._updatePatchGroupsData(),q);break;case 1:this._renderAuxiliaryPass(e,this.programs.depth,this._updatePatchGroupsData(),q);break;case 2:this._renderAuxiliaryPass(e,this.programs.normal,this._updatePatchGroupsData(),q);break;case 4:this.needsHighlight&&(q.overlayEnabled=!0,this._renderAuxiliaryPass(e,this.programs.highlight,this._updatePatchGroupsData(),q),t.clearSafe(256))}return _.trace("# END RENDER TERRAIN"),this.needsRender=0!==this.visibleScaleRangeQueryQueue.length,!0},e.prototype._renderMaterialPass=function(e,t,r,i){var a=this,n=e.rctx,s=e.camera;n.bindProgram(t);var l=this.wireframe;("shader"===l.mode||this._renderPatchBorders)&&(t.setUniform1f("wireframe.width",this.wireframe.width),t.setUniform1f("wireframe.falloff",Math.min(l.width,l.falloff)),t.setUniform1f("wireframe.wireOpacity",l.wireOpacity),t.setUniform1f("wireframe.surfaceOpacity",l.surfaceOpacity),t.setUniform4fv("wireframe.color",l.color)),e.shadowMap&&e.shadowMap.bind(t),e.ssaoHelper&&e.ssaoHelper.setUniforms(t),t.setUniform1i("tex",0),this._bindOverlayUniforms(t),t.setUniformMatrix4fv("viewNormal",s.viewInverseTransposeMatrix),t.setUniformMatrix4fv("proj",s.projectionMatrix);var o=e.lightingData;h.vec3.set(H,o.diffuse[0],o.diffuse[1],o.diffuse[2]),t.setUniform3fv("lightIntensity",H),e.lightingData.helper.setUniforms(t,!0);var d=s.viewMatrix;h.vec3.set(W,d[12],d[13],d[14]),h.vec3.normalize(W,W),t.setUniform3fv("viewDirection",W),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.isOpaque()?this._renderPatchGroups(e,t,r,i):e.offscreenRenderingHelper.renderToTargets(function(){return a._renderPatchGroups(e,t,r,i)},e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries(),this.numTilesRendered>0&&!this._loaded&&(this._loaded=!0,this.loaded&&this.loaded())},e.prototype._renderAuxiliaryPass=function(e,t,r,i){if(e.rctx.bindProgram(t),4===e.pass){var a=e.offscreenRenderingHelper;e.rctx.bindTexture(a.depthTexture,5),t.setUniform1i("depthTex",5),t.setUniform4f("highlightViewportPixelSz",0,0,1/a.width,1/a.height)}else t.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),1!==e.pass&&3!==e.pass||(N[0]=e.camera.near,N[1]=e.camera.far,t.setUniform2fv("nearFar",N));this._renderPatchGroupsAuxiliary(e,t,r,i)},e.prototype._updateTileBackground=function(){var e=this;if(this.tileRenderer){var t=function(){e.tileBackgroundInitialized=!0,e.rootTiles&&P.traverseTilesPreorder(e.rootTiles,function(t){return e.tileRenderer.updateTileTexture(t)})};if("string"==typeof this.tileBackground){var r=this.tileBackground;v.requestImage(r).then(function(i){r===e.tileBackground&&e.tileRenderer&&(e.tileRenderer.setBackground(i),t())})}else{var i=this.tileBackground?a.toUnitRGBA(this.tileBackground):[0,0,0,0];this.tileRenderer.setBackground(i),t()}}},e.prototype._updatePatchGroupsData=function(){var e=this,t=this.patchGroups;if(!this.patchGroupsDirty)return t;if(this.highestVisibleLODTile=null,t.clear(),this._renderCollectOrigins(t),this.renderOrder!==x.RenderOrder.NONE){for(var r=0;r<t.length;r++)P.sortTiles(this.renderOrder,t.data[r].patches);t.sort(function(t,r){return k(t,r,e.renderOrder)})}return this.patchGroupsDirty=!1,t},e.prototype._renderCollectOrigins=function(e){var t=this.rootTiles,r="spherical"===this.manifold;e.clear();for(var i=0,a=t;i<a.length;i++){var n=a[i],s=e.pushNew();s.root=n,s.origin=r?u.vec3f64.ZEROS:n.centerAtSeaLevel,s.patches.clear(),this._renderCollectOriginsForRoot(e,s)}},e.prototype._renderCollectOriginsForRoot=function(e,t){var r=this.tileIterator;r.resetOne(t.root);var i=this.patchGroupsMap;for(i.clear(),i.set(t.origin,t);!r.done;){var a=r.next(),n=a.renderData;if(!n||a.visible){if(a.lij[0]%7==0){var s=e.pushNew();s.root=a,s.origin=a.centerAtSeaLevel,i.set(a.centerAtSeaLevel,s),s.patches.clear()}if(n){var s=i.get(a.renderData.localOrigin);s&&s.patches.push(a),(!this.highestVisibleLODTile||a.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=a),r.skipSubtree()}}else this.numTilesCulled++,r.skipSubtree()}},e.prototype._scaleQueriesForTile=function(e){for(var t=e.extent,r=e.lij[0],i=0;i<this.visibleScaleRangeQueriesInvPtr;){var a=this.visibleScaleRangeQueries.data[i],n=a.extent;r>=a.minLevel&&r<=a.maxLevel&&n[0]<=t[2]&&n[2]>=t[0]&&n[1]<=t[3]&&n[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(i,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):i++}},e.prototype._tileIntersectsStencilEnabledLayer=function(e){for(var t=this.stencilEnabledLayerExtents,r=0;r<t.length;r++)if(e.intersectsExtent(t[r]))return!0;return!1},e.prototype._renderPatchGroupsAuxiliary=function(e,t,r,i){e.rctx.setPipelineState(this.defaultPipelineState);var a=this.stencilEnabledLayerExtents.length>0;t.setUniformMatrix4fv("proj",e.camera.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),i.overlayEnabled&&this._bindOverlayUniforms(t);for(var n=0;n<r.length;n++){var s=r.data[n];this._bindViewForPatchGroup(t,s,e.camera.eye,e.camera.viewMatrix);for(var l=0;l<s.patches.length;l++)this._renderPatch(e.rctx,t,s.patches.data[l],4,a,i)}e.rctx.bindVAO(null)},e.prototype._renderPatchGroups=function(e,t,r,i){var a=e.rctx,n=e.camera,s=n.viewMatrix;if(a.setPipelineState(this.defaultPipelineState),this.debugScreenSizePerspective&&this.pointsOfInterest){var l=O.getSettings("spherical"===this.manifold?"global":"local"),o=this.pointsOfInterest.centerOnSurfaceFrequent.distance;l.update({distance:o,fovY:n.fovY}),D.bindScreenSizePerspective(l,t,"screenSizePerspective")}var d=this.stencilEnabledLayerExtents.length>0;t.setUniform1f("skirtScale",this._skirtScale);var c,h,u=this.highestVisibleLODTile;u?(c=u.vlevel,h=this.tileSize/this.wireframe.resolution):(c=16,h=this.tileSize/64);for(var p="debug"===this.wireframe.mode?1:4,f=0;f<r.length;f++){var g=r.data[f],v=g.patches;if(0!==v.length){this._bindViewForPatchGroup(t,g,n.eye,s);var m=e.sliceHelper&&e.sliceHelper.plane;m&&D.bindSlicePlane(g.origin,m,t),e.shadowMap&&e.shadowMap.bindView(t,g.origin),this.numOriginsRendered++;for(var b=0;b<v.length;b++){var y=v.data[b];if(_.trace("# RENDER TILE "+P.tile2str(y)+", screenDepth:"+y.screenDepth),L(y.renderData.geometryInfo.uvOffsetAndScale,y.renderData.texOffsetAndScale,C),t.setUniform4fv("texOffsetAndScale",C),a.bindTexture(y.renderData.textureReference,0),t.setUniform1f("opacity",y.renderData.opacity),"shader"===this.wireframe.mode||this._renderPatchBorders){var x=h*(1<<c-y.vlevel);t.setUniform1f("wireframe.subdivision",x)}var R=this._renderPatch(a,t,y,p,d,i);y.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=R/3,this._scaleQueriesForTile(y)}}}a.bindVAO(null)},e.prototype._renderPatch=function(e,t,r,i,a,n){n.overlayEnabled&&(this._bindOverlayTextures(t,r.renderData.overlays,n.used),t.setUniform1f("overlayOpacity",r.renderData.overlayOpacity)),a&&e.setPipelineState(this._tileIntersectsStencilEnabledLayer(r)?this.stencilPipelineState:this.defaultPipelineState);var s=0===this._skirtScale?r.renderData.geometryInfo.numWithoutSkirtIndices:r.renderData.vao.indexBuffer.size;return e.bindVAO(r.renderData.vao),U.assertCompatibleVertexAttributeLocations(r.renderData.vao,t),e.drawElements(i,s,r.renderData.vao.indexBuffer.indexType,0),s},e.prototype._bindViewForPatchGroup=function(e,t,r,i){e.setUniform3fv("origin",t.origin),o.mat4.translate(F,i,t.origin),e.setUniformMatrix4fv("view",F),e.setUniform3f("camPos",r[0]-t.origin[0],r[1]-t.origin[1],r[2]-t.origin[2])},e.prototype._bindOverlayUniforms=function(e){e.setUniform1i("ovInnerColorTex",1),e.setUniform1i("ovOuterColorTex",2),e.setUniform1i("ovInnerWaterTex",3),e.setUniform1i("ovOuterWaterTex",4)},e.prototype._bindOverlayTextures=function(e,t,r){for(var i=0;i<2;i++){var a=2*i,n=t[i],s=r?n.highlightRenderTargetId:n.renderTargetId;if(s){G[a]=n.texOffset[0],G[a+1]=n.texOffset[1],z[a]=n.texScale[0],z[a+1]=n.texScale[1];var l=this.drapedRenderer.getRenderTargetTexture(s);this.rctx.bindTexture(l,1+i);var o=n.waterMaskRenderTargetId;if(o){var d=this.drapedRenderer.getRenderTargetTexture(o);this.rctx.bindTexture(d,3+i)}else this.rctx.bindTexture(this.emptyTex,3+i)}else G[a]=0,G[a+1]=0,z[a]=0,z[a+1]=0,this.rctx.bindTexture(this.emptyTex,1+i),this.rctx.bindTexture(this.emptyTex,3+i)}e.setUniform4fv("overlayTexOffset",G),e.setUniform4fv("overlayTexScale",z)},e.prototype._updatePrograms=function(){var e="spherical"===this.manifold,t="shader"===this.wireframe.mode,r=this.programRep;this.programs={color:r.getProgram(E.colorPass,{mode:t||this._renderPatchBorders?"wireframe":"normal",overlay:this.hasOverlays,atmosphere:e&&this._velvetOvergroundEnabled,wireframeTexture:t,tileBorders:this._renderPatchBorders,receiveShadows:this.receiveShadows,screenSizePerspective:this.debugScreenSizePerspective,slice:this._slicePlaneEnabled}),normal:r.getProgram(E.normalPass,{alphaZero:!0}),depth:r.getProgram(E.depthPass,{shadowMap:!1}),depthShadowMap:r.getProgram(E.depthPass,{shadowMap:!0}),highlight:r.getProgram(E.highlightPass,{})},this.defaultPipelineState=I.makePipelineState({culling:this.backfaceCullingEnabled&&I.backFaceCullingParams,depthTest:{func:513},depthWrite:I.defaultDepthWriteParams,colorWrite:I.defaultColorWriteParams}),this.stencilPipelineState=I.makePipelineState(i({},this.defaultPipelineState,{stencilTest:{function:{func:517,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7680}}})),this.setNeedsRender()},e.prototype.releaseTileGeometry=function(e){e.releaseGeometry()&&this.setNeedsRender(),this.renderDataPool.release(e)},e.prototype._prepareScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;e.length<e.data.length&&t.length>0;){var r=t.pop();e.push(r)}this.visibleScaleRangeQueriesInvPtr=e.length},e.prototype._processScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool,r=0;r<e.length;r++){var i=e.data[r];t.release(i),i.callback(r>=this.visibleScaleRangeQueriesInvPtr),i.callback=null}e.clear()},Object.defineProperty(e.prototype,"test",{get:function(){return{tileRenderer:this.tileRenderer}},enumerable:!0,configurable:!0}),e}(),j={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,color:[1,1,1,0],resolution:64},q={overlayEnabled:!1,used:!0},F=d.mat4f64.create(),H=u.vec3f64.create(),W=u.vec3f64.create(),J=u.vec3f64.create(),Y=u.vec3f64.create(),Z=u.vec3f64.create(),X=u.vec3f64.create(),K="TerrainRenderer",$={type:"external"};return V});