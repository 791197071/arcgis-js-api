// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/asyncUtils","../../../core/CollectionFlattener","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/scheduling","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingRect","../../../layers/support/LercWorker","../../../layers/support/TilemapCache","../../2d/engine/vectorTiles/VectorTileDisplayObject","../support/debugFlags","../support/geometryUtils","../support/projectionUtils","./ElevationBounds","./ElevationData","./ElevationTileAgent","./MapTileAgent","./OverlayManager","./PlanarPatch","./SphericalPatch","./SurfaceExtentHelper","./SurfaceTilingSchemeLogic","./TerrainConst","./TerrainRenderer","./terrainUtils","./Tile","./TilemapOnlyTile","./tileUtils","./tileUtils","./UpsampleInfo","../../support/index","../../webgl/Texture","../../webgl/Util","@dojo/framework/shim/Promise"],function(e,t,r,i,n,a,s,o,l,h,d,u,p,c,_,y,g,f,v,m,T,w,L,b,P,S,x,E,R,O,C,I,D,M,U,V,A,k,j,q,B,H,F,W,N,G,X,z,Z,Y,K,J,Q){function $(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function ee(e,t){var r=!1;t=t||e;for(var i=0,n=e.children;i<n.length;i++){var a=n[i];if(a){for(var s=0;s<a.layerInfo.length;s++)for(var o=0,l=a.layerInfo[s];o<l.length;o++){var h=l[o],d=h.upsampleFromTile;if(d&&d.tile===t)return!0}r=r||ee(a,t)}}return r}function te(e){return null!=e.refreshInterval}function re(e){return!e.isLeaf&&(e.children[0].shouldRender||e.children[1].shouldRender||e.children[2].shouldRender||e.children[3].shouldRender||re(e.children[0])||re(e.children[1])||re(e.children[2])||re(e.children[3]))}function ie(e){return e.isLeaf&&e.parent&&e.parent.shouldRender}var ne=p.getLogger("esri.views.3d.terrain.TerrainSurface"),ae=function(t){function s(e,r){var i=t.call(this)||this;return i.defaultTileBackground=F.DEFAULT_TILE_BACKGROUND,i.hideSkirtsDistanceFromExtentMargin=se,i.hideSkirtsMinimumCameraTilt=oe,i.hideSkirtsMaximumCameraTilt=le,i._clippingExtent=null,i._dataExtent=null,i._elevationBounds=new M.ElevationBounds,i._rootExtent=x.create(),i._iteratorPool=new y(Z.IteratorPreorder),i._postorderIterator=new Z.IteratorPostorder,i._visible=!1,i._pendingUpdates=!1,i._asyncWorkItems=0,i._usedMemory=he,i._isFrameProcessing=!1,i._viewChangeUpdateDirty=!1,i._overlayOpacity=1,i._eyePosRenderSR=P.vec3f64.create(),i._eyePosSurfaceSR=P.vec3f64.create(),i._splitLimits=new G.SplitLimits,i._snapLevel=1/0,i._frustum=I.frustum.create(),i._viewProjectionMatrix=L.mat4f64.create(),i._layerViews=[new Array,new Array],i._layerIndexByLayerViewId=[new Map,new Map],i._basemapLayerViewHandles=new Map,i._handles=new u,i._lowPrioUpdates=new g,i._topLevelTilemapOnlyTiles=new Array,i._upsampleInfoPool=new y(Y),i._visibleLevels=new g({deallocator:null}),i._getElevationData={spatialReference:null,rootTiles:null},i.maxTextureScale=1.2,i.rootTiles=null,i.backgroundImage=F.DEFAULT_TILE_BACKGROUND,i.backgroundColor=null,i._scheduledLayerViewChangesHandle=null,i._lercWorker=E.acquireInstance(e.resourceController.scheduler),i}return i(s,t),s.prototype.normalizeCtorArgs=function(e,t){return this._view=e,this._stage=e._stage,this._set("manifold",t),{}},s.prototype.initialize=function(){var t=this;this._tilePool=new y("planar"===this.manifold?j.PlanarPatch:q.SphericalPatch),this._memCache=this._view.resourceController.memoryController.getMemCache("esri.views.3d.terrain",function(e){return t._renderer.releaseTileGeometry(e.renderData)}),this._renderer=new W({manifold:this.manifold,memCache:this._memCache}),this._renderer.install(this._view._stage),m.init(this,"_background",function(){t._renderer.setTileBackground(t._background)}),this._handles.add([this._view.watch("pointsOfInterest",function(e){t._renderer.pointsOfInterest=e}),m.init(C,"TERRAIN_TILE_TREE_SHOW_TILES",function(r){r&&!t._treeDebugger?new Promise(function(t,r){e(["../layers/support/TerrainTileTree3DDebugger"],t,r)}).then(function(e){var r=e.TerrainTileTree3DDebugger;!t._treeDebugger&&C.TERRAIN_TILE_TREE_SHOW_TILES&&(t._treeDebugger=new r({view:t._view}))}):r||!t._treeDebugger||C.TERRAIN_TILE_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)})]),this._set("overlayManager",new k.OverlayManager({terrainSurface:this,view:this._view})),this._handles.add(this.watch("overlayManager.hasHighlights",function(e){return t._handleHasHighlights(e)}),"overlayManager");var r={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?new B.SurfaceExtentHelperGlobal(r):new B.SurfaceExtentHelperLocal(r),this._handles.add(m.init(this.extentHelper,"stencilEnabledExtents",function(e){t._renderer.setStencilEnabledLayerExtents(e)}),"extentHelper");var i=this._view.defaultsFromMap?new h({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(e){return e.layers}}):this._view.map.allLayers,n=new H({layers:i,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",n),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._streamDataRequester=this._view.resourceController.createStreamDataRequester(0);var a=this._view.resourceController.scheduler;this._handles.add(a.registerTask(K.Task.TERRAIN_SURFACE,function(e){return t._frame(e)},function(){return t.updating})),this._view.resourceController.memoryController.events.on("quality-changed",function(){return t._viewChangeUpdate()}),this._handles.add([this._view.on("resize",function(){return t._viewChangeUpdate()}),this._view.watch("state.camera",function(){return t._viewChangeUpdate()},!0),this._view.watch("qualitySettings.tiledSurface.lodBias",function(){return t._viewChangeUpdate()}),this._view.watch("qualitySettings.tiledSurface.reduceTileLevelDifferences",function(){return t._viewChangeUpdate()}),this._view.watch("clippingArea",function(){return t._clippingChanged()})]),this._handles.add(this._view.allLayerViews.on("after-changes",function(){return t._scheduleLayerViewChangesUpdate()})),this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")},s.prototype.destroy=function(){var e=this;this._handles.destroy(),E.releaseInstance(this._lercWorker),this._lercWorker=null,this._removeAllTiles(),this._memCache.destroy(),this._memCache=null,this.tilingSchemeLogic.destroy(),this._set("tilingSchemeLogic",null),this.extentHelper.destroy(),this.extentHelper=null,this._basemapLayerViewHandles.forEach(function(t,r){return e._unregisterTiledLayerView(r)}),this._streamDataRequester=null,this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null)),this._tilePool.destroy(),this._tilePool=null,V.Pool.prune(0),A.Pool.prune(0),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer.uninstall(this._stage),this._renderer.destroy(),this._renderer=null,this._iteratorPool.destroy(),this._iteratorPool=null,this._view=null,this._stage=null,this._upsampleInfoPool.destroy(),this._upsampleInfoPool=null},Object.defineProperty(s.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"frustum",{get:function(){return this._frustum},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"snapLevel",{get:function(){return Math.round(this._snapLevel)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"cullBackFaces",{set:function(e){this._renderer.cullBackFaces=e,this._set("cullBackFaces",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"updating",{get:function(){return!(!(this._pendingUpdates||this._renderer.updating||this._scheduledLayerViewChangesHandle)||!this.ready||this._get("suspended"))},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"baseOpacity",{set:function(e){var t=this._renderer.opaque;this._renderer.opaque=e>=1,this._set("baseOpacity",e);var r=t!==this._renderer.opaque;this._updateTileTextures(r)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"renderOrder",{set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"skirtScale",{set:function(e){this._renderer.skirtScale=e,this._set("skirtScale",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"spatialReference",{get:function(){var e=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=e,e},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"slicePlaneEnabled",{set:function(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"velvetOverground",{set:function(e){e!==this.velvetOverground&&(this._renderer.velvetOvergroundEnabled=e),this._set("velvetOverground",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"wireframe",{set:function(e){this._renderer.setWireframe(e),this._set("wireframe",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"visible",{set:function(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)},enumerable:!0,configurable:!0}),s.prototype.isOpaque=function(){return this._renderer.opaque},Object.defineProperty(s.prototype,"suspended",{set:function(e){this._set("suspended",e),this._viewChangeUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"reduceTileLevelDifferences",{get:function(){return this._view.qualitySettings.tiledSurface.reduceTileLevelDifferences},enumerable:!0,configurable:!0}),s.prototype.intersect=function(e,t,r,i){this._renderer.intersect(e,t,r,i,null)},s.prototype.getElevation=function(e){var t=this._getElevationData.rootTiles;if(!t||!t.length)return null;if(0===t[0].layerInfo[0].length)return null;var r=de;if(Array.isArray(e))r=e;else{var i=e;if("point"===i.type&&!D.pointToVector(i,r,this._getElevationData.spatialReference))return ne.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null}for(var n=0,a=t;n<a.length;n++){var s=a[n];if(s.containsPoint(r)){for(;s&&!s.rendered&&!s.isLeaf;){var o=0;r[0]>.5*(s.extent[0]+s.extent[2])&&(o+=1),r[1]<.5*(s.extent[1]+s.extent[3])&&(o+=2),s=s.children[o]}var l=s.renderData,h=l&&l.geometryState?l.geometryState.samplerData:null;return h?U.sample(r[0],r[1],h):null}}return null},Object.defineProperty(s.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!0,configurable:!0}),s.prototype.getScale=function(e){if(this.tilingScheme){if(!D.pointToVector(e,de,this.spatialReference))return ne.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;var t=this.rootTiles;if(t)for(var r=0,i=t;r<i.length;r++){var n=i[r];if(n.containsPoint(de)){for(;null!=n.children[0];){var a=0;de[0]>n.children[0].extent[2]&&(a+=1),de[1]<n.children[0].extent[1]&&(a+=2),n=n.children[a]}return this._getLodBiasCorrectedScale(n.level)}}}return 1e100},s.prototype.queryVisibleScaleRange=function(e,t,r,i){var n=t?this.tilingScheme.levelAtScale(t):0,a=r?this.tilingScheme.levelAtScale(r):1/0,s=this._getLodBias();this._renderer.queryVisibleLevelRange(e,n+s,a+s,i)},s.prototype._updateTilingSchemeAndExtent=function(){var e=this.tilingSchemeLogic.extent,t=e&&!x.equals(e,this._dataExtent);t&&(this._dataExtent?x.set(this._dataExtent,e):this._dataExtent=x.create(e));var r=this.tilingSchemeLogic.tilingScheme,i=r!==this.tilingScheme;i&&(N.weakAssert(!!r,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",r),this._updateClippingExtent(),r&&(this._updateTiledLayers(),this._renderer.setTileSize(r.pixelSize),this.overlayManager.setSpatialReference(r.spatialReference,"spherical"===this.manifold))),(t||i)&&this._updateRootTiles()},s.prototype._acquireTile=function(e,t,r,i){var n=this._tilePool.acquire();return pe[0]=e,pe[1]=t,pe[2]=r,n.init(pe,i,this),n},s.prototype._updateRootTiles=function(){var e=this,t=this._clippingExtent||this._dataExtent,r=this.tilingScheme;if(t&&r){this._memCache.clear();var i=ue,n=r.rootTilesInExtent(t,i,1/0),a=function(t){var r=e._acquireTile(0,t[1],t[2],null);return 1===r.shouldSplit(e._splitLimits,e._eyePosRenderSR,0)&&r.setPendingUpdate(1),e._loadTile(r),r};if(this.rootTiles){if(n.length>F.MAX_ROOT_TILES)return void ne.warn(F.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);var s=this.rootTiles.map(function(e){return e.lij}),l=o.difference(s,n,$);if(l.removed.length>0||l.added.length>0){var h=this.rootTiles.filter(function(t){return!(o.findIndex(l.removed,$.bind(null,t.lij))>-1&&(e._purgeTile(t),1))});l.added.forEach(function(e){return h.push(a(e))}),this._setRootTiles(h)}}else n.length>F.MAX_ROOT_TILES&&(ne.warn(F.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),n=r.rootTilesInExtent(t,i,F.MAX_ROOT_TILES)),this._setRootTiles(n.map(function(e){return a(e)}));x.equals(i,this._rootExtent)||(this._rootExtent=x.create(i),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}},s.prototype._setRootTiles=function(e){this._set("rootTiles",e),this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTiles(e)},s.prototype._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())},s.prototype._viewChangeUpdate=function(){if(this._stage&&!this.suspended&&this.tilingScheme&&this._visible){if(this._isFrameProcessing)return void(this._viewChangeUpdateDirty=!0);this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTiles(this.rootTiles)}},s.prototype._updateClippingStatus=function(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(16)&&this._updateTileGeometry(e)},s.prototype._updateTiles=function(e){if(e){var t=this._iteratorPool.acquire();t.reset(e);var r,i;for(z.hasVisibleSiblings(e)?(r=this._elevationBounds.min,i=this._elevationBounds.max):(r=1/0,i=-1/0);!t.done;){var n=t.next();if(this._updateClippingStatus(n),n.updateVisibility(),n.setPendingUpdate(8),n.visible){n.updateScreenDepth(this._viewProjectionMatrix),n.renderData&&(r=Math.min(n.elevationBounds[0],r),i=Math.max(n.elevationBounds[1],i));var a=n.shouldSplit(this._splitLimits,this._eyePosRenderSR,0);if(1===a){n.resetPendingUpdate(4),n.isLeaf&&(n.setPendingUpdate(1),t.skipSubtree()),this._pendingUpdates=this._pendingUpdates||n.updating;continue}n.resetPendingUpdate(1)&&n.updateAgentSuspension(),2===a&&n.updateAgents(0)}if(t.skipSubtree(),!n.isLeaf){n.setPendingUpdate(4),n.resetPendingUpdate(1);var s=this._iteratorPool.acquire();for(s.resetOne(n);!s.done;){var o=s.next();this._updateClippingStatus(o),o.updateVisibility(),o.visible&&o.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(s)}this._pendingUpdates=this._pendingUpdates||n.updating}this._iteratorPool.release(t),isFinite(r)&&isFinite(i)&&(this._elevationBounds.min===r&&this._elevationBounds.max===i||(this._elevationBounds.min=r,this._elevationBounds.max=i,this.emit("elevation-bounds-change",null)))}},s.prototype._updateViewDependentParameters=function(){var e=this._view.state.camera,t=Math.tan(.5*e.fovX),r=Math.tan(.5*e.fovY),i=this.tilingScheme.pixelSize,n=Math.pow(2,-this._getLodBias())*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=i/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=i/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this._view.qualitySettings.tiledSurface.angledSplitBias,I.frustum.copy(e.frustum,this._frustum),w.mat4.multiply(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),b.vec3.copy(this._eyePosRenderSR,e.eye),D.vectorToVector(this._eyePosRenderSR,this._view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)},s.prototype._updateSnapLevel=function(){if(this.reduceTileLevelDifferences){var e=C.TESTS_DISABLE_UPDATE_THRESHOLDS?0:.1,t=this._findSnapLevel();if(!(Math.abs(this._snapLevel-t)<e)){var r=this._snapLevel;this._snapLevel=t,r!==this._snapLevel&&this._updateTiles(this.rootTiles)}}},s.prototype._findSnapLevel=function(){if(this._visibleLevels.length<=0)return this._snapLevel;var e=Math.abs(this._view.camera.tilt-90)/90*.4+.3,t=this._visibleLevels,r=Math.round(t.length*e);if(r>=t.length)return this._snapLevel;t.sort(function(e,t){return e-t});for(var i=0,n=r;n<t.length;++n)i+=t.getItemAt(n);var a=t.getItemAt(Math.round(.95*t.length)-1),s=i/(t.length-r);return t.clear(),Math.max(s,a-1)},s.prototype._updateSkirts=function(){var e=this._view.state.camera;N.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,e.near)},s.prototype._updateRender=function(e){e.rendered&&!e.shouldRender&&(re(e)?this._loadChildren(e):ie(e)&&this._loadParent(e))},s.prototype._updateTileGeometry=function(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=he},s.prototype._elevationUpdate=function(e){_e.spatialReference=this.spatialReference,_e.tile=e,_e.extent=e.extent,this.emit("elevation-change",_e),x.containsPoint(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()},s.prototype._frame=function(e){var t=this;this._isFrameProcessing=!0,this._frameTraversal(e),e.run(function(){return z.sortTiles(t._renderer.renderOrder,t._lowPrioUpdates),!1}),e.run(function(){return t._processElevation(e)}),e.run(function(){return t._processTextures(e)}),0!==this._asyncWorkItems&&(this._pendingUpdates=!0),this._lowPrioUpdates.clear(),this._isFrameProcessing=!1,this._runViewChangeUpdateIfDirty(),this.notifyChange("updating")},s.prototype._frameTraversal=function(e){var t=this;if(!this.suspended&&this._pendingUpdates){this._pendingUpdates=!1,this._lowPrioUpdates.clear();var r=this._iteratorPool.acquire(),i=this._eyePosRenderSR;r.reset(this.rootTiles,i);var n=0,a=!1,s=!1,o=new Array;this._visibleLevels.clear();for(var l=function(){},h=this.reduceTileLevelDifferences?function(e){e.visible&&1!==e.shouldSplit(t._splitLimits,i,1)&&e.parent&&1===e.parent.shouldSplit(t._splitLimits,i,1)&&t._visibleLevels.push(e.level)}:l;!r.done&&!e.done;){var d=r.next();n+=d.usedMemory,h(d),d.resetPendingUpdate(4)?(this._mergeTile(d),s=!0,e.madeProgress(),r.skipSubtree()):d.resetPendingUpdate(1)&&(this._splitTile(d)&&o.push(d),a=!0,e.madeProgress()),d.resetPendingUpdate(8)&&(this._updateRender(d),e.madeProgress()),d.hasPendingUpdates&&this._lowPrioUpdates.push(d),this._pendingUpdates=this._pendingUpdates||d.updating,r.done&&(r.reset(o),o.length=0,h!==l&&(this._updateSnapLevel(),h=l))}this._pendingUpdates=this._pendingUpdates||!r.done||this._lowPrioUpdates.length>0,a||s?this._treeDebugger&&this._treeDebugger.update():r.done&&(this._usedMemory=n),this._iteratorPool.release(r),this._visibleLevels.clear()}},s.prototype._processElevation=function(e){var t=this;return this._lowPrioUpdates.some(function(r){return!!e.done||(r.resetPendingUpdate(16)&&(t._updateTileGeometry(r),e.madeProgress()),!1)}),e.hasProgressed},s.prototype._processTextures=function(e){var t=this;return this._lowPrioUpdates.some(function(r){return!!e.done||(r.resetPendingUpdate(32)&&(t._renderer.updateTileTexture(r),t._usedMemory=he,e.madeProgress()),!1)}),e.hasProgressed},s.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var e=x.create(),t=null;return D.extentToBoundingRect(this._view.clippingArea,e,this.spatialReference)&&(t=e),!x.equals(t,this._clippingExtent)&&(this._memCache.clear(),this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)},s.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()},s.prototype._getLodBias=function(){var e=this._view.resourceController.memoryController.memoryFactor;return this._view.qualitySettings.tiledSurface.lodBias-(1-e)*F.MAX_MEMORY_LOD_BIAS},s.prototype._getLodBiasCorrectedScale=function(e){var t=this.tilingScheme.levels,r=c.clamp(e-this._getLodBias(),0,t.length-1),i=Math.floor(r),n=r-i;return t[Math.floor(r)].scale*(1-n)+t[Math.ceil(r)].scale*n},s.prototype._cancelTilemapRequests=function(e){for(var t=0,r=e.layerInfo;t<r.length;t++){var i=r[t];if(i)for(var n=0,a=i;n<a.length;n++){var s=a[n];s.abortTilemapRequest()}}},s.prototype._removeAllTiles=function(){var e=this;this.rootTiles&&(this.rootTiles.forEach(function(t){return e._purgeTile(t)}),this._setRootTiles(null),this.notifyChange("ready"));for(var t=0,r=this._topLevelTilemapOnlyTiles;t<r.length;t++){var i=r[t];_.isSome(i)&&this._cancelTilemapRequests(i)}this.visible=!1},s.prototype._purgeChildTiles=function(e){if(e.isLeaf)return!1;var t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t},s.prototype._purgeTile=function(e){var t=this._purgeChildTiles(e)||e.rendered;return e.unload(this._renderer),this._cancelTilemapRequests(e),e.dispose(),this._tilePool.release(e),t},s.prototype._splitTile=function(e){N.weakAssert(e.isLeaf,"tile that is already split should not be split again!");var t=e.level+1,r=2*e.lij[1],i=2*e.lij[2];return e.setChildren(this._createTile(t,r,i,e),this._createTile(t,r,i+1,e),this._createTile(t,r+1,i,e),this._createTile(t,r+1,i+1,e)),e.setPendingUpdate(8),e.updateAgentSuspension(),ye.spatialReference=this.spatialReference,ye.extent=e.extent,ye.scale=this._getLodBiasCorrectedScale(t),this._pendingUpdates=!0,this.emit("scale-change",ye),e.children[0].hasPendingUpdate(1)||e.children[1].hasPendingUpdate(1)||e.children[2].hasPendingUpdate(1)||e.children[3].hasPendingUpdate(1)},s.prototype._createTile=function(e,t,r,i){N.weakAssert(!!i,"_createTile sanity check");var n=this._acquireTile(e,t,r,i);return n.updateClippingStatus(this._clippingExtent),n.visible&&(n.updateScreenDepth(this._viewProjectionMatrix),1===n.shouldSplit(this._splitLimits,this._eyePosRenderSR,0)&&n.setPendingUpdate(1)),n},s.prototype._mergeTile=function(e){N.weakAssert(!e.hasPendingUpdate(1),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(N.weakAssert(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),ye.spatialReference=this.spatialReference,ye.extent=e.extent,ye.scale=this._getLodBiasCorrectedScale(e.level),this._pendingUpdates=!0,this.emit("scale-change",ye)},s.prototype._loadChildren=function(e){N.weakAssert(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])},s.prototype._loadParent=function(e){var t=e.parent;this._unloadChildren(t),this._loadTile(t)},s.prototype._unloadChildren=function(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))},s.prototype._loadTile=function(e){e.load(this._renderer),e.setPendingUpdate(8),this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(e,e.renderData,this._overlayOpacity),this._elevationUpdate(e)},s.prototype._handleHasHighlights=function(e){this._renderer.setNeedsHighlight(e)},s.prototype._elevationDataUpdated=function(e,t){var r=e.layerInfo[0][t],i=[e],n=e.level,a=this._iteratorPool.acquire();for(a.reset(i);!a.done;){var s=a.next();s.findElevationBoundsForLayer(t,n),s.computeElevationBounds()}this._iteratorPool.release(a),e.dataArrived(t,0,r.data),this._updateTiles(i)},s.prototype._scheduleLayerViewChangesUpdate=function(){var e=this;this._scheduledLayerViewChangesHandle||(this._scheduledLayerViewChangesHandle=v.schedule(function(){return e._handleLayerViewChanges()}),this._handles.add(this._scheduledLayerViewChangesHandle,"scheduledLayerViewChangesHandle"))},s.prototype._handleLayerViewChanges=function(){var e=this;this._handles.remove("scheduledLayerViewChangesHandle"),this._scheduledLayerViewChangesHandle=null;for(var t=!1,r=new Set,i=-1,n=0,a=this._view.allLayerViews.items;n<a.length;n++){var s=a[n];if(r.add(s.uid),N.isTiledLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)){var o=this.layerClassFromLayerView(s),l=this._layerIndexByLayerViewId[o].get(s.uid);l<i&&(t=!0),i=l}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(function(i,n){r.has(n)||(e._unregisterTiledLayerView(n),t=!0)}),this.overlayManager&&this.overlayManager.updateLayerViews(r),t&&this._updateTiledLayers()},s.prototype.layerClassFromLayerView=function(e){return N.isElevationLayerView(e)?0:1},s.prototype._registerTiledLayerView=function(e){var t=this,r=[],i=this.layerClassFromLayerView(e);r.push(e.watch("suspended",function(){return t._updateTiledLayers()})),r.push(e.watch("fullOpacity",function(){return t._updateTileTextures(!1)})),r.push(e.layer.watch("scaleRangeId",function(){return t._restartAllAgents(i)})),e.on("data-changed",function(){var r=t._layerIndexByLayerViewId[i].get(e.uid);null!=r&&t._invalidateLayerData(r,i)}),this._basemapLayerViewHandles.set(e.uid,r)},s.prototype._unregisterTiledLayerView=function(e){var t=this._basemapLayerViewHandles.get(e);if(t){for(var r=0;r<t.length;r++)t[r].remove();this._basemapLayerViewHandles.delete(e)}},s.prototype._updateTiledLayers=function(){var e=this;if(this.tilingScheme&&!this._view.suspended){var t=this._view.allLayerViews,r=[[],[]],i=null,n=x.empty();t.forEach(function(t){var a=t.layer;if(a&&!t.suspended&&N.isTiledLayerView(t)){var s=t.fullExtent;if(!s)return void ne.warn("Terrain: Map or elevation layer does not have fullExtent: "+a.id);if(!e.tilingScheme.compatibleWith(t.tileInfo))return void ne.warn("Terrain: tiling scheme of layer "+a.id+" is incompatible with other tiled layers, will not be drawn");x.expand(n,s);var o=e.layerClassFromLayerView(t);if(1===o){var l=t.displayLevelRange;l.maxLevel!==1/0&&(null===i||l.maxLevel>i)&&(i=l.maxLevel)}r[o].push(t)}});for(var a=0;a<2;a++){var s=this._layerViews[a],o=r[a];o.reverse();var l=o.length,h=s.length!==l,d=new Array(l),u=new Array(s.length);this._layerIndexByLayerViewId[a].clear();for(var p=0;p<l;p++){var c=o[p].uid;this._layerIndexByLayerViewId[a].set(c,p);var y=s.indexOf(o[p]);d[p]=y,p!==y&&(h=!0),y>-1&&(u[y]=p)}if(h){for(var g=0,f=this._topLevelTilemapOnlyTiles;g<f.length;g++){var v=f[g];_.isSome(v)&&v.modifyLayers(u,d,a)}var m=this._postorderIterator;for(m.reset(this.rootTiles);!m.done;)m.next().modifyLayers(u,d,a);this._layerViews[a]=o,0===a&&this._memCache.clear(),this._restartAllAgents(a),this._updateTiles(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}},s.prototype._restartAllAgents=function(e){var t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){var r=t.next();r.restartAgents(e),0===e&&r.computeElevationBounds()}},s.prototype._hasFixedExtent=function(){return!!this._clippingExtent},s.prototype.layerViewByIndex=function(e,t){return this._layerViews[t][e]},s.prototype.numLayers=function(e){return this._layerViews[e].length},s.prototype._updateTileTextures=function(e){var t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){var r=t.next();r.updateAgents(1),e?this.renderer.updateTileTexture(r):r.updateRenderData(1)}this._iteratorPool.release(t)},s.prototype._invalidateLayerData=function(e,t){var r=this._iteratorPool.acquire();for(r.reset(this.rootTiles);!r.done;)r.next().removeLayerAgent(e,t);for(r.reset(this.rootTiles);!r.done;)r.next().invalidateLayerData(e,t);this._iteratorPool.release(r),0===t&&this._memCache.clear()},s.prototype.requestRender=function(e){void 0===e&&(e=1),this.renderer.setNeedsRender(e)},s.prototype.setPendingUpdates=function(){this._pendingUpdates||(this._pendingUpdates=!0,this.notifyChange("updating"))},s.prototype.requestTileData=function(e,t,r,i){var n=this,a=this.layerViewByIndex(t,r),s=a.layer;if(s.tilemapCache&&!N.isVectorTileLayerView(a)){var o=this.getTilemapTile(e),l=o.layerInfo[r][t];if(!l.tilemap)return l.tilemapRequestPromise||(l.tilemapRequestAbort=f.createAbortController(),l.tilemapRequestPromise=this.requestTilemap(o,t,r,a,s,{signal:l.tilemapRequestAbort.signal})),++this._asyncWorkItems,l.tilemapRequestPromise.catch(function(){}).then(function(){--n._asyncWorkItems,l.tilemapRequestPromise=null,l.tilemapRequestAbort=null,f.throwIfAborted(i);var t=n._layerIndexByLayerViewId[r].get(a.uid);if(null!=t)return o.hasDataAvailable(e,t,r)?n._requestTileData(e,t,r,a,i):(n._dispatchDataEvent(e,"dataMissing",r,a,{notInTilemap:!0}),f.reject())});if(!o.hasDataAvailable(e,t,r))return this._dispatchDataEvent(e,"dataMissing",r,a,{notInTilemap:!0}),f.reject()}return this._requestTileData(e,t,r,a,i)},s.prototype._requestTileData=function(e,t,r,i,n){return 0===r?this._requestElevationTileData(e,t,r,i,n):this._requestMapTileData(e,r,i,n)},s.prototype._requestElevationTileData=function(e,t,r,i,n){var a=this;if(!N.isElevationLayerView(i))return void N.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views");var s=function(n){--a._asyncWorkItems;var s=a._layerIndexByLayerViewId[r].get(i.uid);if(null==s)return void ne.warn("TerrainSurface: received data from unknown layer %d %s",r,e.lij.toString());a._usedMemory=he,a._pendingUpdates=!0,e.layerInfo[r][s].data=U.create(e.lij,e.extent,n),a._elevationDataUpdated(e,t)},o=function(t){--a._asyncWorkItems,f.isAbortError(t)||a._dispatchDataEvent(e,"dataMissing",r,i,t)};if(++this._asyncWorkItems,N.useFetchTileForLayer(i.layer))return i.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:F.ELEVATION_NODATA_VALUE,signal:n.signal}).then(function(e){return s(e)},o);var l=i.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._streamDataRequester.request(l,"binary",n).then(function(e){return a._lercWorker.decode(e,{noDataValue:F.ELEVATION_NODATA_VALUE},n.signal)}).then(function(e){s({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}).catch(function(e){return o(e)})},s.prototype._requestMapTileData=function(e,t,r,i){var n=this;++this._asyncWorkItems;var a=function(i){--n._asyncWorkItems,n._dispatchDataEvent(e,"dataArrived",t,r,i)},s=function(i){--n._asyncWorkItems,
f.isAbortError(i)||n._dispatchDataEvent(e,"dataMissing",t,r,i)};if(N.isVectorTileLayerView(r)){var o=r.tileHandler,h=r.schemaHelper.getLevelRowColumn(e.lij);return l.safeCast(o.getVectorTile(h[0],h[1],h[2])).then(function(e){f.isAborted(i)?--n._asyncWorkItems:a(e)},s)}if(N.useFetchTileForLayer(r.layer)&&N.isTileLayerView(r)){return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,s)}var d=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return te(r)&&r.refreshTimestamp&&(d+=(d.indexOf("?")>-1?"&":"?")+"_ts="+r.refreshTimestamp),this._streamDataRequester.request(d,"image",i).then(a,s)},s.prototype.requestTilemap=function(e,t,i,n,a,s){var o=this,l=e.lij[0]+R.TILEMAP_SIZE_EXP,h=Math.round(e.lij[1]*Math.pow(2,R.TILEMAP_SIZE_EXP)),d=Math.round(e.lij[2]*Math.pow(2,R.TILEMAP_SIZE_EXP));return a.tilemapCache.fetchTilemap(l,h,d,r({},s,{timeout:6e3})).then(function(r){null!=(t=o._layerIndexByLayerViewId[i].get(n.uid))&&(e.layerInfo[i][t].tilemap=r)}).catch(function(e){})},s.prototype.getTilemapTile=function(e){var t=e.level;if(t>R.TILEMAP_SIZE_EXP)return z.getTileNLevelsUp(e,R.TILEMAP_SIZE_EXP);var r=this._topLevelTilemapOnlyTiles[t];if(_.isSome(r))return r;var i=z.getRootTile(e),n=R.TILEMAP_SIZE_EXP-t+i.level,a=[t-R.TILEMAP_SIZE_EXP,i.lij[1]/Math.pow(2,n),i.lij[2]/Math.pow(2,n)];return r=new X(a,this._upsampleInfoPool,[this._layerViews[0].length,this._layerViews[1].length]),this._topLevelTilemapOnlyTiles[t]=r,r},s.prototype._dispatchDataEvent=function(e,t,r,i,n){var a=this._layerIndexByLayerViewId[r].get(i.uid);null!=a?e[t](a,r,n):ne.warn("TerrainSurface: received data from unknown layer")},s.prototype.updateTileOverlayParams=function(){if(this.rootTiles){var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var t=e.next();t.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(t,t.renderData,this._overlayOpacity)}this._iteratorPool.release(e),this._renderer.setNeedsRender()}},s.prototype.updateOverlayOpacity=function(){if(this.overlayManager){var e=this._eyePosSurfaceSR[2],t=this.overlayManager.updateOpacity(e);if(!isNaN(t)&&t!==this._overlayOpacity){var r=this._iteratorPool.acquire();for(r.reset(this.rootTiles);!r.done;){var i=r.next();i.renderData&&(i.renderData.overlayOpacity=t)}this._iteratorPool.release(r),this._overlayOpacity=t,this._renderer.setNeedsRender()}}},s.prototype.getStats=function(){var e={numNodes:0,numLeaves:0,numVisible:0,numRendered:0,numVisiblePerLevel:new Array,numLoadedPerLevel:new Array},t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){var r=t.next();e.numNodes++,r.isLeaf&&e.numLeaves++;var i=r.level;r.rendered&&(e.numRendered++,e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),r.visible&&(e.numVisible++,e.numVisiblePerLevel[i]=(e.numVisiblePerLevel[i]||0)+1)}return this._iteratorPool.release(t),e},s.prototype.getUsedMemory=function(){if(!this.tilingScheme)return 0;if(this._usedMemory===he){var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles),this._usedMemory=0;!e.done;){var t=e.next();this._usedMemory+=t.usedMemory}this._iteratorPool.release(e)}return this._usedMemory},s.prototype.getMemoryUsage=function(){if(!this.tilingScheme)return{};var e=0,t=0,r=0,i=this._iteratorPool.acquire();i.reset(this.rootTiles);for(var n=this.tilingScheme.pixelSize,a=n*n*4;!i.done;){for(var s=i.next(),o=ee(s),l=0,h=s.layerInfo[1];l<h.length;l++){var d=h[l],u=d.data,p=0,c=0;u instanceof J?p+=Q.getGpuMemoryUsage(u):u instanceof HTMLImageElement?c+=a:u instanceof O&&(r+=u.getMemoryUsage()),s.renderData||o?(e+=c,e+=p):(t+=c,t+=p)}for(var _=0,y=s.layerInfo[0];_<y.length;_++){var d=y[_],u=d.data;e+=u?a:0}if(s.renderData){var g=s.renderData.textureDescriptor;e+=g?Q.getGpuMemoryUsage(g):0;var f=s.renderData.estimatedGeometryMemoryUsage;r+=f,r+=f}}return this._iteratorPool.release(i),{visibleImageData:e,invisibleImageData:t,geometryData:r}},s.prototype.getTile=function(e){var t=e.split("/").map(function(e){return+e});if(0===t[0])return o.find(this.rootTiles,function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]});var r,i=Math.pow(2,t[0]),n=Math.floor(t[1]/i),a=Math.floor(t[2]/i);if(this.rootTiles.some(function(e){return e.lij[1]===n&&e.lij[2]===a&&(r=e,!0)}),r){for(var s=1<<t[0]-1;r.lij[0]<t[0];){var l=t[1]&s?2:0;if((t[2]&s)>0&&l++,!r.children[l])return console.log("Tile "+e+" doesn't exist, smallest ancestor is "+z.tile2str(r)),null;r=r.children[l],s>>=1}return N.weakAssert(r.lij[0]===t[0]&&r.lij[1]===t[1]&&r.lij[2]===t[2],"not the right tile?"),r}return null},s.prototype.setBorders=function(e){this._renderer.renderPatchBorders=e},s.prototype.setDisableRendering=function(e){this._renderer.renderingDisabled=e},s.prototype.getRenderedTiles=function(){ce.clear();var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var t=e.next();t.visible&&t.rendered&&ce.push(t)}return this._iteratorPool.release(e),z.sortTiles(this.renderOrder,ce),ce.toArray()},Object.defineProperty(s.prototype,"test",{get:function(){var e=this;return{renderer:this._renderer,lercWorker:this._lercWorker,mergeTile:function(t){return e._mergeTile(t)},updateTiles:function(t){return e._updateTiles(t)}}},enumerable:!0,configurable:!0}),n([T.property()],s.prototype,"_renderer",void 0),n([T.property({value:!1})],s.prototype,"cullBackFaces",null),n([T.property({readOnly:!0})],s.prototype,"extent",null),n([T.property({readOnly:!0,dependsOn:["ready","_renderer.updating","_scheduledLayerViewChangesHandle"]})],s.prototype,"updating",null),n([T.property({value:1})],s.prototype,"baseOpacity",null),n([T.property({readOnly:!0})],s.prototype,"overlayManager",void 0),n([T.property({readOnly:!0})],s.prototype,"manifold",void 0),n([T.property()],s.prototype,"maxTextureScale",void 0),n([T.property({readOnly:!0})],s.prototype,"ready",null),n([T.property({value:1})],s.prototype,"renderOrder",null),n([T.property({readOnly:!0})],s.prototype,"rootTiles",void 0),n([T.property({value:!0})],s.prototype,"skirtScale",null),n([T.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],s.prototype,"spatialReference",null),n([T.property({})],s.prototype,"backgroundImage",void 0),n([T.property({type:a})],s.prototype,"backgroundColor",void 0),n([T.property({dependsOn:["backgroundColor","backgroundImage"]})],s.prototype,"_background",null),n([T.property({value:!1})],s.prototype,"slicePlaneEnabled",null),n([T.property({readOnly:!0})],s.prototype,"tilingScheme",void 0),n([T.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],s.prototype,"tilingSchemeLocked",void 0),n([T.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],s.prototype,"tilingSchemeDone",void 0),n([T.property({readOnly:!0})],s.prototype,"tilingSchemeLogic",void 0),n([T.property({value:!0})],s.prototype,"velvetOverground",null),n([T.property({value:!1})],s.prototype,"wireframe",null),n([T.property({value:!1})],s.prototype,"suspended",null),n([T.property()],s.prototype,"_scheduledLayerViewChangesHandle",void 0),s=n([T.subclass("esri.views.3d.terrain.TerrainSurface")],s)}(T.declared(d.EventedMixin(s))),se=1.2,oe=80/180*Math.PI,le=110/180*Math.PI,he=-1,de=S.vec4f64.create(),ue=x.create(),pe=[0,0,0],ce=new g,_e={spatialReference:null,tile:null,extent:null,context:"ground"},ye={spatialReference:null,extent:null,scale:0};return ae});