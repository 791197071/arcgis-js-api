// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/unitUtils","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","./earthUtils","./mathUtils","../webgl-engine/lib/BufferVectorMath"],function(e,n,t,a,r,i,l,c,o,u,s,f,p,h,R){function m(e,n){return!!Z(e,n,le)}function d(e,n,t,a){return 2===e.length?(fe[0]=e[0],fe[1]=e[1],fe[2]=0,e=fe):e===t&&(l.vec3.copy(fe,e),e=fe),I(e,n,0,t,a,0,1)}function v(e,n,t,a){void 0===t&&(t=n.spatialReference),void 0===a&&(a=0),fe[0]=e.x,fe[1]=e.y;var r=e.z;return fe[2]=void 0!==r?r:a,!!I(fe,e.spatialReference,0,fe,t,0,1)&&(n.x=fe[0],n.y=fe[1],n.spatialReference=t,void 0!==r?(n.z=fe[2],n.hasZ=!0):(n.z=void 0,n.hasZ=!1),!0)}function M(e,n,t,a){void 0===a&&(a=0),fe[0]=e.x,fe[1]=e.y;var r=e.z;return fe[2]=void 0!==r?r:a,I(fe,e.spatialReference,0,n,t,0,1)}function x(e,n,t,a){var r;return t instanceof o?(r=t,a=a||r.spatialReference):f.isPoint(t)?(r=t,r.hasZ=!0,a=a||r.spatialReference):(a=t,r=new o({spatialReference:a})),I(e,n,0,fe,a,0,1)?(r.x=fe[0],r.y=fe[1],r.z=fe[2],r.spatialReference=a,r):null}function T(e,n,t,a,r,i){return fe[0]=e,fe[1]=n,fe[2]=t,I(fe,a,0,r,i,0,1)}function I(e,n,t,r,i,l,c){void 0===c&&(c=1);var o=Z(n,i,le);if(a.isNone(o))return!1;if(o===U){if(e===r&&t===l)return!0;for(var u=t+3*c,s=t,f=l;s<u;s++,f++)r[f]=e[s];return!0}for(var p=t+3*c,s=t,f=l;s<p;s+=3,f+=3)o(e,s,r,f);return!0}function S(e,n,t,r){var l=b(e,re),c=b(r,ie);if(l===c&&1!==c&&(0!==l||e.equals(r)))return i.mat4.identity(t),i.mat4.translate(t,t,n),!0;if(1===c){var o=ae[l][6],u=ae[6][c];if(a.isNone(o)||a.isNone(u))return!1;o(n,0,pe,0),u(pe,0,he,0);var s=oe*pe[0],f=oe*pe[1],p=Math.sin(s),h=Math.cos(s),R=Math.sin(f),m=Math.cos(f),d=t;return d[0]=-p,d[4]=-R*h,d[8]=m*h,d[12]=he[0],d[1]=h,d[5]=-R*p,d[9]=m*p,d[13]=he[1],d[2]=0,d[6]=m,d[10]=R,d[14]=he[2],d[3]=0,d[7]=0,d[11]=0,d[15]=1,!0}if(3===c&&(2===l||1===l)){var o=ae[l][6],v=ae[6][3];if(a.isNone(o)||a.isNone(v))return!1;o(n,0,pe,0);var M=oe*pe[1];v(pe,0,he,0),i.mat4.identity(t),i.mat4.translate(t,t,he);var x=1/Math.cos(M);return i.mat4.scale(t,t,[x,x,1]),!0}return!1}function y(e,n,t,a,r){l.vec3.copy(Re,e),l.vec3.add(me,e,n),d(Re,t,Re,r),d(me,t,me,r),l.vec3.subtract(a,me,Re),l.vec3.normalize(a,a)}function P(e,n,t,r){var i=D(n,r,ce);if(i.projector===U)return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],!0;if(a.isNone(i.projector))return!1;var l=i.source,c=i.dest;if(3===c.spatialReferenceId){var o=ae[l.spatialReferenceId][2];if(a.isNone(o))return!1;o(e,0,pe,0);var u=Math.abs(oe*pe[1])+Math.asin(e[3]/(p.earthRadius+e[2]));if(O(pe,0,t,0),u>.9999*Math.PI)t[3]=Number.MAX_VALUE;else{var s=1/Math.cos(u);t[3]=s*e[3]}return!0}return i.projector(e,0,t,0),t[3]=e[3]*l.metersPerUnit/c.metersPerUnit,!0}function E(e,n,t){if(null==e)return!1;var a=!0;return fe[0]=null!=e.xmin?e.xmin:0,fe[1]=null!=e.ymin?e.ymin:0,fe[2]=null!=e.zmin?e.zmin:0,a=a&&I(fe,e.spatialReference,0,n,t,0,1),fe[0]=null!=e.xmax?e.xmax:0,fe[1]=null!=e.ymax?e.ymax:0,fe[2]=null!=e.zmax?e.zmax:0,a=a&&I(fe,e.spatialReference,0,n,t,3,1),null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.zmin&&(n[2]=-1/0),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),a}function G(e,n,t){if(null==e)return!1;var a=!0;return fe[0]=null!=e.xmin?e.xmin:0,fe[1]=null!=e.ymin?e.ymin:0,fe[2]=null!=e.zmin?e.zmin:0,a=a&&I(fe,e.spatialReference,0,fe,t,0,1),n[0]=fe[0],n[1]=fe[1],fe[0]=null!=e.xmax?e.xmax:0,fe[1]=null!=e.ymax?e.ymax:0,fe[2]=null!=e.zmax?e.zmax:0,a=a&&I(fe,e.spatialReference,0,fe,t,0,1),n[2]=fe[0],n[3]=fe[1],null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),a}function g(e,n,t,a){if(null==e)return!1;if(n.equals(a))return s.set(t,e),!0;var r=!0;return fe[0]=e[0],fe[1]=e[1],fe[2]=0,r=r&&I(fe,n,0,fe,a,0,1),t[0]=fe[0],t[1]=fe[1],fe[0]=e[2],fe[1]=e[3],fe[2]=0,r=r&&I(fe,n,0,fe,a,0,1),t[2]=fe[0],t[3]=fe[1],r}function b(e,t){return t.spatialReference===e?t.spatialReferenceId:(t.spatialReference=e,"metersPerUnit"in t&&(t.metersPerUnit=r.getMetersPerUnitForSR(e,1)),e.wkt===n.SphericalECEFSpatialReference.wkt?t.spatialReferenceId=1:e.isWGS84?t.spatialReferenceId=2:e.isWebMercator?t.spatialReferenceId=3:e.wkt===n.WGS84ECEFSpatialReference.wkt?t.spatialReferenceId=4:4490===e.wkid?t.spatialReferenceId=5:t.spatialReferenceId=0)}function U(e,n,t,a){t[a++]=e[n++],t[a++]=e[n++],t[a]=e[n]}function z(e,n,t,a){t[a++]=ue*(e[n++]/p.earthRadius),t[a++]=ue*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/p.earthRadius))),t[a]=e[n]}function A(e,n,t,a){z(e,n,t,a),W(t,a,t,a)}function w(e,n,t,a){z(e,n,t,a),k(t,a,t,a)}function O(e,n,a,r){var i=.4999999*Math.PI,l=t.clamp(oe*e[n+1],-i,i),c=Math.sin(l);a[r++]=oe*e[n]*p.earthRadius,a[r++]=p.halfEarthRadius*Math.log((1+c)/(1-c)),a[r]=e[n+2]}function C(e){var n=b(e,re);return!!ae[n][6]}function N(e,n,t){var r=b(n,re),i=ae[r][6];return!a.isNone(i)&&(i(e,0,fe,0),t!==fe&&(t[0]=fe[0],t[1]=fe[1],t.length>2&&(t[2]=fe[2])),!0)}function H(e,n){return fe[0]=e.x,fe[1]=e.y,fe[2]=e.hasZ?e.z:0,N(fe,e.spatialReference,n)}function j(e,n){var t=b(n.spatialReference,ie);return!a.isNone(ae[6][t])&&(!!H(e,fe)&&(n.x=fe[0],n.y=fe[1],n.z=fe[2],!0))}function L(e,n,t,a){void 0===a&&(a=0);var r=p.earthRadius+a,i=Math.cos(t);e[0]=Math.cos(n)*i*r,e[1]=Math.sin(n)*i*r,e[2]=Math.sin(t)*r}function W(e,n,t,a){var r=p.earthRadius+e[n+2],i=oe*e[n+1],l=oe*e[n],c=Math.cos(i);t[a++]=Math.cos(l)*c*r,t[a++]=Math.sin(l)*c*r,t[a]=Math.sin(i)*r}function q(e,n,t,a){var r=R.Vec3Compact.length(e,n),i=h.asin(e[n+2]/(0===r?1:r)),l=Math.cos(i),c=l*r,o=(e[n+1]>0?1:-1)*h.acos(e[n]/(0===c?1:c));t[a++]=ue*o,t[a++]=ue*i,t[a]=r-p.earthRadius}function X(e,n,t,a){q(e,n,t,a),O(t,a,t,a)}function Y(e,n,t,a){q(e,n,t,a),k(t,a,t,a)}function k(e,n,t,a){var r=se,i=oe*e[n],l=oe*e[n+1],c=e[n+2],o=Math.sin(l),u=Math.cos(l),s=r.a/Math.sqrt(1-r.e2*o*o);t[a++]=(s+c)*u*Math.cos(i),t[a++]=(s+c)*u*Math.sin(i),t[a++]=(s*(1-r.e2)+c)*o}function B(e,n,t,a){var r,i,l,c,o,u,s,f,p,h,R,m,d,v,M,x,T,I,S,y,P,E=se,G=e[n],g=e[n+1],b=e[n+2];r=Math.abs(b),i=G*G+g*g,l=Math.sqrt(i),c=i+b*b,o=Math.sqrt(c),y=Math.atan2(g,G),u=b*b/c,s=i/c,v=E.a2/o,M=E.a3-E.a4/o,s>.3?(f=r/o*(1+s*(E.a1+v+u*M)/o),S=Math.asin(f),h=f*f,p=Math.sqrt(1-h)):(p=l/o*(1-u*(E.a5-v-s*M)/o),S=Math.acos(p),h=1-p*p,f=Math.sqrt(h)),R=1-E.e2*h,m=E.a/Math.sqrt(R),d=E.a6*m,v=l-m*p,M=r-d*f,T=p*v+f*M,x=p*M-f*v,I=x/(d/R+T),S+=I,P=T+x*I/2,b<0&&(S=-S),t[a++]=ue*y,t[a++]=ue*S,t[a]=P}function F(e,n,t,a){B(e,n,t,a),W(t,a,t,a)}function V(e,n,t,a){B(e,n,t,a),O(t,a,t,a)}function Z(e,n,t){return D(e,n,t).projector}function D(e,n,t){if(t.source.spatialReference===e&&t.dest.spatialReference===n)return t;var a=b(e,t.source),r=b(n,t.dest);return 0===a&&0===r?e.equals(n)?t.projector=U:t.projector=null:t.projector=ae[a][r],t}Object.defineProperty(n,"__esModule",{value:!0});var _,J,K,Q,$,ee,ne,te;n.SphericalECEFSpatialReference=new u({wkt:'GEOCCS["Spherical geocentric",\n  DATUM["Not specified",\n    SPHEROID["Sphere",\' + earthUtils.earthRadius + \',0]],\n  PRIMEM["Greenwich",0.0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",EAST],\n  AXIS["Geocentric Z",NORTH]\n]'}),n.WGS84ECEFSpatialReference=new u({wkt:'GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",6378137,298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]'}),n.canProject=m,n.vectorToVector=d,n.pointToPoint=v,n.pointToVector=M,n.vectorToPoint=x,n.xyzToVector=T,n.bufferToBuffer=I,n.computeLinearTransformation=S,n.transformDirection=y,n.mbsToMbs=P,n.extentToBoundingBox=E,n.extentToBoundingRect=G,n.boundingRectToBoundingRect=g;!function(e){function n(e){return e/p.earthRadius}function t(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/p.earthRadius))}function a(e){return e*p.earthRadius}function r(e){var n=Math.sin(e);return p.earthRadius/2*Math.log((1+n)/(1-n))}e.x2lon=n,e.y2lat=t,e.lon2x=a,e.lat2y=r}(n.webMercator||(n.webMercator={})),n.canProjectToWGS84ComparableLonLat=C,n.vectorToWGS84ComparableLonLat=N,n.pointToWGS84ComparableLonLat=H,n.pointToWGS84ComparableLonLatPoint=j,n.wgs84ComparableLonLatToECEF=L;var ae=(_={},_[2]=(J={},J[5]=null,J[6]=U,J[1]=W,J[0]=null,J[3]=O,J[2]=U,J[4]=k,J),_[5]=(K={},K[5]=U,K[6]=U,K[1]=W,K[0]=null,K[3]=null,K[2]=null,K[4]=k,K),_[3]=(Q={},Q[5]=null,Q[6]=z,Q[1]=A,Q[0]=null,Q[3]=U,Q[2]=z,Q[4]=w,Q),_[4]=($={},$[5]=B,$[6]=B,$[1]=F,$[0]=null,$[3]=V,$[2]=B,$[4]=U,$),_[1]=(ee={},ee[5]=q,ee[6]=q,ee[1]=U,ee[0]=null,ee[3]=X,ee[2]=q,ee[4]=Y,ee),_[0]=(ne={},ne[5]=null,ne[6]=null,ne[1]=null,ne[0]=U,ne[3]=null,ne[2]=null,ne[4]=null,ne),_[6]=(te={},te[5]=null,te[6]=U,te[1]=W,te[0]=null,te[3]=null,te[2]=U,te[4]=k,te),_),re={spatialReference:null,spatialReferenceId:0},ie={spatialReference:null,spatialReferenceId:0},le={source:{spatialReference:null,spatialReferenceId:0},dest:{spatialReference:null,spatialReferenceId:0},projector:U},ce={source:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:0,metersPerUnit:1},projector:U},oe=h.deg2rad(1),ue=h.rad2deg(1),se={a:6378137,e2:.006694379990137799,a1:42697.67270715754,a2:1823091254.6075456,a3:142.91722289812412,a4:4557728136.518864,a5:42840.589930055656,a6:.9933056200098622},fe=c.vec3f64.create(),pe=c.vec3f64.create(),he=c.vec3f64.create(),Re=c.vec3f64.create(),me=c.vec3f64.create()});