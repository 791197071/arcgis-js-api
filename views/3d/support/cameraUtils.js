// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Camera","../../../config","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../camera/intersectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./mathUtils","./projectionUtils","../../support/spatialReferenceSupport"],function(e,t,r,n,a,i,o,c,l,s,u,f,v,d,p,m,g,h,T,y,S,x){function M(e){return e.spatialReference||d.WGS84}function R(e){return"global"===e.viewingMode?h:g}function C(e,t,r,n,a){return R(e).headingTiltToDirectionUp(t,r,n,a)}function w(e,t){var r=e.renderSpatialReference,n=R(e).headingTiltToDirectionUp,a=f.vec3f64.create();if(!S.pointToVector(t.position,a,r))return null;var i=n(a,t.heading,t.tilt);u.vec3.scale(i.direction,i.direction,e.state.camera.distance),u.vec3.add(i.direction,i.direction,a);var o=m.cameraOnContentAlongViewDirection(e,a,i.direction,i.up);return o.fov=l.deg2rad(t.fov),o}function b(e,t,r){var n=e.renderSpatialReference,a=u.vec3.copy(ce,t.viewForward),o=A(e,t.eye,a,t.up,le),c=M(e);return S.vectorToVector(t.eye,n,ie,c)||(c=d.WGS84,S.vectorToVector(t.eye,n,ie,c)),r?(r.position.x=ie[0],r.position.y=ie[1],r.position.z=ie[2],r.position.spatialReference=c,r.heading=o.heading,r.tilt=o.tilt,r.fov=l.rad2deg(t.fov),r):new i(new v(ie,c),o.heading,o.tilt,l.rad2deg(t.fov))}function D(e,t,r){var n=e.state.camera,a=n.fovX,i=n.width/2/n.pixelRatio;return"global"===e.viewingMode&&null!=r&&(t*=Math.cos(l.deg2rad(r))),t/=e.renderCoordsHelper.unitInMeters,i/(o.screenDPI*te/t)/Math.tan(a/2)}function U(e,t,r){var n=e.state.camera,a=n.fovX,i=t*Math.tan(a/2),c=n.width/2/n.pixelRatio,s=c/i,u=o.screenDPI*te,f=u/s;return"global"===e.viewingMode&&(f/=Math.cos(l.deg2rad(r))),f*=e.renderCoordsHelper.unitInMeters}function z(e,t,r,n,a,i){return P(e,t,D(e,r,t.latitude),n,a,i)}function P(e,t,r,n,a,i){if(Q(i)){var o=B(i.signal);return L(e,n.heading,n.tilt,t,r,a,o),void o.resolver.promise.then(function(t){return i.resolver.resolve(k(e,t,n.fov))},function(e){return i.resolver.reject(e)})}var c=L(e,n.heading,n.tilt,t,r,a);return k(e,c,n.fov,i)}function A(e,t,r,n,a){return R(e).directionToHeadingTilt(t,r,n,a)}function E(e,t,r){return e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,se,e.spatialReference)&&e.basemapTerrain.getElevation(se)>se.z-1}function H(e,t,r,i){return a(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:return e.renderCoordsHelper.fromRenderCoords(t,se,e.spatialReference)?[4,e.elevationProvider.queryElevation(se,i)]:[2,!1];case 1:return r=n.sent(),[2,r>se.z-10]}})})}function O(e,t,r){return a(this,void 0,void 0,function(){var a,i;return n(this,function(n){switch(n.label){case 0:return a=f.vec3f64.create(),t?[3,1]:(u.vec3.copy(a,e.state.camera.center),[3,5]);case 1:return t instanceof v?(S.pointToVector(t,a,e.renderSpatialReference),null!=t.z||null==e.basemapTerrain?[3,3]:[4,e.elevationProvider.queryElevation(t,r)]):[3,4];case 2:return i=n.sent(),null!=i&&e.renderCoordsHelper.setAltitude(i,a),[2,a];case 3:return[3,5];case 4:u.vec3.copy(a,t),n.label=5;case 5:return[2,a]}})})}function I(e,t){var r=f.vec3f64.create();if(t&&t instanceof v){if(S.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=e.elevationProvider.getElevation(t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?u.vec3.copy(r,t):u.vec3.copy(r,e.state.camera.center);return r}function L(e,t,r,n,a,i,o){var c=n&&n instanceof v?n:null;if(Q(o))return void O(e,n,o.signal).then(function(n){V(e,t,r,c,n,a,i,o)},function(e){return o.resolver.reject(e)});var l=I(e,n);return V(e,t,r,c,l,a,i,o)}function V(e,t,r,n,a,i,o,c){if(!n){var l=e.renderSpatialReference,s=M(e);n=S.vectorToPoint(a,l,s)}i=Math.max(i,e.state.constraints.minimumPoiDistance);var u=G(e,t,r,a,i,o),v=R(e).eyeForCenterWithHeadingTilt,d=v(a,i,u.heading,u.tilt);if(o===$.ADJUST&&"global"===e.viewingMode&&r>0){var p=function(){var l=X(e,a,i,W(e,i,r,a));return o=r-l<1?$.LOCKED:$.ADJUST,V(e,t,l,n,a,i,o,c)};if(E(e,d.eye,d.tilt))return p();if(Q(c))return void H(e,d.eye,d.tilt,c.signal).then(function(e){if(e)return p();c.resolver.resolve({eye:d.eye,up:d.up,center:f.vec3f64.clone(a),heading:d.heading,tilt:d.tilt})})}var m=!c||Q(c)?{center:f.vec3f64.create(),eye:f.vec3f64.create(),up:f.vec3f64.create(),tilt:0,heading:0}:c;return m.eye=d.eye,m.up=d.up,m.center=f.vec3f64.clone(a),m.heading=d.heading,m.tilt=d.tilt,Q(c)&&c.resolver.resolve(m),m}function j(e,t,r,n,a,i){var o,c=0;null!=t.zmax&&null!=t.zmin&&(o=(t.zmax+t.zmin)/2,c=t.zmax-t.zmin);var l,s,u;if("global"===e.viewingMode){if(!x.isSpatialReferenceSupported(t.spatialReference,"global"))return Q(i)&&i.resolver.reject(),null;var f=new v(t.xmin,t.ymin,t.spatialReference),d=new v(t.xmax,t.ymax,t.spatialReference),p=t.spatialReference.isGeographic?fe:ue;l=new v(p.center(f.x,d.x),(d.y+f.y)/2,t.spatialReference),null!=o&&(l.z=o);var m=T.getGreatCircleSpanAt(l,f,d);s=m.lon,u=m.lat,p.diff(f.x,d.x)>p.range/2&&(s+=T.halfEarthCircumference),s=Math.min(s,T.halfEarthCircumference),u=Math.min(u,T.halfEarthCircumference)}else{var g=M(e);s=t.xmax-t.xmin,u=t.ymax-t.ymin,l=new v({x:t.xmin+.5*s,y:t.ymin+.5*u,z:o,spatialReference:g})}var h=e.state.camera,y=1/Math.tan(h.fovX/2),S=1/Math.tan(h.fovY/2),R=1/Math.tan(h.fov/2),C=Math.max(.5*s*y,.5*u*S,.5*c*R)/re;if(Q(i)){var w=B(i.signal);return L(e,r,n,l,C,a,w),void w.resolver.promise.then(function(t){return i.resolver.resolve(k(e,t,e.camera.fov))},function(e){return i.resolver.reject(e)})}var b=L(e,r,n,l,C,a);return k(e,b,e.camera.fov,i)}function F(e,t,r,n,a){t||(r||(r=e.state.camera),t=b(e,r,a));var i,o,c=e.renderSpatialReference;if(r)i=S.vectorToPoint(r.center,c,M(e)),o=r.distance;else{if(!(i=e.toMap(e.screenCenter)))return null;o=T.computeCartesianDistance(t.position,i)}r||(r=e.state.camera);var l=Math.tan(r.fovX/2),s=Math.tan(r.fovY/2),u=2*o*l*re,f=2*o*s*re;return"global"===e.viewingMode?h.toExtent(e,i,u,f,n):g.toExtent(e,i,u,f,n)}function q(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>ne)return!0;var a=e.renderSpatialReference,i=M(e),o=S.vectorToPoint(t,a,i),c=S.vectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a,i),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>ae}function G(e,t,r,n,a,i){var o=0;return i===$.ADJUST&&q(e,n,a)?(t=0,o=J(e,a,r,n)):o=K(e,n,a,r),o=e.state.constraints.clampTilt(a,o),r=X(e,n,a,o),{heading:t,tilt:r}}function J(e,t,r,n){var a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);var i=a.min*(1-ve)+a.max*ve,o=K(e,n,t,r);return Math.min(o,i)}function W(e,t,r,n){var a=e.state.constraints.tilt(t),i=K(e,n,t,r);return i=Math.min(i,.5*Math.PI),a.min*(1-ve)+i*ve}function X(e,t,r,n){return R(e).lookAtTiltToEyeTilt(t,r,n)}function K(e,t,r,n){return R(e).eyeTiltToLookAtTilt(t,r,n)}function k(e,t,r,n){var a=e.renderSpatialReference,o=M(e),c=S.vectorToPoint(t.eye,a,o);return c?n?(n.position=c,n.heading=t.heading,n.tilt=t.tilt,n.fov=r,n):new i(c,t.heading,t.tilt,r):null}function Y(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.levelAtScale(t):void ee.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Z(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.scaleAtLevel(t):void ee.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function _(e,t){return e.spatialReference?p.getResolutionForScale(t,e.spatialReference):void 0}function N(e,t,r){var n=e.renderSpatialReference;t||(t=e.state.camera);var a,o,c=d.WGS84;return t instanceof i?(a=t.position.latitude,S.pointToVector(t.position,ie,n),S.pointToVector(r,oe,n),o=u.vec3.distance(ie,oe)):(S.vectorToVector(t.center,n,oe,c),a=oe[1],o=t.distance),U(e,o,a)}function B(e){return{resolver:s.createResolver(),signal:e}}function Q(e){return e&&"resolver"in e}Object.defineProperty(t,"__esModule",{value:!0});var $,ee=c.getLogger("esri.views.3d.support.cameraUtils"),te=39.37,re=1,ne=8,ae=5,ie=f.vec3f64.create(),oe=f.vec3f64.create(),ce=f.vec3f64.create(),le={heading:0,tilt:0},se=new v,ue=new y.Cyclical(-20037508.342788905,20037508.342788905),fe=new y.Cyclical(-180,180);!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}($=t.OrientationMode||(t.OrientationMode={})),t.headingTiltToDirectionUp=C,t.externalToInternal=w,t.internalToExternal=b,t.scaleToDistance=D,t.distanceToScale=U,t.fromCenterScale=z,t.fromCenterDistance=P,t.directionToHeadingTilt=A,t.getObserverForPointAtDistance=L,t.fromExtent=j,t.toExtent=F;var ve=.7;t.observerToCamera=k,t.scaleToZoom=Y,t.zoomToScale=Z,t.scaleToResolution=_,t.computeScale=N,t.createAsyncContext=B,t.isAsyncContext=Q});