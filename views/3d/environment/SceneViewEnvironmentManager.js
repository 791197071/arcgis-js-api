// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../Color","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4f64","./EnvironmentRenderer","../support/earthUtils","../support/projectionUtils","../support/sunUtils","../webgl-engine/lighting/Lightsources","../../../webscene/background/ColorBackground"],function(e,t,r,i,n,o,s,a,c,d,p,h,l,u,f,_,m,v,g,P,b){Object.defineProperty(t,"__esModule",{value:!0});var y=u.vec3f64.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258),C=function(e){function t(t){var r=e.call(this)||this;return r._referencePointUpdateDelay=200,r._referencePointUpdateInterval=3e3,r._referencePointUpdateDistThreshold=1e6,r._referencePosUpdateQuery=null,r._referencePosMapCoordsRequested=null,r._viewHandles=new a,r._preserveAbsoluteDateTime=!1,r._trackingEnabled=!1,r._viewConnected=!1,r._referencePosResetPreserveAbsoluteTime=!1,r.referencePosUpdateTimer=null,r._referencePosWGS84Comparable=null,r._referencePosMapCoords=null,r._mainLight=new P.MainLight,r._ambientLight=new P.AmbientLight,r._moonLight=new P.FillLight,r._renderer=null,r._resetReferencePosition(),r}return r(t,e),t.prototype.destroy=function(){this._viewHandles.destroy(),this.disposeRendering()},Object.defineProperty(t.prototype,"updating",{get:function(){return!!this._viewConnected&&(!this.disableQueries&&(!!this._referencePosUpdateQuery||!!this._referencePosMapCoordsRequested)||this._renderer.updating)},enumerable:!0,configurable:!0}),t.prototype.updateReadyChange=function(e){e&&!this._viewConnected?(this._viewConnected=!0,this.connectView(this.view),this.notifyChange("updating")):!e&&this._viewConnected&&(this._viewConnected=!1,this.disconnectView(this.view),this.notifyChange("updating"))},t.prototype.disposeRendering=function(){this._renderer&&(this._renderer.destroy(),this._renderer=null),this._resetReferencePosition()},t.prototype.connectView=function(e){var t=this;this._renderer=new _({view:e}),this._viewHandles.add([this.view.watch("environment.lighting.date",function(e){return t._lightingDateHandler(e)},!0),this.view.watch("interacting,stationary",this._interactingStationaryHandler.bind(this)),this.view.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.background.color"],function(){return t._updateRenderParamsHandler()}),this.view.watch("spatialReference",function(){return t._resetReferencePosition()}),p.init(this.view,"viewingMode",function(){return t._resetReferencePosition()}),p.init(this.view,"environment.lighting.cameraTrackingEnabled",function(e){return t._updateCameraTracking(e)},!0),p.init(this,"view.state.camera",function(){return t._cameraHandler(null)},!0),this.watch("disableQueries",function(){return t._cameraHandler(null)})]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler()},t.prototype._updateCameraTracking=function(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{var t=this.get("view.environment.lighting");t&&(t.positionTimezoneInfo.autoUpdated=!1)}},t.prototype.disconnectView=function(e){this.disposeRendering(),this._viewHandles.removeAll()},t.prototype._lightingDateHandler=function(e){if(e){var t=this.view.environment.lighting;if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var r=this.view.spatialReference;if(!v.canProjectToWGS84ComparableLonLat(r)){var i=this.view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(i))return void this._requestReferencePositionUpdate(i)}if(this._preupdateTracking(e),this._referencePosWGS84Comparable){var n=m.positionToTimezone(this._referencePosWGS84Comparable,U);c.isSome(n)&&(t.autoUpdate(null,n),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLightParams(e)}},t.prototype._preupdateTracking=function(e){!this._trackingEnabled&&this.get("view.environment.lighting.cameraTrackingEnabled")&&this._cameraHandler(e)},t.prototype._cameraHandler=function(e){if(void 0===e&&(e=null),this.view.ready){var t=this.view.camera;t&&(this._cameraHandlerClientSide(t,e)||this._cameraHandlerServerSide(t,e))}},t.prototype._cameraHandlerClientSide=function(e,t){if(!v.canProjectToWGS84ComparableLonLat(this.view.spatialReference))return!1;var r=e.position;return this._referencePosWGS84Comparable||(this._referencePosWGS84Comparable=u.vec3f64.create()),v.pointToWGS84ComparableLonLat(r,this._referencePosWGS84Comparable),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLightParams(t),!0},t.prototype._cameraHandlerServerSide=function(e,t){var r=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(r))&&this._requestReferencePositionUpdate(r,!0),this.view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=r.z*this.view.mapCoordsHelper.unitInMeters,this._referencePosChanged())},t.prototype._interactingStationaryHandler=function(){!this.view.interacting&&this.view.stationary&&this._executePendingReferencePositionUpdate()},t.prototype._updateLightParams=function(e){var t=this.view.environment.lighting;e=e||t.date;var r,i=this.view._stage;this._referencePosWGS84Comparable?(r=g.computeColorAndIntensity(e,this._referencePosWGS84Comparable),g.computeDirection(e,this._referencePosWGS84Comparable,this.view.viewingMode,r.diffuse.direction)):r={diffuse:{color:[1,1,1],intensity:.55,direction:y},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0},l.vec3.scale(this._mainLight.intensity,r.diffuse.color,r.diffuse.intensity*Math.PI),l.vec3.negate(this._mainLight.direction,r.diffuse.direction),l.vec3.scale(this._ambientLight.intensity,r.ambient.color,r.ambient.intensity),l.vec3.lerp(this._moonLight.intensity,T,R,r.globalFactor);var n=(1-.5*r.globalFactor)*(1-.4*r.noonFactor*(1-r.globalFactor));l.vec3.scale(this._moonLight.intensity,this._moonLight.intensity,n),l.vec3.copy(this._moonLight.direction,r.diffuse.direction),i.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:r.globalFactor,groundLightingFactor:1-r.noonFactor}),this._updateRenderParamsHandler()},t.prototype._autoUpdateTimezone=function(e,t){if(void 0===t&&(t=null),!this.view.get("environment.lighting.cameraTrackingEnabled"))return!1;var r=w;r.setTime((t||this.view.environment.lighting.date).getTime());var i=m.positionToTimezone(e,U);if(c.isNone(i))return!1;var n=this.view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===i.hours&&n.minutes===i.minutes&&n.seconds===i.seconds)return!1}else n=i;var o=r.getUTCHours()-(i.hours-n.hours),s=r.getUTCMinutes()-(i.minutes-n.minutes),a=r.getUTCSeconds()-(i.seconds-n.seconds);return r.setUTCHours(o),r.setUTCMinutes(s),r.setUTCSeconds(a),!t&&this.view.environment.lighting.autoUpdate(r,i)},t.prototype._updateRenderParamsHandler=function(){var e=this.view._stage;if(e){var t=!this._referencePosWGS84Comparable||g.computeShadowsEnabled(this._referencePosWGS84Comparable,this.view.viewingMode),r=this.view.environment.background,i=r instanceof b?{type:"color",color:f.vec4f64.fromArray(n.toUnitRGBA(r.color))}:{type:"color",color:f.vec4f64.fromValues(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this.view.environment.lighting.directShadowsEnabled&&t,ssao:this.view.environment.lighting.ambientOcclusionEnabled,background:i})}},t.prototype._resetReferencePosition=function(){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating")},t.prototype._requestReferencePositionUpdate=function(e,t){var r=this;if(void 0===t&&(t=!1),this.view.mapCoordsHelper.canProject()&&!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&!this.view.interacting&&this.view.stationary)){var i=this._referencePosUpdateQuery=d.after(this._referencePointUpdateDelay).then(function(){if(r._referencePosUpdateQuery===i){var e=function(){return r._referencePosUpdateQuery!==i};return r._doReferencePositionUpdateQuery(e)}}).catch(function(){}).then(function(){r._referencePosUpdateQuery===i&&(r._referencePosUpdateQuery=null,r.referencePosUpdateTimer||r._executePendingReferencePositionUpdate(),r.notifyChange("updating"))}),n=this.referencePosUpdateTimer=d.after(this._referencePointUpdateInterval).then(function(){r.referencePosUpdateTimer===n&&(r.referencePosUpdateTimer=null,r._referencePosUpdateQuery||r._executePendingReferencePositionUpdate())});this.notifyChange("updating")}},t.prototype._doReferencePositionUpdateQuery=function(e){var t=this;return this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null,this.view.mapCoordsHelper.toGeographic(this._referencePosMapCoords).then(function(r){if(!e()&&!isNaN(r[0])&&!isNaN(r[1])){var i=t._referencePosMapCoords.z*t.view.mapCoordsHelper.unitInMeters;t._referencePosWGS84Comparable?(t._referencePosWGS84Comparable[0]=r[0],t._referencePosWGS84Comparable[1]=r[1],t._referencePosWGS84Comparable[2]=i):t._referencePosWGS84Comparable=[r[0],r[1],i],t._referencePosChanged()}})},t.prototype._executePendingReferencePositionUpdate=function(){var e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)},t.prototype._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams()},t.prototype._exceedsReferencePosDistThreshold=function(e){if(this._referencePosMapCoords){var t=this._referencePosMapCoords.distance(e);return this.view.mapCoordsHelper&&(t*=this.view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0},t.prototype._cancelReferencePosUpdates=function(){this._referencePosUpdateQuery=null,this.referencePosUpdateTimer=null},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{renderer:this._renderer,set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e.referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t}}},enumerable:!0,configurable:!0}),t.FIXED_LIGHT_DIRECTION=y,i([h.property({type:Boolean,dependsOn:["disableQueries","_renderer.updating"],readOnly:!0})],t.prototype,"updating",null),i([h.property()],t.prototype,"disableQueries",void 0),i([h.property({constructOnly:!0})],t.prototype,"view",void 0),i([h.property()],t.prototype,"_renderer",void 0),t=i([h.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],t)}(h.declared(o,s));t.SceneViewEnvironmentManager=C;var w=new Date,U={hours:0,minutes:0,seconds:0},T=u.vec3f64.fromValues(.22,.22,.33),R=u.vec3f64.fromValues(.22,.22,.22);t.default=C});