// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/has","../../../../core/Logger","../../../../core/now","../../../../core/scheduling","../../../../core/libs/gl-matrix-2/vec3f64","../../support/animationUtils","../lib/AutoDisposable","../lib/Camera","../lib/DrapedRenderer","../lib/GLMaterialRep","../lib/ProgramRepository","../lib/Renderer","../lib/TextureRepository","../lib/tracer","./Model","./ScreenshotManager","../shaders/globalOptions","../../../webgl/context-util","../../../webgl/RenderingContext"],function(e,t,r,n,i,s,o,a,d,p,c,u,_,h,l,m,g,y,f,R,b,v,x,T){var w=o.getLogger("esri.views.3d.webgl-engine.parts.View"),M=s("dojo-debug-messages");return function(e){function t(t,r,n,i){var s=e.call(this)||this;s._camera=new _(p.vec3f64.fromValues(0,100,-100)),s._needsRender=!0,s._idleSuspend=!0,s._animationTimeLast=0,s._stats={renderGeometriesTotal:0,renderGeometriesVisible:0,renderTimeTotal:0,renderTimeLast:0,frameCount:0},s._container=t,s._stage=r,s._initializeContext(i);var o=v.glslifyGlobalOptions({viewingMode:i.viewingMode});return s._programRepository=new m(s._rctx,o),s._textureRepository=new y(r.getAll(R.ContentType.TEXTURE),s._programRepository,function(){return s._camera.viewport},s._rctx),s._materialRepository=new l(s._textureRepository,s._programRepository),s._initializeViewportCamera(),s._drapedRenderer=new h(s._rctx,s._canvas,s._programRepository,s._materialRepository,s._textureRepository,n),s._renderer=new g(s._programRepository,s._materialRepository,s._textureRepository,s._rctx,"scene",r),s._screenshotManager=new b.ScreenshotManager(s._rctx,s._render.bind(s),function(){return s.setNeedsRender()},i.screenshot.renderOverlay),s._registerFrameTask(),s}return n(t,e),t.prototype.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),e.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"isLoadingResources",{get:function(){return this._renderer.isLoadingResources},enumerable:!0,configurable:!0}),t.prototype.getCombinedStats=function(){var e=this._rctx.gl,t={},r=this._renderer.getCombinedStats();for(var n in r)t[n]=r[n];if(t.renderGeometriesTotal=this._stats.renderGeometriesTotal,t.renderGeometriesVisible=this._stats.renderGeometriesVisible,M&&(t.totalRenderTime=this._stats.renderTimeTotal,t.currentRenderTime=this._stats.renderTimeLast,t.totalNumFramesRendered=this._stats.frameCount),void 0!==e.getUsedTextureMemory&&(t.textureMemory=e.getUsedTextureMemory()),void 0!==e.getUsedRenderbufferMemory&&(t.renderbufferMemory=e.getUsedRenderbufferMemory()),void 0!==e.getUsedVBOMemory&&(t.VBOMemory=e.getUsedVBOMemory()),void 0!==e.getUsedTextureMemoryStats){var i=e.getUsedTextureMemoryStats();for(var s in i)t["texMem type: "+s]=i[s]}return t},t.prototype.setNeedsRender=function(){this._needsRender=!0},t.prototype.needsRender=function(){var e=this._canRender();return(this._needsRender||!this._idleSuspend||this._renderer.needsRender()||this._textureRepository.needsRender())&&e},t.prototype.ensureEdgeView=function(){return this._renderer.ensureEdgeView()},Object.defineProperty(t.prototype,"edgeView",{get:function(){return this._renderer.edgeView},enumerable:!0,configurable:!0}),t.prototype.setRenderParameters=function(e){this.setNeedsRender(),void 0!==e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend),this._renderer.setRenderParams(e)},t.prototype.getRenderParameters=function(){var e=this._renderer.getRenderParams();return e.anisotropicFiltering=this._textureRepository.getMaxAnisotropy(),e.idleSuspend=this._idleSuspend,e},Object.defineProperty(t.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return"s3tc"===e?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===e&&!!this._rctx.capabilities.shaderTextureLOD},t.prototype.modify=function(e,t,r,n){this._renderer.modify(e,t,r,n)},t.prototype.setCamera=function(e){this._camera.copyFrom(e),this.setNeedsRender()},t.prototype.getCamera=function(){return this._camera},t.prototype.getCanvas=function(){return this._canvas},t.prototype.getDrapedRenderer=function(){return this._drapedRenderer},t.prototype.takeScreenshot=function(e){return this._screenshotManager.takeScreenshot(e)},Object.defineProperty(t.prototype,"renderPlugins",{get:function(){return this._renderer.renderPlugins},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{renderer:this._renderer,textureRepository:this._textureRepository}},enumerable:!0,configurable:!0}),t.prototype.getGpuMemoryUsage=function(){return r({},this._renderer.getGpuMemoryUsage(),{draped:this._drapedRenderer?this._drapedRenderer.getGpuMemoryUsage():0})},t.prototype._registerFrameTask=function(){var e=this,t={viewCamera:this._camera,frameHasSlicePlane:!1,drapedRenderer:this._drapedRenderer},r={preRender:function(t){f.begin(),e._stage.processDirty(),e._processAnimations(t.time)},render:function(){e.needsRender()&&(e._resetNeedsRender(),e._render(null,e._camera,!1))},postRender:function(){f.end()},update:function(){t.viewCamera=e._camera,t.frameHasSlicePlane=e._renderer.hasSlicePlane,t.drapedRenderer=e._drapedRenderer,e._screenshotManager.update(t)}};this._frameTask=d.addFrameTask(r)},t.prototype._resetNeedsRender=function(){this._needsRender=!1,this._renderer.resetNeedsRender(),this._textureRepository.resetNeedsRender()},t.prototype._canRender=function(){var e=this._camera;return e.fullWidth>0&&e.fullHeight>0},t.prototype._initializeViewportCamera=function(){var e=this._container.getBoundingClientRect(),t=this.getCamera();t.viewport[2]=e.width,t.viewport[3]=e.height,this.setCamera(t)},t.prototype._initializeContext=function(e){this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");var t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==e.stencil||e.stencil},r=f.instrumentContext(x.createContextOrErrorHTML(this._canvas,t,e.renderContext)),n={disabledExtensions:e.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.debugWebGLExtensions||{}};this._rctx=new T(r,n),!e.alpha&&this._rctx.contextAttributes.alpha&&w.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&s("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)},t.prototype._processAnimations=function(e){e-this._animationTimeLast<c.DESIRED_ANIMATION_MS||(this._animationTimeLast=e,this._renderer.updateAnimations(e)&&this.setNeedsRender())},t.prototype._render=function(e,t,r){var n;M&&(n=a()),this._renderer.setLighting(this._stage.lighting),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this._renderer.render({fbo:e,camera:t,disableSlice:r,lightDirection:this._stage.mainLightDirection}),M&&(this._stats.renderTimeLast=a()-n,this._stats.renderTimeTotal+=this._stats.renderTimeLast,this._stats.frameCount++)},i([u.autoDispose()],t.prototype,"_rctx",void 0),i([u.autoDispose()],t.prototype,"_container",void 0),i([u.autoDispose()],t.prototype,"_canvas",void 0),i([u.autoDispose()],t.prototype,"_programRepository",void 0),i([u.autoDispose()],t.prototype,"_renderer",void 0),i([u.autoDispose()],t.prototype,"_drapedRenderer",void 0),i([u.autoDispose()],t.prototype,"_screenshotManager",void 0),t}(u.AutoDisposable)});