// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../support/debugFlags","../../webgl-engine/lib/intersectorUtils","./Camera","./DefaultVertexBufferLayouts","./DrapedUpdates","./glUtil3D","./GridLocalOriginFactory","./Renderer","../lighting/Lightsources","../materials/ColorMaterial","../materials/HUDMaterial","../materials/RibbonLineMaterial","../shaders/MiscPrograms","../../../webgl/FramebufferObject","../../../webgl/renderState","../../../webgl/Texture","../../../webgl/Util"],function(e,t,r,i,n,a,s,o,d,l,h,u,p,g,c,f,m,_,y,x,v,w){var T=function(){function e(e,t,r,a,s,o){var d=this;this._renderTargets={},this._clearColor=n.vec4f64.fromValues(0,0,0,0),this._uniqueIdx=0,this._localOrigins=new u,this._rctx=e,this._canvas=t,this._programRep=r,this._modelDirtySet=o,this._modelDirtySet.onMaterialChanged=function(){return d._emitContentChanged()},this._renderer=new p(r,a,s,this._rctx,"draped",function(){return d._emitContentChanged()}),this._updates=new l.DrapedUpdates(this._renderer,{emitContentChanged:function(){return d._emitContentChanged()},emitUpdatingChanged:function(){return d._emitUpdatingChanged()}}),this._renderer.onHasHighlightsChanged=function(e){d.onHasHighlightsChanged&&d.onHasHighlightsChanged(e)},this._renderer.setLighting({lights:[new g.AmbientLight(i.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0})}return e.prototype.dispose=function(){for(var e in this._renderTargets)this._renderTargets[e].dispose();this._renderTargets=null,this._renderer.dispose(),this._renderer=null,this._updates.dispose(),this._updates=null},e.prototype.disposeRenderTarget=function(e){var t=this._renderTargets[e];t&&t.dispose(),delete this._renderTargets[e]},Object.defineProperty(e.prototype,"updating",{get:function(){return this._updates.updating},enumerable:!0,configurable:!0}),e.prototype.commitChanges=function(){this._updates.commitChanges()},e.prototype.getRenderTargetTexture=function(e){var t=this._renderTargets[e];return t?t.colorTexture:null},e.prototype.addRenderGeometries=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];null==i.origin&&(i.origin=this._localOrigins.getOrigin(i.center)),i.idx=this._uniqueIdx++}this._updates.add(e)},e.prototype.removeRenderGeometries=function(e){this._updates.remove(e)},e.prototype.updateRenderGeometries=function(e,t){this._updates.modify(e,t)},e.prototype.updateRenderOrder=function(e){e.size>0&&(this._renderer.modifyRenderOrder(e),this._emitContentChanged())},e.prototype.setBackgroundColor=function(e){this._clearColor=e,this._emitContentChanged()},e.prototype.updateHighlights=function(e){this._updates.modify(e,16)},e.prototype.isEmpty=function(){return this._renderer.isEmpty()&&!a.OVERLAY_DRAW_TEST_TEXTURE},e.prototype.processDirtyMaterials=function(){var e=this._modelDirtySet.getDirtyMaterials();e&&this._renderer.modify(null,0,null,0,null,0,e),this._modelDirtySet.clearDirtyMaterials()},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasWater",{get:function(){return this._renderer.hasWater},enumerable:!0,configurable:!0}),e.prototype.draw=function(e,t){return this.drawPass(0,e,t)},e.prototype.drawNormals=function(e,t){return this.drawPass(2,e,t)},e.prototype.drawHighlights=function(e,t){return this.drawPass(4,e,t)},e.prototype.drawPass=function(e,t,i){if(this._pixelRatio=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||4===e&&!this.hasHighlights||2===e&&!this.hasWater)return!1;if(this.processDirtyMaterials(),!i.views.some(function(e){return e.extent[0]!==e.extent[2]&&e.extent[1]!==e.extent[3]}))return!1;var n=this._renderTargets[t];if(!n)return!1;var s=this._rctx,o=i.width,d=i.height;n.width===o&&n.height===d||n.resize(o,d);var l=C.camera;C.fbo=n,l.near=1,l.far=1e4,l.pixelRatio=i.pixelRatio||1,s.bindFramebuffer(n),s.setClearColor.apply(s,this._clearColor),s.clearSafe(16384);for(var h=0;h<i.views.length;h++){var u=i.views[h];l.viewport=u.viewport,r.mat4.ortho(l.projectionMatrix,0,u.extent[2]-u.extent[0],0,u.extent[3]-u.extent[1],l.near,l.far),r.mat4.identity(l.viewMatrix),r.mat4.translate(l.viewMatrix,l.viewMatrix,[-u.extent[0],-u.extent[1],0]),l.setGLViewport(this._rctx),a.OVERLAY_DRAW_TEST_TEXTURE&&this._drawTestTexture(o,d,b[i.index%b.length]),this._renderer.renderPass(e,C)}return s.bindFramebuffer(null),s.setViewport(0,0,this._canvas.width,this._canvas.height),n.colorTexture.descriptor.hasMipmap&&n.colorTexture.generateMipmap(),!0},e.prototype._drawTestTexture=function(e,t,r){var i=this._rctx;if(!this._testPatternTexture){for(var n=new Uint8Array(e*t*4),a=0,s=0;s<t;s++)for(var o=0;o<e;o++){var l=Math.floor(o/10),u=Math.floor(s/10);l<2||u<2||10*l>e-20||10*u>t-20?(n[a++]=255,n[a++]=255,n[a++]=255,n[a++]=255):(n[a++]=255,n[a++]=255,n[a++]=255,n[a++]=1&l&&1&u?1&o^1&s?0:255:1&l^1&u?0:128)}this._testPatternTexture=new v(i,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},n),this._testPatternProgram=this._programRep.getProgram(_.texOnly),this._testPatternPipelineState=x.makePipelineState({blending:x.separateBlendingParams(770,1,771,771),colorWrite:x.defaultColorWriteParams}),this._quadVAO=h.createQuadVAO(i,d.Pos3Tex)}var p=this._testPatternProgram;i.bindProgram(p),i.setPipelineState(this._testPatternPipelineState),p.setUniform4f("color",r[0],r[1],r[2],1),p.setUniform1i("tex",0),i.bindTexture(this._testPatternTexture,0),i.bindVAO(this._quadVAO),i.drawArrays(5,0,w.vertexCount(this._quadVAO,"geometry"))},e.prototype.updateLogic=function(e){return this._renderer.updateLogic(e)},e.prototype._emitContentChanged=function(){this.onContentChanged&&this.onContentChanged()},e.prototype._emitUpdatingChanged=function(){this.onUpdatingChanged&&this.onUpdatingChanged()},e.prototype.createRenderTarget=function(e,t,r,i){for(var n=e,a=0;this._renderTargets[n];)n=e+"_"+ ++a;return this._renderTargets[n]=y.createWithAttachments(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:i,hasMipmap:t,maxAnisotropy:r,width:0,height:0},{colorTarget:0,depthStencilTarget:0}),n},e.prototype.getGpuMemoryUsage=function(){var e=0;for(var t in this._renderTargets){var r=this._renderTargets[t];e+=w.getGpuMemoryUsage(r)}return e},e.prototype.intersect=function(e,t,r){var i=this,n=0;this._renderer.forEachRenderGeometry(function(a){if(!r||r(a)){if(a.material instanceof c||a.material instanceof m||a.material instanceof f){var s=a.transformation[12],o=a.transformation[13];P[0]=t[0]-s,P[1]=t[1]-o,P[2]=1,R[0]=t[0]-s,R[1]=t[1]-o,R[2]=0,a.pixelRatio=i._pixelRatio,a.material.intersect(a,null,a.getShaderTransformation(),e,P,R,function(t,r,s,o,d,l){i.addIntersectionResult(s,a.material.renderPriority,n,e,a.data.layerUid,a.data.graphicUid)},a.calculateShaderTransformation,!0)}n++}})},e.prototype.addIntersectionResult=function(e,t,r,i,n,a){var o={type:"external",metadata:{layerUid:n,graphicUid:a}},d=function(n){n.set(o,null,i.results.terrain.dist,i.results.terrain.normal,i.results.terrain.transformation,t,null,null,e,r),n.intersector="DrapedRenderer"};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.terrain.dist<=i.results.min.dist)&&d(i.results.min),(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.terrain.dist>i.results.max.dist)&&d(i.results.max),i.enable.storeAll){var l=new s.IntersectorResult(i.ray);d(l),i.results.all.push(l)}},Object.defineProperty(e.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!0,configurable:!0}),e}(),b=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],C={fbo:null,camera:new o.default,lightDirection:i.vec3f64.fromValues(0,0,1)},P=i.vec3f64.create(),R=i.vec3f64.create();return T});