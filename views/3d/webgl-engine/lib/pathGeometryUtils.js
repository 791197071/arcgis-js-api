// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/mathUtils","./GeometryData","./GeometryUtil","./Util","../materials/internal/MaterialUtil","../shaders/PathPrograms"],function(t,e,r,i,s,a,o,n,h,u,l,c,v,p,f,d,m){var x;!function(t){function e(){return{up:u.vec3f64.create(),right:u.vec3f64.create()}}function r(t,e,r){h.vec3.transformMat4(t.up,e.up,r),h.vec3.transformMat4(t.right,e.right,r)}function x(t,e){h.vec3.copy(t.up,e.up),h.vec3.copy(t.right,e.right)}function U(t,e,r){t[0]=r[0]*e.right[0]+r[1]*e.up[0],t[1]=r[0]*e.right[1]+r[1]*e.up[1],t[2]=r[0]*e.right[2]+r[1]*e.up[2]}function T(t,e){var r=null,i=t.vertices.length,s=u.vec3f64.create(),a=u.vec3f64.create(),o=u.vec3f64.create(),n=u.vec3f64.create(),c=u.vec3f64.create(),v=u.vec3f64.create(),f=l.plane.create(),d=t.vertices[0];h.vec3.copy(a,e),h.vec3.set(s,0,1,0),p.makeOrthoBasisDirUpFallback(d.vRight,a,s,s,o,a,.99619469809),h.vec3.copy(d.frame.up,a),h.vec3.copy(d.frame.right,o),r=d;for(var m=1;m<i;++m){d=t.vertices[m],h.vec3.add(c,d.vLeft,d.vRight);var x=h.vec3.length(c);x>0?(x=1/Math.sqrt(x),c[0]=c[0]*x,c[1]=c[1]*x,c[2]=c[2]*x):(c[0]=d.vRight[0],c[1]=d.vRight[1],c[2]=d.vRight[2]),h.vec3.add(v,r.pos,r.frame.up),l.plane.fromPositionAndNormal(d.pos,c,f);l.plane.intersectRay(f,l.ray.wrap(v,d.vLeft),n)?(h.vec3.subtract(n,n,d.pos),h.vec3.normalize(a,n),h.vec3.cross(o,c,a),h.vec3.normalize(o,o)):p.makeOrthoBasisDirUpFallback(c,r.frame.up,r.frame.right,s,o,a,.99619469809),h.vec3.copy(d.frame.up,a),h.vec3.copy(d.frame.right,o),r=d}}t.makeFrame=e,t.profileSpaceToVertexSpace=U;var F=function(){function t(){this.pos=u.vec3f64.create(),this.posES=u.vec3f64.create(),this.posGS=u.vec3f64.create(),this.vRight=u.vec3f64.create(),this.vLeft=u.vec3f64.create(),this.frame=e(),this.rotationFrame=e(),this.rotationAngle=0}return t.prototype.setFrameFromUpVector=function(t){h.vec3.copy(this.frame.up,t),h.vec3.add(y,this.vLeft,this.vRight),h.vec3.normalize(y,y),h.vec3.scale(C,this.frame.up,h.vec3.dot(y,this.frame.up)),h.vec3.subtract(N,y,C),h.vec3.normalize(N,N),h.vec3.cross(this.frame.right,N,this.frame.up)},t.prototype.computeRotationAxisAndAngleFromUpVector=function(){h.vec3.copy(this.rotationFrame.up,this.frame.up);var t=h.vec3.dot(this.rotationFrame.up,this.frame.up),e=h.vec3.dot(this.rotationFrame.up,this.frame.right);h.vec3.scale(C,this.frame.up,-e),h.vec3.scale(y,this.frame.right,t),h.vec3.add(C,C,y),h.vec3.normalize(this.rotationFrame.right,C),h.vec3.scale(C,this.frame.up,h.vec3.dot(this.frame.up,this.vLeft)),h.vec3.subtract(C,this.vLeft,C),h.vec3.negate(C,C),h.vec3.normalize(C,C),h.vec3.scale(y,this.frame.up,h.vec3.dot(this.frame.up,this.vRight)),h.vec3.subtract(y,this.vRight,y),h.vec3.normalize(y,y),h.vec3.cross(D,this.rotationFrame.up,this.vLeft);var r=c.sign(h.vec3.dot(D,this.vRight));this.rotationAngle=r*(Math.PI-c.acos(h.vec3.dot(C,y)));var i=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*i))},t}();t.PathVertex=F;var _=function(){function t(){this.vertices=[],this.vertexIndices=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}return t.prototype.addVertex=function(t,e){return void 0===e&&(e=0),this.vertices.push(n.vec2f64.clone(t)),this.poleIndices.push(e),this.vertices.length-1},t.prototype.addUV=function(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1},t.prototype.addPole=function(t){return this.poles.push(n.vec2f64.clone(t)),this.poles.length-1},t.prototype.addSegment=function(t,e,r,i){void 0===r&&(r=null),void 0===i&&(i=null),this.vertexIndices.push(t),this.vertexIndices.push(e),null!==r&&null!==i&&(this.uvIndices.push(r),this.uvIndices.push(i))},Object.defineProperty(t.prototype,"numSegments",{get:function(){return this.vertexIndices.length/2},enumerable:!0,configurable:!0}),t.prototype.hasUV=function(){return null!=this.uvs},t.prototype.translate=function(t,e){for(var r=0,i=this.vertices;r<i.length;r++){var s=i[r];s[0]+=t,s[1]+=e}for(var a=0,o=this.poles;a<o.length;a++){var n=o[a];n[0]+=t,n[1]+=e}},t.circle=function(e){void 0===e&&(e=20);var r=new t;r.addPole(n.vec2f64.fromValues(0,0));for(var i=0;i<e;++i){var s=2*i*Math.PI/e;r.addVertex(n.vec2f64.fromValues(.5*Math.cos(s),.5*Math.sin(s))),r.addUV(i/e)}r.addUV(1);for(var i=0;i<e-1;++i)r.addSegment(i,i+1,i,i+1);return r.addSegment(e-1,0,e-1,e),r},t.rect=function(){var e=new t,r=n.vec2f64.fromValues(-.5,-.5),i=n.vec2f64.fromValues(.5,-.5),s=n.vec2f64.fromValues(.5,.5),a=n.vec2f64.fromValues(-.5,.5);return e.addPole(n.vec2f64.fromValues(0,.5)),e.addPole(n.vec2f64.fromValues(0,.5)),e.addPole(n.vec2f64.fromValues(0,-.5)),e.addPole(n.vec2f64.fromValues(0,-.5)),e.addUV(0),e.addUV(1),e.addVertex(r,3),e.addVertex(i,3),e.addSegment(0,1,0,1),e.addVertex(i,2),e.addVertex(s,1),e.addSegment(2,3,0,1),e.addVertex(s,0),e.addVertex(a,0),e.addSegment(4,5,0,1),e.addVertex(a,1),e.addVertex(r,2),e.addSegment(6,7,0,1),e},t}();t.Profile=_;var L=function(){function t(t){this.vertices=[],this.offset=u.vec3f64.create(),this.xform=a.mat4f64.create(),this.vertices=t;var e=Math.floor((t.length-1)/2);h.vec3.copy(this.offset,this.vertices[e].pos);for(var r=0,i=this.vertices;r<i.length;r++){var o=i[r];h.vec3.subtract(o.pos,o.pos,this.offset)}s.mat4.translate(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}return t.prototype.updatePathVertexInformation=function(){var t=this.vertices.length,e=this.vertices[0];e.index=0,h.vec3.set(e.vLeft,0,0,0),e.vLeftLength=0,h.vec3.subtract(e.vRight,this.vertices[1].pos,e.pos),e.vRightLength=h.vec3.length(e.vRight),h.vec3.normalize(e.vRight,e.vRight);for(var r=e,i=1;i<t;++i)e=this.vertices[i],e.index=i,h.vec3.copy(e.vLeft,r.vRight),e.vLeftLength=r.vRightLength,i<t-1?(h.vec3.subtract(e.vRight,this.vertices[i+1].pos,e.pos),e.vRightLength=h.vec3.length(e.vRight),h.vec3.normalize(e.vRight,e.vRight)):(h.vec3.copy(e.vRight,e.vLeft),e.vRightLength=e.vLeftLength),r=e},t}();t.Path=L,t.computeMinimumRotationTangentFrame=T;var M=function(){function t(){}return t}();t.Extruder=M;var O=function(){function t(){}return t.prototype.numProfilesPerJoin=function(){return 1},t.prototype.extrude=function(t,e,r){for(var i=0;i<e.vertices.length;++i)U(g,t.frame,e.vertices[i]),r(t.index,t.frame,g,!1)},t}();t.SimpleExtruder=O;var z=function(){function t(t,e){void 0===t&&(t=.8*Math.PI),void 0===e&&(e=1),this.cutoffAngle=t,this.numBendSubdivisions=e}return t.prototype.numProfilesPerJoin=function(){return this.numBendSubdivisions+1},t.prototype.extrude=function(t,e,i){var a=P,o=S;if(x(o,t.frame),Math.abs(t.rotationAngle)>0){var n=h.vec3.dot(o.right,t.rotationFrame.up),u=h.vec3.dot(o.right,t.rotationFrame.right),l=h.vec3.dot(o.up,t.rotationFrame.up),c=h.vec3.dot(o.up,t.rotationFrame.right),v=u/Math.cos(.5*t.rotationAngle),p=c/Math.cos(.5*t.rotationAngle);h.vec3.scale(y,t.rotationFrame.up,n),h.vec3.scale(o.right,t.rotationFrame.right,v),h.vec3.add(o.right,o.right,y),h.vec3.scale(y,t.rotationFrame.up,l),h.vec3.scale(o.up,t.rotationFrame.right,p),h.vec3.add(o.up,o.up,y)}if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(var f=0;f<this.numBendSubdivisions+1;++f){s.mat4.identity(R),s.mat4.rotate(R,R,.5*-t.rotationAngle+f*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),r(a,t.frame,R);for(var d=0;d<e.vertices.length;++d){U(g,t.frame,e.vertices[d]);var m=h.vec3.dot(g,t.rotationFrame.right),b=m*t.rotationAngle>=0;b?(U(g,a,e.vertices[d]),i(t.index,a,g,!1)):(U(g,o,e.vertices[d]),i(t.index,t.frame,g,!0))}}else for(var f=0;f<this.numBendSubdivisions+1;++f)for(var d=0;d<e.vertices.length;++d){U(g,t.frame,e.vertices[d]);var m=h.vec3.dot(g,t.rotationFrame.right),b=m*t.rotationAngle>=0;U(g,o,e.vertices[d]),i(t.index,t.frame,g,!b)}},t}();t.MiterExtruder=z;var B={generateUV:!1},G=function(){function t(){}return t.prototype.rebuildConnectingProfileGeometry=function(t,e,r){for(var i=0;i<e.vertices.length;++i)U(g,t.frame,e.vertices[i]),r(t.index,t.frame,g,V,0)},t}();t.CapBuilder=G;var k=function(t){function e(){return t.call(this)||this}return i(e,t),e.prototype.getNumVertices=function(){return 0},e.prototype.getNumIndices=function(){return 0},e.prototype.rebuildCapGeometry=function(t,e){},e.prototype.buildTopology=function(t,e){},e}(G);t.NoCapBuilder=k;var w=function(t){function e(e,r,i){void 0===r&&(r=0),void 0===i&&(i=!1);var s=t.call(this)||this;return s.profile=e,s.profilePlaneOffset=r,s.flip=i,s}return i(e,t),e.prototype.getNumVertices=function(){return this.profile.vertices.length},e.prototype.getNumIndices=function(){return 3*this.profile.numSegments},e.prototype.rebuildConnectingProfileGeometry=function(t,e,r){var i=C;h.vec3.cross(i,t.frame.up,t.frame.right);for(var s=0;s<e.vertices.length;++s)U(g,t.frame,e.vertices[s]),r(t.index,t.frame,g,i,this.profilePlaneOffset)},e.prototype.rebuildCapGeometry=function(t,e){this.rebuildConnectingProfileGeometry(t,this.profile,e)},e.prototype.buildTopology=function(t,e){for(var r=this.vertexBufferStart+this.profile.vertexIndices[0],i=1;i<this.profile.numSegments;++i){var s=this.profile.vertexIndices[2*i+0],a=this.profile.vertexIndices[2*i+1],o=this.vertexBufferStart+s,n=this.vertexBufferStart+a;this.flip?e(n,o,r):e(r,o,n)}},e}(G);t.TriangulationCapBuilder=w;var E=function(t){function e(e){var r=t.call(this)||this;return r.flip=!1,r.breakNormals=!1,r.numSegments=3,r.profile=e.profile,r.flip=e.flip,r.breakNormals=e.breakNormals,r}return i(e,t),e.prototype.getNumVertices=function(){var t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length},e.prototype.getNumIndices=function(){var t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(var e=0;e<this.profile.numSegments;++e){var r=this.profile.vertexIndices[2*e+0],i=this.profile.vertexIndices[2*e+1];this.profile.poleIndices[r]===this.profile.poleIndices[i]?t+=1:t+=2}return 3*t},e.prototype.rebuildCapGeometry=function(t,e){var r=t.frame,i=C;h.vec3.cross(i,r.up,r.right);for(var s=this.flip?.5:-.5,a=0;a<this.profile.poles.length;++a)U(g,r,this.profile.poles[a]),e(t.index,r,g,i,s);if(this.breakNormals)for(var a=0;a<this.profile.vertices.length;++a)U(g,r,this.profile.vertices[a]),e(t.index,r,g,i,0);for(var a=0;a<this.numSegments-1;++a)for(var n=1-(a+1)/this.numSegments,u=Math.sin(n*Math.PI*.5),l=Math.cos(n*Math.PI*.5),c=0;c<this.profile.vertices.length;++c){var v=A,p=this.profile.poles[this.profile.poleIndices[c]];o.vec2.subtract(v,this.profile.vertices[c],p),o.vec2.scale(v,v,u),o.vec2.add(v,v,p),U(g,r,v),e(t.index,r,g,i,s*l)}},e.prototype.buildTopology=function(t,e){for(var r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length,s=0;s<this.profile.numSegments;++s){for(var a=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],n=this.vertexBufferStart+this.profile.poleIndices[a],h=this.vertexBufferStart+this.profile.poleIndices[o],u=r+a,l=r+o,c=0;c<this.numSegments-1;++c){var v=i+c*this.profile.vertices.length+a,p=i+c*this.profile.vertices.length+o;this.flip?(e(v,l,u),e(l,v,p)):(e(u,l,v),e(p,v,l)),u=v,l=p}this.flip?(e(n,l,u),n!==h&&e(n,h,l)):(e(u,l,n),n!==h&&e(l,h,n))}},e}(G);t.RoundCapBuilder=E;var H=function(){function t(t,e,r,i,s,a){void 0===a&&(a=B),this.options=a,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=e,this.path=t,this.extruder=r,this.startCap=i,this.endCap=s;var o=this.path.vertices.length-2;this.numExtrusionProfiles=r.numProfilesPerJoin()*o+2,this.numVerticesTotal=e.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;var n=this.startCap.getNumVertices();this.numVerticesTotal+=n,this.numNormalsTotal+=n,this.endCap.vertexBufferStart=this.numVerticesTotal;var h=this.endCap.getNumVertices();this.numVerticesTotal+=h,this.numNormalsTotal+=h,this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.auxVectorData=new Float32Array(3*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}return t.prototype.emitVertex=function(t,e,r,i){var s=h.vec3.dot(r,e.right);this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0]*s,this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1]*s,this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2]*s;var a=h.vec3.dot(r,e.up);if(this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0]*a,this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1]*a,this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2]*a,this.pathVertexData[this._extrusionVertexCount]=t,i){var o=this.path.vertices[t];this.auxVectorData[3*this._extrusionVertexCount+0]=o.rotationFrame.right[0]*o.maxStretchDistance,this.auxVectorData[3*this._extrusionVertexCount+1]=o.rotationFrame.right[1]*o.maxStretchDistance,this.auxVectorData[3*this._extrusionVertexCount+2]=o.rotationFrame.right[2]*o.maxStretchDistance}else this.auxVectorData[3*this._extrusionVertexCount+0]=0,this.auxVectorData[3*this._extrusionVertexCount+1]=0,this.auxVectorData[3*this._extrusionVertexCount+2]=0;++this._extrusionVertexCount},t.prototype.emitCapVertex=function(t,e,r,i,s){var a=h.vec3.dot(r,e.right);this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0]*a,this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1]*a,this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2]*a;var o=h.vec3.dot(r,e.up);this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0]*o,this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1]*o,this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2]*o,this.pathVertexData[this._extrusionVertexCount]=t,this.auxVectorData[3*this._extrusionVertexCount+0]=i[0]*s,this.auxVectorData[3*this._extrusionVertexCount+1]=i[1]*s,this.auxVectorData[3*this._extrusionVertexCount+2]=i[2]*s,++this._extrusionVertexCount},t.prototype.emitTriangle=function(t,e,r){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=e,this.vertexIndices[3*this._triangleCount+2]=r,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[r],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=e,this.normalIndices[3*this._triangleCount+2]=r,++this._triangleCount},t.prototype.rebuildGeometry=function(){var t=this.emitVertex.bind(this),e=this.emitCapVertex.bind(this);this._extrusionVertexCount=0;for(var r=0,i=this.path.vertices;r<i.length;r++){var s=i[r];this.originData[3*s.index+0]=s.pos[0],this.originData[3*s.index+1]=s.pos[1],this.originData[3*s.index+2]=s.pos[2]}this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,e);for(var a=1;a<this.path.vertices.length-1;++a)this.extruder.extrude(this.path.vertices[a],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,e),this.startCap.rebuildCapGeometry(this.path.vertices[0],e),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],e),this.profile.hasUV()&&this.options.generateUV)for(var a=0;a<this.profile.uvs.length;++a)this.uvData[2*a+0]=this.profile.uvs[a],this.uvData[2*a+1]=0},t.prototype.buildTopology=function(){var t=this.emitTriangle.bind(this);this._triangleCount=0;var e=this.profile.vertices.length,r=this.profile.numSegments,i=this.numExtrusionProfiles-1,s=r*i,a=2*s,o=3*a;this.startCap.indexBufferStart=o,this.startCap.firstProfileVertexIndex=0,o+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=o,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1),o+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(o),this.normalIndices=new Uint32Array(o),this.pathVertexIndices=new Uint32Array(o),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(o));for(var n=0;n<r;++n)for(var h=this.profile.vertexIndices[2*n],u=this.profile.vertexIndices[2*n+1],l=0;l<i;++l){var c=l*e+h,v=(l+1)*e+h,p=(l+1)*e+u,f=l*e+u;t(c,v,p),t(c,p,f)}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t)},t.prototype.onPathChanged=function(){this.rebuildGeometry()},t}();t.Builder=H;var J=function(){function t(t){this.builder=t}return Object.defineProperty(t.prototype,"xform",{get:function(){return this.builder.path.xform},enumerable:!0,configurable:!0}),t.prototype.onPathChanged=function(){this.builder.onPathChanged()},t}();t.PathGeometry=J;var j=function(t){function e(e){var r=t.call(this,e)||this;return r.vertexAttributePosition=null,r.vertexAttributeNormal=null,r.vertexAttributeColor=null,r.vertexAttributePosition=new Float32Array(3*r.builder.numVerticesTotal),r.vertexAttributeNormal=new Float32Array(3*r.builder.numNormalsTotal),r.vertexAttributeColor=new Uint8Array(4),r.vertexAttributeColor[0]=255,r.vertexAttributeColor[1]=255,r.vertexAttributeColor[2]=255,r.vertexAttributeColor[3]=255,r}return i(e,t),e.prototype.bakeVertexColors=function(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1)},e.prototype.bakeVertexPositions=function(t){this.size=t;for(var e=0;e<this.builder.numVerticesTotal;++e){var r=this.builder.pathVertexData[e],i=0===r||r===this.builder.path.vertices.length-1,s=b;h.vec3.set(s,this.builder.originData[3*r+0],this.builder.originData[3*r+1],this.builder.originData[3*r+2]);var a=C;if(h.vec3.set(a,this.builder.profileRightAxisData[4*e+0]*t[0]+this.builder.profileUpAxisData[4*e+0]*t[1],this.builder.profileRightAxisData[4*e+1]*t[0]+this.builder.profileUpAxisData[4*e+1]*t[1],this.builder.profileRightAxisData[4*e+2]*t[0]+ +this.builder.profileUpAxisData[4*e+2]*t[1]),i){var o=y;h.vec3.set(o,this.builder.auxVectorData[3*e+0]*t[0],this.builder.auxVectorData[3*e+1]*t[0],this.builder.auxVectorData[3*e+2]*t[0]),h.vec3.add(a,a,o)}else{var n=y,u=D;h.vec3.set(n,this.builder.auxVectorData[3*e+0],this.builder.auxVectorData[3*e+1],this.builder.auxVectorData[3*e+2]);var l=h.vec3.length(n);h.vec3.normalize(n,n);var v=h.vec3.dot(a,n),p=c.sign(v);h.vec3.scale(u,n,v),h.vec3.subtract(u,a,u),Math.abs(v)>l&&(h.vec3.scale(n,n,l*p),h.vec3.add(a,n,u))}this.vertexAttributePosition[3*e+0]=s[0]+a[0],this.vertexAttributePosition[3*e+1]=s[1]+a[1],this.vertexAttributePosition[3*e+2]=s[2]+a[2]}},e.prototype.computeNormals=function(){for(var t=this.builder.vertexIndices,e=this.vertexAttributePosition,r=t.length/3,i=0;i<this.vertexAttributeNormal.length;++i)this.vertexAttributeNormal[i]=0;for(var s=this.builder.profile.numSegments,a=this.builder.numExtrusionProfiles-1,o=s*a*2,n=0;n<o;n+=2){var u=this.builder.vertexIndices[3*n+0],l=this.builder.vertexIndices[3*n+1],c=this.builder.vertexIndices[3*n+2],v=this.builder.vertexIndices[3*n+5];h.vec3.set(C,e[3*u+0],e[3*u+1],e[3*u+2]),h.vec3.set(y,e[3*l+0],e[3*l+1],e[3*l+2]),h.vec3.set(D,e[3*c+0],e[3*c+1],e[3*c+2]),h.vec3.subtract(y,y,C),h.vec3.subtract(D,D,C),h.vec3.normalize(y,y),h.vec3.normalize(D,D),h.vec3.cross(I,y,D),this.vertexAttributeNormal[3*u+0]+=I[0],this.vertexAttributeNormal[3*u+1]+=I[1],this.vertexAttributeNormal[3*u+2]+=I[2],this.vertexAttributeNormal[3*l+0]+=I[0],this.vertexAttributeNormal[3*l+1]+=I[1],this.vertexAttributeNormal[3*l+2]+=I[2],this.vertexAttributeNormal[3*c+0]+=I[0],this.vertexAttributeNormal[3*c+1]+=I[1],this.vertexAttributeNormal[3*c+2]+=I[2],this.vertexAttributeNormal[3*v+0]+=I[0],this.vertexAttributeNormal[3*v+1]+=I[1],this.vertexAttributeNormal[3*v+2]+=I[2]}for(;n<r;++n){var u=t[3*n+0],l=t[3*n+1],c=t[3*n+2];h.vec3.set(C,e[3*u+0],e[3*u+1],e[3*u+2]),h.vec3.set(y,e[3*l+0],e[3*l+1],e[3*l+2]),h.vec3.set(D,e[3*c+0],e[3*c+1],e[3*c+2]),h.vec3.subtract(y,y,C),h.vec3.subtract(D,D,C),h.vec3.normalize(y,y),h.vec3.normalize(D,D),h.vec3.cross(I,y,D),this.vertexAttributeNormal[3*u+0]+=I[0],this.vertexAttributeNormal[3*u+1]+=I[1],this.vertexAttributeNormal[3*u+2]+=I[2],this.vertexAttributeNormal[3*l+0]+=I[0],this.vertexAttributeNormal[3*l+1]+=I[1],this.vertexAttributeNormal[3*l+2]+=I[2],this.vertexAttributeNormal[3*c+0]+=I[0],this.vertexAttributeNormal[3*c+1]+=I[1],this.vertexAttributeNormal[3*c+2]+=I[2]}for(var p=this.vertexAttributeNormal.length/3,i=0;i<p;++i)h.vec3.set(C,this.vertexAttributeNormal[3*i+0],this.vertexAttributeNormal[3*i+1],this.vertexAttributeNormal[3*i+2]),h.vec3.normalize(C,C),this.vertexAttributeNormal[3*i+0]=C[0],this.vertexAttributeNormal[3*i+1]=C[1],this.vertexAttributeNormal[3*i+2]=C[2]},e.prototype.createGeometryData=function(){var t={};if(t[f.VertexAttrConstants.POSITION]=this.builder.vertexIndices,t[f.VertexAttrConstants.NORMAL]=this.builder.normalIndices,this.vertexAttributeColor){var e=t[f.VertexAttrConstants.POSITION].length;t[f.VertexAttrConstants.COLOR]=new Uint32Array(e)}var r={};return r[f.VertexAttrConstants.POSITION]={size:3,data:this.vertexAttributePosition},r[f.VertexAttrConstants.NORMAL]={size:3,data:this.vertexAttributeNormal},this.vertexAttributeColor&&(r[f.VertexAttrConstants.COLOR]={size:4,data:this.vertexAttributeColor}),new v(r,t,v.DefaultOffsets,"triangle")},e.prototype.onPathChanged=function(){t.prototype.onPathChanged.call(this),this.bakeVertexPositions(this.size),this.computeNormals()},e.prototype.intersect=function(t,e,r){var i=this.builder.vertexIndices,s={size:3,offsetIdx:0,strideIdx:3,data:this.vertexAttributePosition},a=i.length/3;d.intersectTriangles(t,e,0,a,i,s,void 0,r)},e}(J);t.StaticPathGeometry=j;var q=function(t){function e(e,r,i,s){var a=t.call(this,e)||this;a.sizeAttributeValue=r,a.colorAttributeValue=i,a.opacityAttributeValue=s,a.vvData=null,a.data=null,a.baked=new j(e),a.baked.bakeVertexPositions([1,1]),a.baked.computeNormals(),a.data=new Float32Array(9*a.builder.numVerticesTotal);for(var o=0;o<a.builder.numVerticesTotal;++o){var n=9*o;a.data[n+0]=e.profileRightAxisData[4*o+0],a.data[n+1]=e.profileRightAxisData[4*o+1],a.data[n+2]=e.profileRightAxisData[4*o+2],a.data[n+3]=e.profileUpAxisData[4*o+0],a.data[n+4]=e.profileUpAxisData[4*o+1],a.data[n+5]=e.profileUpAxisData[4*o+2],a.data[n+6]=e.auxVectorData[3*o+0],a.data[n+7]=e.auxVectorData[3*o+1],a.data[n+8]=e.auxVectorData[3*o+2]}a.vvData=new Float32Array(4*a.builder.path.vertices.length);for(var o=0;o<a.builder.path.vertices.length;++o){a.vvData[4*o+0]=r,a.vvData[4*o+1]=i,a.vvData[4*o+2]=s;var h=0===o||o===a.builder.path.vertices.length-1;a.vvData[4*o+3]=h?1:0}return a}return i(e,t),e.prototype.createGeometryData=function(){var t={};t[m.VertexAttrConstants.POSITION]=this.builder.pathVertexIndices,t[m.VertexAttrConstants.NORMAL]=this.builder.normalIndices,t[m.VertexAttrConstants.PATHGEOMETRYINFO]=this.builder.vertexIndices,t[m.VertexAttrConstants.FEATUREVALUE]=this.builder.pathVertexIndices;var e={};return e[m.VertexAttrConstants.POSITION]={size:3,data:this.builder.originData},e[m.VertexAttrConstants.NORMAL]={size:3,data:this.baked.vertexAttributeNormal},e[m.VertexAttrConstants.PATHGEOMETRYINFO]={size:9,data:this.data},e[m.VertexAttrConstants.FEATUREVALUE]={size:4,data:this.vvData},new v(e,t,v.DefaultOffsets,"triangle")},e}(J);t.FastUpdatePathGeometry=q}(x||(x={}));var g=u.vec3f64.create(),b=u.vec3f64.create(),V=u.vec3f64.fromValues(0,0,0),A=n.vec2f64.create(),C=u.vec3f64.create(),y=u.vec3f64.create(),D=u.vec3f64.create(),I=u.vec3f64.create(),N=u.vec3f64.create(),P=x.makeFrame(),S=x.makeFrame(),R=a.mat4f64.create();return x});