// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/IntervalUtilities","../../lib/ResizableFloat32Array","../../lib/Util","../WaterGLMaterial","./Instance","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,r,a,i,n,o,s,u,l,d,g,f,h,p){function m(e,t,r,a){for(var i=new Map,n=t.vertexBufferLayout.stride/4,o=function(r,a){var o=r.origin,s=e.get(o.id),u=i.get(o.id);null==u&&(u={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.getSize(),toAdd:[],toRemove:[],origin:o.vec3},i.set(o.id,u));var l=t.elementCount(r.data)*n;a?(u.optimalCount+=l,u.sparseCount+=l,u.toAdd.push(r)):(u.optimalCount-=l,u.toRemove.push(r))},s=0,u=r;s<u.length;s++){var l=u[s];o(l,!0)}for(var d=0,g=a;d<g.length;d++){var l=g[d];o(l,!1)}return i}var c=function(){function e(e,t,r,a){void 0===a&&(a=n.Default3D),this.type="MergedRenderer",this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._vertexAttributeLocations=a,this._material=r,this._materialRep=t,this._glMaterials=g.acquireMaterials(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}return e.prototype.dispose=function(){g.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.hasWater=function(){var e=!1;return this._glMaterials.forEach(function(t){e=e||t instanceof l.WaterGLMaterial}),e},e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){var t=this,r=_;r.clear(),this.updateGeometries(e.toUpdate,r),this.addAndRemoveGeometries(e.toAdd,e.toRemove,r),this.updateHighlightCount(),r.forEach(function(e){return t.updateDisplayedIndexRanges(e)})},e.prototype.addAndRemoveGeometries=function(e,t,r){var a=this,i=this._material,n=this._bufferWriter,o=n.vertexBufferLayout,s=o.stride/4,l=this._dataByOrigin,d=m(l,n,e,t);d.forEach(function(e,t){d.delete(t);var n=e.optimalCount,g=e.sparseCount,f=l.get(t);if(null==f&&(u.assert(n>0),f=a.createData(o,n,e.origin),l.set(t,f)),0===n)return f.vao.dispose(!0),f.vao=null,void l.delete(t);var h=n<e.sparseCount/2,p=h?n:g,m=y,c=f.buffer.getSize(),b=f.buffer.getArray(),x=f.buffer.resize(p,!1);h||x?a.removeAndRebuild(f,e.toRemove,s,b,m):e.toRemove.length>0?(a.removeByErasing(f,e.toRemove,s,m),e.toAdd.length>0&&(m.end=c)):(m.begin=c,m.end=c);var R=v;u.setMatrixTranslation3(R,-e.origin[0],-e.origin[1],-e.origin[2]),a.append(f,i,e.toAdd,s,R,m);var _=f.vao.vertexBuffers.geometry;if(_.byteSize!==f.buffer.getArray().buffer.byteLength)_.setData(f.buffer.getArray());else{var C=m.begin,A=m.end;if(C<A){var I=f.buffer.getArray(),w=4*C,B=4*A;_.setSubData(I,w,w,B)}}(m.updatedDisplayedIndexRange||f.displayedIndexRanges)&&r.add(f)})},e.prototype.updateGeometries=function(e,t){for(var r=this._bufferWriter,a=r.vertexBufferLayout.stride/4,i=0,n=e;i<n.length;i++){var o=n[i],s=o.updateType,l=o.renderGeometry,d=this._dataByOrigin.get(l.origin.id),f=d&&d.instances.get(l.uniqueName);if(!f)return;if(1&s&&(f.displayedIndexRange=g.generateRenderGeometryVisibleIndexRanges(l),t.add(d)),17&s&&(f.highlightedIndexRanges=g.generateRenderGeometryHighlightRanges(l),d.highlightCount=null),6&s){var h=d.buffer.getArray(),p=d.vao;g.calculateTransformRelToOrigin(l,b,x),r.write({transformation:b,invTranspTransformation:x},l.data,r.vertexBufferLayout.createView(h.buffer),f.from),u.assert(f.from+r.elementCount(l.data)===f.to,"material VBO layout has changed"),p.vertexBuffers.geometry.setSubData(h,f.from*a*4,f.from*a*4,f.to*a*4)}}},e.prototype.updateDisplayedIndexRanges=function(e){var t=e.instances;e.displayedIndexRanges=[];var r=!0;t.forEach(function(t){t.displayedIndexRange?(e.displayedIndexRanges.push.apply(e.displayedIndexRanges,o.offsetIntervals(t.displayedIndexRange,t.from)),r=!1):e.displayedIndexRanges.push([t.from,t.to-1])}),e.displayedIndexRanges=r?null:o.mergeIntervals(e.displayedIndexRanges)},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.instances.forEach(function(e){e.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.updateLogic=function(e){return this._material.update(e)},e.prototype.render=function(e,t,r,a){var i=this,n=this._rctx,o=this._glMaterials.get(t.pass),s=4===t.pass,u=e;if(2===t.pass&&null===u&&(u=20),!o||null!=u&&!o.beginSlot(u)||s&&0===this._highlightCount)return!1;o.bind(n,r);var l=o.getProgram();l.setUniformMatrix4fv("model",R),l.hasUniform("modelNormal")&&l.setUniformMatrix4fv("modelNormal",R);var d=!1;return this._dataByOrigin.forEach(function(e){s&&0===e.highlightCount||(r.origin=e.origin,o.bindView(n,r),d=s?i.renderHighlightPass(o,e,a)||d:i.renderDefaultPass(o,e,a)||d)}),o.release(n,r),d},e.prototype.renderDefaultPass=function(e,t,r){var a=this._rctx,i=e.getProgram(),n=e.getDrawMode(),o=t.displayedIndexRanges;if(o&&0===o.length)return!1;if(h.assertCompatibleVertexAttributeLocations(t.vao,i),a.bindVAO(t.vao),o)g.drawArraysFaceRange(a,o,0,n,r);else{var s=4*t.buffer.getSize()/h.getStride(t.vao.layout.geometry);g.drawArrays(a,n,0,s,r)}return!0},e.prototype.renderHighlightPass=function(e,t,r){var a=this._rctx,i=e.getProgram(),n=e.getDrawMode(),o=t.vao;h.assertCompatibleVertexAttributeLocations(o,i),a.bindVAO(o);var s=!1;return t.instances.forEach(function(e){var t=e.highlightedIndexRanges;if(t&&0!==t.length)for(var i=0;i<t.length;i++){var o=t[i],u=o.range?o.range[0]+e.from:e.from,l=o.range?o.range[1]-o.range[0]+1:e.to-e.from;g.drawArrays(a,n,u,l,r),s=!0}}),s},e.prototype.createData=function(e,t,r){return{instances:new Map,vao:new p(this._rctx,this._vertexAttributeLocations,{geometry:i.glLayout(e)},{geometry:f.createVertex(this._rctx,35044)}),buffer:new s.ResizableFloat32Array(t),optimalCount:0,origin:r,highlightCount:0}},e.prototype.removeAndRebuild=function(e,t,r,a,i){for(var n=0,o=t;n<o.length;n++){var s=o[n],u=s.uniqueName,l=e.instances.get(u);e.optimalCount-=(l.to-l.from)*r,e.instances.delete(u)}var d=0,g=e.buffer.getArray();i.begin=0,i.end=0;var f=-1,h=-1,p=0;e.instances.forEach(function(e){var t=e.from*r,i=e.to*r,n=i-t;f!==h&&h!==t?(g.set(a.subarray(f,h),p),p+=h-f,f=t):-1===f&&(f=t),h=i,e.from=d/r,d+=n,e.to=d/r}),f!==h&&g.set(a.subarray(f,h),p),i.end=d},e.prototype.removeByErasing=function(e,t,r,a){a.begin=1/0,a.end=-1/0;for(var i=-1,n=-1,o=0,s=t;o<s.length;o++){var u=s[o],l=u.uniqueName,d=e.instances.get(l),g=d.from*r,f=d.to*r;i!==n&&n!==g?(e.buffer.erase(i,n),i=g):-1===i&&(i=g),n=f,e.instances.delete(l),e.optimalCount-=f-g,g<a.begin&&(a.begin=g),f>a.end&&(a.end=f)}i!==n&&e.buffer.erase(i,n)},e.prototype.append=function(e,t,a,i,n,o){o.updatedDisplayedIndexRange=!1;for(var s=this._bufferWriter,l=0,f=a;l<f.length;l++){var h=f[l],p=h.data;r.mat4.multiply(b,n,h.transformation),r.mat4.invert(x,b),r.mat4.transpose(x,x);var m=o.end;s.write({transformation:b,invTranspTransformation:x},p,s.vertexBufferLayout.createView(e.buffer.getArray().buffer),o.end/i);var c=s.elementCount(p)*i,y=m+c;u.assert(null==e.instances.get(h.uniqueName));var v=g.generateRenderGeometryVisibleIndexRanges(h),R=g.generateRenderGeometryHighlightRanges(h);R&&(e.highlightCount=null);var _=new d(h.name,m/i,y/i,v,R,void 0,void 0,h.idx);e.instances.set(h.uniqueName,_),v&&(o.updatedDisplayedIndexRange=!0),e.optimalCount+=c,o.end+=c}},Object.defineProperty(e.prototype,"test",{get:function(){return{material:this._material}},enumerable:!0,configurable:!0}),e}(),y={updatedDisplayedIndexRange:!1,begin:0,end:0},v=a.mat4f64.create(),b=a.mat4f64.create(),x=a.mat4f64.create(),R=a.mat4f64.create(),_=new Set;return c});