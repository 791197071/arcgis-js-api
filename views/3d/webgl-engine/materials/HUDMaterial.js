// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/types/mat4","../../../../geometry/support/aaBoundingRect","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterialTexture","../lib/Material","../lib/screenSizePerspectiveUtils","../lib/Util","./internal/bufferWriterUtils","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/HUDPrograms","../../../webgl/renderState"],function(e,t,r,i,n,a,o,s,c,l,f,v,p,d,m,u,g,h,S,P,x,A,O,y,b){function z(e,t,r){var i=r.cameraAboveGround?1:-1;e.setUniform1f("cameraGroundRelative",i),e.setUniform1f("polygonOffset",t.shaderPolygonOffset),e.setUniform4fv("viewport",r.viewport),e.setUniform1f("perDistancePixelRatio",Math.tan(r.fovY/2)/(r.viewport[2]/2)),A.bindVerticalOffset(t.verticalOffset,r,e),e.setUniformMatrix4fv("viewNormal",r.viewInvTransp),t.screenSizePerspective&&(A.bindScreenSizePerspective(t.screenSizePerspective,e,"screenSizePerspective"),A.bindScreenSizePerspective(t.screenSizePerspectiveAlignment||t.screenSizePerspective,e,"screenSizePerspectiveAlignment"))}function C(e,t,r,i){r.occlusionTest&&(t.setUniform1i("hudVisibilityTexture",1),e.bindTexture(i.hudVisibilityTexture,1),e.setActiveTexture(0)),t.setUniform1f("uRenderTransparentlyOccludedHUD","occluded"===i.renderTransparentlyOccludedHUD?1:"notOccluded"===i.renderTransparentlyOccludedHUD?0:.75);var n=i.pixelRatio||1;t.setUniform4fv("overrideColor",r.color),t.setUniform1f("pixelRatio",n),r.textureIsSignedDistanceField&&(t.setUniform4fv("outlineColor",r.outlineColor),t.setUniform1f("outlineSize",r.outlineSize)),r.vvSizeEnabled&&(t.setUniform3fv("vvSizeMinSize",r.vvSizeMinSize),t.setUniform3fv("vvSizeMaxSize",r.vvSizeMaxSize),t.setUniform3fv("vvSizeOffset",r.vvSizeOffset),t.setUniform3fv("vvSizeFactor",r.vvSizeFactor)),r.vvColorEnabled&&(t.setUniform1fv("vvColorValues",r.vvColorValues),t.setUniform4fv("vvColorColors",r.vvColorColors)),t.setUniform2f("screenOffset",2*r.screenOffset[0]*n,2*r.screenOffset[1]*n),t.setUniform2fv("anchorPos",V(r))}function V(e,t){return void 0===t&&(t=B),e.textureIsSignedDistanceField?I(e.anchorPos,e.distanceFieldBoundingBox,t):c.vec2.copy(t,e.anchorPos),t}function U(e,t,r,i){return void 0===i&&(i=B),c.vec2.copy(i,e.anchorPos),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r,i}function I(e,t,r){r[0]=e[0]*(t[2]-t[0])+t[0],r[1]=e[1]*(t[3]-t[1])+t[1]}function M(e){var t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8],f=1/Math.sqrt(t*t+r*r+i*i),v=1/Math.sqrt(n*n+a*a+o*o),p=1/Math.sqrt(s*s+c*c+l*l);return e[0]=t*f,e[1]=r*f,e[2]=i*f,e[3]=n*v,e[4]=a*v,e[5]=o*v,e[6]=s*p,e[7]=c*p,e[8]=l*p,e}var w=function(e){function t(t,r){var i=e.call(this,r)||this;return i.params=A.copyParameters(t,J),i}return r(t,e),t.prototype.dispose=function(){},t.prototype.setParameterValues=function(e){for(var t in e)"textureId"===t&&P.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[t]=e[t];this.notifyDirty("matChanged")},t.prototype.getParameters=function(){return this.params},t.prototype.intersect=function(e,t,r,i,n,a,o,s,c){c?this.intersectDrapedRenderHudGeometry(e,t,r,i,n,a,o,s):this.intersectHudGeometry(e,t,r,i,n,a,o,s)},t.prototype.intersectDrapedRenderHudGeometry=function(e,t,r,i,n,a,o,s){var c=e.getAttribute(P.VertexAttrConstants.POSITION),l=e.getAttribute(P.VertexAttrConstants.SIZE),v=this.params,p=V(v),d=1,m=1;if(s){var u=s(Z);d=u[0],m=u[5]}d*=e.pixelRatio,m*=e.pixelRatio;for(var g=_*e.pixelRatio,h=0;h<c.data.length/c.size;h++){var S=h*c.size;f.vec3.set(E,c.data[S],c.data[S+1],c.data[S+2]);var x=h*l.size;j[0]=l.data[x]*d,j[1]=l.data[x+1]*m;var A=E[0],O=E[1],y=void 0;v.textureIsSignedDistanceField&&(y=v.outlineSize*e.pixelRatio/2),this._isInsideIconBoundaries(a,A,O,g,y,v,p)&&o()}},t.prototype.intersectHudGeometry=function(e,t,r,i,a,s,c,l){if(i.enable.selectionMode&&i.enable.hud&&!u.isAllHidden(t.componentVisibilities,e.componentOffsets)){var p=e.data,d=this.params,m=1,g=1;if(n.mat3.fromMat4(W,r),l){var h=l(Z);m=h[0],g=h[5],M(W)}var x=p.getVertexAttr()[P.VertexAttrConstants.POSITION],A=p.getVertexAttr()[P.VertexAttrConstants.SIZE],O=p.getVertexAttr()[P.VertexAttrConstants.NORMAL],y=p.getVertexAttr()[P.VertexAttrConstants.AUXPOS1];P.assert(x.size>=3);var b=i.point,z=i.camera,C=V(d);m*=z.pixelRatio,g*=z.pixelRatio;for(var U="screen"===this.params.centerOffsetUnits,I=0;I<x.data.length/x.size;I++){var w=I*x.size;f.vec3.set(E,x.data[w],x.data[w+1],x.data[w+2]),f.vec3.transformMat4(E,E,r);var T=I*A.size;j[0]=A.data[T]*m,j[1]=A.data[T+1]*g,f.vec3.transformMat4(E,E,z.viewMatrix);var R=I*y.size;if(f.vec3.set(G,y.data[R+0],y.data[R+1],y.data[R+2]),!U&&(E[0]+=G[0],E[1]+=G[1],0!==G[2])){var B=G[2];f.vec3.normalize(G,E),f.vec3.subtract(E,E,f.vec3.scale(G,G,B))}var H=I*O.size;if(f.vec3.set(F,O.data[H],O.data[H+1],O.data[H+2]),this.applyVerticalOffsetTransformation(E,F,W,z,D),z.applyProjection(E,N),N[0]>-1){var k=Math.floor(N[0])+this.params.screenOffset[0],_=Math.floor(N[1])+this.params.screenOffset[1];U&&(k+=G[0],0!==G[1]&&(_+=S.applyScaleFactor(G[1],D.factorAlignment))),S.applyPrecomputedScaleFactorVec2(j,D.factor,j);var Y=q*z.pixelRatio,J=void 0;if(d.textureIsSignedDistanceField&&(J=d.outlineSize*z.pixelRatio/2),this._isInsideIconBoundaries(b,k,_,Y,J,d,C)){var K=i.ray;f.vec3.transformMat4(L,E,o.mat4.invert(X,z.viewMatrix)),N[0]=b[0],N[1]=b[1],z.unprojectPoint(N,E);var Q=v.vec3f64.create();f.vec3.copy(Q,K.direction);var $=1/f.vec3.length(Q);f.vec3.scale(Q,Q,$);c(f.vec3.distance(K.origin,E)*$,Q,-1,1,!0,L)}}}}},t.prototype._isInsideIconBoundaries=function(e,t,r,i,n,a,o){var s=t-i-(o[0]>0?j[0]*o[0]:0),c=s+j[0]+2*i,l=r-i-(o[1]>0?j[1]*o[1]:0),f=l+j[1]+2*i;if(a.textureIsSignedDistanceField){var v=a.distanceFieldBoundingBox;s+=j[0]*v[0],l+=j[1]*v[1],c-=j[0]*(1-v[2]),f-=j[1]*(1-v[3]),s-=n,c+=n,l-=n,f+=n}return e[0]>s&&e[0]<c&&e[1]>l&&e[1]<f},t.prototype.createBufferWriter=function(){return new Q(this)},t.prototype.createRenderer=function(e,t){return new O(e,t,this)},t.prototype.normalAndViewAngle=function(e,t,r,i){return void 0===i&&(i=k),f.vec3.transformMat3(i.normal,e,t),f.vec3.transformMat4(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=f.vec3.dot(H,Y),i},t.prototype.updateScaleInfo=function(e,t,r){var i=this.params;i.screenSizePerspective?e.factor=S.precomputeScaleFactor(k.cosAngle,r,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),i.screenSizePerspectiveAlignment?e.factorAlignment=S.precomputeScaleFactor(k.cosAngle,r,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)},t.prototype.applyVerticalOffsetTransformation=function(e,t,r,i,a,o){var s=this.params;if(p.isMat4(r)&&(r=n.mat3.fromMat4(W,r)),!s.verticalOffset||!s.verticalOffset.screenLength){if(a&&(s.screenSizePerspective||s.screenSizePerspectiveAlignment)){var c=this.normalAndViewAngle(t,r,i),l=f.vec3.length(e);this.updateScaleInfo(a,c.cosAngle,l)}else a&&(a.factor.scale=1,a.factorAlignment.scale=1);return o?f.vec3.copy(o,e):e}var v=this.normalAndViewAngle(t,r,i),d=f.vec3.length(e),m=s.screenSizePerspectiveAlignment||s.screenSizePerspective,u=A.verticalOffsetAtDistance(i,d,s.verticalOffset,v.cosAngle,m);return a&&this.updateScaleInfo(a,v.cosAngle,d),f.vec3.add(o||e,e,f.vec3.scale(v.normal,v.normal,u))},t.prototype.getGLMaterials=function(){return{color:T,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:R}},t.prototype.calculateRelativeScreenBounds=function(e,t,r){return void 0===r&&(r=d.create()),U(this.params,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r},t.prototype.calculateAnchorPosForRendering=function(e){return V(this.params,e)},t.shouldRenderVisibilityDuringRenderPass=function(e){return 0===e||4},t}(h.Material),T=function(e){function t(t){var r=e.call(this,g.makeCtorParameters(t,t.material.getParameters()))||this;return r.isOcclusionSlot=!1,r.updateParameters(),r}return r(t,e),t.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?17:16},t.prototype.selectProgram=function(){var e=this.params;this.occlusionProgram=this.programRep.getProgram(y.occlusionPass,{verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,slice:e.slicePlaneEnabled}),this.renderProgram=this.programRep.getProgram(y.colorPass,{occlTest:e.occlusionTest,sdf:e.textureIsSignedDistanceField,vvSize:!!e.vvSizeEnabled,vvColor:!!e.vvColorEnabled,verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,debugDrawBorder:!!e.debugDrawBorder,slice:e.slicePlaneEnabled}),this.renderPipelineState=b.makePipelineState({blending:b.simpleBlendingParams(1,771),polygonOffset:e.polygonOffset&&$,depthTest:{func:515},depthWrite:b.defaultDepthWriteParams,colorWrite:b.defaultColorWriteParams}),this.occlusionPipelineState=b.makePipelineState({depthTest:{func:515},depthWrite:b.defaultDepthWriteParams,colorWrite:b.defaultColorWriteParams})},t.prototype.beginSlot=function(e){return this.params.occlusionTest?(this.isOcclusionSlot=11===e,11===e||e===this.mainSlot):(this.isOcclusionSlot=!1,e===this.mainSlot)},t.prototype.getProgram=function(){return this.isOcclusionSlot?this.occlusionProgram:this.renderProgram},t.prototype.getPrograms=function(){return[this.occlusionProgram,this.renderProgram]},t.prototype.updateParameters=function(){this.params=A.copyParameters(this.material.getParameters()),this.updateTexture(this.params.textureId),this.selectProgram(),this.selectSlot()},t.prototype.bind=function(e,t){if(this.isOcclusionSlot){var r=this.occlusionProgram;e.bindProgram(r),e.setPipelineState(this.occlusionPipelineState),z(r,this.params,t),r.setUniform4f("color",1,1,1,1),r.setUniform1f("pixelRatio",t.pixelRatio||1)}else{var r=this.renderProgram;e.bindProgram(r),e.setPipelineState(this.renderPipelineState),this.bindTexture(e,r),this.bindTextureScale(e,r),z(r,this.params,t),C(e,r,this.params,t)}},t.prototype.bindView=function(e,t){var r=t.origin,i=this.getProgram();A.bindView(r,t.view,i),A.bindCamPos(r,t.viewInvTransp,i),this.params.slicePlaneEnabled&&A.bindSlicePlane(t.origin,t.slicePlane,i)},t.prototype.bindInstance=function(e,t){var r=this.getProgram();r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.release=function(e){},t.prototype.getDrawMode=function(){return this.isOcclusionSlot?0:4},t}(g),R=function(e){function t(t){var r=e.call(this,g.makeCtorParameters(t,t.material.getParameters()))||this;return r.updateParameters(),r}return r(t,e),t.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?17:16},t.prototype.beginSlot=function(e){return e===this.mainSlot},t.prototype.getProgram=function(){return this.program},t.prototype.updateParameters=function(){this.params=A.copyParameters(this.material.getParameters()),this.updateTexture(this.params.textureId),this.selectProgram(),this.selectSlot()},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(y.highlightPass,{occlTest:e.occlusionTest,sdf:e.textureIsSignedDistanceField,vvSize:!!e.vvSizeEnabled,vvColor:!!e.vvColorEnabled,verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,binaryHighlightOcclusion:e.binaryHighlightOcclusion,slice:e.slicePlaneEnabled}),this.pipelineState=b.makePipelineState({blending:b.separateBlendingParams(1,1,771,771),polygonOffset:e.polygonOffset&&$,depthTest:{func:513},colorWrite:b.defaultColorWriteParams})},t.prototype.bind=function(e,t){var r=this.program;e.bindProgram(r),e.setPipelineState(this.pipelineState),this.bindTexture(e,r),this.bindTextureScale(e,r),z(r,this.params,t),C(e,r,this.params,t),A.bindHighlightRendering(e,t,this.program)},t.prototype.bindView=function(e,t){var r=t.origin,i=this.getProgram();A.bindView(r,t.view,i),A.bindCamPos(r,t.viewInvTransp,i),this.params.slicePlaneEnabled&&A.bindSlicePlane(t.origin,t.slicePlane,i)},t.prototype.bindInstance=function(e,t){var r=this.getProgram();r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.release=function(e){},t.prototype.getDrawMode=function(){return 4},t}(g),D={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},B=l.vec2f64.create(),E=v.vec3f64.create(),F=v.vec3f64.create(),N=i.createRenderScreenPointArray3(),H=v.vec3f64.create(),L=v.vec3f64.create(),W=a.mat3f64.create(),X=s.mat4f64.create(),G=v.vec3f64.create(),k={normal:H,cosAngle:0},Z=s.mat4f64.create();o.mat4.identity(Z);var q=1,_=2,j=[0,0],Y=v.vec3f64.fromValues(0,0,1),J={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:l.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},K=m.newLayout().vec3f(P.VertexAttrConstants.POSITION).vec3f(P.VertexAttrConstants.NORMAL).vec2f(P.VertexAttrConstants.UV0).vec4u8(P.VertexAttrConstants.COLOR).vec2f(P.VertexAttrConstants.SIZE).vec4f(P.VertexAttrConstants.AUXPOS1).vec4f(P.VertexAttrConstants.AUXPOS2),Q=function(){function e(e){this.material=e,this.vertexBufferLayout=K}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return 6*e.indices[P.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,i){x.writePosition(t.indices[P.VertexAttrConstants.POSITION],t.vertexAttr[P.VertexAttrConstants.POSITION].data,e.transformation,r.position,i,6),x.writeNormal(t.indices[P.VertexAttrConstants.NORMAL],t.vertexAttr[P.VertexAttrConstants.NORMAL].data,e.invTranspTransformation,r.normal,i,6);var n=t.vertexAttr[P.VertexAttrConstants.UV0].data,a=void 0,o=void 0,s=void 0,c=void 0;if(null==n||n.length<4){var l=this.material.getParameters();a=0,o=0,s=l.texCoordScale[0],c=l.texCoordScale[1]}else a=n[0],o=n[1],s=n[2],c=n[3];s=Math.min(1.99999,s+1),c=Math.min(1.99999,c+1);for(var f=t.indices[P.VertexAttrConstants.POSITION].length,v=r.uv0,p=i,d=0;d<f;++d)v.set(p,0,a),v.set(p,1,o),p+=1,v.set(p,0,s),v.set(p,1,o),p+=1,v.set(p,0,s),v.set(p,1,c),p+=1,v.set(p,0,s),v.set(p,1,c),p+=1,v.set(p,0,a),v.set(p,1,c),p+=1,v.set(p,0,a),v.set(p,1,o),p+=1;x.writeColor(t.indices[P.VertexAttrConstants.COLOR],t.vertexAttr[P.VertexAttrConstants.COLOR].data,4,r.color,i,6);for(var m=t.indices[P.VertexAttrConstants.SIZE],u=t.vertexAttr[P.VertexAttrConstants.SIZE].data,g=m.length,h=r.size,p=i,d=0;d<g;++d)for(var S=u[2*m[d]],A=u[2*m[d]+1],O=0;O<6;++O)h.set(p,0,S),h.set(p,1,A),p+=1;t.indices[P.VertexAttrConstants.AUXPOS1]&&t.vertexAttr[P.VertexAttrConstants.AUXPOS1]&&x.writeBufferVec4(t.indices[P.VertexAttrConstants.AUXPOS1],t.vertexAttr[P.VertexAttrConstants.AUXPOS1].data,r.auxpos1,i,6),t.indices[P.VertexAttrConstants.AUXPOS2]&&t.vertexAttr[P.VertexAttrConstants.AUXPOS2]&&x.writeBufferVec4(t.indices[P.VertexAttrConstants.AUXPOS2],t.vertexAttr[P.VertexAttrConstants.AUXPOS2].data,r.auxpos2,i,6)},e}(),$={factor:0,units:-4};return w});