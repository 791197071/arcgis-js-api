// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f32","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../../../geometry/support/aaBoundingBox","../../lib/ComponentUtils","../../lib/doublePrecisionUtils","../../lib/screenSizePerspectiveUtils","../../lib/Util"],function(e,t,r,i,n,a,o,c,f,s,l,u,v,m){function d(e,t,r,i,n,a){var o=t&&t.componentVisibilities,c=r.tolerance;if(e.componentCount>1)h(e,o,i,n,c,a);else if(!o||l.getVisibility(o,0))if(e.boundingInfo)m.assert("triangle"===e.data.primitiveType),g(e.boundingInfo,i,n,c,a);else{var f=e.getIndices(j.POSITION),s=e.getAttribute(j.POSITION),u=f.length/3;p(i,n,0,u,f,s,void 0,a)}}function g(e,t,r,i,n){var a=P(t,r,G);if(s.setMin(_,e.getBBMin()),s.setMax(_,e.getBBMax()),x(_,t,a,i)){var o=e.getPrimitiveIndices(),c=e.getIndices(),f=e.getPosition(),l=o?o.length:c.length/3;if(l>te){var u=e.getChildren();if(void 0!==u){for(var v=0;v<8;++v)void 0!==u[v]&&g(u[v],t,r,i,n);return}}p(t,r,0,l,c,f,o,n)}}function h(e,t,r,i,n,a){var o=P(r,i,G),c=e.componentCount,f=e.componentOffsets,u=e.getIndices(j.POSITION),v=e.getAttribute(j.POSITION),m=e.boundingInfo;if(!m||(s.setMin(_,m.getBBMin()),s.setMax(_,m.getBBMax()),x(_,r,o,n)))for(var d=0;d<c;d++)if(!t||l.getVisibility(t,d)){if(e.getComponentAABB){var g=e.getComponentAABB(d,_);if(!x(g,r,o,n))continue}var h=f[d]/3,b=f[d+1]/3;p(r,i,h,b,u,v,void 0,a)}}function p(e,t,r,i,n,a,o,c){if(o)return b(e,t,r,i,n,a,o,c);for(var f=a.data,s=a.offsetIdx,l=a.strideIdx,u=e[0],v=e[1],m=e[2],d=t[0],g=t[1],h=t[2],p=d-u,P=g-v,x=h-m,I=r,B=3*r;I<i;++I){var O=s+l*n[B++],S=f[O++],A=f[O++],U=f[O];O=s+l*n[B++];var L=f[O++],T=f[O++],w=f[O];O=s+l*n[B++];var y=f[O++],R=f[O++],D=f[O],W=L-S,E=T-A,N=w-U,V=y-S,C=R-A,z=D-U,F=P*z-C*x,q=x*V-z*p,H=p*C-V*P,Y=W*F+E*q+N*H;if(!(Math.abs(Y)<=k)){var _=u-S,j=v-A,G=m-U,Z=_*F+j*q+G*H;if(Y>0){if(Z<0||Z>Y)continue}else if(Z>0||Z<Y)continue;var J=j*N-E*G,K=G*W-N*_,Q=_*E-W*j,$=p*J+P*K+x*Q;if(Y>0){if($<0||Z+$>Y)continue}else if($>0||Z+$<Y)continue;var ee=(V*J+C*K+z*Q)/Y;if(ee>=0){c(ee,M(W,E,N,V,C,z,X),I)}}}}function b(e,t,r,i,n,a,o,c){for(var f=a.data,s=a.offsetIdx,l=a.strideIdx,u=e[0],v=e[1],m=e[2],d=t[0],g=t[1],h=t[2],p=d-u,b=g-v,P=h-m,x=r;x<i;++x){var I=o[x],B=3*I,O=s+l*n[B++],S=f[O++],A=f[O++],U=f[O];O=s+l*n[B++];var L=f[O++],T=f[O++],w=f[O];O=s+l*n[B];var y=f[O++],R=f[O++],D=f[O],W=L-S,E=T-A,N=w-U,V=y-S,C=R-A,z=D-U,F=b*z-C*P,q=P*V-z*p,H=p*C-V*b,Y=W*F+E*q+N*H;if(!(Math.abs(Y)<=k)){var _=u-S,j=v-A,G=m-U,Z=_*F+j*q+G*H;if(Y>0){if(Z<0||Z>Y)continue}else if(Z>0||Z<Y)continue;var J=j*N-E*G,K=G*W-N*_,Q=_*E-W*j,$=p*J+b*K+P*Q;if(Y>0){if($<0||Z+$>Y)continue}else if($>0||Z+$<Y)continue;var ee=(V*J+C*K+z*Q)/Y;if(ee>=0){c(ee,M(W,E,N,V,C,z,X),I)}}}}function M(e,t,r,i,n,a,c){return o.vec3.set(Z,e,t,r),o.vec3.set(J,i,n,a),o.vec3.cross(c,Z,J),o.vec3.normalize(c,c),c}function P(e,t,r){return o.vec3.set(r,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function x(e,t,r,i){var n=(e[0]-i-t[0])*r[0],a=(e[3]+i-t[0])*r[0],o=Math.min(n,a),c=Math.max(n,a),f=(e[1]-i-t[1])*r[1],s=(e[4]+i-t[1])*r[1];if(o=Math.max(o,Math.min(f,s)),c=Math.min(c,Math.max(f,s)),o>c)return!1;var l=(e[2]-i-t[2])*r[2],u=(e[5]+i-t[2])*r[2];return o=Math.max(o,Math.min(l,u)),c=Math.min(c,Math.max(l,u)),o<=c}function I(e,t,r){return f.vec4.set(r,e[0]-t[0],e[1]-t[1],e[2]-t[2],1)}function B(e,t,r,n){return i.mat4.translate(Y,r,t),r=Y,f.vec4.transformMat4(n,e,r)}function O(e,t,r,i){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i[3]=e[3],f.vec4.transformMat4(i,i,t)}function S(e,t){return f.vec4.scale(t,e,1/Math.abs(e[3]))}function A(e,t,r,i,n){return v.scale(e,i,r,n)}function U(e,t,i,n,a){var o=(i.screenLength||0)*e.pixelRatio;a&&(o=A(o,e,t,n,a));var c=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return r.clamp(c*t,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)}function L(e,t,r){if(void 0!==e)return t.acquire(e,r)}function T(e,t){void 0!==e&&t.release(e)}function w(e,t,r){i.mat4.translate(K,t,e),r.setUniform3fv("localOrigin",e),r.setUniformMatrix4fv("view",K)}function y(e,t,r){r.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])}function R(e,t){u.encodeDoubleArraySplit(e,Q,$,3),t.setUniform3fv("viewOriginHi",Q),t.setUniform3fv("viewOriginLo",$)}function D(e,t,r){o.vec3.subtract(ee,t.origin,e),r.setUniform3fv("slicePlaneOrigin",ee),r.setUniform3fv("slicePlaneBasis1",t.basis1),r.setUniform3fv("slicePlaneBasis2",t.basis2)}function W(e,t,r){if(e){var i=N(e,t.fovY,t.viewport[3]),n=t.pixelRatio||1;r.setUniform4f("verticalOffset",i.screenLength*n,i.perDistance,i.minWorldLength,i.maxWorldLength)}}function E(e,t,r){e.bindTexture(t.highlightDepthTexture,5),r.setUniform1i("depthTex",5),r.setUniform4f("highlightViewportPixelSz",0,0,1/t.viewport[2],1/t.viewport[3])}function N(e,t,r,i){return void 0===i&&(i=re),i.screenLength=e.screenLength,i.perDistance=Math.tan(.5*t)/(.5*r),i.minWorldLength=e.minWorldLength,i.maxWorldLength=e.maxWorldLength,i}function V(e,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var i=e.parameters,n=e.paddingPixelsOverride;t.setUniform4f(r,i.divisor,i.offset,i.minPixelSize,n)}}function C(e,t){var r=t?C(t):{};for(var i in e){var n=e[i];n&&n.forEach&&(n=q(n)),null==n&&i in r||(r[i]=n)}return r}function z(e,t){var r=!1;for(var i in t){var n=t[i];void 0!==n&&(r=!0,Array.isArray(n)?e[i]=n.slice():e[i]=n)}return r}function F(e,t,i,n,a,o,c,f,s){if(n.enable.selectionMode){for(var l=e.getAttribute(j.POSITION).data,u=e.getAttribute(j.SIZE),v=u&&u.data[0],m=o[0],d=o[1],g=v+c,h=(g/2+4)*e.pixelRatio,p=Number.MAX_VALUE,b=0;b<l.length-5;b+=3){var M=l[b],P=l[b+1],x=l[b+3],I=l[b+4],B=m-M,O=d-P,S=x-M,A=I-P,U=S*B+A*O,L=S*S+A*A,T=r.clamp(U/L,0,1),w=S*T-B,y=A*T-O,R=w*w+y*y;R<p&&(p=R)}p<h*h&&f()}}function q(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}function H(e,r){return r&&e?t.defaultPBRTreeMaterialParameters:e?t.defaultPBRMaterialParameters:{usePBR:!1}}Object.defineProperty(t,"__esModule",{value:!0});var Y=a.mat4f64.create(),_=s.create(),j=m.VertexAttrConstants;t.IDENTITY=a.mat4f64.create(),t.intersectTriangleGeometry=d;var G=c.vec3f64.create(),k=Math.pow(2,-52),X=c.vec3f64.create();t.intersectTriangles=p;var Z=c.vec3f64.create(),J=c.vec3f64.create();t.computeNormal=M,t.intersectAabbInvDir=x,t.transformToWorld=I,t.transformToView=B,t.transformToProjection=O,t.transformToNDC=S,t.applyScreenSizePerspectiveScale=A,t.verticalOffsetAtDistance=U,t.acquireIfNotUndefined=L,t.releaseIfNotUndefined=T;var K=n.mat4f32.create();t.bindView=w,t.bindCamPos=y;var Q=c.vec3f64.create(),$=c.vec3f64.create();t.bindViewOriginDouble=R;var ee=c.vec3f64.create();t.bindSlicePlane=D,t.bindVerticalOffset=W,t.bindHighlightRendering=E,t.bindScreenSizePerspective=V,t.copyParameters=C,t.updateParameters=z;!function(e){function t(e,t){for(var r=[],i=0;i<2;i++)for(var a=0;a<2;a++){var o=n({shadowMappingEnabled:1===i,ssaoEnabled:1===a}),c=n({shadowMappingEnabled:1===i,ssaoEnabled:1===a&&e.receiveSSAO});r[o]=r[c]||t({receiveShadows:1===i,receiveSSAO:1===a&&e.receiveSSAO})}return{programs:r.filter(function(e){return null!=e}),byParameter:r}}function r(e,t){return e.byParameter[n(t)]}function i(e){return e.programs}function n(e){return(e.shadowMappingEnabled?1:0)|(e.ssaoEnabled?2:0)}e.create=t,e.lookup=r,e.programs=i}(t.BindParametersMap||(t.BindParametersMap={})),t.intersectDrapedRenderLineGeometry=F,t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var te=1e3,re={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0};t.defaultPBRMaterialParameters={usePBR:!0,roughnessFactor:.6,metallicFactor:0,reflectanceFactor:.2},t.defaultPBRTreeMaterialParameters={usePBR:!0,roughnessFactor:1,metallicFactor:0,reflectanceFactor:.2},t.returnDefaultPBRMaterialParameters=H});