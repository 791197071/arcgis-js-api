// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/mathUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f32","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../../../geometry/support/aaBoundingBox","../../lib/ComponentUtils","../../lib/doublePrecisionUtils","../../lib/screenSizePerspectiveUtils","../../lib/Util"],function(e,t,i,n,r,a,o,c,f,s,l,v,u,m){function d(e,t,i,n,r,a,o,c){var f=t&&t.componentVisibilities,s=n.tolerance;if(e.componentCount>1)h(e,f,r,a,s,o);else if(!f||l.getVisibility(f,0))if(e.boundingInfo)m.assert("triangle"===e.data.primitiveType),g(e.boundingInfo,r,a,s,o);else{var v=e.getIndices(j.POSITION),u=e.getAttribute(j.POSITION),d=v.length/3;p(r,a,0,d,v,u,void 0,o)}}function g(e,t,i,n,r){var a=M(t,i,G);if(s.setMin(_,e.getBBMin()),s.setMax(_,e.getBBMax()),P(_,t,a,n)){var o=e.getPrimitiveIndices(),c=e.getIndices(),f=e.getPosition(),l=o?o.length:c.length/3;if(l>ee){var v=e.getChildren();if(void 0!==v){for(var u=0;u<8;++u)void 0!==v[u]&&g(v[u],t,i,n,r);return}}p(t,i,0,l,c,f,o,r)}}function h(e,t,i,n,r,a){var o=M(i,n,G),c=e.componentCount,f=e.componentOffsets,v=e.getIndices(j.POSITION),u=e.getAttribute(j.POSITION),m=e.boundingInfo;if(!m||(s.setMin(_,m.getBBMin()),s.setMax(_,m.getBBMax()),P(_,i,o,r)))for(var d=0;d<c;d++)if(!t||l.getVisibility(t,d)){if(e.getComponentAABB){var g=e.getComponentAABB(d,_);if(!P(g,i,o,r))continue}var h=f[d]/3,b=f[d+1]/3;p(i,n,h,b,v,u,void 0,a)}}function p(e,t,i,n,r,a,o,c){if(o)return b(e,t,i,n,r,a,o,c);for(var f=a.data,s=a.offsetIdx,l=a.strideIdx,v=e[0],u=e[1],m=e[2],d=t[0],g=t[1],h=t[2],p=d-v,M=g-u,P=h-m,I=i,O=3*i;I<n;++I){var S=s+l*r[O++],A=f[S++],U=f[S++],L=f[S];S=s+l*r[O++];var B=f[S++],T=f[S++],w=f[S];S=s+l*r[O++];var y=f[S++],W=f[S++],D=f[S],E=B-A,N=T-U,V=w-L,C=y-A,z=W-U,R=D-L,q=M*R-z*P,H=P*C-R*p,Y=p*z-C*M,_=E*q+N*H+V*Y;if(!(Math.abs(_)<=k)){var j=v-A,G=u-U,Z=m-L,F=j*q+G*H+Z*Y;if(_>0){if(F<0||F>_)continue}else if(F>0||F<_)continue;var J=G*V-N*Z,K=Z*E-V*j,Q=j*N-E*G,$=p*J+M*K+P*Q;if(_>0){if($<0||F+$>_)continue}else if($>0||F+$<_)continue;var ee=(C*J+z*K+R*Q)/_;if(ee>=0){c(ee,x(E,N,V,C,z,R,X),I)}}}}function b(e,t,i,n,r,a,o,c){for(var f=a.data,s=a.offsetIdx,l=a.strideIdx,v=e[0],u=e[1],m=e[2],d=t[0],g=t[1],h=t[2],p=d-v,b=g-u,M=h-m,P=i;P<n;++P){var I=o[P],O=3*I,S=s+l*r[O++],A=f[S++],U=f[S++],L=f[S];S=s+l*r[O++];var B=f[S++],T=f[S++],w=f[S];S=s+l*r[O];var y=f[S++],W=f[S++],D=f[S],E=B-A,N=T-U,V=w-L,C=y-A,z=W-U,R=D-L,q=b*R-z*M,H=M*C-R*p,Y=p*z-C*b,_=E*q+N*H+V*Y;if(!(Math.abs(_)<=k)){var j=v-A,G=u-U,Z=m-L,F=j*q+G*H+Z*Y;if(_>0){if(F<0||F>_)continue}else if(F>0||F<_)continue;var J=G*V-N*Z,K=Z*E-V*j,Q=j*N-E*G,$=p*J+b*K+M*Q;if(_>0){if($<0||F+$>_)continue}else if($>0||F+$<_)continue;var ee=(C*J+z*K+R*Q)/_;if(ee>=0){c(ee,x(E,N,V,C,z,R,X),I)}}}}function x(e,t,i,n,r,a,c){return o.vec3.set(Z,e,t,i),o.vec3.set(F,n,r,a),o.vec3.cross(c,Z,F),o.vec3.normalize(c,c),c}function M(e,t,i){return o.vec3.set(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function P(e,t,i,n){var r=(e[0]-n-t[0])*i[0],a=(e[3]+n-t[0])*i[0],o=Math.min(r,a),c=Math.max(r,a),f=(e[1]-n-t[1])*i[1],s=(e[4]+n-t[1])*i[1];if(o=Math.max(o,Math.min(f,s)),c=Math.min(c,Math.max(f,s)),o>c)return!1;var l=(e[2]-n-t[2])*i[2],v=(e[5]+n-t[2])*i[2];return o=Math.max(o,Math.min(l,v)),c=Math.min(c,Math.max(l,v)),o<=c}function I(e,t,i){return f.vec4.set(i,e[0]-t[0],e[1]-t[1],e[2]-t[2],1)}function O(e,t,i,r){return n.mat4.translate(Y,i,t),i=Y,f.vec4.transformMat4(r,e,i)}function S(e,t,i,n){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n[2]=e[2]+i[2],n[3]=e[3],f.vec4.transformMat4(n,n,t)}function A(e,t){return f.vec4.scale(t,e,1/Math.abs(e[3]))}function U(e,t,i,n,r){return u.scale(e,n,i,r)}function L(e,t,n,r,a){var o=(n.screenLength||0)*e.pixelRatio;a&&(o=U(o,e,t,r,a));var c=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return i.clamp(c*t,n.minWorldLength||0,null!=n.maxWorldLength?n.maxWorldLength:1/0)}function B(e,t,i){if(void 0!==e)return t.acquire(e,i)}function T(e,t){void 0!==e&&t.release(e)}function w(e,t,i){n.mat4.translate(J,t,e),i.setUniform3fv("localOrigin",e),i.setUniformMatrix4fv("view",J)}function y(e,t,i){i.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])}function W(e,t){v.encodeDoubleArraySplit(e,K,Q,3),t.setUniform3fv("viewOriginHi",K),t.setUniform3fv("viewOriginLo",Q)}function D(e,t,i){o.vec3.subtract($,t.origin,e),i.setUniform3fv("slicePlaneOrigin",$),i.setUniform3fv("slicePlaneBasis1",t.basis1),i.setUniform3fv("slicePlaneBasis2",t.basis2)}function E(e,t,i){if(e){var n=V(e,t.fovY,t.viewport[3]),r=t.pixelRatio||1;i.setUniform4f("verticalOffset",n.screenLength*r,n.perDistance,n.minWorldLength,n.maxWorldLength)}}function N(e,t,i){e.bindTexture(t.highlightDepthTexture,5),i.setUniform1i("depthTex",5),i.setUniform4f("highlightViewportPixelSz",0,0,1/t.viewport[2],1/t.viewport[3])}function V(e,t,i,n){return void 0===n&&(n=te),n.screenLength=e.screenLength,n.perDistance=Math.tan(.5*t)/(.5*i),n.minWorldLength=e.minWorldLength,n.maxWorldLength=e.maxWorldLength,n}function C(e,t,i){if(void 0===i&&(i="screenSizePerspectiveAlignment"),e){var n=e.parameters,r=e.paddingPixelsOverride;t.setUniform4f(i,n.divisor,n.offset,n.minPixelSize,r)}}function z(e,t){var i=t?z(t):{};for(var n in e){var r=e[n];r&&r.forEach&&(r=H(r)),null==r&&n in i||(i[n]=r)}return i}function R(e,t){var i=!1;for(var n in t){var r=t[n];void 0!==r&&(i=!0,Array.isArray(r)?e[n]=r.slice():e[n]=r)}return i}function q(e,t,n,r,a,o,c,f,s){if(r.enable.selectionMode){for(var l=e.getAttribute(j.POSITION).data,v=e.getAttribute(j.SIZE),u=v&&v.data[0],m=o[0],d=o[1],g=u+c,h=(g/2+4)*e.pixelRatio,p=Number.MAX_VALUE,b=0;b<l.length-5;b+=3){var x=l[b],M=l[b+1],P=l[b+3],I=l[b+4],O=m-x,S=d-M,A=P-x,U=I-M,L=A*O+U*S,B=A*A+U*U,T=i.clamp(L/B,0,1),w=A*T-O,y=U*T-S,W=w*w+y*y;W<p&&(p=W)}p<h*h&&f()}}function H(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}Object.defineProperty(t,"__esModule",{value:!0});var Y=a.mat4f64.create(),_=s.create(),j=m.VertexAttrConstants;t.IDENTITY=a.mat4f64.create(),t.intersectTriangleGeometry=d;var G=c.vec3f64.create(),k=Math.pow(2,-52),X=c.vec3f64.create();t.intersectTriangles=p;var Z=c.vec3f64.create(),F=c.vec3f64.create();t.computeNormal=x,t.intersectAabbInvDir=P,t.transformToWorld=I,t.transformToView=O,t.transformToProjection=S,t.transformToNDC=A,t.applyScreenSizePerspectiveScale=U,t.verticalOffsetAtDistance=L,t.acquireIfNotUndefined=B,t.releaseIfNotUndefined=T;var J=r.mat4f32.create();t.bindView=w,t.bindCamPos=y;var K=c.vec3f64.create(),Q=c.vec3f64.create();t.bindViewOriginDouble=W;var $=c.vec3f64.create();t.bindSlicePlane=D,t.bindVerticalOffset=E,t.bindHighlightRendering=N,t.bindScreenSizePerspective=C,t.copyParameters=z,t.updateParameters=R;!function(e){function t(e,t){for(var i=[],n=0;n<2;n++)for(var a=0;a<2;a++){var o=r({shadowMappingEnabled:1===n,ssaoEnabled:1===a}),c=r({shadowMappingEnabled:1===n,ssaoEnabled:1===a&&e.receiveSSAO});i[o]=i[c]||t({receiveShadows:1===n,receiveSSAO:1===a&&e.receiveSSAO})}return{programs:i.filter(function(e){return null!=e}),byParameter:i}}function i(e,t){return e.byParameter[r(t)]}function n(e){return e.programs}function r(e){return(e.shadowMappingEnabled?1:0)|(e.ssaoEnabled?2:0)}e.create=t,e.lookup=i,e.programs=n}(t.BindParametersMap||(t.BindParametersMap={})),t.intersectDrapedRenderLineGeometry=q,t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ee=1e3,te={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});