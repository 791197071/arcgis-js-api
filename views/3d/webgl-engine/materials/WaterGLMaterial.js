// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../lib/GLMaterial","./internal/MaterialUtil","./internal/waterMaterialUtils","../shaders/WaterSurfacePrograms","../../../webgl/renderState"],function(t,e,r,i,a,o,n,s){Object.defineProperty(e,"__esModule",{value:!0});var p=function(t){function e(e){var r=t.call(this,e)||this;return r.updateParameters(),r}return r(e,t),e.prototype.updateParameters=function(){this.params=a.copyParameters(this.material.getParameters()),this.selectProgram()},e.prototype._selectPipelineState=function(){this.pipelineState=s.makePipelineState({blending:this.params.transparent&&s.separateBlendingParams(770,1,771,771),depthTest:{func:513},depthWrite:this.params.writeDepth&&s.defaultDepthWriteParams,colorWrite:s.defaultColorWriteParams})},e.prototype.getProgramTemplate=function(){return n.color},e.prototype.selectProgram=function(){this.program=this.programRep.getProgram(this.getProgramTemplate(),{slice:this.params.slicePlaneEnabled,receiveShadows:this.params.receiveShadows}),this._selectPipelineState()},e.prototype.beginSlot=function(t){var e=5;return this.params.transparent&&(e=this.params.writeDepth?7:10),t===e},e.prototype.getProgram=function(){return this.program},e.prototype._initTextures=function(t){this.texturePaths=[this.params.waveTexture,this.params.perturbationTexture],o.waterTextureRepo.initialize(t,this.texturePaths)},e.prototype._bindUniforms=function(t,e){t.bindProgram(this.program),t.setPipelineState(this.pipelineState),o.waterTextureRepo.bindRepo(t),this.program.setUniform4fv("waterColor",this.params.color),this._setWaveUniforms(this.program)},e.prototype._setWaveUniforms=function(t){t.setUniform1i("texWaveNormal",0),t.setUniform1i("texWavePerturbation",1),t.setUniform4f("waveParams",this.params.waveStrength,this.params.waveTextureRepeat,this.params.flowStrength,this.params.flowOffset),t.setUniform2f("waveDirection",this.params.waveDirection[0]*this.params.waveVelocity,this.params.waveDirection[1]*this.params.waveVelocity);var e=.001*this.material.animation.time;t.setUniform1f("timeElapsed",e*this.params.animationSpeed)},e.prototype._updateShadowState=function(t){t.shadowMappingEnabled!==this.params.receiveShadows&&(this.material.setParameterValues({receiveShadows:t.shadowMappingEnabled}),this.updateParameters())},e.prototype.bind=function(t,e){if(!o.waterTextureRepo.ready())return void(o.waterTextureRepo.loading()||this._initTextures(t));this._updateShadowState(e),this._bindUniforms(t,e)},e.prototype.release=function(t){},e.prototype.bindView=function(t,e){var r=this.program;r.setUniform3fv("localOrigin",e.origin),a.bindView(e.origin,e.view,r),a.bindCamPos(e.origin,e.viewInvTransp,r),this.params.slicePlaneEnabled&&a.bindSlicePlane(e.origin,e.slicePlane,r),e.shadowMappingEnabled&&(e.shadowMap.bind(r),e.shadowMap.bindView(r,e.origin))},e.prototype.bindInstance=function(t,e){this.program.setUniformMatrix4fv("model",e.transformation)},e.prototype.getDrawMode=function(){return 4},e}(i);e.WaterGLMaterial=p;var l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.bind=function(t,e){t.bindProgram(this.program),t.setPipelineState(this.pipelineState),this.program.setUniform4fv("waterColor",this.params.color)},e.prototype.bindView=function(t,e){this.program.setUniform3fv("localOrigin",e.origin),a.bindView(e.origin,e.view,this.program)},e.prototype.beginSlot=function(t){return null==t},e.prototype.getProgramTemplate=function(){return n.drapedColor},e}(p);e.WaterDrapedGLMaterial=l;var m=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.bind=function(t,e){if(!o.waterTextureRepo.ready())return void(o.waterTextureRepo.loading()||this._initTextures(t));t.bindProgram(this.program),t.setPipelineState(this.pipelineState),o.waterTextureRepo.bindRepo(t),this._setWaveUniforms(this.program)},e.prototype.bindView=function(t,e){this.program.setUniform3fv("localOrigin",e.origin),a.bindView(e.origin,e.view,this.program)},e.prototype.beginSlot=function(t){return 20===t},e.prototype._selectPipelineState=function(){this.pipelineState=s.makePipelineState({depthTest:{func:513},depthWrite:this.params.writeDepth&&s.defaultDepthWriteParams,colorWrite:s.defaultColorWriteParams})},e.prototype.getProgramTemplate=function(){return n.drapedNormal},e}(p);e.WaterNormalGLMaterial=m});