// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/tsSupport/decorateHelper","../../lib/AutoDisposable","../../lib/DefaultTextureUnits","../../lib/GLMaterial","./Parameters","../internal/MaterialUtil","../internal/MaterialUtil","../internal/TextureBinding","../../shaders/DefaultPrograms","../../../../webgl/renderState"],function(e,t,r,a,o,i,n,s,l,m,p,c,u){function h(e){if(e.hasTransparency)return u.separateBlendingParams(770,1,771,771)}function d(e){return"none"!==e.parameters.cullFace}function f(e){if(d(e))return{face:"front"===e.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(t,"__esModule",{value:!0});var g=function(e){function t(t,r,a,o){var n=e.call(this,r,a)||this;n._passName=t,n.material=r;var s=r.parameters;return n._baseColorTexture=new p.TextureBinding(o,s.baseColorTexture,{textureUniform:"tex",textureSizeUniform:"texSize",textureUnit:i.DefaultTextureUnits.DIFFUSE}),n.createPrograms(),n.selectPipeline(),n.selectSlot(),n}return r(t,e),t.prototype.createPrograms=function(){var e=this;this.programs=l.BindParametersMap.create(this.material.parameters,function(t){return e._createProgram(t)})},t.prototype._createProgram=function(e){var t=this.material.parameters,r=this.material.geometryParameters,a=t.baseColorTexture?r.textureCoordinateRegions?"AtlasTextured":"Textured":"none",o="screen-space"===t.normals||"screen-space"===r.normals||"none"===r.normals?"screenDerivative":"compressed"===r.normals?"compressed":"default";return"color"===this._passName?this.programRep.getProgram(c.colorPass,{textureMode:a,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,doubleSided:t.doubleSidedShading,groundNormalShading:"ground"===t.normals,normals:o,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO}):"depth"===this._passName||"depthShadowMap"===this._passName?this.programRep.getProgram(c.depthPass,{textureMode:a,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:o,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this._passName,slice:t.slicePlaneEnabled}):"normal"===this._passName?this.programRep.getProgram(c.normalPass,{textureMode:a,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:o,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):"highlight"===this._passName?this.programRep.getProgram(c.highlightPass,{textureMode:a,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:o,componentColor:r.componentData&&!s.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):void 0},t.prototype.selectPipeline=function(){var e=this.material.parameters;"color"===this._passName?this.pipelineState=u.makePipelineState({blending:h(this.material),culling:f(this.material),polygonOffset:e.polygonOffsetEnabled&&D,stencilTest:e.writeStencil&&{function:{func:e.readStencil?517:519,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:e.writeStencil&&{mask:255},depthTest:{func:513},depthWrite:u.defaultDepthWriteParams,colorWrite:u.defaultColorWriteParams}):this.pipelineState=u.makePipelineState({culling:f(this.material),polygonOffset:e.polygonOffsetEnabled&&D,depthTest:{func:513},depthWrite:u.defaultDepthWriteParams,colorWrite:u.defaultColorWriteParams})},t.prototype.selectSlot=function(){this.slot=this.material.hasTransparency?7:this.material.parameters.readStencil?3:this.material.parameters.writeStencil?2:5},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program||this.getPrograms()[0]},t.prototype.getPrograms=function(){return l.BindParametersMap.programs(this.programs)},t.prototype.updateParameters=function(){var e=this.material.parameters;this._baseColorTexture.update(e.baseColorTexture),this.createPrograms(),this.selectPipeline(),this.selectSlot()},t.prototype.bind=function(e,t){var r=this.material.parameters,a=this.program=l.BindParametersMap.lookup(this.programs,t);e.bindProgram(a),e.setPipelineState(this.pipelineState),a.setUniform3fv("ambient",r.baseColor),a.setUniform3fv("diffuse",r.baseColor),a.setUniform3fv("specular",S),a.setUniform1f("opacity",r.baseColorOpacity),a.setUniform1f("layerOpacity",r.layerOpacity),s.isUniformComponentData(r.componentData)?(a.setUniform4fv("externalColor",r.componentData.externalColor),a.setUniform1i("colorMixMode",m.colorMixModes[r.componentData.externalColorMixMode])):(a.setUniform4fv("externalColor",M),a.setUniform1i("colorMixMode",m.colorMixModes.multiply),this.material.geometryParameters.componentData&&(r.componentData.updateTexture(),r.componentData.bind(a,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:i.DefaultTextureUnits.COMPONENT_COLOR}))),this._baseColorTexture.bind(e,a),a.setUniform1f("textureAlphaCutoff",.1),"depth"!==this._passName&&"depthShadowMap"!==this._passName||a.setUniform2fv("nearFar",t.nearFar),"highlight"===this._passName&&m.bindHighlightRendering(e,t,a)},t.prototype.bindView=function(e,t){var r=this.material.parameters,a=this.program=l.BindParametersMap.lookup(this.programs,t),o=t.origin;m.bindView(o,t.view,a),m.bindCamPos(o,t.viewInvTransp,a),r.slicePlaneEnabled&&m.bindSlicePlane(o,t.slicePlane,a),"color"===this._passName&&t.shadowMappingEnabled&&t.shadowMap.bindView(a,o),"normal"===this._passName&&a.setUniformMatrix4fv("viewNormal",t.viewInvTransp)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},a([o.autoDispose()],t.prototype,"_baseColorTexture",void 0),t}(n),x=function(e){function t(t,r,a){var o=e.call(this,"color",t,r,a)||this;return o.material=t,o}return r(t,e),t}(g);t.GLMaterialColor=x;var v=function(e){function t(t,r,a){var o=e.call(this,"depth",t,r,a)||this;return o.material=t,o}return r(t,e),t}(g);t.GLMaterialDepth=v;var P=function(e){function t(t,r,a){var o=e.call(this,"depthShadowMap",t,r,a)||this;return o.material=t,o}return r(t,e),t}(g);t.GLMaterialDepthShadowMap=P;var b=function(e){function t(t,r,a){var o=e.call(this,"normal",t,r,a)||this;return o.material=t,o}return r(t,e),t}(g);t.GLMaterialNormal=b;var C=function(e){function t(t,r,a){var o=e.call(this,"highlight",t,r,a)||this;return o.material=t,o}return r(t,e),t}(g);t.GLMaterialHighlight=C;var M=[1,1,1,1],S=[0,0,0],D={factor:2,units:2}});