// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/extendsHelper","../../../../../core/tsSupport/decorateHelper","../../lib/AutoDisposable","../../lib/DefaultTextureUnits","../../lib/GLMaterial","./Parameters","../internal/MaterialUtil","../internal/MaterialUtil","../internal/TextureBinding","../../shaders/DefaultPrograms","../../../../webgl/renderState"],function(e,t,r,a,o,i,s,n,l,u,m,p,c,d){function h(e){if(e.hasTransparency)return d.separateBlendingParams(770,1,771,771)}function x(e){return"none"!==e.parameters.cullFace}function f(e){if(x(e))return{face:"front"===e.parameters.cullFace?1028:1029,mode:2305}}Object.defineProperty(t,"__esModule",{value:!0});var g=function(e){function t(t){var r=e.call(this,t)||this;r.discardTransparentVertices=!1,r.material=t.material,r.passName=t.passName;var a=r.material.parameters;return r._baseColorTexture=new p.TextureBinding(t.textureRep,a.baseColorTexture,{textureUniform:"tex",textureUnit:s.DefaultTextureUnits.DIFFUSE}),r._metallicRoughnessTexture=new p.TextureBinding(t.textureRep,a.metallicRoughnessTexture,{textureUniform:"texMetallicRoughness",textureUnit:s.DefaultTextureUnits.METALLIC_ROUGHNESS}),r._normalTexture=new p.TextureBinding(t.textureRep,a.normalTexture,{textureUniform:"texNormal",textureUnit:s.DefaultTextureUnits.NORMAL}),r._emissiveTexture=new p.TextureBinding(t.textureRep,a.emissiveTexture,{textureUniform:"texEmission",textureUnit:s.DefaultTextureUnits.EMISSION}),r._occlusionTexture=new p.TextureBinding(t.textureRep,a.occlusionTexture,{textureUniform:"texOcclusion",textureUnit:s.DefaultTextureUnits.OCCLUSION}),r.createPrograms(),r.selectPipeline(),r}return a(t,e),Object.defineProperty(t.prototype,"requiresVertexTransparencyDiscards",{get:function(){var e=this.material.parameters.componentData;return!l.isUniformComponentData(e)&&("color"===this.passName&&this.material.hasTransparency&&this.material.parameters.useVertexTransparencyDiscards)},enumerable:!0,configurable:!0}),t.prototype.createPrograms=function(){var e=this;this.programs=u.BindParametersMap.create(this.material.parameters,function(t){return e._createProgram(t)})},t.prototype._createProgram=function(e){var t=this.material.parameters,r=this.material.geometryParameters,a="screen-space"===t.normals||"screen-space"===r.normals||"none"===r.normals?"screenDerivative":"compressed"===r.normals?"compressed":"default";return"color"===this.passName?this.programRep.getProgram(c.colorPass,{textureAtlas:!!r.textureCoordinateRegions,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,doubleSided:t.doubleSidedShading,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!l.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled,receiveShadows:e.receiveShadows,receiveSSAO:e.receiveSSAO,usePBR:t.usePBR,roughnessMetallnessTexture:!!t.metallicRoughnessTexture,emissionTexture:!!t.emissiveTexture,normalTexture:!!t.normalTexture,occlusionTexture:!!t.occlusionTexture,vertexTransparencyDiscardEnabled:this.requiresVertexTransparencyDiscards}):"depth"===this.passName||"depthShadowMap"===this.passName?this.programRep.getProgram(c.depthPass,{textureAtlas:!!r.textureCoordinateRegions,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!l.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",shadowMap:"depthShadowMap"===this.passName,slice:t.slicePlaneEnabled}):"normal"===this.passName?this.programRep.getProgram(c.normalPass,{textureAtlas:!!r.textureCoordinateRegions,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!l.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):"highlight"===this.passName?this.programRep.getProgram(c.highlightPass,{textureAtlas:!!r.textureCoordinateRegions,colorTexture:!!t.baseColorTexture,vertexColors:r.colors,groundNormalShading:"ground"===t.normals,normals:a,componentColor:r.componentData&&!l.isUniformComponentData(t.componentData),textureAlphaMode:"maskBlend",slice:t.slicePlaneEnabled}):void 0},t.prototype.selectPipeline=function(){var e=this.material.parameters;"color"===this.passName?this.pipelineState=d.makePipelineState({blending:h(this.material),culling:f(this.material),polygonOffset:e.polygonOffsetEnabled&&U,stencilTest:e.writeStencil&&{function:{func:e.readStencil?517:519,ref:1,mask:255},operation:{fail:7680,zFail:7680,zPass:7681}},stencilWrite:e.writeStencil&&{mask:255},depthTest:{func:513},depthWrite:d.defaultDepthWriteParams,colorWrite:d.defaultColorWriteParams}):this.pipelineState=d.makePipelineState({culling:f(this.material),polygonOffset:e.polygonOffsetEnabled&&U,depthTest:{func:513},depthWrite:d.defaultDepthWriteParams,colorWrite:d.defaultColorWriteParams})},t.prototype.beginSlot=function(e){return this.requiresVertexTransparencyDiscards?(this.discardTransparentVertices=5===e,7===e||5===e):this.material.hasTransparency?7===e:e===(this.material.parameters.readStencil?3:this.material.parameters.writeStencil?2:5)},t.prototype.getProgram=function(){return this.program||this.getPrograms()[0]},t.prototype.getPrograms=function(){return u.BindParametersMap.programs(this.programs)},t.prototype.updateParameters=function(){var e=this.material.parameters;this._baseColorTexture.update(e.baseColorTexture),this.createPrograms(),this.selectPipeline()},t.prototype.bind=function(e,t){var r=this.material.parameters,a=this.material.geometryParameters,o=this.program=u.BindParametersMap.lookup(this.programs,t);e.bindProgram(o),e.setPipelineState(this.pipelineState),o.setUniform3fv("ambient",r.baseColor),o.setUniform3fv("diffuse",r.baseColor),o.setUniform3fv("specular",D),r.usePBR&&(o.setUniform1f("metalnessFactor",r.metallicFactor),o.setUniform1f("roughnessFactor",r.roughnessFactor),o.setUniform3fv("emissionFactor",r.emissiveFactor),o.setUniform1f("reflectanceFactor",r.reflectanceFactor)),o.setUniform1f("opacity",r.baseColorOpacity),o.setUniform1f("layerOpacity",r.layerOpacity),this.requiresVertexTransparencyDiscards&&o.setUniform1f("discardTransparentVertices",this.discardTransparentVertices?1:0),l.isUniformComponentData(r.componentData)?(o.setUniform4fv("externalColor",r.componentData.externalColor),o.setUniform1i("colorMixMode",m.colorMixModes[r.componentData.externalColorMixMode])):(o.setUniform4fv("externalColor",S),o.setUniform1i("colorMixMode",m.colorMixModes.multiply),a.componentData&&(r.componentData.textureBuffer.updateTexture(),r.componentData.textureBuffer.bind(o,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:s.DefaultTextureUnits.COMPONENT_COLOR}))),this._baseColorTexture.bind(e,o),o.setUniform1f("textureAlphaCutoff",.1),this._metallicRoughnessTexture.bind(e,o),this._normalTexture.bind(e,o),this._emissiveTexture.bind(e,o),this._occlusionTexture.bind(e,o),a.textureCoordinateRegions&&(this._baseColorTexture.isValid()?this._baseColorTexture.bindSize("atlasSize",o):this._metallicRoughnessTexture.isValid()?this._metallicRoughnessTexture.bindSize("atlasSize",o):this._normalTexture.isValid()?this._normalTexture.bindSize("atlasSize",o):this._emissiveTexture.isValid()?this._emissiveTexture.bindSize("atlasSize",o):this._occlusionTexture.isValid()&&this._occlusionTexture.bindSize("atlasSize",o)),"depth"!==this.passName&&"depthShadowMap"!==this.passName||o.setUniform2fv("nearFar",t.nearFar),"highlight"===this.passName&&m.bindHighlightRendering(e,t,o)},t.prototype.bindView=function(e,t){var r=this.material.parameters,a=this.program=u.BindParametersMap.lookup(this.programs,t),o=t.origin;m.bindView(o,t.view,a),m.bindCamPos(o,t.viewInvTransp,a),r.slicePlaneEnabled&&m.bindSlicePlane(o,t.slicePlane,a),"color"===this.passName&&t.shadowMappingEnabled&&t.shadowMap.bindView(a,o),"normal"===this.passName&&a.setUniformMatrix4fv("viewNormal",t.viewInvTransp)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},o([i.autoDispose()],t.prototype,"_baseColorTexture",void 0),o([i.autoDispose()],t.prototype,"_metallicRoughnessTexture",void 0),o([i.autoDispose()],t.prototype,"_normalTexture",void 0),o([i.autoDispose()],t.prototype,"_emissiveTexture",void 0),o([i.autoDispose()],t.prototype,"_occlusionTexture",void 0),t}(n),T=function(e){function t(t){return e.call(this,r({passName:"color"},t))||this}return a(t,e),t}(g);t.GLMaterialColor=T;var v=function(e){function t(t){return e.call(this,r({passName:"depth"},t))||this}return a(t,e),t}(g);t.GLMaterialDepth=v;var b=function(e){function t(t){return e.call(this,r({passName:"depthShadowMap"},t))||this}return a(t,e),t}(g);t.GLMaterialDepthShadowMap=b;var C=function(e){function t(t){return e.call(this,r({passName:"normal"},t))||this}return a(t,e),t}(g);t.GLMaterialNormal=C;var P=function(e){function t(t){return e.call(this,r({passName:"highlight"},t))||this}return a(t,e),t}(g);t.GLMaterialHighlight=P;var S=[1,1,1,1],D=[0,0,0],U={factor:2,units:2}});