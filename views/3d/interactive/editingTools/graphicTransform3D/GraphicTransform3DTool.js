// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/unitUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/math/common","../../../../../geometry/Point","../../../../../layers/graphics/dehydratedFeatures","./graphicTransform3DToolConfig","./isSupportedGraphic","../../../support/geometryUtils","../../../support/mathUtils","../../../support/projectionUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/InteractiveToolBase","../../../../interactive/Manipulator3D","../../../../interactive/manipulatorUtils"],function(t,e,a,r,i,n,o,s,c,l,u,p,h,g,m,d,f,v,_,y,D,S,T,R,I,M,A,b,E,w,N,O,P,F,C,k){function G(t){var e=new N(O.createCylinderGeometry(I.DISC_HEIGHT,1,I.GEOMETRY_SEGMENTS,D.vec3f64.fromValues(0,0,1),D.vec3f64.fromValues(0,0,0)),"graphic-transform-disc"),a=W(),r=W(.5),i=v.mat4.fromScaling(_.mat4f64.create(),D.vec3f64.fromValues(I.DISC_RADIUS,I.DISC_RADIUS,I.DISC_RADIUS)),n=new C.Manipulator3D({view:t,renderObjects:[{geometry:e,material:a,stateMask:nt.RingUnfocused|nt.ArrowUnfocused,transform:i},{geometry:e,material:r,transform:i}],autoScaleRenderObjects:!1,radius:I.DISC_COLLISION_RADIUS,focusMultiplier:1,touchMultiplier:1,snapToPointer:!1,alignment:"on-the-ground",collisionType:{type:"disc",direction:D.vec3f64.fromValues(0,0,1)}});return n.visible=!1,n}function U(t){for(var e=function(t,e,a){for(var r=[],i=Math.ceil(I.GEOMETRY_SEGMENTS*(e-t)/(2*Math.PI)),n=0;n<i+1;n++){var o=t+n*(e-t)/i;r.push(D.vec3f64.fromValues(a*Math.cos(o),a*Math.sin(o),0))}return r},a=function(t){return e(0,2*Math.PI,t)},r=function(t){return[[-t/2,0],[t/2,0],[t/2,I.RING_HEIGHT/2],[-t/2,I.RING_HEIGHT/2]]},i=function(t,e){return new N(O.createPathExtrusionGeometry(r(e),t,[],[],!1),"graphic-transform-ring")},n=a(I.RING_RADIUS),o=i(n,I.RING_THICKNESS),s={left:[],right:[]},c=[],l=0;l<2;l++){var u=l*Math.PI-Math.PI/4,p=Math.PI/2-I.ROTATE_INDICATOR_ARC_LENGTH,h=u+p,g=u+Math.PI/2-p,m=e(h,g,I.INNER_INDICATOR_RADIUS),d=i(m,I.INDICATOR_THICKNESS);c.push(m),s.left.push(d),s.right.push(d);for(var f=0;f<2;f++){var y=0===f,S=_.mat4f64.create();if(y){v.mat4.scale(S,S,[1,-1,1]),v.mat4.rotate(S,S,-h,[0,0,1]);var T=Math.round(I.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(m.length-1));S[12]=m[T][0],S[13]=m[T][1],S[14]=m[T][2]}else{v.mat4.rotate(S,S,g,[0,0,1]);var T=Math.round((1-I.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(m.length-1));S[12]=m[T][0],S[13]=m[T][1],S[14]=m[T][2]}var R=O.createExtrudedTriangle(I.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,I.ROTATE_INDICATOR_ARROW_TIP_RADIUS,I.RING_HEIGHT);O.transformInPlace(R,S);var M=new N(R,"graphic-transform-ring-rotate");(y?s.left:s.right).push(M)}}for(var A=[],l=0;l<2;l++){var u=l*Math.PI-Math.PI/4,p=Math.PI/2-I.SCALE_INDICATOR_ARC_LENGTH,h=u+p,g=u+Math.PI/2-p,m=e(h,g,I.OUTER_INDICATOR_RADIUS);A.push(i(m,I.INDICATOR_THICKNESS))}var b=a(I.RING_RADIUS+I.SCALE_INDICATOR_OFFSET1),E=a(I.RING_RADIUS+I.SCALE_INDICATOR_OFFSET2),w=i(b,I.INDICATOR_THICKNESS),P=i(E,I.INDICATOR_THICKNESS),F=a(I.RING_RADIUS-I.SCALE_INDICATOR_OFFSET1),k=a(I.RING_RADIUS-I.SCALE_INDICATOR_OFFSET2),G=i(F,I.INDICATOR_THICKNESS),U=i(k,I.INDICATOR_THICKNESS),H=W(),L=W(.66),x=W(.5),j=W(.33),V=[{geometry:o,material:H,stateMask:nt.DiscUnfocused|nt.ArrowUnfocused},{geometry:o,material:x},{geometry:A,material:H,stateMask:nt.Unlocked|nt.RingFocused},{geometry:w,material:L,stateMask:2|nt.ScaleIn},{geometry:P,material:j,stateMask:2|nt.ScaleIn},{geometry:G,material:L,stateMask:2|nt.ScaleOut},{geometry:U,material:j,stateMask:2|nt.ScaleOut},{geometry:s.left,material:H,stateMask:nt.Unlocked|nt.RingFocused},{geometry:s.left,material:H,stateMask:2|nt.RotateLeft},{geometry:s.right,material:H,stateMask:2|nt.RotateRight}],z=[n].concat(c);return new C.Manipulator3D({view:t,renderObjects:V,autoScaleRenderObjects:!1,radius:I.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,moveOnDrag:!1,alignment:"on-the-ground",collisionType:{type:"ribbon",paths:z,direction:D.vec3f64.fromValues(0,0,1)}})}function H(t){var e=Math.sqrt(I.DISC_TRANSLATE_ARROW_SIZE*I.DISC_TRANSLATE_ARROW_SIZE*3/4),a=O.createExtrudedTriangle(e,I.DISC_TRANSLATE_ARROW_SIZE/2,I.DISC_TRANSLATE_ARROW_SIZE/2,I.DISC_HEIGHT);O.transformInPlace(a,v.mat4.fromTranslation(w.sm4d.get(),y.vec3.set(w.sv3d.get(),0,-e/3,0)));var r=new N(a,"graphic-transform-disc-arrow"),i=W(),n=W(.5),o=new C.Manipulator3D({view:t,renderObjects:[{geometry:r,material:n,stateMask:1|nt.DiscFocused},{geometry:r,material:n,stateMask:1|nt.ArrowFocused},{geometry:r,material:i,stateMask:nt.TouchInput|nt.ArrowUnfocused|nt.DiscUnfocused|nt.RingUnfocused},{geometry:r,material:i,stateMask:2}],autoScaleRenderObjects:!1,radius:e,focusMultiplier:1,touchMultiplier:1,snapToPointer:!1,alignment:"on-the-ground",collisionType:{type:"disc",direction:D.vec3f64.fromValues(0,0,1)}});return o.visible=!1,o}function L(t,e){var a=this,r=t.allLayerViews.find(function(t){return t.layer===e.layer}),o=e.symbol;return p.all(o.symbolLayers.map(function(t){return n(a,void 0,void 0,function(){var e,a,n;return i(this,function(i){switch(i.label){case 0:e=null,a=null,"object"===t.type&&(e=t.heading),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,r.whenSymbolLayerSize(o,t)];case 2:return a=i.sent(),[3,4];case 3:return n=i.sent(),a=null,[3,4];case 4:return[2,{heading:e,size:a}]}})})}).toArray()).then(function(t){return{symbolLayers:t}})}function x(t){var e=t.symbol,a=e.symbolLayers.find(function(t){return"object"===t.type});return a&&a.heading||0}function j(t,e,a,r){t.symbolLayers.forEach(function(t,i){var n=e.symbolLayers[i],o=n.heading,s=n.size;"object"===t.type&&(t.heading=(u.isSome(o)?o:0)-S.toDegree(a),u.isSome(s)&&"width"in s&&(t.width=s.width*r,t.depth=s.depth*r,t.height=s.height*r))})}function V(t){var e=y.vec3.subtract(w.sv3d.get(),t.startPoint,t.origin),a=y.vec3.subtract(w.sv3d.get(),t.endPoint,t.origin),r=y.vec3.length(e),i=y.vec3.length(a);return 0===r?0:i/r}function z(t,e){var a=t.origin,r=t.startPoint,i=t.endPoint,n=t.plane,o=K(r,e,w.sv3d.get()),s=K(i,e,w.sv3d.get());if(y.vec3.squaredDistance(o,s)<I.DRAG_THRESHOLD_PX*I.DRAG_THRESHOLD_PX)return null;var c=y.vec3.subtract(w.sv3d.get(),r,a),l=y.vec3.cross(w.sv3d.get(),c,n),u=r,p=y.vec3.add(w.sv3d.get(),u,l),h=K(a,e,w.sv3d.get()),g=o,m=K(p,e,w.sv3d.get()),d=y.vec3.subtract(w.sv3d.get(),m,g),f=y.vec3.subtract(w.sv3d.get(),o,h),v=A.ray.wrap(g,d),_=A.ray.wrap(h,f);return A.ray.distance2(v,s)<A.ray.distance2(_,s)?"rotate":"scale"}function W(t){void 0===t&&(t=1);var e=I.HANDLE_COLOR.concat([t]),a=new P({color:e,transparent:1!==t,cullFace:"back"},"graphic-transform");return a.renderOccluded=2,a}function K(t,e,a){var r=e.projectPoint(t,g.castRenderScreenPointArray(ot)),i=e.renderToScreen(r,st);return y.vec3.set(a,i[0],i[1],0)}function B(t,e){var a=t.longitude,r=e.longitude;if(null==a||null==r)return!1;var i=b.cyclicalDeg.shortestSignedDiff(a,r);return Math.abs(i)<90}function Z(t){return"local"===t.viewingMode||t.scale<I.ALIGN_ARROWS_SCALE_THRESHOLD}Object.defineProperty(e,"__esModule",{value:!0});var q=c.getLogger("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransform3DTool"),Y=function(){function t(t){this.graphic=t}return t}();e.GraphicTranslateStartEvent=Y;var X=function(){function t(t){this.graphic=t}return t}();e.GraphicTranslateStopEvent=X;var J=function(){function t(t){this.graphic=t}return t}();e.GraphicRotateStartEvent=J;var Q=function(){function t(t){this.graphic=t}return t}();e.GraphicRotateStopEvent=Q;var $=function(){function t(t){this.graphic=t}return t}();e.GraphicScaleStartEvent=$;var tt=function(){function t(t){this.graphic=t}return t}();e.GraphicScaleStopEvent=tt;var et=function(){function t(t,e,a){this.graphic=t,this.dx=e,this.dy=a,this.type="translate"}return t}();e.GraphicTranslateEvent=et;var at=function(){function t(t,e){this.graphic=t,this.angle=e,this.type="rotate"}return t}();e.GraphicRotateEvent=at;var rt=function(){function t(t,e){this.graphic=t,this.scale=e,this.type="scale"}return t}();e.GraphicScaleEvent=rt;var it=function(t){function e(e){var a=t.call(this,e)||this;return a.enableRotation=!0,a.enableScaling=!0,a.discManipulator=null,a.ringManipulator=null,a.arrowManipulators=null,a.type="transform-3d",a._handles=new s,a._arrowDragData=null,a._ringDragData=null,a._startSymbolDataPromise=null,a._startSymbolData=null,a._ringDelayedFocusFrameTask=null,a._ringManipulatorHasDelayedFocused=!1,a._scaleAnimationFrameTask=null,a._lastPointerEventType=null,a}return r(e,t),e.prototype.destroy=function(){this._removeFrameTasks(),this.graphic=null,this._handles.destroy(),this._handles=null,this._set("view",null)},Object.defineProperty(e.prototype,"graphic",{set:function(t){if(u.isSome(t)&&!M.isSupportedGraphic(t))return void q.error("Only graphics from a graphics layer with point geometries and object symbology are supported");this._set("graphic",t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_ringMode",{get:function(){return u.isSome(this._ringDragData)&&this._ringDragData.mode||this._ringModeFromOptions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_ringModeFromOptions",{get:function(){var t=this._shouldAllowModeType("scale"),e=this._shouldAllowModeType("rotate");return t||e?e?t?null:{type:"rotate",startAngle:0}:{type:"scale"}:{type:"disabled"}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_manipulatorState",{get:function(){var t=this._ringMode,e="touch"===this._lastPointerEventType?nt.TouchInput:0;return u.isNone(t)?e|=nt.Unlocked:"rotate"===t.type?e|=u.isSome(this._ringDragData)&&this._ringDragData.angleDir<0?nt.RotateLeft:nt.RotateRight:e|=u.isSome(this._ringDragData)&&this._ringDragData.scaleDir<0?nt.ScaleIn:nt.ScaleOut,e|=this.discManipulator.focused?nt.DiscFocused:nt.DiscUnfocused,e|=this._ringManipulatorHasDelayedFocused?nt.RingFocused:nt.RingUnfocused,e|=this.arrowManipulators.some(function(t){return t.manipulator.focused})?nt.ArrowFocused:nt.ArrowUnfocused},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this.graphic=null},e.prototype.handleInputEvent=function(t){"pointer-move"!==t.type&&"pointer-down"!==t.type&&"pointer-up"!==t.type||t.pointerType!==this._lastPointerEventType&&(this._lastPointerEventType=t.pointerType,this._updateManipulators())},e.prototype.initialize=function(){for(var t=this,e=G(this.view),a=U(this.view),r=[],i=0;i<4;i++){var n=H(this.view),o=_.mat4f64.create();this._calculateArrowManipulatorTransform(i,o),r.push({manipulator:n,transform:o})}this.discManipulator=e,this.ringManipulator=a,this.arrowManipulators=r,this._handles.add([e.watch("grabbing",function(a){t._setSingleManipulatorInteractive(e,a)},!0),e.watch("dragging",function(e){u.isSome(t.graphic)&&(e?t.emit("graphic-translate-start",new Y(t.graphic)):t.emit("graphic-translate-stop",new X(t.graphic)))},!0),d.watch(e,"focused",function(){u.isNone(t._scaleAnimationFrameTask)&&t._updateManipulators()}),d.init(this,"graphic.geometry",function(){u.isSome(t.graphic)&&u.isSome(t.graphic.geometry)&&"point"===t.graphic.geometry.type&&(e.mapPoint=R.clonePoint(t.graphic.geometry,lt)),t._updateManipulators()},!0)]),r.forEach(function(e,a){var r=e.manipulator;r.on("drag",function(e){t._handleArrowDrag(a)}),t._handles.add([d.watch(r,"focused",function(){t._updateManipulators()}),d.watch(r,"grabbing",function(e){t._setSingleManipulatorInteractive(r,e)}),d.watch(r,"dragging",function(e){u.isNone(t.graphic)||(e?t.emit("graphic-translate-start",new Y(t.graphic)):(t._arrowDragData=null,t.emit("graphic-translate-stop",new X(t.graphic))))})])}),e.on("drag",function(a){if(!u.isNone(t.graphic)&&!u.isNone(t.graphic.geometry)&&"point"===t.graphic.geometry.type){var r=t.graphic.geometry.z,i=t.graphic.geometry,n=R.clonePoint(e.mapPoint,new T);n.z=r,t.graphic.geometry=n;var o=n.x-i.x,s=n.y-i.y;t.emit("graphic-translate",new et(t.graphic,o,s))}}),this._handles.add([a.watch("grabbing",function(e){t._setSingleManipulatorInteractive(a,e)},!0),a.watch("dragging",function(e){if(!1===e){var a=t._ringDragData;if(t._ringDragData=null,t._startSymbolDataPromise=null,t._startSymbolData=null,u.isSome(a)){var r=a.mode;if(u.isNone(r)||u.isSome(r)&&"scale"===r.type){var i=V(a);t._startScaleResetAnimation(i)}else t._updateManipulators();if(u.isSome(t.graphic)&&u.isSome(a.mode))switch(a.mode.type){case"rotate":t.emit("graphic-rotate-stop",new Q(t.graphic));break;case"scale":t.emit("graphic-scale-stop",new tt(t.graphic))}}}else if(u.isSome(t.graphic)&&u.isSome(t._ringMode)&&"disabled"!==t._ringMode.type)switch(t._ringMode.type){case"rotate":t.emit("graphic-rotate-start",new J(t.graphic));break;case"scale":t.emit("graphic-scale-start",new $(t.graphic))}},!0),d.watch(a,"focused",function(){u.isNone(t._scaleAnimationFrameTask)&&t._startRingFocusFrameTask()})]),a.on("drag",function(e){t._handleRingDrag(e.screenPoint)}),this.manipulators.add(e),this.manipulators.add(a),r.forEach(function(e){var a=e.manipulator;return t.manipulators.add(a)})},e.prototype.onHide=function(){this._removeFrameTasks()},e.prototype._handleArrowDrag=function(t){if(!u.isNone(this.graphic)&&!u.isNone(this.graphic.geometry)&&"point"===this.graphic.geometry.type){var e=this.arrowManipulators[t].manipulator,a=this.graphic.geometry,r=this.graphic.geometry.spatialReference,i=e.mapPoint,n=E.vectorToPoint(y.vec3.set(w.sv3d.get(),i.x,i.y,i.z),i.spatialReference,r),o=y.vec3.subtract(w.sv3d.get(),e.position,this.discManipulator.position);e.position=this.discManipulator.position;if(!!B(a,n)){var s=1/m.getMetersPerUnitForSR(r)*1e-4;if(u.isNone(this._arrowDragData)){if(Z(this.view)){var c=this._calculateArrowManipulatorDirection(t,w.sv3d.get());A.vector.projectPoint(c,o,o);var l=y.vec3.add(o,o,this.discManipulator.position);if(!this.view.renderCoordsHelper.fromRenderCoords(l,n,r))return}else 0===t||2===t?n.x=a.x:n.y=a.y;var p=R.clonePoint(a,new T),h=n.x-a.x,g=n.y-a.y;if(Math.abs(h)>s||Math.abs(g)>s){var d=D.vec3f64.fromValues(h,g,0);y.vec3.normalize(d,d),this._arrowDragData={startPoint:p,dxDyMapConstrained:d}}}if(u.isSome(this._arrowDragData)){var f=this._arrowDragData,d=f.dxDyMapConstrained,p=f.startPoint;if(Math.abs(d[0])<s)n.x=p.x;else if(Math.abs(d[1])<s)n.y=p.y;else{var v=n.x-p.x,_=n.y-p.y,S=A.vector.projectPoint(d,y.vec3.set(w.sv3d.get(),v,_,0),w.sv3d.get());n.x=p.x+S[0],n.y=p.y+S[1]}var I=n.x-a.x,M=n.y-a.y;n.z=a.z,this.graphic.geometry=n,this.emit("graphic-translate",new et(this.graphic,I,M))}}}},e.prototype._handleRingDrag=function(t){var e=this,a=this.graphic;if(!u.isNone(a)&&!u.isNone(a.symbol)&&!u.isSome(this._startSymbolDataPromise)){var r=this._ringDragData,i=this._startSymbolData,n=g.screenPointObjectToArray(t,g.castScreenPointArray(w.sv2d.get())),o=A.ray.fromScreen(this.view.state.camera,n,ct),s=this.discManipulator.modelTransform;if(u.isNone(r)||u.isNone(i)){var c=D.vec3f64.fromValues(0,0,1);y.vec3.transformMat4(c,c,s);var p=D.vec3f64.clone(this.ringManipulator.position),h=A.plane.fromPositionAndNormal(p,c),m=D.vec3f64.create();A.plane.intersectRay(h,o,m)&&(this._ringDragData={origin:p,plane:h,angle:0,angleDir:0,scale:1,scaleDir:0,startPoint:m,endPoint:D.vec3f64.clone(m),mode:null},this._startSymbolDataPromise=L(this.view,a),this._startSymbolDataPromise.then(function(t){e._startSymbolData=t,e._startSymbolDataPromise=null},function(){e._startSymbolDataPromise=null}))}else{var h=r.plane;if(A.plane.intersectRay(h,o,r.endPoint)){var d=V(r),c=h,f=k.calculateInputRotationTransform(r.startPoint,r.endPoint,r.origin,c),v=b.cyclicalPI.shortestSignedDiff(r.angle,f);r.angleDir=l.clamp(r.angleDir+v,-I.ROTATE_INDICATOR_DIRECTION_BUFFER,I.ROTATE_INDICATOR_DIRECTION_BUFFER),r.angle=f;var _=d-r.scale;r.scaleDir=l.clamp(r.scaleDir+_,-I.SCALE_INDICATOR_DIRECTION_BUFFER,I.SCALE_INDICATOR_DIRECTION_BUFFER),r.scale=d;var T=null,R=this._ringMode;if(u.isSome(R))T=R;else{var M=z(r,this.view.state.camera);if(u.isSome(M)){switch(M){case"rotate":this.emit("graphic-rotate-start",new J(a));break;case"scale":this.emit("graphic-scale-start",new $(a))}T="scale"===M?{type:"scale"}:{type:"rotate",startAngle:f}}}if(r.mode=T,this._updateManipulators(),u.isSome(T)&&"disabled"!==T.type){var E=a.symbol.clone();switch(j(E,i,this._calculateSymbolRotateAngle(T),this._calculateSymbolScaleFactor(T)),a.symbol=E,T.type){case"rotate":this.emit("graphic-rotate",new at(a,S.toDegree(f)));break;case"scale":this.emit("graphic-scale",new rt(a,d))}}}}}},e.prototype._calculateSymbolRotateAngle=function(t){return void 0===t&&(t=this._ringMode),u.isNone(t)||"rotate"!==t.type||u.isNone(this._ringDragData)?0:this._ringDragData.angle-t.startAngle},e.prototype._calculateSymbolScaleFactor=function(t){return void 0===t&&(t=this._ringMode),u.isNone(t)||"scale"!==t.type||u.isNone(this._ringDragData)?1:this._ringDragData.scale},e.prototype._shouldAllowModeType=function(t){return"scale"===t?this.enableScaling:!(u.isNone(this.graphic)||!this.enableRotation)&&this.graphic.symbol.symbolLayers.some(function(t){return"object"===t.type})},e.prototype._updateManipulators=function(t){if(!t){var e=this._calculateSymbolScaleFactor();t=v.mat4.fromScaling(w.sm4d.get(),y.vec3.set(w.sv3d.get(),e,e,1))}var a=this._manipulatorState,r=this._getManipulatorRotationAngle(),i=v.mat4.identity(w.sm4d.get());0!==r&&v.mat4.rotate(i,i,r,D.vec3f64.fromValues(0,0,1));var n=this.discManipulator.position,o=this.view.renderCoordsHelper.basisMatrixAtPosition(n,w.sm4d.get()),s=t?v.mat4.multiply(w.sm4d.get(),o,t):o,c=u.isSome(this.graphic)&&null!=this.graphic.geometry,l=Z(this.view)?v.mat4.multiply(w.sm4d.get(),s,i):s;this.discManipulator.state=a,this.discManipulator.modelTransform=l,this.discManipulator.visible=c,this.arrowManipulators.forEach(function(t){var e=t.manipulator,r=t.transform,i=v.mat4.multiply(w.sm4d.get(),l,r);e.state=a,e.position=n,e.modelTransform=i,e.visible=c});var p=v.mat4.multiply(w.sm4d.get(),s,i);this.ringManipulator.state=a,this.ringManipulator.position=this.discManipulator.position,this.ringManipulator.modelTransform=p;var h=this._ringMode,g=u.isSome(h)&&"disabled"===h.type;this.ringManipulator.visible=c&&!g},e.prototype._setSingleManipulatorInteractive=function(t,e){if(!e)return this.discManipulator.interactive=!0,this.ringManipulator.interactive=!0,void this.arrowManipulators.forEach(function(t){t.manipulator.interactive=!0});this.discManipulator.interactive=this.discManipulator===t,this.ringManipulator.interactive=this.ringManipulator===t,this.arrowManipulators.forEach(function(e){var a=e.manipulator;a.interactive=a===t})},e.prototype._startRingFocusFrameTask=function(){var t=this;this._removeFrameTasks();var e=0;this._ringDelayedFocusFrameTask=h.addFrameTask({update:function(a){var r=a.deltaTime;if(e+=r,!t.ringManipulator.focused)return t._ringManipulatorHasDelayedFocused=!1,t._removeFrameTasks(),void t._updateManipulators();e>I.RING_INDICATOR_DELAY_MS&&(t._ringManipulatorHasDelayedFocused=!0,t._removeFrameTasks(),t._updateManipulators())}})},e.prototype._startScaleResetAnimation=function(t){var e=this;this._removeFrameTasks();var a=t;this._scaleAnimationFrameTask=h.addFrameTask({update:function(t){var r=t.deltaTime;if(a+=((a+1)/2-a)*Math.min(r*I.RING_RESET_ANIMATION_SPEED_FACTOR,1),Math.abs(a-1)<.01)return e._removeFrameTasks(),void e._updateManipulators();e._ringManipulatorHasDelayedFocused=!1;var i=v.mat4.fromScaling(w.sm4d.get(),y.vec3.set(w.sv3d.get(),a,a,1));e._updateManipulators(i)}})},e.prototype._getManipulatorRotationAngle=function(){var t=u.isSome(this.graphic)?x(this.graphic):0,e=S.toRadian(-t);if(u.isNone(this._ringDragData)||u.isSome(this._ringDragData.mode))return e;var a=this._ringDragData,r=a.origin,i=a.plane,n=a.startPoint,o=a.endPoint,s=i;return e+k.calculateInputRotationTransform(n,o,r,s)},e.prototype._calculateArrowManipulatorTransform=function(t,e){var a=v.mat4.identity(w.sm4d.get());v.mat4.fromZRotation(a,t*Math.PI/2);var r=v.mat4.identity(w.sm4d.get());return v.mat4.fromTranslation(r,y.vec3.set(w.sv3d.get(),0,I.DISC_TRANSLATE_ARROW_OFFSET,0)),v.mat4.multiply(e,a,r)},e.prototype._calculateArrowManipulatorDirection=function(t,e){var a=this.discManipulator.modelTransform;return 0===t||2===t?y.vec3.set(e,a[4],a[5],a[6]):y.vec3.set(e,a[0],a[1],a[2])},e.prototype._removeFrameTasks=function(){this.ringManipulator&&(this._ringManipulatorHasDelayedFocused=this.ringManipulator.focused),u.isSome(this._ringDelayedFocusFrameTask)&&(this._ringDelayedFocusFrameTask.remove(),this._ringDelayedFocusFrameTask=null),u.isSome(this._scaleAnimationFrameTask)&&(this._scaleAnimationFrameTask.remove(),this._scaleAnimationFrameTask=null)},a([f.property({constructOnly:!0,nonNullable:!0})],e.prototype,"view",void 0),a([f.property({value:null})],e.prototype,"graphic",null),a([f.property()],e.prototype,"enableRotation",void 0),a([f.property()],e.prototype,"enableScaling",void 0),a([f.property({readOnly:!0})],e.prototype,"type",void 0),e=a([f.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransform3DTool")],e)}(f.declared(o.EventedMixin(F.InteractiveToolBase)));e.GraphicTransform3DTool=it;var nt,ot=D.vec3f64.create(),st=g.createScreenPointArray();!function(t){t.Unlocked=16,t.ScaleIn=32,t.ScaleOut=64,t.RotateLeft=128,t.RotateRight=256,t.DiscFocused=512,t.DiscUnfocused=1024,t.RingFocused=2048,t.RingUnfocused=4096,t.ArrowFocused=8192,t.ArrowUnfocused=16384,t.TouchInput=32768}(nt||(nt={}));var ct=A.ray.create(),lt=R.makeDehydratedPoint(0,0,0,null)});