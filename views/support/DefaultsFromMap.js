// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/Accessor","../../core/arrayUtils","../../core/Handles","../../core/Logger","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/heightModelInfoUtils","../../geometry/support/webMercatorUtils","@dojo/framework/shim/Promise"],function(e,t,i,o,n,r,a,s,l,c,d,p,u,h,f){function g(e){return e?JSON.stringify(e.toJSON()):"undefined"}function _(e){switch(e){case 0:return"Waiting";case 1:return"Found";case 2:return"Exhausted"}return"Unknown: "+e}var y=c.getLogger("esri.views.support.DefaultsFromMap");return function(t){function a(){var e=null!==t&&t.apply(this,arguments)||this;return e._handles=new l,e._waitTask=null,e._extentProjectController=null,e._isStarted=!1,e._spatialReferenceCandidates=null,e._extentCandidates=null,e.logDebugInformation=!1,e.isSpatialReferenceDone=!1,e.isTileInfoDone=!1,e.isHeightModelInfoSearching=!1,e.spatialReference=null,e.extent=null,e.heightModelInfo=null,e.vcsWkid=null,e.latestVcsWkid=null,e.mapCollectionPaths=c.DefaultMapCollectionPaths.slice(),e.tileInfo=null,e}i(a,t),c=a,a.prototype.initialize=function(){var e=this;this.watch("mapCollectionPaths",function(){e._isStarted&&(e.reset(),e.start())})},a.prototype.destroy=function(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null,this._isStarted=!1),this._cancelLoading()},a.prototype.reset=function(){this._handles.removeAll(),this._isStarted=!1,this._set("isSpatialReferenceDone",!1),this._set("isTileInfoDone",!1),this._set("isHeightModelInfoSearching",!1),this._set("spatialReference",null),this._set("extent",null),this._set("heightModelInfo",null),this._set("vcsWkid",null),this._set("latestVcsWkid",null),this._set("tileInfo",null),this._spatialReferenceCandidates=null,this._extentCandidates=null},a.prototype.start=function(){this._handles.removeAll(),this._isStarted=!0;for(var e=this._updateLayerChange.bind(this),t=0,i=this.mapCollectionPaths;t<i.length;t++){var o=i[t];this._handles.add(p.on(this.view,"map."+o,"change",e,e,e,!0))}},a.prototype._ownerNameFromCollectionName=function(e){var t=e.lastIndexOf(".");return-1===t?"view":"view."+e.slice(0,t)},a.prototype._ensureLoadedOwnersFromCollectionName=function(e){for(var t,i=this._ownerNameFromCollectionName(e),o=i.split("."),n=0;n<o.length&&(t=this.get(o.slice(0,n+1).join(".")));n++)if(t.load&&!t.isFulfilled())return{collectionName:e,owner:null,loading:t.load()};return{collectionName:e,owner:t}},a.prototype._cancelLoading=function(){this._waitTask=null,this._extentProjectController&&(this._extentProjectController.abort(),this._extentProjectController=null)},a.prototype._updateWhen=function(e){var t=this,i=!0,o=!1,n=e.catch(function(e){}).then(function(){i?o=!0:n===t._waitTask&&t._update()});return i=!1,o||(this._waitTask=n),o},a.prototype._updateLayerChange=function(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set("isSpatialReferenceDone",!1),this._update()},a.prototype._update=function(){var e=this;if(this._cancelLoading(),this.view){if(!this.isSpatialReferenceDone){this._debugLog("Starting search for spatial reference...");var t=this._processMapCollections(function(t){return e._processSpatialReferenceSource(t)});if(this._debugLog("Search ended with status '"+_(t)+"'"),0!==t){var i=null,o=this._spatialReferenceCandidates;if(!o||o.length<1?(i=this.defaultSpatialReference,this._debugLog("No spatial reference found, locking to default ("+g(i)+")")):(this.defaultSpatialReference&&o.length>1&&s.findIndex(o,function(t){return t.equals(e.defaultSpatialReference)})>-1&&(o=[this.defaultSpatialReference]),i=o[0],this._debugLog("Locking to "+g(i))),this._set("spatialReference",i),this._set("isSpatialReferenceDone",!0),i){var n=this.logDebugInformation;this.logDebugInformation=!1,this._processMapCollections(function(t){return e._findExtent(t,i)}),this.extent||this._projectExtentCandidate(),this.logDebugInformation=n}}}if(null==this.heightModelInfo&&this.view.isHeightModelInfoRequired){this._debugLog("Starting search for height model info...");var r=this._processMapCollections(function(t){return e._processHeightModelInfoSource(t)},function(e){return h.mayHaveHeightModelInfo(e)});this._debugLog("Search ended with status "+_(r)),this._set("isHeightModelInfoSearching",0===r)}if(null==this.tileInfo){var a=!1;this.view.isTileInfoRequired()&&(a=this._deriveTileInfo()),a||this._set("isTileInfoDone",!0)}}},a.prototype._processMapCollections=function(e,t){var i=this;this._preloadMapCollections(t);var o=2;return this._forAllMapCollectionSources(function(e){if(2!==o)return!1;var t=e.collectionName;return i._debugLog("Processing collection "+t+"..."),e.loading&&!i._updateWhen(e.loading)?(i._debugLog("Collection "+e.collectionName+" owner is loading -> wait"),o=0,!1):void 0},function(n){return 2===o&&(null==t||t(n)?!n.load||n.isFulfilled()||i._updateWhen(n.load())?n.load&&!n.isResolved()||!e(n)?void 0:(o=1,!1):(i._debugLog("Source "+n.id+" is loading -> wait"),o=0,!1):(i._debugLog("Source "+n.id+" is skipped due to predicate"),!1))}),o},a.prototype._preloadMapCollections=function(e){var t=this,i=10,o=this.logDebugInformation;this.logDebugInformation=!1,this._forAllMapCollectionSources(function(e){return!0},function(n){return 0!==i&&(!(null!=e&&!e(n))&&void(n.load&&!n.isFulfilled()&&(t.logDebugInformation=o,t._debugLog("Pre-loading source "+n.id),t.logDebugInformation=!1,n.load(),i--)))}),this.logDebugInformation=o},a.prototype._forAllMapCollectionSources=function(e,t){for(var i=0,o=this.mapCollectionPaths;i<o.length;i++){var n=o[i],r="map."+n,a=this._ensureLoadedOwnersFromCollectionName(r);if(!1!==e(a)){var s=a.owner;if(!s||s.isRejected&&s.isRejected())this._debugLog("Collection "+r+" owner is invalid or rejected -> skip");else{var l=this.view.get(r);l?this._forEachSource(l,t):this._debugLog("Collection "+r+" does not exist -> skip")}}}},a.prototype._forEachSource=function(e,t){for(var i=0,o=e.items;i<o.length;i++){var n=o[i];!1!==t(n)&&("layers"in n&&this._forEachSource(n.layers,t))}},a.prototype._processSpatialReferenceSource=function(e){var t=this._getSupportedSpatialReferences(e);return 0!==t.length&&(this._spatialReferenceCandidates?(t=s.intersect(t,this._spatialReferenceCandidates,function(e,t){return e.equals(t)}),t.length>0?this._spatialReferenceCandidates=t:this._debugLog("Layer "+e.id+" is ignored because its supported spatial\n          references are not compatible with the previous candidates")):this._spatialReferenceCandidates=t,1===this._spatialReferenceCandidates.length)},a.prototype._findExtent=function(e,t){var i="fullExtents"in e&&e.fullExtents||(e.fullExtent?[e.fullExtent]:[]),o=s.find(i,function(e){return e.spatialReference.equals(t)});if(o)return this._set("extent",o),!0;if(this._getSupportedSpatialReferences(e).length>0){var n=i.map(function(t){return{extent:t,layer:e}}),r=this._extentCandidates||[];this._extentCandidates=r.concat(n)}return!1},a.prototype._projectExtentCandidate=function(){return r(this,void 0,void 0,function(){var t,i,o,r,a,l;return n(this,function(n){switch(n.label){case 0:return this._extentCandidates&&this._extentCandidates.length?(t=this.spatialReference,(i=s.find(this._extentCandidates,function(e){return f.canProject(e.extent.spatialReference,t)}))?(this._set("extent",f.project(i.extent,t)),[3,7]):[3,1]):[2];case 1:return o=this._extentCandidates[0],this._extentProjectController=d.createAbortController(),[4,new Promise(function(t,i){e(["../../portal/support/geometryServiceUtils"],t,i)})];case 2:r=n.sent(),n.label=3;case 3:return n.trys.push([3,5,,6]),[4,r.projectGeometry(o.extent,t,o.layer.portalItem,this._extentProjectController.signal)];case 4:return a=n.sent(),this._set("extent",a),[3,6];case 5:return l=n.sent(),[3,6];case 6:this._extentProjectController=null,n.label=7;case 7:return[2]}})})},a.prototype._getSupportedSpatialReferences=function(e){var t=this,i="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===i.length)return this._debugLog("Layer "+e.id+" is ignored because it does not have any spatial references"),[];var o=i.filter(function(i){return t.view.isSpatialReferenceSupported(i,e,function(e){return t._debugLog(e)})});return 0===o.length?this._debugLog("Layer "+e.id+" has spatial references but none of them are supported (or layer doesn't require locking)"):this._debugLog("Layer "+e.id+" has spatial references. Resulting candidate set: "+o.map(g).join(", ")),o},a.prototype._processHeightModelInfoSource=function(e){var t=h.deriveHeightModelInfoFromLayer(e);return!!t&&(this._set("heightModelInfo",t),this._set("isHeightModelInfoSearching",!1),e.spatialReference&&(this._set("vcsWkid",e.spatialReference.vcsWkid),this._set("latestVcsWkid",e.spatialReference.latestVcsWkid)),!0)},a.prototype._deriveTileInfo=function(){if(!this.isSpatialReferenceDone)return!0;var e=this.get("view.map");if(!e)return!0;var t=e.basemap,i=t&&t.get("baseLayers.0"),o=e.get("layers.0"),n=!1,r=null;return t&&"failed"!==t.loadStatus?t.loaded?i&&"failed"!==i.loadStatus?i.loaded?r="tileInfo"in i&&i.tileInfo:(this._updateWhen(i.load()),n=!0):o&&"failed"!==o.loadStatus?o.loaded?r="tileInfo"in o&&o.tileInfo:(this._updateWhen(o.load()),n=!0):n=!0:(this._updateWhen(t.load()),n=!0):o&&"failed"!==o.loadStatus&&(o.loaded?r="tileInfo"in o&&o.tileInfo:(this._updateWhen(o.load()),n=!0)),r&&!r.spatialReference.equals(this.spatialReference)&&(r=null),n||this._set("tileInfo",r),n},a.prototype._debugLog=function(e){this.logDebugInformation&&y.info(e)};var c;return a.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"],o([u.property()],a.prototype,"logDebugInformation",void 0),o([u.property({readOnly:!0})],a.prototype,"isSpatialReferenceDone",void 0),o([u.property({readOnly:!0})],a.prototype,"isTileInfoDone",void 0),o([u.property({readOnly:!0})],a.prototype,"isHeightModelInfoSearching",void 0),o([u.property({constructOnly:!0})],a.prototype,"view",void 0),o([u.property({readOnly:!0})],a.prototype,"spatialReference",void 0),o([u.property({readOnly:!0})],a.prototype,"extent",void 0),o([u.property({readOnly:!0})],a.prototype,"heightModelInfo",void 0),o([u.property({readOnly:!0})],a.prototype,"vcsWkid",void 0),o([u.property({readOnly:!0})],a.prototype,"latestVcsWkid",void 0),o([u.property()],a.prototype,"mapCollectionPaths",void 0),o([u.property()],a.prototype,"defaultSpatialReference",void 0),o([u.property({readOnly:!0})],a.prototype,"tileInfo",void 0),a=c=o([u.subclass("esri.views.support.DefaultsFromMap")],a)}(u.declared(a))});