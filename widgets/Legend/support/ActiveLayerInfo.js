// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","../../../Color","../../../request","../../../symbols","../../../core/Accessor","../../../core/arrayUtils","../../../core/Collection","../../../core/Handles","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/urlUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/support/ExportImageParameters","../../../layers/support/fieldUtils","../../../renderers/support/jsonUtils","../../../symbols/support/symbolUtils","../../../symbols/support/utils","./colorRampUtils","./heatmapRampUtils","./relationshipRampUtils","./sizeRampUtils","./utils","@dojo/framework/shim/Promise"],function(e,t,r,n,l,i,s,o,a,u,c,d,p,y,f,h,m,g,b,v,_,S,E,L,R,w,C,F,I,T){function M(e){return"raster-colormap"===e.type}function V(e){return"raster-stretch"===e.type}function z(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function P(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function O(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function x(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function D(e){return U(e)||k(e)||B(e)||A(e)}function A(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}function U(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function k(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function B(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function N(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function W(e){return z(e)||P(e)||O(e)||V(e)||M(e)||x(e)||U(e)||k(e)||B(e)||N(e)}function H(e){return"esri.layers.WMSLayer"===e.declaredClass}function j(e){return"esri.layers.WMTSLayer"===e.declaredClass}function q(e){return"esri.layers.MapImageLayer"===e.declaredClass}function G(e){return"esri.layers.FeatureLayer"===e.declaredClass}function J(e){return e.declaredClass===Z}var $=f.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),Z="esri.layers.ImageryLayer",Q=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,X=new u.SimpleMarkerSymbol({size:6,outline:{color:[128,128,128,.5],width:.5}}),K=new u.SimpleFillSymbol({style:"solid"}),Y=new u.SimpleMarkerSymbol({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});return function(t){function u(e){var r=t.call(this,e)||this;return r._handles=new y,r._hasColorRamp=!1,r._hasOpacityRamp=!1,r._hasSizeRamp=!1,r._legendResponse={},r._webStyleSymbolCache=new Map,r._dotDensityUrlCache=new Map,r.children=new p,r.layer=null,r.legendElements=[],r.parent=null,r.scale=null,r.title=null,r.view=null,r}return n(u,t),u.prototype.initialize=function(){var e=this,t=function(){return e.notifyChange("ready")};this._handles.add([b.on(this,"children","change",function(r){var n=r.added,l=r.removed,i=e._handles;n.map(function(e){var r="activeLayerInfo-ready-watcher-"+e.layer.uid;i.add(b.init(e,"ready",t),r)}),l.forEach(function(e){return i.remove(e.layer.uid)}),t()})])},u.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._legendResponse=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null},Object.defineProperty(u.prototype,"ready",{get:function(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"isScaleDriven",{get:function(){var e=this,t=this.layer;if(null===t)return!1;if("renderer"in t&&t.renderer){if("dot-density"===t.renderer.type)return!0;var r=t.get("renderer.valueExpression");if(Q.test(r))return!0;var n=t.get("renderer.visualVariables");return n&&n.some(function(t){return e._isScaleDrivenSizeVariable(t)})}return!0},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!0,configurable:!0}),u.prototype.buildLegendElementsForFeatureCollections=function(e){return i(this,void 0,void 0,function(){var t,r=this;return s(this,function(n){return this.legendElements=[],t=e.map(function(e){if(G(e))return r._buildRendererLegendElements(e.renderer,e.title,"append");if(e.featureSet&&e.featureSet.features.length){var t=e.layerDefinition,n=t&&t.drawingInfo,l=n&&E.fromJSON(n.renderer);return l?r._buildRendererLegendElements(l,e.name,"append"):($.warn("drawingInfo not available!"),null)}return null}),[2,m.eachAlways(t).then(function(){})]})})},u.prototype.buildLegendElementsForRenderer=function(){return i(this,void 0,void 0,function(){return s(this,function(e){return[2,this._buildRendererLegendElements("renderer"in this.layer&&this.layer.renderer,null,"replace")]})})},u.prototype.buildLegendElementsForTools=function(){return i(this,void 0,void 0,function(){var e,t=this;return s(this,function(r){switch(r.label){case 0:return e=this.layer,j(e)?(this._constructLegendElementsForWMTSlayer(),[3,6]):[3,1];case 1:return H(e)?(this._constructLegendElementsForWMSSublayers(),[3,6]):[3,2];case 2:return q(e)?[4,this._constructLegendElementsForSublayers()]:[3,4];case 3:return r.sent(),[3,6];case 4:return this._handles.remove("imageryLayers-watcher"),[4,this._getLegendLayers().then(function(r){t.legendElements=[],r.forEach(function(r){if(J(e)){var n=e.watch("renderingRule, bandIds",function(){t._legendResponse.default=null,t.buildLegendElementsForTools()});t._handles.add(n,"imageryLayers-watcher")}var l=t._generateSymbolTableElementForLegendLayer(r);l&&l.infos.length&&(J(e)&&(l.title=e.title),t.legendElements.push(l)),t.notifyChange("ready")}),t.notifyChange("ready")}).catch(function(e){$.warn("Request to server for legend has failed!",e)})];case 5:r.sent(),r.label=6;case 6:return[2]}})})},u.prototype._isGroupActive=function(){var e=this.children;return!!e.length&&e.some(function(e){return e.ready})},u.prototype._isScaleDrivenSizeVariable=function(e){if(e&&"size"!==e.type)return!1;var t=e,r=t.minSize,n=t.maxSize;return"object"==typeof r&&r?this._isScaleDrivenSizeVariable(r):"object"==typeof n&&n?this._isScaleDrivenSizeVariable(n):!!t.expression||Q.test(t.valueExpression)},u.prototype._buildRendererLegendElements=function(e,t,r){return i(this,void 0,void 0,function(){var n,l;return s(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this._getRendererLegendElements(e,t)];case 1:return n=i.sent(),"append"===r?Array.prototype.push.apply(this.legendElements,n):this.legendElements=n,this.notifyChange("ready"),[3,3];case 2:return l=i.sent(),$.warn("error while building legend for layer!",l),[3,3];case 3:return[2]}})})},u.prototype._constructLegendElementsForWMTSlayer=function(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");var e=this.layer,t=e.activeLayer;if(this._handles.add(b.watch(this.layer,"activeLayer",this._constructLegendElementsForWMTSlayer.bind(this)),"wmts-activeLayer-watcher"),t.styleId&&t.styles){var r=null;t.styles.some(function(e){return t.styleId===e.id&&(r=e.legendUrl,!0)}),r&&(this.legendElements=[{type:"symbol-table",title:t.title,infos:[{src:r,opacity:e.opacity}]}])}this.notifyChange("ready")},u.prototype._constructLegendElementsForWMSSublayers=function(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");var e=this.layer,t=null;(e.customParameters||e.customLayerParameters)&&(t=r({},e.customParameters,e.customLayerParameters)),this._handles.add(b.watch(this.layer,"sublayers",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher"),this.legendElements=this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")},u.prototype._generateLegendElementsForWMSSublayers=function(e,t){var r=this,n=[];return this._handles.add(e.on("change",this._constructLegendElementsForWMSSublayers.bind(this)),"wms-sublayers-watcher"),e.forEach(function(e){var l=e.watch("title, visible, legendEnabled",function(){return r._constructLegendElementsForWMSSublayers()});if(r._handles.add(l,"wms-sublayers-watcher"),e.visible&&e.legendEnabled){var i=r._generateSymbolTableElementForWMSSublayer(e,t);i&&i.infos.length&&n.unshift(i)}}),n},u.prototype._generateSymbolTableElementForWMSSublayer=function(e,t){if(!e.legendUrl&&e.sublayers){var r=this._generateLegendElementsForWMSSublayers(e.sublayers,t).filter(function(e){return e});return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendUrl(e,t)},u.prototype._generateSymbolTableElementForLegendUrl=function(e,t){var r=e.legendUrl;if(r){var n={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};return t&&(r+="?"+g.objectToQuery(t)),n.infos.push({src:r,opacity:e.layer&&e.layer.opacity}),n}},u.prototype._getLegendLayers=function(e){var t=this,r=e&&e.hasDynamicLayers,n=r?e.dynamicLayers:null,l=n||"default",i=this._legendResponse&&this._legendResponse[l];return i?m.resolve(i):this._legendRequest(n).then(function(e){var r=e.layers;return t._legendResponse[l]=r,r})},u.prototype._legendRequest=function(e){var t=this.layer,n={f:"json",dynamicLayers:e};if(J(t)){var l=t;if(l.renderingRule&&(n.renderingRule=JSON.stringify(l.renderingRule.toJSON())),l.bandIds&&(n.bandIds=l.bandIds.join()),l.raster||l.viewId){var i=l.raster,s=l.viewId;n=r({raster:i,viewId:s},n)}}var o=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){var u=o.indexOf("?");u>-1?o=o.substring(0,u)+"/legend"+o.substring(u):o+="/legend"}else{var c=o.toLowerCase().indexOf("/rest/"),d=o.substring(0,c)+o.substring(c+5,o.length);o="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(d)+"&returnbytes=true"}return a(o,{query:n}).then(function(e){return e.data})},u.prototype._constructLegendElementsForSublayers=function(){var e=this;this.legendElements=[],this._handles.remove("sublayers-watcher");var t=this.layer,r=new _.ExportImageParameters({layer:t});return this._getLegendLayers(r).then(function(r){var n={};r.forEach(function(e){n[e.layerId]=e}),e._handles.add(b.watch(t,"sublayers",e._constructLegendElementsForSublayers.bind(e)),"sublayers-watcher"),e.legendElements=e._generateLegendElementsForSublayers(t.sublayers,n,t.opacity),e.notifyChange("ready")}).catch(function(e){$.warn("Request to server for legend has failed!",e)}).then(function(){return r.destroy()})},u.prototype._generateLegendElementsForSublayers=function(e,t,r){var n=this,l=[];return this._handles.add(e.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),e.forEach(function(e){var i=e.watch("renderer, opacity, title, visible",function(){return n._constructLegendElementsForSublayers()});if(n._handles.add(i,"sublayers-watcher"),e.visible&&e.legendEnabled){var s=e&&null!=e.opacity?e.opacity:null,o=null!=s?s*r:r,a=n._generateSymbolTableElementForSublayer(e,t,o);a&&a.infos.length&&l.unshift(a)}}),l},u.prototype._generateSymbolTableElementForSublayer=function(e,t,r){var n=t[e.id];if(!n&&e.sublayers){var l=this._generateLegendElementsForSublayers(e.sublayers,t,r).filter(function(e){return e});return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(n,e,r)},u.prototype._generateSymbolTableElementForLegendLayer=function(e,t,r){var n=this;if(e){var l=t&&t.renderer,i=t&&t.title||e.layerName;if(l){var s=t&&t.title||this._getRendererTitle(l,t);s&&(i&&(s.title=i),i=s)}var o={type:"symbol-table",title:i,infos:[]};if(e.legendType&&(o.legendType=e.legendType),e.legend&&this._isLegendLayerInScale(e,t)){var a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;o.infos=a.map(function(t){var l=t.url;if(t.imageData&&t.imageData.length>0)l="data:image/png;base64,"+t.imageData;else{if(0===l.indexOf("http"))return null;l=g.addTokenParameter(n.layer.url+"/"+e.layerId+"/images/"+l)}return{label:t.label,src:l,opacity:r,width:t.width,height:t.height}}).filter(function(e){return!!e})}return o.infos.length?o:null}},u.prototype._isLegendLayerInScale=function(e,t){var r=t||this.layer,n=null,l=null,i=!0;return!r.minScale&&0!==r.minScale||!r.maxScale&&0!==r.maxScale?(0===e.minScale&&r.tileInfo&&(n=r.tileInfo.lods[0].scale),0===e.maxScale&&r.tileInfo&&(l=r.tileInfo.lods[r.tileInfo.lods.length-1].scale)):(n=Math.min(r.minScale,e.minScale)||r.minScale||e.minScale,l=Math.max(r.maxScale,e.maxScale)),(n>0&&n<this.scale||l>this.scale)&&(i=!1),i},u.prototype._sanitizeLegendForSublayer=function(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;var r=t.renderer,n=e.some(function(e){return e.values}),l=null,i=null;return n&&e.some(function(e,t){return e.values||(l=t,i=e,i.label||(i.label="others")),null!=i}),r?"unique-value"===r.type?i&&(e.splice(l,1),e.push(i)):"class-breaks"===r.type&&(i&&e.splice(l,1),e.reverse(),i&&e.push(i)):i&&(e.splice(l,1),e.push(i)),e},u.prototype._getRendererLegendElements=function(e,t){return i(this,void 0,void 0,function(){return s(this,function(r){return W(e)?D(e)?[2,this._constructPointCloudRendererLegendElements(e,t)]:"dot-density"===e.type?[2,this._constructDotDensityRendererLegendElements(e)]:[2,this._constructRendererLegendElements(e,t)]:($.warn("Renderer not supported!"),[2,[]])})})},u.prototype._getPointCloudRendererTitle=function(e){return e.legendOptions&&e.legendOptions.title||e.field},u.prototype._constructPointCloudRendererLegendElements=function(e,t){var r=this,n=[],l=null,i=null;if(U(e))l={type:"symbol-table",title:t||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(function(e){l.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:r._getAppliedCloneSymbol(X,e.color)})});else if(k(e)){var s=e.stops,o=null;if(s.length&&(1===s.length&&(o=s[0].color),!o)){var a=s[0].value,u=s[s.length-1].value;if(null!=a&&null!=u){var c=a+(u-a)/2;o=w.getColorFromPointCloudStops(c,s)}}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(X,o||X.color)}]};var d=w.getRampStopsForPointCloud(e.stops);i={type:"color-ramp",title:t||this._getPointCloudRendererTitle(e),infos:d,preview:L.renderColorRampPreviewHTML(d.map(function(e){return e.color}))}}else B(e)&&(l={type:"symbol-table",title:t||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach(function(e){l.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:r._getAppliedCloneSymbol(X,e.color)})}));l&&l.infos.length&&n.push(l),i&&i.infos.length&&n.push(i);var p=n.reduce(function(e,t){return e.concat(t.infos)},[]).filter(function(e){return!!e.symbol}).map(function(e){return r._getSymbolPreview(e)});return m.eachAlways(p).then(function(){return n})},u.prototype._getElementInfoForDotDensity=function(e,t){var r=e.backgroundColor,n=e.outline,l=e.dotSize,i=l+"-"+t+"-"+r+"-"+(n&&JSON.stringify(n.toJSON())),s=this._dotDensityUrlCache,o=s.has(i)?s.get(i):L.renderDotDensityPreviewHTML(e,t);return s.set(i,o),{opacity:1,src:o.src,preview:o,width:o.width,height:o.height}},u.prototype._constructDotDensityRendererLegendElements=function(e){var t=this,r=e.calculateDotValue(this.view.scale),n=e.legendOptions&&e.legendOptions.unit,l={type:"symbol-table",title:{value:r&&Math.round(r),unit:n||""},infos:[]};return e.attributes.forEach(function(r){var n=t._getElementInfoForDotDensity(e,r.color);n.label=r.label||r.valueExpressionTitle||r.field,l.infos.push(n)}),m.resolve([l])},u.prototype._constructRendererLegendElements=function(e,t){return i(this,void 0,void 0,function(){var r,n,l,i,o,a,u,c,d,p,y,f,g,b,v,_,S,E,R,w,I,T,D,A,U,g,k,B,N,W,H,j,q,G,J,$,Z=this;return s(this,function(s){switch(s.label){case 0:return[4,this._loadRenderer(e)];case 1:return r=s.sent(),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,[4,this._getVisualVariableLegendElements(r)];case 2:return n=s.sent()||[],(l={type:"symbol-table",title:t||this._getRendererTitle(r),infos:[]},i=null,o=!1,x(r))?(a=C.getHeatmapRampStops(r),n.push({type:"heatmap-ramp",title:t,infos:a,preview:L.renderColorRampPreviewHTML(a.map(function(e){return e.color}))}),[3,10]):[3,3];case 3:if(!O(r))return[3,4];if(u=r&&r.authoringInfo,c=u&&"relationship"===u.type){if(d=u.focus,p=u.numClasses,y=u.field1,f=u.field2,p&&y&&f){for(g=this.layer,b=[y,f],v=F.getRotationAngleForFocus(d)||0,_=0,S=b;_<S.length;_++)E=S[_],R=E.field,w=E.normalizationField,I={field:this._getFieldAlias(R,g),normField:w&&this._getFieldAlias(w,g)},T=Y.clone(),T.angle=v,l.infos.push({label:I,symbol:T}),v+=90;D=F.getRelationshipRampElement({focus:d,numClasses:p,infos:r.uniqueValueInfos}),n.unshift(D)}}else A=r.field,r.uniqueValueInfos.forEach(function(e){e.symbol&&l.infos.push({label:e.label||Z._getDomainName(A,e.value)||e.value,value:e.value,symbol:e.symbol})});return r.defaultSymbol&&(l.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),o=!0),[3,10];case 4:return P(r)?(i=this._isUnclassedRenderer(r),U=!i||!this._hasSizeRamp,U&&(r.classBreakInfos.forEach(function(e){e.symbol&&l.infos.unshift({label:e.label||(i?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})}),i&&(l.title=null),this._updateInfosforClassedSizeRenderer(r,l.infos)),r.defaultSymbol&&!i&&(l.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),o=!0),[3,10]):[3,5];case 5:return V(r)?(g=this.layer,k=void 0,B=void 0,r.statistics&&(k=r.statistics[0].min||r.statistics[0][0],B=r.statistics[0].max||r.statistics[0][1]),N=[],H=h.unwrap,g.renderingRule?[4,g.generateRasterInfo(g.renderingRule)]:[3,7]):[3,9];case 6:return j=s.sent(),[3,8];case 7:j=g.serviceRasterInfo,s.label=8;case 8:return W=H.apply(void 0,[j]),q=W.keyProperties.BandProperties,1===W.bandCount?(k=k||W.statistics&&W.statistics[0].min,B=B||W.statistics&&W.statistics[0].max,k&&B?n.push(this._getStretchLegendElements(r,{min:k,max:B})):this.buildLegendElementsForTools()):g.bandIds&&1===g.bandIds.length?(k=k||W.statistics&&W.statistics[g.bandIds[0]].min,B=B||W.statistics&&W.statistics[g.bandIds[0]].max,k&&B?n.push(this._getStretchLegendElements(r,{min:k,max:B})):this.buildLegendElementsForTools()):W.bandCount>=3?q&&q.length>=W.bandCount?g.bandIds&&3===g.bandIds.length?(N=g.bandIds.map(function(e){return q[e].BandName}),l.infos=this._createSymbolTableElementMultiBand(N)):"lerc"===g.format?(N=[0,1,2].map(function(e){return q[e].BandName}),l.infos=this._createSymbolTableElementMultiBand(N)):this.buildLegendElementsForTools():"lerc"===g.format?(N=["band0","band1","band2"],l.infos=this._createSymbolTableElementMultiBand(N)):this.buildLegendElementsForTools():this.buildLegendElementsForTools(),[3,10];case 9:M(r)?r.colormapInfos.forEach(function(e){l.infos.push({label:e.label,value:e.value,symbol:Z._getAppliedCloneSymbol(K,e.color)})}):z(r)&&r.symbol&&!this._hasSizeRamp&&l.infos.push({label:r.label,symbol:r.symbol}),s.label=10;case 10:return G=r.defaultSymbol,!G||o||z(r)||i&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||n.push({type:"symbol-table",infos:[{label:r.defaultLabel||"others",symbol:G}]}),l.infos.length&&n.unshift(l),J=this._getSymbolConfig("visualVariables"in r&&r.visualVariables),$=n.reduce(function(e,t){return e.concat(t.infos)},[]).filter(function(e){return!(!e||!e.symbol)}).map(function(e){return Z._getSymbolPreview(e,J)}),r=null,[4,m.eachAlways($)];case 11:return s.sent(),[2,n]}})})},u.prototype._getStretchLegendElements=function(e,t){var r=e.colorRamp,n=w.getStrectchRampStops(r,t);return{type:"stretch-ramp",title:"",infos:n,preview:L.renderColorRampPreviewHTML(n.map(function(e){return e.color}))}},u.prototype._createSymbolTableElementMultiBand=function(e){var t=[],r=["red","green","blue"];return e.forEach(function(e,n){t.push({label:{colorName:r[n],bandName:e},src:T.RGB_IMG_SOURCE[n],opacity:1})}),t},u.prototype._updateInfosforClassedSizeRenderer=function(e,t){var r=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,n=e.classBreakInfos.some(function(e){return R.isVolumetricSymbol(e.symbol)});if(r&&n){var l=I.REAL_WORLD_MAX_SIZE,i=I.REAL_WORLD_MIN_SIZE,s=e.classBreakInfos.length,o=(l-i)/(s>1?s-1:s);t.forEach(function(e,t){e.size=l-o*t})}},u.prototype._getSymbolConfig=function(e){var t=!1,r=!1;if(e)for(var n=0;n<e.length&&(!t||!r);n++){var l=e[n];"size"===l.type&&("height"===l.axis&&(t=!0),"width-and-depth"===l.axis&&(r=!0))}return t&&r?"tall":null},u.prototype._getSymbolPreview=function(e,t){return L.renderPreviewHTML(e.symbol,{size:e.size,opacity:this.layer.opacity,symbolConfig:t,rotation:e.symbol.angle}).then(function(t){return e.preview=t,e}).catch(function(){return e.preview=null,e})},u.prototype._loadRenderer=function(e){return i(this,void 0,void 0,function(){var t,r,n,l,i=this;return s(this,function(s){switch(s.label){case 0:return t=[],e=e.clone(),[4,this._getMedianColor(e)];case 1:return r=s.sent(),(P(e)||O(e))&&(n=e.classBreakInfos||e.uniqueValueInfos,l=n.map(function(e){return i._fetchSymbol(e.symbol,r).then(function(t){e.symbol=t}).catch(function(){e.symbol=null})}),Array.prototype.push.apply(t,l)),t.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:r).then(function(t){i._applySymbolToRenderer(e,t,z(e))}).catch(function(){i._applySymbolToRenderer(e,null,z(e))})),[2,m.eachAlways(t).then(function(){return e})]}})})},u.prototype._applySymbolToRenderer=function(e,t,r){r?e.symbol=t:e.defaultSymbol=t},u.prototype._getMedianColor=function(t){return i(this,void 0,void 0,function(){var r,n,l,i,o;return s(this,function(s){switch(s.label){case 0:if(!("visualVariables"in t&&t.visualVariables))return[2,null];if(!(r=d.find(t.visualVariables,function(e){return"color"===e.type})))return[2,null];if(n=null,l=null,r.stops){if(1===r.stops.length)return[2,r.stops[0].color];n=r.stops[0].value,l=r.stops[r.stops.length-1].value}return i=n+(l-n)/2,[4,new Promise(function(t,r){e(["../../../renderers/visualVariables/support/visualVariableUtils"],t,r)})];case 1:return o=s.sent().getColor,[2,o(r,i)]}})})},u.prototype._fetchSymbol=function(e,t){var r=this;if(!e)return m.reject();if("web-style"===e.type){var n=e.portal,l=n&&n.url,i=n&&n.user&&n.user.username,s=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+l+"-"+i,o=this._webStyleSymbolCache;return o.has(s)||o.set(s,e.fetchSymbol()),o.get(s).then(function(e){return r._getAppliedCloneSymbol(e,t)}).catch(function(){return $.warn("Fetching web-style failed!"),m.reject()})}return m.resolve(this._getAppliedCloneSymbol(e,t))},u.prototype._getAppliedCloneSymbol=function(e,t){if(!e)return e;var r=e.clone(),n=r.type,l=n.indexOf("3d")>-1,i=t&&t.toRgba();return l?this._applyColorTo3dSymbol(r,i):r.color&&(r.color=new o(i||r.color)),r},u.prototype._applyColorTo3dSymbol=function(e,t){t&&e.symbolLayers.forEach(function(e){e&&(e.material||(e.material={}),e.material.color=new o(t))})},u.prototype._getVisualVariableLegendElements=function(e){return i(this,void 0,void 0,function(){var t,r,n,l,o,a,u,c,d,p,y=this;return s(this,function(f){switch(f.label){case 0:return"visualVariables"in e&&e.visualVariables?(t=e.visualVariables,r=[],n=[],l=[],o=this.layer,t.forEach(function(e){"color"===e.type?r.push(e):"size"===e.type?n.push(e):"opacity"===e.type&&l.push(e)}),a=r.concat(n,l),0===r.length&&P(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&(d=e.classBreakInfos[0],u=d&&d.symbol),0===r.length&&z(e)&&(u=e.symbol),u&&(u.type.indexOf("3d")>-1?(p=u.symbolLayers.getItemAt(0),"water"===p.type?h.isSome(p.color)&&(c=p.color):h.isSome(p.material)&&h.isSome(p.material.color)&&(c=p.material.color)):u.url||(c=u.color)),[4,m.all(a.map(function(t){return i(y,void 0,void 0,function(){var r,n,l,i,a,u,d,p,a;return s(this,function(s){switch(s.label){case 0:return t.legendOptions&&!1===t.legendOptions.showLegend?[3,8]:(r=this._getRampTitle(t,o),n=null,l="getField"in o&&o.getField&&o.getField(t.field),i=l&&S.isDateField(l),"color"!==t.type?[3,2]:[4,w.getRampStops(t,null,i)]);case 1:return a=s.sent(),n={type:"color-ramp",title:r,infos:a,preview:L.renderColorRampPreviewHTML(a.map(function(e){return e.color}))},this._hasColorRamp||(this._hasColorRamp=!(null==n.infos||!n.infos.length)),[3,7];case 2:return"size"!==t.type?[3,5]:(u={type:"size-ramp",title:r},d=I.getRampStops,p=[e,t],[4,this._getMedianColor(e)]);case 3:return[4,d.apply(void 0,p.concat([s.sent(),this.scale,this.view,i]))];case 4:return u.infos=s.sent(),n=u,this._hasSizeRamp||(this._hasSizeRamp=!(null==n.infos||!n.infos.length)),[3,7];case 5:return"opacity"!==t.type?[3,7]:[4,w.getRampStops(t,c,i)];case 6:a=s.sent(),n={type:"opacity-ramp",title:r,infos:a,preview:L.renderColorRampPreviewHTML(a.map(function(e){return e.color}))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==n.infos||!n.infos.length)),s.label=7;case 7:return[2,n.infos&&n];case 8:return[2,void 0]}})})}))]):[2,null];case 1:return[2,f.sent().filter(function(e){return!!e})]}})})},u.prototype._getDomainName=function(e,t){if(e&&"function"!=typeof e){var r=this.layer,n=r.getField&&r.getField(e),l=n&&r.getFieldDomain?r.getFieldDomain(n.name):null;return l&&l.codedValues?l.getName(t):null}return null},u.prototype._getRampTitle=function(e,t){var r=e.field,n=e.normalizationField,l=!1,i=!1,s=!1,o=null;if(r="function"==typeof r?null:r,n="function"==typeof n?null:n,null!=(e.legendOptions&&e.legendOptions.title))o=e.legendOptions.title;else if(e.valueExpressionTitle)o=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var a=t.renderer.authoringInfo.visualVariables,u=0;u<a.length;u++){var c=a[u];if("color"===c.type){if("ratio"===c.style){l=!0;break}if("percent"===c.style){i=!0;break}if("percent-of-total"===c.style){s=!0;break}}}o={field:r&&this._getFieldAlias(r,t),normField:n&&this._getFieldAlias(n,t),ratio:l,ratioPercent:i,ratioPercentTotal:s}}return o},u.prototype._getRendererTitle=function(e,t){var r=e;if(r.legendOptions&&r.legendOptions.title)return r.legendOptions.title;if(r.valueExpressionTitle)return r.valueExpressionTitle;var n=this.layer,l=r.field,i=null,s=null;P(r)&&(i=r.normalizationField,s="percent-of-total"===r.normalizationType),l="function"==typeof l?null:l,i="function"==typeof i?null:i;var o=null;return(l||i)&&(o={field:t?l:l&&this._getFieldAlias(l,n),normField:t?i:i&&this._getFieldAlias(i,n),normByPct:s}),o},u.prototype._getFieldAlias=function(e,t){var r="popupTemplate"in t&&t.popupTemplate,n=r&&r.fieldInfos,l="function"==typeof e?null:"getField"in t&&t.getField&&t.getField(e),i=null;n&&n.some(function(t){return e===t.fieldName&&(i=t,!0)});var s=i||l,o=null;return s&&(o=i&&i.label||l&&l.alias||"name"in s&&s.name||"fieldName"in s&&s.fieldName),o},u.prototype._isUnclassedRenderer=function(e){var t=e.visualVariables,r=P(e)&&e.classBreakInfos&&1===e.classBreakInfos.length,n=!1;return r&&t&&(n=e.field?t.some(function(t){return!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)}):!!t.length),n},l([v.property()],u.prototype,"children",void 0),l([v.property()],u.prototype,"layer",void 0),l([v.property()],u.prototype,"legendElements",void 0),l([v.property()],u.prototype,"parent",void 0),l([v.property({readOnly:!0})],u.prototype,"ready",null),l([v.property()],u.prototype,"scale",void 0),l([v.property({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?"],readOnly:!0})],u.prototype,"isScaleDriven",null),l([v.property()],u.prototype,"title",void 0),l([v.property({dependsOn:["ready"],readOnly:!0,value:0})],u.prototype,"version",null),l([v.property()],u.prototype,"view",void 0),u=l([v.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],u)}(v.declared(c))});