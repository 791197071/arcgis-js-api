// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","../../../symbols","../../../core/promiseUtils","../../../intl/date","../../../renderers/support/numberUtils","../../../symbols/support/utils","./utils","@dojo/framework/shim/Promise"],function(e,r,n,t,l,i,s,u,o,a){function c(e){return"esri.symbols.SimpleMarkerSymbol"===e.declaredClass}function f(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}function m(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}function p(e){return"esri.symbols.TextSymbol"===e.declaredClass}function b(e,l,c,f,m,p){return n(this,void 0,void 0,function(){var b,h,d,v,g,w,z,x,D,V,E,M,O,R,I,k,A=this;return t(this,function(C){switch(C.label){case 0:return b=l.legendOptions,h=b&&b.customValues,d=y(e,c),(v=!!d,g=!!h,w=null!=l.minSize&&null!=l.maxSize,z=l.stops&&l.stops.length>1,x=!!l.target,v&&(g||w||z&&!x))?(D=o.isVolumetricSymbol(d),V=null,E=null,M=null,!D||z?[3,1]:(E=u.round([l.minDataValue,l.maxDataValue]),[3,4])):[2];case 1:return O=h,O?[3,3]:[4,S(e,l,d,f,m)];case 2:O=C.sent(),C.label=3;case 3:E=O,C.label=4;case 4:return!E&&z&&(E=l.stops.map(function(e){return e.value}),(V=l.stops.some(function(e){return!!e.label}))&&(M=l.stops.map(function(e){return e.label}))),(D&&E&&E.length>2&&(E=[E[0],E[E.length-1]]),E)?(R=[r.REAL_WORLD_MIN_SIZE,r.REAL_WORLD_MAX_SIZE],I=o.getSymbolOutlineSize(d),[4,i.all(E.map(function(r,i){return n(A,void 0,void 0,function(){var n,o,c,b;return t(this,function(t){switch(t.label){case 0:return D?(c=R[i],[3,3]):[3,1];case 1:return[4,L(e,l,d,r,f,m)];case 2:c=t.sent(),t.label=3;case 3:return n=c,o=_(d,n),b=V?M[i]:a.getLabelPrefix(i,E.length-1)+(p?s.formatDate(r):u.format(r)),[2,{value:r,symbol:o,label:b,size:n,outlineSize:I}]}})})}))]):[2,null];case 5:return k=C.sent(),[2,k.reverse()]}})})}function y(e,r){var n=null,t=null;if("simple"===e.type)n=e.symbol;else if("unique-value"===e.type||"class-breaks"===e.type){var l=e.classBreakInfos||e.uniqueValueInfos,i=l&&l[0];n=i&&i.symbol,t=l.length>1}return!n||h(n)?null:(n=n.clone(),(r||t)&&(n.type.indexOf("3d")>-1?d(n):v(n)),n)}function h(e){if(e){if(l.isSymbol3D(e)){return!!e.symbolLayers&&e.symbolLayers.some(function(e){return e&&"fill"===e.type})}return-1!==e.type.indexOf("fill")}}function d(e){o.isVolumetricSymbol(e)||("line-3d"===e.type?e.symbolLayers.forEach(function(e){e.material={color:V}}):e.symbolLayers.forEach(function(e){"icon"!==e.type||e.resource&&e.resource.href?e.material={color:D}:(e.material={color:x},e.outline={color:V,size:1.5})}))}function v(e){-1!==e.type.indexOf("line")?e.color=V:(e.color=x,"simple-marker"===e.type&&(e.outline={color:V,width:1.5}))}function S(r,l,i,s,o){return n(this,void 0,void 0,function(){var n,a,c,f,m;return t(this,function(t){switch(t.label){case 0:return[4,new Promise(function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)})];case 1:if(n=t.sent().getSizeRangeAtScale(l,s,o),a=n&&g(n),!n&&!a)return[2];c=a.map(function(e){return w(e,l,n)}),c=u.round(c),f=1,t.label=2;case 2:return f<c.length-1?[4,z(r,l,i,c[f],c[f-1],s,o)]:[3,5];case 3:m=t.sent(),m&&(c[f]=m[0],a[f]=m[1]),t.label=4;case 4:return f++,[3,2];case 5:return[2,c]}})})}function g(e){for(var r=e.minSize,n=e.maxSize,t=M,l=(n-r)/(t-1),i=[],s=0;s<t;s++)i.push(r+l*s);return i}function w(e,r,n){var t=n.minSize,l=n.maxSize,i=r.minDataValue,s=r.maxDataValue,u=null;if(e<=t)u=i;else if(e>=l)u=s;else{var o=(e-t)/(l-t);u=o*(s-i)+i}return u}function z(e,r,l,i,s,o,a){return n(this,void 0,void 0,function(){var n,c,f,m,p,b,y,h,d,v,S,g,w,z,_,x,D,V,M,O,R,I;return t(this,function(t){switch(t.label){case 0:return[4,L(e,r,l,i,o,a)];case 1:return c=t.sent(),[4,L(e,r,l,s,o,a)];case 2:f=t.sent(),m=u.numDigits(i),p=m.fractional,b=E,y=m.integer,h=null,d=null,i>0&&i<1&&(h=Math.pow(10,p),i*=h,y=u.numDigits(i).integer),v=y-1,t.label=3;case 3:return v>=0?(S=Math.pow(10,v),g=Math.floor(i/S)*S,w=Math.ceil(i/S)*S,null!=h&&(g/=h,w/=h),z=(g+w)/2,n=u.round([g,z,w],{indexes:[1]}),z=n[1],[4,L(e,r,l,g,o,a)]):[3,8];case 4:return _=t.sent(),[4,L(e,r,l,w,o,a)];case 5:return x=t.sent(),[4,L(e,r,l,z,o,a)];case 6:if(D=t.sent(),V=u.percentChange(c,_,f,null),M=u.percentChange(c,x,f,null),O=u.percentChange(c,D,f,null),R=V.previous<=b,I=M.previous<=b,R&&I&&(V.previous<=M.previous?(R=!0,I=!1):(I=!0,R=!1)),R?d=[g,_]:I?d=[w,x]:O.previous<=b&&(d=[z,D]),d)return[3,8];t.label=7;case 7:return v--,[3,3];case 8:return[2,d]}})})}function L(r,l,i,s,u,o){return n(this,void 0,void 0,function(){var r;return t(this,function(n){switch(n.label){case 0:return[4,new Promise(function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)})];case 1:return r=n.sent().getSize,[2,r(l,s,{scale:u,view:o,shape:-1!==i.type.indexOf("marker-symbol")?i.style:null})]}})})}function _(e,r){var n=e.clone();if(l.isSymbol3D(n))o.isVolumetricSymbol(n)||n.symbolLayers.forEach(function(e){"fill"!==e.type&&(e.size=r)});else if(c(n))n.size=r;else if(f(n)){var t=n.width,i=n.height;n.height=r,n.width=r*(t/i)}else m(n)?n.width=r:p(n)&&n.font&&(n.font.size=r);return n}Object.defineProperty(r,"__esModule",{value:!0}),r.REAL_WORLD_MAX_SIZE=30,r.REAL_WORLD_MIN_SIZE=12;var x=[255,255,255],D=[200,200,200],V=[128,128,128],E=20,M=5;r.getRampStops=b});