// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../nls/DatePicker","../../../intl","../../../moment","../../../core/events","../../../core/accessorSupport/decorators","../../Widget","./DatePickerViewModel","../../support/widget"],function(e,t,r,a,i,o,s,n,d,c,l,h){var p={base:"esri-date-picker esri-widget",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",openIcon:"esri-icon-down-arrow",closeIcon:"esri-icon-up-arrow",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",button:"esri-widget--button"},_={year:"numeric",month:"2-digit",day:"2-digit"},u=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"];return function(e){function t(t){var r=e.call(this)||this;return r._activeDate=null,r._calendarNode=null,r._closedByUserAction=!1,r._isOpen=!1,r._rootNode=null,r.value=null,r.viewModel=new l,r}return r(t,e),t.prototype.render=function(){var e,t=o.formatDate(this.viewModel.value.valueOf(),_),r=this._isOpen,a=(e={},e[p.openIcon]=!r,e[p.closeIcon]=r,e);return h.tsx("div",{afterCreate:h.storeNode,bind:this,class:p.base,"data-node-ref":"_rootNode"},h.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":r.toString(),bind:this,class:this.classes(p.button,p.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},h.tsx("span",{class:p.date},t),h.tsx("span",{"aria-hidden":"true",class:this.classes(a)})),r?this._renderCalendar():null)},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){"Escape"===n.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this.get("viewModel.value");return h.tsx("div",{afterCreate:h.storeNode,bind:this,class:p.datePicker,"data-node-ref":"_calendarNode",key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._handleDatePickerBlur=function(e){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()},t.prototype._renderMonthPicker=function(e){var t=s.months().map(function(t,r){var a=e.month()===r;return h.tsx("option",{selected:a},t)});return h.tsx("div",{class:p.monthPicker},h.tsx("div",{"aria-label":i.goToPreviousMonth,bind:this,class:p.button,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:i.goToPreviousMonth},h.tsx("span",{"aria-hidden":"true",class:p.previousIcon})),h.tsx("select",{"aria-live":"assertive",bind:this,class:p.monthDropdown,id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onkeydown:this._setMonth},t),h.tsx("div",{"aria-label":i.goToNextMonth,bind:this,class:p.button,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:i.goToNextMonth},h.tsx("span",{"aria-hidden":"true",class:p.nextIcon})))},t.prototype._renderDayPicker=function(e,t){var r=this,a=e.clone().day(s.localeData().firstDayOfWeek()),i=this._getWeekLabels(a),o=this._getDayId(e),n=this._renderMonth(e,t);return h.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":o,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,class:p.dayPicker,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},h.tsx("div",{class:p.week,role:"row"},i.map(function(e){return h.tsx("div",{"aria-label":e.name,class:r.classes(p.day,p.dayHeader),role:"columnheader",title:e.name},e.abbr)})),n)},t.prototype._getDayId=function(e){return this.id+"__"+o.formatDate(e.valueOf(),_)},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],r={weekday:"long"},a={weekday:"narrow"},i=0;i<7;i++)t.push({name:o.formatDate(e.valueOf(),r),abbr:o.formatDate(e.valueOf(),a)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.ctrlKey,r=e.shiftKey,a=n.eventKey(e),i=this._activeDate;if(-1!==u.indexOf(a)){if("ArrowLeft"===a)i.subtract(1,"day");else if("ArrowRight"===a)i.add(1,"day");else if("ArrowUp"===a)i.subtract(1,"week");else if("ArrowDown"===a)i.add(1,"week");else if("PageUp"===a){var o=r?"year":"month";i.subtract(1,o)}else if("PageDown"===a){var o=r?"year":"month";i.add(1,o)}else if("Home"===a){var o=t?"year":"month";i.startOf(o)}else if("End"===a){var o=t?"year":"month";i.endOf(o)}else"Enter"!==a&&" "!==a||(this.viewModel.value=i.clone(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var r,a=s(),i=s.localeData(),o=e.clone().startOf("month"),n=e.clone().endOf("month"),d=o.clone().subtract(o.weekday()-i.firstDayOfWeek(),"day"),c=d,l=[],_=0;_<6;_++){for(var u=[],y=0;y<7;y++){var v=c.date(),k=c.isSame(e,"day"),f=c.isSame(t,"day"),b=this._getDayId(c),w=(r={},r[p.nearbyMonth]=!c.isBetween(o,n,null,"[]"),r[p.today]=c.isSame(a,"day"),r[p.activeDay]=k,r[p.selectedDay]=f,r);u.push(h.tsx("div",{"aria-label":v.toString(),"aria-selected":k.toString(),bind:this,class:this.classes(p.day,w),"data-iso-date":c.toISOString(),id:b,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},v)),c.add(1,"day")}l.push(h.tsx("div",{class:p.week,role:"row"},u))}return l},t.prototype._renderYearPicker=function(e){var t={year:"numeric"},r=e.clone(),a=o.formatDate(r.valueOf(),t),s=o.formatDate(r.add(1,"year").valueOf(),t),n=o.formatDate(r.subtract(2,"year").valueOf(),t);return h.tsx("div",{class:p.yearPicker},h.tsx("div",{"aria-label":i.goToPreviousYear,bind:this,class:p.year,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:0,title:i.goToPreviousYear},n),h.tsx("div",{class:this.classes(p.year,p.selectedYear),id:this.id+"__selected-year"},a),h.tsx("div",{"aria-label":i.goToNextYear,bind:this,class:p.year,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onkeydown:this._setNextYear,tabIndex:0,title:i.goToNextYear},s))},t.prototype._toggle=function(){if(this._isOpen)return void this._close();this._open(this.viewModel.value.clone())},t.prototype._setMonth=function(e){var t=e.target,r=t.value;this._activeDate.month(r)},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1},t.prototype._open=function(e){this._activeDate=e,this._isOpen=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month")},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month")},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=s(t.getAttribute("data-iso-date")),this._closedByUserAction=!0,this._close()},a([d.aliasOf("viewModel.value")],t.prototype,"value",void 0),a([d.property({type:l}),h.renderable("viewModel.value")],t.prototype,"viewModel",void 0),a([h.accessibleHandler()],t.prototype,"_toggle",null),a([h.accessibleHandler()],t.prototype,"_setPreviousMonth",null),a([h.accessibleHandler()],t.prototype,"_setNextMonth",null),a([h.accessibleHandler()],t.prototype,"_setPreviousYear",null),a([h.accessibleHandler()],t.prototype,"_setNextYear",null),a([h.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=a([d.subclass("esri.widgets.Directions.support.DatePicker")],t)}(d.declared(c))});