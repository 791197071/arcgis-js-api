// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!../nls/common","dojo/i18n!./Bookmarks/nls/Bookmarks","../core/Handles","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./Bookmarks/BookmarksViewModel","./support/widget"],function(o,t,e,r,i,a,s,n,d,k,l,u){var m={base:"esri-bookmarks esri-widget--panel",loaderContainer:"esri-bookmarks__loader-container",loader:"esri-bookmarks__loader",fadeIn:"esri-bookmarks--fade-in",bookmarkList:"esri-bookmarks__list",bookmark:"esri-bookmarks__bookmark",bookmarkButton:"esri-bookmarks__bookmark-button",bookmarkImageContainer:"esri-bookmarks__bookmark-image-container",bookmarkIcon:"esri-bookmarks__bookmark-icon",bookmarkImage:"esri-bookmarks__image",bookmarkName:"esri-bookmarks__bookmark-name",bookmarkActive:"esri-bookmarks__bookmark--active",noBookmarksContainer:"esri-widget__content--empty",noBookmarksHeader:"esri-bookmarks__no-bookmarks-heading",noBookmarksIcon:"esri-widget__no-bookmark-icon",noBookmarksDescription:"esri-bookmarks__no-bookmarks-description",disabledContainer:"esri-bookmarks__disabled-container",disabledHeading:"esri-bookmarks__disabled-heading",disabledDescription:"esri-bookmarks__disabled-description",addingBookmark:"esri-bookmarks__adding-bookmark",addBookmark:"esri-bookmarks__add-bookmark",addBookmarkButton:"esri-bookmarks__add-bookmark-button",addBookmarkIcon:"esri-bookmarks__add-bookmark-icon",authoringCard:"esri-bookmarks__authoring-card",authoringForm:"esri-bookmarks__authoring-form",authoringLabel:"esri-bookmarks__authoring-label",authoringActions:"esri-bookmarks__authoring-actions",authoringInputInvalid:"esri-bookmarks__authoring-input--invalid",authoringDeleteButton:"esri-bookmarks__authoring-delete-button",authoringCancelButton:"esri-bookmarks__authoring-cancel-button",esriWidget:"esri-widget",esriButton:"esri-button",esriButtonTertiary:"esri-button--tertiary",esriInput:"esri-input",iconPlus:"esri-icon-plus",iconEdit:"esri-icon-edit",widgetIcon:"esri-icon-bookmark",header:"esri-widget__heading",disabled:"esri-disabled",loading:"esri-icon-loading-indicator",rotating:"esri-rotating"};return function(o){function t(t){var e=o.call(this)||this;return e._handles=new s,e._addInputNode=null,e._editInputNode=null,e._addBookmarkButtonNode=null,e._focusAddBookmarkButton=!1,e._addBookmark=!1,e._editBookmark=null,e._invalidEntry=!1,e._creatingBookmark=!1,e.bookmarks=null,e.editingEnabled=!1,e.goToOverride=null,e.iconClass=m.widgetIcon,e.label=a.widgetLabel,e.view=null,e.viewModel=new l,e}return e(t,o),t.prototype.postInitialize=function(){var o=this;this.own([n.init(this,"viewModel.bookmarks",function(){return o._bookmarksInitialized()})])},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null},t.prototype.goTo=function(o){return null},t.prototype.render=function(){var o,t=this.viewModel.state,e="disabled"===t?this._renderDisabled():"loading"===t?this._renderLoading():this._renderBookmarks(),r=(o={},o[m.disabled]="disabled"===t,o);return u.tsx("div",{class:this.classes(r,m.base,m.esriWidget)},e)},t.prototype._renderLoading=function(){return u.tsx("div",{class:m.loaderContainer,key:"loader"},u.tsx("div",{class:m.loader}))},t.prototype._renderDisabled=function(){return u.tsx("div",{key:"bookmarks-disabled",class:this.classes(m.noBookmarksContainer,m.disabledContainer)},u.tsx("h1",{class:m.header},a.disabledHeading),u.tsx("p",{class:m.disabledDescription},a.disabledDescription))},t.prototype._renderNoBookmarksContainer=function(){return u.tsx("div",{class:m.noBookmarksContainer,key:"no-bookmarks"},u.tsx("span",{"aria-hidden":"true",class:this.classes(m.noBookmarksIcon,m.widgetIcon)}),u.tsx("h1",{class:this.classes(m.header,m.noBookmarksHeader)},a.noBookmarksHeading),u.tsx("p",{class:m.noBookmarksDescription},a.noBookmarksDescription))},t.prototype._renderAddBookmarkLoading=function(){return u.tsx("li",{key:"adding-bookmark",class:m.addingBookmark},u.tsx("span",{"aria-hidden":"true",class:this.classes(m.loading,m.rotating)}),a.addingBookmark)},t.prototype._renderBookmarkItems=function(o){var t=this;return o?o.map(function(o){return t.editingEnabled&&t._editBookmark&&o&&t._editBookmark===o?t._renderEditingBookmark(o):t._renderBookmark(o)}).toArray():null},t.prototype._renderBookmarksContainer=function(o){var t=this.editingEnabled?this._creatingBookmark?this._renderAddBookmarkLoading():this._addBookmark?this._renderAddingBookmark():this._renderAddBookmarkButton():null;return u.tsx("ul",{key:"bookmark-list","aria-label":a.widgetLabel,class:m.bookmarkList},this._renderBookmarkItems(o),t)},t.prototype._renderAddBookmarkButton=function(){return u.tsx("li",{key:"add-bookmark-item",class:m.addBookmark},u.tsx("button",{class:this.classes(m.esriButton,m.esriButtonTertiary,m.addBookmarkButton),onclick:this._showAddBookmarkForm,afterCreate:this._storeAddBookmarkButton,afterUpdate:this._storeAddBookmarkButton,"data-node-ref":"_addBookmarkButtonNode",bind:this},u.tsx("span",{"aria-hidden":"true",class:this.classes(m.addBookmarkIcon,m.iconPlus)}),a.addBookmark))},t.prototype._renderBookmarks=function(){var o=this.viewModel.bookmarks,t=o&&o.filter(Boolean),e=t&&t.length,r=e||this.editingEnabled?this._renderBookmarksContainer(t):null;return[e?null:this._renderNoBookmarksContainer(),r]},t.prototype._renderBookmark=function(o){var t,e=this.viewModel.activeBookmark,r=o.name,a=o.thumbnail,s=r||i.untitled,n=(t={},t[m.bookmarkActive]=e===o,t),d=a&&a.url||"",k=d?u.tsx("img",{src:d,alt:"",class:m.bookmarkImage}):u.tsx("span",{"aria-hidden":"true",class:this.classes(m.bookmarkIcon,m.widgetIcon)}),l=u.tsx("div",{class:m.bookmarkImageContainer},k),c=this.editingEnabled?u.tsx("div",{key:"edit-container"},u.tsx("button",{title:i.edit,"aria-label":i.edit,"data-bookmark-item":o,onclick:this._showEditBookmarkForm,bind:this,class:this.classes(m.esriButton,m.esriButtonTertiary)},u.tsx("span",{"aria-hidden":"true",class:m.iconEdit}))):null;return u.tsx("li",{key:o,class:this.classes(m.bookmark,n)},u.tsx("button",{bind:this,"data-bookmark-item":o,onclick:this._goToBookmark,class:m.bookmarkButton},l,u.tsx("span",{class:m.bookmarkName},s),c))},t.prototype._renderEditingBookmark=function(o){return u.tsx("li",{key:"edit-bookmark-form",class:m.authoringCard},u.tsx("form",{class:m.authoringForm,onsubmit:this._editBookmarkSubmit,bind:this},u.tsx("label",{class:m.authoringLabel},a.title,u.tsx("input",{required:!0,bind:this,class:this.classes(m.esriInput,this._invalidEntry?m.authoringInputInvalid:null),type:"text",value:o.name,afterCreate:this._storeEditInput,afterUpdate:this._focusEditInput,"data-bookmark-item":o,"data-node-ref":"_editInputNode",placeholder:a.addPlaceholder})),u.tsx("div",{class:m.authoringActions},u.tsx("input",{type:"button",value:i.delete,class:this.classes(m.esriButton,m.esriButtonTertiary,m.authoringDeleteButton),"data-bookmark-item":o,onclick:this._deleteBookmark,bind:this}),u.tsx("input",{type:"button",value:i.cancel,class:this.classes(m.esriButton,m.esriButtonTertiary),onclick:this._hideEditBookmarkForm,bind:this}),u.tsx("input",{class:m.esriButton,type:"submit",value:i.save}))))},t.prototype._renderAddingBookmark=function(){return u.tsx("li",{key:"add-bookmark-form",class:m.authoringCard},u.tsx("form",{class:m.authoringForm,onsubmit:this._addBookmarkSubmit,bind:this},u.tsx("label",{class:m.authoringLabel},a.title,u.tsx("input",{required:!0,bind:this,class:this.classes(m.esriInput,this._invalidEntry?m.authoringInputInvalid:null),type:"text",afterCreate:this._storeAddInput,afterUpdate:this._focusAddInput,"data-node-ref":"_addInputNode",value:"",placeholder:a.addPlaceholder})),u.tsx("div",{class:this.classes(m.authoringActions)},u.tsx("input",{type:"button",value:i.cancel,class:this.classes(m.esriButton,m.esriButtonTertiary,m.authoringCancelButton),onclick:this._hideAddBookmarkForm,bind:this}),u.tsx("input",{class:m.esriButton,type:"submit",value:i.add}))))},t.prototype._bookmarksInitialized=function(){var o=this,t=this._handles;t.remove("bookmarks-init"),t.add(n.on(this,"viewModel.bookmarks","change",function(){return o._bookmarksChanged()}),"bookmarks-init")},t.prototype._bookmarksChanged=function(){var o=this,t=this.viewModel.bookmarks,e=this._handles;e.remove("bookmarks-change");var r=t.map(function(t){return n.watch(t,["active","name","thumbnail.url"],function(){return o.scheduleRender()})});e.add(r,"bookmarks-change"),this.scheduleRender()},t.prototype._showAddBookmarkForm=function(){this._editBookmark=null,this._addBookmark=!0,this.scheduleRender()},t.prototype._hideAddBookmarkForm=function(){this._invalidEntry=!1,this._addBookmark=!1,this._creatingBookmark=!1,this._focusAddBookmarkButton=!0,this.scheduleRender()},t.prototype._showEditBookmarkForm=function(o){o.stopPropagation();var t=o.currentTarget,e=t["data-bookmark-item"];this._addBookmark=!1,this._editBookmark=e,this.scheduleRender()},t.prototype._hideEditBookmarkForm=function(){this._invalidEntry=!1,this._editBookmark=null,this.scheduleRender()},t.prototype._addBookmarkSubmit=function(o){var t=this;o.preventDefault();var e=this._addInputNode,r=e&&e.value.trim();if(!r)return this._invalidEntry=!0,void this.scheduleRender();this._creatingBookmark=!0,this.scheduleRender(),this.viewModel.createBookmark().then(function(o){o.name=r,t.viewModel.bookmarks.add(o),t._hideAddBookmarkForm()})},t.prototype._editBookmarkSubmit=function(o){o.preventDefault();var t=this,e=t._editInputNode,r=t._editBookmark,i=e&&e.value.trim();if(!i)return this._invalidEntry=!0,void this.scheduleRender();r.name=i,this._hideEditBookmarkForm()},t.prototype._storeAddBookmarkButton=function(o){this._addBookmarkButtonNode=o,this._focusAddBookmark()},t.prototype._storeEditInput=function(o){this._editInputNode=o,this._focusEditInput()},t.prototype._storeAddInput=function(o){this._addInputNode=o,this._focusAddInput()},t.prototype._focusAddInput=function(){this._addInputNode&&this._addInputNode.focus()},t.prototype._focusAddBookmark=function(){this._addBookmarkButtonNode&&this._focusAddBookmarkButton&&(this._focusAddBookmarkButton=!1,this._addBookmarkButtonNode.focus())},t.prototype._focusEditInput=function(){this._editInputNode&&this._editInputNode.focus()},t.prototype._deleteBookmark=function(o){o.stopPropagation();var t=o.currentTarget,e=t["data-bookmark-item"];this.viewModel.bookmarks.remove(e)},t.prototype._goToBookmark=function(o){var t=o.currentTarget,e=t["data-bookmark-item"];this._hideAddBookmarkForm(),this._hideEditBookmarkForm(),this.viewModel.goTo(e)},r([d.aliasOf("viewModel.bookmarks")],t.prototype,"bookmarks",void 0),r([u.renderable(),d.property()],t.prototype,"editingEnabled",void 0),r([d.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),r([d.property()],t.prototype,"iconClass",void 0),r([d.property()],t.prototype,"label",void 0),r([d.aliasOf("viewModel.view")],t.prototype,"view",void 0),r([d.property({type:l}),u.renderable(["activeBookmark","state","bookmarks"]),u.vmEvent(["select-bookmark"])],t.prototype,"viewModel",void 0),r([d.aliasOf("viewModel.goTo")],t.prototype,"goTo",null),t=r([d.subclass("esri.widgets.Bookmarks")],t)}(d.declared(k))});