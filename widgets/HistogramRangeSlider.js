// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./HistogramRangeSlider/nls/HistogramRangeSlider","../Color","../core/Logger","../core/watchUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","./Histogram","./Slider","./Widget","./HistogramRangeSlider/HistogramRangeSliderViewModel","./smartMapping/support/utils","./support/widget"],function(e,t,a,r,i,n,o,l,s,d,u,p,c,h,g,v,m){var b={base:"esri-histogram-range-slider",sliderContainer:"esri-histogram-range-slider__slider-container",histogramContainer:"esri-histogram-range-slider__histogram-container",rangeTypePrefix:"esri-histogram-range-slider__range-type--",esriWidget:"esri-widget",widgetIcon:"esri-icon-edit",disabled:"esri-disabled"},y=l.getLogger("esri.widgets.HistogramRangeSlider");return function(e){function t(t){var a=e.call(this)||this;return a._barElements=[],a._histogram=null,a._slider=null,a.average=null,a.barCreatedFunction=null,a.bins=null,a.dataLines=null,a.dataLineCreatedFunction=null,a.excludedBarColor=new o("#d7e5f0"),a.hasTimeData=null,a.includedBarColor=new o("#599dd4"),a.label=n.widgetLabel,a.labelFormatFunction=null,a.max=null,a.min=null,a.precision=4,a.rangeType=null,a.standardDeviation=null,a.standardDeviationCount=1,a.values=null,a.viewModel=new g,a}return r(t,e),t.prototype.postInitialize=function(){var e=this,t=this,r=t.average,i=t.bins,n=t.hasTimeData,o=t.max,l=t.min,d=t.viewModel;this._updateBarFill=this._updateBarFill.bind(this),this._histogram=new p({average:r,bins:i,barCreatedFunction:function(t,a){0===t&&(e._barElements=[]),e._barElements.push(a),e._updateBarFill(t,a),e.barCreatedFunction&&e.barCreatedFunction(t,a)},dataLines:this._getDataLines(),dataLineCreatedFunction:function(t,a){e.dataLineCreatedFunction&&e.dataLineCreatedFunction(t,a)},labelFormatFunction:this.labelFormatFunction,layout:"horizontal",max:o,min:l}),this._slider=new c({labelFormatFunction:this.labelFormatFunction,layout:"horizontal",labelsVisible:!0,rangeLabelsVisible:!0,rangeLabelInputsEnabled:!n,viewModel:d}),this.own(this._slider.on(["max-change","min-change"],function(t){return e.emit(t.type,t)}),this._slider.on(["segment-drag"],function(t){e.hasEventListener("values-change")&&(y.warn("'values-change' is deprecated, watch the 'values' property instead."),e.emit("values-change",a({},t,{type:"values-change"}))),e._updateBarFills(),e.emit(t.type,t)}),this._slider.on(["thumb-change","thumb-drag"],function(t){e.hasEventListener("value-change")&&(y.warn("'value-change' is deprecated, watch the 'values' property instead."),e.emit("value-change",a({},t,{type:"value-change"}))),e._updateBarFills(),e.emit(t.type,t)}),s.watch(this,"bins",function(){var t=e,a=t._histogram,r=t.bins;if(r&&a.bins){var i=a.bins.length-r.length;e._barElements.splice(-i,i)}else e._barElements=[];a.set({bins:r}),e._updateBarFills(),e.scheduleRender()}),s.watch(this,["max","min","rangeType","values"],function(){var t=e,a=t._histogram,r=t.max,i=t.min;a.set({max:r,min:i}),e._updateBarFills(),e.scheduleRender()}),s.watch(this,["average","dataLines","standardDeviation","standardDeviationCount"],function(){var t=e,a=t._histogram,r=t.average;a.set({average:r,dataLines:e._getDataLines()})}),s.watch(this,"labelFormatFunction",function(){var t=e,a=t._histogram,r=t.labelFormatFunction;a.set({labelFormatFunction:r})}),s.watch(this,"hasTimeData",function(){e._slider.set({rangeLabelInputsEnabled:!e.hasTimeData})}))},t.prototype.generateWhereClause=function(e){return this.viewModel.generateWhereClause(e)},t.prototype.render=function(){var e=this,t=e.rangeType,a=e.viewModel,r=e.label,i=this.classes(b.base,b.esriWidget,""+b.rangeTypePrefix+t,"disabled"===a.state?b.disabled:null);return m.tsx("div",{"aria-label":r,class:i},"disabled"===a.state?null:this.renderContent())},t.prototype.renderContent=function(){return[this.renderHistogram(),this.renderSlider()]},t.prototype.renderSlider=function(){return m.tsx("div",{key:this.id+"-slider-container",class:b.sliderContainer},this._slider.render())},t.prototype.renderHistogram=function(){return m.tsx("div",{class:b.histogramContainer},this._histogram.render())},t.prototype._getDataLines=function(){return this._getStandardDeviationDataLines().concat(this.dataLines||[])},t.prototype._getStandardDeviationDataLines=function(){var e=this,t=e.average,a=e.standardDeviation,r=e.standardDeviationCount;return v.getDeviationValues(a,t,r).map(function(e){return{value:e}})},t.prototype._updateBarFills=function(){var e=this;this._barElements.forEach(function(t,a){return e._updateBarFill(a,t)})},t.prototype._updateBarFill=function(e,t){t.setAttribute("fill",this._getFillForBar(e).toHex())},t.prototype._getFillForBar=function(e){var t=this,a=t.bins,r=t.rangeType,i=t.values;if(!(a&&a.length&&r&&i.length))return null;var n=a[e];if(!n)return null;var o=n.maxValue,l=n.minValue,s=o-l;switch(r){case"equal":case"not-equal":return this.includedBarColor;case"less-than":case"at-most":return i[0]>l&&i[0]<o?this._getBlendedColor((i[0]-l)/s):l<i[0]?this.includedBarColor:this.excludedBarColor;case"greater-than":case"at-least":return i[0]>l&&i[0]<o?this._getBlendedColor(1-(i[0]-l)/s):l>i[0]?this.includedBarColor:this.excludedBarColor;case"between":if(2===i.length)return i[0]>l&&i[0]<o?this._getBlendedColor(1-(i[0]-l)/s):i[1]>l&&i[1]<o?this._getBlendedColor((i[1]-l)/s):l>=i[0]&&o<=i[1]?this.includedBarColor:this.excludedBarColor;case"not-between":if(2===i.length)return i[0]>l&&i[0]<o?this._getBlendedColor((i[0]-l)/s):i[1]>l&&i[1]<o?this._getBlendedColor(1-(i[1]-l)/s):l>i[0]&&o<i[1]?this.excludedBarColor:this.includedBarColor;default:return this.includedBarColor}},t.prototype._getBlendedColor=function(e){return o.blendColors(this.excludedBarColor,this.includedBarColor,e)},i([d.aliasOf("viewModel.average")],t.prototype,"average",void 0),i([d.property(),m.renderable()],t.prototype,"barCreatedFunction",void 0),i([d.aliasOf("viewModel.bins")],t.prototype,"bins",void 0),i([d.property(),m.renderable()],t.prototype,"dataLines",void 0),i([d.property(),m.renderable()],t.prototype,"dataLineCreatedFunction",void 0),i([d.property({type:o,json:{type:[u.Integer],write:!0}})],t.prototype,"excludedBarColor",void 0),i([d.aliasOf("viewModel.hasTimeData")],t.prototype,"hasTimeData",void 0),i([d.property({type:o,json:{type:[u.Integer],write:!0}})],t.prototype,"includedBarColor",void 0),i([d.property()],t.prototype,"label",void 0),i([d.aliasOf("viewModel.labelFormatFunction")],t.prototype,"labelFormatFunction",void 0),i([d.aliasOf("viewModel.max")],t.prototype,"max",void 0),i([d.aliasOf("viewModel.min")],t.prototype,"min",void 0),i([d.aliasOf("viewModel.precision")],t.prototype,"precision",void 0),i([d.aliasOf("viewModel.rangeType")],t.prototype,"rangeType",void 0),i([d.aliasOf("viewModel.standardDeviation")],t.prototype,"standardDeviation",void 0),i([d.property(),m.renderable()],t.prototype,"standardDeviationCount",void 0),i([m.renderable(),d.aliasOf("viewModel.values")],t.prototype,"values",void 0),i([d.property(),m.renderable(["viewModel.average","viewModel.hasTimeData","viewModel.labelFormatFunction","viewModel.max","viewModel.min","viewModel.precision","viewModel.rangeType","viewModel.standardDeviation","viewModel.values"])],t.prototype,"viewModel",void 0),t=i([d.subclass("esri.widgets.HistogramRangeSlider")],t)}(d.declared(h))});