// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/i18n!./Feature/nls/Feature","../intl","../core/events","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./Feature/FeatureViewModel","./Feature/support/attachmentUtils","./support/chartUtils","./support/uriUtils","./support/widget","./support/widgetUtils"],function(e,t,i,a,n,r,s,o,l,d,c,m,u,p,h,f,_){var v={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",showMediaPagination:"esri-feature--media-pagination-visible",attachments:"esri-feature__attachments",attachmentsList:"esri-feature__attachments--list",attachmentsPreview:"esri-feature__attachments--preview",attachmentsTitle:"esri-feature__attachments-title",attachmentsItems:"esri-feature__attachments-items",attachmentsItem:"esri-feature__attachments-item",attachmentsItemMask:"esri-feature__attachment-item-mask",attachmentsItemMaskIcon:"esri-feature__attachment-item-mask--icon",attachmentsItemImage:"esri-feature__attachments-image",attachmentsItemImageOverlay:"esri-feature__attachments-image-overlay",attachmentsItemLinkIcon:"esri-feature__attachments-link-icon esri-icon-link-external",attachmentsItemImageResizable:"esri-feature__attachments-image--resizable",attachmentsItemFilename:"esri-feature__attachments-filename",attachmentsItemLink:"esri-feature__attachments-item-link",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",media:"esri-feature__media",mediaContainer:"esri-feature__media-container",mediaItemContainer:"esri-feature__media-item-container",mediaItem:"esri-feature__media-item",mediaItemTitle:"esri-feature__media-item-title",mediaItemCaption:"esri-feature__media-item-caption",mediaPrevious:"esri-feature__media-previous",mediaPreviousIconLTR:"esri-feature__media-previous-icon",mediaPreviousIconRTL:"esri-feature__media-previous-icon--rtl",mediaNext:"esri-feature__media-next",mediaNextIconLTR:"esri-feature__media-next-icon",mediaNextIconRTL:"esri-feature__media-next-icon--rtl",mediaChart:"esri-feature__media-chart",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},y={title:!0,content:!0,lastEditedInfo:!0};return function(e){function t(t){var i=e.call(this)||this;return i._chartMap=new Map,i._activeMediaMap=new Map,i._refreshTimers=new Map,i._mediaInfo=new Map,i.graphic=null,i.defaultPopupTemplateEnabled=!1,i.spatialReference=null,i.title=null,i.visibleElements=n({},y),i.map=null,i.view=null,i.viewModel=new m,i}return i(t,e),t.prototype.postInitialize=function(){var e=this;this.own(l.init(this,"viewModel.content",function(){return e._setupMediaRefreshTimers()}))},t.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._destroyCharts()},t.prototype.castVisibleElements=function(e){return n({},y,e)},t.prototype.render=function(){var e=f.tsx("div",{key:"loading-container",class:v.loadingSpinnerContainer},f.tsx("span",{class:this.classes(v.iconLoading,v.spinner)})),t=this.visibleElements,i=this.viewModel,a=i.waitingForContent,n=i.title,r=t.title?f.tsx("h4",{class:v.title,innerHTML:n}):null,s=t.content?f.tsx("div",{class:v.main},[this._renderContent(),this._renderLastEditInfo()]):null;return f.tsx("div",{class:this.classes(v.base,v.esriWidget)},f.tsx("div",{class:v.container},r,a?e:s))},t.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},t.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},t.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},t.prototype._buildKey=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return e+"__"+(this.get("viewModel.graphic.uid")||"0")+"-"+t.join("-")},t.prototype._destroyCharts=function(){this._chartMap.forEach(function(e){return e.dispose()}),this._chartMap.clear()},t.prototype._renderContent=function(){var e=this.viewModel.content;return e?"string"==typeof e?f.tsx("div",{key:"content-string",innerHTML:e}):f.isWidget(e)?f.tsx("div",{key:"content-widget"},e.render()):e instanceof HTMLElement?f.tsx("div",{key:"content-html-element",bind:e,afterCreate:this._attachToNode}):f.isWidgetBase(e)?f.tsx("div",{key:"content-dijit",bind:e.domNode,afterCreate:this._attachToNode}):Array.isArray(e)?e.length?f.tsx("div",{key:"content-content-elements"},e.map(this._renderContentElement,this)):null:void 0:null},t.prototype._renderContentElement=function(e,t){var i=this.visibleElements;if("boolean"!=typeof i.content&&!i.content[e.type])return null;switch(e.type){case"attachments":return this._renderAttachments(e,t);case"fields":return this._renderFields(e,t);case"media":return this._renderMedia(e,t);case"text":return this._renderText(e,t);default:return null}},t.prototype._renderAttachmentInfo=function(e){var t,i,a=e.attachmentInfo,n=e.supportsResizeAttachments,s=e.contentElement,o=s.displayType,l=a.contentType,d=a.orientationInfo,c=a.name,m=a.url,p="preview"===o?128:48,h=d?[d.rotation?"rotate("+d.rotation+"deg)":"",d.mirrored?"scaleX(-1)":""].join(" "):"",_=h?{transform:h}:{},y=n&&u.isSupportedImage(l),x=-1===m.indexOf("?")?"?":"&",g=y?""+m+x+"w="+p:u.getIconPath(l),M=(t={},t[v.attachmentsItemMaskIcon]=!y,t),I=(i={},i[v.attachmentsItemImageResizable]=n,i);return f.tsx("li",{class:v.attachmentsItem,key:a},f.tsx("a",{class:v.attachmentsItemLink,href:m,target:"_blank"},f.tsx("div",{class:this.classes(M,v.attachmentsItemMask)},f.tsx("img",{styles:_,alt:"",class:this.classes(I,v.attachmentsItemImage),src:g}),f.tsx("span",{class:v.attachmentsItemImageOverlay},f.tsx("span",{"aria-hidden":"true",class:v.attachmentsItemLinkIcon}))),f.tsx("span",{class:v.attachmentsItemFilename},c||r.noTitle)))},t.prototype._renderAttachments=function(e,t){var i,a=this,n=e.displayType,s=e.attachmentInfos,o=s&&s.length,l=this.get("graphic.layer.capabilities.operations.supportsResizeAttachments"),d=(i={},i[v.attachmentsList]="preview"!==n,i[v.attachmentsPreview]="preview"===n,i);return o?f.tsx("div",{key:"attachments-element",class:this.classes(v.attachments,v.contentElement,d)},f.tsx("div",{class:v.attachmentsTitle},r.attach),f.tsx("ul",{class:v.attachmentsItems},s.map(function(t,i){return a._renderAttachmentInfo({attachmentInfo:t,attachmentInfoIndex:i,supportsResizeAttachments:l,contentElement:e})}))):null},t.prototype._forceLTR=function(e){return"&lrm;"+e},t.prototype._renderFieldInfo=function(e,t){var i,a=this.viewModel.formattedAttributes,n=a?a.content[t]||a.global:null,r=e.fieldName,s=e.label||r,o=n?null==n[r]?"":n[r]:"",l=!(!e.format||!e.format.dateFormat),d="number"==typeof o&&!l,c=d?this._forceLTR(o):h.autoLink(o),m=(i={},i[v.fieldDataDate]=l,i);return f.tsx("tr",{key:this._buildKey("fields-element-info-row",t)},f.tsx("th",{key:this._buildKey("fields-element-info-row-header",t),class:v.fieldHeader,innerHTML:s}),f.tsx("td",{key:this._buildKey("fields-element-info-row-data",t),class:this.classes(v.fieldData,m),innerHTML:c}))},t.prototype._renderFields=function(e,t){var i=this,a=e.fieldInfos;return a?f.tsx("div",{key:this._buildKey("fields-element",t),class:this.classes(v.fields,v.contentElement)},f.tsx("table",{class:v.esriTable,summary:r.fieldsSummary,key:this._buildKey("fields-element-table",t)},f.tsx("tbody",{key:this._buildKey("fields-element-table-body",t)},a.map(function(e){return i._renderFieldInfo(e,t)})))):null},t.prototype._shouldOpenInNewTab=function(e){if(void 0===e&&(e=""),e){return!/^(?:mailto:|tel:)/.test(e.trim().toLowerCase())}},t.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(e){return clearTimeout(e)}),this._refreshTimers.clear()},t.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers.delete(e))},t.prototype._getImageSource=function(e,t){var i=-1!==e.indexOf("?")?"&":"?",a=e.split("#"),n=a[0],r=a[1],s=void 0===r?"":r;return""+n+i+"timestamp="+t+(s?"#":"")+s},t.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var i=t[e];if(i&&"media"===i.type){var a=this._activeMediaMap.get(e);isNaN(a)&&(a=0);var n=i.mediaInfos[a];n&&"image"===n.type&&n.refreshInterval&&this._setRefreshTimeout(e,n)}}},t.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach(function(t,i){return e._setupMediaRefreshTimer(i)})},t.prototype._updateMediaInfoTimestamp=function(e,t){var i=Date.now();this._mediaInfo.set(t,{timestamp:i,sourceURL:this._getImageSource(e,i)}),this.scheduleRender()},t.prototype._setRefreshTimeout=function(e,t){var i=this,a=t.refreshInterval,n=t.value;if(a){var r=6e4*a;this._updateMediaInfoTimestamp(n.sourceURL,e);var s=setInterval(function(){i._updateMediaInfoTimestamp(n.sourceURL,e)},r);this._refreshTimers.set(e,s)}},t.prototype._renderMediaInfoType=function(e){var t=e.mediaInfo,i=e.contentElementIndex,a=e.activeMediaIndex,n=t.title,r=void 0===n?"":n;if("image"===t.type){var s=t,o=s.value,l=s.refreshInterval,d=o.sourceURL,c=o.linkURL,m=this._shouldOpenInNewTab(c),u=m?"_blank":"_self",p=l?this._mediaInfo.get(i):null,h=p?p.timestamp:0,_=p?p.sourceURL:d,y=f.tsx("img",{alt:r,key:this._buildKey("media-image",i,a,h),src:_}),x=c?f.tsx("a",{title:r,href:c,target:u},y):null;return x||y}if(-1!==t.type.indexOf("chart"))return f.tsx("div",{key:this._buildKey("media-chart",i,a),bind:this,"data-media-info":t,"data-content-element-index":i,class:v.mediaChart,afterCreate:this._getChartDependencies})},t.prototype._getChartDependencies=function(e){var t=this,i=e["data-media-info"],a=e["data-content-element-index"],n=i.value,r=i.type;p.loadChartsModule().then(function(i){t._renderChart({chartDiv:e,contentElementIndex:a,type:r,value:n,chartsModule:i})})},t.prototype._createPieChart=function(e){var t=e.chartDiv,i=e.chartsModule,a=i.am4core,n=i.am4charts,r=a.create(t,n.PieChart);r.rtl=_.isRTL();var s=r.series.push(new n.PieSeries);return s.labels.template.disabled=!0,s.ticks.template.disabled=!0,s.dataFields.value="y",s.dataFields.category="x",s.tooltip.label.wrap=!0,s.tooltip.label.maxWidth=150,s.tooltip.label.rtl=r.rtl,r},t.prototype._createXYChart=function(e){var t=e.chartDiv,i=e.type,a=e.value,n=e.chartsModule,r=n.am4core,s=n.am4charts,o=r.create(t,s.XYChart);o.rtl=_.isRTL();var l=a.series.length>15;if("column-chart"===i){var d=o.xAxes.push(new s.CategoryAxis);d.dataFields.category="x",d.renderer.labels.template.disabled=!0,d.tooltip.label.wrap=!0,d.tooltip.label.maxWidth=125,d.tooltip.label.rtl=o.rtl,d.tooltip.events.on("sizechanged",function(){d.tooltip.dy=-d.tooltip.contentHeight}),o.yAxes.push(new s.ValueAxis);var c=o.series.push(new s.ColumnSeries);c.dataFields.valueY="y",c.dataFields.categoryX="x",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new r.Scrollbar)}if("bar-chart"===i){var m=o.yAxes.push(new s.CategoryAxis);m.dataFields.category="x",m.renderer.inversed=!0,m.renderer.labels.template.disabled=!0,m.tooltip.label.wrap=!0,m.tooltip.label.maxWidth=125,m.tooltip.label.rtl=o.rtl,m.tooltip.events.on("sizechanged",function(){m.tooltip.dx=m.tooltip.contentWidth}),o.xAxes.push(new s.ValueAxis);var c=o.series.push(new s.ColumnSeries);c.dataFields.valueX="y",c.dataFields.categoryY="x",o.cursor=new s.XYCursor,l&&(o.scrollbarY=new r.Scrollbar)}if("line-chart"===i){var u=o.xAxes.push(new s.CategoryAxis);u.dataFields.category="x",u.renderer.labels.template.disabled=!0,u.tooltip.label.wrap=!0,u.tooltip.label.maxWidth=125,u.tooltip.label.rtl=o.rtl,u.tooltip.events.on("sizechanged",function(){u.tooltip.dy=-u.tooltip.contentHeight}),o.yAxes.push(new s.ValueAxis);var c=o.series.push(new s.LineSeries);c.dataFields.categoryX="x",c.dataFields.valueY="y",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new r.Scrollbar)}return o},t.prototype._renderChart=function(e){var t=e.contentElementIndex,i=e.type,a=e.value,n=e.chartsModule;n.am4core.useTheme(n.am4themes_animated);var r="pie-chart"===i?this._createPieChart(e):this._createXYChart(e);r.data=a.series.map(function(e){return{x:e.tooltip,y:e.y}}),this._chartMap.set(t,r)},t.prototype._renderMediaInfo=function(e){var t=e.mediaInfo,i=e.contentElementIndex,a=e.activeMediaIndex,n=this._renderMediaInfoType({mediaInfo:t,contentElementIndex:i,activeMediaIndex:a}),r=t.title?f.tsx("div",{key:this._buildKey("media-title",i),class:v.mediaItemTitle,innerHTML:t.title}):null,s=t.caption?f.tsx("div",{key:this._buildKey("media-caption",i),class:v.mediaItemCaption,innerHTML:t.caption}):null;return f.tsx("div",{key:this._buildKey("media-container",i),class:v.mediaItemContainer},f.tsx("div",{key:this._buildKey("media-item-container",i),class:v.mediaItem},n),r,s)},t.prototype._renderMediaPageButton=function(e,t){var i="previous"===e,a=i?r.previous:r.next,n=i?this.classes(v.btn,v.mediaPrevious):this.classes(v.btn,v.mediaNext),s=i?this.classes(v.icon,v.mediaPreviousIconLTR,v.iconLeftTriangleArrow):this.classes(v.icon,v.mediaNextIconLTR,v.iconRightTriangleArrow),o=i?this.classes(v.icon,v.mediaPreviousIconRTL,v.iconRightTriangleArrow):this.classes(v.icon,v.mediaNextIconRTL,v.iconLeftTriangleArrow),l=i?"media-previous":"media-next",d=i?this._previousClick:this._nextClick;return f.tsx("div",{key:this._buildKey(l,t),title:a,tabIndex:0,role:"button",class:n,"data-content-element-index":t,bind:this,onkeydown:d,onclick:d},f.tsx("span",{"aria-hidden":"true",class:s}),f.tsx("span",{"aria-hidden":"true",class:o}),f.tsx("span",{class:v.iconText},a))},t.prototype._handleMediaKeyup=function(e){var t=e.currentTarget,i=t["data-content-element-index"],a=o.eventKey(e);"ArrowLeft"===a&&(e.stopPropagation(),this.previousMedia(i)),"ArrowRight"===a&&(e.stopPropagation(),this.nextMedia(i))},t.prototype._renderMedia=function(e,t){var i,a=e.mediaInfos,n=a&&a.length||0,r=(i={},i[v.showMediaPagination]=n>1,i),s=this._renderMediaPageButton("previous",t),o=this._renderMediaPageButton("next",t),l=this._activeMediaMap.get(t);return isNaN(l)&&(this._activeMediaMap.set(t,0),l=0),n?f.tsx("div",{key:this._buildKey("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes(v.media,v.contentElement,r)},f.tsx("div",{key:this._buildKey("media-element-container",t),class:v.mediaContainer},s,this._renderMediaInfo({mediaInfo:a[l],contentElementIndex:t,activeMediaIndex:l}),o)):null},t.prototype._renderLastEditInfo=function(){var e=this.visibleElements,t=this.viewModel.lastEditInfo;if(!t||!e.lastEditedInfo)return null;var i=t.date,a=t.user,n="edit"===t.type?a?r.lastEditedByUser:r.lastEdited:a?r.lastCreatedByUser:r.lastCreated,o=s.substitute(n,{date:i,user:a});return f.tsx("div",{key:"edit-info-element",class:this.classes(v.lastEditedInfo,v.contentElement)},o)},t.prototype._renderText=function(e,t){return e.text?f.tsx("div",{key:this._buildKey("text-element",t),innerHTML:e.text,class:this.classes(v.text,v.contentElement)}):null},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var i=this.viewModel.content,a=i&&i[e],n=a&&a.mediaInfos;if(n&&n.length){var r=(t+n.length)%n.length;this._activeMediaMap.set(e,r),this._setupMediaRefreshTimer(e),this.scheduleRender()}},t.prototype._pageContentElementMedia=function(e,t){var i="previous"===t?-1:1,a=this._activeMediaMap.get(e)+i;this._setContentElementMedia(e,a)},t.prototype._previousClick=function(e){var t=e.currentTarget,i=t["data-content-element-index"];this.previousMedia(i)},t.prototype._nextClick=function(e){var t=e.currentTarget,i=t["data-content-element-index"];this.nextMedia(i)},a([d.aliasOf("viewModel.graphic")],t.prototype,"graphic",void 0),a([d.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),a([d.aliasOf("viewModel.spatialReference")],t.prototype,"spatialReference",void 0),a([d.aliasOf("viewModel.title")],t.prototype,"title",void 0),a([d.property(),f.renderable()],t.prototype,"visibleElements",void 0),a([d.cast("visibleElements")],t.prototype,"castVisibleElements",null),a([d.aliasOf("viewModel.map")],t.prototype,"map",void 0),a([d.aliasOf("viewModel.view")],t.prototype,"view",void 0),a([d.property({type:m}),f.renderable(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo"])],t.prototype,"viewModel",void 0),a([f.accessibleHandler()],t.prototype,"_previousClick",null),a([f.accessibleHandler()],t.prototype,"_nextClick",null),t=a([d.subclass("esri.widgets.Feature")],t)}(d.declared(c))});