// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../Graphic","../../core/Handles","../../core/accessorSupport/decorators","../../geometry/geometryEngine","../../geometry/Point","../../geometry/Polygon","../../geometry/Polyline","../../geometry/projection","../../geometry/SpatialReference","../../geometry/support/geodesicUtils","../../layers/GraphicsLayer","../../symbols/SimpleMarkerSymbol","../../views/2d/draw/Draw","../../views/interactive/GraphicManipulator","../../views/interactive/InteractiveToolBase","../../views/interactive/interactiveToolUtils"],function(e,t,r,i,o,s,a,n,p,c,l,h,d,u,y,m,v,f,g,w){function _(e,t,r,i){var s=new m({style:"circle",color:i.handleColor,size:i.handleWidth,outline:{type:"simple-line",width:0}}),a=new m({style:"circle",color:i.handleColor,size:1.5*i.handleWidth,outline:{type:"simple-line",width:0}}),n=new o({geometry:e,symbol:s});return new f.GraphicManipulator({view:t,layer:r,graphic:n,focusedSymbol:a})}return function(e){function t(t){var r=e.call(this,t)||this;return r._drawActive=!1,r._handles=new s,r._graphicsLayer=new y({listMode:"hide"}),r._manipulatorLayer=new y({listMode:"hide"}),r._vertices=[],r}r(t,e),m=t,t.prototype.initialize=function(){var e=this;this._draw=new v({view:this.view});var t=this.view;t.map.addMany([this._graphicsLayer,this._manipulatorLayer]),t.focus(),this._handles.add(this.watch(["viewModel.unit","viewModel.mode"],function(){e._updateGraphics()})),this.projectionEngineRequired&&this.projectionEngineSupported&&(h.isLoaded()||h.load())},t.prototype.destroy=function(){this.detach(),this._handles.removeAll(),this._graphicsLayer.removeAll(),this.viewModel.view.map.remove(this._graphicsLayer),this.viewModel.view.map.remove(this._manipulatorLayer),this.viewModel.measurement=null,this._draw&&(this._draw.destroy(),this._draw=null),this._handles&&(this._handles.destroy(),this._handles=null),this._graphicsLayer&&(this._graphicsLayer.destroy(),this._graphicsLayer=null),this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)},Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),e||this._draw.reset()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"projectionEngineRequired",{get:function(){if(!this.view||!this.view.spatialReference)return!1;var e=this.view.spatialReference;return!e.isWebMercator&&!e.isWGS84&&!u.isSupported(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"projectionEngineSupported",{get:function(){return h.isSupported()},enumerable:!0,configurable:!0}),t.prototype.onShow=function(){this._graphicsLayer.visible=!0},t.prototype.onHide=function(){this._graphicsLayer.visible=!1},t.prototype.reset=function(){this._vertices=[],this._graphicsLayer.removeAll(),this.viewModel.measurement=null,this._draw.reset(),this._drawActive=!1,this._updateSketch([])},t.prototype.newMeasurement=function(){this.reset(),w.setActive(this,!0),this._startSketch()},t.prototype.clearMeasurement=function(){this.reset(),w.setActive(this,!1),this.cursor=null},t.updateViewModelAndCreateGraphics=function(e,t,r,i,s,a){var p=[];if(2===e.length){var y=new l({paths:[e.map(function(e){return e.coord})],spatialReference:t});if(r&&(y=h.project(y,d.WGS84)),i||r)y=u.geodesicDensify(y,1e5);else{var m=n.geodesicLength(y,"meters");("geodesic"===s.mode||"auto"===s.mode&&m>=s.geodesicDistanceThreshold)&&(y=n.geodesicDensify(y,1e5,"meters"))}p.push(new o({geometry:y,symbol:{type:"simple-line",color:a.pathColor,width:a.pathWidth}}))}else{e.push(e[0]);var v=e.map(function(e){return e.coord}),f=new l({paths:[v],spatialReference:t}),g=new c({rings:[v],spatialReference:t});if(r&&(g=h.project(g,d.WGS84),f=h.project(f,d.WGS84)),i||r)g=u.geodesicDensify(g,1e5),f=u.geodesicDensify(f,1e5),g=n.simplify(g),s.measurement={geometry:g,area:u.geodesicAreas([g],"square-meters")[0],perimeter:u.geodesicLengths([g],"meters")[0]};else{var w=n.planarLength(g,"meters");"geodesic"===s.mode||"auto"===s.mode&&w>=s.geodesicDistanceThreshold?(g=n.geodesicDensify(g,1e5,"meters"),f=n.geodesicDensify(f,1e5,"meters"),g=n.simplify(g),s.measurement={geometry:g,area:n.geodesicArea(g,"square-meters"),perimeter:n.geodesicLength(g,"meters")}):(g=n.simplify(g),s.measurement={geometry:g,area:n.planarArea(g,"square-meters"),perimeter:w})}p.push(new o({geometry:g,symbol:{type:"simple-fill",style:"solid",color:a.fillColor,outline:{type:"simple-line",width:0}}})),p.push(new o({geometry:f,symbol:{type:"simple-line",style:"solid",color:a.pathColor,width:a.pathWidth}})),p.push(new o({geometry:g.centroid,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:s.measurementLabel.area,font:{size:14,family:"sans-serif"}}}))}return p},t.prototype.onInputEvent=function(e){"pointer-move"===e.type&&this._updateCursor()},t.prototype._startSketch=function(){var e=this;this._drawActive=!0;var t=this._draw.create("polyline",{mode:"click"});t.on("vertex-add",function(t){return e._updateSketch(t.vertices)}),t.on("vertex-update",function(t){return e._updateSketch(t.vertices)}),t.on("vertex-remove",function(t){return e._updateSketch(t.vertices)}),t.on("cursor-update",function(t){return e._updateSketch(t.vertices)}),t.on("undo",function(t){return e._updateSketch(t.vertices)}),t.on("redo",function(t){return e._updateSketch(t.vertices)}),t.on("draw-complete",function(){return e._stopSketch()})},t.prototype._stopSketch=function(){this.manipulators.forEach(function(e){e.manipulator.interactive=!0}),w.setActive(this,!1),this._drawActive=!1},t.prototype._updateSketch=function(e){var t=this;if(!this.projectionEngineRequired||h.isLoaded()){if(e.length<2)return this._vertices=[],this.manipulators.removeAll(),void this._graphicsLayer.removeAll();for(var r=this.view.spatialReference;this._vertices.length>e.length;){var i=this._vertices.pop().manipulatorId;this.manipulators.remove(i)}for(var o=this,s=this._vertices.length;s<e.length;s++)!function(i){var s=e[i],a=s[0],n=s[1],c=new p({x:a,y:n,spatialReference:r}),l=_(c,o.view,o._manipulatorLayer,o.viewModel.palette),h=o.manipulators.add(l);l.on("drag",function(){var e=l.graphic.geometry;t._vertices[i].coord=[e.x,e.y],t._updateGraphics()}),o._vertices.push({manipulatorId:h,coord:[a,n]})}(s);var a=this._vertices.length-1,n=this._vertices[a],c=e[a],l=c[0],d=c[1];if(n.coord[0]!==l||n.coord[1]!==d){n.coord=[l,d];var u=new p({x:l,y:d,spatialReference:r});this.manipulators.findById(n.manipulatorId).graphic.geometry=u}var y=this._drawActive?this._vertices[a].manipulatorId:null;this.manipulators.forEach(function(e){e.manipulator.interactive=null==y||e.id!==y}),this._updateGraphics()}},t.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null},t.prototype._updateGraphics=function(){this._graphicsLayer.removeAll();var e=this._vertices.slice(),t=this.viewModel,r=t.palette,i=t.view.spatialReference,o=u.isSupported(i),s=!o&&!i.isWebMercator&&!i.isWGS84,a=m.updateViewModelAndCreateGraphics(e,i,s,o,t,r);this._graphicsLayer.addMany(a)};var m;return i([a.property({constructOnly:!0})],t.prototype,"view",void 0),i([a.property({constructOnly:!0})],t.prototype,"viewModel",void 0),i([a.property()],t.prototype,"cursor",void 0),i([a.property({value:!0})],t.prototype,"editable",null),i([a.property({dependsOn:["view.spatialReference"],readOnly:!0})],t.prototype,"projectionEngineRequired",null),i([a.property({readOnly:!0})],t.prototype,"projectionEngineSupported",null),t=m=i([a.subclass("esri.widgets.AreaMeasurement2D.AreaMeasurement2DTool")],t)}(a.declared(g.InteractiveToolBase))});