// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/Collection","../core/Handles","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./LayerList/LayerListViewModel","./LayerList/ListItem","./support/widget"],function(e,t,i,n,s,o,l,r,a,c,d,p,u,g,h){function y(e){var t=e.actionsOpen,i=e.children;t&&(e.actionsOpen=!1),i.forEach(function(e){return y(e)})}var _=r.ofType(g),m={base:"esri-layer-list esri-widget esri-widget--panel",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemContent:"esri-layer-list__item-content",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemSelectable:"esri-layer-list__item--selectable",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actionsMenuItemActive:"esri-layer-list__item-actions-menu-item--active",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",actionToggle:"esri-layer-list__action-toggle",actionToggleOn:"esri-layer-list__action-toggle--on",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childToggleOpen:"esri-layer-list__child-toggle--open",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",disabledElement:"esri-disabled-element",hidden:"esri-hidden",rotating:"esri-rotating",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",widgetIcon:"esri-icon-layers"},b={actions:"actions",actionSection:"action-section",items:"items"},v={exclusive:"exclusive",inherited:"inherited",independent:"independent"};return function(e){function t(t){var i=e.call(this)||this;return i._handles=new a,i.iconClass=m.widgetIcon,i.label=l.widgetLabel,i.listItemCreatedFunction=null,i.operationalItems=null,i.selectionEnabled=!1,i.selectedItems=new _,i.statusIndicatorsVisible=!0,i.view=null,i.viewModel=new u,i}return i(t,e),t.prototype.postInitialize=function(){var e=this,t=this.operationalItems;this.own(c.on(this,"operationalItems","change",function(){return e._itemsChanged(t)}))},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null},t.prototype.triggerAction=function(e,t){},t.prototype.render=function(){var e,t=this,i=this._getItems(),n=this.get("viewModel.state"),s=0===i.length?h.tsx("div",{class:m.noItems},l.noItemsToDisplay):h.tsx("ul",{class:this.classes(m.list,m.listRoot,m.listIndependent)},i.map(function(e,i){return t._renderItem(e,null)})),o=(e={},e[m.hidden]="loading"===n,e[m.disabled]="disabled"===n,e);return h.tsx("div",{class:this.classes(m.base,o)},s)},t.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(t){return e.errorsVisible||!t.error})},t.prototype._getSingleActionButton=function(e){return e.actionsSections.reduce(function(e){return e}).filter(function(e){return e&&"button"===e.type}).getItemAt(0)},t.prototype._renderItem=function(e,t){var i,n,r,a,c=this,d=this.id,p=d+"_"+e.uid,u=p+"_actions",g=p+"__list",y=p+"__title",_=e.children.length,b=!!e.error,f=!!_&&!b,I=b?l.layerError:"",A=e.visibilityMode,x=e.children&&e.children.toArray(),w=v.exclusive,k=v.inherited,C=(i={},i[m.listExclusive]=A===w,i[m.listInherited]=A===k,i[m.listIndependent]=A!==k&&A!==w,i),S=(n={},n[m.itemChildren]=f,n[m.itemError]=!!b,n[m.itemUpdating]=e.updating&&!t&&this.statusIndicatorsVisible,n[m.itemInvisibleAtScale]=!e.visibleAtCurrentScale,n[m.itemSelectable]=this.selectionEnabled,n),O=this._countActions(e.actionsSections),L=e.panel,E=L&&L.open?L.render():null,M=L&&L.visible?this._renderPanelButton(L):null,T=(r={},r[m.actionsMenuItemActive]=e.actionsOpen,r),R=e.actionsOpen?o.close:o.open,V=1===O&&this._getSingleActionButton(e),P=V?this._renderAction({item:e,action:V,singleAction:!0}):null,H=!V&&O?h.tsx("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes(m.actionsMenuItem,T),tabindex:"0",role:"button","aria-controls":u,"aria-label":R,title:R},h.tsx("span",{"aria-hidden":"true",class:m.iconEllipses})):null,N=H||M||P?h.tsx("div",{key:"esri-layer-list__actions-menu",class:m.actionsMenu},M,P,H):null,D=O?this._renderActionsSections(e,e.actionsSections,u):null,B=f?h.tsx("ul",{key:"esri-layer-list__list-items",id:g,class:this.classes(m.list,C),"aria-expanded":e.open?"true":"false",role:A===w?"radiogroup":"group",hidden:!e.open||null},x.map(function(t){return c._renderItem(t,e)})):null,U=(a={},a[m.childToggleOpen]=e.open,a),F=e.open?o.collapse:o.expand,j=f?h.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"esri-layer-list__toggle-children",class:this.classes(m.childToggle,U),tabindex:"0",role:"button","aria-controls":g,"aria-label":F,title:F},h.tsx("span",{"aria-hidden":"true",class:this.classes(m.childClosed,m.iconRightArrow)}),h.tsx("span",{"aria-hidden":"true",class:this.classes(m.childOpened,m.iconDownArrow)}),h.tsx("span",{"aria-hidden":"true",class:this.classes(m.childClosed_RTL,m.iconLeftArrow)})):null,z=this._createLabelNode(e,t,y),K=b?h.tsx("div",{key:"esri-layer-list__error",class:m.errorMessage,role:"alert"},h.tsx("span",null,I)):null,q=this.selectedItems.indexOf(e)>-1,W=this.selectionEnabled?{bind:this,onclick:this._toggleSelection,onkeydown:this._toggleSelection,"data-item":e,tabIndex:0,"aria-checked":q?"true":"false",role:"checkbox","aria-labelledby":y}:{bind:void 0,onclick:void 0,onkeydown:void 0,"data-item":void 0,tabIndex:void 0,"aria-checked":void 0,role:void 0,"aria-labelledby":void 0};return h.tsx("li",{key:e,class:this.classes(m.item,S),"aria-labelledby":y},h.tsx("div",s({key:"esri-layer-list__list-item-container",class:m.itemContainer},W),j,z,N),K,D,E,B)},t.prototype._createLabelNode=function(e,t,i){var n,o=this.selectionEnabled,r=v.exclusive,a=v.inherited,c=t&&t.visibilityMode,d=(n={},n[m.iconRadioSelected]=c===r&&e.visible,n[m.iconRadioUnselected]=c===r&&!e.visible,n[m.iconVisible]=c!==r&&e.visible,n[m.iconInvisible]=c!==r&&!e.visible,n),p=c===r?"radio":"switch",u=e.title||l.untitledLayer,g=e.visibleAtCurrentScale?u:u+" ("+l.layerInvisibleAtScale+")",y=h.tsx("span",{id:i,title:g,"aria-label":g,class:m.title},u),_=h.tsx("span",{class:this.classes(m.toggleVisibleIcon,d),"aria-hidden":"true"}),b={bind:this,onclick:this._toggleVisibility,onkeydown:this._toggleVisibility,"data-item":e,"data-parent-visibility":c,tabIndex:0,"aria-checked":e.visible?"true":"false",role:p,"aria-labelledby":i},f={bind:void 0,onclick:void 0,onkeydown:void 0,"data-item":void 0,"data-parent-visibility":void 0,tabIndex:void 0,"aria-checked":void 0,role:void 0,"aria-labelledby":void 0},I=o?b:f,A=o?f:b,x=h.tsx("div",s({key:e,class:m.label},A),h.tsx("span",s({class:m.toggleVisible},I),_),y),w=!!e.error,k=w?h.tsx("span",{"aria-hidden":"true",class:m.iconNoticeTriangle}):null;return c===a||w?h.tsx("div",{key:e,class:m.label},k,y):x},t.prototype._renderPanelButton=function(e){var t,i,n=e.className,s=e.open,o=e.title,l=e.image,r=l||n?n:m.iconDefaultAction,a=this._getIconImageStyles(e),c=(t={},t[m.actionsMenuItemActive]=s,t),d=(i={},i[m.actionImage]=!!a["background-image"],i);return r&&(d[r]=!!r),h.tsx("div",{key:e,bind:this,"data-panel":e,onclick:this._triggerPanel,onkeydown:this._triggerPanel,class:this.classes(m.actionsMenuItem,c),role:"button",tabindex:"0",title:o,"aria-label":o},h.tsx("span",{class:this.classes(d),styles:a}))},t.prototype._watchActionSectionChanges=function(e,t){var i=this,n=b.actionSection+t;this._handles.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return i._renderOnActionChanges(e,t)})},t.prototype._renderOnActionChanges=function(e,t){var i=this,n=b.actions+t;return"toggle"===e.type?void this._handles.add([c.init(e,["className","image","id","title","visible","value"],function(){return i.scheduleRender()})],n):"slider"===e.type?void this._handles.add([c.init(e,["className","id","title","visible","value","displayValueEnabled","max","min","step"],function(){return i.scheduleRender()})],n):void this._handles.add([c.init(e,["className","image","id","title","visible"],function(){return i.scheduleRender()})],n)},t.prototype._renderOnItemChanges=function(e){var t=this,i=e.uid,n=b.items+i;this._handles.add([c.init(e,["actionsOpen","visible","open","updating","title","visibleAtCurrentScale","error","visibilityMode","panel","panel.title","panel.content","panel.className"],function(){return t.scheduleRender()}),e.actionsSections.on("change",function(){return t.scheduleRender()}),e.children.on("change",function(){return t.scheduleRender()})],n),e.children.forEach(function(e){return t._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return t._watchActionSectionChanges(e,i)})},t.prototype._itemsChanged=function(e){var t=this;this._handles.removeAll(),e.forEach(function(e){return t._renderOnItemChanges(e)}),this.scheduleRender()},t.prototype._renderActionsSections=function(e,t,i){var n=this,s=t.toArray(),o=s.map(function(t){return h.tsx("ul",{key:t,class:m.actionsList},n._renderActionSection(e,t))});return h.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"esri-layer-list__actions-section",id:i,class:m.actions,hidden:!e.actionsOpen||null},o)},t.prototype._renderActionSection=function(e,t){var i=this;return(t&&t.toArray()).map(function(t){return i._renderAction({item:e,action:t})})},t.prototype._renderAction=function(e){var t,i,n=e.item,s=e.action,o=e.singleAction,l=this._getIconImageStyles(s),r=s.active,a=s.className,c=s.disabled,d=s.title,p="button"!==s.type||s.image||a?a:m.iconDefaultAction,u=(t={},t[m.actionsMenuItem]=o&&"button"===s.type,t[m.action]=!o&&"toggle"!==s.type,t[m.actionToggle]="toggle"===s.type,t[m.actionToggleOn]="toggle"===s.type&&s.value,t[m.disabledElement]=c,t),g=(i={},i[m.actionImage]=!r&&!!l["background-image"],i[m.iconLoading]=r,i[m.rotating]=r,i);p&&(g[p]=!0);var y=h.tsx("span",{"aria-hidden":"true",class:this.classes(m.actionIcon,g),styles:l}),_=o?null:h.tsx("span",{class:m.actionTitle},d),b=[y,_];return o?h.tsx("div",{bind:this,"data-item":n,"data-action":s,role:"button",key:s,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:u,tabindex:"0",title:d,"aria-label":d},b):h.tsx("li",{bind:this,"data-item":n,"data-action":s,key:s,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:u,tabindex:"0",role:"button",title:d,"aria-label":d},b)},t.prototype._countActions=function(e){return e.reduce(function(e,t){return e+t.length},0)},t.prototype._getIconImageStyles=function(e){var t="esri.widgets.LayerList.ListItemPanel"===e.declaredClass||"esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?'url("'+t+'")':null}},t.prototype._toggleActionsOpen=function(e){var t=e.currentTarget,i=t["data-item"],n=i.actionsOpen,s=!n;s&&this.operationalItems.forEach(function(e){return y(e)}),i.actionsOpen=s,e.stopPropagation()},t.prototype._triggerPanel=function(e){var t=e.currentTarget,i=t["data-panel"];i&&(i.open=!i.open),e.stopPropagation()},t.prototype._triggerAction=function(e){var t=e.currentTarget,i=t["data-action"],n=t["data-item"];"toggle"===i.type&&(i.value=!i.value),this.triggerAction(i,n),e.stopPropagation()},t.prototype._toggleVisibility=function(e){var t=e.currentTarget,i=t.getAttribute("data-parent-visibility"),n=t["data-item"];i===v.exclusive&&n.visible||(n.visible=!n.visible),e.stopPropagation()},t.prototype._toggleChildrenClick=function(e){var t=e.currentTarget,i=t["data-item"];i.open=!i.open,e.stopPropagation()},t.prototype._toggleSelection=function(e){var t=e.metaKey||e.ctrlKey,i=e.currentTarget,n=i["data-item"],s=this.selectedItems,o=s.indexOf(n)>-1,l=s.length,r=o&&1===l;return t?void(o?s.remove(n):s.add(n)):l&&!r?(s.removeAll(),void s.add(n)):void(o?s.remove(n):s.add(n))},n([d.property()],t.prototype,"iconClass",void 0),n([d.property(),h.renderable()],t.prototype,"errorsVisible",void 0),n([d.property()],t.prototype,"label",void 0),n([d.aliasOf("viewModel.listItemCreatedFunction"),h.renderable()],t.prototype,"listItemCreatedFunction",void 0),n([d.aliasOf("viewModel.operationalItems"),h.renderable()],t.prototype,"operationalItems",void 0),n([d.property(),h.renderable()],t.prototype,"selectionEnabled",void 0),n([d.property(),h.renderable()],t.prototype,"selectedItems",void 0),n([d.property(),h.renderable()],t.prototype,"statusIndicatorsVisible",void 0),n([d.aliasOf("viewModel.view"),h.renderable()],t.prototype,"view",void 0),n([h.vmEvent("trigger-action"),d.property({type:u}),h.renderable("viewModel.state")],t.prototype,"viewModel",void 0),n([d.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",null),n([h.accessibleHandler()],t.prototype,"_toggleActionsOpen",null),n([h.accessibleHandler()],t.prototype,"_triggerPanel",null),n([h.accessibleHandler()],t.prototype,"_triggerAction",null),n([h.accessibleHandler()],t.prototype,"_toggleVisibility",null),n([h.accessibleHandler()],t.prototype,"_toggleChildrenClick",null),n([h.accessibleHandler()],t.prototype,"_toggleSelection",null),t=n([d.subclass("esri.widgets.LayerList")],t)}(d.declared(p))});