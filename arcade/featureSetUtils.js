// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();define(["require","exports","../request","./featureSetCollection","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerDynamicMap","./featureset/sources/FeatureLayerMemoryMap","./featureset/sources/FeatureSetRelated","./featureset/support/cache","./featureset/support/shared","./polyfill/promiseUtils","../arcgis/Portal","../layers/FeatureLayer","./featureset/actions/GroupBy"],function(e,t,r,a,n,i,l,o,s,u,c,d,f){"use strict";function h(){null===s.applicationCache&&(s.applicationCache=new s)}function p(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var a=r({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(e){if(e){var t=e;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),c.resolve(t)}var r={layers:[],tables:[]};return c.resolve(r)});return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,a),a=a.catch(function(t){throw s.applicationCache.clearLayerInfo(e),t})),a}function y(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var a=r({url:e,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(e){if(e){var t=e;return c.resolve(t)}return c.resolve(null)});return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,a),a=a.catch(function(t){throw s.applicationCache.clearLayerInfo(e),t})),a}function m(e,t){var a="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==s.applicationCache){var n=s.applicationCache.getLayerInfo(a);if(null!==n)return n}var i=r({url:e+"/queryDataElements",usePost:!0,handleAs:"json",content:{layers:JSON.stringify([t.toString()]),f:"json"}}).then(function(e){if(e){var t=e;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")});return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(a,i),i=i.catch(function(e){throw s.applicationCache.clearLayerInfo(a),e})),i}function v(e,t,r,a,i){return void 0===r&&(r=null),void 0===a&&(a=!0),void 0===i&&(i=null),null===r&&(r=["*"]),new n({url:e,outFields:r,spatialReference:t,includeGeometry:a,lrucache:i})}function L(e,t,r,a,n){return void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),c.resolve(v(e,t,r,a,n))}function _(e,t,r,a,n){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),!e.getMap())throw new Error("FeatureSets can only be used once the layer is added to a Map");if(e.mode===f.MODE_SNAPSHOT&&!e.url)return new l({layer:e,spatialReference:t,outFields:r,includeGeometry:a});if(e.mode===f.MODE_SNAPSHOT||e.mode===f.MODE_ONDEMAND||e.mode===f.MODE_AUTO)return new i({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n});throw new Error("FeatureSets only support for Snapshot or OnDemand FeatureSet")}function S(e,t,r){return void 0===r&&(r=null),new b(e,t,r)}function I(e,t,r){return void 0===r&&(r=null),new C(e,t,r)}function g(e,t){var a=t.portalUrl+(t.portalUrl.match(/\/$/)?"":"/")+"content/items/"+e;return c.create(function(e,t){return r({url:a,content:{f:"json"},callbackParamName:"callback",load:function(t){e({item:t})},error:function(e){t(e)}})})}function N(e,t){return null===e?t:new d.Portal(e.field("url"))}function F(e,t,r,a,n,i,l){return c.create(function(o,c){if(s.applicationCache){var d=s.applicationCache.getLayerInfo(e+":"+i.url);if(d)return void d.then(function(e){try{var i=L(u.extractServiceUrl(e.item.url)+"/"+t,r,a,n,l);o(i)}catch(e){c(e)}},function(e){c(e)})}var f=g(e,i);s.applicationCache&&s.applicationCache.setLayerInfo(e+":"+i.url,f),f.then(function(e){try{var i=L(u.extractServiceUrl(e.item.url)+"/"+t,r,a,n,l);o(i)}catch(e){c(e)}},function(t){s.applicationCache&&s.applicationCache.clearLayerInfo(e+":"+i.url),c(t)})})}function O(e,t,r,a,n,i,l){void 0===a&&(a=null),void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null);var s=e.serviceUrl();return s?(s="/"===s.charAt(s.length-1)?s+t.relatedTableId.toString():s+"/"+t.relatedTableId.toString(),L(s,a,n,i,l).then(function(s){return new o({layer:e,relatedLayer:s,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l})})):null}function k(e,t){var r={metadata:null,terminals:[],networkId:-1,queryelem:null,layerNameLkp:{},lkp:null};return p(e).then(function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(var n=0,i=a.layers;n<i.length;n++){var l=i[n];r.layerNameLkp[l.id]=l.name}if(a.tables)for(var o=0,s=a.tables;o<s.length;o++){var l=s[o];r.layerNameLkp[l.id]=l.name}var u=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=u,m(e,u).then(function(a){if(a){r.queryelem=a,r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(var n=0,i=r.queryelem.dataElement.domainNetworks;n<i.length;n++){for(var l=i[n],o=0,s=l.edgeSources?l.edgeSources:[];o<s.length;o++){var c=s[o],d={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};d.className&&(r.lkp[d.className]=d)}for(var f=0,h=l.junctionSources?l.junctionSources:[];f<h.length;f++){var c=h[f],d={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};d.className&&(r.lkp[d.className]=d)}}if(r.queryelem.terminalConfigurations)for(var p=0,m=r.queryelem.dataElement.terminalConfigurations;p<m.length;p++)for(var v=m[p],_=0,S=v.terminals;_<S.length;_++){var I=S[_];r.terminals.push({terminalId:I.terminalId,terminalName:I.terminalName})}return y(e+"/"+u).then(function(a){return a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId?L(e+"/"+a.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],!1,null).then(function(e){return e.load()}).then(function(e){return{lkp:r.lkp,associations:e,terminals:r.terminals}}):{associations:null,lkp:null,terminals:[]}})}return{associations:null,lkp:null,terminals:[]}})}return{associations:null,lkp:null,terminals:[]}})}Object.defineProperty(t,"__esModule",{value:!0}),t.initialiseMetaDataCache=h,t.constructFeatureSetFromUrlRaw=v,t.constructFeatureSetFromUrl=L,t.constructFeatureSet=_;var b=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._map=t,n._overridespref=r,n.lrucache=a,n._instantLayers=[],n}return __extends(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=_(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.makeAndAddFeatureSetTable=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=v(e.url,this._overridespref,r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:{name:e.title,id:e.id},includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var a=JSON.stringify(r),n=0;n<this._instantLayers.length;n++){var i=this._instantLayers[n];if(i.opitem.name===e&&i.includeGeometry===t&&i.outFields===a)return this.resolvePromise(this._instantLayers[n].featureset)}for(var l=null,o=0,s=this._map.graphicsLayerIds;o<s.length;o++){var u=s[o],c=this._map.getLayer(u);if(c instanceof f&&c.name===e){l=c;break}}if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,r));if(this._map.tables){var d=this._map.tables.find(function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)});if(d)return this.resolvePromise(this.makeAndAddFeatureSetTable(d,t,r))}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var a=JSON.stringify(r),n=0;n<this._instantLayers.length;n++){var i=this._instantLayers[n];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===a)return this.resolvePromise(this._instantLayers[n].featureset)}for(var l=null,o=0,s=this._map.graphicsLayerIds;o<s.length;o++){var u=s[o],c=this._map.getLayer(u);if(c instanceof f&&c.id===e){l=c;break}}if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,r));if(this._map.tables){var d=this._map.tables.find(function(t){return!!(t.id&&t.id===e||t.id&&t.id===e)});if(d)return this.resolvePromise(this.makeAndAddFeatureSetTable(d,t,r))}return this.resolvePromise(null)},t}(a);t.createFeatureSetCollectionFromMap=S;var C=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._url=t,n._overridespref=r,n.lrucache=a,n.metadata=null,n._instantLayers=[],n}return __extends(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype._loadMetaData=function(){var e=this;return p(this._url).then(function(t){return e.metadata=t,t})},t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=_(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var n=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.name===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then(function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){var s=o[l];s.name===e&&(i=s)}if(!i)for(var u=0,c=n.tables?n.tables:[];u<c.length;u++){var s=c[u];s.name===e&&(i=s)}return i?a.resolvePromise(v(a._url+"/"+i.id,a._overridespref,r,t,a.lrucache)):a.resolvePromise(null)})},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();var n=JSON.stringify(r);e=null!==e&&void 0!==e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then(function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){var s=o[l];null!==s.id&&void 0!==s.id&&s.id.toString()===e&&(i=s)}if(!i)for(var u=0,c=n.tables?n.tables:[];u<c.length;u++){var s=c[u];null!==s.id&&void 0!==s.id&&s.id.toString()===e&&(i=s)}return i?a.resolvePromise(v(a._url+"/"+i.id,a._overridespref,r,t,a.lrucache)):a.resolvePromise(null)})},t}(a);t.createFeatureSetCollectionFromService=I,t.getPortal=N,t.constructFeatureSetFromPortalItem=F,t.constructFeatureSetFromRelationship=O,t.constructAssociationMetaDataFeatureSetFromUrl=k});