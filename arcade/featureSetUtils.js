// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/extendsHelper","../core/tsSupport/assignHelper","../request","./featureSetCollection","./featureset/polyfill/FeatureLayerAndTable","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/FeatureSet","../core/promiseUtils","../layers/FeatureLayer","../portal/PortalItem","./featureset/actions/OrderBy","./featureset/actions/Top","./featureset/actions/SpatialFilter","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy"],function(e,t,r,a,n,i,l,o,u,s,c,d,f,h,p){function y(){null===c.applicationCache&&(c.applicationCache=new c)}function v(e,t){if(c.applicationCache){var r=c.applicationCache.getLayerInfo(e);if(r)return r.then(function(r){return f.resolve(new l({url:e,outFields:t,resourceInfo:r}))});var a=new l({url:e,outFields:t}),n=f.create(function(e,t){a.load().then(function(){e(a.resourceInfo)},function(e){t(e)})});return c.applicationCache&&(c.applicationCache.setLayerInfo(e,n),n=n.catch(function(t){throw c.applicationCache.clearLayerInfo(e),t})),n.then(function(e){return f.resolve(a)})}return f.resolve(new l({url:e,outFields:t}))}function m(e,t,r,a,n){return v(e,["*"]).then(function(e){return f.resolve(L(e,t,r,a,n))})}function L(e,t,r,a,n){return void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),!0===e._hasMemorySource()?new u({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n}):new o({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n})}function I(e){if(null!==c.applicationCache){var t=c.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then(function(e){if(e.data){var t=e.data;return f.resolve(t)}return f.resolve(null)});return null!==c.applicationCache&&(c.applicationCache.setLayerInfo(e,r),r=r.catch(function(t){throw c.applicationCache.clearLayerInfo(e),t})),r}function _(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==c.applicationCache){var a=c.applicationCache.getLayerInfo(r);if(null!==a)return a}var i=n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then(function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")});return null!==c.applicationCache&&(c.applicationCache.setLayerInfo(r,i),i=i.catch(function(e){throw c.applicationCache.clearLayerInfo(r),e})),i}function S(e){if(null!==c.applicationCache){var t=c.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then(function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),f.resolve(t)}var r={layers:[],tables:[]};return f.resolve(r)});return null!==c.applicationCache&&(c.applicationCache.setLayerInfo(e,r),r=r.catch(function(t){throw c.applicationCache.clearLayerInfo(e),t})),r}function F(e,t){var r={metadata:null,networkId:-1,queryelem:null,layerNameLkp:{},lkp:null};return S(e).then(function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(var n=0,i=a.layers;n<i.length;n++){var l=i[n];r.layerNameLkp[l.id]=l.name}if(a.tables)for(var o=0,u=a.tables;o<u.length;o++){var l=u[o];r.layerNameLkp[l.id]=l.name}var s=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=s,_(e,s).then(function(a){if(a){r.queryelem=a,r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(var n=0,i=r.queryelem.dataElement.domainNetworks;n<i.length;n++){for(var l=i[n],o=0,u=l.edgeSources?l.edgeSources:[];o<u.length;o++){var c=u[o],d={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};d.className&&(r.lkp[d.className]=d)}for(var f=0,h=l.junctionSources?l.junctionSources:[];f<h.length;f++){var c=h[f],d={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};d.className&&(r.lkp[d.className]=d)}}return I(e+"/"+s).then(function(a){return a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId?m(e+"/"+a.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],!1,null).then(function(e){return e.load()}).then(function(e){return{lkp:r.lkp,associations:e}}):{associations:null,lkp:null}})}return{associations:null,lkp:null}})}return{associations:null,lkp:null}})}function g(e,t,r,a,n,i,l){void 0===a&&(a=null),void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null);var o=e.serviceUrl();return o?(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),m(o,a,n,i,l).then(function(o){return new s({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l})})):null}function C(e,t,r){return void 0===r&&(r=null),new k(e,t,r)}function N(e,t,r){return void 0===r&&(r=null),new T(e,t,r)}function b(e,t,r,a,n,i,o){if(c.applicationCache){var u=c.applicationCache.getLayerInfo(e+":"+i.url);if(u)return u.then(function(e){try{var i=new l({url:e.url+"/"+t,outFields:["*"]});return f.resolve(L(i,r,a,n,o))}catch(e){return f.reject(e)}},function(e){return f.reject(e)})}return f.create(function(u,s){var d=new p({id:e,portal:i}),f=d.load();c.applicationCache&&c.applicationCache.setLayerInfo(e+":"+i.url,f),f.then(function(e){try{var i=new l({url:e.url+"/"+t,outFields:["*"]});u(L(i,r,a,n,o))}catch(e){s(e)}},function(t){c.applicationCache&&c.applicationCache.clearLayerInfo(e+":"+i.url),s(t)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.initialiseMetaDataCache=y,t.constructFeatureSetFromUrl=m,t.constructFeatureSet=L,t.constructAssociationMetaDataFeatureSetFromUrl=F,t.constructFeatureSetFromRelationship=g,d._polyfill.table=l;var k=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._map=t,n._overridespref=r,n.lrucache=a,n._instantLayers=[],n}return r(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=L(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=null),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return n.featureSetByName(e,t,r)}catch(e){return f.reject(e)}});null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var i=JSON.stringify(r),o=0;o<this._instantLayers.length;o++){var u=this._instantLayers[o];if(u.opitem.title===e&&u.includeGeometry===t&&u.outFields===i)return this.resolvePromise(this._instantLayers[o].featureset)}var s=this._map.layers.find(function(t){return t instanceof h&&t.title===e});if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,t,r));if(this._map.tables){var c=this._map.tables.find(function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)});if(c){if(c._materializedTable);else{var d=c.outFields?c:a({},c,{outFields:["*"]});c._materializedTable=new l(d)}return c._materializedTable.load().then(function(){return n.resolvePromise(n.makeAndAddFeatureSet(c._materializedTable,t,r))})}}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=["*"]),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return n.featureSetById(e,t,r)}catch(e){return f.reject(e)}});null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var i=JSON.stringify(r),o=0;o<this._instantLayers.length;o++){var u=this._instantLayers[o];if(u.opitem.id===e&&u.includeGeometry===t&&u.outFields===i)return this.resolvePromise(this._instantLayers[o].featureset)}var s=this._map.layers.find(function(t){return t instanceof h&&t.id===e});if(s)return this.resolvePromise(this.makeAndAddFeatureSet(s,t,r));if(this._map.tables){var c=this._map.tables.find(function(t){return t.id===e});if(c){if(c._materializedTable);else{var d=a({},c,{outFields:["*"]});c._materializedTable=new l(d)}return c._materializedTable.load().then(function(){return n.resolvePromise(n.makeAndAddFeatureSet(c._materializedTable,t,r))})}}return this.resolvePromise(null)},t}(i),T=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._url=t,n._overridespref=r,n.lrucache=a,n.metadata=null,n._instantLayers=[],n}return r(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=L(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype._loadMetaData=function(){var e=this;return S(this._url).then(function(t){return e.metadata=t,t})},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var n=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then(function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){var u=o[l];u.name===e&&(i=u)}if(!i)for(var s=0,c=n.tables?n.tables:[];s<c.length;s++){var u=c[s];u.name===e&&(i=u)}return i?v(a._url+"/"+i.id,["*"]).then(function(e){return a.makeAndAddFeatureSet(e,t,r)}):a.resolvePromise(null)})},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();var n=JSON.stringify(r);e=null!==e&&void 0!==e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then(function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){var u=o[l];null!==u.id&&void 0!==u.id&&u.id.toString()===e&&(i=u)}if(!i)for(var s=0,c=n.tables?n.tables:[];s<c.length;s++){var u=c[s];null!==u.id&&void 0!==u.id&&u.id.toString()===e&&(i=u)}return i?v(a._url+"/"+i.id,["*"]).then(function(e){return a.makeAndAddFeatureSet(e,t,r)}):a.resolvePromise(null)})},t}(i);t.createFeatureSetCollectionFromMap=C,t.createFeatureSetCollectionFromService=N,t.constructFeatureSetFromPortalItem=b});