// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["require","exports","../ArcadePortal","../Dictionary","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../languageUtils","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/sqlUtils","./fieldStats","../polyfill/promiseUtils","../polyfill/sql/WhereClause","../../layers/FeatureLayer"],function(e,r,t,n,a,i,l,u,s,o,f,c,d,y,m,p,h,g,v,F){"use strict";function I(e,r,t,n){if(1===n.length){if(s.isArray(n[0]))return h.calculateStat(e,n[0],-1);if(s.isImmutableArray(n[0]))return h.calculateStat(e,n[0].toArray(),-1)}return h.calculateStat(e,n,-1)}function b(e,r,t){var n=e.getVariables();if(n.length>0){for(var a=[],i=0;i<n.length;i++){var l={name:n[i]};a.push(r.evaluateIdentifier(t,l))}return g.all(a).then(function(r){for(var t={},a=0;a<n.length;a++)t[n[a]]=r[a];return e.parameters=t,e})}return g.resolve(e)}function S(e,r,t){void 0===t&&(t=null);for(var n in e)if(n.toLowerCase()===r.toLowerCase())return e[n];return t}function D(e){if(null===e)return null;var r={type:S(e,"type",""),name:S(e,"name","")};if("range"===r.type)r.range=S(e,"range",[]);else{r.codedValues=[];for(var t=0,n=S(e,"codedValues",[]);t<n.length;t++){var a=n[t];r.codedValues.push({name:S(a,"name",""),code:S(a,"code",null)})}}return r}function w(e){if(null===e)return null;var r={},t=S(e,"wkt",null);null!==t&&(r.wkt=t);var n=S(e,"wkid",null);return null!==n&&(r.wkid=n),r}function A(e){if(null===e)return null;var r={hasZ:S(e,"hasz",!1),hasM:S(e,"hasm",!1)},t=S(e,"spatialreference",null);t&&(r.spatialReference=w(t));var n=S(e,"x",null);if(null!==n)return r.x=n,r.y=S(e,"y",null),r;var a=S(e,"rings",null);if(null!==a)return r.rings=a,r;var i=S(e,"paths",null);if(null!==i)return r.paths=i,r;var l=S(e,"points",null);if(null!==l)return r.points=l,r;for(var u=0,s=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];u<s.length;u++){var o=s[u],f=S(e,o,null);null!==f&&(r[o]=f)}return r}function x(e,r){for(var t=0,n=r;t<n.length;t++){if(n[t]===e)return!0}return!1}function E(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==x(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==s.isArray(e.layerDefinition.fields)&&!1!==s.isArray(e.featureSet.features)))))}function C(e){"async"===e.mode&&(e.functions.featuresetbyid=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){if(s.pcCheck(t,2,4),t[0]instanceof l){var n=s.toString(t[1]),a=s.defaultUndefined(t[2],null),i=s.toBoolean(s.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===s.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetById(n,i,a)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(r,n){return e.standardFunctionAsync(r,n,function(e,n,a){if(s.pcCheck(a,2,5),null===a[0])throw new Error("Portal is required");if(a[0]instanceof t){var i=s.toString(a[1]),l=s.toString(a[2]),o=s.defaultUndefined(a[3],null),f=s.toBoolean(s.defaultUndefined(a[4],!0));if(null===o&&(o=["*"]),!1===s.isArray(o))throw new Error("Invalid Parameter");var c=null;return r.services&&r.services.portal&&(c=r.services.portal),c=u.getPortal(a[0],c),u.constructFeatureSetFromPortalItem(i,l,r.spatialReference,o,f,c,r.lrucache)}if(!1===s.isString(a[0]))throw new Error("Portal is required");var d=s.toString(a[0]),y=s.toString(a[1]),m=s.defaultUndefined(a[2],null),p=s.toBoolean(s.defaultUndefined(a[3],!0));if(null===m&&(m=["*"]),!1===s.isArray(m))throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return u.constructFeatureSetFromPortalItem(d,y,r.spatialReference,m,p,r.services.portal,r.lrucache);throw new Error("Portal is required")})},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){if(s.pcCheck(t,2,4),t[0]instanceof l){var n=s.toString(t[1]),a=s.defaultUndefined(t[2],null),i=s.toBoolean(s.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===s.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetByName(n,i,a)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(r,t){return e.standardFunction(r,t,function(e,t,a){s.pcCheck(a,1,1);var i=a[0],l={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(s.isString(i))i=JSON.parse(i),void 0!==i.layerDefinition?(l.layerDefinition=i.layerDefinition,l.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(l.featureSet.features=i.features,l.featureSet.geometryType=i.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=i.objectIdFieldName,l.layerDefinition.typeIdField=i.typeIdFieldName,l.layerDefinition.fields=i.fields,i.spatialReference&&(l.layerDefinition.spatialReference=i.spatialReference));else{if(!(a[0]instanceof n))throw new Error("Invalid Parameter");i=JSON.parse(a[0].castToText());var u=S(i,"layerdefinition");if(null!==u){l.layerDefinition.geometryType=S(u,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=S(u,"objectidfield",""),l.layerDefinition.typeIdField=S(u,"typeidfield","");var o=S(u,"spatialreference",null);o&&(l.layerDefinition.spatialReference=w(o));for(var f=0,c=S(u,"fields",[]);f<c.length;f++){var d=c[f],m={name:S(d,"name",""),alias:S(d,"alias",""),type:S(d,"type",""),nullable:S(d,"nullable",!0),editable:S(d,"editable",!0),length:S(d,"length",null),domain:D(S(d,"domain"))};l.layerDefinition.fields.push(m)}var p=S(i,"featureset",null);if(p){for(var h={},g=0,v=l.layerDefinition.fields;g<v.length;g++){var F=v[g];h[F.name.toLowerCase()]=F.name}for(var I=0,b=S(p,"features",[]);I<b.length;I++){var x=b[I],C={},L=S(x,"attributes",{});for(var F in L)C[h[F.toLowerCase()]]=L[F];l.featureSet.features.push({attributes:C,geometry:A(S(x,"geometry",null))})}}}else{l.layerDefinition.geometryType=S(i,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=S(i,"objectidfieldname",""),l.layerDefinition.typeIdField=S(i,"typeidfieldname","");var o=S(i,"spatialreference",null);o&&(l.layerDefinition.spatialReference=w(o));for(var k=0,N=S(i,"fields",[]);k<N.length;k++){var d=N[k],m={name:S(d,"name",""),alias:S(d,"alias",""),type:S(d,"type",""),nullable:S(d,"nullable",!0),editable:S(d,"editable",!0),length:S(d,"length",null),domain:D(S(d,"domain"))};l.layerDefinition.fields.push(m)}for(var h={},P=0,T=l.layerDefinition.fields;P<T.length;P++){var F=T[P];h[F.name.toLowerCase()]=F.name}for(var B=0,M=S(i,"features",[]);B<M.length;B++){var x=M[B],C={},L=S(x,"attributes",{});for(var F in L)C[h[F.toLowerCase()]]=L[F];l.featureSet.features.push({attributes:C,geometry:A(S(x,"geometry",null))})}}}if(!1===E(l))throw new Error("Invalid Parameter");return y.create(l,r.spatialReference)})},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(r,t){return e.standardFunctionAsync(r,t,function(t,n,a){return s.pcCheck(a,2,2),s.isFeatureSet(a[0])?a[0].load().then(function(t){var n=v.WhereClause.create(a[1],t.getFieldsIndex()),i=n.getVariables();if(i.length>0){for(var l=[],u=0;u<i.length;u++){var s={name:i[u]};l.push(e.evaluateIdentifier(r,s))}return g.all(l).then(function(e){for(var r={},t=0;t<i.length;t++)r[i[t]]=e[t];return n.parameters=r,new o({parentfeatureset:a[0],whereclause:n})})}return g.resolve(new o({parentfeatureset:a[0],whereclause:n}))}):e.failDefferred("Filter cannot accept this parameter type")})},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(r,t){return e.standardFunctionAsync(r,t,function(r,t,n){if(s.pcCheck(n,2,2),s.isFeatureSet(n[0])){var a=new m(n[1]);return g.resolve(new f({parentfeatureset:n[0],orderbyclause:a}))}return e.failDefferred("Order cannot accept this parameter type")})},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(r,t){return e.standardFunctionAsync(r,t,function(r,t,n){return s.pcCheck(n,2,2),s.isFeatureSet(n[0])?g.resolve(new c({parentfeatureset:n[0],topnum:n[1]})):s.isArray(n[0])?s.toNumber(n[1])>=n[0].length?n[0].slice(0):n[0].slice(0,s.toNumber(n[1])):s.isImmutableArray(n[0])?s.toNumber(n[1])>=n[0].length()?n[0].slice(0):n[0].slice(0,s.toNumber(n[1])):e.failDefferred("Top cannot accept this parameter type")})},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){return s.pcCheck(t,1,1),s.isFeatureSet(t[0])?t[0].first(e.abortSignal).then(function(e){if(null!==e){var r=i.createFromGraphicLikeObject(e.geometry,e.attributes,t[0]);r._underlyingGraphic=e,e=r}return e}):s.isArray(t[0])?0===t[0].length?g.resolve(null):g.resolve(t[0][0]):s.isImmutableArray(t[0])?0===t[0].length()?g.resolve(null):g.resolve(t[0].get(0)):null})},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(r,t){return e.standardFunctionAsync(r,t,function(e,t,a){s.pcCheck(a,1,2);var l={minsize:-1,maxsize:-1,types:null};if(a.length>1)if(a[1]instanceof n){if(a[1].hasField("minsize")&&(l.minsize=s.toNumber(a[1].field("minsize"))),a[1].hasField("maxsize")&&(l.maxsize=s.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){var o=s.toStringArray(a[1].field("types"),!1);o.length>0&&(l.types=o)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(a[0]instanceof i){var f=a[0]._layer;return f instanceof F&&(f=u.constructFeatureSet(f,r.spatialReference,["*"],!0,r.lrucache)),null===f?[]:!1===s.isFeatureSet(f)?[]:f.load().then(function(){return f.queryAttachments(a[0].field(f.objectIdField),l.minsize,l.maxsize,l.types)})}if(null===a[0])return[];throw new Error("Invalid Parameter")})},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(r,t){return e.standardFunctionAsync(r,t,function(e,t,n){s.pcCheck(n,2,4);var a=n[0],l=s.toString(n[1]),o=s.defaultUndefined(n[2],null),f=s.toBoolean(s.defaultUndefined(n[3],!0));if(null===o&&(o=["*"]),!1===s.isArray(o))throw new Error("Invalid Parameter");if(null===n[0])return null;if(!(n[0]instanceof i))throw new Error("Invalid Parameter");var c=a._layer;return c instanceof F&&(c=u.constructFeatureSet(c,r.spatialReference,["*"],!0,r.lrucache)),null===c?null:!1===s.isFeatureSet(c)?null:c.load().then(function(e){var t=e.relationshipMetaData(),n=t.filter(function(e){return e.name===l});if(0===n.length)return null;if(void 0!==n[0].relationshipTableId&&null!==n[0].relationshipTableId&&n[0].relationshipTableId>-1)return u.constructFeatureSetFromRelationship(e,n[0],a.field(e.objectIdField),e.spatialReference,o,f,r.lrucache);var i=e.serviceUrl();return i?(i="/"===i.charAt(i.length-1)?i+n[0].relatedTableId.toString():i+"/"+n[0].relatedTableId.toString(),u.constructFeatureSetFromUrl(i,e.spatialReference,o,f,r.lrucache).then(function(r){return r.load().then(function(){return r.relationshipMetaData()}).then(function(t){if(t=t.filter(function(e){return e.id===n[0].id}),!1===a.hasField(n[0].keyField)||null===a.field(n[0].keyField))return e.getFeatureByObjectId(a.field(e.objectIdField),[n[0].keyField]).then(function(e){if(e){var a=v.WhereClause.create(t[0].keyField+"= @id",r.getFieldsIndex());return a.parameters={id:e.attributes[n[0].keyField]},r.filter(a)}return new d({parentfeatureset:r})});var i=v.WhereClause.create(t[0].keyField+"= @id",r.getFieldsIndex());return i.parameters={id:a.field(n[0].keyField)},r.filter(i)})})):null})})},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.groupby=function(r,t){return e.standardFunctionAsync(r,t,function(t,n,i){return s.pcCheck(i,3,3),s.isFeatureSet(i[0])?i[0].load().then(function(t){var n=[],l=[],u=!1,o=[];if(s.isString(i[1]))o.push(i[1]);else if(i[1]instanceof a)o.push(i[1]);else if(s.isArray(i[1]))o=i[1];else{if(!s.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");o=i[1].toArray()}for(var f=0,c=o;f<c.length;f++){var d=c[f];if(s.isString(d)){var y=v.WhereClause.create(s.toString(d),t.getFieldsIndex()),m=!0===p.isSingleField(y)?s.toString(d):"%%%%FIELDNAME";n.push({name:m,expression:y}),"%%%%FIELDNAME"===m&&(u=!0)}else{if(!(d instanceof a))return e.failDefferred("Illegal Value: GroupBy");var h=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",y=d.hasField("expression")?d.field("expression"):"";if("%%%%FIELDNAME"===h&&(u=!0),!h)return e.failDefferred("Illegal Value: GroupBy");n.push({name:h,expression:v.WhereClause.create(y||h,t.getFieldsIndex())})}}if(o=[],s.isString(i[2]))o.push(i[2]);else if(s.isArray(i[2]))o=i[2];else if(s.isImmutableArray(i[2]))o=i[2].toArray();else{if(!(i[2]instanceof a))return e.failDefferred("Illegal Value: GroupBy");o.push(i[2])}for(var F=0,I=o;F<I.length;F++){var d=I[F];if(!(d instanceof a))return e.failDefferred("Illegal Value: GroupBy");var S=d.hasField("name")?d.field("name"):"",D=d.hasField("statistic")?d.field("statistic"):"",y=d.hasField("expression")?d.field("expression"):"";if(!S||!D||!y)return e.failDefferred("Illegal Value: GroupBy");l.push({name:S,statistic:D.toLowerCase(),expression:v.WhereClause.create(y,t.getFieldsIndex())})}if(u){for(var w={},A=0,x=t.fields;A<x.length;A++){var E=x[A];w[E.name.toLowerCase()]=1}for(var C=0,L=n;C<L.length;C++){var E=L[C];"%%%%FIELDNAME"!==E.name&&(w[E.name.toLowerCase()]=1)}for(var k=0,N=l;k<N.length;k++){var E=N[k];"%%%%FIELDNAME"!==E.name&&(w[E.name.toLowerCase()]=1)}for(var P=0,T=0,B=n;T<B.length;T++){var E=B[T];if("%%%%FIELDNAME"===E.name){for(;1===w["field_"+P.toString()];)P++;w["field_"+P.toString()]=1,E.name="FIELD_"+P.toString()}}}for(var M=[],G=0,R=n;G<R.length;G++){var U=R[G];M.push(b(U.expression,e,r))}for(var j=0,V=l;j<V.length;j++){var U=V[j];M.push(b(U.expression,e,r))}return M.length>0?g.all(M).then(function(){return g.resolve(i[0].groupby(n,l))}):g.resolve(i[0].groupby(n,l))}):e.failDefferred("Illegal Value: GroupBy")})},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(r,t){return e.standardFunctionAsync(r,t,function(t,n,i){return s.isFeatureSet(i[0])?(s.pcCheck(i,2,2),i[0].load().then(function(t){var n=[],l=[];if(s.isString(i[1]))l.push(i[1]);else if(i[1]instanceof a)l.push(i[1]);else if(s.isArray(i[1]))l=i[1];else{if(!s.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");l=i[1].toArray()}for(var u=!1,o=0,f=l;o<f.length;o++){var c=f[o];if(s.isString(c)){var d=v.WhereClause.create(s.toString(c),t.getFieldsIndex()),y=!0===p.isSingleField(d)?s.toString(c):"%%%%FIELDNAME";n.push({name:y,expression:d}),"%%%%FIELDNAME"===y&&(u=!0)}else{if(!(c instanceof a))return e.failDefferred("Illegal Value: GroupBy");var m=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",d=c.hasField("expression")?c.field("expression"):"";if("%%%%FIELDNAME"===m&&(u=!0),!m)return e.failDefferred("Illegal Value: GroupBy");n.push({name:m,expression:v.WhereClause.create(d||m,t.getFieldsIndex())})}}if(u){for(var h={},F=0,I=t.fields;F<I.length;F++){var S=I[F];h[S.name.toLowerCase()]=1}for(var D=0,w=n;D<w.length;D++){var S=w[D];"%%%%FIELDNAME"!==S.name&&(h[S.name.toLowerCase()]=1)}for(var A=0,x=0,E=n;x<E.length;x++){var S=E[x];if("%%%%FIELDNAME"===S.name){for(;1===h["field_"+A.toString()];)A++;h["field_"+A.toString()]=1,S.name="FIELD_"+A.toString()}}}for(var C=[],L=0,k=n;L<k.length;L++){var N=k[L];C.push(b(N.expression,e,r))}return C.length>0?g.all(C).then(function(){return g.resolve(i[0].groupby(n,[]))}):g.resolve(i[0].groupby(n,[]))})):I("distinct",t,n,i)})})}Object.defineProperty(r,"__esModule",{value:!0}),r.registerFunctions=C});