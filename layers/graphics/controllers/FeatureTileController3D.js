// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/Accessor","../../../core/asyncUtils","../../../core/Collection","../../../core/compilerUtils","../../../core/Error","../../../core/Handles","../../../core/lang","../../../core/Logger","../../../core/maybe","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../support/arcgisLayerUrl","../../../portal/support/geometryServiceUtils","../../../tasks/support/StatisticDefinition","../../../views/3d/layers/graphics/Graphics3DVerticalScale","../../../views/3d/layers/support/FeatureTileFetcher3D","../../../views/3d/layers/support/FeatureTileFetcher3DDebugger","../../../views/3d/support/debugFlags"],function(e,t,r,i,n,a,s,o,l,u,c,p,h,d,f,m,y,v,x,g,b,F,E,T,O,C,S){var D=f.getLogger("esri.layers.graphics.controllers.FeatureTileController3D"),w=function(e){function t(t){var r=e.call(this)||this;return r.type="feature-tile-3d",r.serviceDataExtent=null,r.serviceDataCount=n.constants.NO_SERVICE_DATA_COUNT,r.vertexLimitExceeded=!1,r.displayFeatureLimit=null,r.suspended=!1,r.asyncTasks=new u,r.tileFetcher=null,r.handles=new h,r.fetchDataInfoPromise=null,r.fetchDataInfoAbortController=null,r.lifeCycleAbortController=v.createAbortController(),r}r(t,e),n=t,Object.defineProperty(t.prototype,"extent",{set:function(e){if(e&&!e.spatialReference.equals(this.layerView.view.spatialReference))return void D.error("#extent=","extent needs to be in the same spatial reference as the view");var t=this._get("extent");if(t!==e&&!(t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("extent",r)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.tileFetcher&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||this.asyncTasks.length>0||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.updatingTotal:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.updatingRemaining:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"expectedFeatureDiff",{get:function(){return this.updating&&this.tileFetcher?this.tileFetcher.expectedFeatureDiff:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"memoryForUnusedFeatures",{get:function(){return this.tileFetcher?this.tileFetcher.memoryForUnusedFeatures:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!(!this.tileFetcher||!this.tileFetcher.maximumNumberOfFeaturesExceeded)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filteredDataExtent",{get:function(){return this.extent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeatures",{get:function(){return this.displayFeatureLimit?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&(null==e?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasMaximumNumberOfFeaturesOverride",{get:function(){return this._isOverridden("maximumNumberOfFeatures")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(this.serviceDataCount===n.constants.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var e=this.layerView,t=e.layer,r=e.view,i=r&&r.featureTiles,a=i&&i.tilingScheme;if(t&&t.minScale&&this.serviceDataExtent&&a){var s=this.approximateExtentSizeAtScale(t.minScale,a);if((this.serviceDataExtent.width/s+this.serviceDataExtent.height/s)/2>n.constants.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxTotalSnapshotVertices",{get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&this.tileFetcher&&this.tileFetcher.totalVertices||0;return Math.max(e,t)},enumerable:!0,configurable:!0}),t.prototype.approximateExtentSizeAtScale=function(e,t){var r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize[0]+r.height/t.pixelSize[1])/2),n=t.levels[0];return i*((n.tileSize[0]/(n.scale/e)+n.tileSize[1]/(n.scale/e))/2)},Object.defineProperty(t.prototype,"tileDescriptors",{get:function(){return"snapshot"===this.mode?new u([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new u},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.handles.add([this.watch("vertexLimitInfo",function(){return e.registerAsyncTask(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))}),x.init(this,"mode",function(){return e.modeChanged()})]);var t=v.resolve().then(function(){return e.verifyCapabilities()}).then(function(){return e.registerAsyncTask(e.fetchServiceDataInfo())}).then(function(){return e.initializeTileFetcher()});this.addResolvingPromise(t)},t.prototype.verifyCapabilities=function(){var e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery"))throw new p("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})},t.prototype.registerAsyncTask=function(e){var t=this.asyncTasks;t.add(e);var r=function(){return t.remove(e)};return e.then(r,r),e},t.prototype.destroy=function(){this.cancelFetchServiceDataInfo(),this.tileFetcher&&(this.tileFetcher.destroy(),this.tileFetcher=null),this.handles&&(this.handles.destroy(),this.handles=null),this.tilesHandle&&(this.tilesHandle.remove(),this.tilesHandle=null),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null)},t.prototype.suspend=function(){this.suspended||(this.suspended=!0,this.tileFetcher&&this.tileFetcher.suspend())},t.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.tileFetcher&&this.tileFetcher.resume())},t.prototype.refresh=function(){var e=this,t=function(){e.tileFetcher&&e.tileFetcher.filtersChanged()};this.registerAsyncTask(this.fetchServiceDataInfo().then(t,t))},t.prototype.initializeTileFetcher=function(){var e=this,t=this.layerView.view;x.whenOnce(t.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal).then(function(){var r=e,i=r.layerView,n=r.tileDescriptors,a=i.layer,s=new T({sourceSpatialReference:a.spatialReference,destSpatialReference:t.spatialReference});e.tileFetcher=new O.FeatureTileFetcher3D({layerView:i,filterExtent:e.filteredDataExtent,tilingScheme:t.featureTiles.tilingScheme,tileDescriptors:n,features:e.graphics,verticalScale:s,viewingMode:t.viewingMode,hasZ:e.hasZ,hasM:e.hasM}),e.suspended?e.tileFetcher.suspend():e.tileFetcher.resume();var o=function(t){e.tileFetcher.maximumNumberOfFeatures=t,e.tileFetcher.useTileCount=e.serviceDataCount>t},l=function(t){return e.tileFetcher.useTileCount=t>e.maximumNumberOfFeatures};e.handles.add([a.watch("definitionExpression",function(){return e.definitionExpressionChanged()}),i.watch("availableFields",function(t,r){return e.attributesChanged(r,t)}),a.on("apply-edits",function(t){return e.applyEdits(t)}),e.watch("filteredDataExtent",function(t){return e.tileFetcher.filterExtent=t},!0),e.watch("tileDescriptors",function(t){return e.tileFetcher.tileDescriptors=t},!0),x.init(e,"maximumNumberOfFeatures",o,!0),x.init(e,"serviceDataCount",l,!0),x.init(S,"FEATURE_TILE_FETCH_SHOW_TILES",function(r){r&&e.tileFetcher&&!e.tileFetcher.debugger?(e.tileFetcher.debugger=new C.FeatureTileFetcher3DDebugger(e.tileFetcher,t.featureTiles.tilingScheme.toTileInfo(),t),e.tileFetcher.debugger.update()):!r&&e.tileFetcher&&e.tileFetcher.debugger&&(e.tileFetcher.debugger.destroy(),e.tileFetcher.debugger=null)})]),e.supportsExceedsLimitQuery||e.watch("maxTotalSnapshotVertices",function(){return e.registerAsyncTask(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))})})},t.prototype.modeChanged=function(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:D.warn("Unhandled feature layer mode "+this.mode);case"snapshot":this.tilesHandle&&(this.tilesHandle.remove(),this.tilesHandle=null)}},t.prototype.definitionExpressionChanged=function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refresh()},t.prototype.applyEdits=function(e){var t=this;this.tileFetcher.applyEdits(e).then(function(e){e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t.registerAsyncTask(t.updateServiceDataExtent(t.lifeCycleAbortController.signal))})},t.prototype.attributesChanged=function(e,t){if(!e||-1===e.indexOf("*"))if(e&&t){for(var r=new Set,i=0,n=e;i<n.length;i++){var a=n[i];r.add(a)}for(var s=0,o=t;s<o.length;s++){var a=o[s];if(!r.has(a))return void this.refresh()}}else this.refresh()},t.prototype.createVertexLimitExceededQuery=function(e){var t=this.layerView.layer,r=t.createQuery();return r.outStatistics=[new E({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(r.cacheHint=!0),r},t.prototype.createDataInfoQuery=function(){var e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t},t.prototype.fullExtentIsAccurate=function(){var e=this.layerView,t=e.layer;if(t.definitionExpression)return!1;switch(t.type){case"feature":case"stream":return b.isHostedAgolService(t.url);case"csv":case"geojson":return!0;default:c.neverReached(t)}},t.prototype.updateServiceDataExtent=function(e){return s(this,void 0,void 0,function(){var t;return a(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.tryUpdateServiceDataExtent(e)];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),v.isAbortError(t)||this._set("serviceDataExtent",d.clone(this.layerView.fullExtentInLocalViewSpatialReference)),[3,3];case 3:return[2]}})})},t.prototype.tryUpdateServiceDataExtent=function(e){return s(this,void 0,void 0,function(){var t,r,i,s,o,l,u,c,p,h,f,m;return a(this,function(a){switch(a.label){case 0:return t=this.layerView,(r=t.layer,i=r.capabilities.query.supportsExtent,s=d.clone(t.fullExtentInLocalViewSpatialReference),o=r.fullExtent,l=this.fullExtentIsAccurate(),u=this.serviceDataCount,c=i&&u<=n.constants.MAX_FEATURE_COUNT_FOR_EXTENT&&(!s||!l))?(p=this.createDataInfoQuery(),[4,r.queryExtent(p,{timeout:n.constants.QUERY_EXTENT_TIMEOUT,signal:e})]):[3,2];case 1:return h=a.sent(),this._set("serviceDataExtent",h.extent),[3,6];case 2:return s?(this._set("serviceDataExtent",s),[3,6]):[3,3];case 3:return o?(f="portalItem"in r?r.portalItem:null,[4,F.projectGeometry(o,t.view.spatialReference,f,e)]):[3,5];case 4:return m=a.sent(),this._set("serviceDataExtent",m),[3,6];case 5:this._set("serviceDataExtent",null),a.label=6;case 6:return[2]}})})},t.prototype.updateServiceDataCount=function(e){return s(this,void 0,void 0,function(){var t,r,i;return a(this,function(a){switch(a.label){case 0:return t=this.layerView.layer,[4,l.result(t.queryFeatureCount(this.createDataInfoQuery(),{timeout:n.constants.QUERY_STATISTICS_TIMEOUT,signal:e}))];case 1:if(r=a.sent(),!0===r.ok)this._set("serviceDataCount",r.value);else{if(v.isAbortError(r.error))throw r.error;i=n.constants.NO_SERVICE_DATA_COUNT,this._set("serviceDataCount",i)}return[2]}})})},Object.defineProperty(t.prototype,"vertexLimitInfo",{get:function(){if(!this.displayFeatureLimit||!this.displayFeatureLimit.maximumSymbolComplexity)return null;var e=this.displayFeatureLimit,t=e.maximumSymbolComplexity,r=e.maximumTotalNumberOfPrimitives,i=t.primitivesPerCoordinate,n=t.primitivesPerFeature,a=this._get("vertexLimitInfo");return a&&a.maximumTotalNumberOfPrimitives===r&&a.primitivesPerCoordinate===i&&a.primitivesPerFeature===n?a:{primitivesPerCoordinate:i,primitivesPerFeature:n,maximumTotalNumberOfPrimitives:r}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"supportsExceedsLimitQuery",{get:function(){var e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minimumNumberOfVerticesForGeometry",{get:function(){var e=this.layerView.layer.geometryType;switch(e){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return c.neverReached(e),0}},enumerable:!0,configurable:!0}),t.prototype.updateVertexLimitExceeded=function(e,t){return s(this,void 0,void 0,function(){var r,i,s,o,u,c,p,h,d,f,y,x,g,b;return a(this,function(a){switch(a.label){case 0:return r=this.vertexLimitInfo&&this.vertexLimitInfo.primitivesPerFeature<=0,(i=this.layerView.layer,s=this.supportsExceedsLimitQuery,r)?(o=this.vertexLimitInfo,u=o.primitivesPerFeature,c=o.primitivesPerCoordinate,p=o.maximumTotalNumberOfPrimitives,h=0!==u,h&&m.isSome(e)?[4,e]:[3,2]):(this._set("vertexLimitExceeded",!1),[2]);case 1:a.sent(),a.label=2;case 2:return d=this.serviceDataCount,(y=d!==n.constants.NO_SERVICE_DATA_COUNT,f=y?Math.ceil((p-d*u)/(c||1)):Math.ceil(p/(c||1)),y&&this.minimumNumberOfVerticesForGeometry*d>f)?(this._set("vertexLimitExceeded",!0),[2]):(s||this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>f),[4,l.result(i.queryFeatures(this.createVertexLimitExceededQuery(f),{timeout:n.constants.QUERY_STATISTICS_TIMEOUT,signal:t}))]);case 3:if(x=a.sent(),!1===x.ok){if(v.isAbortError(x.error))throw x.error;return this._set("vertexLimitExceeded",!1),[2]}return g=x.value,b=g.features[0],b&&b.attributes?this._set("vertexLimitExceeded",!!b.attributes.exceedslimit):this._set("vertexLimitExceeded",!1),[2]}})})},t.prototype.fetchServiceDataInfo=function(){return s(this,void 0,void 0,function(){var e,t,r,i,n,s=this;return a(this,function(a){return this.cancelFetchServiceDataInfo(),e=v.createAbortController(),t=e.signal,r=this.updateServiceDataCount(t),i=v.eachAlways([r,this.updateVertexLimitExceeded(r,t)]),n=i.then(function(){return s.updateServiceDataExtent(t)}).catch(function(e){v.isAbortError(e)||D.error("#fetchServiceDataInfo()",e)}).then(function(){n===s.fetchDataInfoPromise&&(s.fetchDataInfoPromise=null,s.fetchDataInfoAbortController=null),e=null}),e&&(this.fetchDataInfoPromise=n),this.fetchDataInfoAbortController=e,[2,i.catch(function(){})]})})},t.prototype.cancelFetchServiceDataInfo=function(){var e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())},Object.defineProperty(t.prototype,"debug",{get:function(){return{storedFeatures:this.tileFetcher?this.tileFetcher.storedFeatures:0,totalFeatures:this.tileFetcher?this.tileFetcher.totalFeatures:0,totalVertices:this.tileFetcher?this.tileFetcher.totalVertices:0}},enumerable:!0,configurable:!0});var n;return i([g.property({readOnly:!0})],t.prototype,"type",void 0),i([g.property({constructOnly:!0})],t.prototype,"graphics",void 0),i([g.property({constructOnly:!0})],t.prototype,"layerView",void 0),i([g.property()],t.prototype,"extent",null),i([g.property({dependsOn:["tileFetcher.updating","mode","layerView.view.featureTiles.updating","fetchDataInfoPromise","asyncTasks.length"]})],t.prototype,"updating",null),i([g.property({dependsOn:["updating","tileFetcher.updatingTotal"]})],t.prototype,"updatingTotal",null),i([g.property({dependsOn:["updating","tileFetcher.updatingRemaining"]})],t.prototype,"updatingRemaining",null),i([g.property({dependsOn:["updating","tileFetcher.expectedFeatureDiff"]})],t.prototype,"expectedFeatureDiff",null),i([g.property({dependsOn:["tileFetcher.memoryForUnusedFeatures"]})],t.prototype,"memoryForUnusedFeatures",null),i([g.property({dependsOn:["tileFetcher.maximumNumberOfFeaturesExceeded"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),i([g.property({readOnly:!0})],t.prototype,"serviceDataExtent",void 0),i([g.property({readOnly:!0})],t.prototype,"serviceDataCount",void 0),i([g.property({readOnly:!0})],t.prototype,"vertexLimitExceeded",void 0),i([g.property({readOnly:!0,dependsOn:["extent"]})],t.prototype,"filteredDataExtent",null),i([g.property()],t.prototype,"displayFeatureLimit",void 0),i([g.property({type:Number,dependsOn:["displayFeatureLimit"]})],t.prototype,"maximumNumberOfFeatures",null),i([g.property({readOnly:!0,dependsOn:["serviceDataCount","displayFeatureLimit","maximumNumberOfFeatures","vertexLimitExceeded","serviceDataExtent","layerView.layer.minScale","layerView.view.featureTiles.tilingScheme"]})],t.prototype,"mode",null),i([g.property({readOnly:!0,dependsOn:["mode","tileFetcher.totalVertices"]})],t.prototype,"maxTotalSnapshotVertices",null),i([g.property({readOnly:!0,dependsOn:["mode"]})],t.prototype,"tileDescriptors",null),i([g.property({constructOnly:!0})],t.prototype,"hasZ",void 0),i([g.property({constructOnly:!0})],t.prototype,"hasM",void 0),i([g.property({readOnly:!0})],t.prototype,"asyncTasks",void 0),i([g.property()],t.prototype,"tileFetcher",void 0),i([g.property()],t.prototype,"fetchDataInfoPromise",void 0),i([g.property({readOnly:!0,dependsOn:["displayFeatureLimit"]})],t.prototype,"vertexLimitInfo",null),t=n=i([g.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],t)}(g.declared(o,y));return function(e){!function(e){function t(){e.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,e.QUERY_STATISTICS_TIMEOUT=12e3,e.QUERY_EXTENT_TIMEOUT=1e4}e.NO_SERVICE_DATA_COUNT=1/0,e.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,e.reset=t}(e.constants||(e.constants={}))}(w||(w={})),w.constants.reset(),w});