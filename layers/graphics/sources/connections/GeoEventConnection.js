// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../FeatureLayer","./StreamConnection","../../../../tasks/operations/query","../../../../tasks/support/Query"],function(e,t,r,n,o,i,s,c,u,a,d,h,l,f,p,y){Object.defineProperty(t,"__esModule",{value:!0});var v,_=u.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection");!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(v=t.ReadyState||(t.ReadyState={}));var g=function(e){function t(t,r,n,o,i,s){void 0===o&&(o=5),void 0===i&&(i=3);var c=e.call(this)||this;return c.errorString=null,c._source=t,c._spatialReference=r,c._filter=n,c._outFields=s,c._maxQueryDepth=o,c._maxRecordCountFactor=i,c._open(),c}return i(t,e),t.prototype._open=function(){return o(this,void 0,void 0,function(){var e,t,n,o;return r(this,function(r){switch(r.label){case 0:return[4,this._fetchServiceDefinition(this._source)];case 1:return e=r.sent(),e.timeInfo.trackIdField?[4,this._fetchWebSocketUrl(e.streamUrls,this._spatialReference)]:(_.error(new c("geoevent-connection","Found an invalid GeoEvent service configuration. No TrackIdField found. Unable to establish WebSocket connection.")),[2]);case 2:return t=r.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return r.sent(),[4,this._tryCreateWebSocket(t)];case 4:return r.sent(),n=this._filter,o=this._outFields,this._setFilter(n,o),[2]}})})},t.prototype.destroy=function(){a.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null},Object.defineProperty(t.prototype,"connectionStatus",{get:function(){if(a.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case v.CONNECTING:case v.OPEN:return"connected";case v.CLOSING:case v.CLOSED:return"disconnected"}},enumerable:!0,configurable:!0}),t.prototype._tryCreateWebSocket=function(e,t){return void 0===t&&(t=1e3),o(this,void 0,void 0,function(){var n,o,i;return r(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,4]),n=this,[4,this._createWebSocket(e)];case 1:return n._websocket=r.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return o=r.sent(),i=t/1e3,_.error(new c("geoevent-connection","Failed to connect. Attempting to reconnect in "+i+"s",o)),[4,d.after(t)];case 3:return r.sent(),[2,this._tryCreateWebSocket(e,1.5*t)];case 4:return[2]}})})},t.prototype._createWebSocket=function(e){var t=this,r=new WebSocket(e),n=d.create(function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}});return n.then(function(){r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}}),n},t.prototype._onMessage=function(e){var t;try{t=this._enrich(JSON.parse(e.data))}catch(e){return void _.error(new c("geoevent-connection","Failed to parse message",e))}this.onFeature(t)},t.prototype._onError=function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),_.error("geoevent-connection",t)},t.prototype._onClose=function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&_.error("geoevent-connection","WebSocket closed unexpectedly with error code "+e.code),this._open()},t.prototype._fetchServiceDefinition=function(e){return o(this,void 0,void 0,function(){var t,n,o,i;return r(this,function(r){switch(r.label){case 0:return t={f:"json"},n=s(e,{query:t,responseType:"json"}),[4,n];case 1:return o=r.sent(),i=o.data,this._serviceDefinition=i,[2,i]}})})},t.prototype._fetchWebSocketUrl=function(e,t){return o(this,void 0,void 0,function(){var n,o,i,s;return r(this,function(r){return n=e[0],o=n.urls,i=n.token,s=this._inferWebSocketBaseUrl(o),[2,s+"/subscribe?outSR="+t.wkid+(i?"&token="+i:"")]})})},t.prototype._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(var t=0,r=e;t<r.length;t++){var n=r[t];if(-1!==n.indexOf("wss"))return n}return _.error(new c("geoevent-connection","Unable to infer WebSocket url",e)),null},t.prototype._setFilter=function(e,t){return o(this,void 0,void 0,function(){var n,o,i,s,u,h,l=this;return r(this,function(r){return n=this._websocket,this._filter=e,this._outFields=t,a.isNone(n)||a.isNone(e)&&a.isNone(t)?[2]:(o=JSON.stringify({filter:this._serializeFilter(e,t)}),i=!1,s=d.createResolver(),u=function(){i||(l._websocket===n&&_.error(new c("geoevent-connection","Server timed out when setting filter")),s.reject())},h=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(_.error(new c("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - "+t.error),s.reject(t.error)),n.onmessage=l._onMessage.bind(l),i=!0,s.resolve())},n.onmessage=h,n.send(o),setTimeout(u,1e4),[2,s.promise])})})},t.prototype._serializeFilter=function(e,t){var r={};return a.isNone(e)&&a.isNone(t)?r:(a.isSome(e)&&e.geometry&&(r.geometry=JSON.stringify(e.geometry)),a.isSome(e)&&e.where&&(r.where=e.where),a.isSome(t)&&(r.outFields=t.join(",")),r)},t.prototype._enrich=function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return _.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),o=n.attributes,i=n.geometry;for(var s in o)e.attributes[s]=o[s];return i&&(e.geometry=i),e.geometry||e.centroid||_.error(new c("geoevent-connection","Found malformed feature - no geometry found",e)),e},t.prototype._queryBuddyServices=function(){return o(this,void 0,void 0,function(){var e,t,n,o,i,s,u,a,d,h;return r(this,function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),e=this._serviceDefinition,t=e.relatedFeatures,n=e.keepLatestArchive,o=this._queryRelatedFeatures(t),i=this._queryArchive(n),[4,o];case 1:return r.sent(),[4,i];case 2:if(!(s=r.sent()))return[2];for(u=0,a=s.features;u<a.length;u++)d=a[u],this.onFeature(this._enrich(d));return[3,4];case 3:return h=r.sent(),_.error(new c("geoevent-connection","Encountered an error when querying buddy services",{error:h})),[3,4];case 4:return[2]}})})},t.prototype._queryRelatedFeatures=function(e){return o(this,void 0,void 0,function(){var t;return r(this,function(r){switch(r.label){case 0:return e?[4,this._queryBuddy(e.featuresUrl)]:[2];case 1:return t=r.sent(),this._addRelatedFeatures(t),[2]}})})},t.prototype._queryArchive=function(e){return o(this,void 0,void 0,function(){return r(this,function(t){return e?[2,this._queryBuddy(e.featuresUrl)]:[2]})})},t.prototype._queryBuddy=function(e){return o(this,void 0,void 0,function(){var t,n,o,i,s,c,u,d,h;return r(this,function(r){switch(r.label){case 0:return t=new l({url:e}),[4,t.load()];case 1:return n=r.sent().capabilities,o=n.query.supportsMaxRecordCountFactor,i=n.query.supportsPagination,s=n.query.supportsCentroid,c=this._maxRecordCountFactor,u=o?t.maxRecordCount*c:t.maxRecordCount,d=new y,d.outFields=a.unwrapOr(this._outFields,["*"]),d.where=a.unwrapOr(a.get(this._filter,"where"),"1=1"),d.returnGeometry=!0,d.returnExceededLimitFeatures=!0,d.outSpatialReference=this._spatialReference,s&&(d.returnCentroid=!0),o&&(d.maxRecordCountFactor=c),i?(d.num=u,t.destroy(),[2,this._queryPages(e,d)]):[4,p.executeQuery(e,d)];case 2:return h=r.sent(),t.destroy(),[2,h.data]}})})},t.prototype._queryPages=function(e,t,n,i){return void 0===n&&(n=[]),void 0===i&&(i=0),o(this,void 0,void 0,function(){var o;return r(this,function(r){switch(r.label){case 0:return t.start=i*t.num,[4,p.executeQuery(e,t)];case 1:return o=r.sent().data,o.exceededTransferLimit&&i<this._maxQueryDepth?(o.features.forEach(function(e){return n.push(e)}),[2,this._queryPages(e,t,n,i+1)]):(n.forEach(function(e){return o.features.push(e)}),[2,o])}})})},t.prototype._addRelatedFeatures=function(e){for(var t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField,o=0,i=r;o<i.length;o++){var s=i[o],c=s.attributes[n];t.set(c,s)}this._relatedFeatures=t},n([h.property()],t.prototype,"connectionStatus",null),n([h.property()],t.prototype,"errorString",void 0),t=n([h.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],t)}(h.declared(f.default));t.default=g});