// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Map","@dojo/framework/shim/Set","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/MemCache","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./timeSupport","./utils","../../support/FieldsIndex","../../support/PromiseQueue"],function(e,t,r,i,n,s,u,a,o,c,h,l,f,d,p,y,m,g,_,x,S,Q,v,b,E,R,F,I){Object.defineProperty(t,"__esModule",{value:!0});var w=h.getLogger("esri.layers.graphics.data.QueryEngine"),T=function(){function e(e,t,r,i,n){this.attributes=e,this.localId=t,this.geometry=r,this.centroid=i,this.filterFlags=n}return e}();t.Feature=T;var C=new a.default,j=new l.MemCacheStorage(2e6),P=0,k=function(){function e(e){var t=this;this.capabilities={query:Q.queryCapabilities},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.gdbVersion=e.gdbVersion,this.historicMoment=e.historicMoment,this.featureStore=e.featureStore,this._changeHandle=this.featureStore.events.on("changed",function(){return t.clearCache()}),this.timeInfo=e.timeInfo,this.cacheSpatialQueries&&(this._geometryQueryCache=new l.MemCache(P+++"$$",j)),this.fieldsIndex=new F(e.fields),e.scheduler&&e.priority&&(this._frameQueue=new I.PromiseQueue,this._frameTask=e.scheduler.registerTask(e.priority,function(e){return t._update(e)},function(){return t._frameQueue.length>0}))}return e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()},Object.defineProperty(e.prototype,"featureAdapter",{get:function(){return this.featureStore.featureAdapter},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullExtent",{get:function(){var e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:R.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:(this._timeExtent=E.getTimeExtent(this.timeInfo,this.featureStore),this._timeExtent):null},enumerable:!0,configurable:!0}),e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null},e.prototype.executeQuery=function(e,t){return void 0===e&&(e={}),n(this,void 0,void 0,function(){var t,r,n;return i(this,function(i){switch(i.label){case 0:t=c.clone(e),i.label=1;case 1:return i.trys.push([1,13,,14]),[4,R.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 2:return t=i.sent(),[4,this._reschedule()];case 3:return i.sent(),[4,this._checkQuerySupport(t)];case 4:return t=i.sent(),[4,this._reschedule()];case 5:return i.sent(),[4,this._executeGeometryQuery(t)];case 6:return r=i.sent(),[4,this._reschedule()];case 7:return i.sent(),[4,r.executeObjectIdsQuery(t)];case 8:return r=i.sent(),[4,this._reschedule()];case 9:return i.sent(),[4,r.executeTimeQuery(t)];case 10:return r=i.sent(),[4,this._reschedule()];case 11:return i.sent(),[4,r.executeAttributesQuery(t)];case 12:return r=i.sent(),[3,14];case 13:if((n=i.sent())!==R.QUERY_ENGINE_EMPTY_RESULT)throw n;return r=new v.default([],null,this),[3,14];case 14:return[2,r.createQueryResponse(t)]}})})},e.prototype.executeQueryForCount=function(e,t){return void 0===e&&(e={}),n(this,void 0,void 0,function(){var t,r,n;return i(this,function(i){switch(i.label){case 0:t=c.clone(e),t.returnGeometry=!1,t.returnCentroid=!1,t.outSR=null,i.label=1;case 1:return i.trys.push([1,13,,14]),[4,R.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 2:return t=i.sent(),[4,this._reschedule()];case 3:return i.sent(),[4,this._checkQuerySupport(t)];case 4:return t=i.sent(),[4,this._reschedule()];case 5:return i.sent(),[4,this._executeGeometryQuery(t)];case 6:return r=i.sent(),[4,this._reschedule()];case 7:return i.sent(),[4,r.executeObjectIdsQuery(t)];case 8:return r=i.sent(),[4,this._reschedule()];case 9:return i.sent(),[4,r.executeTimeQuery(t)];case 10:return r=i.sent(),[4,this._reschedule()];case 11:return i.sent(),[4,r.executeAttributesQuery(t)];case 12:return r=i.sent(),[2,r.size];case 13:if((n=i.sent())!==R.QUERY_ENGINE_EMPTY_RESULT)throw n;return[2,0];case 14:return[2]}})})},e.prototype.executeQueryForExtent=function(e,t){return void 0===e&&(e={}),n(this,void 0,void 0,function(){var t,r,n,s,u,a,o,o,o,h;return i(this,function(i){switch(i.label){case 0:t=c.clone(e),n=t.outSR,i.label=1;case 1:return i.trys.push([1,13,,14]),[4,R.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 2:return t=i.sent(),[4,this._reschedule()];case 3:return i.sent(),[4,this._checkQuerySupport(t)];case 4:return t=i.sent(),t.returnGeometry=!0,t.returnCentroid=!1,t.outSR=null,[4,this._reschedule()];case 5:return i.sent(),[4,this._executeGeometryQuery(t)];case 6:return r=i.sent(),[4,this._reschedule()];case 7:return i.sent(),[4,r.executeObjectIdsQuery(t)];case 8:return r=i.sent(),[4,this._reschedule()];case 9:return i.sent(),[4,r.executeTimeQuery(t)];case 10:return r=i.sent(),[4,this._reschedule()];case 11:return i.sent(),[4,r.executeAttributesQuery(t)];case 12:return r=i.sent(),(s=r.size)?(p.set(A,p.NEGATIVE_INFINITY),this.featureStore.forEachBounds(r.items,function(e){return p.expand(A,e)},z),u={xmin:A[0],ymin:A[1],xmax:A[3],ymax:A[4],spatialReference:R.cleanFromGeometryEngine(this.spatialReference)},this.hasZ&&isFinite(A[2])&&isFinite(A[5])&&(u.zmin=A[2],u.zmax=A[5]),a=S.project(u,r.spatialReference,n),a.spatialReference=R.cleanFromGeometryEngine(n||this.spatialReference),a.xmax-a.xmin==0&&(o=d.getMetersPerUnitForSR(a.spatialReference),a.xmin-=o,a.xmax+=o),a.ymax-a.ymin==0&&(o=d.getMetersPerUnitForSR(a.spatialReference),a.ymin-=o,a.ymax+=o),this.hasZ&&null!=a.zmin&&null!=a.zmax&&a.zmax-a.zmin==0&&(o=d.getMetersPerUnitForSR(a.spatialReference),a.zmin-=o,a.zmax+=o),[2,{count:s,extent:a}]):[2,{count:s,extent:null}];case 13:if((h=i.sent())===R.QUERY_ENGINE_EMPTY_RESULT)return[2,{count:0,extent:null}];throw h;case 14:return[2]}})})},e.prototype.executeQueryForIds=function(e,t){return void 0===e&&(e={}),n(this,void 0,void 0,function(){return i(this,function(r){return[2,this.executeQueryForIdSet(e,t).then(function(e){return s.from(e)})]})})},e.prototype.executeQueryForIdSet=function(e,t){return void 0===e&&(e={}),n(this,void 0,void 0,function(){var t,r,n,s,u,o,h,l;return i(this,function(i){switch(i.label){case 0:t=c.clone(e),t.returnGeometry=!1,t.returnCentroid=!1,t.outSR=null,i.label=1;case 1:return i.trys.push([1,12,,13]),[4,R.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 2:return t=i.sent(),[4,this._reschedule()];case 3:return i.sent(),[4,this._executeGeometryQuery(t)];case 4:return r=i.sent(),[4,this._reschedule()];case 5:return i.sent(),[4,r.executeObjectIdsQuery(t)];case 6:return r=i.sent(),[4,this._reschedule()];case 7:return i.sent(),[4,r.executeTimeQuery(t)];case 8:return r=i.sent(),[4,this._reschedule()];case 9:return i.sent(),[4,r.executeAttributesQuery(t)];case 10:return r=i.sent(),[4,this._reschedule()];case 11:for(i.sent(),n=r.items,s=new a.default,u=0,o=n;u<o.length;u++)h=o[u],s.add(r.featureAdapter.getObjectId(h));return[2,s];case 12:if((l=i.sent())===R.QUERY_ENGINE_EMPTY_RESULT)return[2,new a.default];throw l;case 13:return[2]}})})},e.prototype.executeQueryForLatestObservations=function(e,t){var r=this;return this.timeInfo?this.executeQuery(e,t).then(function(e){return r._filterLatest(e,r.timeInfo)}):void w.error(new o("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))},e.prototype._reschedule=function(e){return n(this,void 0,void 0,function(){return i(this,function(t){return this._frameQueue?[2,this._frameQueue.push(e).then(function(e){return e})]:[2,e]})})},e.prototype._update=function(e){for(this._budget=e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null},e.prototype._filterLatest=function(e,t){for(var i=t.trackIdField,n=t.startTimeField,s=t.endTimeField,a=s||n,o=new u.default,c=[],h=0,l=e.features;h<l.length;h++){var f=l[h],d=f.attributes[i],p=f.attributes[a];(!o.has(d)||o.get(d).attributes[a]<p)&&o.set(d,f)}return o.forEach(function(e){return c.push(e)}),r({},e,{features:c})},e.prototype._getAll=function(){if(!this._allItems){var e=[];this.featureStore.forEach(function(t){return e.push(t)}),this._allItems=new v.default(e,null,this)}return this._allItems},e.prototype._executeGeometryQuery=function(e){return n(this,void 0,void 0,function(){var t,r,s,u,o,c,h,l,f,d,p,y,m,g,x,S,Q,E,R,F,I,R,w,T,C,j=this;return i(this,function(P){switch(P.label){case 0:if(t=e.geometry,r=e.outSR,s=e.spatialRel,u=_.isValid(r)&&!_.equals(this.spatialReference,r),(o=this.cacheSpatialQueries?u?JSON.stringify({geometry:t,spatialRelationship:s,outSpatialReference:r}):JSON.stringify({geometry:t,spatialRelationship:s}):null)&&void 0!==(c=this._geometryQueryCache.get(o)))return[2,c];if(h=function(t){return n(j,void 0,void 0,function(){var n;return i(this,function(i){switch(i.label){case 0:return u&&(e.returnGeometry||e.returnCentroid)?[4,t.project(r)]:[3,2];case 1:return n=i.sent(),o&&this._geometryQueryCache.put(o,n,n.size||1),[2,n];case 2:return o&&this._geometryQueryCache.put(o,t,t.size||1),[2,t]}})})},!t)return[2,h(this._getAll())];if(l=this.featureAdapter,"esriSpatialRelDisjoint"!==s)return[3,5];if(f=this._searchFeatures(this._getQueryBBoxes(t)),!f.length)return[2,h(this._getAll())];for(y=new a.default,m=0,g=f;m<g.length;m++)x=g[m],y.add(l.getObjectId(x));return[4,this._reschedule(y)];case 1:return y=P.sent(),S=0,d=new Array(y.size),this.featureStore.forEach(function(e){return d[S++]=e}),p=y,[4,this._reschedule()];case 2:return P.sent(),[4,b.getSpatialQueryOperator(s,t,this)];case 3:return Q=P.sent(),E=function(e){return!p.has(l.getObjectId(e))||Q(l.getGeometry(e))},F=v.default.bind,[4,this._runSpatialFilter(d,E)];case 4:return R=new(F.apply(v.default,[void 0,P.sent(),t,this])),[2,h(R)];case 5:return I=this._searchFeatures(this._getQueryBBoxes(t)),I.length?(w=this._canExecuteSoloPass(t,e),w?[2,h(new v.default(I,t,this))]:[4,b.getSpatialQueryOperator(s,t,this)]):(R=new v.default([],t,this),o&&this._geometryQueryCache.put(o,R,R.size||1),[2,R]);case 6:return T=P.sent(),[4,this._runSpatialFilter(I,function(e){return T(l.getGeometry(e))})];case 7:return C=P.sent(),[2,h(new v.default(C,t,this))]}})})},e.prototype._runSpatialFilter=function(e,t){return n(this,void 0,void 0,function(){var r,s,u,a=this;return i(this,function(o){return t?this._budget?(r=0,s=new Array,u=function(){return n(a,void 0,void 0,function(){var n;return i(this,function(i){switch(i.label){case 0:return r<e.length?(n=e[r],t(n)&&s.push(n),this._budget.done?[4,this._reschedule()]:[3,2]):[3,3];case 1:return i.sent(),[2,u()];case 2:return++r,[3,0];case 3:return[2]}})})},[2,this._reschedule().then(function(){return u()}).then(function(){return s})]):[2,e.filter(function(e){return t(e)})]:[2,e]})})},e.prototype._canExecuteSoloPass=function(e,t){var r=this.geometryType,i=t.spatialRel;return b.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===i||"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===i||"esriSpatialRelContains"===i||"esriSpatialRelWithin"===i))},e.prototype._getQueryBBoxes=function(e){if(b.canQueryWithRBush(e)){if(g.isExtent(e))return[y.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(g.isPolygon(e))return e.rings.map(function(e){return y.fromValues(e[0][0],e[0][1],e[2][0],e[2][1])})}return[m.getBoundsXY(y.create(),e)]},e.prototype._searchFeatures=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];this.featureStore.forEachInBounds(i,function(e){C.add(e)})}var n=new Array(C.size),s=0;return C.forEach(function(e){return n[s++]=e}),C.clear(),n},e.prototype._checkQuerySupport=function(e){return n(this,void 0,void 0,function(){return i(this,function(t){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new o("feature-store:unsupported-query","Unsupported query options",{query:e});return[2,f.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),b.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),S.checkProjectionSupport(this.spatialReference,e.outSR)]).then(function(){return e})]})})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,r=e.orderByFields,i=e.returnDistinctValues;if(r&&r.length>0){var n=r.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});x.validateFields(this.fieldsIndex,n,"orderByFields contains missing fields")}if(t&&t.length>0)x.validateFields(this.fieldsIndex,t,"outFields contains missing fields");else if(i)throw new o("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});x.validateWhere(this.fieldsIndex,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){return n(this,void 0,void 0,function(){var t,r,n,s,u,a,c,h,l,f,d,p;return i(this,function(i){if(t=e.outStatistics,r=e.groupByFieldsForStatistics,n=e.having,s=r&&r.length,u=t&&t.length,n){if(!s||!u)throw new o("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});x.validateHaving(this.fieldsIndex,n,t)}if(u){if(a=t.some(function(e){return"exceedslimit"===e.statisticType}))return[2];for(c=t.map(function(e){return e.onStatisticField}),x.validateFields(this.fieldsIndex,c,"onStatisticFields contains missing fields"),s&&x.validateFields(this.fieldsIndex,r,"groupByFieldsForStatistics contains missing fields"),h=0,l=t;h<l.length;h++){if(f=l[h],d=f.onStatisticField,p=f.statisticType,"exceedslimit"===p)throw new o("feature-store:unsupported-query","statistic type exceedslimit is not supported",{definition:f,query:e});if((!s||"count"!==p)&&d&&x.hasInvalidFieldType(d,this.fieldsIndex))throw new o("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:f,query:e})}}return[2]})})},e}();t.default=k;var z=p.create(),A=p.create()});