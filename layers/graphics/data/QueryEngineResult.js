// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/iteratorUtils","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils"],function(e,t,r,i,s,a,n,o,u,l,h,f,c,p,m,d){Object.defineProperty(t,"__esModule",{value:!0});var y=function(){function e(e,t,r){this.items=e,this.queryGeometry=t,this.definitionExpression=r.definitionExpression,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.fieldsIndex=r.fieldsIndex,this.timeInfo=r.timeInfo,this.featureAdapter=r.featureAdapter}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){var t;if(e.outStatistics){t=e.outStatistics.some(function(e){return"exceedslimit"===e.statisticType})?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e)}else t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(l.isValid(e.outSR)&&!l.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=d.cleanFromGeometryEngine(r({spatialReference:e.outSR},p.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=d.cleanFromGeometryEngine(r({spatialReference:e.outSR},this.queryGeometry))),t},e.prototype.executeAttributesQuery=function(t){var r=c.getWhereClause(t.where,this.fieldsIndex);if(!r)return o.resolve(this);if(r.isStandardized){for(var i=0,s=[],a=0,n=this.items;a<n.length;a++){var u=n[a];r.testFeature(u,this.featureAdapter)&&(s[i++]=u)}var l=new e(s,this.queryGeometry,this);return l.definitionExpression=t.where,o.resolve(l)}return o.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(t){if(!t.objectIds||!t.objectIds.length)return o.resolve(this);var r=a.SetFromValues(t.objectIds),i=this.featureAdapter.getObjectId;return o.resolve(new e(this.items.filter(function(e){return r.has(i(e))}),this.queryGeometry,this))},e.prototype.executeTimeQuery=function(t){var r=m.getTimeOperator(this.timeInfo,t.timeExtent,this.featureAdapter);if(!n.isSome(r))return o.resolve(this);var i=this.items.filter(r);return o.resolve(new e(i,this.queryGeometry,this))},e.prototype.project=function(t){return s(this,void 0,void 0,function(){var r,s,a,n=this;return i(this,function(i){switch(i.label){case 0:return!t||l.equals(this.spatialReference,t)?[2,this]:(r=this.featureAdapter,[4,p.projectMany(this.items.map(function(e){return d.getGeometry(n,r.getGeometry(e))}),this.spatialReference,t)]);case 1:return s=i.sent(),a=s.map(function(e,t){return r.cloneWithGeometry(n.items[t],h.convertFromGeometry(e,n.hasZ,n.hasM))}),[2,new e(a,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:t,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}})})},e.prototype._createFeatureQueryResponse=function(e){var t=this,r=this.items,i=this,s=i.geometryType,a=i.hasM,n=i.hasZ,o=i.objectIdField,l=i.spatialReference,h=e.outFields,f=e.outSR,c=e.quantizationParameters,p=e.resultRecordCount,m=e.resultOffset,y=!1;if(null!=p&&null!=m){var g=m+p;y=r.length>g,r=r.slice(m,Math.min(r.length,g))}return{exceededTransferLimit:y,features:this._createFeatures(e,r),fields:h&&h.map(function(e){return t.fieldsIndex.get(e)}),geometryType:s,hasM:a,hasZ:n,objectIdFieldName:o,spatialReference:d.cleanFromGeometryEngine(f||l),transform:c&&u.toQuantizationTransform(c)||null}},e.prototype._createFeatures=function(e,t){var r=new f.default(e,this.featureAdapter,this.fieldsIndex),i=e.quantizationParameters,s=e.returnGeometry,a=e.returnCentroid,n=e.maxAllowableOffset,o=e.orderByFields,l=[],h=0;if(t.length&&o&&o.length){var c=o[0].split(" "),p=c[0],m=this.fieldsIndex.get(p),y="DESC"===c[1];t.sort(function(e,t){var i=r.getFieldValue(e,p,m),s=r.getFieldValue(t,p,m);if("number"==typeof i&&"number"==typeof s)return y?s-i:i-s;if("string"==typeof i&&"string"==typeof s){var a=i.toUpperCase(),n=s.toUpperCase();return(y?a>n:a<n)?-1:(y?a<n:a>n)?1:0}})}if(s||a){var g=u.toQuantizationTransform(i);if(s&&!a)for(var I=0,v=t;I<v.length;I++){var b=v[I];l[h++]={attributes:r.getAttributes(b),geometry:d.getGeometry(this,this.featureAdapter.getGeometry(b),n,g)}}else if(!s&&a)for(var x=0,F=t;x<F.length;x++){var b=F[x];l[h++]={attributes:r.getAttributes(b),centroid:d.transformCentroid(this,this.featureAdapter.getCentroid(b,this),g)}}else for(var T=0,S=t;T<S.length;T++){var b=S[T];l[h++]={attributes:r.getAttributes(b),centroid:d.transformCentroid(this,this.featureAdapter.getCentroid(b,this),g),geometry:d.getGeometry(this,this.featureAdapter.getGeometry(b),n,g)}}}else for(var N=0,R=t;N<R.length;N++){var b=R[N],G=r.getAttributes(b);G&&(l[h++]={attributes:G})}return l},e.prototype._createExceedsLimitQueryResponse=function(e){for(var t=!1,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=0,n=e.outStatistics;a<n.length;a++){var o=n[a];if("exceedslimit"===o.statisticType){r=null!=o.maxPointCount?o.maxPointCount:Number.POSITIVE_INFINITY,i=null!=o.maxRecordCount?o.maxRecordCount:Number.POSITIVE_INFINITY,s=null!=o.maxVertexCount?o.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)t=this.items.length>r;else if(this.items.length>i)t=!0;else{var u=this.hasZ?this.hasM?4:3:this.hasM?3:2,l=this.featureAdapter,h=this.items.reduce(function(e,t){var r=l.getGeometry(t);return e+(r&&r.coords.length||0)},0)/u;t=h>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},e.prototype._createStatisticsQueryResponse=function(e){for(var t=new f.default(e,this.featureAdapter,this.fieldsIndex),r=e.outStatistics,i=[],s=[],a=e.groupByFieldsForStatistics,n=e.having,o=a&&a.length,u=o&&a[0],l=this.fieldsIndex.get(u),h=!l,c={},p={},m={},d={attributes:{}},y=0,g=r;y<g.length;y++){var I=g[y],v=I.outStatisticFieldName,b=I.statisticType,x="exceedslimit"!==b?I.onStatisticField:void 0,F=this.fieldsIndex.get(x),T=o&&(x===u||h)&&"count"===b;if(o){c[x]||(c[x]=this._calculateUniqueValues(t,u,l));var S=c[x];for(var N in S){var R=S[N],G=R.count,_=R.data,A=R.items;if(!n||t.validateItems(A,n)){var E=p[_]||{attributes:{}},q=null;if(T)q=G;else{var V=this._calculateStatistics(A,t,x,F),j="var"===b?"variance":b;q=V[j]}E.attributes[v]=q,E.attributes[h?"EXPR_1":u]=_,p[_]=E}}}else{m[x]||(m[x]=this._calculateStatistics(this.items,t,x,F));var V=m[x],j="var"===b?"variance":b;d.attributes[v]=V[j]}s.push({name:v,alias:v,type:"esriFieldTypeDouble"})}if(o)for(var C in p)i.push(p[C]);else i.push(d);return{fields:s,features:i}},e.prototype._calculateStatistics=function(e,t,r,i){for(var s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,n=null,o=null,u=null,l=null,h=[],f=0,c=0;c<e.length;c++){var p=e[c],m=t.getFieldValue(p,r,i);"string"==typeof m?f++:null==m||isNaN(m)||(n+=m,s=Math.min(s,m),a=Math.max(a,m),h.push(m),f++)}if(f){o=n/f;for(var d=0,y=0,g=h;y<g.length;y++){var m=g[y];d+=Math.pow(m-o,2)}l=f>1?d/(f-1):0,u=Math.sqrt(l)}else s=null,a=null;return{avg:o,count:f,max:a,min:s,stddev:u,sum:n,variance:l}},e.prototype._calculateUniqueValues=function(e,t,r){for(var i={},s=0,a=this.items;s<a.length;s++){var n=a[s],o=e.getFieldValue(n,t,r);(null==o||"string"==typeof o&&""===o.trim())&&(o=null),null==i[o]?i[o]={count:1,data:o,items:[n]}:(i[o].count++,i[o].items.push(n))}return i},e}();t.default=y});