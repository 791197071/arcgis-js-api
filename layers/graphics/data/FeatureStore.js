// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/extendsHelper","../../../core/Error","../../../core/Evented","../../../core/has","../../../core/Logger","../../../core/maybe","../../../core/libs/rbush/rbush","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../featureConversionUtils","./optimizedFeatureQueryEngineAdapter"],function(e,t,r,o,n,i,s,a,u,d,h,f,y,_,p){function c(e,t){return l.minX=t[0],l.minY=t[1],l.maxX=t[2],l.maxY=t[3],e.search(l)}Object.defineProperty(t,"__esModule",{value:!0});var m=[],g=u.getLogger("esri.layers.graphics.data.FeatureStore"),l={minX:0,minY:0,maxX:0,maxY:0},B=function(){function e(e,t,r){this._geometryInfo=e,this._onFeatureAdd=t,this._onFeatureRemove=r,this._featuresById=new Map,this._boundsByFeature=new Map,this._featuresByBounds=new Map,this._index=h(9,a("csp-restrictions")?function(e){return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}:["[0]","[1]","[2]","[3]"]),this.events=new s,this.featureAdapter=p.optimizedFeatureQueryEngineAdapter}return Object.defineProperty(e.prototype,"geometryType",{get:function(){return this._geometryInfo.geometryType},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasM",{get:function(){return this._geometryInfo.hasM},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasZ",{get:function(){return this._geometryInfo.hasZ},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numFeatures",{get:function(){return this._featuresById.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullBounds",{get:function(){if(!this.numFeatures)return null;var e=y.create(y.NEGATIVE_INFINITY);return this._boundsByFeature.forEach(function(t){t&&(e[0]=Math.min(t[0],e[0]),e[1]=Math.min(t[1],e[1]),e[2]=Math.max(t[2],e[2]),e[3]=Math.max(t[3],e[3]))}),e},enumerable:!0,configurable:!0}),e.prototype.add=function(e){this._add(e,m),this._index.load(m),this._emitChanged(),m.length=0},e.prototype.addMany=function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];this._add(o,m)}this._index.load(m),this._emitChanged(),m.length=0},e.prototype.clear=function(){this._featuresById.clear(),this._boundsByFeature.clear(),this._featuresByBounds.clear(),this._index.clear(),this._emitChanged()},e.prototype.removeById=function(e){var t=this._featuresById.get(e);if(!t)return null;var r=this._boundsByFeature.get(t);return r&&(this._index.remove(r),this._featuresByBounds.delete(r)),this._boundsByFeature.delete(t),this._featuresById.delete(e),this._emitChanged(),t},e.prototype.removeIf=function(e,t){var r=this;this._featuresById.forEach(function(o,n){t(o)&&(r._remove(o),e.push(o))}),this._emitChanged()},e.prototype.removeManyById=function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t],n=this._featuresById.get(o);if(n){var i=this._boundsByFeature.get(n);i&&(this._index.remove(i),this._featuresByBounds.delete(i)),this._boundsByFeature.delete(n)}this._featuresById.delete(o)}this._emitChanged()},e.prototype.forEachBounds=function(e,t,r){for(var o=0,n=e;o<n.length;o++){var i=n[o],s=this._boundsByFeature.get(i);s&&t(f.fromRect(r,s))}},e.prototype.getFeature=function(e){return this._featuresById.get(e)},e.prototype.has=function(e){return this._featuresById.has(e)},e.prototype.forEach=function(e){this._featuresById.forEach(function(t){return e(t)})},e.prototype.forEachInBounds=function(e,t){for(var r=0,o=c(this._index,e);r<o.length;r++){var n=o[r];t(this._featuresByBounds.get(n))}},e.prototype.transferById=function(e,t){var r=this._featuresById.get(t);r&&(this._remove(r),e.add(r),this._emitChanged())},e.prototype.transferByIds=function(e,t){for(var r=[],o=0,n=t;o<n.length;o++){var i=n[o],s=this._featuresById.get(i);s&&(this._remove(s),r.push(s))}e.addMany(r),this._emitChanged()},e.prototype.transferIdRange=function(e,t,r){for(var o=[],n=t;n<r;n++){var i=this._featuresById.get(n);i&&(this._remove(i),o.push(i))}e.addMany(o),this._emitChanged()},e.prototype.transferIf=function(e,t){var r=this,o=[];this._featuresById.forEach(function(e,n){t(e)&&(r._remove(e),o.push(e))}),e.addMany(o),this._emitChanged()},e.prototype.transferAll=function(e){var t=this,r=[];this._featuresById.forEach(function(e,o){t._remove(e),r.push(e)}),e.addMany(r),this._emitChanged()},e.prototype._emitChanged=function(){this.events.emit("changed",void 0)},e.prototype._add=function(e,t){if(e){var r=e.objectId;if(null==r)return void g.error(new i("featurestore:invalid-feature","feature id is missing",{feature:e}));var o,n=this._featuresById.get(r);if(n?(o=this._boundsByFeature.get(n),e.localId=n.localId,o&&(this._index.remove(o),this._boundsByFeature.delete(n),this._featuresByBounds.delete(o))):d.isSome(this._onFeatureAdd)&&this._onFeatureAdd(e),!e.geometry||!e.geometry.coords||!e.geometry.coords.length)return this._boundsByFeature.set(e,null),void this._featuresById.set(r,e);o=_.getBoundsOptimizedGeometry(o||y.create(),e.geometry,this._geometryInfo.hasZ,this._geometryInfo.hasM),this._boundsByFeature.set(e,o),this._featuresByBounds.set(o,e),this._featuresById.set(r,e),t.push(o)}},e.prototype._remove=function(e){var t;e&&(d.isSome(this._onFeatureRemove)&&this._onFeatureRemove(e),t=this._boundsByFeature.get(e),t&&(this._index.remove(t),this._boundsByFeature.delete(e),this._featuresByBounds.delete(t)),this._featuresById.delete(e.objectId))},e}();t.default=B});