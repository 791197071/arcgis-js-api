// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../PixelBlock"],function(t,e,n){function r(t,e){return e&&c(t)?e&&e.some(function(e){return e>t.pixels.length})?t:new n({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:e.map(function(e){return t.pixels[e]}),statistics:t.statistics&&e.map(function(e){return t.statistics[e]})}):t}function i(t){if(t){var e=t.colormap;if(e&&0!==e.length){var n=e.sort(function(t,e){return t[0]-e[0]}),r=0;n[0][0]<0&&(r=n[0][0]);var i,a=Math.max(256,n[n.length-1][0]-r+1),o=new Uint8Array(4*a),l=[],f=0,h=0,u=5===n[0].length;if(a>65536)return n.forEach(function(t){l[t[0]-r]=u?t.slice(1):t.slice(1).concat([255])}),{indexed2DColormap:l,offset:r,alphaSpecified:u};if(t.fillUnspecified)for(i=n[h],f=i[0]-r;f<a;f++)o[4*f]=i[1],o[4*f+1]=i[2],o[4*f+2]=i[3],o[4*f+3]=u?i[4]:255,f===i[0]-r&&(i=h===n.length-1?i:n[++h]);else for(f=0;f<n.length;f++)i=n[f],h=4*(i[0]-r),o[h]=i[1],o[h+1]=i[2],o[h+2]=i[3],o[h+3]=u?i[4]:255;return{indexedColormap:o,offset:r,alphaSpecified:u}}}}function a(t,e){if(!c(t))return t;if(!e&&(e.indexedColormap||e.indexed2DColormap))return t;var n=t.clone(),r=n.pixels,i=n.mask,a=n.width*n.height;if(1!==r.length)return t;var o,l=e.indexedColormap,f=e.indexed2DColormap,h=e.offset,u=e.alphaSpecified,s=l.length-1,x=0,m=r[0],p=new Uint8Array(m.length),d=new Uint8Array(m.length),y=new Uint8Array(m.length),g=0;if(l)if(i)for(x=0;x<a;x++)i[x]&&(g=4*(m[x]-h),g<h||g>s?i[x]=0:(p[x]=l[g],d[x]=l[g+1],y[x]=l[g+2],i[x]=l[g+3]));else{for(i=new Uint8Array(a),x=0;x<a;x++)g=4*(m[x]-h),g<h||g>s?i[x]=0:(p[x]=l[g],d[x]=l[g+1],y[x]=l[g+2],i[x]=l[g+3]);n.mask=i}else if(i)for(x=0;x<a;x++)i[x]&&(o=f[m[x]],p[x]=o[0],d[x]=o[1],y[x]=o[2],i[x]=o[3]);else{for(i=new Uint8Array(a),x=0;x<a;x++)o=f[m[x]],p[x]=o[0],d[x]=o[1],y[x]=o[2],i[x]=o[3];n.mask=i}return n.pixels=[p,d,y],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=u,n}function o(t){if(!c(t))return null;var e,n,r,i,a,o,l,f,h,u,s,x,m,p,d,y=t.pixels,g=t.mask,w=t.pixelType,M=t.statistics,v=t.width*t.height,k=y.length,A=[],C=[];for(i=0;i<k;i++){if(o=new Uint32Array(256),f=y[i],"u8"===w)if(e=-.5,n=255.5,g)for(a=0;a<v;a++)g[a]&&o[f[a]]++;else for(a=0;a<v;a++)o[f[a]]++;else{if(e=M[i].minValue,n=M[i].maxValue,r=(n-e)/256,l=new Uint32Array(257),g)for(a=0;a<v;a++)g[a]&&l[Math.floor((f[a]-e)/r)]++;else for(a=0;a<v;a++)l[Math.floor((f[a]-e)/r)]++;for(a=0;a<255;a++)o[a]=l[a];o[255]=l[255]+l[256]}for(A.push({min:e,max:n,size:256,counts:o}),h=0,u=0,m=0,a=0;a<256;a++)h+=o[a],u+=a*o[a];for(p=u/h,a=0;a<256;a++)m+=o[a]*Math.pow(a-p,2);d=Math.sqrt(m/(h-1)),r=(n-e)/256,s=(p+.5)*r+e,x=d*r,C.push({min:e,max:n,avg:s,stddev:x})}return{statistics:C,histograms:A}}function l(t){var e=t.minCutOff,n=t.maxCutOff,r=t.gamma,i=t.pixelType,a=t.outMin||0,o=t.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(i))return null;var l,h,u=e.length,s=0;"s8"===i?s=-127:"s16"===i&&(s=-32767);var x=256;["u16","s16"].indexOf(i)>-1&&(x=65536);var m=[],p=[],c=o-a;for(l=0;l<u;l++)p[l]=n[l]-e[l],m[l]=c/(n[l]-e[l]);var d=r&&r.length>=u,y=[];if(d)for(l=0;l<u;l++)r[l]>1?r[l]>2?y[l]=6.5+Math.pow(r[l]-2,2.5):y[l]=6.5+100*Math.pow(2-r[l],4):y[l]=1;var g,w,M,v,k=[];if(d)for(l=0;l<u;l++){for(v=[],h=0;h<x;h++)w=h+s,g=(w-e[l])/p[l],M=1,r[l]>1&&(M-=Math.pow(1/c,g*y[l])),w<n[l]&&w>e[l]?v[h]=Math.floor(M*c*Math.pow(g,1/r[l]))+a:w>=n[l]?v[h]=o:v[h]=a;k[l]=v}else for(l=0;l<u;l++){for(v=[],h=0;h<x;h++)w=h+s,w<=e[l]?v[h]=a:w>=n[l]?v[h]=o:v[h]=Math.floor((w-e[l])/p[l]*c)+a;k[l]=v}if(null!=t.contrastOffset){var A=f(t.contrastOffset,t.brightnessOffset);for(l=0;l<u;l++)for(v=k[l],h=0;h<x;h++)v[h]=A[v[h]]}return{lut:k,offset:s}}function f(t,e){var n,r,i=Math.min(Math.max(t,-100),100),a=Math.min(Math.max(e,-100),100),o=new Uint8Array(256);for(n=0;n<256;n++)i>0&&i<100?r=(200*n-25500+510*a)/(2*(100-i))+128:i<=0&&i>-100?r=(200*n-25500+510*a)*(100+i)/2e4+128:100===i?(r=200*n-25500+256*(100-i)+510*a,r=r>0?255:0):-100===i&&(r=128),o[n]=r>255?255:r<0?0:r;return o}function h(t,e){if(!c(t))return null;var n,r,i,a,o,l=t.clone(),f=l.pixels,h=l.mask,u=e.minCutOff,s=e.maxCutOff,x=e.gamma,m=e.outMin||0,p=e.outMax||255,d=l.width*l.height,y=f.length,g=p-m,w=[],M=[];for(n=0;n<y;n++)M[n]=s[n]-u[n],w[n]=g/(s[n]-u[n]);var v=x&&x.length>=y,k=[];if(v)for(n=0;n<y;n++)x[n]>1?x[n]>2?k[n]=6.5+Math.pow(x[n]-2,2.5):k[n]=6.5+100*Math.pow(2-x[n],4):k[n]=1;if(v)if(null!=h){for(r=0;r<d;r++)if(h[r])for(n=0;n<y;n++)i=f[n][r],o=(i-u[n])/M[n],a=1,x[n]>1&&(a-=Math.pow(1/g,o*k[n])),i<s[n]&&i>u[n]?f[n][r]=Math.floor(a*g*Math.pow(o,1/x[n]))+m:i>=s[n]?f[n][r]=p:f[n][r]=m}else for(r=0;r<d;r++)for(n=0;n<y;n++)i=f[n][r],o=(i-u[n])/M[n],a=1,x[n]>1&&(a-=Math.pow(1/g,o*k[n])),i<s[n]&&i>u[n]?f[n][r]=Math.floor(a*g*Math.pow(o,1/x[n]))+m:i>=s[n]?f[n][r]=p:f[n][r]=m;else if(null!=h){for(r=0;r<d;r++)if(h[r])for(n=0;n<y;n++)i=f[n][r],i<s[n]&&i>u[n]?f[n][r]=Math.floor((i-u[n])/M[n]*g)+m:i>=s[n]?f[n][r]=p:f[n][r]=m}else for(r=0;r<d;r++)for(n=0;n<y;n++)i=f[n][r],i<s[n]&&i>u[n]?f[n][r]=Math.floor((i-u[n])/M[n]*g)+m:i>=s[n]?f[n][r]=p:f[n][r]=m;return l.pixelType="u8",l.updateStatistics(),l}function u(t,e){if(!c(t))return null;var r,i,a=t.pixels,o=t.mask,l=t.width*t.height,f=a.length,h=e.lut,u=e.offset;h&&1===h[0].length&&(h=a.map(function(t){return h}));var s,x,m,p=[];if(u)if(null==o)for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(l),i=0;i<l;i++)m[i]=x[s[i]-u];p.push(m)}else for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(l),i=0;i<l;i++)o[i]&&(m[i]=x[s[i]-u]);p.push(m)}else if(null==o)for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(l),i=0;i<l;i++)m[i]=x[s[i]];p.push(m)}else for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(l),i=0;i<l;i++)o[i]&&(m[i]=x[s[i]]);p.push(m)}var d=new n({width:t.width,height:t.height,pixels:p,mask:o,pixelType:"u8"});return d.updateStatistics(),d}function s(t,e){if(!c(t))return null;var n,r,i,a,o,l,f=t.clone(),h=f.pixels,u=f.width*f.height,s=e.length,x=Math.floor(s/2),m=e[Math.floor(x)],p=h[0],d=!1,y=new Uint8Array(u),g=new Uint8Array(u),w=new Uint8Array(u),M=f.mask,v=4===e[0].mappedColor.length;for(M||(M=new Uint8Array(u),M.fill(v?255:1),f.mask=M),o=0;o<u;o++)if(M[o]){for(n=p[o],d=!1,l=x,r=m,i=0,a=s-1;a-i>1;){if(n===r.value){d=!0;break}n>r.value?i=l:a=l,l=Math.floor((i+a)/2),r=e[Math.floor(l)]}d||(n===e[i].value?(r=e[i],d=!0):n===e[a].value?(r=e[a],d=!0):n<e[i].value?(d=!1,r=null):n>e[i].value&&(n<e[a].value?(r=e[i],d=!0):a===s-1?(d=!1,r=null):(r=e[a],d=!0))),d?(y[o]=r.mappedColor[0],g[o]=r.mappedColor[1],w[o]=r.mappedColor[2],M[o]=r.mappedColor[3]):y[o]=g[o]=w[o]=M[o]=0}return f.pixels=[y,g,w],f.mask=M,f.pixelType="u8",f.maskIsAlpha=v,f}function x(t,e,n,r,i,a,o,l){return{xmin:i<=n*t?0:i<n*t+t?i-n*t:t,ymin:a<=r*e?0:a<r*e+e?a-r*e:e,xmax:i+o<=n*t?0:i+o<n*t+t?i+o-n*t:t,ymax:a+l<=r*e?0:a+l<r*e+e?a+l-r*e:e}}function m(t,e){if(!t||0===t.length)return null;var n=t.filter(function(t){return t.pixelBlock})[0];if(!n)return null;var r=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,i=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,a=.01*Math.min(r,i),o=t.sort(function(t,e){return Math.abs(t.extent.ymax-e.extent.ymax)>a?e.extent.ymax-t.extent.ymax:Math.abs(t.extent.xmin-e.extent.xmin)>a?t.extent.xmin-e.extent.xmin:0}),l=Math.min.apply(null,o.map(function(t){return t.extent.xmin})),f=Math.min.apply(null,o.map(function(t){return t.extent.ymin})),h=Math.max.apply(null,o.map(function(t){return t.extent.xmax})),u=Math.max.apply(null,o.map(function(t){return t.extent.ymax})),s={x:Math.round((e.xmin-l)/r),y:Math.round((u-e.ymax)/i)},x={width:Math.round((h-l)/r),height:Math.round((u-f)/i)},m={width:Math.round((e.xmax-e.xmin)/r),height:Math.round((e.ymax-e.ymin)/i)};if(Math.round(x.width/n.pixelBlock.width)*Math.round(x.height/n.pixelBlock.height)!==o.length||s.x<0||s.y<0||x.width<m.width||x.height<m.height)return null;var p=o.map(function(t){return t.pixelBlock});return{extent:e,pixelBlock:d.mosaic(p,x,s,m)}}function p(t,e,r,i){var a=t.filter(function(t){return c(t)})[0];if(null==a)return null;var o,l,f,h,u,s,m,p,d,y,g,w=i?i.width:e.width,M=i?i.height:e.height,v=a.width,k=a.height,A=e.width/v,C=e.height/k,U=r?r.x:0,T=r?r.y:0,B=a.pixelType,O=a.getPixelArrayConstructor(B),S=a.pixels.length,P=[];for(s=0;s<S;s++){for(l=new O(w*M),m=0;m<C;m++)for(p=0;p<A;p++)if(f=t[m*A+p])for(o=f.pixels[s],g=x(v,k,p,m,U,T,w,M),d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)l[h+y]=o[u+y];P.push(l)}var b,D,I=t.some(function(t){return t&&t.mask&&t.mask.length>0});if(I)for(b=new Uint8Array(w*M),m=0;m<C;m++)for(p=0;p<A;p++)if(f=t[m*A+p],D=f?f.mask:null,g=x(v,k,p,m,U,T,w,M),D)for(d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)b[h+y]=D[u+y];else if(f)for(d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)b[h+y]=1;else for(d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)b[h+y]=0;var L=new n({width:w,height:M,pixels:P,mask:b});return L.updateStatistics(),L}var c=function(t){return t&&"esri.layers.support.PixelBlock"===t.declaredClass&&t.pixels&&t.pixels.length>0},d={createColormapLUT:i,createContrastBrightnessLUT:f,createStretchLUT:l,colorize:a,estimateStatisticsHistograms:o,extractBands:r,stretch:h,lookupPixels:u,remapColor:s,mosaic:p,mosaicPixelData:m};return d});