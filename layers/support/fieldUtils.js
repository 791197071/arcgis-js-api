// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","@dojo/framework/shim/Set","../../core/Error","../../core/object","../../core/promiseUtils","./domains","../../support/arcadeOnDemand"],function(e,n,i,r,t,l,a,o,u,s,d,c){function f(e,i){if(null!=e&&null!=i)for(var r=0,t=Array.isArray(e)?e:[e];r<t.length;r++){var l=t[r];if(g(n.rendererFields,l,i),"visualVariables"in l&&l.visualVariables)for(var a=0,o=l.visualVariables;a<o.length;a++){var u=o[a];g(n.visualVariableFields,u,i)}}}function g(e,n,i){if(e)for(var r=0,t=e;r<t.length;r++){var l=t[r],a=u.getDeepValue(l,n),o=a&&"function"!=typeof a&&b(i,a);o&&u.setDeepValue(l,o.name,n)}}function m(e,n){if(null!=e&&null!=n)if("startField"in e){var i=b(n,e.startField),r=b(n,e.endField);e.startField=i&&i.name||null,e.endField=r&&r.name||null}else{var t=b(n,e.startTimeField),l=b(n,e.endTimeField);e.startTimeField=t&&t.name||null,e.endTimeField=l&&l.name||null}}function F(e,n){return e&&n?(Z.clear(),p(Z,e,n),l.from(Z).sort()):[]}function p(e,n,i){if(i)if(n&&n.length)if(l.includes(i,"*"))for(var r=0,t=n;r<t.length;r++){var a=t[r].name;e.add(a)}else for(var o=0,u=i;o<u.length;o++){var s=u[o];v(e,n,s)}else{if(l.includes(i,"*"))return e.clear(),void e.add("*");for(var d=0,c=i;d<c.length;d++){var s=c[d];e.add(s)}}}function v(e,n,i){if(n&&n.length){var r=b(n,i);return void(r&&e.add(r.name))}"string"==typeof i&&e.add(i)}function h(e,n){return n&&e?l.includes(n,"*")?e.map(function(e){return e.name}):n:[]}function y(e,n,i){if(void 0===i&&(i=1),!n||!e)return[];if(l.includes(n,"*"))return["*"];var r=F(e,n);return r.length/e.length>=i?["*"]:r}function b(e,n){if("string"!=typeof n)return null;if(null!=e){n=n.toLowerCase();for(var i=0,r=e;i<r.length;i++){var t=r[i];if(t&&t.name.toLowerCase()===n)return t}}return null}function I(e,n){if(!e||!n||"string"!=typeof n)return!1;n=n.toLowerCase();for(var i=0,r=e;i<r.length;i++){var t=r[i];if(t&&t.name.toLowerCase()===n)return!0}return!1}function T(e,n,i){return t(this,void 0,void 0,function(){var t,l,a,o,u;return r(this,function(r){switch(r.label){case 0:return i?[4,c.loadArcade()]:[2];case 1:for(t=r.sent().arcadeUtils,l=t.extractFieldNames(i),a=0,o=l;a<o.length;a++)u=o[a],v(e,n,u);return[2]}})})}function V(e){return t(this,void 0,void 0,function(){var n;return r(this,function(i){switch(i.label){case 0:return e?(n=new a.default,[4,N(n,e)]):[2,[]];case 1:return i.sent(),[2,l.from(n).sort()]}})})}function N(e,n){return t(this,void 0,void 0,function(){var i,t;return r(this,function(r){return n?(i=n.fields,t=u.getDeepValue("elevationInfo.featureExpressionInfo",n),t?[2,t.collectRequiredFields(e,i)]:[2]):[2]})})}function E(n,i,l){return t(this,void 0,void 0,function(){var t,a;return r(this,function(r){switch(r.label){case 0:return i&&l&&(l.where&&"1=1"!==l.where||l.timeExtent)?(i.timeInfo&&l.timeExtent&&p(n,i.fields,[i.timeInfo.startField,i.timeInfo.endField]),l.where?[4,s.create(function(n){e(["../../core/sql/WhereClause"],n)})]:[3,2]):[2];case 1:if(t=r.sent(),a=t.WhereClause.create(l.where,i.fieldsIndex),!a.isStandardized)return[2,s.reject(new o("fieldUtils:collectFilterFields","Where clause is not standardized"))];p(n,i.fields,a.fieldNames),r.label=2;case 2:return[2]}})})}function w(e){return t(this,void 0,void 0,function(){var n;return r(this,function(i){return e?(n="timeInfo"in e&&e.timeInfo,n?[2,F(e.fields,[e.trackIdField,n.startField,n.endField])]:[2,[]]):[2,[]]})})}function R(e){if(!e)return[];var n="editFieldsInfo"in e&&e.editFieldsInfo;return n?F(e.fields,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function D(e){if(!e)return[];var n="geometryProperties"in e&&e.geometryProperties;return n?F(e.fields,[n&&n.shapeAreaFieldName,n&&n.shapeLengthFieldName]):[]}function x(e){return t(this,void 0,void 0,function(){var n;return r(this,function(i){switch(i.label){case 0:return e?(n=new a.default,[4,S(n,e)]):[2,[]];case 1:return i.sent(),[2,l.from(n).sort()]}})})}function S(e,n){return t(this,void 0,void 0,function(){var i,t;return r(this,function(r){switch(r.label){case 0:return i=n.labelingInfo,t=n.fields,i&&i.length?[4,s.all(i.map(function(n){return A(e,t,n)}))]:[2];case 1:return r.sent(),[2]}})})}function A(e,n,i){return t(this,void 0,void 0,function(){var t,l,a,o,u;return r(this,function(r){switch(r.label){case 0:return i?(t=i.getLabelExpression(),l=i.where,"arcade"!==t.type?[3,2]:[4,T(e,n,t.expression)]):[2];case 1:return r.sent(),[3,3];case 2:a=t.expression.match(/{[^}]*}/g),a&&a.forEach(function(i){v(e,n,i.slice(1,-1))}),r.label=3;case 3:return o=/['"]+/g,l&&(u=l.split(" "),3===u.length&&v(e,n,u[0].replace(o,"")),7===u.length&&(v(e,n,u[0].replace(o,"")),v(e,n,u[4].replace(o,"")))),[2]}})})}function _(e){var n=e.defaultValue;return void 0!==n&&P(e,n)?n:e.nullable?null:void 0}function L(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function O(e){return null===e||L(e)}function U(e){return null===e||$(e)}function k(e){return null!=e&&"string"==typeof e}function z(e){return null===e||k(e)}function C(e){return!0}function P(e,n){var i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?U:$;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?O:L;break;case"string":case"esriFieldTypeString":i=e.nullable?z:k;break;default:i=C}return 1===arguments.length?i:i(n)}function j(e){return null!=e&&ee.has(e.type)}function G(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function M(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function H(e,n){return null===W(e,n)}function q(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function W(e,n){return e.nullable&&null===n?null:j(e)&&!Y(e.type,n)?ne.OUT_OF_RANGE:P(e,n)?e.domain?d.validateDomainValue(e.domain,n):null:ie.INVALID_TYPE}function Y(e,n){var i="string"==typeof e?X(e):e;return!!i&&(i.isInteger?$(n)&&n>=i.min&&n<=i.max:n>=i.min&&n<=i.max)}function J(e){var n=d.getDomainRange(e.domain);if(n)return n;if(j(e))return X(e.type)}function X(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return n.smallIntegerRange;case"esriFieldTypeInteger":case"integer":return n.integerRange;case"esriFieldTypeSingle":case"single":return n.singleRange;case"esriFieldTypeDouble":case"double":return n.doubleRange}}function B(e){if(!L(e))return null;if($(e)){if(e>=n.smallIntegerRange.min&&e<=n.smallIntegerRange.max)return"esriFieldTypeSmallInteger";if(e>=n.integerRange.min&&e<=n.integerRange.max)return"esriFieldTypeInteger"}return e>=n.singleRange.min&&e<=n.singleRange.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}function K(e,n,i){switch(e){case d.DomainValidationError.INVALID_CODED_VALUE:return"Value "+i+" is not in the coded domain - field: "+n.name+", domain: "+JSON.stringify(n.domain);case d.DomainValidationError.VALUE_OUT_OF_RANGE:return"Value "+i+" is out of the range of valid values - field: "+n.name+", domain: "+JSON.stringify(n.domain);case ie.INVALID_TYPE:return"Value "+i+" is not a valid value for the field type - field: "+n.name+", type: "+n.type+", nullable: "+n.nullable;case ne.OUT_OF_RANGE:var r=X(n.type),t=r.min,l=r.max;return"Value "+i+" is out of range for the number type - field: "+n.name+", type: "+n.type+", value range is "+t+" to "+l}}function Q(e,n){if(!n||!n.attributes||!e)return!1;for(var i=n.attributes,r=0,t=e;r<t.length;r++){if(!(t[r]in i))return!1}return!0}Object.defineProperty(n,"__esModule",{value:!0}),n.rendererFields=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],n.visualVariableFields=["field","normalizationField"],n.fixRendererFields=f,n.fixTimeInfoFields=m;var Z=new a.default;n.fixFields=F,n.collectFields=p,n.collectField=v,n.unpackFieldNames=h,n.packFields=y,n.getField=b,n.hasField=I,n.collectArcadeFieldNames=T,n.getElevationFields=V,n.collectElevationFields=N,n.collectFilterFields=E,n.getTimeFields=w,n.getFeatureEditFields=R,n.getFeatureGeometryFields=D,n.getLabelingFields=x,n.collectLabelingFields=S,n.getFieldDefaultValue=_;var $=function(){return"isInteger"in Number?Number.isInteger:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}}();n.isValueMatchingFieldType=P,n.numericTypes=["integer","small-integer","single","double"];var ee=new a.default(n.numericTypes.concat(["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]));n.isNumericField=j,n.isStringField=G,n.isDateField=M,n.isValidFieldValue=H;var ne;!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(ne=n.NumericRangeValidationError||(n.NumericRangeValidationError={}));var ie;!function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(ie=n.TypeValidationError||(n.TypeValidationError={})),n.sanitizeNullFieldValue=q,n.validateFieldValue=W,n.isNumberInRange=Y,n.getFieldRange=J,n.getNumericTypeForValue=B,n.smallIntegerRange={min:-32768,max:32767,isInteger:!0},n.integerRange={min:-2147483648,max:2147483647,isInteger:!0},n.singleRange={min:-3.4e38,max:1.2e38,isInteger:!1},n.doubleRange={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1},n.validationErrorToString=K,n.featureHasFields=Q});