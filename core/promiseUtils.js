// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/AbortController","dojo/Deferred","dojo/promise/all","./Error","./events","./maybe","./has","./clock","@dojo/framework/shim/Promise"],function(r,n,e,t,o,i,u,c,f,a){function l(r){return f("esri-native-promise")?Promise.all(r):o(r)}function s(r,n){var e=r.slice();return l(r.map(function(r,e){return n(r,e)})).then(function(r){return e.filter(function(n,e){return r[e]})})}function v(r,n){if(f("esri-native-promise"))return new Promise(r);var e=new t(n);try{r(function(r){return S(r).then(e.resolve)},e.reject)}catch(r){e.reject(r)}return e.promise}function h(r){void 0===r&&(r="Aborted");var n=new i("AbortError",r);return n.dojoType="cancel",n}function m(){return new e.default}function p(r){if(b(r))throw h()}function d(r){return c.isSome(r)?"aborted"in r?r:r.signal:r}function b(r){var n=d(r);return c.isSome(n)&&n.aborted}function w(r){if(A(r))throw r}function j(r,n){var e=d(r);if(!c.isNone(e))return e.aborted?void n():u.once(e,"abort",n)}function y(r,n){var e=d(r);if(!c.isNone(e))return p(e),u.once(e,"abort",n)}function A(r){return r&&("AbortError"===r.name||"cancel"===r.dojoType)}function T(r){var n=null,e=v(function(r,e){n={resolve:r,reject:e}},r);return n.promise=e,n.cancel=function(){n.reject(h())},n}function E(r){if(r){if("function"!=typeof r.forEach){var n=Object.keys(r);return E(n.map(function(n){return r[n]})).then(function(r){var e={};return n.forEach(function(n,t){return e[n]=r[t]}),e})}var e=r,t=null,o=C;return v(function(r,n){var i=[],u=e.length;0===u&&r(i),e.forEach(function(e){var c={promise:e||o(e)};i.push(c),c.promise.then(function(r){c.value=r}).catch(function(r){c.error=r}).then(function(){0===--u&&(t?n(h()):r(i))})})},function(r){t=r||"Invocation cancellation",e.forEach(function(n){"cancel"in n&&n.cancel(r)})})}}function g(r){return E(r).then(function(r){return r.filter(function(r){return!!r.value}).map(function(r){return r.value})})}function P(r){return r&&r.length?v(function(n,e){for(var t=0,o=r;t<o.length;t++){o[t].then(n,e)}}):C()}function k(r){if(f("esri-native-promise"))return Promise.reject(r);var n=new t;return n.reject(r),n.promise}function C(r){if(void 0===r&&(r=void 0),f("esri-native-promise"))return Promise.resolve(r);var n=new t;return n.resolve(r),n.promise}function I(r,n,e){void 0===n&&(n=void 0);var t=m();return j(e,function(){return t.abort()}),v(function(e){var o=setTimeout(function(){o=0,e(n)},r);j(t,function(){o&&(clearTimeout(o),k(h()))})},function(){return t.abort()})}function O(r,n,e,t){var o=e&&"abort"in e?e:null;null!=t||o||(t=e);var u=setTimeout(function(){u=0,o&&o.abort()},n),c=function(){throw t||new i("promiseUtils:timeout","The wrapped promise did not resolve within "+n+" ms")};return r.then(function(r){if(0===u)throw c();return clearTimeout(u),r},function(r){throw clearTimeout(u),0===u?c():r})}function D(r){var n=!1;return v(function(){r(function(r){n||C(r)})},function(){return n=!0})}function N(r){return r&&"function"==typeof r.then}function S(r){return r&&"object"==typeof r&&"then"in r&&"function"==typeof r.then?r:C(r)}function _(r,n){void 0===n&&(n=-1);var e,t,o,i,u=null,c=function(){for(var f=[],a=0;a<arguments.length;a++)f[a]=arguments[a];if(e){t=f,i&&i.reject(h()),i=T();var l=i.promise;if(u){var s=u;u=null,s.abort()}return l}if(o=i||T(),i=null,n>0){var v=m();e=S(r.apply(void 0,f.concat([v.signal])));var p=e;I(n).then(function(){e===p&&(i?v.abort():u=v)})}else e=S(r.apply(void 0,f));var d=function(){var r=t;t=o=e=u=null,null!=r&&c.apply(void 0,r)},b=e,w=o;return b.then(d,d),b.then(w.resolve,w.reject),w.promise};return c}function q(r){var n,e,t=v(function(r,t){n=r,e=t},r),o=function(r){n(r)};return o.resolve=function(r){return n(r)},o.reject=function(r){return e(r)},o.timeout=function(r,n){return a.default.setTimeout(function(){return o.reject(n)},r)},o.promise=t,o}function x(r,n){return r.then(n,n)}Object.defineProperty(n,"__esModule",{value:!0}),f.add("esri-native-promise",!1),n.all=l,n.filter=s,n.create=v,n.createAbortError=h,n.createAbortController=m,n.throwIfAborted=p,n.isAborted=b,n.throwIfAbortError=w,n.onAbort=j,n.onAbortOrThrow=y,n.isAbortError=A,n.createDeferred=T,n.eachAlways=E,n.eachAlwaysValues=g,n.first=P,n.reject=k,n.resolve=C,n.after=I,n.timeout=O,n.wrapCallback=D,n.isThenable=N,n.when=S,n.debounce=_,n.createResolver=q,n.always=x});