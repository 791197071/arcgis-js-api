// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","@dojo/framework/shim/AbortController","dojo/Deferred","dojo/promise/all","./Error","./events","./maybe","./has","@dojo/framework/shim/Promise"],function(r,n,e,t,o,i,u,c,f){function a(r){return f("esri-native-promise")?Promise.all(r):o(r)}function l(r,n){var e=r.slice();return a(r.map(function(r,e){return n(r,e)})).then(function(r){return e.filter(function(n,e){return r[e]})})}function s(r,n){if(f("esri-native-promise"))return new Promise(r);var e=new t(n);try{r(function(r){return N(r).then(e.resolve)},e.reject)}catch(r){e.reject(r)}return e.promise}function v(r){void 0===r&&(r="Aborted");var n=new i("AbortError",r);return n.dojoType="cancel",n}function h(){return new e.default}function m(r){if(d(r))throw v()}function p(r){return c.isSome(r)?"aborted"in r?r:r.signal:r}function d(r){var n=p(r);return c.isSome(n)&&n.aborted}function b(r){if(y(r))throw r}function w(r,n){var e=p(r);if(!c.isNone(e))return e.aborted?void n():u.once(e,"abort",n)}function j(r,n){var e=p(r);if(!c.isNone(e))return m(e),u.once(e,"abort",n)}function y(r){return r&&("AbortError"===r.name||"cancel"===r.dojoType)}function A(r){var n=null,e=s(function(r,e){n={resolve:r,reject:e}},r);return n.promise=e,n.cancel=function(){n.reject(v())},n}function E(r){if(r){if("function"!=typeof r.forEach){var n=Object.keys(r);return E(n.map(function(n){return r[n]})).then(function(r){var e={};return n.forEach(function(n,t){return e[n]=r[t]}),e})}var e=r,t=null,o=k;return s(function(r,n){var i=[],u=e.length;0===u&&r(i),e.forEach(function(e){var c={promise:e||o(e)};i.push(c),c.promise.then(function(r){c.value=r}).catch(function(r){c.error=r}).then(function(){0===--u&&(t?n(v()):r(i))})})},function(r){t=r||"Invocation cancellation",e.forEach(function(n){"cancel"in n&&n.cancel(r)})})}}function T(r){return E(r).then(function(r){return r.filter(function(r){return!!r.value}).map(function(r){return r.value})})}function g(r){return r&&r.length?s(function(n,e){for(var t=0,o=r;t<o.length;t++){o[t].then(n,e)}}):k()}function P(r){if(f("esri-native-promise"))return Promise.reject(r);var n=new t;return n.reject(r),n.promise}function k(r){if(void 0===r&&(r=void 0),f("esri-native-promise"))return Promise.resolve(r);var n=new t;return n.resolve(r),n.promise}function C(r,n){void 0===n&&(n=void 0);var e=0;return s(function(t){e=setTimeout(function(){t(n)},r)},function(){e&&(clearTimeout(e),e=0)})}function I(r,n,e,t){var o=setTimeout(function(){o=0,e&&e.abort()},n),u=function(){throw t||new i("promiseUtils:timeout","The wrapped promise did not resolve within "+n+" ms")};return r.then(function(r){if(0===o)throw u();return clearTimeout(o),r},function(r){throw clearTimeout(o),0===o?u():r})}function O(r){var n=!1;return s(function(){r(function(r){n||k(r)})},function(){return n=!0})}function D(r){return r&&"function"==typeof r.then}function N(r){return r&&"object"==typeof r&&"then"in r&&"function"==typeof r.then?r:k(r)}function S(r,n){void 0===n&&(n=-1);var e,t,o,i,u=null,c=function(){for(var f=[],a=0;a<arguments.length;a++)f[a]=arguments[a];if(e){t=f,i&&i.reject(v()),i=A();var l=i.promise;if(u){var s=u;u=null,s.abort()}return l}if(o=i||A(),i=null,n>0){var m=h();e=N(r.apply(void 0,f.concat([m.signal])));var p=e;C(n).then(function(){e===p&&(i?m.abort():u=m)})}else e=N(r.apply(void 0,f));var d=function(){var r=t;t=o=e=u=null,null!=r&&c.apply(void 0,r)},b=e,w=o;return b.then(d,d),b.then(w.resolve,w.reject),w.promise};return c}function _(r){var n,e,t=s(function(r,t){n=r,e=t},r),o=function(r){n(r)};return o.resolve=function(r){return n(r)},o.reject=function(r){return e(r)},o.promise=t,o}function q(r,n){return r.then(n,n)}Object.defineProperty(n,"__esModule",{value:!0}),f.add("esri-native-promise",!1),n.all=a,n.filter=l,n.create=s,n.createAbortError=v,n.createAbortController=h,n.throwIfAborted=m,n.isAborted=d,n.throwIfAbortError=b,n.onAbort=w,n.onAbortOrThrow=j,n.isAbortError=y,n.createDeferred=A,n.eachAlways=E,n.eachAlwaysValues=T,n.first=g,n.reject=P,n.resolve=k,n.after=C,n.timeout=I,n.wrapCallback=O,n.isThenable=D,n.when=N,n.debounce=S,n.createResolver=_,n.always=q});