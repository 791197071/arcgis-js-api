// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/JsonXmlConverter","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil","../../../supportClasses/DocumentOptions","../../ConversionUtil","../../../sections/SectionTypes","./AlignParser","./_HiddenCellsCollector","esri/dijit/geoenrichment/utils/ColorUtil"],function(t,e,r,a,i,s,n,o,l,u){var d={parseTableCellAttributes:function(e,r,a){var i=a.tableDefaultStyles;if(r=r||{},e.overrideStyle&&(r.overrideStyle=e.overrideStyle),e.pad&&(r.horizontalPadding=s.ptToPx(e.pad)),e.vpad&&(r.verticalPadding=s.ptToPx(e.vpad)),e.angle&&(r.angle=Number(e.angle)||0),o.parseAlign(e,r),e.width&&(r.width=s.ptToPx(e.width)),e.height&&(r.height=s.ptToPx(e.height)),t.mixin(r,s.ptToPxObj(s.parseStyleString(e.style))),r.overrideStyle&&i){var n=i.getStyle(r.overrideStyle);for(var l in n)delete r[l]}return d._parseBorderProperties(e,r),r},_SIDES:["Top","Right","Bottom","Left"],_parseBorderProperties:function(t,e){function r(r){if(t["border"+r+"Width"]){t["border"+r+"Color"]&&(e["border"+r+"Color"]=t["border"+r+"Color"]),t["border"+r+"Width"]&&(e["border"+r+"Width"]=s.ptToPx(t["border"+r+"Width"])),t["border"+r+"Style"]&&(e["border"+r+"Style"]=t["border"+r+"Style"]);var a=t["border"+r+"Opacity"];e["border"+r+"Opacity"]=a?Number(a):1}}d._SIDES.forEach(r)}},g={getElement:function(t,e,r){var a=g._processTableColumns(t,e.templateJson,r),i=Number(t.attributes.fixedColumns)||0,n=Number(t.attributes.dynamicColumns)||0,o=g._getTableOuterTags(t,e),u=o.trTags,p=o.bgTag,c=o.fgTag,f=o.backgroundFloatingPanelsTag,b=o.foregroundFloatingPanelsTag,h=o.filterTag;if(u){var T=u.map(function(){return{style:{fields:{}},fieldInfos:{}}}),m=l.collectHiddenCells(u,e);u.forEach(function(t,r){var o=T[r];if(t.attributes&&t.attributes.height&&(o.style.height=s.ptToPx(t.attributes.height)),t.tags&&t.tags.length){var u=0;if(n){var p=[],c=[],f=0;t.tags.forEach(function(t){for(;l.isHidden(m,f,r);)f++;f<i?p.push(t):c.push(t),f++});var b=Math.round((a.length-i)/n);t.tags=p;for(var h=0;h<b;h++)t.tags=t.tags.concat(c)}t.tags.forEach(function(t){for(;l.isHidden(m,u,r);)u++;if(a[u]){var i=a[u].field,s=t.attributes||{},n=o.style.fields[i]={};d.parseTableCellAttributes(s,n,e),s.width&&g._parseSpannedCellsDimentions(s,T,a,r,u);var p=Number(s.colspan),c=Number(s.rowspan);p&&(o.columnSpans=o.columnSpans||{},o.columnSpans[i]=p),c&&(o.rowSpans=o.rowSpans||{},o.rowSpans[i]=c);try{g._parseCellContent(t,o,i,n,e)}catch(t){console.log(t)}u++}})}})}var y={id:"table",customName:t.attributes.customName,backgroundSectionJson:p&&g._parseTableBackgroundForeground(p,e,!0),foregroundSectionJson:c&&g._parseTableBackgroundForeground(c,e,!1),backgroundFloatingTablesSectionJson:f&&g._parseFloatingPanels(f,e,!0),foregroundFloatingTablesSectionJson:b&&g._parseFloatingPanels(b,e,!1),data:{columns:a,data:T||[]},style:{width:s.ptToPx(t.attributes.width),left:s.ptToPx(t.attributes.left),top:s.ptToPx(t.attributes.spaceBefore),spaceAfter:s.ptToPx(t.attributes.spaceAfter),alternatingStyle:t.attributes.alternatingStyle,opacity:t.attributes.opacity?Number(t.attributes.opacity):void 0,fixedCellsOpacity:t.attributes.fixedCellsOpacity?Number(t.attributes.fixedCellsOpacity):void 0},attributes:{},filter:h&&e.parsers.getParser("filter").getFilter(h)};return i&&(y.attributes.fixedColumns=i),n&&(y.attributes.dynamicColumns=n),t.attributes.fixedRows&&(y.attributes.fixedRows=Number(t.attributes.fixedRows)||0),t.attributes.dynamicRows&&(y.attributes.dynamicRows=Number(t.attributes.dynamicRows)||0),y.attributes.inSectionRole=t.attributes.inSectionRole,y},_processTableColumns:function(t,e,r){if(r&&r.fixTableWidthsForPage){var a=s.pxToPt(i.getPageBox(e.documentOptions).contentW);if(t.attributes.widths&&Number(t.attributes.width)>a){var n=s.splitTrim(t.attributes.widths,";",!0),o=Number(t.attributes.width)-a,l=Number(n[n.length-1]);l>o&&(l-=o,n[n.length-1]=l,t.attributes.widths=n.join(";"),t.attributes.width=a)}}var u=0;return t.attributes.widths?s.splitTrim(t.attributes.widths,";",!0).map(function(t){return{field:"field"+u++,style:{width:s.ptToPx(t)}}}):[]},_getTableOuterTags:function(t,e){var r,a,i,s,o,l=[];return e.revisionVersion>=1.1?t.tags&&t.tags.forEach(function(t){if("tr"===t.name)return void l.push(t);if("filter"===t.name)return void(o=t);switch(t.attributes.type){case n.TABLE_BACKGROUND:r=t;break;case n.TABLE_FOREGROUND:a=t;break;case n.TABLE_BACKGROUND_FLOATING_PANELS:i=t;break;case n.TABLE_FOREGROUND_FLOATING_PANELS:case n.TABLE_FLOATING_PANELS:s=t}}):t.tags&&t.tags.forEach(function(t){"tr"===t.name?l.push(t):"background"===t.name?r=t:"foreground"===t.name?a=t:"floatingElements"===t.name&&(s=t)}),{trTags:l,bgTag:r,fgTag:a,backgroundFloatingPanelsTag:i,foregroundFloatingPanelsTag:s,filterTag:o}},_processTdContent:function(t,e){function r(t){var a=t.tags&&1===t.tags.length&&t.tags[0];return a&&a.tags?("b"===a.name?e.fontWeight="bold":"i"===a.name?e.fontStyle="italic":"u"===a.name&&(e.textDecoration="underline"),"b"===a.name||"i"===a.name||"u"===a.name?r(a)||{tag:a.tags[0],parentTag:a}:null):null}var a,i,s;if(t.tags&&t.tags.length)if(s=t.tags.filter(function(t){return"br"!==t.name}),(i=s[0])&&"trigger"===i.name&&s[1]&&"d"===s[1].name)a=i,i=s[1];else{var n=r(t);i=n&&n.tag||s[0],t=n&&n.parentTag||t}return{firstTag:i,triggerTag:a,parentTag:t,hasMultipleTags:s&&s.length>1}},_parseSpannedCellsDimentions:function(t,e,r,a,i){if(t.spannedWidths||t.spannedHeights)for(var n=t.spannedWidths?t.spannedWidths.split(";").map(function(t){return s.ptToPx(t)}):[s.ptToPx(t.width)],o=t.spannedHeights?t.spannedHeights.split(";").map(function(t){return s.ptToPx(t)}):[s.ptToPx(t.height)],l=0;l<n.length;l++)for(var u=0;u<o.length;u++){var d=r[i+l],g=e[a+u],p=g.style.fields[d.field]=g.style.fields[d.field]||{};p.width=n[l],p.height=o[u]}},_parseCellContent:function(t,i,n,o,l){function d(t){e.isRichText(t)?i.fieldInfos[n]=a.createFieldInfoFromRichText(t):i[n]=e.unrichHTML(t)}var p,c=g._processTdContent(t,o),f=c.firstTag,b=c.parentTag,h=c.triggerTag,T=c.hasMultipleTags;if(T&&!h){var m=l.parsers.getParser("field").parseRichTextTag(b,l);m&&(i.fieldInfos[n]=m,p=!0)}if(f&&!p){l.isGraphicReport&&"section"===f.name&&!f.attributes.style&&o.backgroundColor&&!u.isTransparent(o.backgroundColor)&&(f.attributes.style=s.composeStyleString({backgroundColor:o.backgroundColor}),delete o.backgroundColor);var y;try{y=l.parsers.getParser("field").parseField(f,b,h,l)}catch(t){console.log(t),y=r.createFieldInfoForUnsupportedContent()}if(!1===y)p=!0;else if("number"==typeof y)i[n]=y+"",p=!0;else if(y)i.fieldInfos[n]=y,p=!0;else if("chart"===f.name)p=!0;else if("img"===f.name)p=!0;else if("mapImage"===f.name)p=!0;else if("text"===f.name)i[n]=f.attributes.name,p=!0;else if("a"===f.name&&f.tags&&f.tags[0].text){var v=f.attributes.href;v&&(i.urls=i.urls||{},i.urls[n]=v,i[n]=f.tags[0].text,p=!0)}else f.text&&!T&&(d(f.text),p=!0)}p||d(e.getInnerHTML(b))},_parseTableBackgroundForeground:function(t,e,r){return t.attributes=t.attributes||{},t.attributes.type=r?n.TABLE_BACKGROUND:n.TABLE_FOREGROUND,e.parsers.getParser("section").parseSection(t,e)},_parseFloatingPanels:function(t,e,r){return t.attributes=t.attributes||{},t.attributes.type=r?n.TABLE_BACKGROUND_FLOATING_PANELS:n.TABLE_FOREGROUND_FLOATING_PANELS,e.parsers.getParser("section").parseSection(t,e)}};return g.parseTableCellAttributes=d.parseTableCellAttributes,g});