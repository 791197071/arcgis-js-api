// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-style","../../grid/valueField/ValueField","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/utils/ShapeUtil","../utils/AnnotationsUtil","./ShapeThemeUtil","dojo/i18n!esri/nls/jsapi"],function(e,t,i,s,a,h,o,n,l,r,d,p){p=p.geoenrichment.dijit.ReportPlayer.ReportPlayer;var c={borderColor:"#AAAAAA",fillColor:"#AAAAAA"};return e(o,{__isShapeContainer:!0,viewModel:null,theme:null,currentFeatureIndex:null,shapeJson:null,relativeParent:null,alignParams:null,applyThemeStyle:!0,getPreviewValueFunction:null,parentWidget:null,_g:!1,_viewBox:!1,_shapeStyle:null,_shapeThemeStyle:null,_needSaveShapeThemeStyle:!0,_preserveAspectRatio:void 0,_showAsBar:!1,_showBarBackground:!1,_barBackgroundStyle:null,_isPlaceholder:!1,_angle:0,postCreate:function(){var e=this,t=a.create("div",{class:"floatingElement templateShape"});this.content=t,this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.shapeJson.style.width,this.fieldStyle.height=this.shapeJson.style.height,this._g=this.shapeJson.g,this._viewBox=this.shapeJson.viewBox,this._shapeStyle=this.shapeJson.style||{},this._preserveAspectRatio=this.shapeJson.preserveAspectRatio,this._isPlaceholder=this.shapeJson.isPlaceholder,this._angle=this.shapeJson.style.angle||0,this._processThemeStyle(),this._showAsBar=this.shapeJson.showAsBar,this._showBarBackground=this.shapeJson.showBarBackground,this._barBackgroundStyle=this.shapeJson.barBackgroundStyle||{},this.inherited(arguments),s.add(this.domNode,"floatingElementContainer"),h.set(this.domNode,"position","absolute"),h.set(this.domNode,"top",(this.shapeJson.style.top||0)+"px"),h.set(this.domNode,"left",(this.shapeJson.style.left||0)+"px"),this._updateShapeNode(),this._applyRotation(),this.alignParams&&r.alignAnnotationContainer(this,this.alignParams),e.onInitialized()},_processThemeStyle:function(){this.applyThemeStyle&&(this._shapeThemeStyle=d.getThemeStylesFromShapeJson(this.shapeJson,this.parentWidget.parentGrid),this._needSaveShapeThemeStyle=!!this.shapeJson.themeStyle)},setAngle:function(e){this._angle=n.angleTo180_180Range(Number(e)||0),this._applyRotation()},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var e=i("webkit")?"webkitTransform":"transform";this.content.style[e]="rotate("+this._angle+"deg)"},_lastAlignParams:null,resize:function(e,t){e&&(this.setWidth(e.w),this.setHeight(e.h)),this._updateShapeNode(),this._lastAlignParams=t||this._lastAlignParams,r.alignAnnotationContainer(this,this._lastAlignParams)},scaleProportionallyWithinParent:function(e){var t=this.getShapeBox();this.resize({w:t.w*e.xScale,h:t.h*e.yScale}),h.set(this.domNode,{left:t.l*e.xScale+"px",top:t.t*e.yScale+"px"})},getShapeBox:function(){return{l:h.get(this.domNode,"left"),t:h.get(this.domNode,"top"),w:this.getWidth(),h:this.getHeight()}},_updateShapeNode:function(){function e(e){var n,g=a.create("div",{class:"shapeContainer_svgContainer esriGEAbsoluteStretched"},i.content);e?(s.add(g,"shapeContainer_svgContainerBackground"),n=t.mixin({},i._barBackgroundStyle,c)):n=t.mixin({},i._shapeThemeStyle,i._shapeStyle);var _=1;i._showAsBar&&(_=e?1:i.getPreviewValueFunction?i.getPreviewValueFunction().normalizedValue:.5+.5*Math.random(),h.set(g,"width",_*p+"px"),s.add(g,"shapeContainer_svgContainerShowAsBar"));var u=i._showAsBar?Math.floor(p/r):1;u=Math.round(_*u);for(var m=0;m<u;m++)!function(e){var t=l.createSVGNode(o,{width:r+"px",height:d+"px",overflow:"visible"});i._preserveAspectRatio&&t.setAttribute("preserveAspectRatio",i._preserveAspectRatio),i._g.forEach(function(e){var i=l.createNodeByAttributes(e,n,{overrideFillOpacity:!0});i&&t.appendChild(i)});var s=a.create("div",{class:"shapeContainer_svgContainerElement"},g);h.set(s,"left",e*r+"px"),a.place(t,s)}(m)}var i=this,o=this._viewBox;if(this._shapeStyle.borderAlpha>0&&this._shapeStyle.borderWidth>0){var n=this._shapeStyle.borderWidth;o=t.mixin({},this._viewBox),o.xmin=o.xmin||0,o.ymin=o.ymin||0,o.xmin-=n/4,o.ymin-=n/4,o.width+=n/2,o.height+=n/2}var r,d,p=this.getWidth(),g=this.getHeight(),_=o.width/o.height,u=Math.min(p,g*_);if("none"===this._preserveAspectRatio?(r=p,d=g):(r=u,d=u/_),h.set(this.content,"width",(this._showAsBar?p:r)+"px"),h.set(this.content,"height",d+"px"),a.empty(this.content),this._isPlaceholder)return void a.create("div",{class:"shapeContainer_svgPlaceholder"},this.content);this._showAsBar&&this._showBarBackground&&e(!0),e()},onInitialized:function(){},_domNodePositionToShapeStyle:function(){this.domNode&&(this._shapeStyle.top=h.get(this.domNode,"top"),this._shapeStyle.left=h.get(this.domNode,"left"))},toJson:function(){this._domNodePositionToShapeStyle();var e={id:"shape",g:this._g,viewBox:this._viewBox,preserveAspectRatio:this._preserveAspectRatio,isPlaceholder:this._isPlaceholder,style:t.mixin({},this._shapeStyle,{angle:this._angle,width:this.getWidth(),height:this.getHeight()}),themeStyle:this._needSaveShapeThemeStyle?this._shapeThemeStyle:void 0,showAsBar:this._showAsBar,showBarBackground:this._showBarBackground,barBackgroundStyle:t.mixin({},this._barBackgroundStyle)};return t.clone(e)}})});