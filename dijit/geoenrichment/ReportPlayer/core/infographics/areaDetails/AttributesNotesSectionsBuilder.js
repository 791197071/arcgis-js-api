// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/when","../../supportClasses/tableJson/TableJsonUtil","../../supportClasses/tableJson/TableJsonResizeUtil","./AreaDetailsLayouts","../../../dataProvider/supportClasses/attachments/AttributesUtil","../../sections/SectionTypes","esri/dijit/geoenrichment/utils/FieldUtil","dojo/i18n!esri/nls/jsapi"],function(t,e,n,o,r,a,i,l,s,u){u=u.geoenrichment.dijit.ReportPlayer.AreaDetailsInfographic;var c={buildDataInfo:function(t){return n(c._calcBuildInfo(t),function(e){if(!e)return null;var n,o=c._createAttributesSectionJsons(e.attributes,t.infographicJson,t.defaultCellStyle),a=c._createNotesSectionJsons(e.notes,t.infographicJson,t.defaultCellStyle);if(e.canFitOnSinglePage)if(o.length)if(a.length){var i=o[0],l=a[0].stack[0];l.style.top=e.attributes.totalHeight,i.stack.push(l),n=[i]}else n=o;else n=a;else{var n=[];n=n.concat(o),n=n.concat(a),n.forEach(function(n){r.resizeTableJsonToFitWidth(n.stack[0],t.width),t.scaleToFitHeight&&r.resizeTableJsonToFitHeight(n.stack[0],e.contentHeight-t.footerHeight)})}return n.length?{sectionJsons:n,stats:{numAttributesTotal:e.attributes.numTotal,numAttributesShown:e.attributes.numShown,numNotesTotal:e.notes.numTotal,numNotesShown:e.notes.numShown}}:null})},_calcBuildInfo:function(t){var e=t.infographicJson,r=t.titleHeight,i=t.minRowHeight,l=t.scaleToFitHeight,s=t.footerHeight,u=t.searchTextRe,h=t.forceSinglePage,m=t.width,f=t.height;return n(c._getData(t),function(t){function n(t){return(p?Math.round(t.length/2):t.length)+(e.showAttributesTitle?1:0)}var g=t.attrs||[],d=t.benchmarkAttrs,w=t.notes||[];if(e.attributesSectionJson||(g=[]),e.notesSectionJson||(w=[]),!g.length&&!w.length)return null;var S=g.length,b=0,T=w.length,y=0;u&&(g=g.filter(function(t){return u.test(t.alias)}),w=w.filter(function(t){return u.test(t.text)})),b=g.length,y=w.length;var A=g.length,v=w.length,p=e.attributesLayout===a.ATTRS_2COLUMNS,_=p?Math.round(g.length/2):g.length,C=n(g),J=w.length,H=J+(e.showNotesTitle?1:0),R=C+H,k=f-r,x=Math.max(i||o.DEFAULT_ROW_HEIGHT,k/R),I=A&&e.showAttributesTitle?x:0,N=A?x:0,F=v&&e.showNotesTitle?x:0,P=v?x:0;if(!l){var E;A&&(e.showAttributesTitle&&(E=e.attributesSectionJson.stack[0].data.data[0])&&(I=E.style.height),(E=e.attributesSectionJson.stack[0].data.data[e.showAttributesTitle?1:0])&&(N=E.style.height)),v&&(e.showNotesTitle&&(E=e.notesSectionJson.stack[0].data.data[0])&&(F=E.style.height),(E=e.notesSectionJson.stack[0].data.data[e.showNotesTitle?1:0])&&(P=E.style.height))}var D,O,U=I+N*_+F+P*J,j=h||U<=k+1;return j?(D=[{attrs:g,numRows:C}],O=[{notes:w,numRows:H}]):(D=c._splitByPages(g,I,N*(p?.5:1),k,s).map(function(t){return{attrs:t,numRows:n(t)}}),O=c._splitByPages(w,F,P,k,s).map(function(t){return{notes:t,numRows:t.length+(e.showNotesTitle?1:0)}})),{canFitOnSinglePage:j,contentHeight:k,attributes:{attrGroups:D,numColumns:p?4:2,titleRowH:I,dataRowH:N,width:m,numTotal:S,numShown:b,totalHeight:I+N*_,benchmarkAttrs:d},notes:{noteGroups:O,numColumns:1,titleRowH:F,dataRowH:P,width:m,numTotal:T,numShown:y,totalHeight:F+P*J}}})},_getData:function(t){var o=t.attachmentsStore;return o?(o.setCurrentAnalysisAreaIndex&&o.setCurrentAnalysisAreaIndex(t.currentFeatureIndex),e([o.getAttributes(),o.getNotes()]).then(function(e){var r={attrs:e[0]||[],notes:e[1]||[]};return t.benchmarkController&&t.benchmarkController.getAreaIndex()>=0&&t.benchmarkController.getAreaIndex()!==t.currentFeatureIndex&&o.supportsMultipleAreas?(o.setCurrentAnalysisAreaIndex(t.benchmarkController.getAreaIndex()),n(o.getAttributes(),function(t){return t&&(r.benchmarkAttrs={},t.forEach(function(t){r.benchmarkAttrs[t.name]=t})),r})):r})):null},_splitByPages:function(t,e,n,o,r){var a,i=o-r,l=[],s=0;return t.forEach(function(t){a||(a=[],l.push(a),s+=e),a.push(t),(s+=n)+n>i&&(a=null,s=0)}),l},_createAttributesSectionJsons:function(e,n,r){var h=c._getSourceSectionStyle(n.attributesSectionJson,n.showAttributesTitle);return e.attrGroups.map(function(m){function f(t,e,n){return c._getCellStyle(t,e,n,h,r)}function g(n,r,a){r=r||0,o.modifyTableJson(S,b,0+r,{text:n?n.alias:"",cellStyle:f(!1,0+r,a),height:e.dataRowH});var l=i.formatAttributeValue(n),u=e.benchmarkAttrs&&e.benchmarkAttrs[n.name];if(u&&s.isNumericField(n)){var c=n.value-u.value;l+=" ("+(c>0?"+":"")+i.formatAttributeValue(t.mixin({},n,{value:c,domain:null}))+")"}o.modifyTableJson(S,b,1+r,{text:l,cellStyle:f(!1,1+r,a)})}var d=m.attrs,w=m.numRows;if(!d.length)return null;var S=o.createTable({numColumns:e.numColumns,numRows:w,style:{width:e.width},useDefaultHeaderTheme:!1}),b=0,T=n.attributesLayout===a.ATTRS_2COLUMNS;n.showAttributesTitle&&(o.modifyTableJson(S,b,0,{text:h.title||u.attributes,columnSpan:e.numColumns,cellStyle:f(!0,0,-1),height:e.titleRowH}),b++);for(var y=0,A=0;A<d.length;A++){var v=d[A];g(v,0,y),T&&(v=d[++A],g(v,e.numColumns/2,y)),b++,y++}return{type:l.INFOGRAPHIC_ATTRIBUTES,stack:[S]}}).filter(function(t){return!!t})},_createNotesSectionJsons:function(t,e,n){var r=c._getSourceSectionStyle(e.notesSectionJson,e.showNotesTitle);return t.noteGroups.map(function(a){function i(t,e){return c._getCellStyle(t,0,e,r,n)}var s=a.notes,h=a.numRows;if(!s.length)return null;var m=o.createTable({numColumns:t.numColumns,numRows:h,style:{width:t.width},useDefaultHeaderTheme:!1}),f=0;e.showNotesTitle&&(o.modifyTableJson(m,f,0,{text:r.title||u.notes,cellStyle:i(!0,-1),height:t.titleRowH}),f++);var g=0;return s.forEach(function(e){o.modifyTableJson(m,f,0,{text:e.text,cellStyle:i(!1,g),height:t.dataRowH}),f++,g++}),{type:l.INFOGRAPHIC_NOTES,stack:[m]}}).filter(function(t){return!!t})},_getSourceSectionStyle:function(t,e){var n={titleStyle:null,title:null};if(t){var o=t.stack[0],r=o.data.columns[0].field,a=0;if(e){var i=o.data.data[a++];i&&(n.titleStyle=i.style.fields[r],n.title=i[r])}for(var l=0;o.data.data[a];){var s=o.data.data[a++];o.data.columns.forEach(function(t,e){n["row"+l+"_column"+e]=s.style.fields[t.field]}),l++}}return n},_getCellStyle:function(e,n,o,r,a){var i,l=o%2!=0,s=n%2!=0;e?i=r.titleStyle:(i=r["row"+o+"_column"+n])||(i=l?r["row1_column"+n]||(s?r.row1_column1:r.row1_column0)||r.row1_column0:r["row0_column"+n]||(s?r.row0_column1:r.row0_column0)||r.row0_column0);var u=t.mixin({verticalAlign:"middle",horizontalAlign:s?"right":void 0,horizontalPadding:e||n>0?5:20},a);return e&&(u.fontSize*=1.2),t.mixin(u,i),u}};return c});