// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/promise/all","./_FieldInfoBuilder","../../../supportClasses/tableJson/TableJsonUtil","../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil","../../../../dataProvider/supportClasses/dataCollections/DataCollectionsLoader","./_config","./EnrichUtil"],function(e,t,a,r,i,n,o,s){function l(e){return"string"==typeof e?e.split(",").map(function(e){return e+"/"}):e}function u(){return d=d||o.collectSubstitutionVariables()}var f={};s.ddLibrary=f,f.getDrillingOptions=function(e,t,a){if(t){var r=function(){var r;if("string"==typeof t){var n=o.getById(e+"."+t);return n?[n]:null}r=t;var s=r.usedFields||a&&a(r);if(s=s&&s.map(function(e){return e.toUpperCase()}),!r.variableID&&!s)return null;var l=r.variableID&&r.variableID.toUpperCase(),u=o.LIBRARY[e];for(var f in u){var c=f.toUpperCase(),d=i.createFieldNameFromVariable(f).toUpperCase();if(function(e,t){return!(!l||-1===l.indexOf(e))||s&&s.some(function(a){return-1!==a.indexOf(e)||-1!==a.indexOf(t)})}(c,d))return u[f]}return null}();return r&&r.forEach(function(e){f._provideStateData(e)}),r}},f.getDrillingOptionByStandardId=function(e,t){},f.getDrillingOptionInfo=function(t,a,i,n,o,l,u){var c=f.getDrillingOptions(t,a,u),d=c&&c.filter(function(e){return e.name===i})[0];if(!d)return null;!l&&d.defaultState&&(l=d.defaultState),l=l&&l.charAt(0)||"n";var p;d.calcGroup&&(p=e.clone(d.calcGroup),p.value=l+"/");var v=d.stateData[l],b=r.createSingleCellTable({fieldInfo:v.fieldInfo,width:n,height:o});return{calculationStatesGroup:p,tableJson:e.clone(b),enrichInfos:s._getStandardEnrichInfosForTableInfo(d,!0)}},f._provideStateData=function(t){if(!t.stateData){var r=t.states?e.clone(t.fieldInfo):t.fieldInfo;t.stateData={n:{fieldInfo:t.fieldInfo}},t.fieldInfo.isChart&&f._updateChartJsonForState(t.fieldInfo.chartJson,"n",t.stateSettings&&t.stateSettings.n),t.states&&(t.states=l(t.states),t.states.forEach(function(a){var i=a.charAt(0);if("n"!==i){var n=e.clone(r);t.stateData[i]={fieldInfo:n},n.isChart&&f._updateChartJsonForState(n.chartJson,i,t.stateSettings&&t.stateSettings[i])}}),t.calcGroup=f.createCalculationStatesGroup(t.states));for(var i in t.stateData){var n=t.stateData[i];n.fieldInfo.isChart&&n.fieldInfo.chartJson.seriesItems.forEach(function(e){e.points.forEach(function(t){a.provideFieldInfoForChartPoint(t,e,1===n.fieldInfo.chartJson.seriesItems.length,i,n.fieldInfo.chartJson.comparisonInfo&&n.fieldInfo.chartJson.comparisonInfo.calculatorName)})})}delete t.states,delete t.stateSettings,delete t.fieldInfo}},f._updateChartJsonForState=function(t,a,r){r&&r.title?t.visualProperties.title.text=r&&r.title:"n"!==a&&(t.visualProperties.title.text+=" ("+o.STATE_LOCALIZATION_MAP_SHORT[a]+")"),t.visualProperties.yAxis&&(t.visualProperties.yAxis.title=r&&r.yAxisTitle||("n"===a?"":o.STATE_LOCALIZATION_MAP[a]),"i"===a&&(t.visualProperties.yAxis.baseLineValue=100)),"n"!==a&&(t.visualProperties.dataLabelsDecimals="p"===a?1:0),"p"===a&&(t.visualProperties.dataLabelsShowValuePercentSymbol=!0,t.visualProperties.yAxis&&(t.visualProperties.yAxis.showPercentSymbol=!0,t.visualProperties.yAxis.showSymbolForAllLabels=!0)),r&&r.isCurrency&&(t.visualProperties.dataLabelsShowValueCurrencySymbol=!0,t.visualProperties.yAxis&&(t.visualProperties.yAxis.showCurrencySymbol=!0,t.visualProperties.yAxis.showSymbolForAllLabels=!0)),e.mixin(t.visualProperties,r&&r.visualProps)},f.createCalculationStatesGroup=function(e){if(e)return e=l(e),{states:{ids:e,names:e.slice(),labels:e.map(function(e){return o.STATE_LOCALIZATION_MAP_SHORT[e.charAt(0)]})},value:e[0]}};var c,d;return f.init=function(e){if(c)return c;var a=u(),r={};if(!n.canLoad()){if(e&&e.variableProvider&&e.countryID&&a[e.countryID]){var i={fields:a[e.countryID].fields,variables:[]};r[e.countryID]=i,a[e.countryID].variables.forEach(function(t){var a=e.variableProvider.getVariableVintage(t);i.variables.push({fullName:t,vintage:a||"N/A"})}),o.replaceSubstitutionVariables(r)}return void(c=!0)}return c=t(Object.keys(a).map(function(e){var t=a[e].fields,i=a[e].variables;return n.loadVariables({countryID:e,hierarchy:"census",outFields:t,forceLowerCase:!0}).then(function(a){var n={fields:t,variables:[]};i.forEach(function(e){var t=a.fullNameToVariableCache[e];t.fullName=e,n.variables.push(t)}),r[e]=n})})).then(function(){o.replaceSubstitutionVariables(r)})},f.getSubstitutionVariables=function(e,t){var a=u()[e];return a&&a.variables},f});