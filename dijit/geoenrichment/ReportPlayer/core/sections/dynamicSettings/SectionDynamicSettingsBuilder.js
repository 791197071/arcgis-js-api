// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/on","esri/dijit/geoenrichment/when","dojo/dom-class","dojo/dom-construct","dijit/Destroyable","esri/dijit/geoenrichment/ReportPlayer/PlayerSelect","esri/dijit/geoenrichment/ReportPlayer/PlayerThemes","esri/dijit/geoenrichment/ReportPlayer/ReportPlayerState","./SettingsProvider","./SectionDynamicSettings","./SectionDynamicFilter","./supportClasses/ToolbarAdjuster","./dynamicInfographic/_DynamicInfographicSettingsBuilder","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/PopupUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(t,e,i,n,s,o,a,r,l,c,u,g,_,h,d,S,f,p,m,v,b){return b=b.geoenrichment.dijit.ReportPlayer.SectionDynamicSettingsBuilder,t(a,{_section:null,_settingsWidget:null,_filterWidget:null,_settingsToolbar:null,_buttonBar:null,_settingsButton:null,_filterButton:null,_filtersOnIndicator:null,_featureSelectDiv:null,_stats:null,_onButtonBarShowCallbacks:null,_needRequerySettingsSet:!1,constructor:function(t,i){this._section=t,e.mixin(this,i),this._createSettings()},_createSettings:function(){var t=this;this._provideSettingsStats().then(function(){t._stats&&(t._tryAddFeatureSelect(),t._tryAddLocatorExportButton(),t._tryAddFilterButton(),t._tryAddSettingsButton(),t.onButtonsCreated())})},_provideSettingsStats:function(){var t=this;return u.getSettingsSet(this._section).then(function(e){t._stats=e})},_tryAddFeatureSelect:function(){var t=this;if(this._stats.multiFeatureSettings&&this._stats.multiFeatureSettings.canSelectFeatures){var e=this._section.viewModel.dynamicReportInfo.analysisAreas.map(function(t,e){return{value:e,label:t.shortName||t.name}}),i=new r({options:e,value:0,allowRepetitiveSelection:!1,onChange:function(e){t._needRequerySettingsSet=!0,t._setFiltersOnIndicatorVisible(!1);var s=t._section.toJson();s.currentFeatureIndex=e.value,t._section.fromJson(s),i.closePopup(),t._settingsWidget&&t._settingsWidget.setVisualState(t._section.getVisualState()),t._filterWidget&&(t._stats.dynamicInfographicSettings?n(d.provideDynamicInfogarphicSettings(t._section),function(e){t._filterWidget.updateDynamicInfographicFilter(e.filter)}):t._filterWidget.setVisualState(t._section.getVisualState()))}}).placeAt(this._provideSettingsToolbar().featureSelectDiv);i.setTheme(l.DARK)}},_tryAddLocatorExportButton:function(){var t=this;if(this._stats.hasExport&&!this._section.isDataDrillingView){var e=this._createButton("dijitInline sectionDynamicSettings_exportButton");i(e,"click",function(){t._stats.locatorSettings.exportSettings.exportToExcel()}),v.setTooltipToNode(e,b.exportInfographicPanel)}},_settingsStateTimeoutH:null,_filterPopupShown:!1,_tryAddFilterButton:function(){function t(){i||(i=!0,m.makePopup(function(){return n(e._needRequerySettingsSet&&e._provideSettingsStats(),function(){return e._needRequerySettingsSet=!1,e._provideFilterWidget()})},e._section,e._filterButton,{orient:["before","below"],onShow:function(){e._filterPopupShown=!0,clearTimeout(e._settingsStateTimeoutH),c.isViewingDynamicSettings=!0},onClose:function(){e._filterPopupShown=!1,e._settingsPopupShown||(e._settingsStateTimeoutH=setTimeout(function(){c.isViewingDynamicSettings=!1}))}}))}var e=this,i=!1;this._stats.hasFilter&&(this._filterButton=this._createButton("dijitInline sectionDynamicSettings_filterButton",t))},_settingsPopupShown:!1,_tryAddSettingsButton:function(){function t(){i||(i=!0,m.makePopup(function(){return n(e._needRequerySettingsSet&&e._provideSettingsStats(),function(){return e._needRequerySettingsSet=!1,e._provideSettingsWidget()})},e._section,e._settingsButton,{orient:["before","below"],onShow:function(){e._settingsPopupShown=!0,clearTimeout(e._settingsStateTimeoutH),c.isViewingDynamicSettings=!0},onClose:function(){e._settingsPopupShown=!1,e._filterPopupShown||(e._settingsStateTimeoutH=setTimeout(function(){c.isViewingDynamicSettings=!1}))}}))}var e=this,i=!1;this._stats.hasViewSettings&&(this._settingsButton=this._createButton("dijitInline sectionDynamicSettings_settingsButton",t))},_createButton:function(t,e){return o.create("div",{class:t},this._provideSettingsToolbar(e).buttonBar)},_provideSettingsToolbar:function(t){function e(t){n._section.isDataDrillingView&&(t=!0),n._buttonBar.style.display=!t||!n._section.isDataDrillingView&&c.isViewingDataDrillingZoom?"none":"",t&&n._onButtonBarShowCallbacks.forEach(function(t){return t()}),t?n._adjustToolbarPosition():n._closePopup(),s[t?"add":"remove"](n._section.domNode,"hasDynamicSettingsToolbar")}var n=this;return this._settingsToolbar||(this._settingsToolbar=o.create("div",{class:"sectionDynamicSettings_toolbar"},this._section.domNode),this._featureSelectDiv=o.create("div",{class:"dijitInline"},this._settingsToolbar),this._buttonBar=o.create("div",{class:"dijitInline sectionDynamicSettings_buttonBar"},this._section.dynamicSettingsToolbarRoot||this._settingsToolbar),this._onButtonBarShowCallbacks=[],e(!1),S.isMobileDevice()?(f.addNoDragClickHandler(this._section.domNode,function(){e(!0)}),this.own(i(document.body,"touchstart",function(t){n.isMouseOver(t)||e(!1)}))):this.own(i(document.body,"mousemove",function(){e(n.isMouseOver())}))),t&&this._onButtonBarShowCallbacks.push(t),{buttonBar:this._buttonBar,featureSelectDiv:this._featureSelectDiv}},_closePopup:function(){m.close(this._settingsWidget),m.close(this._filterWidget)},_provideSettingsWidget:function(){function t(){i._closePopup()}function e(){return i._section.getInfographic().getInnerInfographic()}var i=this;return this._settingsWidget||(this._settingsWidget=new g({chartSettings:i._stats.chartSettings&&i._stats.chartSettings.viewSettings,comparisonSettings:i._stats.comparisonSettings&&i._stats.comparisonSettings.viewSettings,locatorSettings:i._stats.locatorSettings&&i._stats.locatorSettings.viewSettings,mapSettings:i._stats.mapSettings&&i._stats.mapSettings.viewSettings,onSortChart:function(e){t(),i._section.getChart().sortChart(e)},onChartToTable:function(){t(),i._section.getChart().chartToTable()},onTableToChart:function(){t(),i._section.getChart().tableToChart()},onCalcStateChanged:function(e){t(),i._section.setChartCalculationState(e)},onShowChart:function(i){t(),e().setChartView(i)},onLocatorSummaryChanged:function(t){e().setVisibleSummaryFields(t.visibleFields)},onLegendVisibilityChanged:function(t){i._section.getMapImages()[0].setLegendVisible(t)},onClosePopup:function(){t()}}),this.own(this._settingsWidget),this._settingsWidget.setVisualState(this._section.getVisualState())),this._settingsWidget},_provideFilterWidget:function(){function t(){i._closePopup()}function e(){return i._section.getInfographic().getInnerInfographic()}var i=this;return this._filterWidget||(this._filterWidget=new _({areaDetailsFilter:i._stats.areaDetailsSettings&&i._stats.areaDetailsSettings.filter,chartFilter:i._stats.chartSettings&&i._stats.chartSettings.filter,comparisonFilter:i._stats.comparisonSettings&&i._stats.comparisonSettings.filter,dynamicInfographicFilter:i._stats.dynamicInfographicSettings&&i._stats.dynamicInfographicSettings.filter,locatorFilter:i._stats.locatorSettings&&i._stats.locatorSettings.filter,onChartFilterChanged:function(t){i._section.getChart().setFilterRanges(t.filterRanges),i._setFiltersOnIndicatorVisible(t.hasFiltersOn)},onLocatorFilterChanged:function(t){e().setSearchText(t.searchText),e().setFilterRanges(t.filterRanges),i._setFiltersOnIndicatorVisible(t.hasFiltersOn)},onAreaDetailsFilterChanged:function(t){e().setSearchText(t.searchText),i._setFiltersOnIndicatorVisible(t.hasFiltersOn)},onComparisonFilterChanged:function(t){e().setFilterRanges(t.filterRanges),i._setFiltersOnIndicatorVisible(t.hasFiltersOn)},onDynamicInfographicFilterChanged:function(t){e().setFilterRanges(t.filterRanges),i._setFiltersOnIndicatorVisible(t.hasFiltersOn)},onClosePopup:function(){t()}}),this.own(this._filterWidget),this._filterWidget.setVisualState(this._section.getVisualState())),this._filterWidget},_setFiltersOnIndicatorVisible:function(t){this._filtersOnIndicator&&o.destroy(this._filtersOnIndicator),this._filtersOnIndicator=t&&o.create("div",{class:"sectionDynamicSettings_filtersOnIndicator",innerHTML:b.on},this._filterButton)},setVisualState:function(t){this._settingsWidget&&this._settingsWidget.setVisualState(t),this._filterWidget&&this._filterWidget.setVisualState(t)},notifyShown:function(){this._adjustToolbarPosition()},_panelScale:null,setPanelScale:function(t){this._panelScale=t,this._adjustToolbarPosition()},_adjustToolbarPosition:function(){this._stats&&(this._stats.locatorSettings&&!this._stats.locatorSettings.hasTitle||this._stats.areaDetailsSettings&&!this._stats.areaDetailsSettings.hasTitle||this._stats.comparisonSettings)&&s.add(this._settingsToolbar,"needsTopOffset"),this._buttonBar&&this._buttonBar.children.length>1&&s.add(this._buttonBar,"hasMultipleButtons"),h.adjustToolbarPosition({toolbar:this._settingsToolbar,section:this._section,panelScale:this._panelScale})},isMouseOver:function(t){return p.isMouseOver(this._section.domNode,{event:t})||p.isMouseOver(this._settingsToolbar,{event:t})||this._settingsWidget&&(p.isMouseOver(this._settingsWidget.domNode,{event:t})||p.isMouseOver(this._settingsWidget.domNode.parentNode,{event:t}))||this._filterWidget&&(p.isMouseOver(this._filterWidget.domNode,{event:t})||p.isMouseOver(this._filterWidget.domNode.parentNode,{event:t}))},onButtonsCreated:function(){},destroy:function(){o.destroy(this._settingsToolbar)}})});