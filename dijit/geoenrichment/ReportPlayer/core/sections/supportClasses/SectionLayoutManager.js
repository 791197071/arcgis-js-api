// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/dom-style","./SectionContentFitModes","../../grid/coreUtils/GridDataUtil","../../infographics/InfographicTypes","esri/dijit/geoenrichment/utils/FitUtil"],function(t,e,i,s,a,n){var o=t(null,{section:null,constructor:function(t){this.section=t},getWidth:function(){return e.get(this.section.domNode,"width")},_widthInitializedFlag:!1,setWidth:function(t,i){i=i||{};var s=this._widthInitializedFlag?e.get(this.section.domNode,"width"):0;i&&i.previousDim&&(s=i.previousDim.w,this._widthInitializedFlag=!0),e.set(this.section.domNode,"width",t+"px"),this._widthInitializedFlag=this._widthInitializedFlag||t>1,this.section.hasFixedLayout?this.section.getTables().forEach(function(e){(e.getMaxWidth()!==t||i.forceResize)&&e.setMaxWidth(t,{resizeToFitAllowedWidth:i.resizeContentToFit,preserveRightOffset:i.preserveRightOffset})}):this._widthInitializedFlag&&i&&i.resizeContentProportionally&&s&&t&&s!==t&&this.scaleFloatingContentProportionally({xScale:t/s,yScale:1})},getHeight:function(t){if(!this.section.hasFixedLayout)return 0;var i=0;return this.section._stackElements.forEach(function(s){switch(s.stackId){case"table":i+=s.getHeight(t),s.isLocatorTable&&s.isLocatorTable()&&(i+=s.getLocatorTablePreviewExtraHeight());break;case"img":break;case"hr":case"pageBreak":i+=e.get(s,"height")}}),i},getResizedHeight:function(){return this.section.hasFixedLayout?this.getHeight(!0):e.get(this.section.domNode,"height")},setHeight:function(t,e){if(this._setHeight(t,e),this.section.hasFixedLayout){var i=this;this.section.getTables().forEach(function(t){t.needScaleToFitHeight()&&i._scaleFixedTableToFitHeight(t)})}},updateHeightAfterContentChange:function(){this.section.hasFixedLayout&&this._setHeight(this.getResizedHeight())},_resizedHeightInitializedFlag:!1,_setHeight:function(t,i){if(this.section.hasFixedLayout){var s=this.section.getLastTable();s&&s.setSpaceAfter(t-this.getHeight())}var a=this._resizedHeightInitializedFlag?e.get(this.section.domNode,"height"):0;i&&i.previousDim&&(a=i.previousDim.h,this._resizedHeightInitializedFlag=!0),e.set(this.section.domNode,"height",t+"px"),this._resizedHeightInitializedFlag=this._resizedHeightInitializedFlag||t>1,!this.section.hasFixedLayout&&i&&i.resizeContentProportionally&&a&&t&&a!==t&&this.scaleFloatingContentProportionally({xScale:1,yScale:t/a})},scaleFloatingContentProportionally:function(t){this.section.hasFixedLayout||1===t.xScale&&1===t.yScale||this.section._stackElements.length>1||this.section._stackElements.forEach(function(e){switch(e.stackId){case"table":case"img":e.scaleProportionallyWithinParent(t)}})},getFloatingContentBox:function(){function t(t){e.minX=Math.min(e.minX,t.l),e.minY=Math.min(e.minY,t.t),e.maxX=Math.max(e.maxX,t.l+t.w),e.maxY=Math.max(e.maxY,t.t+t.h)}var e={minX:1/0,minY:1/0,maxX:0,maxY:0};return this.section._stackElements.forEach(function(e){switch(e.stackId){case"table":t(e.getTableBox());break;case"img":t(e.getImageBox(!1))}}),{l:e.minX,t:e.minY,w:e.maxX-e.minX,h:e.maxY-e.minY}},fitContentNicely:function(t,e){t=t||{},this.section.hasFixedLayout?this._fitFixedTablesNicely(t,e):this._fitFloatingContentNicely(t,e)},_fitFixedTablesNicely:function(t,e){if(t.fitMode!==i.NONE){t.fitMode===i.ALL&&delete t.fitMode;var s=this;(e||this.section.getTables()).forEach(function(e){"table"===e.stackId&&(t.fitMode!==i.WIDTH&&t.fitMode||e.resizeToFitAllowedWidth(),t.fitMode!==i.HEIGHT&&t.fitMode||s._scaleFixedTableToFitHeight(e))}),this.section._notifyContentChanged()}},_scaleFixedTableToFitHeight:function(t){t.resizeToFitHeight(this.section.getResizedHeight()),t.setSpaceAfter(0)},_fitFloatingContentNicely:function(t,s){var a=t.fitMode;if(a!==i.NONE&&(s=s||this.section._stackElements,s.length&&!(this.section._stackElements.length>1))){var n;1===s.length&&(n=this._getTransformParamsForSpecificSingleElement(s)),n=n||this._getTransformParamsForOtherElement(s,a),s.forEach(function(t){switch(t.stackId){case"table":t.scaleProportionallyWithinParent(n.scaleParams),t.setGridPosition(n.deltaLeft+t.getLeft(),n.deltaTop+t.getTop());break;case"img":t.scaleProportionallyWithinParent(n.scaleParams),e.set(t.domNode,{left:n.deltaLeft+e.get(t.domNode,"left")+"px",top:n.deltaTop+e.get(t.domNode,"top")+"px"})}})}},_getTransformParamsForSpecificSingleElement:function(t){var i,a,o,h=this.section.getTables()[0],l=h&&h.isSingleCelledTable()&&s.getFieldInfo(h.getFirstCell());if("img"===t[0].stackId&&!t[0].isMapImage()||l&&l.isImage&&!l.imageJson.isMapImage||l&&l.isShape){var c=this.getFloatingContentBox(),r=n.fitBox(c,{w:this.section.getWidth(),h:e.get(this.section.domNode,"height")},{hAlign:"center",vAlign:"middle"});i={xScale:r.ratio,yScale:r.ratio},a=r.x-c.l*i.xScale,o=r.y-c.t*i.yScale}return i&&{scaleParams:i,deltaLeft:a,deltaTop:o}},_getTransformParamsForOtherElement:function(t,s){var a,n,o,h=this.getFloatingContentBox();s===i.SINGLE_ALL_COMPLEX_WIDTH&&(s=t.length>1?i.WIDTH:i.ALL);var l=this._getContentFitOffset(t),c=this.section.getWidth()-2*l,r=e.get(this.section.domNode,"height")-2*l;return t.length>1&&h.h>r&&(s=i.ALL),a={xScale:s===i.HEIGHT?1:c/h.w,yScale:s===i.WIDTH?1:r/h.h},n=l-h.l*a.xScale,o=l-h.t*a.yScale,{scaleParams:a,deltaLeft:n,deltaTop:o}},_getContentFitOffset:function(t){var e=this.section.getTables()[0],i=e&&e.isSingleCelledTable()&&s.getFieldInfo(e.getFirstCell()),n=i&&i.isInfographic&&i.infographicJson.style&&i.infographicJson.style.padding;return this.section.noContentOffset?0:t.length>1?5:this.section.hasMapImages()?0:this.section.hasChart()?0:this.section.hasInfographic(a.ATTACHMENTS)?n||0:a.isTableLike(this.section.getInfographicType())?"number"==typeof n?n:this.section.viewModel.getCurrentTheme(this.section.theme).table.dataTablePadding||0:this.section.hasInfographic()?"number"==typeof n?n:this.section.viewModel.getStaticInfographicDefaultStyles(this.section.theme).padding||0:e&&(this.section.isImageTable(e)||i&&i.isShape)?0:this.section.viewModel.getCurrentTheme(this.section.theme).table.dataTablePadding||0},getPreferredHeight:function(){var t=this.section.getInfographicWithTable();if(!t||!t.infographic.getPreferredHeight)return 0;var e=t.table.getTableBox();return e.t+(this.getResizedHeight()-e.t-e.h)+(t.infographic.getPreferredHeight()||0)}});return o.IMAGE_FIT_PRETTY_OFFSET=0,o});