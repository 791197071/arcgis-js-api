// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","dojo/dom-construct","dojo/dom-geometry","esri/arcgis/utils","esri/graphicsUtils","esri/dijit/HomeButton","./layers/MapContentBuilder","./legend/LegendBuilder","./MapLoadTracker","./StaticMap","./WebMapsUtil","./Popup","./Projector","./mobile/MobilePanUtil","../../../dataProvider/supportClasses/AreaDataUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/UrlUtil"],function(e,t,a,n,r,o,i,s,l,c,d,u,p,m,f,I,h,g,_,v,x){var M=e(null,{_mapInfos:null,_mapDivId:0,_mapImageInfos:null,renderMapsFromCalculators:!1,constructor:function(e){t.mixin(this,e),this.reset()},setArcgisUrl:function(e){e&&(i.arcgisUrl=x.combine(e,"/sharing/rest/content/items"))},reset:function(){this._mapInfos={},this._mapImageInfos=null},collectAreaMaps:function(e){var t=[];e=e||0;var a=this._mapInfos[e];for(var n in a){var r=a[n],i=r.node;if(i.parentNode){var s=o.position(i);t.push({areaIndex:e,node:i,x:s.x,y:s.y,position:-1,map:r.map,legend:r.legend,itemId:r.itemId})}}return t.sort(function(e,t){return e.x-t.x}),t.sort(function(e,t){return e.y-t.y}),t.forEach(function(e,t){e.position=t}),t},collectAllAreasMaps:function(){var e=[];for(var t in this._mapInfos)e=e.concat(this.collectAreaMaps(t));return e},setFallbackMapImageInfos:function(e){if(!e)return void(this._mapImageInfos=null);this._mapImageInfos={},e.forEach(function(e){var t=e.areaIndex||0;(this._mapImageInfos[t]=this._mapImageInfos[t]||{})[e.itemId]=e},this)},createMap:function(e,t){return t.areaIndex=t.areaIndex||0,n(this._doCreateMap(e,t),function(e){return t.waitForLoad?n(u.waitForLoad(e.map),function(){return e}):e})},_doCreateMap:function(e,t){var r=this;if(this.renderMapsFromCalculators&&t.calculatorFieldName){var o=g.getAreaDataValue({fieldName:t.calculatorFieldName,fieldData:t.fieldData,featureIndex:this.currentFeatureIndex});if(o)return this._createStaticMap({url:v.base64DataToDataURL(o)},e,t)}return n(m.getItem(t.webMapId),function(n){if(!n)return(new a).reject(new Error("Can't load an item or the item is incorrect."));var o=new a;try{r._createMapFromItem(n,e,t).then(o.resolve,o.reject)}catch(e){o.reject(e),console.log(e)}return o.promise}).otherwise(this._createFallbackStaticMap.bind(this,t,e))},_createMapFromItem:function(e,t,o){var i=this,u=_.isMobileDevice();return m.createMap(e,t,{defaultBasemapId:o.defaultBasemapId,additionalLayerInfos:o.additionalLayerInfos,mapOptions:{extent:o.extent||s.graphicsExtent(o.features).expand(o.expandFactor||1.5),sliderPosition:!1===o.sliderPosition?"none":o.sliderPosition||"top-right",infoWindow:new f({getPlayerZoomScale:function(){return i.getPlayerZoomScale(t)}},r.create("div")),isMapNavigation:!u}}).then(function(e){var r=e&&e.map;return r?n(i._setInitialExtent(r,o),function(){return n(c.addLayersToMap(r,{features:o.features,featureIndexToAreaIndexMap:o.featureIndexToAreaIndexMap,analysisAreas:o.analysisAreas,locatorPointsControllers:o.locatorPointsControllers,stdPolygonsControllers:o.stdPolygonsControllers,thisAreasHighlightController:o.thisAreasHighlightController,geClient:o.geClient,countryID:o.countryID,hierarchy:o.hierarchy,additionalLayerInfos:o.additionalLayerInfos,calculatorFieldName:o.calculatorFieldName,attachmentsStore:o.attachmentsStore}),function(){u&&h.setUpMapPan(r,o.onPanContainer),void 0===t.__mapDivId&&(t.__mapDivId=i._mapDivId++);var e={node:t,map:r,itemId:o.webMapId,legend:null};d.createLegend(r,t,o.legendController,{onCreated:function(t){e.legend=t},onDestroyed:function(){delete e.legend}});var a=new l({map:r}).placeAt(t);return a.startup(),a.own(r.on("before-unload",function(){a.destroy()})),(i._mapInfos[o.areaIndex]=i._mapInfos[o.areaIndex]||{})[t.__mapDivId]=e,e})}):(new a).reject(new Error("Can't create a map."))})},_setInitialExtent:function(e,t){var a=t.extent||s.graphicsExtent(t.features).expand(t.expandFactor||1.5);return I.needProject(a,e)?n(I.projectGeometries(a,e),function(t){return e.setExtent(t)}):e.setExtent(a)},_createFallbackStaticMap:function(e,t){var a=this._mapImageInfos&&this._mapImageInfos[e.areaIndex]&&this._mapImageInfos[e.areaIndex][e.webMapId];return this._createStaticMap(a,t,e)},_createStaticMap:function(e,t,a){var n=e&&new p(e,t);return n&&n.load().then(function(){return n.loaded?{node:t,map:n,itemId:a.webMapId,legend:null}:null})},getPlayerZoomScale:function(e){}});return M.EXPAND_FACTOR=1.5,M});