// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","../templateJsonUtils/fieldInfo/FieldInfoBuilder","../../grid/coreUtils/GridDataUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes"],function(e,t,a,i){var n={};return n.createTable=function(a){var i=a.numColumns,n=a.numRows,l=a.width,r=a.widths,o=a.style,s=a.attributes&&a.attributes.fixedColumns,f=a.attributes&&a.attributes.dynamicColumns;if(l)if(r)r=r.map(function(e){return l*Number(e.replace("%",""))/100});else{var d=l/i;r=[];for(var u=0;u<i;u++)r.push(d)}if(r)l||isNaN(Number(r[0]))||(l=0,r.forEach(function(e){l+=e}));else{var c=Number(100/i).toFixed(3)+"%";r=[];for(var h=0;h<i;h++)r.push(c)}for(var m=[],g=0;g<i;g++)m.push({field:"field"+g,style:{width:r[g]}});for(var p=[],y=!0,b=a.height?a.height/n:a.rowHeight||15.07,v=0;v<n;v++){var T={style:{height:b,fields:{}},fieldInfos:{}};for(g=0;g<i;g++){var S="field"+g;!1!==a.useDefaultTheme&&(T.style.fields[S]=e.mixin({horizontalAlign:0===g?"left":"right",overrideStyle:0===v?n>1?!1!==a.useDefaultHeaderTheme?"TableHeader":"Default":void 0:y?"AlternatingRow":"Default"},a.cellParams)),f&&g>=s&&0===v&&(T.fieldInfos[S]=t.createFieldInfoFromSpecialFieldName("AREA_DESC")),a.processTableCell&&a.processTableCell(T,S,v,g,a)}p.push(T),y=!y}return{id:"table",attributes:e.mixin({},a.attributes),style:e.mixin({width:l||772.33},o),data:{columns:m,data:p}}},n.createSingleCellTable=function(e){e=e||{};var t=n.createTable({numColumns:1,numRows:1,attributes:e.attributes,useDefaultTheme:!1});return n.modifyTableJson(t,0,0,e),t},n.modifyTableJson=function(e,t,a,i){var n=e.data.data[t],l=e.data.columns[a],r=l.field;i.text&&(n[r]=i.text),i.fieldInfo&&(n.fieldInfos[r]=i.fieldInfo),i.cellStyle&&(n.style.fields[r]=i.cellStyle),i.columnSpan&&(n.columnSpans=n.columnSpans||{},n.columnSpans[r]=i.columnSpan),i.rowSpan&&(n.rowSpans=n.rowSpans||{},n.rowSpans[r]=i.rowSpan),n.themeStyle=i.themeStyle,i.width&&(e.style.width=i.width,l.style.width=i.width),i.height&&(n.style.height=i.height),void 0!==i.left&&(e.style.left=i.left),void 0!==i.top&&(e.style.top=i.top)},n.getTableWidth=function(e){return e.style.width},n.getTableHeight=function(e){var t=0;return e.data.data.forEach(function(e){t+=e.style?e.style.height:0}),t},n.calcTableBox=function(e){return{x:e.style.left||0,y:e.style.top||0,w:n.getTableWidth(e),h:n.getTableHeight(e)}},n.createDetailsSection=function(e){return{type:i.DETAILS,stack:[n.createTable(e)]}},n.createDetailsSectionForFieldInfos=function(t,a){return{type:i.DETAILS,stack:[function(){var i=n.createTable(e.mixin({numColumns:2,numRows:t.length+1},a));return i.data.data.forEach(function(e,a){if(0===a)return void(e.field0=t[0].hasVariable?t[0].fieldCategory:"");var i=t[a-1];e.field0=i.script?i.script.alias:i.alias,e.fieldInfos.field1=i}),n.provideSpaceAfter(i),i}()]}},n.createDetailsSectionForFieldInfoGroups=function(t,a){return{type:i.DETAILS,stack:[function(){var i=t[0],l=n.createTable(e.mixin({numColumns:t.length+1,numRows:i.length+1},a));return l.data.data.forEach(function(e,a){l.data.columns.forEach(function(i,n){if(0!==n){if(0===a)return void(e[i.field]=t[n-1][0].fieldCategory||"");var l=t[n-1][a-1];e.field0=e.field0||(l.script?l.script.alias:l.alias),e.fieldInfos[i.field]=l}})}),n.provideSpaceAfter(l),l}()]}},n.provideSpaceAfter=function(e,t){e.style.spaceAfter=Math.max(t||0,90-15.07*e.data.data.length)},n.applyDefaultStyling=function(e){var t=!0;e.data.data.forEach(function(a,i){e.data.columns.forEach(function(e){a.style.fields[e.field].overrideStyle=0===i?"TableHeader":t?"AlternatingRow":void 0}),t=!t})},n.setTableHeaderStyle=function(e){if(e.style)for(var t in e.style.fields){var a=e.style.fields[t]=e.style.fields[t]||{};a.overrideStyle="TableHeader"}},n.DEFAULT_ROW_HEIGHT=15.07,n.isEmptyTable=function(e){return e.isGrid?!(e.columns&&e.columns.length&&e.store&&e.store.data.length):!!e.data&&!(e.data.columns&&e.data.columns.length&&e.data.data&&e.data.data.length)},n.isSingleCelledTable=function(e){return e.isGrid?e.store&&1===e.store.data.length&&e.columns&&1===e.columns.length:!!e.data&&(1===e.data.columns.length||1===e.data.data.length)},n.isMultiDataTable=function(e){return e.isGrid?e.columns.length>1||e.store.data.length>2:!!e.data&&(e.data.columns.length>1||e.data.data.length>2)},n.getTableSubtype=function(e){if(!n.isSingleCelledTable(e))return null;var t;return t=e.isGrid?e.store.data[0].fieldInfos[e.columns[0].field]:e.data.data[0].fieldInfos[e.data.columns[0].field],a.isTextLikeCell(t)?"isTextLike":t.isImage?"isImage":t.isShape?"isShape":null},n.tableJsonHasInfographic=function(e){return!!n.getTableJsonInfographic(e)},n.getTableJsonInfographic=function(e){var t;return e.data.data.some(function(e){if(e.fieldInfos)for(var a in e.fieldInfos){var i=e.fieldInfos[a];if(i&&i.isInfographic)return t=i.infographicJson,!0}}),t},n.getTableJsonFirstFieldInfo=function(e){return e.data.data[0].fieldInfos[e.data.columns[0].field]},n.tableJsonHasChart=function(e){return e.data.data.some(function(e){if(e.fieldInfos)for(var t in e.fieldInfos){var a=e.fieldInfos[t];if(a&&a.isChart)return!0}})},n});