// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/ReportPlayer/core/grid/coreUtils/GridDataUtil","../../tableJson/TableJsonUtil"],function(e,t,n,o){var a={},s={provideParentInfo:function(e,t,n,o,a,s){i.collectStatistics(t),e._parentBox={x:function(){switch(a){case"floating":return t.style.left+s.left;case"page":return i.calcX(t,n,o)+s.left}}(),y:function(){switch(a){case"floating":return t.style.spaceBefore+s.top;case"page":return i.calcY(t,n,o)+s.top}}(),w:i.calcFullWidth(t,n,o),h:i.calcFullHeight(t,n,o)},e._parentStyle={backgroundColor:function(e,t){return e.style.fields=e.style.fields||{},(e.style.fields[t]=e.style.fields[t]||{}).backgroundColor}(n,o.field)}},sanitize:function(e){i.sanitize(e)}},i={collectStatistics:function(e){if(!e._measureInfo){var t,n={},o={};e.data.columns.forEach(function(e){t&&(o[t.field]=e),t=e,n[e.field]=e});var a={},s={},l={},c={},r={},f={};e.data.data.forEach(function(t,n){e.data.columns.forEach(function(e,o){var d=r[o]||0,u=f[n]||0,g=i._getDataHeight(t,e.field),h=i._getFieldWidth(t,e);d+=g,u+=h,r[o]=d,f[n]=u;var p=o+"_"+n;s[p]=d,a[p]=u,l[p]=a[o-1+"_"+n]||0,c[p]=s[o+"_"+(n-1)]||0})}),e._measureInfo={xPositions:l,yPositions:c,columnsHash:n,nextColumnHash:o}}},calcX:function(e,t,n){var o=e.data.columns.indexOf(n),a=e.data.data.indexOf(t);return e._measureInfo.xPositions[o+"_"+a]||0},calcY:function(e,t,n){var o=e.data.columns.indexOf(n),a=e.data.data.indexOf(t);return e._measureInfo.yPositions[o+"_"+a]||0},calcFullWidth:function(e,t,n){var o=n.field,a=i._getFieldWidth(t,e._measureInfo.columnsHash[o]),s=t.columnSpans&&t.columnSpans[o]||1;if(s>1)for(var l,c=0;c<s-1;c++)l=e._measureInfo.nextColumnHash[l?l.field:o],a+=i._getFieldWidth(t,l);return a},_getFieldWidth:function(e,t){return e.style.fields=e.style.fields||{},(e.style.fields[t.field]=e.style.fields[t.field]||{}).width||t.style.width},calcFullHeight:function(e,t,n){var o=n.field,a=e.data.data.indexOf(t),s=i._getDataHeight(t,o),l=t.rowSpans&&t.rowSpans[o]||1;if(l>1)for(var c,r=a+1,f=0;f<l-1;f++)c=e.data.data[r++],s+=i._getDataHeight(c,o);return s},_getDataHeight:function(e,t){return e.style.fields=e.style.fields||{},(e.style.fields[t]=e.style.fields[t]||{}).height||e.style.height},sanitize:function(e){delete e._measureInfo}},l={getIntersectingTableJsonsBehind:function(e,a,s,i,l){function c(e){var i=e.data.data[0].fieldInfos[e.data.columns[0].field];return!!(n.isTextLikeCell(i)||n.isShapeCell(i)||n.isImageCell(i))&&t.checkRectsIntersect([s,{x:e.style.left+a.left,y:e.style.spaceBefore+a.top,w:o.getTableWidth(e),h:o.getTableHeight(e)}])}function r(e){return t.checkRectsIntersect([s,{x:e.style.left+a.left,y:e.style.spaceBefore+a.top,w:e.style.width,h:e.style.height}])}var f=[],d=[];return e.backgroundFloatingTablesSectionJson&&e.backgroundFloatingTablesSectionJson.stack.forEach(function(e,t){if((-1===i||l||i!==t)&&("table"===e.id&&c(e)||"img"===e.id&&r(e))){-1===i||l||i>t?f.push(e):d.push(e)}}),e.foregroundFloatingTablesSectionJson&&e.foregroundFloatingTablesSectionJson.stack.forEach(function(e,t){if(l&&i===t)return!0;if("table"===e.id&&c(e)||"img"===e.id&&r(e)){l&&i>t?f.push(e):d.push(e)}}),{elementJsonsBehind:f,elementJsonsAbove:d}}};return a.collectSectionJsons=function(e,t){t=t||{};var n=[];return e?e.sections?e.sections:e.sectionsTables?(e.sectionsTables.forEach(function(o){!1!==t.backgroundForeground&&o.foregroundSectionJson&&o.foregroundSectionJson.stack&&n.push(o.foregroundSectionJson);var s=[];!1!==t.floatingTables&&o.foregroundFloatingTablesSectionJson&&o.foregroundFloatingTablesSectionJson.stack.forEach(function(n,i){"table"===n.id&&a._processTableJson(n,s,"floating",e.documentOptions,t,o,i,!0)}),s.reverse(),n=n.concat(s),a._processTableJson(o,n,"page",e.documentOptions,t,o),s.length=0,!1!==t.floatingTables&&o.backgroundFloatingTablesSectionJson&&o.backgroundFloatingTablesSectionJson.stack.forEach(function(n,i){"table"===n.id&&a._processTableJson(n,s,"floating",e.documentOptions,t,o,i,!1)}),s.reverse(),n=n.concat(s),!1!==t.backgroundForeground&&o.backgroundSectionJson&&o.backgroundSectionJson.stack&&n.push(o.backgroundSectionJson)}),n):[]:[]},a._processTableJson=function(t,n,o,a,i,c,r,f){t.data.data.forEach(function(d){d.fieldInfos&&t.data.columns.forEach(function(u){function g(t){return t=e.clone(t),t.isContextFloatingElement=!0,t.style.left=t.style.left+a.left-b._parentBox.x,"table"===t.id?t.style.spaceBefore=t.style.spaceBefore+a.top-b._parentBox.y:"img"===t.id&&(t.style.top=t.style.top+a.top-b._parentBox.y),t}var h=d.fieldInfos[u.field];if(h&&h.sectionJson&&h.sectionJson.stack)if(i.processFieldInfoFunc&&i.processFieldInfoFunc(h),(!1!==i.saveParentInfo||i.populateWithFloatingElementsBehind)&&s.provideParentInfo(h.sectionJson,t,d,u,o,a),i.populateWithFloatingElementsBehind){var p,b=e.clone(h.sectionJson);"page"===o?p=l.getIntersectingTableJsonsBehind(c,a,b._parentBox,-1,void 0):"floating"===o&&(p=l.getIntersectingTableJsonsBehind(c,a,b._parentBox,r,f));var y=p.elementJsonsBehind.map(g),m=p.elementJsonsAbove.map(g);b.stack=y.concat(b.stack),b.stack=b.stack.concat(m),n.push(b)}else n.push(h.sectionJson)})}),s.sanitize(t)},a.getParentBox=function(e){return e&&e._parentBox},a.getParentStyle=function(e){return e&&e._parentStyle},a});