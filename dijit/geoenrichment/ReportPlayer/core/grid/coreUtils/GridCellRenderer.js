// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/aspect","./GridDataUtil","./GridStyleUtil","./GridCellContentScaler","./GridCellContentSynchronizer","../../supportClasses/conditionalStyling/ConditionalStyleUtil","../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoRenderer","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ElementUsageTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/SpecificViewModes","./GridQueryUtil","./tooltip/GridCellTooltipBuilder","../../../_devConfig"],function(e,t,n,i,r,a,o,l,d,s,g,h,c,u,p){function C(e){return e[e.parentGrid.hasRealBorders?"getContentWidth":"getWidth"]()}function f(e){return e[e.parentGrid.hasRealBorders?"getContentHeight":"getHeight"]()}function m(e){return{formattedValue:null===e||void 0===e||"number"==typeof e&&isNaN(e)?"":e,value:e,formatFunction:null,isUnavailableData:!1,conditionalStyle:null}}var v={color:"#FF0000"},y=e(null,{_parentState:null,constructor:function(e,n,i){var o=this;r.fitContentInsideCell(e),this._setParentState(e),i.forEach(function(i){var l=i[0],d=i[1];n.own(t.after(e,l,function(){o._checkParentChanged(d,e)&&(r.fitContentInsideCell(e),a.syncParentFieldInfoWithElementState(e,n))}))})},_setParentState:function(e){var t=e.getFullStyle();this._parentState={width:e.getWidth(),height:e.getHeight(),horizontalAlign:t.horizontalAlign,verticalAlign:t.verticalAlign}},_checkParentChanged:function(e,t){var n;switch(e){case"width":var i=t.getWidth();this._parentState.width!==i&&(this._parentState.width=i,n=!0);break;case"height":var r=t.getHeight();this._parentState.height!==r&&(this._parentState.height=r,n=!0);break;case"horizontalAlign":case"verticalAlign":var a=t.getFullStyle();this._parentState.horizontalAlign===a.horizontalAlign&&this._parentState.verticalAlign===a.verticalAlign||(this._parentState.horizontalAlign=a.horizontalAlign,this._parentState.verticalAlign=a.verticalAlign,n=!0)}return n}});return e(null,{renderCellContent:function(e){var t,i=e.parentGrid,r=n.getFieldInfo(e);if(p.emulateErrors.reportContainerRenderError)throw new Error("Error test: something crashed whend building the UI layout!");if(r){if(r.isChart)return void this._placeChartInCell(i,e);if(r.isImage||r.isShape)return this._renderCellTooltip(e),void this._placeImageOrShapeInCell(i,e,r.isImage);if(r.isReportSection)return void this._placeReportSectionInCell(i,e);if(r.isInfographic)return void this._placeInfographicInCell(i,e);r.isMissing&&e.setStyle(v),t=this._getRenderedContent(e,r)}else t=m(e.gridData[e.column.field]);this._applyRenderedContent(e,t),e.setContent(null),this._renderCellTooltip(e)},_renderCellTooltip:function(e){if(e.viewModel.dynamicReportInfo){var t=e.viewModel.dynamicReportInfo.templateVariableProvider;u.setDynamicTooltipToCell(e,t)}},updateViewMode:function(e){var t=n.getFieldInfo(e);t&&(t.hasVariable||t.script||t.alias||t.isRichText)&&this._applyRenderedContent(e,this._getRenderedContent(e,t))},_getRenderedContent:function(e,t){var n=this._prepareRenderContextForFieldCell(e,t);return l.renderFieldInfoInTableCell(t,n)},_prepareRenderContextForFieldCell:function(e,t){var n=e.parentGrid,i=n.getViewMode()===g.EDIT;return{previewValues:this._isPreviewValues(e),previewConditionalStyle:!i,getPreviewValueFunction:n.getPreviewValueFunction,fieldData:n.viewModel.dynamicReportInfo&&n.viewModel.dynamicReportInfo.fieldData,currentFeatureIndex:n.getFeatureIndexForCell(e),rowIndex:e.gridData&&e.gridData.index,isGraphicReport:n.viewModel.isGraphicStyle,isMultiFeature:n.viewModel.dynamicReportInfo&&n.viewModel.dynamicReportInfo.isMultiFeature}},_isPreviewValues:function(e){var t=e.parentGrid,i=n.getFieldInfo(e),r=t.getSpecificViewMode(),a=t.getViewMode()===g.PREVIEW_VALUES;return!i||"SiteNote"!==i.name&&"SiteNotes"!==i.name||(a=!0),r&&i&&(r[h.RICH_TEXT]===g.PREVIEW_VALUES&&i.isRichText?a=!0:r[h.VARIABLE]===g.PREVIEW_VALUES&&(i.hasVariable||i.script)?a=!0:r[h.INFOGRAPHIC]===g.PREVIEW_VALUES&&i.isInfographic&&(a=!0)),a},_applyRenderedContent:function(e,t){t&&(n.setFieldCellContent(e,t.formattedValue),t.isUnavailableData||("number"==typeof t.value&&(n.setNumericCellValue(e,t.value),e.setNumberValue(t.value,t.formatFunction,e.parentGrid.enableNumberAnimation)),t.conditionalStyle?(e.setStyle(t.conditionalStyle.style),"string"==typeof t.conditionalStyle.formattedValue&&n.setFieldCellContent(e,t.conditionalStyle.formattedValue),e.__hasConditionalStyle=!0):(!1===t.conditionalStyle||e.__hasConditionalStyle)&&(delete e.__hasConditionalStyle,e.setStyle(i.combineCellStyle(e.parentGrid,e.gridData,e.column)))),e.parentGrid&&e.parentGrid.viewModel.dynamicReportInfo&&e.setUrl(n.getFieldCellUrl(e)))},_placeChartInCell:function(e,t){var n={viewModel:e.viewModel,theme:e.theme,currentFeatureIndex:e.getFeatureIndexForCell(t),parentWidget:t,onContentLoadingStart:e.onContentLoadingStart.bind(e),onContentLoadingEnd:e.onContentLoadingEnd.bind(e)};return this._createChartPageFromParams(e,t,n)},_createChartPageFromParams:function(e,t,i){var r=n.getFieldInfo(t).chartJson;r.visualProperties.width=t.getWidth(),r.visualProperties.height=t.getHeight();var a=function(e){t.setContent(e)},o=e.viewModel.layoutBuilder.createElement("chart",{node:t.getContentContainerNode(),placeFunc:a,json:r,creationParams:i});return new y(t,o,[["onWidthChanged","width"],["onHeightChanged","height"]]),o},_placeImageOrShapeInCell:function(e,t,i){var r=n.getFieldInfo(t),a=r[i?"imageJson":"shapeJson"],d=C(t),s=f(t);if(i){if(r.triggerJson&&e.viewModel.dynamicReportInfo){var g=l.getValueFromFieldData(r.triggerJson.fieldInfo,{fieldData:e.viewModel.dynamicReportInfo.fieldData,currentFeatureIndex:e.getFeatureIndexForCell(t)});o.processImageJsonForTrigger(a,g.value,r.triggerJson),g.isUnavailableData||"number"!=typeof g.value||(n.setNumericCellValue(t,g.value),t.setNumberValue(g.value,g.formatFunction,!1))}else if(r.triggerJson){var h=l.getConditionalStylePreview(r,t.gridData.index);h&&"number"==typeof h.value&&(o.processImageJsonForTrigger(a,h.value,r.triggerJson),n.setNumericCellValue(t,h.value))}a.style.width&&a.style.height&&!a.fitParent&&Math.round(a.style.width)!==Math.round(d)&&Math.round(a.style.height)!==Math.round(s)?a.fitParent=!1:(a.fitParent=!0,a.style.width=d,a.style.height=s)}else a.style.width=d,a.style.height=s;var c,u={viewModel:e.viewModel,theme:e.theme,parentWidget:t,currentFeatureIndex:e.getFeatureIndexForCell(t),alignParams:t.getFullStyle(),imageTriggerJson:r.triggerJson,getPreviewValueFunction:e.getPreviewValueFunction,applyThemeStyle:e.applyThemeStyle,onInitialized:function(){if(t.domNode){var e=C(t),n=f(t);c&&c.resize&&c.resize({w:e,h:n},t.getFullStyle())}},onContentLoadingStart:e.onContentLoadingStart.bind(e),onContentLoadingEnd:e.onContentLoadingEnd.bind(e)};return c=this._createImageOrShapeFromParams(e,t,a,i,u),new y(t,c,[["onWidthChanged","width"],["onHeightChanged","height"],["setStyle","horizontalAlign"]]),c},_createImageOrShapeFromParams:function(e,t,n,i,r){var a=function(e){t.setContent(e)};return e.viewModel.layoutBuilder.createElement(i?"image":"shape",{node:t.getContentContainerNode(),placeFunc:a,relativeParent:t.domNode,json:n,creationParams:r})},_placeReportSectionInCell:function(e,t){var i={};return i.class="adjustableGrid_inCellSection",i.json=n.getFieldInfo(t).sectionJson,i.viewModel=e.viewModel,i.theme=e.theme,i.viewPortContainer=e.viewPortContainer,i.parentWidget=t,i.currentFeatureIndex=e.getFeatureIndexForCell(t),i.initialWidth=C(t),i.noContentOffset=c.cellHasFloatingTableParent(t),i.initialViewMode=e.getViewMode(),i.onContentLoadingStart=e.onContentLoadingStart.bind(e),i.onContentLoadingEnd=e.onContentLoadingEnd.bind(e),this._createReportSectionFromParams(e,t,i)},_createReportSectionFromParams:function(e,t,n){var i;return n.parentGridCell=t,n.elementUsageType=(e.isReportContainerPageGrid||e.parentGrid&&e.parentGrid.isReportContainerPageGrid)&&s.PAGE_PANEL_SECTION,i=n.json&&n.json.stack&&n.json.type!==d.EMPTY?e.viewModel.layoutBuilder.createElement("section",n,t.getContentContainerNode()):e.viewModel.layoutBuilder.createElement("emptySection",n,t.getContentContainerNode()),t.setContent(i),new y(t,i,[["onWidthChanged","width"],["onHeightChanged","height"]]),i},_placeInfographicInCell:function(e,t){var i=n.getFieldInfo(t).infographicJson,r={viewModel:e.viewModel,theme:e.theme,parentWidget:t,currentFeatureIndex:e.getFeatureIndexForCell(t),getPreviewValueFunction:e.getPreviewValueFunction,width:C(t),height:f(t),adjustElementsWhenResized:c.cellHasFloatingTableParent(t),onContentLoadingStart:e.onContentLoadingStart.bind(e),onContentLoadingEnd:e.onContentLoadingEnd.bind(e)},a=this._createInfographicFromParams(e,t,i,r);return a.setViewMode&&a.setViewMode(e.getViewMode()),a},_createInfographicFromParams:function(e,t,n,i){var r=function(e){t.setContent(e)},a=e.viewModel.layoutBuilder.createElement("infographic",{node:t.getContentContainerNode(),placeFunc:r,json:n,creationParams:i});return new y(t,a,[["onWidthChanged","width"],["onHeightChanged","height"]]),a}})});