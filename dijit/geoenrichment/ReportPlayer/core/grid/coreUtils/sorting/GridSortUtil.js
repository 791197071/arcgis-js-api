// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/dom-class","dojo/dom-construct","./GridRowStyler","../GridDataUtil","../GridQueryUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/ObjectUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(o,r,e,t,n,i,l,a,s){s=s.geoenrichment.dijit.ReportPlayer.Grid;var d={},f=/^(\d+|\d+[.,]\d+)%$/;return d.isGridSortable=function(o){return!(!o.allowSorting||o.isEmptyTable()||o.store.data.length<3||!o.viewModel.dynamicReportInfo)},d.updateSorting=function(o,r){if(d.isGridSortable(o)){var e=d._collectHeaderRowInfo(o);e&&d._makeSortable(o,e),!r&&e&&d._applySortInfo(o,e)}},d._collectHeaderRowInfo=function(o){function r(r){return r&&r.length===o.columns.length}for(var e,t,i=o.store.data.length-2,l=0;l<i;l++){var a=n.queryCells(o,{rowIndex:l});if(r(a)){e=a,t=l;break}}if(!e)return null;for(l=t+1;l<o.store.data.length;l++)if(a=n.queryCells(o,{rowIndex:l}),!r(a))return null;return{cells:e,headerRowIndex:t}},d._makeSortable=function(e,t){t.cells.forEach(function(n){var l=r.create("div",{class:"sortArrow sortArrowHoverIndicator"},n.domNode),a=n.getFullStyle();l.style[a&&"left"===a.horizontalAlign?"right":"left"]="5px",n._sortArrow=l,o.add(n.domNode,"esriGEClickable"),i.addNoDragClickHandler(n.contentBlock,function(o){e&&e.canSortCellFunc&&!e.canSortCellFunc(n)||d._checkCanSortOnHeaderClick(o)&&d._toggleSortForCell(n,t)}),i.addNoDragClickHandler(l,function(o){d._toggleSortForCell(n,t)})}),d._updateArrows(e,t)},d._toggleSortForCell=function(o,r){var e=o.parentGrid,t=e._sortInfo&&e._sortInfo.field===o.column.field?e._sortInfo.order:null;e._sortInfo={field:o.column.field,order:null,originalData:e._sortInfo?e._sortInfo.originalData:e.store.data.slice()},t?"desc"===t?e._sortInfo.order="asc":"asc"===t&&(e._sortInfo.order=null):e._sortInfo.order="desc",d._applySortInfo(e,r),e.onSortingChanged(d.getSorting(e))},d._checkCanSortOnHeaderClick=function(o){if(o&&o.path){if(o.path.some(function(o){return"A"===o.nodeName}))return!1}else if(o&&o.srcElement&&o.srcElement.parentNode&&"A"===o.srcElement.parentNode.nodeName)return!1;return!0},d._applySortInfo=function(o,r,n){if(d._updateArrows(o,r),o._sortInfo){if(o._sortInfo.order){for(var i=[],a=o._sortInfo.originalData.slice(),s=0;s<r.headerRowIndex+1;s++)i.push(a.shift());var c=e.getStyleInfo(a,o.columns),u=o._sortInfo.field;a.sort(function(r,e){function n(o){var r=t.getNumericDataValue(o,u);if(void 0!==r)return r;var e=o[u];return"string"==typeof e?f.test(e)?(r=l.parseNumber(e.replace("%","")),isNaN(r)?e:r):(r=l.parseNumber(e),isNaN(r)?e:r):e}var i,a=n(r),s=n(e),d="desc"===o._sortInfo.order,c="number"==typeof a||"number"==typeof s;return c?(a=Number(a),s=Number(s),i=a>s?1:a<s?-1:0,d?-i:i):(a=String(a),s=String(s),i=a.localeCompare(s),d?-i:i)}),c&&e.setAlternatingColors(a,o.columns,c),o.store.data=i.concat(a)}else o.store.data=o._sortInfo.originalData,e.resetStyling(o._sortInfo.originalData,o.columns);n||o.refresh({skipSorting:!0})}},d._updateArrows=function(r,e){e.cells.forEach(function(e){var t=e._sortArrow;o.remove(t,"sortArrowHoverIndicator sortArrowUp sortArrowDown"),a.setTooltipToNode(t,null),r._sortInfo&&r._sortInfo.field===e.column.field?"asc"===r._sortInfo.order?o.add(t,"sortArrowUp"):"desc"===r._sortInfo.order?o.add(t,"sortArrowDown"):(a.setTooltipToNode(t,s.sortTable),o.add(t,"sortArrowHoverIndicator")):(a.setTooltipToNode(t,s.sortTable),o.add(t,"sortArrowHoverIndicator")),setTimeout(function(){t.style.top=(e.getHeight()-t.clientHeight)/2+"px"},100)})},d.getSorting=function(o){return o._sortInfo&&{field:o._sortInfo.field,order:o._sortInfo.order}},d.setSorting=function(o,r,e){if(d.isGridSortable(o)&&r){var t=d._collectHeaderRowInfo(o);t&&(o._sortInfo={field:r.field,order:r.order,originalData:o._sortInfo?o._sortInfo.originalData:o.store.data.slice()},d._applySortInfo(o,t,e&&e.doNotRefresh))}},d.getSortRowIndexMapping=function(o){if(!o._sortInfo||!o._sortInfo.order)return null;var r={};return o.store.data.forEach(function(e,t){r[t]=o._sortInfo.originalData.indexOf(e)}),r},d});