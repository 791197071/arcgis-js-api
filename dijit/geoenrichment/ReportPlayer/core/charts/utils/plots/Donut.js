// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojox/charting/plot2d/Base","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils","./animation/_DonutAnimation","./labelsRendering/LabelOverlapFixer","./labelsRendering/LabelsUtil"],function(t,e,n,i,a,s,r,l,o,h,u){var c={createPath:function(t,e,n,i,a,s,r,l,o,h,u,c){var f=function(a,c,f){e=void 0!==c?c:e;var b=d.getEndAngle(e,a,s,r,o,u,f);1===a&&(b=Number(Math.floor(1e5*b)/1e5));var x,g=n*l,p=b-e,m=i.cx+n*Math.cos(e),_=i.cy+n*Math.sin(e),v=i.cx+n*Math.cos(b),M=i.cy+n*Math.sin(b);if(g){var y=i.cx+g*Math.cos(e),P=i.cy+g*Math.sin(e),R=i.cx+g*Math.cos(b),A=i.cy+g*Math.sin(b);x=t.createPath().moveTo(y,P).lineTo(m,_).arcTo(n,n,0,p>Math.PI,!0,v,M).lineTo(R,A).arcTo(g,g,0,p>Math.PI,!1,y,P).closePath().setStroke(h.series.stroke)}else x=t.createPath().moveTo(i.cx,i.cy).lineTo(m,_).arcTo(n,n,0,p>Math.PI,!0,v,M).lineTo(i.cx,i.cy).closePath().setStroke(h.series.stroke);return x.setFill(h.series.fill),{shape:x,end:b,donutGap:r}};return c.push({isSlice:!0,sliceIndex:a,func:f}),f}},d={getStartAngle:function(t,e){return t.series.donutArcPercent&&100!==t.series.donutArcPercent?(100-t.series.donutArcPercent)/100*360/2-270:(t.series.startAngle||0)+e},getEndAngle:function(t,e,n,i,a,s,r){var l=t+2*e*Math.PI-i;if(n){var o=s+2*Math.PI-i;r||a.series.donutArcPercent&&100!==a.series.donutArcPercent?(l+=i,l=Math.min(l,o)):l=o}return l}};return t([n,i,o],{enableHole:!0,enableGap:!0,startAngleOffset:0,_animationInfos:null,_dataLabels:null,_labelBoxes:null,defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelStyle:"outside",startAngle:0,animate:null},optionalParams:{radius:0,omitLabels:!1,labelFunc:null,stroke:{},outline:{},fill:{},styleFunc:null,font:"",fontColor:"",labelWiring:{}},constructor:function(t,n){this.opt=e.clone(this.defaultParams),l.updateWithObject(this.opt,n),l.updateWithPattern(this.opt,n,this.optionalParams),this.axes=[],this.run=null,this.dyn=[],this.runFilter=[]},clear:function(){return this.inherited(arguments),this.dyn=[],this.run=null,this},setAxis:function(t){return this},addSeries:function(t){return this.run=t,this},getSeriesStats:function(){return e.delegate(a.defaultStats)},getRequiredColors:function(){return this.run?this.run.data.length:0},getRenderResults:function(){return this._lastRenderResults},render:function(t,n){function i(t,e,n){return d.getEndAngle(t,e,n,L,l,v)}if(!this.dirty)return this;this.resetEvents(),this._eventSeries={},this.cleanGroup();var a=this.group,l=this.chart.theme;if(!this.run||!this.run.data.length)return this;var o,h,f,b,x,g,p=(t.width-n.l-n.r)/2,m=(t.height-n.t-n.b)/2/this._getRYMultiplier(l),_=Math.min(p,m),v=s._degToRad(this._getStartAngle(l)),M=v,y=this.events(),P=this.run.data.map(function(t,e){return"number"!=typeof t&&t.hidden&&(this.runFilter.push(e),t.hidden=!1),this.runFilter.some(function(t){return t===e})?"number"==typeof t?0:{y:0,text:t.text}:t},this);this.dyn=[],"radius"in this.opt&&(_=this.opt.radius,g=_);var R,A={cx:n.l+p,cy:n.t+m,r:_};if(f=r.map(P,"x ? Math.max(x.y, 0) : 0"),r.every(f,"<= 0"))return a.createCircle(A).setStroke(l.series.stroke),this.dyn=f.map(function(){return{}}),this;b=r.map(f,"/this",r.foldl(f,"+",0)),this.opt.labels&&(x=b.map(function(t,e){return u.getLabelInfo(this,P[e],l,{horizontalAlign:l.series.dataLabelsHorizontalAlign,dataLabelsMaxWidth:l.series.dataLabelsMaxWidth})},this));var S=this.enableHole?(l.series.donutHolePercent||0)/100:0,L=this.enableGap?s._degToRad(l.series.donutGap||0):0;b=this._fixSlices(b,L),this._lastRenderResults={},this._animationInfos=[],this._labelBoxes=[];var T=r.map(P,function(t,e){var n=[this.opt,this.run];return null!=t&&"number"!=typeof t&&n.push(t),this.opt.styleFunc&&n.push(this.opt.styleFunc(t)),l.next("slice",n,!0)},this),w=this._preprocessParams(P,l,_,_*S,p,m,A,b);if(A=w.circle,_=w.r,this.opt.labels)switch(o=0,h=0,x.forEach(function(t,e){o=Math.max(o,t.box.w),h=Math.max(h,t.box.h)}),this.opt.labelStyle){case"outside":var E=_;_=Math.min(p-o,m-h)-5,g=_+10,_=Math.max(_,E/2);break;case"inside":var k=(_-_*S)/2+_*S;g=Math.abs(k+(_-o/2))/2;break;case"columns":_=Math.min(p-o-20,m-2*h),g=_}var I=new Array(b.length);if(b.some(function(t,e){t=this._getSliceValueAt(b,e,l);var n,i=P[e],s=T[e];R=_*S;var r=c.createPath(a,M,_,A,e,e+1===b.length,L,S,l,s,v,this._animationInfos)(t),o=r.end;return shape=r.shape,l.series.isEditMode&&(shape.rawNode.style.cursor="pointer"),this.dyn.push({fill:void 0,stroke:s.series.stroke}),y&&(n={element:"slice",index:e,run:this.run,shape:shape,x:e,y:"number"==typeof i?i:i.y,cx:A.cx,cy:A.cy,cr:_},this._connectEvents(n),I[e]=n),M=o+L,!1},this),this.opt.labels)if("outside"===this.opt.labelStyle||"inside"===this.opt.labelStyle)M=v,b.some(function(t,e){t=this._getSliceValueAt(b,e,l);var n=x[e];if(t<=0)return!1;T[e];if(t>=1)return this._labelBoxes.push({x:A.cx-n.box.w/2,y:A.cy-n.box.h/2,w:n.box.w,h:n.box.h,text:n.getText()}),!0;var a=i(M,t,e+1===b.length);if(this.opt.omitLabels&&a-M<.001)return!1;var s,r,o=(M+a)/2;return"outside"===this.opt.labelStyle?(s=A.cx+g*Math.cos(o)-(n.box.w/2-n.box.w/2*Math.cos(o)),r=A.cy+g*Math.sin(o)-(n.box.h/2-n.box.h/2*Math.sin(o))):(s=A.cx+g*Math.cos(o)-n.box.w/2,r=A.cy+g*Math.sin(o)-n.box.h/2),this._labelBoxes.push({x:s,y:r,w:n.box.w,h:n.box.h,text:n.getText()}),M=a+L,!1},this);else if("columns"===this.opt.labelStyle){M=v;var F=this.opt.omitLabels,j=[];b.forEach(function(t,e){t=this._getSliceValueAt(b,e,l);var n=i(M,t,e+1===b.length),a=(M+n)/2;j.push({angle:a,left:Math.cos(a)<0,theme:T[e],index:e,omit:!!F&&n-M<.001}),M=n+L},this),this._getProperLabelRadius(j,x[0].box.h,1.1*g);for(var B=0;B<j.length;B++){var G=j[B],O=x[B];if(!G.omit){var W=A.cx-p,H=A.cx+p,V=O.box.w+5,C=A.cx+G.labelR*Math.cos(G.angle),Y=A.cy+G.labelR*Math.sin(G.angle),z=G.left?W+V:H-V,N=G.left?W:z+5,q=a.createPath().moveTo(A.cx+g*Math.cos(G.angle),A.cy+g*Math.sin(G.angle));q.lineTo(C,Y),q.lineTo(z,Y).setStroke(G.theme.series.labelWiring),this._labelBoxes.push({x:N,y:Y-O.box.h/2,w:O.box.w,h:O.box.h,text:O.getText()})}}}this._renderLabels(a,l,t,n);var D=0;return this._eventSeries[this.run.name]=r.map(P,function(t){return t<=0?null:I[D++]}),this.dirty=!1,this._lastRenderResults=e.mixin(this._lastRenderResults,{labels:this.opt.labels,radiusInner:R,radiusOuter:_}),this._renderAdditionalElements(P,a,l,_,R,A,b),this.opt.animate&&this._renderAnimation(l,_,a,A,b),this},_renderLabels:function(t,e,n,i){this._dataLabels=[],h.fixLabelsOverlap(this._labelBoxes,n,i,this._getFixLabelsParams(),t),this._labelBoxes.forEach(function(t){t.hidden||this._dataLabels.push(this.renderLabel(t))},this)},renderLabel:function(t){var e=u.renderHTMLLabel(this.chart,t.x,t.y,t.text);return this.htmlElements.push(e),e},_getFixLabelsParams:function(){return{allowXShift:!0,allowYShift:!0,xGap:3,yGap:3,xTolerance:0,yTolerance:0}},_getStartAngle:function(t){return d.getStartAngle(t,this.startAngleOffset)},_getEndAngle:function(t){return 0},_fixSlices:function(t,e){var n=[],i=0,a=[],s=e/(2*Math.PI)+.001;t.forEach(function(t,e){if(t<s){var r=s-t;t=s,i+=r,a.push(e),n[e]=t}});var r=i/(t.length-a.length);return t.forEach(function(t,e){-1===a.indexOf(e)&&(t-=r,n[e]=t)}),n},_getSliceValueAt:function(t,e,n){return Math.max(0,t[e])*(n.series.donutArcPercent?n.series.donutArcPercent/100:1)},_preprocessParams:function(t,e,n,i,a,s,r,l){return{circle:r,r:n}},_getRYMultiplier:function(t){return Math.max(.625,t.series.donutArcPercent&&100!==t.series.donutArcPercent?(1+Math.cos(s._degToRad(360*(100-t.series.donutArcPercent)/100/2.1)))/2:1)},_renderAdditionalElements:function(t,e,n,i,a,s,r){},_getProperLabelRadius:function(t,e,n){var i,a,s=1,r=1;if(1===t.length)return void(t[0].labelR=n);for(var l=0;l<t.length;l++){var o=Math.abs(Math.sin(t[l].angle));t[l].left?s>=o&&(s=o,i=t[l]):r>=o&&(r=o,a=t[l])}i.labelR=a.labelR=n,this._calculateLabelR(i,t,e),this._calculateLabelR(a,t,e)},_calculateLabelR:function(t,e,n){for(var i,a=t.index,s=e.length,r=t.labelR;!(e[a%s].left^e[(a+1)%s].left);)e[(a+1)%s].omit||(i=(Math.sin(e[a%s].angle)*r+(e[a%s].left?-n:n))/Math.sin(e[(a+1)%s].angle),r=i<t.labelR?t.labelR:i,e[(a+1)%s].labelR=r),a++;a=t.index;for(var l=0===a?s-1:a-1;!(e[a].left^e[l].left);)e[l].omit||(i=(Math.sin(e[a].angle)*r+(e[a].left?n:-n))/Math.sin(e[l].angle),r=i<t.labelR?t.labelR:i,e[l].labelR=r),a--,l--,a=a<0?a+e.length:a,l=l<0?l+e.length:l}})});