// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/declare","dojox/charting/plot2d/Base","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils","./animation/_RingAnimation","./labelsRendering/LabelsUtil"],function(t,e,n,i,s,r,a,o,h,l){var u={createPath:function(t,e,n,i,s,r,a,o,h){var l=function(o){var h={cx:n.cx,cy:n.cy,r:e},l=t.createCircle(h).setStroke({color:a.series.ringBackgroundColor||"#DDDDDD",width:r}),u=i+2*o*Math.PI,c=n.cx+e*Math.cos(i),d=n.cy+e*Math.sin(i),f=n.cx+e*Math.cos(u),p=n.cy+e*Math.sin(u);return{shape:t.createPath().moveTo(c,d).arcTo(e,e,0,o>.5,!0,f,p).setStroke({color:s,width:r}),bgShape:l,end:u,ac:h}};return h.push({sliceIndex:o,func:l}),l}};return e([n,i,h],{_animationInfos:null,defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelOffset:20,labelStyle:"default",radGrad:"native",fanSize:5,startAngle:0,animate:null},optionalParams:{radius:0,omitLabels:!1,labelFunc:null,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:"",labelWiring:{}},_lastRenderResults:null,constructor:function(e,n){this.opt=t.clone(this.defaultParams),o.updateWithObject(this.opt,n),o.updateWithPattern(this.opt,n,this.optionalParams),this.axes=[],this.run=null,this.dyn=[],this.runFilter=[]},clear:function(){return this.inherited(arguments),this.dyn=[],this.run=null,this},setAxis:function(t){return this},addSeries:function(t){return this.run=t,this},getSeriesStats:function(){return t.delegate(s.defaultStats)},getRequiredColors:function(){return this.run?this.run.data.length:0},getRenderResults:function(){return this._lastRenderResults},render:function(t,e){if(!this.dirty)return this;this.resetEvents(),this.dirty=!1,this._eventSeries={},this.cleanGroup();var n=this.group,i=this.chart.theme;if(!this.run||!this.run.data.length)return this;var s,o,h,c=(t.width-e.l-e.r)/2,d=(t.height-e.t-e.b)/2,f=Math.min(c,d),p=("font"in this.opt?this.opt.font:i.series.dataLabelsFont,r._degToRad(90)),x=this.events(),m=this.run.data.map(function(t,e){return"number"!=typeof t&&t.hidden&&(this.runFilter.push(e),t.hidden=!1),this.runFilter.some(function(t){return t===e})?"number"==typeof t?0:{y:0,text:t.text}:t},this);this.dyn=[],"radius"in this.opt&&(f=this.opt.radius);var b={cx:e.l+c,cy:e.t+d,r:f};if(s=a.map(m,"x ? Math.max(x.y, 0) : 0"),a.every(s,"<= 0"))return n.createCircle(b).setStroke(i.series.stroke),this.dyn=s.map(function(){return{}}),this;o=a.map(s,"/this",a.foldl(s,"+",0)),this.opt.labels&&(h=o.map(function(t,e){return l.getLabelInfo(this,m[e],i,{forceOneLine:!0,minSpace:20})},this));var y=a.map(m,function(t,e){var n=[this.opt,this.run];return null!=t&&"number"!=typeof t&&n.push(t),this.opt.styleFunc&&n.push(this.opt.styleFunc(t)),i.next("slice",n,!0)},this),v=0;if(this.opt.labels){h.forEach(function(t){v=Math.max(v,t.box.w)});var g=b.cx+f+v+e.r-t.width;if(g>0){var L=b.cx-f;if(L>g)b.cx-=g;else{var _=(g-L)/2;b.cx-=L+_,f-=_}}}var S=2*f+v;b.cx-=b.cx-f-(t.width-S)/2;var P=new Array(o.length),w=Math.min(f/10,.5*f/o.length),M=f;f-=w/2;var R=[],k=[];this._animationInfos=[],o.some(function(t,e){t=Math.max(t,.001);var s,r,a=m[e],o=y[e];s=o.series.fill;var h=u.createPath(n,f,b,p,s,w,o,e,this._animationInfos)(t);return shape=h.shape,i.series.isEditMode&&(shape.rawNode.style.cursor="pointer"),k.push(h.ac),this.dyn.push({fill:s,stroke:o.series.stroke}),x&&(r={element:"slice",index:e,run:this.run,shape:shape,x:e,y:"number"==typeof a?a:a.y,cx:b.cx,cy:b.cy,cr:f},this._connectEvents(r),P[e]=r),R.push({x:b.cx,y:b.cy+f}),f-=w+3,!1},this),this.opt.labels&&(R.forEach(function(t,e){var s=h[e];n.createPath().moveTo(t.x-5,t.y).lineTo(t.x+M-5,t.y).setStroke(i.series.labelWiring);this.renderLabel({x:t.x+M,y:t.y-s.box.h/2,text:s.getText({forceOneLine:!0,spaceToWidth:v})})},this),i.series.show100PercentLabel&&this._show100PercentLabel(i,f,b));var j=0;return this._eventSeries[this.run.name]=a.map(m,function(t){return t<=0?null:P[j++]}),this._lastRenderResults={labels:this.opt.labels,slicePies:k,maxLabelWidth:v},this.opt.animate&&this._renderAnimation(n,o),this},_show100PercentLabel:function(t,e,n){var i=l.getSimpleLabelInfo({text:"100%",font:t.series.dataLabelsFont,fontSize:Math.min(50,.6*e),fontColor:t.series.dataLabelsColor});this.renderLabel({x:n.cx-i.box.w/2,y:n.cy-i.box.h/2,text:i.text}).style.opacity="0.5"},renderLabel:function(t){var e=l.renderHTMLLabel(this.chart,t.x,t.y,t.text);return this.htmlElements.push(e),e}})});