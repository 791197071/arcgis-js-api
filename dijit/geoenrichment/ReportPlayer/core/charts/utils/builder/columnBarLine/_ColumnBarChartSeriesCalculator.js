// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartSorting","../../ChartLineStyles","../../../../supportClasses/conditionalStyling/ConditionalStyleUtil","../utils/ChartDataUtil","../utils/TooltipInfoBuilder","./_ComparisonUtil","./_AxisBuilder","./_PointLabelUtil","esri/dijit/geoenrichment/utils/ColorUtil"],function(e,a,i,t,n,s,r,o,l,u,c){var m={calcLineStyle:function(e,a){return{color:c.getColorWithAlpha(a.columnBarLineColor||e,a.columnBarLineOpacity),width:a.columnBarLineThickness,style:t.toGFXValue(a.columnBarLineStyle||t.SOLID)}}};return{calcSeriesColumnBar:function(t){var s=t.chart,h=t.visualProperties,d=t.seriesItems,S=1===d.length,p=t.seriesItemsWithComparison||d,g=t.chartType,I=t.comparisonInfo,v=t.themeSettings,V=t.viewModel,f=1===p.length&&t.sorting,y=p.length>1&&h.renderColumnBarsInOppositeDirections,x=[],C={minYValue:1/0,maxYValue:-1/0,stackedValues:h.isStacked?[]:null};u.createPointToLabelMap(s);var b={};return p.forEach(function(e,l){if(e.points.length){var d={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:e.isComparisonSeries&&o.getComparisonPlotName(g,I)||void 0}},A=this._collectStatisticsForSeries(t,e,l,C);a.provideMissingIconsForPoints(e.points,g);var M=[];e.points.forEach(function(i,s){var o,f=A.values[s],x=f||0,C=s+1;if(h.conditionalStyling){var T=n.getConditionalStyle(x,h.conditionalStyling);o=T&&T.backgroundColor}i.hidden&&(o="transparent"),o=o||a.calcColorForPoint({point:i,seriesItem:e,pointIndex:s,seriesIndex:l,numSeries:S?1:p.length,chartType:g,themeSettings:v,isComparisonSeries:e.isComparisonSeries,comparisonInfo:I,isMultiFeature:t.isMultiFeatureChart});var F=r.getTooltipInfo({yValue:f,pointLabel:u.getPointLabel(i,V),seriesLabel:e.label,minInSeriesValue:A.minInSeries,maxInSeriesValue:A.maxInSeries,sumInSeriesValue:A.valuesSum,absSumInSeriesValue:A.absValuesSum,avgInSeriesValue:A.avgInSeries,minInAreasValue:A.minInSeries,maxInAreasValue:A.maxInSeries,sumInAreasValue:A.valuesSum,absSumInAreasValue:A.absValuesSum,avgInAreasValue:A.avgInSeries,visualProperties:h,chartType:g,isMultiFeature:t.isMultiFeatureChart,color:o,conditionalStyling:h.conditionalStyling,fieldInfo:i.fieldInfo,isThisAreaSpecific:I&&!t.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:S,decimals:i.value&&i.value.decimals}),P=b[C]=b[C]||[];P.push(F),M.push(F),F.getGroup=function(){return t.isMultiFeatureChart?M:P};var k=m.calcLineStyle(o,h);i.hidden&&(k.color="transparent");var L={x:C,y:x*function(){return y&&l>=p.length/2?-1:1}(),originalValue:f,isUnavailableData:isNaN(f),valueProp:"y",unsortedIndex:s,seriesIndex:l,name:u.getPointLabel(i,V),valuesSumsInSeries:A.absValuesSum,point:i,fill:h.columnBarOpacity<1?c.getColorWithAlpha(o,h.columnBarOpacity):o,tooltip:F,icon:a.calcIconForPoint(i,o,g),bgIcon:a.calcBackgroundIconForPoint(i,g,v,h),stroke:{color:k.color,width:k.width,style:k.style}};h.yAxis.showValuesAsWeightsInSeries&&(L.y/=A.absValuesSum/100),d.data.push(L)}),f&&f!==i.NONE&&(d.data.sort(function(e,a){return(e.y-a.y)*(f===i.DESC?-1:1)}),d.data.forEach(function(e,a){var i=a+1;e.x=i})),d.data.forEach(function(e){u.updatePointIndexToLabelMap(s,e.x,l,e.point,V)}),x.push(d)}},this),C.stackedValues&&(C.stackedValues.sort(function(e,a){return a-e}),C.minYValue=C.stackedValues[C.stackedValues.length-1],C.maxYValue=C.stackedValues[0]),l.prettifyYAxis(C.minYValue,C.maxYValue,s,h,g,v,V,x),t.plotStats&&(e.mixin(t.plotStats,C),t.plotStats.pointIndexToTooltipsHash=b),x},_collectStatisticsForSeries:function(e,a,i,t){var r=e.visualProperties,o=e.viewModel,l=e.seriesItems,u=e.currentFeatureIndex,c=e.isMultiFeatureChart,m=e.excludedSeriesHash&&e.excludedSeriesHash[a.label],h=e.comparisonFeatureAttributes,d=e.chartType,S=l.length>1&&r.renderColumnBarsInOppositeDirections,p=2===l.length&&S?s.CHART_DATA_SMOOTH:null;if(r.conditionalStyling){var g=n.getStatistics(r.conditionalStyling);g&&l.length&&(p=s.getChartData(g,l[0].points.length,p,!1))}var I=[],v=0,V=0,f=1e6,y=-1e6;a.points.forEach(function(e,t){var n=e.hidden?void 0:s.getPointValue({point:e,index:t,seriesIndex:i,maxValue:!1,chartType:d,visualProperties:r,viewModel:o,currentFeatureIndex:c?t:u,chartData:p,isComparisonSeries:a.isComparisonSeries,comparisonFeatureAttribute:h&&h[0],allowNegativeValuesInPreview:!1});I[t]=n,n=n||0,m||e.hidden||(v+=n,V+=Math.abs(n),f=Math.min(f,n),y=Math.max(y,n))});var x=0;return m||a.points.forEach(function(e,a){if(!e.hidden){x++;var i=I[a],i=r.yAxis.showValuesAsWeightsInSeries?i/V*100:i;t.stackedValues?(t.stackedValues[a]=t.stackedValues[a]||0,t.stackedValues[a]+=i):(t.minYValue=Math.min(i,t.minYValue),t.maxYValue=Math.max(i,t.maxYValue))}}),{values:I,valuesSum:v,absValuesSum:V,minInSeries:f,maxInSeries:y,avgInSeries:v/x}},prettifyColumnBarYAxis:function(e){l.prettifyYAxis(e.totalStat.minYValue,e.totalStat.maxYValue,e.chart,e.visualProperties,e.chartType,e.themeSettings,e.viewModel,e.chartSeries,!0,e.chartSize),e.chart.dirty=!0}}});