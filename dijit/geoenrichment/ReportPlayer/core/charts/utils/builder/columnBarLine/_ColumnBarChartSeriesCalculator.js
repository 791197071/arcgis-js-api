// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartSorting","../../ChartLineStyles","../../../../supportClasses/conditionalStyling/ConditionalStyleUtil","../utils/TooltipInfoBuilder","./_ComparisonUtil","./_AxisBuilder","./_PointLabelUtil","./_StatsBuilder","esri/dijit/geoenrichment/utils/ColorUtil"],function(e,i,t,a,n,r,s,o,l,u,c){var h={calcLineStyle:function(e,i){return{color:c.getColorWithAlpha(i.outlineColor||e,i.outlineOpacity),width:i.outlineThickness,style:a.toGFXValue(i.outlineStyle||a.SOLID)}}};return{calcSeriesColumnBar:function(a){var S=a.chart,d=a.visualProperties,p=a.seriesItems,m=1===p.length,I=a.seriesItemsWithComparison||p,g=a.chartType,v=a.comparisonInfo,f=a.themeSettings,y=a.viewModel,C=1===I.length&&a.sorting,x=I.length>1&&d.renderColumnBarsInOppositeDirections,V=[],k=new u({visualProperties:d,seriesItems:I,viewModel:y,currentFeatureIndex:a.currentFeatureIndex,isMultiFeatureChart:a.isMultiFeatureChart,excludedSeriesHash:a.excludedSeriesHash,comparisonFeatureAttributes:a.comparisonFeatureAttributes,chartType:g});l.createPointToLabelMap(S);var b={};I.forEach(function(e,o){if(e.points.length){var u={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:e.isComparisonSeries&&s.getComparisonPlotName(g,v)||void 0}},p=k.gettatisticsForSeriesAt(o);i.provideMissingIconsForPoints(e.points,g);var A=[];e.points.forEach(function(t,s){var S,C=p.values[s],V=C.value,k=V||0;if(d.conditionalStyling){var w=n.getConditionalStyle(C.isBenchmarked?C.ownValue:k,d.conditionalStyling);S=w&&w.backgroundColor}S=S||i.calcColorForPoint({point:t,seriesItem:e,pointIndex:s,seriesIndex:o,numSeries:m?1:I.length,chartType:g,themeSettings:f,isComparisonSeries:e.isComparisonSeries,comparisonInfo:v,isMultiFeature:a.isMultiFeatureChart});var F=h.calcLineStyle(S,d),P=S;S=d.columnBarOpacity<1?c.getColorWithAlpha(S,d.columnBarOpacity):S;var T;t.hidden&&(T=S,S=P="transparent");var B;t.hidden&&(B=F.color,F.color="transparent");var M=s+1,L={x:M,y:k*function(){return x&&o>=I.length/2?-1:1}(),originalValue:V,isUnavailableData:isNaN(V),valueProp:"y",unsortedIndex:s,originalIndex:t.originalIndex||s,seriesIndex:o,name:l.getPointLabel(t,y),valuesSumsInSeries:p.absSumInSeries,point:t,fill:S,icon:i.calcIconForPoint(t,P,g),bgIcon:i.calcBackgroundIconForPoint(t,g,f,d),stroke:{color:F.color,width:F.width,style:F.style},unhiddenFillColor:T,unhiddenLineColor:B,isBenchmarked:C.isBenchmarked,unbenchmarkedValue:C.ownValue};if(d.isStacked){var W=d.showValuesAsWeightInStack?p.stackValuesAsWeighedPercents:p.stackValues;L.stackValues=W&&W[s]}d.showValuesAsWeightInStack?L.y=p.weightsInStack?100*p.weightsInStack[s]:0:d.yAxis.showValuesAsWeightsInSeries&&(L.y/=p.absSumInSeries/100);var Y=r.getTooltipInfo({yValue:V,pointLabel:l.getPointLabel(I[0].points[s]||t,y),seriesLabel:e.label,isSinglePointInSeries:1===e.points.length,minInSeriesValue:p.minInSeries,maxInSeriesValue:p.maxInSeries,sumInSeriesValue:p.sumInSeries,absSumInSeriesValue:p.absSumInSeries,avgInSeriesValue:p.avgInSeries,weightInStack:p.weightsInStack&&p.weightsInStack[s],minInAreasValue:p.minInSeries,maxInAreasValue:p.maxInSeries,sumInAreasValue:p.sumInSeries,absSumInAreasValue:p.absSumInSeries,avgInAreasValue:p.avgInSeries,visualProperties:d,chartType:g,isMultiFeature:a.isMultiFeatureChart,conditionalStyling:d.conditionalStyling,fieldInfo:t.fieldInfo,isThisAreaSpecific:v&&!a.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:m,decimals:t.value&&t.value.decimals,fill:L.fill,stroke:L.stroke.width>0?L.stroke.color:void 0,isBenchmarked:C.isBenchmarked,unbenchmarkedValue:C.ownValue}),E=b[M]=b[M]||[];a.excludedSeriesHash[e.label]||(E.push(Y),A.push(Y)),Y.getGroup=function(){return a.isMultiFeatureChart?A:E},L.tooltip=Y,u.data.push(L)}),C&&C!==t.NONE&&(u.data.sort(function(e,i){return(e.y-i.y)*(C===t.DESC?-1:1)}),u.data.forEach(function(e,i){var t=i+1;e.x=t})),u.data.forEach(function(e){l.updatePointIndexToLabelMap(S,e.x,o,e.point,y)}),V.push(u)}},this);var A=k.getTotalStats();return o.prettifyYAxis(A.minYValue,A.maxYValue,S,d,g,f,y,V),a.plotStats&&(e.mixin(a.plotStats,A),a.plotStats.pointIndexToTooltipsHash=b),V},prettifyColumnBarYAxis:function(e){o.prettifyYAxis(e.totalStat.minYValue,e.totalStat.maxYValue,e.chart,e.visualProperties,e.chartType,e.themeSettings,e.viewModel,e.chartSeries,!0,e.chartSize),e.chart.dirty=!0}}});