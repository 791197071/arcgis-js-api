// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartTypes","../../ChartLineStyles","../../ChartLineMarkers","../../AxisUtil","../utils/TooltipInfoBuilder","../ChartPlots","esri/dijit/geoenrichment/utils/ColorUtil","./_AxisBuilder","./_PointLabelUtil","./_StatsBuilder"],function(e,r,i,a,t,l,n,s,o,u,m,p){var c={calcLineStyle:function(e,l,n,s){var u=s.comparisonInfo,m=s.themeSettings,p=s.visualProperties,c=e.lineThickness||p.lineThickness||1,S=1,h=1,k=1;p.fillLineArea?(S="number"==typeof p.lineOpacity?p.lineOpacity:p.lineAreaOpacity,h=p.lineAreaOpacity):"number"==typeof p.lineOpacity&&(S=p.lineOpacity);var d=r.calcColorForPoint({point:null,seriesItem:e,pointIndex:0,seriesIndex:l,numSeries:n.length,chartType:i.LINE,themeSettings:m,isComparisonSeries:e.isComparisonSeries,comparisonInfo:u,isMultiFeature:s.isMultiFeatureChart});if(S<1&&d){var d=o.toColor(d);d.a=S}var y,I,C,f,M=e.lineStyle||a.SOLID,g=e.lineMarkerSize,x=o.toColor(e.fillColor||d);return x.a=h,C=o.toColor(e.lineMarkerColor||d),C.a=S,k="number"==typeof p.lineMarkersFillOpacity?p.lineMarkersFillOpacity:h,f=o.toColor(e.lineMarkerFillColor||x),f.a=k,e.isComparisonSeries&&u?(u.lineThickness&&(c=u.lineThickness),u.lineStyle&&(M=u.lineStyle),u.lineMarkerSize&&(g=u.lineMarkerSize),u.lineMarker?(I=t.getMarkerPath(u.lineMarker),y=t.getMarkerPath(u.lineMarker,g)):(I=r.getComparisonSymbol(),y=r.getComparisonSymbol(g)),u.lineMarkerColor&&(C=o.toColor(u.lineMarkerColor),C.a=S),u.lineMarkerFillColor&&(f=o.toColor(u.lineMarkerFillColor),f.a=h)):s.viewModel.isGraphicStyle&&(I=e.lineMarker&&t.getMarkerPath(e.lineMarker)||t.getMarkerPathAt(l),y=e.lineMarker&&t.getMarkerPath(e.lineMarker,g)||t.getMarkerPathAt(l,g)),{lineColor:d,width:c,style:a.toGFXValue(M),marker:y,unscaledMarker:I,markerColor:C,markerFillColor:f,fillColor:x}}};return{calcSeriesLine:function(r){function t(e){return e}var o=r.chart,S=r.chartType,h=r.visualProperties,k=r.seriesItems,d=1===k.length,y=r.seriesItemsWithComparison||k,I=r.isSecondaryPlot,C=r.reverseXY||S===i.VERTICAL_LINE,f=r.comparisonInfo,M=r.themeSettings,g=r.viewModel,x=[],v=new p({visualProperties:h,seriesItems:y,viewModel:g,currentFeatureIndex:r.currentFeatureIndex,isMultiFeatureChart:r.isMultiFeatureChart,comparisonFeatureAttributes:r.comparisonFeatureAttributes,chartType:S,isSecondaryPlot:I,oppositeDirections:r.oppositeDirections,excludedSeriesHash:r.excludedSeriesHash}),V=r.primaryPlotStat&&r.primaryPlotStat.pointIndexToTooltipsHash||{},P=v.getTotalStats();if(y.forEach(function(e,i){if(e.points.length){var l=c.calcLineStyle(e,t(i),y,r),u={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:I?s.SECONDARY:void 0,fill:h.fillLineArea?l.fillColor:"transparent",stroke:{color:l.lineColor,width:l.width,style:l.style},marker:l.marker,unscaledMarker:l.unscaledMarker,markerStroke:{color:l.markerColor,width:l.width,style:a.toGFXValue(a.SOLID)},markerFill:h.fillLineMarkers?l.markerFillColor:"transparent",outline:!1}},p=v.gettatisticsForSeriesAt(t(i));e.points.forEach(function(a,t){function l(){return I&&r.oppositeDirections&&1===i?-1:1}function s(){return I&&!r.oppositeDirections&&2===r.primarySeries.length?0===i?-.15:.15:0}if(!a.hidden){var c=p.values[t],k=c.value,M=k||0,x=t+1;I||m.updatePointIndexToLabelMap(o,x,i,a,g);var v=r.isMultiFeatureChart&&P.crossSeriesStats[t],b={originalValue:k,isUnavailableData:isNaN(k),unsortedIndex:t,originalIndex:a.originalIndex||t,name:m.getPointLabel(a,g),valuesSumsInSeries:p.absSumInSeries,seriesItem:e,seriesIndex:i,point:a,isBenchmarked:c.isBenchmarked,unbenchmarkedValue:c.ownValue};C?(b.x=M*l(),b.y=x+s(),b.valueProp="x"):(b.x=x+s(),b.y=M*l(),b.valueProp="y"),h.showValuesAsWeightInStack?b[C?"x":"y"]=p.weightsInStack?100*p.weightsInStack[t]:0:h.yAxis.showValuesAsWeightsInSeries&&(b[C?"x":"y"]/=p.absSumInSeries/100);var A=n.getTooltipInfo({yValue:k,pointLabel:m.getPointLabel(y[0].points[t]||a,g),seriesLabel:e.label,minInSeriesValue:p.minInSeries,maxInSeriesValue:p.maxInSeries,sumInSeriesValue:p.sumInSeries,absSumInSeriesValue:p.absSumInSeries,avgInSeriesValue:p.avgInSeries,weightInStack:p.weightsInStack&&p.weightsInStack[t],minInAreasValue:v&&v.min,maxInAreasValue:v&&v.max,sumInAreasValue:v&&v.sum,absSumInAreasValue:v&&v.absSum,avgInAreasValue:v&&v.avg,visualProperties:h,chartType:S,isMultiFeature:r.isMultiFeatureChart,conditionalStyling:null,fieldInfo:a.fieldInfo,isThisAreaSpecific:f&&!r.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:d,decimals:a.value&&a.value.decimals,fill:u.params.markerFill,stroke:u.params.markerStroke.color,marker:u.params.unscaledMarker||u.params.marker,isBenchmarked:c.isBenchmarked,unbenchmarkedValue:c.ownValue}),F=V[x]=V[x]||[];F.push(A),A.getGroup=function(){return F},b.tooltip=A,u.data.push(b)}}),x.push(u)}},this),I){if(r.primaryPlotStat){r.primaryPlotStat.minYValue=Math.min(P.minYValue,r.primaryPlotStat.minYValue),r.primaryPlotStat.maxYValue=Math.max(P.maxYValue,r.primaryPlotStat.maxYValue);var b=l.getPrettifyYAxisParameters(r.primaryPlotStat.minYValue,r.primaryPlotStat.maxYValue,{baseLineValue:h.yAxis.baseLineValue,renderColumnBarsInOppositeDirections:r.oppositeDirections,previewBelowZero:!g.dynamicReportInfo,nonZeroInclusive:h.yAxis.nonZeroInclusive});e.mixin(o.axes.y.opt,{majorTickStep:b.majorTickStep,minorTickStep:b.minorTickStep,min:b.min,max:b.max})}if(1===r.primarySeries.length){var A=C?"y":"x",F=[];r.primarySeries[0].data.forEach(function(e){var r=x[0].data[e.unsortedIndex];r[A]=e.x,F.push(r)}),x[0].data=F}}else u.prettifyYAxis(P.minYValue,P.maxYValue,o,h,S,M,g);return x}}});