// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dijit/Destroyable","esri/dijit/geoenrichment/ReportPlayer/config","../../supportClasses/tableJson/TableJsonUtil","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","../../sections/sectionUtils/SectionJsonUtil","../utils/builder/utils/ChartDataUtil","../utils/ChartTypes","../../grid/coreUtils/GridDataUtil","dojo/i18n!esri/nls/jsapi"],function(e,t,a,i,n,o,r,l,s,u,c){c=c.geoenrichment.dijit.ReportPlayer.ChartContainer;var d=/_P$/i,h={buildSectionJsonFromSeriesItems:function(e,a,o,h,f,m,b,v){function g(e){function t(){return o[e-1].name||""}return 0===e?h.xAxis&&h.xAxis.title||"":1===e?f?a||o.length>2?t():c.thisArea:o.length>1?t():h.yAxis&&h.yAxis.title||"":e===C?c.total:e===V?c.average:t()}function w(e){if(0!==e)return e===y?c.total:e===A?c.average:o[0].data[e-1].name||""}function S(e,t,a){var n,r,s=o[e-1]&&o[e-1].data[t-1],u=s||I,f=u&&u.point.fieldInfo&&d.test(u.point.fieldInfo.name);if(s&&s.isUnavailableData&&(n=0,r=i.tables.showUnavailableData?c.unavailableDataShort:""),n=void 0!==a?a:s&&s.originalValue,r=void 0!==r?r:void 0!==n?l.formatNumber(n,h,f):"",s&&r&&s.isBenchmarked&&!s.isUnavailableData){r=l.formatNumber(s.unbenchmarkedValue,h,f)+" ("+(n>0?"+":"")+r+")"}return{value:n||0,formattedValue:r||""}}function _(e,t){return t+";"+e}if(o=o.map(function(e){return e=t.mixin({},e),e.data=e.data.slice(),e.data.sort(function(e,t){return e.unsortedIndex-t.unsortedIndex}),e}),a&&s.isColumnBarLike(e)){var p=[];o[0].data.forEach(function(e,a){p.push({name:e.name,data:o.map(function(e){var i=e.data[a];return t.mixin({},i,{name:e.name})})})}),o=p}var y=-1,A=-1,C=-1,V=-1,T=o[0].data.length+1,F=T;v.showTotalsBelow&&(y=T++),v.showAvgBelow&&(A=T++);var M=o.length+1,B=M;v.showTotalsAfter&&(C=M++),v.showAvgAfter&&(V=M++);var x=b/T-2,D=n.createTable({numColumns:M,numRows:T,width:m,height:b,processTableCell:function(e,t,a,i,n){e.style.fields[t].verticalAlign="middle",e.style.fields[t].horizontalPadding=5,e.style.fields[t].fontSize=Math.round(Math.min(x,15-4*T/50))}}),I=o[0]&&o[0].data[0],j={cache:{},totalsBelow:{},avgsBelow:{},totalsAfter:{},avgsAfter:{}};D.data.data.forEach(function(e,t){D.data.columns.forEach(function(e,a){j.cache[_(a,t)]=S(a,t)})});for(var U=0;U<F;U++){j.totalsAfter[U]=0;for(var E=0;E<B;E++)j.totalsAfter[U]+=j.cache[_(E,U)].value;j.avgsAfter[U]=j.totalsAfter[U]/(B-1)}for(var E=0;E<B;E++){j.totalsBelow[E]=0;for(var U=0;U<F;U++)j.totalsBelow[E]+=j.cache[_(E,U)].value;j.avgsBelow[E]=j.totalsBelow[E]/(F-1)}return D.data.data.forEach(function(e,t){D.data.columns.forEach(function(a,i){if(0===t)return void(e[a.field]=g(i));if(0===i)return void(e[a.field]=w(t));var n;n=i===C?S(i,t,j.totalsAfter[t]):i===V?S(i,t,j.avgsAfter[t]):t===y?S(i,t,j.totalsBelow[i]):t===A?S(i,t,j.avgsBelow[i]):j.cache[_(i,t)],u.setNumericDataValue(n.value,e,a.field),e[a.field]=n.formattedValue})}),{sectionJson:r.wrapInDetailsSectionJson(D),numberFormatFunction:function(e,t){return S(t.column.index,t.gridData.index,e).formattedValue}}}};return e(a,{_tableSection:null,_sorting:null,renderTableForChart:function(e){var t=this;if(this._destroyTable(),e.chartSeries&&e.chartSeries.length){var a={};a.class="chartContainer_tableSection",a.initialWidth=e.width,a.initialHeight=e.height;var i=h.buildSectionJsonFromSeriesItems(e.chartType,e.isMultiFeatureChart,e.chartSeries,e.visualProperties,e.hasComparison,e.width,e.height,e.tableViewInfo);a.json=i.sectionJson;var n=e.viewModel.getDocumentDefaultStyles(e.theme);n.backgroundImage&&n.backgroundImage.data&&(a.json.style={backgroundColor:n.backgroundColor}),e.showAnimation||(i.numberFormatFunction=null),a.viewModel=e.viewModel,a.theme=e.theme,a.tableClass="chartContainerChartTable",a.parentWidget=e.parentWidget,a.initialViewMode=this._viewMode||o.PREVIEW_VALUES,a.tableParams={enableNumberAnimation:e.showAnimation,_postCreateFieldCell:function(e){if(i.numberFormatFunction){var t=i.numberFormatFunction;e.setNumberValue(u.getNumericCellValue(e),function(a){return t(a,e)},!0),setTimeout(function(){i.numberFormatFunction=null})}},onSortingChanged:function(e){t._sorting=e}},this._tableSection=e.viewModel.layoutBuilder.createElement("section",a,e.tableNode),this._tableSection.getTables()[0].setSorting(this._sorting)}},_viewMode:null,setViewMode:function(e){this._viewMode!==e&&(this._viewMode=e,this._tableSection&&this._tableSection.setViewMode(e))},getVisualState:function(){return{type:"tableViewRenderer",tableSection:this._tableSection&&this._tableSection.getVisualState()}},setVisualState:function(e){return e&&e.tableSection&&this._tableSection&&this._tableSection.setVisualState(e.tableSection)},destroyTable:function(){this._destroyTable()},_destroyTable:function(){this._tableSection&&this._tableSection.destroy(),this._tableSection=null},destroy:function(){this._destroyTable(),this.inherited(arguments)}})});