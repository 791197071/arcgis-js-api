// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/_base/lang","../../supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","../../sections/sectionUtils/SectionJsonUtil","../../supportClasses/tableJson/TableJsonUtil","../../infographics/InfographicTypes","../../infographics/utils/InfographicJsonConversionUtil","../../infographics/utils/InfographicLayoutResizer","../../infographics/utils/InfographicVariableLayoutUtil","../../infographics/utils/InfographicThemeUtil","../../grid/coreUtils/GridDataUtil"],function(e,t,a,n,o,i,r,s,l,c){function f(t){var a=e.mixin({},t.getComparisonSettings());return a.preserveRelativeSize=!1,a.equalizeVariableText=a.splitPanels,a.equalizeDescriptionText=a.splitPanels,a.equalizeLayout=a.splitPanels,a.splitPanels?(a.spaceOutFactor=null,a.scale=a.scaleSplit):(a.spaceOutFactor=1/a.scale,a.scale=null),a}var h={};return h.getProcessor=function(t){return function(n){var i=f(t);return n=h._filterSectionJsons(n,t.viewModel),n=n.map(function(t){var n=a.getSectionJsonInfographic(t);return n&&n.type===o.STATIC?e.clone(t):t}),i.spaceOutFactor&&1!==i.spaceOutFactor&&h._spaceOutSectionJsons(n,i),i.splitPanels&&(n=h._splitSectionJsons(n)),n=h._equalizeSectionJsons(n,i,t.viewModel),i.hideBackgroundImage&&(n=h._hideBackgroundElements(n)),i.scale&&1!==i.scale&&(n=h._zoomOutSectionJsons(n,i)),n}},h._filterSectionJsons=function(e,a){return e.filter(function(e){if(e.stack&&e.stack.some(function(e){return e.isMap}))return!0;var n=!1;return t.processSectionFieldInfos(e,function(e){n=h._isComparableFieldInfo(e,a)||n}),n})},h._isComparableFieldInfo=function(e,t){return!!e.isChart||(e.isInfographic?e.infographicJson.type!==o.ATTACHMENTS&&(e.infographicJson.type!==o.AREA_DETAILS||t.dynamicReportInfo.attachmentsStore&&t.dynamicReportInfo.attachmentsStore.supportsMultipleAreas):!!e.isMap||!!e.hasVariable)},h._spaceOutSectionJsons=function(e,n){e.forEach(function(e){var i=a.getSectionJsonInfographic(e);if(i&&i.type===o.STATIC&&!(i.variableTables.length<2)){var r=n.spaceOutFactor,s=i.style.width,l=s*r,c=(l-s)/2;i.header&&(i.header.data.columns[0].style.width="100%",i.header.style.left=-c,i.header.style.width=l),i.variableTables.forEach(function(e){var t=(e.style.width*r-e.style.width)/2;e.style.left=e.style.left*r-c+t});var f=t.getParentBox(e);h._applyParentBoxWidth(e,f.w*r)}})},h._splitSectionJsons=function(s){var l=[];return s.forEach(function(s){var f=a.getSectionJsonInfographic(s);if(!f||f.type!==o.STATIC)return void l.push(s);var h=f.variableTables;if(f.header){var u=f.header;if(u.data.data[0][u.data.columns[0].field]||u.data.data[0].fieldInfos&&u.data.data[0].fieldInfos[u.data.columns[0].field]){var p=e.clone(s);f=a.getSectionJsonInfographic(p),f.variableTables=[];var g=n.calcTableBox(f.header),v=t.getParentBox(p);v.y+=g.y,v.h=g.h,t.setParentBox(p,v),l.push(p)}}h.forEach(function(n,o){var f=e.clone(s),h=a.getSectionJsonInfographicTable(f),u=a.getSectionJsonInfographic(f);delete u.header,u.variableTables=[u.variableTables[o]];var p=u.variableTables[0],g=i.variableTableToNormalTables(p),v=a.wrapInDetailsSectionJson(g.tableJsons);v.style=p.style;var y,d=a.calcSectionJsonBox(v),S=p.variable.style.horizontalAlign||"left";y=g.isVariableInShape||"left"===S?2*p.variable.style.width:p.variable.style.width;var b=d.contentW+y,x=Math.min(1.75,b/d.contentW);c.isNumericVariableFieldCell(p.variable.fieldInfo)||(x=1);var m=d.x+d.contentLeft,T=d.y+d.contentTop,B=h.style.left+m-d.contentW*(x-1)/2,I=h.style.top+T;h.style.left=0,h.style.top=0,p.style.left=d.contentW*(x-1)/2,p.style.top=0,r.VARIABLE_TABLE_ELEMENTS.forEach(function(e){p[e]&&(p[e].style.left-=d.contentLeft,p[e].style.top-=d.contentTop)}),f.stack.filter(function(e){return e!==h}).forEach(function(e){e.style.left-=B,e.style.top-=I});var J=t.getParentBox(f);J.x+=B,J.y+=I,J.w=d.contentW*x,J.h=d.contentH,t.setParentBox(f,J),l.push(f)})}),l},h._zoomOutSectionJsons=function(e,n){return e.map(function(e){var i=a.getSectionJsonInfographic(e);if(i&&i.type===o.STATIC){var r=t.getParentBox(e);return h._applyParentBoxWidth(e,r.w/n.scale),e}return e})},h._equalizeSectionJsons=function(e,t,n){var i=[],r=[],s=e.map(function(e){var n=a.getSectionJsonInfographic(e);return n&&n.type===o.STATIC?t.splitPanels?(n.header?i.push(e):r.push(e),e):(r.push(e),e):e});return t.preserveRelativeSize&&(h._equalizeBox(i),h._equalizeBox(r)),t.equalizeVariableText&&(h._equalizeVariableAndHeaderText(i,n,!0),h._equalizeVariableAndHeaderText(r,n,!1)),t.equalizeDescriptionText&&h._equalizeDescriptionText(r,n),t.equalizeIcons&&h._equalizeIcons(r,n),t.equalizeLayout&&h._equalizeLayout(r,n),s},h._equalizeBox=function(e){var a=0;e.forEach(function(e){var n=t.getParentBox(e);a=Math.max(a,n.w)}),e.forEach(function(e){h._applyParentBoxWidth(e,a)})},h._equalizeVariableAndHeaderText=function(e,n,o){function i(e){return h._getFont(e,n,r,o?"header":"variable")}var r=0;e.forEach(function(e){var a=t.getParentBox(e);r=Math.max(r,a.w)});var s,l=1/0;e.forEach(function(e){var t=i(e);t&&(l=Math.min(l,t.fontSize),t.isBold||(s=!0))}),e.forEach(function(e){var n=i(e);if(n){var r=t.getParentBox(e),c=r.w*n.fontSize/l;if(h._applyParentBoxWidth(e,c),!o&&s){a.getSectionJsonInfographic(e).variableTables[0].variable.style.fontWeight="normal"}}})},h._applyParentBoxWidth=function(e,n){var o=t.getParentBox(e),i=(o.w-n)/2,r=a.getSectionJsonInfographicTable(e);r.style.left-=i,e.stack.filter(function(e){return e!==r}).forEach(function(e){e.style.left-=i}),o.x+=i,o.w=n,t.setParentBox(e,o)},h._equalizeDescriptionText=function(e,n){function o(e){return h._getFont(e,n,i,"description")}var i=0;e.forEach(function(e){var a=t.getParentBox(e);i=Math.max(i,a.w)});var r,s=1/0;e.forEach(function(e){var t=o(e);t&&(s=Math.min(s,t.fontSize),t.isBold||(r=!0))}),e.forEach(function(e){var n=a.getSectionJsonInfographic(e),o=n.variableTables[0].description;if(o){var l=t.getParentBox(e),c=l.w/i;o.style.fontSize=s*c,r&&(o.style.fontWeight="normal")}})},h._getFont=function(e,n,o,i){var r=t.getParentBox(e),s=a.getSectionJsonInfographic(e);l.applyThemeSettingsToJson(s,n.getInfographicDefaultStyles().staticInfographic);var c,f;if("header"===i){var h=s.header.data.data[0],u=s.header.data.columns[0].field;c=h.style.fields[u].fontSize||h.themeStyle&&h.themeStyle.fields[u].fontSize,f=h.style.fields[u].fontWeight||h.themeStyle&&h.themeStyle.fields[u].fontWeight}else{var p=s.variableTables[0][i];p&&(c=p.style.fontSize||p.themeStyle&&p.themeStyle.fontSize,f=p.style.fontWeight||p.themeStyle&&p.themeStyle.fontWeight)}var g=o/r.w;return c&&{fontSize:(c||0)*g,isBold:"bold"===f}},h._equalizeIcons=function(e,n){function o(e,o){if(r[o])return r[o];var l=t.getParentBox(e),c=a.getSectionJsonInfographic(e),f=c.variableTables[0].shape;if(!f||!f.shapeJson||f.shapeJson.showAsBar)return null;var h=s.getActualShapeBox(f,n);if(!h)return null;var u=i/l.w;return r[o]={areaFactor:Math.sqrt(h.w*h.h)*u}}e=e.filter(function(e){var t=a.getSectionJsonInfographic(e);return!s.isVariableInShape(t.variableTables[0])});var i=0;e.forEach(function(e){var a=t.getParentBox(e);i=Math.max(i,a.w)});var r=[],l=1/0;e.forEach(function(e,t){var a=o(e,t);a&&(l=Math.min(l,a.areaFactor))}),e.forEach(function(e,t){var n=a.getSectionJsonInfographic(e),i=n.variableTables[0].shape,r=i&&o(e,t);if(r){var s=l/r.areaFactor,c=(i.style.width-i.style.width*s)/2,f=(i.style.height-i.style.height*s)/2;i.style.width*=s,i.style.height*=s,i.style.left+=c,i.style.top+=f}})},h._equalizeLayout=function(e,n){e=e.filter(function(e){var t=a.getSectionJsonInfographic(e),n=t.variableTables[0];if(n.shape&&n.shape.shapeJson&&n.shape.shapeJson.showAsBar)return!1;var o=s.getClosestId(n,"custom");return"v1"===o||"v4"===o});var o=0;e.forEach(function(e){var a=t.getParentBox(e);o=Math.max(o,a.w)});var i=0,r=0,l=0,c=0;e.forEach(function(e,n){var f=t.getParentBox(e),h=o/f.w,u=a.getSectionJsonInfographic(e),p=u.variableTables[0],g=s.getBoxes(p);g.iconBox&&(i=Math.max(i,g.iconBox.h*h),r=Math.max(r,g.iconBox.w*h)),l=Math.max(l,g.variableBox.h*h),c=Math.max(c,g.descriptionBox.h*h)}),e.forEach(function(e,n){var f=t.getParentBox(e),h=o/f.w,u=a.getSectionJsonInfographic(e),p=u.variableTables[0],g=s.getBoxes(p),v=p.shape||p.image;if(v&&(v.style.height=i/h,v.style.width=r/h,p.image&&p.image.imageJson)){var y=p.image.imageJson.style=p.image.imageJson.style||{};y.left=0,y.top=0,y.width=v.style.width,y.height=v.style.height}p.variable.style.height=l/h,p.description.style.height=c/h,v?(v.style.top=0,p.variable.style.top=v.style.top+v.style.height):p.variable.style.top=0,p.description.style.top=p.variable.style.top+p.variable.style.height;var d=s.getBoxes(p),S=0,b=-10/h;v&&(v.style.left-=(d.iconBox.w-g.iconBox.w)/2,b+=d.iconBox.y-g.iconBox.y,S=-b),S+=d.descriptionBox.y+d.descriptionBox.h-g.descriptionBox.y-g.descriptionBox.h,f.y+=b,f.h+=S,t.setParentBox(e,f);var x=a.getSectionJsonInfographicTable(e);x.style.top-=b,e.stack.filter(function(e){return e!==x}).forEach(function(e){e.style.top-=b})})},h._hideBackgroundElements=function(e){return e.map(function(e){var t=a.getSectionJsonInfographic(e);return t&&t.type===o.STATIC?(e.stack=[a.getSectionJsonInfographicTable(e)],e):e})},h});