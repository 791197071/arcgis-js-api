// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/query","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/DynamicStyleUtil","./HeaderFooterRenderer","../../../PlayerViewModes","../../../core/supportClasses/DocumentOptions"],function(e,t,o,r,n,i,a,d,s,c,l){var g={processTooltips:function(e){i(".selectableLegendRootLabel",e).forEach(function(e){e.title=e.innerHTML})}},p={PROPS_TO_REMOVE:{"data-dojo-attach-point":1,id:1,widgetid:1},buildHtmlStringForPlayer:function(e,t){var r=[],n=p._preprocessMainNode(e,r),i=p._getPageNodes(e,n,t),a=p._cleanUpAndCombinePageNodes(i);return i.forEach(function(e){o.destroy(e)}),{domString:a,additionalStyleNodes:r}},_preprocessMainNode:function(e,t){function r(e){i("."+e,a).forEach(function(e){n.set(e,{maxWidth:"none",maxHeight:"none",width:"auto",height:"auto"})})}var a=o.toDom(e.domNode.outerHTML);return p._processNode(a,t),e.getViewMode()===c.FULL_PAGES?(r("esriGEReportPlayer_reportContainerGrid"),r("reportContainerGrid_mainContainer")):e.getViewMode()===c.PANELS_IN_STACK_ALL&&(r("esriGEReportPlayer_reportContainerStackAll"),i(".reportContainerStackAll_zoomFillerContainer",a)[0].style.margin="0"),g.processTooltips(a),a},_processNode:function(r,i){function s(e,o){return o?"line"!==e.nodeName||e.getAttribute("x1")!==e.getAttribute("x2")||e.getAttribute("y1")!==e.getAttribute("y2"):!(a.isHidden(e)||"none"===n.get(e,"display")||t.contains(e,"esriTriStateCheckBoxIcon"))}function c(t,o){o=void 0===o||o;for(var r in g.PROPS_TO_REMOVE)(o||"id"!==r)&&e.remove(t,r)}function l(e,t){if("svg"===e.nodeName&&(t=!0),!t){var r=d.getStyle(e.id);r&&r.forEach(function(e){i.push(e)}),c(e,!r)}if(!s(e,t))return o.destroy(e),!1;if(e.children)for(var n=e.children.length,a=0,g=0;a+g<n;)l(e.children[a],t)?a++:g++;return!0}var g=this;l(r)},_getPageNodes:function(e,t,o){return e.getViewMode()===c.PANELS_IN_STACK_ALL?p._getPageNodes_stackAll(e,t,o):p._getPageNodes_fullPages(e,t,o)},_getPageNodes_stackAll:function(e,t,n){if(!e.splitPages()){return(p._providePageHeaderFooter(1,e,!0,[t])||e.needAutoScale())&&p._tryApplyNewPageSize(e,t),p._processAllPanelsInStacks(t),[t]}var a=o.create("div",{class:"esriGEBehindScreen"},document.body);a.appendChild(t),p._providePageHeaderFooter(1,e,!0,[t]),["esriGEReportPlayerPrint_reportHeader","esriGEReportPlayerPrint_reportDataSource","esriGEReportPlayerPrint_reportFooter"].map(function(e){var r=i("."+e,t)[0];r&&o.destroy(r)});var d=i(".esriGEReportPlayer_infographicsPageStack",t)[0],s=0,c=i(".infographicPageStack_infographicRow",d).map(function(e){var t=r.getMarginBox(e).h;return s=Math.max(s,t),t}),g=[];if(1===c.length)g.push({height:c[0],indexes:[0]});else if(2===c.length)g.push({height:c[0]+c[1],indexes:[0,1]});else{var u,h=l.getPageBox(e.getDocumentOptions()),f=t.clientWidth*h.h/h.w,_=Math.max(f,c[0]+c[1],s);c.forEach(function(e,t){u&&u.height+e<=_?(u.indexes.push(t),u.height+=e):(u={height:e,indexes:[t]},g.push(u)),u.height>=_&&(u=null)})}var P=i(".reportContainerStackAll_groupLabelsContainer",t)[0].clientHeight,m=g.map(function(e){var r=o.toDom(t.outerHTML);return i(".reportContainerStackAll_zoomFillerContainer",r)[0].style.height=e.height+P+"px",p._processAllPanelsInStacks(r,function(t,r){-1===e.indexes.indexOf(r)&&o.destroy(t)}),r});return p._providePageHeaderFooter(m.length,e,!0,m),o.destroy(a),m},_processAllPanelsInStacks:function(e,o){i(".esriGEReportPlayer_infographicsPageStack",e).forEach(function(e){i(".infographicPageStack_infographicRow",e).forEach(function(e,r){var n=i(".section_stackNode",e)[0];t.add(n,"infographicPageStack_infographicSectionNode_stackNode"),o&&o(e,r)})})},_getPageNodes_fullPages:function(e,t,r){var n=[],a=i(".reportContainerGrid_gridContainerWrapper",t);if(a.length>1){a.forEach(function(e){e.parentNode.removeChild(e)});i(".esriGEReportPlayer_reportContainerGrid",t).forEach(function(e,t){t>0&&e.parentNode.removeChild(e)}),a.forEach(function(e){var r=o.toDom(t.outerHTML);i(".reportContainerGrid_gridStackContainer",r)[0].appendChild(e),n.push(r)})}else n.push(t);return(p._providePageHeaderFooter(e.getNumberOfPages(),e,r,n)||e.needAutoScale())&&p._tryApplyNewPageSize(e,n[0]),n},_tryApplyNewPageSize:function(e,t){if(-1!==e.getDocumentOptions().pagesize.indexOf("x")){var r=o.create("div",{class:"esriGEBehindScreen"},document.body);r.appendChild(t),e.setNewPageSize(t.clientWidth,t.clientHeight),r.removeChild(t),o.destroy(r)}},_providePageHeaderFooter:function(e,t,o,r){var n=t.getDocumentOptions(),i=t.getHeaderFooterParams(),a=!1;return r.forEach(function(t,d){var c=Math.floor(d/e),l=d%e;a=s.addHeaderAndFooterToPage({pageNode:t.children[0],headerFooterParams:i&&i[c],documentOptions:n,pageIndex:o?d:l,numPages:o?r.length:e})||a}),a},_cleanUpAndCombinePageNodes:function(e){return function(e){return e&&e.replace(/esriMapsAnalystXNonSelectable|esriGENonSelectable|esriMapsAnalystXClickable|dojogfxstrokestyle="solid"/g,"")}(e.map(function(e){return e.outerHTML}).join(""))}};return p});