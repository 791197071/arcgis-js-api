// COPYRIGHT © 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","./tasks/EnrichAreasTask","./tasks/RunReportTask","./data/AreaDataUtil","./data/AreaCalculatorsUtil","./data/VariablesUtil","./CustomReportsManager","esri/dijit/geoenrichment/utils/DateUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldLibrary","../../core/infographics/simpleInfographic/dataDrilling/EnrichUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil","../../core/infographics/utils/InfographicJsonUtil"],function(e,a,t,r,i,n,o,s,l,u,c,f,d,p){return{populateReportDataFromAttachmentsStore:function(t,r){var i=[];return r.setCurrentAnalysisAreaIndex&&r.setCurrentAnalysisAreaIndex(0),i.push(e(r.getNotes(),function(e){e&&e.length&&(t.fieldData.metadata[c.SITENOTE_FIELD_NAME]=e[0].text,t.fieldData.metadata[c.SITENOTES_FIELD_NAME]=e.map(function(e){return e.text}).join("<br/><br/>"))})),i.push(e(r.getAttributes(),function(e){if(!e||!e.length)return null;var a={attributes:{}};e.forEach(function(e){a.attributes[e.name]=e}),t.analysisAreas.forEach(function(e,r){var i=t.fieldData.areaData[r];i&&o.addFeatureAttributesCalculator(a,i)})})),a(i)},runReportAndGetData:function(a){return e(l.getCustomReportByID(a),function(e){function r(e){return a.fieldData.errors.push(e),(new t).reject(e)}return(new i).execute({portalUrl:a.portalUrl,analysisAreas:a.analysisAreas,countryID:a.countryID,hierarchy:a.hierarchy,report:{reportID:e.reportID,portalUrl:e.templateData.getPortalUrl(!0),modified:e.modified,isMultiFeature:e.isMultiFeature},cacheResult:!0}).then(function(a){return{taskIDs:a.taskIDs,selectedReport:e,areaData:a.areaData}},r)})},runReportFromVariables:function(e){function a(a){return e.fieldData.errors.push(a),(new t).reject(a)}var i={};return e.variables.fullNames.forEach(function(e){var a=d.createFieldNameFromVariable(e);i[e.substr(e.indexOf(".")+1)]=a}),(new r).enrichAreas({portalUrl:e.portalUrl,analysisAreas:e.analysisAreas,countryID:e.countryID,hierarchy:e.hierarchy,fields:s.convertForEnrich(e.variables),comparisonLevels:e.comparisonLevels||p.getDefaultLevels()}).then(function(a){var t=e.analysisAreas.map(function(){return{}});return o.addEnrichFeatures(a,i,d.DATA_COLLECTIONS_CALCULATOR_NAME,t),{areaData:t}},a)},applyRunReportAndGetDataResults:function(e,a){e&&e.areaData&&(a.fieldData.runReportTaskIDs=e.taskIDs,a.fieldData.areaData=e.areaData,a.analysisAreas&&this._reportDataFromAreas(a.analysisAreas,a.fieldData.areaData),e.selectedReport&&this._reportDataFromReport(e.selectedReport,a.fieldData,a.combinedAreasInfo))},_reportDataFromAreas:function(e,a){e.forEach(function(e,t){var r=e.feature,i=a[t];i&&(o.addFeatureAttributesCalculator(r,i),o.addAreaInfoCalculator(e,i))})},_reportDataFromReport:function(e,a,t){var r=a.metadata;e&&!r.Title&&(r.Title=e.title),r.Source="Esri",r.Date=u.getReportFooterDate(),r.Copyright="©"+u.getFullYear()+" Esri",r.ProductLabel="",r.ProductUrl="",r.PhoneNumber="",r.TrialUrlText="",e.isMultiFeature&&(r.SITE_NAME=t.locationName||t.name,r.STORE_NAME=t.locationName||t.name,r.AREA_DESC2=t.description||t.name,r.STORE_ADDR=t.address)},enrichFieldData:function(t,i){function s(e,a,t){function r(e){return i.fieldData.areaData.every(function(a,r){return void 0!==n.getAreaDataValue({fieldName:e,fieldData:i.fieldData,calculatorName:t,featureIndex:r,ignoreMetadata:!0})})}t=t||d.ENRICHED_DATA_NO_LEVELS;var o=[],s={};return e.forEach(function(e){r(e.fieldName)||(o.push(e.mapTo),s[e.mapTo]=e.fieldName,s[e.mapTo.substr(e.mapTo.indexOf(".")+1)]=e.fieldName)}),o.length?{fields:o,fieldsMap:s,comparisonLevels:a,calculatorName:t}:null}var u=[];if(t=f.optimizeInfos(t),t.forEach(function(e){var a;(e.isGeneral||e.isChart)&&(a=s(e.fields,e.levels,e.calculatorName)),a&&u.push(a)}),u.length)return e(l.getCustomReportByID(i),function(e){function t(e){i.fieldData.errors.push(e)}return a(u.map(function(e){return(new r).enrichAreas({portalUrl:i.portalUrl,analysisAreas:i.analysisAreas,countryID:i.countryID,hierarchy:i.hierarchy,fields:e.fields,comparisonLevels:e.comparisonLevels}).then(function(a){o.addEnrichFeatures(a,e.fieldsMap,e.calculatorName,i.fieldData.areaData)},t)}))})}}});