// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["require","dojo/_base/declare","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","./supportClasses/ReportDataProcessor","./supportClasses/tasks/parsers/DataXMLParser","./supportClasses/tasks/RunReportTask","./supportClasses/areas/AnalysisAreaUtil","./supportClasses/areas/AnalysisAreaJsonUtil","./supportClasses/CustomReportsManager","./supportClasses/GEUtil","../core/supportClasses/ReportTemplateTypes","../core/conversion/PortalToEditorConverter","esri/dijit/geoenrichment/utils/ImageInfoUtil"],function(e,r,t,a,s,o,n,i,l,p,m,c,u,g,f){function d(){var r=new a;return e(["./supportClasses/attachments/AttachmentsStoreSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","./commands/mapToImage/MapToURLUtil","esri/dijit/geoenrichment/utils/ProjectionUtil"],function(e,t,a,s,o){h=e,v=t,A=a,I=s,U=o,r.resolve()}),r.promise}var h,v,A,I,U;return r(null,{reportDataToServerData:function(e){var r=e.getReportData(),a=this;return d().then(function(){return t({files:r.reportObject.templateData.getFiles(),attachmentsProvider:r.attachmentsStore&&h.getAttachmentsStoreJson(r.attachmentsStore,r.analysisAreas.length),mapImages:a._getMapImages(e)}).then(function(e){var t=i.CreateReportResultCache.getResults()[0].originalXMLs[0];return e.mapImages&&e.mapImages.forEach(function(e){t=t.replace(/\<mapImage_0\>mapImage_.*?\.png\<\/mapImage_0\>/,"<mapImage_0>"+e+"</mapImage_0>")}),e.files.push({name:"data.xml",data:t}),{portalItem:{properties:{isMultiFeature:r.reportObject.isMultiFeature?"true":"false"},resources:e.files},attachmentsProvider:e.attachmentsProvider,customLogo:r.customLogo,portalUrl:r.config.portalUrl,geometryServiceUrl:r.config.geometryServiceUrl,printMapTaskUrl:r.config.printMapTaskUrl,analysisAreas:p.areasToJson(r.analysisAreas),combinedAreasInfo:r.combinedAreasInfo&&p.combinedAreasInfoToJson(r.combinedAreasInfo),reverseAnalysisAreasOnMap:r.reverseAnalysisAreasOnMap}})})},_getMapImages:function(e){var r=e.collectMaps({allAreas:!0});return t(r.map(function(e){return I.mapToURL(e.map,e.legend,e.node).then(function(e){return f.getRemoteImageDataUrl(e,{sizeLimit:100})})}))},reportDataFromServerData:function(e){function r(r){var t=m.prepareCustomReportFromItem(e.portalItem);return t.isGraphicReport=!0,t.portalJson={files:i},s(g.provideEditorJson(t,{variableProvider:r}),function(){return t.templateJson=v.deserialize(t.templateJson),delete t.portalJson,t})}function t(e,r){var t=i.filter(function(e){return"data.xml"===e.name})[0],a=/.*\.png/i,s={};i.forEach(function(e){a.test(e.name)&&(s[e.name]=e.data)});var l={selectedReport:e,areaData:n.parse(t.data,function(e,r){return s[r]||r})};o.applyRunReportAndGetDataResults(l,r)}function a(e){return f._infographicOptionsProvider.getInfographicOptions({geoenrichmentUrl:"",countryID:"",reportID:"",analysisAreas:e})}var i,f=this,y=e.portalItem.resources;if(Array.isArray(y))i=y;else{i=[];for(var D in y)i.push({name:D,data:y[D]})}return d().then(function(){var n=new A;return s(r(n),function(r){var i=p.areasFromJson(e.analysisAreas),m={isClassic:!1,isMultiFeature:r.isMultiFeature&&i.length>1,reportType:r.type||u.STANDARD,reportTitle:r.title||"",templateJson:r.templateJson,reportObject:r,fieldData:{metadata:{},areaData:[],errors:[]},analysisAreas:i,combinedAreasInfo:e.combinedAreasInfo&&p.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},reverseAnalysisAreasOnMap:e.reverseAnalysisAreasOnMap,infographicOptions:a(i),attachmentsStore:e.attachmentsProvider&&h.getAttachmentsStoreFromJson(e.attachmentsProvider),geClient:null,templateVariableProvider:n,config:{portalUrl:e.portalUrl,geoenrichmentUrl:null,geometryServiceUrl:e.geometryServiceUrl,printMapTaskUrl:e.printMapTaskUrl,countryID:null,hierarchy:null,reportID:r.reportID,variables:null},customLogo:e.customLogo};return l.populateCombinedAreasInfo(m.combinedAreasInfo,m.analysisAreas),t(r,m),c.setGeoenrichmentUrl(m.config.geoenrichmentUrl),m.config.geometryServiceUrl&&U.setGeometryServiceUrl(m.config.geometryServiceUrl),m.config.printMapTaskUrl&&I.setPrintMapTaskUrl(m.config.printMapTaskUrl),s(m.attachmentsStore&&o.populateReportDataFromAttachmentsStore(m,m.attachmentsStore),function(){return m})})})}})});