// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.31/esri/copyright.txt for details.

define(["dojo/dom-construct","dojo/dom-geometry","../dom-style","./TextStyleBuilder","../TransformUtil","./FlowCalculator","./ReplaceUtil","./SiblingsUtil"],function(e,t,i,n,r,s,o,l){var a={_linesNode:null,_wordNode:null,_wordsNode:null,createTempLinesNode:function(e){return this._linesNode=this._linesNode||this._createTempNode(),this._styleNode(this._linesNode,e,!0)},createTempWordNode:function(e){return this._wordNode=this._wordNode||this._createTempNode(!0),this._styleNode(this._wordNode,e)},createTempWordsNode:function(e){return this._wordsNode=this._wordsNode||this._createTempNode(!0),this._styleNode(this._wordsNode,e)},_createTempNode:function(t){var n=e.create("div",null,document.body);return i.set(n,{position:"absolute",display:"inline-block",left:t?"600px":"300px",top:"100px",color:"yellow"}),n},_styleNode:function(e,t,r){return n.resetTextStyle(e),i.set(e,"display","inline-block"),t&&(i.set(e,"width",r?t.style.cw+"px":""),i.set(e,t.style.getTextStyleObject())),e},dispose:function(e){e&&i.set(e,"display","none")},cleanUp:function(){this._linesNode&&e.destroy(this._linesNode),this._linesNode=null,this._wordNode&&e.destroy(this._wordNode),this._wordNode=null,this._wordsNode&&e.destroy(this._wordsNode),this._wordsNode=null}},d={getParagraphs:function(e,t){function i(e){return o.collapseMultipleSpaces(e.trim())}var n=t.style.getTextStyle("whiteSpace"),r="pre-wrap"===n||"pre"===n||"pre-line"===n;r||(e=o.removeReturns(e));var s="pre-wrap"===n||"pre"===n;s||(e=i(e));var l=r?e.split(String.fromCharCode(10)):[e];return l.length>1&&!s&&(l=l.map(i)),l}},h={measureWidth:function(e,t){return t.innerHTML=e,i.get(t,"width")}},u={getLinesForWords:function(e,i,n,r,s){function o(){var e=r.innerHTML;r.innerHTML="";var t=e.split("");return u.getLinesForWords(t,i,n,r,{checkBreaking:!1,separator:""}).lines}function l(e){var t=e.split("");return u.getLinesForWords(t,i,n,r,{checkBreaking:!1,separator:"",clearLinesNodeBeforeMeasure:!s.isBreakAll}).lines}function a(e,t){return t=t||"",N.test(e)?e+t:e+s.separator+t}var d,c,p=0;s.checkBreaking&&(r.innerHTML="a",c=t.position(r).h);var g=0,f="";s.clearLinesNodeBeforeMeasure&&(r.innerHTML="");var N=/[^\s]-$/;e.some(function(e){if(d){var i;s.checkBreaking&&(i=r.innerHTML),r.innerHTML=a(r.innerHTML,e);var u=t.position(r).h;if(g>0&&u>g&&u-g<p/2){p+=u-g,g=u}if(g>0&&u>g){d.push({text:f,w:h.measureWidth(f,n),lineHeight:p});var N;if(s.checkBreaking&&(u-g>1.2*c||s.isBreakAll)){r.innerHTML=a(f);var _=l(e);r.innerHTML=a(i,e),_.length>1&&(N=!0,_.forEach(function(e,t){if(t<_.length-1)if(0===t&&s.isBreakAll){var i=d[d.length-1];i.text=a(i.text,e.text),i.w=h.measureWidth(i.text,n)}else d.push(e);else p=e.lineHeight,f=e.text}),g=u)}N||(f=e,p=u-g,g=u)}else f=a(f,e),0===g&&(g=t.position(r).h,p=g)}else if(d=[],s.clearLinesNodeBeforeMeasure?r.innerHTML=e:r.innerHTML+=e,f=e,g=t.position(r).h,p=g,s.checkBreaking&&g>1.2*c){var w=o();w.length>1&&w.forEach(function(e,t){t<w.length-1?d.push(e):(p=e.lineHeight,f=e.text)})}}),d.push({text:f,w:h.measureWidth(f,n),lineHeight:p});var _=t.position(r).w;return"justify"===i.style.textAlign&&d.forEach(function(e,t){if(!s.isInsideParagraph||t!==d.length-1){var i=0;e.words=e.text.split(" ").map(function(e){var t=h.measureWidth(e,n);return i+=t,{text:e,w:t}}),e.wordSpace=e.words.length<2?0:(_-i)/(e.words.length-1)}}),{lines:d,textWidth:_,lineHeight:p}}},c={getLinesForParagraph:function(e,t,i,n){var r=this._splitIntoWords(e),s="break-word"===t.style.getTextStyle("overflowWrap")||"break-word"===t.style.getTextStyle("wordWrap"),o="break-all"===t.style.getTextStyle("wordBreak");return u.getLinesForWords(r,t,i,n,{checkBreaking:s||o,isBreakAll:o,clearLinesNodeBeforeMeasure:!0,separator:" ",isInsideParagraph:!0})},_splitIntoWords:function(e){return e.replace(/([^\s])-([^\s])/g,"$1- $2").split(" ")}},p={_node:null,_originalInnerHTML:null,_nextSiblingsHideInfo:null,setNode:function(e){this._node=e,this._originalInnerHTML=null,this._nextSiblingsHideInfo=null},doPresets:function(){this._originalInnerHTML=this._node.innerHTML,this.hideNextSibling()},undoPresets:function(){this.showNextSibling(),this._node.innerHTML=this._originalInnerHTML},hideNextSibling:function(){this._nextSiblingsHideInfo||(this._nextSiblingsHideInfo=l.hideNextSiblings(this._node))},showNextSibling:function(){l.showNextSiblings(this._nextSiblingsHideInfo),this._nextSiblingsHideInfo=null}};return{getLines:function(e,i){if(e.innerHTML&&e.innerHTML.trim()){var n=r.disableTransform(e,i.parentVs);p.setNode(e),p.doPresets();var s,o=d.getParagraphs(e.innerHTML,i),l=i.isSpanLike?e:a.createTempLinesNode(i),h=a.createTempWordNode(i),u=[];if(o.forEach(function(e){var t=c.getLinesForParagraph(e,i,h,l);s=t.textWidth,u=u.concat(t.lines)}),i.isSpanLike){l.innerHTML=p._originalInnerHTML;var g=t.position(l).h;p.showNextSibling();var f=t.position(l).h;if(f>g){var N=(f-g)/2;u[u.length-1].lineHeight+=N}p.hideNextSibling()}return p.undoPresets(),a.dispose(h),!i.isSpanLike&&a.dispose(l),r.restoreTransform(n),{lines:u,textWidth:s}}},getSpanFlowOffsets:function(e,t){return s.getSpanFlowOffsets(e,t)},cleanUp:function(){a.cleanUp()}}});