// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["../../kernel","./AnalysisRegistry","./RasterAnalysisMixin","./utils","./ItemTypes","dijit/_FocusMixin","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","esri/layers/ArcGISImageServiceLayer","dojo/_base/array","dojo/_base/declare","dojo/_base/json","dojo/_base/lang","dojo/has","dojo/i18n!./nls/DetermineTravelCostPathAsPolyline","dojo/text!./templates/DetermineTravelCostPathAsPolyline.html"],function(t,e,s,i,n,a,r,o,h,u,l,p,y,c,d,_,L,m){var S=y([h,o,u,r,a,s],{declaredClass:"esri.dijit.analysis.DetermineTravelCostPathAsPolyline",templateString:m,widgetsInTemplate:!0,analysisType:"feature",browseType:[n.IS,n.FS],checkGeometries:[e.GeometryTypes.Point,e.GeometryTypes.MultiPoint,e.GeometryTypes.Line],tags:["point","line"],map:null,drawDestinationPointLayerName:"",drawSourcePointLayerName:"",toolName:"DetermineTravelCostPathAsPolyline",helpFileName:"DetermineTravelCostPathAsPolyline",toolNlsName:L,rasterGPToolName:"DetermineTravelCostPathAsPolyline",outputName:"outputPolylineName",resultParameter:"outputPolylineFeatures",constructor:function(t,e){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode)},_removePointLayer:function(){this.sourcePointLayer&&this._removeLayer(this.sourcePointLayer,this.inputLayers,this._analysisSelect),this.destinationPointLayer&&this._removeLayer(this.destinationPointLayer,this.inputLayers,this._destinationSelect),this._sourceDrawBtn.deactivate(),this._destinationDrawBtn.deactivate()},_getJobParameters:function(){var t=i.constructAnalysisInputLyrObj(this.get("inputLayer"));this.inputLayer.drawnLayer&&(t.drawnLayer=this.inputLayer.drawnLayer);var e=c.toJson(i.constructAnalysisInputLyrObj(this.get("inputCostRaster"))),s=i.constructAnalysisInputLyrObj(this.get("inputDestinationRasterOrFeatures"));return this.get("inputDestinationRasterOrFeatures").drawnLayer&&(s.drawnLayer=this.get("inputDestinationRasterOrFeatures").drawnLayer),{inputSourceRasterOrFeatures:c.toJson(t),inputCostRaster:e,inputDestinationRasterOrFeatures:c.toJson(s),pathType:this._pathTypeSelect.get("value")}},_setDefaultInputs:function(){this._addInputCostRasterLayerOptions(),this._setDefaultInputCostRaster(),this._addDestinationLayerOptions(),this._pathTypeSelect.set("value",this.pathType),this._outputLayerInput.set("value",this.outputPolylineName&&this.outputPolylineName.serviceProperties.name),this.drawDestinationPointLayerName||(this.drawDestinationPointLayerName=this.i18n.drawDestinationPointLayerName),this.drawSourcePointLayerName||(this.drawSourcePointLayerName=this.i18n.drawSourcePointLayerName),this.inputLayer&&this.inputLayer.drawnLayer&&(this._sourceDrawBtn.set("pointFeatureLayer",this.inputLayer),this.sourcePointLayer=this.inputLayer),this.inputDestinationRasterOrFeatures&&this.inputDestinationRasterOrFeatures.drawnLayer&&(this.inputLayers.push(this.inputDestinationRasterOrFeatures),this._destinationDrawBtn.set("pointFeatureLayer",this.inputDestinationRasterOrFeatures),this.destinationPointLayer=this.inputDestinationRasterOrFeatures),this._destinationDrawBtn.set("map",this.map),this._sourceDrawBtn.set("map",this.map),this._destinationDrawBtn.on("change",d.hitch(this,this._handleDestinationDrawLayer)),this._sourceDrawBtn.on("change",d.hitch(this,this._handleSourceDrawLayer)),this._destinationSelect.set("isValid",d.hitch(this,this._isValid))},_setDefaultInputCostRaster:function(){this.inputCostRaster||(this.inputCostRaster=this.inputCostRasters[0])},_handleSourceDrawLayer:function(t){this._clearSelectedPointSelectLayer(!0),this.inputLayers&&0!==this.inputLayers.length&&-1!==this.inputLayers.indexOf(t)||(this.sourcePointLayer=t,this.inputLayers.push(t),this.inputLayer=t,this._analysisSelect.removeOption(this._analysisSelect.getOptions()),i.populateAnalysisLayers(this,"inputLayer","inputLayers"),this._addDestinationLayerOptions())},_handleDestinationDrawLayer:function(t){if(this._clearSelectedPointSelectLayer(!1),!this.inputLayers||0===this.inputLayers.length||-1===this.inputLayers.indexOf(t)){this.destinationPointLayer=t;var e=this._updateSelectOptionsForDrawLayer(!1,t);this._handleDestinationAnalysisLayerChange(e)}},_clearSelectedPointSelectLayer:function(t){t&&this.destinationPointLayer&&this._destinationDrawBtn.reset(),!t&&this.sourcePointLayer&&this._sourceDrawBtn.reset()},_isValid:function(){return"placeholder"===this._destinationSelect.value?(this._destinationSelect._missingMsg=this.toolNlsName.missingMessage,!1):(this._destinationSelect._missingMsg=this.toolNlsName.noValueMessage,!this._destinationSelect.required||0===this._destinationSelect.value||!/^\s*$/.test(this._destinationSelect.value||""))},_updateSelectOptionsForDrawLayer:function(t,e){var s=this.inputLayers.length,i=this._destinationSelect.getOptions();return this._destinationSelect.removeOption(i),i=p.map(i,function(t){return t.selected=!1,t}),i.push({value:s,label:e.name,selected:!0}),this.inputLayers.push(e),this._destinationSelect.addOption(i),s},_addInputCostRasterLayerOptions:function(){var t=[];this._inputCostRasterSelect.removeOption(this._inputCostRasterSelect.getOptions()),p.forEach(this.inputCostRasters,d.hitch(this,function(e,s){this._isSelected(this.inputCostRaster,this.inputLayer)||t.push({label:e.name,value:s,selected:this._isSelected(e,this.inputCostRaster)})})),this._inputCostRasterSelect.addOption(t),this._handleInputCostRasterChange(this._inputCostRasterSelect.get("value"))},_addDestinationLayerOptions:function(){var t=this._destinationSelect.getOptions(),e=[];p.some(t,function(t){return"separator"===t.type})&&(e=t.splice(t.length-2,2)),this._destinationSelect.removeOption(this._destinationSelect.getOptions()),this._destinationSelect.addOption(this._getDestinationLayerOptions()),this._destinationSelect.addOption(e),this._handleDestinationAnalysisLayerChange(this._destinationSelect.get("value"))},_getDestinationLayerOptions:function(){var t=[];return p.forEach(this.destinationRasters,d.hitch(this,function(e,s){this._isSelected(e,this.inputLayer)||this._isSelected(e,this.inputDestinationRasterOrFeatures)?this._isSelected(e,this.inputDestinationRasterOrFeatures)&&(this._isSelected(e,this.inputLayer)?t.push({label:this.toolNlsName.placeHolder,value:"placeholder",selected:!0,disabled:!0}):t.push({label:e.name,value:s,selected:!0})):t.push({label:e.name,value:s,selected:!1})})),t},_handleInputCostRasterChange:function(t){"browselayers"===t||"browse"===t?(this._isAnalysisSelect=!1,this._isCostRasterSelect=!0,this.defaultItemTypes=[],this.set("allowedItemTypes",[n.IS]),this._createBrowseItems({browseValue:t,disableLAAL:!0,disableBoundary:!0},{},this._inputCostRasterSelect)):t>=0&&this.set("inputCostRaster",this.inputCostRasters[t])},_handleDestinationAnalysisLayerChange:function(t){"browselayers"===t||"browse"===t?(this._isAnalysisSelect=!1,this._isCostRasterSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",this.browseType),this._createBrowseItems({browseValue:t},{geometryTypes:this.checkGeometries,tags:this.tags,customCheck:{customCheckHandler:d.hitch(this,function(t){return!i.isSameLayer(t,this.inputLayer)})}},this._destinationSelect)):"placeholder"===t?(this.set("inputDestinationRasterOrFeatures",void 0),this._destinationSelect.validate(!0)):t>=0&&this.set("inputDestinationRasterOrFeatures",this.destinationRasters[t])},_handleBrowseItemsSelect:function(t,e){t&&t.selection&&i.addAnalysisReadyLayer({item:t.selection,layers:this._isAnalysisSelect?this.inputLayers:this._isCostRasterSelect?this.inputCostRasters:this.destinationRasters,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._isCostRasterSelect?this._inputCostRasterSelect:this._destinationSelect,browseDialog:this._browseLyrsdlg,widget:this},e).always(d.hitch(this,function(){this._isAnalysisSelect?this._handleAnalysisLayerChange(this._analysisSelect.get("value")):this._isCostRasterSelect?this._handleInputCostRasterChange(this._inputCostRasterSelect.get("value")):this._handleDestinationAnalysisLayerChange(this._destinationSelect.get("value"))}))},_handleSourceAnalysisLayerChange:function(t){t>=0&&this.set("inputLayer",this.inputLayers[t]),this._addDestinationLayerOptions()},_resetUI:function(){this._addDestinationLayerOptions()},addBrowseOption:function(){i.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._inputCostRasterSelect},this._destinationSelect])},_isSelected:function(t,e){return e&&t&&e.url===t.url&&e.id===t.id},_setInputLayerAttr:function(t){this.inputLayer=t},_getInputLayerAttr:function(){return this.inputLayer},_setInputDestinationRasterOrFeaturesAttr:function(t){this.inputDestinationRasterOrFeatures=t,this._isSelected(t,this.inputLayer)&&this._resetUI()},_getInputDestinationRasterOrFeaturesAttr:function(){return this.inputDestinationRasterOrFeatures},_setInputLayersAttr:function(t){this.inputLayers=p.filter(t,function(t){return t.geometryType===e.GeometryTypes.Point||t.geometryType===e.GeometryTypes.Line||t.geometryType===e.GeometryTypes.Polygon||t instanceof l}),this.set("inputCostRasters",t),this.set("destinationRasters",t)},_getInputLayersAttr:function(t){return this.inputLayers},_getInputCostRasterAttr:function(){return this.inputCostRaster},_setInputCostRasterAttr:function(t){t instanceof l&&(this.inputCostRaster=t)},_getInputCostRastersAttr:function(){return this.inputCostRasters},_setInputCostRastersAttr:function(t){this.inputCostRasters=p.filter(t,function(t){return t instanceof l})},_getDestinationRastersAttr:function(){return this.destinationRasters},setDestinationRastersAttr:function(t){this.destinationRasters=t},_setOutputPolylineNameAttr:function(t){this.outputOptimumNetworkName=t},_getOutputPolylineNameAttr:function(){return this._outputLayerInput.get("value")},_setPathTypeAttr:function(t){this.pathType=t},_getPathTypeAttr:function(){return this.pathType},_setDrawSourcePointLayerNameAttr:function(t){this.drawSourcePointLayerName=t},_getDrawSourcePointLayerNameAttr:function(){return this.drawSourcePointLayerName},_setDrawDestinationPointLayerNameAttr:function(t){this.drawDestinationPointLayerName=t},_getDrawDestinationPointLayerNameAttr:function(){return this.drawDestinationPointLayerName}});return _("extend-esri")&&d.setObject("dijit.analysis.DetermineTravelCostPathAsPolyline",S,t),S});