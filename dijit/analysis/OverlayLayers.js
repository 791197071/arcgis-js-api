// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/fx","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","../../kernel","./AnalysisBase","./_AnalysisOptions","./CreditEstimator","./AnalysisToggleButton","./GroupToggleButton","./utils","./AnalysisRegistry","dojo/i18n!../../nls/jsapi","dojo/text!./templates/OverlayLayers.html"],function(e,t,s,i,n,a,o,r,l,y,h,u,p,c,d,_,L,m,v,g,T,f,S,b,C,I,P,B,O,A,w,k,F,j,G,x,N,M,U,E){var D=t([L,m,v,g,T,F,k],{declaredClass:"esri.dijit.analysis.OverlayLayers",templateString:E,widgetsInTemplate:!0,inputLayer:null,overlayLayer:null,overlayType:"intersect",tolerance:0,snapToInput:!1,outputLayerName:null,outputType:"Input",i18n:null,toolName:"OverlayLayers",helpFileName:"OverlayLayers",resultParameter:"Outputlayer",constructor:function(e,t){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),i.forEach(this._pbConnects,n.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,U.overlayLayersTool)},postCreate:function(){this.inherited(arguments),d.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_buildJobParams:function(){var e,t={};if(t.inputLayer=a.toJson(this.constructAnalysisInputLyrObj(this.inputLayer,this.showGeoAnalyticsParams)),"0"!==this._overlayFeaturesSelect.get("value")){var s=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1];t.overlayLayer=a.toJson(this.constructAnalysisInputLyrObj(s,this.showGeoAnalyticsParams))}return t.overlayType=this.get("overlayType"),this.returnFeatureCollection||(t.OutputName=a.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),this.showGeoAnalyticsParams||("intersect"===this.overlayType&&(t.outputType=this._outputTypeSelect.get("value")),t.tolerance=this.tolerance,t.snapToInput=this.snapToInput),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=a.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(e={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.extent=this.map.extent._normalize(!0)),t.context=a.toJson(e)),t},_handleSaveBtnClick:function(e){if(this._form.validate()){var t={};this._saveBtn.set("disabled",!0),t.jobParams=this._buildJobParams(),t.itemParams={description:this.i18n.itemDescription,tags:y.substitute(this.i18n.itemTags,{layername:this.inputLayer.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(t.itemParams.folder=this.get("folderId")),this.showGeoAnalyticsParams&&(this.resultParameter="output",t.isSpatioTemporalDataStore=!0),this.execute(t)}},_handleShowCreditsClick:function(e){e.preventDefault(),this._form.validate()&&this.getCreditsEstimate(this.toolName,this._buildJobParams()).then(s.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()}))},_save:function(){},_sortbyGeometryType:function(e,t){return this.isPolygon(e.geometryType)?-1:this.isPolygon(t.geometryType)?1:this.isLine(e.geometryType)?-1:this.isLine(t.geometryType)?1:this.isPoint(e.geometryType)?-1:this.isPoint(t.geometryType)?1:void 0},filterOverlayLayers:function(e,t){var s=[];return i.forEach(e,function(e){e.geometryType===t&&s.push(e)}),s},_buildUI:function(){var e=!0;this.signInPromise.then(s.hitch(this,N.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),this.showGeoAnalyticsParams&&(u.set(this._analysisFieldHelpLink,"esriHelpTopic","overlayLayer"),u.set(this._outputLayerHelpNode,"esriHelpTopic","outputLayer")),this.get("showSelectAnalysisLayer")&&(this.inputLayers&&this.inputLayer&&!N.isLayerInLayers(this.inputLayer,this.inputLayers)&&this.inputLayers.push(this.inputLayer),this.get("inputLayer")||!this.get("inputLayers")||this.rerun||this.set("inputLayer",this.inputLayers[0]),N.populateAnalysisLayers(this,"inputLayer","inputLayers")),this.overlayLayer&&this.oLayer&&!N.isLayerInLayers(this.oLayer,this.overlayLayer)&&this.overlayLayer.push(this.oLayer),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),e=!1),(this.oLayer||this.rerun)&&(e=!1),this.inputLayer&&this._updateAnalysisLayerUI(e),N.addReadyToUseLayerOption(this,[this._analysisSelect,this._overlayFeaturesSelect]),h.set(this._chooseFolderRow,"display",!0===this.showSelectFolder?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(e){this.folderStore=e,N.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),this.updateUIForGeoAnalytics(),h.set(this._chooseExtentDiv,"display",!0===this.showChooseExtent?"inline-block":"none"),h.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this.showGeoAnalyticsParams||N.updateDisplay([this._eraseBtnCell],this.isServerAdvanceLicensed,"table-cell"),this._loadConnections()},_updateAnalysisLayerUI:function(e){if(this.inputLayer&&u.set(this._overlaylayersToolDescription,"innerHTML",y.substitute(this.i18n.overlayDefine,{layername:this.inputLayer.name})),this.overlayLayer){this.overlayLayer.sort(s.hitch(this,this._sortbyGeometryType));var t=i.some(this._overlayFeaturesSelect.getOptions(),function(e){return"browse"===e.value},this),n=i.some(this._overlayFeaturesSelect.getOptions(),function(e){return"browselayers"===e.value},this),a=[],o=this._overlayFeaturesSelect.get("value");this._overlayFeaturesSelect.removeOption(this._overlayFeaturesSelect.getOptions()),this.rerun&&!this.overlayLayer&&N.addBlankOption(this._overlayFeaturesSelect,a);var r=this.overlayLayer.concat([]);this.showGeoAnalyticsParams&&(r=this.filterOverlayLayers(this.overlayLayer,this._getGeometryType())),i.forEach(r,function(t,s){var i=!0;t.url&&this.inputLayer.url&&t.url!==this.inputLayer.url?i=!1:this.inputLayer===t||t.analysisReady&&this.inputLayer.analysisReady||(i=!1),!i&&(this.isPolygon(t.geometryType)||this.isPoint(t.geometryType)||this.isLine(t.geometryType))&&a.push({value:s+1,label:t.name,selected:this.oLayer&&!e&&(this.oLayer.url&&t.url&&t.url===this.oLayer.url||this.oLayer.name===t.name)})},this),(this.get("showReadyToUseLayers")||this.get("showBrowseLayers")||t||n)&&a.push({type:"separator",value:""}),this._overlayFeaturesSelect.addOption(a),N.addBrowseOptionForTool({select:this._overlayFeaturesSelect,disableLAAL:!1},this),e&&this._overlayFeaturesSelect.set("value",o),this._handleLayerChange(this._overlayFeaturesSelect.get("value"))}this.overlayType&&("intersect"===this.overlayType?(this._intersectBtn.set("checked",!0),this._handleIntersectBtnClick()):"union"===this.overlayType?(this._unionBtn.set("checked",!0),this._handleUnionBtnClick()):"erase"===this.overlayType&&(this._eraseBtn.set("checked",!0),this._handleEraseBtnClick())),this.outputType&&this._outputTypeSelect.set("value",this.outputType),!e&&this.outputLayerName&&this._outputLayerInput.set("value",this.outputLayerName),this.updateUIForGeoAnalytics()},_handleAnalysisLayerChange:function(e){this._checkBrowseLayer(e,!0)||(this.inputLayer=this.inputLayers[e],this._updateAnalysisLayerUI(!0))},updateUIForGeoAnalytics:function(){this.showGeoAnalyticsParams&&(h.set(this._unionBtnCell,"display","none"),h.set(this._outputTypeTable,"display","none"),d.add(this._intersectBtnCell,"gaxOverlayTypeCell"),d.add(this._eraseBtnCell,"gaxOverlayTypeCell"))},_handleBrowseItemsSelect:function(e,t){e&&e.selection&&N.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.overlayLayer,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._overlayFeaturesSelect,browseDialog:e.dialog||this._browsedlg,posIncrement:this._isAnalysisSelect?0:1,widget:this},t).always(s.hitch(this,function(e){if(this._isAnalysisSelect&&(this.inputLayer=this.inputLayers[this._analysisSelect.get("value")],this.inputLayer)){i.some(this.overlayLayer,function(e){return e&&e.analysisReady&&this.inputLayer.analysisReady&&e.itemId===this.inputLayer.itemId},this)||this.overlayLayer.push(this.inputLayer)}this._isAnalysisSelect&&this._handleAnalysisLayerChange(this._analysisSelect.get("value"))}))},_checkBrowseLayer:function(e,t){return this._isAnalysisSelect=t,("browse"===e||"browselayers"===e)&&(this._filterLayersForGeometryType(t,e),!0)},_filterLayersForGeometryType:function(e,t){e?this._createBrowseItems({browseValue:t},{tags:["point","polygon","line"],geometryTypes:[M.GeometryTypes.Point,M.GeometryTypes.Polygon,M.GeometryTypes.Line]},this._analysisSelect):this._createBrowseItems({browseValue:t},{tags:this._getInputLivingAtlasType(),geometryTypes:this._getGeometryType()},this._overlayFeaturesSelect)},_getInputLivingAtlasType:function(){if(this.inputLayer){if(this.isPoint(this._getGeometryType()))return["point"];if(this.isPolygon(this._getGeometryType()))return["polygon"];if(this.isLine(this._getGeometryType()))return["line"]}return["point","polygon","line"]},_getGeometryType:function(){return this.inputLayer?[this.inputLayer.geometryType]:[M.GeometryTypes.Point,M.GeometryTypes.Polygon,M.GeometryTypes.Line]},isPolygon:function(e){return M.GeometryTypes.Polygon===e},isPoint:function(e){return M.GeometryTypes.Point===e},isLine:function(e){return M.GeometryTypes.Line===e},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1))},_handleLayerChange:function(e){var t,s,i,n;this._checkBrowseLayer(e,!1)||(t=this.overlayLayer[e-1],s=!1,n=this.get("overlayType"),t&&this.inputLayer&&(i=!this.isPolygon(this.inputLayer.geometryType)||!this.isPolygon(t.geometryType),this._unionBtn.set("disabled",i),this._unionBtn.set("iconClass",i?"unionLayersDisabledIcon":"unionLayersIcon"),this.isPolygon(this.inputLayer.geometryType)?s=this.isPolygon(this.inputLayer.geometryType)&&!this.isPolygon(t.geometryType):this.isLine(this.inputLayer.geometryType)?s=this.isLine(this.inputLayer.geometryType)&&this.isPoint(t.geometryType):this.isLine(this.inputLayer.geometryType)&&(s=!0),this._eraseBtn.set("disabled",s),this._eraseBtn.set("iconClass",s?"eraseLayersDisabledIcon":"eraseLayersIcon"),"union"!==n||this.isPolygon(this.inputLayer.geometryType)&&this.isPolygon(t.geometryType)?"erase"===n&&this.isLine(this.inputLayer.geometryType)&&this.isPoint(t.geometryType)?(this._showMessages(this.i18n.notSupportedEraseOverlayMsg),this._intersectBtn.set("checked",!0),this._handleIntersectBtnCtrClick()):"erase"===n&&this.isPolygon(this.inputLayer.geometryType)&&!this.isPolygon(t.geometryType)?(this._showMessages(this.i18n.notSupportedEraseOverlayMsg),this._intersectBtn.set("checked",!0),this._handleIntersectBtnCtrClick()):"intersect"===n?this._handleIntersectBtnCtrClick():"union"===n?this._handleUnionBtnCtrClick():"erase"===n&&this._handleEraseBtnCtrClick():(this._showMessages(this.i18n.overlayLayerPolyMsg),this._intersectBtn.set("checked",!0),this._handleIntersectBtnCtrClick()))),this.updateUIForGeoAnalytics()},_showMessages:function(e){u.set(this._bodyNode,"innerHTML",e),o.fadeIn({node:this._errorMessagePane,easing:_.quadIn,onEnd:s.hitch(this,function(){h.set(this._errorMessagePane,{display:""})})}).play(),window.setTimeout(s.hitch(this,this._handleCloseMsg),3e3)},_handleCloseMsg:function(e){e&&e.preventDefault(),o.fadeOut({node:this._errorMessagePane,easing:_.quadOut,onEnd:s.hitch(this,function(){h.set(this._errorMessagePane,{display:"none"})})}).play()},_updateOutputType:function(){var e,t;"0"!==this._overlayFeaturesSelect.get("value")&&(e=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1]),t=this.isPoint(this.inputLayer.geometryType)||this.inputLayer.geometryType===M.GeometryTypes.MultiPoint||this.isPoint(e.geometryType)||e.geometryType===M.GeometryTypes.MultiPoint,h.set(this._outputTypeTable,"display","table"),this._outputTypeSelect.removeOption(this._outputTypeSelect.getOptions()),this._outputTypeSelect.set("disabled",t),t?d.add(this._outputTypeLabel,"esriAnalysisTextDisabled"):d.remove(this._outputTypeLabel,"esriAnalysisTextDisabled"),t?this._outputTypeSelect.addOption({value:"Input",label:this.i18n.points}):this.isLine(this.inputLayer.geometryType)&&this.isLine(e.geometryType)?this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points,selected:!0},{value:"Input",label:this.i18n.lines}]):this.isPolygon(this.inputLayer.geometryType)&&this.isPolygon(e.geometryType)?this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points},{value:"Line",label:this.i18n.lines},{value:"Input",label:this.i18n.areas,selected:!0}]):this.isLine(this.inputLayer.geometryType)&&this.isPolygon(e.geometryType)?this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points,selected:!0},{value:"Input",label:this.i18n.lines}]):this.isPolygon(this.inputLayer.geometryType)&&this.isLine(e.geometryType)&&this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points,selected:!0},{value:"Input",label:this.i18n.lines}])},_handleUnionBtnCtrClick:function(){this._unionBtnCtr.set("checked",!0),this._unionBtn.set("checked",!0),h.set(this._outputTypeTable,"display","none"),this._outputTypeSelect.set("disabled",!0),d.add(this._outputTypeLabel,"esriAnalysisTextDisabled"),this._handleUnionBtnClick()},_handleIntersectBtnCtrClick:function(){this._intersectBtnCtr.set("checked",!0),this._intersectBtn.set("checked",!0),this.overlayLayer[this._overlayFeaturesSelect.get("value")-1],this._handleIntersectBtnClick(),this.showGeoAnalyticsParams||this._updateOutputType(),this.updateUIForGeoAnalytics()},_handleEraseBtnCtrClick:function(){this._eraseBtnCtr.set("checked",!0),this._eraseBtn.set("checked",!0),h.set(this._outputTypeTable,"display","none"),this._outputTypeSelect.set("disabled",!0),d.add(this._outputTypeLabel,"esriAnalysisTextDisabled"),this._handleEraseBtnClick()},_handleUnionBtnClick:function(e){this._canSelectOverlayType()||(this._outputLayerInput.set("value",this._getOutputLayerName(this.i18n.unionOutputLyrName)),this._unionBtn.focus(),this.set("OverlayType","union"))},_handleEraseBtnClick:function(e){this._canSelectOverlayType()||(this._outputLayerInput.set("value",this._getOutputLayerName(this.i18n.eraseOutputLyrName)),this._eraseBtn.focus(),this.set("OverlayType","erase"))},_handleIntersectBtnClick:function(e){this._canSelectOverlayType()||(this._outputLayerInput.set("value",this._getOutputLayerName(this.i18n.intersectOutputLyrName)),this._intersectBtn.focus(),this.set("OverlayType","intersect"))},_getOutputLayerName:function(e){var t=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1].name;return y.substitute(e,{layername:this.inputLayer.name,overlayname:t})},_canSelectOverlayType:function(){return"browse"===this._overlayFeaturesSelect.get("value")||"browselayers"===this._overlayFeaturesSelect.get("value")||""===this._overlayFeaturesSelect.get("value")||!this.inputLayer},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setInputLayerAttr:function(e){this.inputLayer=e},_setInputLayersAttr:function(e){this.inputLayers=e||[]},_setOverlayLayerAttr:function(e){this.overlayLayer=e},_setOverlayTypeAttr:function(e){this.overlayType=e},_getOverlayTypeAttr:function(){return this.overlayType},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setOutputTypeAttr:function(e){this.outputType=e},_getOutputTypeAttr:function(){return this.outputType},validateServiceName:function(e){return N.validateServiceName(e,{textInput:this._outputLayerInput,isItem:!this.returnFeatureCollection})},_connect:function(e,t,s){this._pbConnects.push(n.connect(e,t,s))}});return r("extend-esri")&&s.setObject("dijit.analysis.OverlayLayers",D,w),D});