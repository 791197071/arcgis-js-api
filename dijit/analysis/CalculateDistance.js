// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.28/esri/copyright.txt for details.

define(["../../kernel","./AnalysisRegistry","./RasterAnalysisMixin","./ItemTypes","./utils","dijit/_FocusMixin","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","esri/layers/ArcGISImageServiceLayer","dojo/_base/array","dojo/_base/declare","dojo/_base/json","dojo/_base/lang","dojo/dom-style","dojo/has","dojo/i18n!./nls/CalculateDistance","dojo/text!./templates/CalculateDistance.html"],function(t,e,i,n,a,s,l,u,o,r,c,p,h,m,d,y,_,g,A){var D=h([o,u,r,l,s,i],{declaredClass:"esri.dijit.analysis.CalculateDistance",templateString:A,widgetsInTemplate:!0,browseType:[n.IS,n.FS],checkGeometries:[e.GeometryTypes.Point,e.GeometryTypes.MultiPoint,e.GeometryTypes.Line],tags:["point","line"],inputFlowDirectionRaster:null,inputLayer:null,allocationField:null,maximumDistance:{},outputCellSize:{},toolName:"CalculateDistance",helpFileName:"CalculateDistance",toolNlsName:g,rasterGPToolName:"CalculateDistance",outputName:"outputDistanceName",resultParameter:["outputDistanceRaster","outputDirectionRaster","outputAllocationRaster"],secondaryOutputs:["outputDirectionRaster","outputAllocationRaster"],secondaryOutputNames:["outputDirectionName","outputAllocationName"],constructor:function(t,e){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode),t.rerun||(this.set("maximumDistance",{units:t.distanceDefaultUnits}),this.set("outputCellSize",{units:t.distanceDefaultUnits}))},_getJobParameters:function(){var t=a.constructAnalysisInputLyrObj(this.get("inputLayer"));this.get("inputLayer").drawnLayer&&(t.drawnLayer=this.get("inputLayer").drawnLayer);var e={inputSourceRasterOrFeatures:m.toJson(t),maximumDistance:this.get("maximumDistance")&&m.toJson(this.get("maximumDistance")),outputCellSize:this.get("outputCellSize")&&m.toJson(this.get("outputCellSize")),outputDistanceName:this.get("outputDistanceName")};return this.get("allocationField")&&(e.allocationField=this.get("allocationField")),e},_handleAllocationFieldChange:function(t){this.set("allocationField",t)},getLengthMeasureUnit:function(){return[{value:"Miles",label:this.i18n.miles},{value:"Feet",label:this.i18n.feet},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}]},_setDefaultInputs:function(){this._distanceUnitsSelect.addOption(this.getLengthMeasureUnit()),this._cellSizeUnitsSelect.addOption(this.getLengthMeasureUnit()),this._distanceUnitsSelect.set("value",this.maximumDistance.units),this._cellSizeUnitsSelect.set("value",this.outputCellSize.units),this._distanceInput.set("value",this.maximumDistance.distance),this._cellSizeInput.set("value",this.outputCellSize.distance),this._outputLayerInput.set("value",this.outputDistanceName&&this.outputDistanceName.serviceProperties.name),this._outputDirectionLayerInput.set("value",this.outputDirectionName&&this.outputDirectionName.serviceProperties.name),this._outputAllocationLayerInput.set("value",this.outputAllocationName&&this.outputAllocationName.serviceProperties.name),this._allocationField.set("value",this.allocationField),this.addPointAnalysisLayer()},_onChangeOfResultAllocationLayer:function(t){""!==t&&t?(this.inputLayer&&this._addAllocationFieldOptions(),y.set(this._allocationFieldTr,"display","block")):y.set(this._allocationFieldTr,"display","none")},_addAllocationFieldOptions:function(){var t=[];this._allocationField.removeOption(this._allocationField.getOptions());var e;e=this.inputLayer instanceof c?this.inputLayer.hasRasterAttributeTable?this.inputLayer._rasterAttributeTableFields:[{value:"VALUE",label:"VALUE"}]:this.inputLayer.fields,p.forEach(e,d.hitch(this,function(e){this._isNumberType(e.type)&&t.push({value:e.name,label:e.alias,selected:e.name===this.allocationField})})),!this.allocationField&&t&&t[0]&&this.set("allocationField",t[0].value),this._allocationField.addOption(t)},_resetUI:function(){this._onChangeOfResultAllocationLayer(this.get("outputAllocationName"))},_isNumberType:function(t){return t===e.FieldTypes.Integer},_isSelected:function(t){return this.inputFlowDirectionRaster&&t&&this.inputFlowDirectionRaster.url===t.url},_setInputLayerAttr:function(t){this.inputLayer=t},_getInputLayerAttr:function(){return this.inputLayer},_setInputLayersAttr:function(t){this.inputLayers=p.filter(t,function(t){return t.geometryType===e.GeometryTypes.Point||t.geometryType===e.GeometryTypes.Polygon||t.geometryType===e.GeometryTypes.Line||t.geometryType===e.GeometryTypes.MultiPoint||t instanceof c})},_getInputLayersAttr:function(t){return this.inputLayers},_setMaximumDistanceAttr:function(t){this.maximumDistance=t},_getMaximumDistanceAttr:function(){return this._distanceInput.get("value")?{distance:this._distanceInput.get("value"),units:this._distanceUnitsSelect.get("value")}:null},_setOutputCellSizeAttr:function(t){this.outputCellSize=t},_getOutputCellSizeAttr:function(){if(this._cellSizeInput.get("value"))return{distance:this._cellSizeInput.get("value"),units:this._cellSizeUnitsSelect.get("value")}},_setAllocationFieldAttr:function(t){this.allocationField=t},_getAllocationFieldAttr:function(){return this.allocationField},_setOutputDistanceNameAttr:function(t){this.outputDistanceName=t},_getOutputDistanceNameAttr:function(){return this._outputLayerInput.get("value")},_setOutputDirectionNameAttr:function(t){this.outputDirectionName=t},_getOutputDirectionNameAttr:function(){return this._outputDirectionLayerInput.get("value")},_setOutputAllocationNameAttr:function(t){this.outputAllocationName=t},_getOutputAllocationNameAttr:function(){return this._outputAllocationLayerInput.get("value")}});return _("extend-esri")&&d.setObject("dijit.analysis.CalculateDistance",D,t),D});