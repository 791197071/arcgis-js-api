// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/colorUtils","../../core/compilerUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./IconSymbol3DLayerResource","./ObjectSymbol3DLayerResource","./previewUtils","./renderUtils","./styleUtils","./utils"],function(e,a,r,t,s,l,i,o,n,h,p,u,c,m,f,v,d){function y(e){var a=e.outline,r=o.isSome(e.material)?e.material.color:null,t=o.isSome(r)?r.toRgba().toString():null;if(o.isNone(a))return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var s=h.pt2px(a.size)||0;return{color:"rgba("+(o.isSome(a.color)?a.color.toRgba():"255,255,255,1")+")",width:Math.min(s,H)}}function b(e,a){var r=a&&a.resource,t=r&&r.href;return e.thumbnail&&e.thumbnail.url?n.resolve(e.thumbnail.url):t&&"object"!==a.type?n.resolve(d.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?v.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch(function(e){return e}).then(function(e){return e&&e.thumbnail&&e.thumbnail.url||O}):n.resolve(O)}function g(e,a){void 0===a&&(a=1);var r=e.a,s=t.toHSV(e),l=s.h,i=s.s/a,o=100-(100-s.v)/a,n=t.toRGB({h:l,s:i,v:o});return[n.r,n.g,n.b,r]}function x(e,a){return Math.round(Math.min(Math.max(e+255*a*.75,0),255))}function w(e){return"water"===e.type?o.isNone(e.color)?null:e.color:o.isNone(e.material)||o.isNone(e.material.color)?null:e.material.color}function k(e,a){void 0===a&&(a=0);var r=w(e);if(!r){var t=p.defaultThematicColor.r,s=x(t,a);return[s,s,s,100]}for(var l=r.toRgba(),i=0;i<3;i++)l[i]=x(l[i],a);return l}function M(e){return e.outline?y(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function S(e,a){var r=w(e);if(!r)return null;var t="rgba(";return t+=x(r.r,a)+",",t+=x(r.g,a)+",",(t+=x(r.b,a)+",")+r.a+");"}function L(e,a){var r=S(e,a);return r?{color:r,width:Math.min(e.size?h.pt2px(e.size):.75,H)}:{}}function z(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function U(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&t<r}function j(e,a,r){var t=[];if(!e)return t;switch(e.type){case"icon":var l=a,i=a,o=e.resource&&e.resource.primitive||u.defaultPrimitive;switch(o){case"circle":t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:k(e,0),stroke:y(e)});break;case"square":t.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[0,0]},{command:"L",values:[l,0]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:k(e,0),stroke:y(e)});break;case"triangle":t.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[.5*l,0]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:k(e,0),stroke:y(e)});break;case"cross":t.push({shape:{type:"path",path:[{command:"M",values:[.5*l,0]},{command:"L",values:[.5*l,i]},{command:"M",values:[0,.5*i]},{command:"L",values:[l,.5*i]},{command:"E",values:[]}]},stroke:M(e)});break;case"x":t.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[l,i]},{command:"M",values:[l,0]},{command:"L",values:[0,i]},{command:"E",values:[]}]},stroke:M(e)});break;case"kite":t.push({shape:{type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*l,0]},{command:"L",values:[l,.5*i]},{command:"L",values:[.5*l,i]},{command:"Z",values:[]}]},fill:k(e,0),stroke:y(e)});break;default:s.neverReached(o)}break;case"object":var o=e.resource&&e.resource.primitive||c.defaultPrimitive;switch(o){case"cone":var n=k(e,0),h=k(e,-.6),p=r?A:a,f=z(n,h,p),v=m.getConeShapes(a,r);t.push({shape:v[0],fill:f}),t.push({shape:v[1],fill:f});break;case"inverted-cone":var d=k(e,0),b=k(e,-.6),g=z(d,b,a),x=m.getInvertedConeShapes(a);t.push({shape:x[0],fill:g}),t.push({shape:x[1],fill:d});break;case"cube":var w=m.getCubeShapes(a,r);t.push({shape:w[0],fill:k(e,0)}),t.push({shape:w[1],fill:k(e,-.3)}),t.push({shape:w[2],fill:k(e,-.5)});break;case"cylinder":var S=k(e,0),L=k(e,-.6),U=r?A:a,j=z(S,L,U),D=m.getCylinderShapes(a,r);t.push({shape:D[0],fill:j}),t.push({shape:D[1],fill:j}),t.push({shape:D[2],fill:k(e,0)});break;case"diamond":var R=m.getDiamondShapes(a);t.push({shape:R[0],fill:k(e,-.3)}),t.push({shape:R[1],fill:k(e,0)}),t.push({shape:R[2],fill:k(e,-.3)}),t.push({shape:R[3],fill:k(e,-.7)});break;case"sphere":var E=k(e,0),I=k(e,-.6),C=z(E,I);C.x1=0,C.y1=0,C.x2=.25*a,C.y2=.25*a,t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:C});break;case"tetrahedron":var O=m.getTetrahedronShapes(a);t.push({shape:O[0],fill:k(e,-.3)}),t.push({shape:O[1],fill:k(e,0)}),t.push({shape:O[2],fill:k(e,-.6)});break;default:s.neverReached(o)}}return t}function D(e){return"icon"===e.type?"multiply":"tint"}function R(e,a){var r,t=a&&a.size?h.pt2px(a.size):null,s=a&&a.maxSize?h.pt2px(a.maxSize):null,l=a&&a.disableUpsampling,i=e.symbolLayers,o=[],p=0,u=0,c=i.getItemAt(i.length-1);return c&&"icon"===c.type&&(r=c.size&&h.pt2px(c.size)),i.forEach(function(i,c){if("icon"===i.type||"object"===i.type){var m="icon"===i.type?i.size&&h.pt2px(i.size):0,v=t||m?Math.ceil(Math.min(t||m,s||N)):P,d="icon"===i.type?y(i):null,g=d?d.width:0;if(i&&i.resource&&i.resource.href){var x=b(e,i).then(function(e){var a=i.get("material.color"),r=D(i);return f.tintImageWithColor(e,v,a,r,l)}).then(function(e){var a=e.width,r=e.height;return p=Math.max(p,a+g+W),u=Math.max(u,r+g+W),[{shape:{type:"image",x:0,y:0,width:a,height:r,src:e.url},fill:null,stroke:null}]});o.unshift(x)}else{var w=v;"icon"===i.type&&r&&t&&(w=v*(m/r));var k=a&&"tall"===a.symbolConfig||"object"===i.type&&U(i);p=Math.max(p,k?A:w+g+W),u=Math.max(u,w+g+W),o.unshift(n.resolve(j(i,w,k)))}}}),n.eachAlways(o).then(function(e){var r=[];return e.forEach(function(e){e.value?r.push(e.value):e.error&&T.warn("error while building swatchInfo!",e.error)}),f.renderSymbol(r,[p,u],{node:a&&a.node,scale:!1,opacity:a&&a.opacity})})}function E(e,a){var t,s=e.symbolLayers,l=[],i=d.isVolumetricSymbol(e),o=a&&a.size?h.pt2px(a.size):null,p=a&&a.maxSize?h.pt2px(a.maxSize):null,u=p||H,c=0,v=0;return s.forEach(function(e,a){if(e&&("line"===e.type||"path"===e.type)){var s=[];switch(e.type){case"line":var i=L(e,0),n=i&&i.width||0;0===a&&(t=n);var h=Math.min(o||n,u),p=0===a?h:o?h*(n/t):h,f=p>P?p+W:q;v=Math.max(v,p),c=Math.max(c,f),i.width=p,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*v]},{command:"L",values:[c,.5*v]},{command:"E",values:[]}]},stroke:i});break;case"path":var d=Math.min(o||P,u),y=k(e,0),b=k(e,-.2),g=S(e,-.4),i=g?{color:g,width:1}:{};if("quad"===e.profile){var x=e.width||e.size,w=e.height||e.size,M=x&&w?x/w:1,z=m.getPathSymbolShapes(M),U=r({},i,{join:"bevel"});s.push({shape:z[0],fill:b,stroke:U}),s.push({shape:z[1],fill:b,stroke:U}),s.push({shape:z[2],fill:y,stroke:U})}else s.push({shape:m.shapes.pathSymbol3DLayer[0],fill:b,stroke:i}),s.push({shape:m.shapes.pathSymbol3DLayer[1],fill:y,stroke:i});v=Math.max(v,d+(i.width||0)+W),c=v}l.push(s)}}),n.resolve(f.renderSymbol(l,[c,v],{node:a&&a.node,scale:i,opacity:a&&a.opacity}))}function I(e,a){for(var t=e.type,s="mesh-3d"===t,l=e.symbolLayers,i=a&&a.size?h.pt2px(a.size):null,o=a&&a.maxSize?h.pt2px(a.maxSize):null,p=i||P,u=[],c=0,v=0,d=!1,b=0;b<l.length;b++){var x=l.getItemAt(b),M=[];if(!s||"fill"===x.type){var S=m.shapes.fill[0];switch(x.type){case"fill":var z=y(x),U=z&&z.width||0,j=Math.min(p,o||N);c=Math.max(c,j+U),v=Math.max(v,j+U),d=!0,M.push({shape:S,fill:k(x,0),stroke:z});break;case"line":var D=L(x,0),R=D&&D.width||0,E={stroke:D,shape:S};c=Math.max(c,P+R),v=Math.max(v,P+R),M.push(E);break;case"extrude":var I=r({join:"round"},L(x,-.4)),C=k(x,0),O=k(x,-.2),H=Math.min(p,o||N),q=m.getExtrudeSymbolShapes(H);I.width=1,M.push({shape:q[0],fill:O,stroke:I}),M.push({shape:q[1],fill:O,stroke:I}),M.push({shape:q[2],fill:C,stroke:I});var A=P,T=.7*P+.5*H;c=Math.max(c,A+I.width+W),v=Math.max(v,T+I.width+W);break;case"water":var Z=w(x),C=g(Z),V=g(Z,2),_=g(Z,3),B=m.getWaterSymbolShapes();d=!0,M.push({shape:B[0],fill:C}),M.push({shape:B[1],fill:V}),M.push({shape:B[2],fill:_});var j=Math.min(p,o||N);c=Math.max(c,j),v=Math.max(v,j)}u.push(M)}}return n.resolve(f.renderSymbol(u,[c,v],{node:a&&a.node,scale:d,opacity:a&&a.opacity}))}function C(e,a){if(0===e.symbolLayers.length)return n.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var r=null;switch(e.type){case"point-3d":r=R(e,a);break;case"line-3d":r=E(e,a);break;case"polygon-3d":case"mesh-3d":r=I(e,a)}return r||n.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var O=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),P=22,N=120,H=80,q=40,A=20,T=i.getLogger("esri.symbols.support.previewSymbol3D"),W=1;a.getSymbolLayerFill=k,a.previewSymbol3D=C});