// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../Color","../../core/Logger","../../geometry/support/jsonUtils","../cim/CIMCursor","../cim/CIMEffects","../cim/CIMOperators","../cim/CIMPlacements","./CIMSymbolDrawHelper","./packingUtils"],function(e,r,a,t,i,o,s,n,l,c,f){function m(e,r){switch(r.type){case"CIMSymbolReference":var a={type:"point",x:0,y:0};e.drawSymbol(r.symbol,a);break;case"CIMPointSymbol":var a={type:"point",x:0,y:0};e.drawSymbol(r,a);break;case"CIMVectorMarker":var t=new l.Placement;e.drawMarker(r,t)}return e.envelope()}Object.defineProperty(r,"__esModule",{value:!0});var y=Math.PI,h=y/2,v=t.getLogger("esri.symbols.cim.CIMSymbolHelper"),p=function(){function e(){}return e.getEnvelope=function(e){var r=new c.EnvDrawHelper;if(Array.isArray(e)){for(var a=void 0,t=0,i=e;t<i.length;t++){var o=i[t];a?a.union(m(r,o)):a=m(r,o)}return a}return m(r,e)},e.getTextureAnchor=function(e){var r=this.getEnvelope(e);if(!r||r.width<=0||r.height<=0)return[0,0];var a=(r.x+.5*r.width)*(96/72),t=-(r.y+.5*r.height)*(96/72);return[a/(r.width*(96/72)+2),t/(r.height*(96/72)+2)]},e.rasterize=function(e,r){var a=this.getEnvelope(r);if(!a||a.width<=0||a.height<=0)return[null,0,0];var t=(a.x+.5*a.width)*(96/72),i=-(a.y+.5*a.height)*(96/72);e.width=a.width*(96/72)+2,e.height=a.height*(96/72)+2;var o=e.getContext("2d"),s=c.Transformation.createScale(96/72,-96/72);s.translate(.5*e.width-t,.5*e.height-i);var n=new c.CanvasDrawHelper(o,s);switch(r.type){case"CIMPointSymbol":var f={type:"point",x:0,y:0};n.drawSymbol(r,f);break;case"CIMVectorMarker":var m=new l.Placement;n.drawMarker(r,m)}for(var y,h=o.getImageData(0,0,e.width,e.height),v=new Uint8Array(h.data),p=0;p<v.length;p+=4)y=v[p+3]/255,v[p]=v[p]*y,v[p+1]=v[p+1]*y,v[p+2]=v[p+2]*y;return[v,e.width,e.height]},e.fromSimpleMarker=function(e){var r,a,t=e.style;if("circle"===t||"esriSMSCircle"===t){var i=Math.acos(.995),o=Math.ceil(y/i/4);0===o&&(o=1),i=h/o,o*=4;var s=[];s.push([50,0]);for(var n=1;n<o;n++)s.push([50*Math.cos(n*i),-50*Math.sin(n*i)]);s.push([50,0]),r={rings:[s]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===t||"esriSMSCross"===t){var l=0;r={rings:[[[l,50],[l,l],[50,l],[50,-l],[l,-l],[l,-50],[-l,-50],[-l,-l],[-50,-l],[-50,l],[-l,l],[-l,50],[l,50]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("diamond"===t||"esriSMSDiamond"===t)r={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===t||"esriSMSSquare"===t)r={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===t||"esriSMSX"===t){var l=0;r={rings:[[[0,l],[50-l,50],[50,50-l],[l,0],[50,l-50],[50-l,-50],[0,-l],[l-50,-50],[-50,l-50],[-l,0],[-50,50-l],[l-50,50],[0,l]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("triangle"===t||"esriSMSTriangle"===t){var c=57.735026918962575,f=-c,m=2/3*100-100;r={rings:[[[f,m],[0,2/3*100],[c,m],[f,m]]]},a={xmin:f,ymin:m,xmax:c,ymax:2/3*100}}var v;if(r&&a){var p=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&p.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});var S={type:"CIMPolygonSymbol",symbolLayers:p};v={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:a,markerGraphics:[{type:"CIMMarkerGraphic",geometry:r,symbol:S}]}]}}return v},e.getFillColor=function(r){if(!r)return null;switch(r.type){case"CIMPolygonSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getFillColor(i);if(null!=o)return o}break;case"CIMTextSymbol":return e.getFillColor(r.symbol);case"CIMSolidFill":return r.color}},e.getStrokeColor=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getStrokeColor(i);if(void 0!==o)return o}break;case"CIMTextSymbol":return e.getStrokeColor(r.symbol);case"CIMSolidStroke":return r.color}},e.getStrokeWidth=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getStrokeWidth(i);if(void 0!==o)return o}break;case"CIMTextSymbol":return e.getStrokeWidth(r.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return r.width}},e.getSize=function(r){if(r)switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":var a=0;if(r.symbolLayers)for(var t=0,i=r.symbolLayers;t<i.length;t++){var o=i[t],s=e.getSize(o);s>a&&(a=s)}return a;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return r.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return r.size}},e.getMarkerScaleRatio=function(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){var r=e.frame.ymax-e.frame.ymin;return e.size/r}}return 1},e.executeEffects=function(e,r,a){void 0===a&&(a=!1);var t=e?e.length:0;t&&a&&--t;for(var i=0;i<t;++i){var o=e[i];if(o){var s=n.getEffectOperator(o);s&&(r=s.execute(r,o,96/72))}}return r},e.processEffects=function(r,a,t){var n;if(r.effects&&r.effects.length>0){var l=o.deltaEncodeGeometry(t);n=new s.SimpleGeometryCursor(l),n=e.executeEffects(r.effects,n)}var c=r.symbolLayers[a];if(c.effects&&c.effects.length>0){var f=!1;if("CIMGeometricEffectDashes"===c.effects[c.effects.length-1].type&&(f=!0),!n){var l=o.deltaEncodeGeometry(t);n=new s.SimpleGeometryCursor(l)}n=e.executeEffects(c.effects,n,f)}if(!n)return t;for(var m=[],y=n.next();y;)m.push(y),y=n.next();var h=m.length;switch(h){case 0:return null;case 1:return o.deltaEncodeGeometry(m[0]);default:for(var v=m[0],p=1;p<h;++p){var S=m[p];i.isPolygon(v)&&i.isPolygon(S)&&Array.prototype.push.apply(v.rings,S.rings),i.isPolyline(v)&&i.isPolyline(S)&&Array.prototype.push.apply(v.paths,S.paths)}return o.deltaEncodeGeometry(v)}},e}();r.CIMSymbolHelper=p;var S=function(){function e(){}return e.rasterizeSimpleFill=function(e,r){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization");e.width=8,e.height=8;var a=e.getContext("2d");a.strokeStyle="#FFFFFF",a.lineWidth=1,a.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(a.moveTo(0,0),a.lineTo(0,8)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(a.moveTo(0,0),a.lineTo(8,0)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(a.moveTo(0,0),a.lineTo(8,8)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(a.moveTo(8,0),a.lineTo(0,8)),a.stroke();for(var t,i=a.getImageData(0,0,e.width,e.height),o=new Uint8Array(i.data),s=0;s<o.length;s+=4)t=o[s+3]/255,o[s]=o[s]*t,o[s+1]=o[s+1]*t,o[s+2]=o[s+2]*t;return[o,e.width,e.height]},e.rasterizeSimpleLine=function(e,r,a){var t;switch(a){case"butt":t="Butt";break;case"square":t="Square";break;default:t="Round"}var i,o="Butt"===t;switch(r){case"dash":case"esriSLSDash":i=o?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":i=o?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":i=o?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":i=o?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":i=o?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":i=o?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":i=o?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":i=o?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":i=o?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":i=o?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":v.error("Unexpected: style does not require rasterization"),i=[0,0];break;default:v.error("Tried to rasterize SLS, but found an unexpected style: "+r+"!"),i=[0,0]}return this.rasterizeDash(e,i,t)},e.rasterizeDash=function(e,r,a){for(var t="Butt"===a,i="Square"===a,o=!t&&!i,s=0,n=0,l=r;n<l.length;n++){var c=l[n];s+=c}for(var m=15*s,y=31*m,h=new Float32Array(y),v=o?225:15,p=0;p<y;++p)h[p]=v;for(var S=0,u=0,d=!0,g=0,M=r;g<M.length;g++){var c=M[g];S=u,u+=15*c;for(var b=S;b<u;){for(var C=0;C<31;){var p=C*m+b,k=o?(C-15)*(C-15):Math.abs(C-15);h[p]=d?t?Math.max(Math.max(S+7.5-b,k),Math.max(b-u+7.5,k)):k:o?Math.min((b-S)*(b-S)+k,(b-u)*(b-u)+k):i?Math.min(Math.max(b-S,k),Math.max(u-b,k)):Math.min(Math.max(b-S+7.5,k),Math.max(u+7.5-b,k)),C++}b++}d=!d}for(var I=h.length,x=new Uint8Array(4*I),p=0;p<I;++p){var w=(o?Math.sqrt(h[p]):h[p])/15;f.packFloatRGBA(w,x,4*p)}return[x,m,31]},e}();r.SymbolHelper=S;var u=function(){function e(){}return e.findApplicableOverrides=function(r,a,t){if(a){if(r.primitiveName){for(var i=!1,o=0,s=t;o<s.length;o++){var n=s[o];if(n.primitiveName===r.primitiveName){i=!0;break}}if(!i)for(var l=0,c=a;l<c.length;l++){var n=c[l];n.primitiveName===r.primitiveName&&t.push(n)}}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(var f=0,m=r.effects;f<m.length;f++){var y=m[f];e.findApplicableOverrides(y,a,t)}if(r.symbolLayers)for(var h=0,v=r.symbolLayers;h<v.length;h++){var p=v[h];e.findApplicableOverrides(p,a,t)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(r.effects)for(var S=0,u=r.effects;S<u.length;S++){var y=u[S];e.findApplicableOverrides(y,a,t)}if(r.markerPlacement&&e.findApplicableOverrides(r.markerPlacement,a,t),"CIMVectorMarker"===r.type){if(r.markerGraphics)for(var d=0,g=r.markerGraphics;d<g.length;d++){var M=g[d];e.findApplicableOverrides(M,a,t),e.findApplicableOverrides(M.symbol,a,t)}}else"CIMCharacterMarker"===r.type?e.findApplicableOverrides(r.symbol,a,t):"CIMHatchFill"===r.type&&e.findApplicableOverrides(r.lineSymbol,a,t)}}},e.applyOverrides=function(r,a,t,i){if(a){if(r.primitiveName)for(var o=0,s=a;o<s.length;o++){var n=s[o];if(n.primitiveName===r.primitiveName){if(i&&i.push({cim:r,propertyName:n.propertyName,value:r[n.propertyName]}),n.expression&&(n.value=e.toValue(n.propertyName,n.expression)),t){for(var l=!1,c=0,f=t;c<f.length;c++){var m=f[c];m.primitiveName===r.primitiveName&&(l=!0)}l||t.push(n)}r[n.propertyName]=n.value}}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(var y=0,h=r.effects;y<h.length;y++){var v=h[y];e.applyOverrides(v,a,t,i)}if(r.symbolLayers)for(var p=0,S=r.symbolLayers;p<S.length;p++){var u=S[p];e.applyOverrides(u,a,t,i)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(r.effects)for(var d=0,g=r.effects;d<g.length;d++){var v=g[d];e.applyOverrides(v,a,t,i)}if("CIMVectorMarker"===r.type&&r.markerGraphics)for(var M=0,b=r.markerGraphics;M<b.length;M++){var C=b[M];e.applyOverrides(C,a,t,i),e.applyOverrides(C.symbol,a,t,i)}}}},e.restoreOverrides=function(e){for(var r=0,a=e;r<a.length;r++){var t=a[r];t.cim[t.propertyName]=t.value}},e.getOverride=function(r,a,t){if(a&&0!==a.length)for(var i=0,o=r;i<o.length;i++){var s=o[i];if(s.primitiveName===a&&s.propertyName===t)return e.toValue(t,s.value)}},e.buildOverrideKey=function(e){for(var r="",a=0,t=e;a<t.length;a++){var i=t[a];void 0!==i.value&&(r+=""+i.primitiveName+i.propertyName+JSON.stringify(i.value))}return r},e.toValue=function(e,r){if("dashTemplate"===e)return r.split(" ").map(function(e){return Number(e)});if("color"===e){var t=new a(r).toRgba();return t[3]*=255,t}return r},e}();r.OverrideHelper=u});