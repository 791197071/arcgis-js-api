// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/tsSupport/assignHelper","../../Color","../../core/Logger","../../core/promiseUtils","../../support/arcadeOnDemand","./CIMSymbolHelper","./enums","./SDFHelper","./utils","../../views/2d/arcade/utils"],function(e,t,r,n,i,o,a,s,l,c,u,f,h,m){function p(e){return e?{r:e[0],g:e[1],b:e[2],a:e[3]/255}:{r:0,g:0,b:0,a:0}}function y(e){switch(e){case"Butt":return u.CapType.BUTT;case"Square":return u.CapType.SQUARE;case"Round":default:return u.CapType.ROUND}}function d(e){switch(e){case"Bevel":return u.JoinType.BEVEL;case"Miter":return u.JoinType.MITER;case"Round":default:return u.JoinType.ROUND}}function g(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function v(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function S(e){var t="normal",r="normal";if(e){var n=e.toLowerCase();-1!==n.indexOf("italic")?t="italic":-1!==n.indexOf("oblique")&&(t="oblique"),-1!==n.indexOf("bold")?r="bold":-1!==n.indexOf("light")&&(r="lighter")}return{style:t,weight:r}}function b(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function C(e,t,i,o,a){return n(this,void 0,void 0,function(){var n,s,l,c;return r(this,function(r){switch(r.label){case 0:if(n=o||[],!e)return[2,n];switch("CIMSymbolReference"===e.type?(s=e.symbol,l=e.primitiveOverrides):(s=e,l=null),c=s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":return[3,1];case"CIMTextSymbol":return[3,3]}return[3,4];case 1:return[4,O(s,l,t,i,n,a)];case 2:return r.sent(),[3,4];case 3:return[3,4];case 4:return[2,n]}})})}function O(e,t,i,o,a,s){return n(this,void 0,void 0,function(){var n,l,f,h,m,p,y;return r(this,function(r){switch(r.label){case 0:if(!e)return[2];if(!(n=e.symbolLayers))return[2];f=c.CIMSymbolHelper.getSize(e),"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(l=u.Alignment.MAP),h=n.length,r.label=1;case 1:if(!h--)return[3,23];if(!(m=n[h])||!1===m.enable)return[3,1];switch(p=[],c.OverrideHelper.findApplicableOverrides(m,t,p),y=m.type){case"CIMSolidFill":return[3,2];case"CIMPictureFill":return[3,4];case"CIMHatchFill":return[3,6];case"CIMGradientFill":return[3,8];case"CIMSolidStroke":return[3,10];case"CIMPictureStroke":return[3,12];case"CIMGradientStroke":return[3,14];case"CIMCharacterMarker":return[3,16];case"CIMPictureMarker":return[3,17];case"CIMVectorMarker":return[3,19]}return[3,21];case 2:return[4,N(m,p,o,a)];case 3:return r.sent(),[3,22];case 4:return[4,w(m,p,o,a)];case 5:return r.sent(),[3,22];case 6:return[4,M(m,p,o,a)];case 7:return r.sent(),[3,22];case 8:return[4,k(m,p,o,a)];case 9:return r.sent(),[3,22];case 10:return[4,I(m,p,o,a,"CIMPolygonSymbol"===e.type,f)];case 11:return r.sent(),[3,22];case 12:return[4,H(m,p,o,a,"CIMPolygonSymbol"===e.type,f)];case 13:return r.sent(),[3,22];case 14:return[4,L(m,p,o,a,"CIMPolygonSymbol"===e.type,f)];case 15:return r.sent(),[3,22];case 16:return[3,22];case 17:return[4,P(m,p,o,a,l,f)];case 18:return r.sent(),[3,22];case 19:return[4,x(m,p,i,o,a,l,f,s)];case 20:return r.sent(),[3,22];case 21:j.error("Cannot analyze CIM layer",m.type),r.label=22;case 22:return[3,1];case 23:return[2]}})})}function N(e,t,i,o){return n(this,void 0,void 0,function(){var n,a,s,l,c,u;return r(this,function(r){switch(r.label){case 0:return n=e.primitiveName,a=p(e.color),s=h.hashString(JSON.stringify(e)).toString(),c=(l=o).push,u={type:"fill",templateHash:s,materialHash:0===t.length?s:function(e,t,r){return s},cim:e,materialOverrides:null,colorLocked:e.colorLocked},[4,T(n,"Color",t,i,a,A)];case 1:return c.apply(l,[(u.color=r.sent(),u.height=0,u.angle=0,u.offsetX=0,u.offsetY=0,u.scaleX=1,u)]),[2]}})})}function w(e,t,i,o){return n(this,void 0,void 0,function(){var n,a,s,l,c,u,f;return r(this,function(r){switch(r.label){case 0:return n=e.primitiveName,a=p(e.tintColor),s=h.hashString(JSON.stringify(e)).toString(),l=h.hashString(""+e.url+JSON.stringify(e.colorSubstitutions)).toString(),u=(c=o).push,f={type:"fill",templateHash:s,materialHash:0===t.length?l:function(e,t,r){return l},cim:e,materialOverrides:null,colorLocked:e.colorLocked},[4,T(n,"TintColor",t,i,a,A)];case 1:return f.color=r.sent(),[4,T(n,"Height",t,i,e.height)];case 2:return f.height=r.sent(),[4,T(n,"ScaleX",t,i,e.scaleX)];case 3:return f.scaleX=r.sent(),[4,T(n,"Rotation",t,i,e.rotation)];case 4:return f.angle=r.sent(),[4,T(n,"OffsetX",t,i,e.offsetX)];case 5:return f.offsetX=r.sent(),[4,T(n,"OffsetY",t,i,e.offsetY)];case 6:return u.apply(c,[(f.offsetY=r.sent(),f)]),[2]}})})}function M(e,t,i,o){return n(this,void 0,void 0,function(){var n,a,s,l,c,u,f,m;return r(this,function(r){switch(r.label){case 0:return n=["Rotation","OffsetX","OffsetY"],(a=t.filter(function(t){return t.primitiveName!==e.primitiveName&&-1===n.indexOf(t.propertyName)}),s=e.primitiveName,l=h.hashString(JSON.stringify(e)).toString(),u=(c=o).push,f={type:"fill",templateHash:l},0!==t.length)?[3,1]:(m=l,[3,3]);case 1:return[4,D(l,a,i)];case 2:m=r.sent(),r.label=3;case 3:return f.materialHash=m,f.cim=e,f.materialOverrides=a,f.colorLocked=e.colorLocked,f.color={r:128,g:128,b:128,a:1},f.height=0,f.scaleX=1,[4,T(s,"Rotation",t,i,e.rotation)];case 4:return f.angle=r.sent(),[4,T(s,"OffsetX",t,i,e.offsetX)];case 5:return f.offsetX=r.sent(),[4,T(s,"OffsetY",t,i,e.offsetY)];case 6:return u.apply(c,[(f.offsetY=r.sent(),f)]),[2]}})})}function k(e,t,i,o){return n(this,void 0,void 0,function(){var n,a,s,l,c;return r(this,function(r){switch(r.label){case 0:return n=h.hashString(JSON.stringify(e)).toString(),(s=(a=o).push,l={type:"fill",templateHash:n},0!==t.length)?[3,1]:(c=n,[3,3]);case 1:return[4,D(n,t,i)];case 2:c=r.sent(),r.label=3;case 3:return s.apply(a,[(l.materialHash=c,l.cim=e,l.materialOverrides=null,l.colorLocked=e.colorLocked,l.color={r:128,g:128,b:128,a:1},l.height=0,l.angle=0,l.offsetX=0,l.offsetY=0,l.scaleX=1,l)]),[2]}})})}function I(e,t,i,o,a,s){return n(this,void 0,void 0,function(){var n,l,c,u,f,m,g,v,S,b;return r(this,function(r){switch(r.label){case 0:return n=h.hashString(JSON.stringify(e)).toString(),l=e.primitiveName,c=p(e.color),u=void 0!==e.width?e.width:4,f=y(e.capStyle),m=d(e.joinStyle),g=e.miterLimit,S=(v=o).push,b={type:"line",templateHash:n,materialHash:0===t.length?n:function(e,t,r){return n},cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked},[4,T(l,"Color",t,i,c,A)];case 1:return b.color=r.sent(),[4,T(l,"Width",t,i,u)];case 2:return b.width=r.sent(),[4,T(l,"CapStyle",t,i,f)];case 3:return b.cap=r.sent(),[4,T(l,"JoinStyle",t,i,m)];case 4:return b.join=r.sent(),[4,T(l,"MiterLimit",t,i,g)];case 5:return S.apply(v,[(b.miterLimit=r.sent(),b.referenceWidth=s,b.zOrder=Y(e.name),b.isDashed=!1,b)]),[2]}})})}function H(e,t,i,o,a,s){return n(this,void 0,void 0,function(){var n,l,c,u,f,m,g,v,S,b,C;return r(this,function(r){switch(r.label){case 0:return n=h.hashString(""+e.url+JSON.stringify(e.colorSubstitutions)).toString(),l=e.primitiveName,c=p(e.tintColor),u=void 0!==e.width?e.width:4,f=y(e.capStyle),m=d(e.joinStyle),g=e.miterLimit,v=h.hashString(JSON.stringify(e)).toString(),b=(S=o).push,C={type:"line",templateHash:v,materialHash:0===t.length?n:function(e,t,r){return n},cim:e,materialOverrides:null,isOutline:a,colorLocked:e.colorLocked},[4,T(l,"TintColor",t,i,c,A)];case 1:return C.color=r.sent(),[4,T(l,"Width",t,i,u)];case 2:return C.width=r.sent(),[4,T(l,"CapStyle",t,i,f)];case 3:return C.cap=r.sent(),[4,T(l,"JoinStyle",t,i,m)];case 4:return C.join=r.sent(),[4,T(l,"MiterLimit",t,i,g)];case 5:return b.apply(S,[(C.miterLimit=r.sent(),C.referenceWidth=s,C.zOrder=Y(e.name),C.isDashed=!1,C)]),[2]}})})}function L(e,t,i,o,a,s){return n(this,void 0,void 0,function(){var n,l,c,u,f,m,p,g,v,S;return r(this,function(r){switch(r.label){case 0:return n=e.primitiveName,(l=void 0!==e.width?e.width:4,c=y(e.capStyle),u=d(e.joinStyle),f=e.miterLimit,m=h.hashString(JSON.stringify(e)).toString(),g=(p=o).push,v={type:"line",templateHash:m},0!==t.length)?[3,1]:(S=m,[3,3]);case 1:return[4,D(m,t,i)];case 2:S=r.sent(),r.label=3;case 3:return v.materialHash=S,v.cim=e,v.materialOverrides=null,v.isOutline=a,v.colorLocked=e.colorLocked,v.color={r:128,g:128,b:128,a:1},[4,T(n,"Width",t,i,l)];case 4:return v.width=r.sent(),[4,T(n,"CapStyle",t,i,c)];case 5:return v.cap=r.sent(),[4,T(n,"JoinStyle",t,i,u)];case 6:return v.join=r.sent(),[4,T(n,"MiterLimit",t,i,f)];case 7:return g.apply(p,[(v.miterLimit=r.sent(),v.referenceWidth=s,v.zOrder=Y(e.name),v.isDashed=!1,v)]),[2]}})})}function P(e,t,i,o,a,s){return n(this,void 0,void 0,function(){var n,l,c,u,f,m,y,d,g,v,S,b,C,O,N,w;return r(this,function(r){switch(r.label){case 0:for(n=e.primitiveName,l=e.size,c=e.scaleX,u=e.rotation,f=e.offsetX,m=e.offsetY,y=p(e.tintColor),d=h.hashString(""+e.url+JSON.stringify(e.colorSubstitutions)).toString(),g=!1,v="",S=0,b=t;S<b.length;S++)C=b[S],C.primitiveName===n&&(void 0!==C.value?v+="|"+C.primitiveName+"|"+C.propertyName+"|"+JSON.stringify(C.value):C.valueExpressionInfo&&(g=!0));return N=(O=o).push,w={type:"marker",templateHash:h.hashString(JSON.stringify(e)+v).toString(),materialHash:g?function(e,t,r){return d}:d,cim:e,materialOverrides:null,colorLocked:e.colorLocked,scaleSymbolsProportionally:!1,alignment:a,anchorPoint:e.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits},[4,T(n,"Size",t,i,l)];case 1:return w.size=r.sent(),[4,T(n,"ScaleX",t,i,c)];case 2:return w.scaleX=r.sent(),[4,T(n,"Rotation",t,i,u)];case 3:return w.rotation=r.sent(),[4,T(n,"OffsetX",t,i,f)];case 4:return w.offsetX=r.sent(),[4,T(n,"OffsetY",t,i,m)];case 5:return w.offsetY=r.sent(),[4,T(n,"TintColor",t,i,y,A)];case 6:return N.apply(O,[(w.color=r.sent(),w.outlineColor={r:0,g:0,b:0,a:0},w.outlineWidth=0,w.frameHeight=0,w.rotateClockwise=e.rotateClockwise,w.referenceSize=s,w.sizeRatio=1,w)]),[2]}})})}function x(e,t,i,o,a,l,c,u){return n(this,void 0,void 0,function(){var n,f,h,m,p,y,d,g;return r(this,function(r){switch(r.label){case 0:if(!(n=e.markerGraphics))return[2];for(f=0,e.scaleSymbolsProportionally&&(h=e.frame)&&(f=h.ymax-h.ymin),m=[],p=0,y=n;p<y.length;p++)if(d=y[p]){if(!(g=d.symbol))continue;switch(g.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":m.push(z(e,d,t,o,a,l,c,f,u));break;case"CIMTextSymbol":m.push(X(e,d,t,i,o,a,l,c,f))}}return[4,s.all(m)];case 1:return r.sent(),[2]}})})}function X(e,t,o,a,s,l,u,f,m){return n(this,void 0,void 0,function(){var n,y,d,C,O,N,w,M,k,I,H,L,P,x,X,z,J,R,Y,A,F,D,E,U;return r(this,function(r){switch(r.label){case 0:if(n=[],c.OverrideHelper.findApplicableOverrides(t,o,n),!("x"in(y=t.geometry)&&"y"in y))return[2];for(d=t.symbol,C=b(d),O=S(d.fontStyleName),d.font=i({family:d.fontFamilyName,decoration:C},O),N=e.frame,w=y.x-.5*(N.xmin+N.xmax),M=y.y-.5*(N.ymin+N.ymax),k=e.size/m,I=e.primitiveName,H=(d.height||0)*k,L=d.angle||0,P=((d.offsetX||0)+w)*k,x=((d.offsetY||0)+M)*k,X=p(c.CIMSymbolHelper.getFillColor(d)),z=p(c.CIMSymbolHelper.getStrokeColor(d)),J=c.CIMSymbolHelper.getStrokeWidth(d),J||(z=p(c.CIMSymbolHelper.getFillColor(d.haloSymbol)),J=d.haloSize*k),R="",Y=0,A=o;Y<A.length;Y++)F=A[Y],F.primitiveName===I&&void 0!==F.value&&(R+="|"+F.primitiveName+"|"+F.propertyName+"|"+JSON.stringify(F.value));return E=(D=l).push,U={type:"text",templateHash:h.hashString(JSON.stringify(t)+R).toString(),materialHash:function(e,t,r){return h.hashString(JSON.stringify(d.font)).toString()},cim:d,materialOverrides:null,colorLocked:e.colorLocked,alignment:u,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,fontName:d.fontFamilyName,decoration:"none",weight:"normal",style:"normal"},[4,T(I,"Height",o,s,H)];case 1:return U.size=r.sent(),[4,T(I,"Rotation",o,s,L)];case 2:return U.angle=r.sent(),[4,T(I,"OffsetX",o,s,P)];case 3:return U.offsetX=r.sent(),[4,T(I,"OffsetY",o,s,x)];case 4:return E.apply(D,[(U.offsetY=r.sent(),U.horizontalAlignment=g(d.horizontalAlignment),U.verticalAlignment=v(d.verticalAlignment),U.text=W(a,s,t.textString,d.textCase),U.color=X,U.outlineColor=z,U.outlineSize=J,U.referenceSize=f,U.sizeRatio=1,U)]),[2]}})})}function z(e,t,i,o,a,s,l,u,m){return n(this,void 0,void 0,function(){var n,y,d,g,v,S;return r(this,function(b){switch(b.label){case 0:if(n=t.symbol,!(y=t.geometry))return[2];if(d=f.getExtent(y),"CIMTextSymbol"===n.type)return[2];if(!(g=n.symbolLayers))return[2];v=g.length,S=function(){var n,S,b,C,O,N,w,M,k,I,H,L,P,x,X,z,R,Y,F,W,D,E,U,j,B,q,G,_,V;return r(this,function(r){switch(r.label){case 0:return n=g[v],n&&!1!==n.enable?m?[4,J(e,t,i,o,a,s,l,u)]:[3,2]:[2,"continue"];case 1:return r.sent(),[2,"continue"];case 2:switch(S=n.type){case"CIMSolidFill":case"CIMSolidStroke":return[3,3]}return[3,15];case 3:if(b=f.getSDFMetrics(d,e.frame,e.size,e.anchorPoint,"Relative"!==e.anchorPointUnits),C=b[0],O=b[1],N=b[2],w="CIMSolidFill"===n.type,M={type:"sdf",geom:y,asFill:w},k=e.primitiveName,I=e.size,H=e.rotation,L=e.offsetX,P=e.offsetY,x=n.primitiveName,X=p(w?c.CIMSymbolHelper.getFillColor(n):c.CIMSymbolHelper.getStrokeColor(n)),z=w?{r:0,g:0,b:0,a:0}:p(c.CIMSymbolHelper.getStrokeColor(n)),R=c.CIMSymbolHelper.getStrokeWidth(n),!w&&!R)return[3,16];for(Y=!1,F="",W=0,D=i;W<D.length;W++)E=D[W],E.primitiveName!==x&&E.primitiveName!==k||(void 0!==E.value?F+="|"+E.primitiveName+"|"+E.propertyName+"|"+JSON.stringify(E.value):E.valueExpressionInfo&&(Y=!0));return U=h.hashString(JSON.stringify(M)).toString(),j=h.hashString(JSON.stringify(n)+JSON.stringify(t)+F).toString(),q=(B=a).push,G={type:"marker",templateHash:j,materialHash:Y?function(e,t,r){return U}:U,cim:M,materialOverrides:null,colorLocked:e.colorLocked,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:O,y:N},isAbsoluteAnchorPoint:!1},[4,T(k,"Size",i,o,I)];case 4:return G.size=r.sent(),G.scaleX=1,[4,T(k,"Rotation",i,o,H)];case 5:return G.rotation=r.sent(),[4,T(k,"OffsetX",i,o,L)];case 6:return G.offsetX=r.sent(),[4,T(k,"OffsetY",i,o,P)];case 7:return G.offsetY=r.sent(),[4,T(x,"Color",i,o,X,A)];case 8:return G.color=r.sent(),w?(_={r:0,g:0,b:0,a:0},[3,11]):[3,9];case 9:return[4,T(x,"Color",i,o,z,A)];case 10:_=r.sent(),r.label=11;case 11:return G.outlineColor=_,w?(V=0,[3,14]):[3,12];case 12:return[4,T(x,"Width",i,o,R)];case 13:V=r.sent(),r.label=14;case 14:return q.apply(B,[(G.outlineWidth=V,G.frameHeight=u,G.rotateClockwise=e.rotateClockwise,G.referenceSize=l,G.sizeRatio=C,G)]),[3,16];case 15:return J(e,t,i,o,a,s,l,u),[3,16];case 16:return[2]}})},b.label=1;case 1:return v--?[5,S()]:[3,3];case 2:return b.sent(),[3,1];case 3:return[2]}})})}function J(e,t,i,o,a,s,l,u){return n(this,void 0,void 0,function(){var n,f,m,p,y,d,g,v,S,b,C,O,N,w,M,k;return r(this,function(r){switch(r.label){case 0:return n=R(e,t),(f=[],m=["Rotation","OffsetX","OffsetY"],f=i.filter(function(t){return t.primitiveName===e.primitiveName&&-1===m.indexOf(t.propertyName)}),p=c.CIMSymbolHelper.getTextureAnchor(n),y=p[0],d=p[1],g=JSON.stringify(n),v=e.primitiveName,S=e.rotation,b=e.offsetX,C=e.offsetY,O=h.hashString(JSON.stringify(n)).toString(),w=(N=a).push,M={type:"marker",templateHash:O},0!==f.length)?[3,1]:(k=O,[3,3]);case 1:return[4,D(g,f,o)];case 2:k=r.sent(),r.label=3;case 3:return M.materialHash=k,M.cim=n,M.materialOverrides=f,M.colorLocked=e.colorLocked,M.scaleSymbolsProportionally=e.scaleSymbolsProportionally,M.alignment=s,M.anchorPoint={x:y,y:d},M.isAbsoluteAnchorPoint=!1,M.size=e.size,M.scaleX=1,[4,T(v,"Rotation",i,o,S)];case 4:return M.rotation=r.sent(),[4,T(v,"OffsetX",i,o,b)];case 5:return M.offsetX=r.sent(),[4,T(v,"OffsetY",i,o,C)];case 6:return w.apply(N,[(M.offsetY=r.sent(),M.color={r:0,g:0,b:0,a:0},M.outlineColor={r:0,g:0,b:0,a:0},M.outlineWidth=0,M.frameHeight=u,M.rotateClockwise=e.rotateClockwise,M.referenceSize=l,M.sizeRatio=1,M)]),[2]}})})}function R(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function Y(e){if(e&&0===e.indexOf("Level_")){var t=parseInt(e.substr(6),10);if(NaN!==t)return t}return 0}function A(e){if(!e||0===e.length)return null;var t=new o(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function T(e,t,i,o,a,s){return n(this,void 0,void 0,function(){var n,c,u,f,h;return r(this,function(p){switch(p.label){case 0:if(!e)return[3,4];n=function(n){var i,c,u;return r(this,function(r){switch(r.label){case 0:return n.primitiveName!==e||n.propertyName!==t?[3,2]:void 0!==n.value?[2,{value:s?s(n.value):n.value}]:(i=n.valueExpressionInfo)?(c=i.expression,[4,l.createRendererExpression(c,o.spatialReference,o.fields)]):[3,2];case 1:return u=r.sent(),[2,{value:function(e,t,r){var n=m.callWithFeature(u,e,{$view:r},o.geometryType,t);return null!==n&&s&&(n=s(n)),null!==n?n:a}}];case 2:return[2]}})},c=0,u=i,p.label=1;case 1:return c<u.length?(f=u[c],[5,n(f)]):[3,4];case 2:if("object"==typeof(h=p.sent()))return[2,h.value];p.label=3;case 3:return c++,[3,1];case 4:return[2,a]}})})}function F(e,t){switch(t){case"LowerCase":return e.toLowerCase();case"Allcaps":return e.toUpperCase();default:return e}}function W(e,t,r,n){if(!e||-1===r.indexOf("["))return F(r,n);var i=" /-,\n",o=function(e){for(var t=e.length;t--;)if(-1===i.indexOf(e.charAt(t)))return!1;return!0},a=[],s=0,l=-1;do{if((l=r.indexOf("[",s))>=s){if(l>s){var c=r.substr(s,l-s);a.push([c,null,o(c)])}if(s=l+1,(l=r.indexOf("]",s))>=s){if(l>s){var u=r.substr(s,l-s),f=e[u];f&&a.push([null,f,!1])}s=l+1}}}while(-1!==l);if(s<r.length-1){var c=r.substr(s);a.push([c,null,o(c)])}return function(e,t,r){for(var i="",o=null,s=0,l=a;s<l.length;s++){var c=l[s],u=c[0],f=c[1],h=c[2];if(u)h?o=u:(o&&(i+=o,o=null),i+=u);else{var m=e.attributes[f];m&&(o&&(i+=o,o=null),i+=m)}}return F(i,n)}}function D(e,t,i){return n(this,void 0,void 0,function(){var n,o,a,s;return r(this,function(u){switch(u.label){case 0:n=function(e){var t,n,o;return r(this,function(r){switch(r.label){case 0:return(t=e.valueExpressionInfo)?(n=t.expression,[4,l.createRendererExpression(n,i.spatialReference,i.fields)]):[3,2];case 1:o=r.sent(),e.fn=function(e,t,r){return m.callWithFeature(o,e,{$view:r},i.geometryType,t)},r.label=2;case 2:return[2]}})},o=0,a=t,u.label=1;case 1:return o<a.length?(s=a[o],[5,n(s)]):[3,4];case 2:u.sent(),u.label=3;case 3:return o++,[3,1];case 4:return[2,function(r,n,i){for(var o=0,a=t;o<a.length;o++){var s=a[o];s.fn&&(s.value=s.fn(r,n,i))}return h.hashString(e+c.OverrideHelper.buildOverrideKey(t)).toString()}]}})})}function E(e,t,r){if(!r||0===r.length)return t;var n=JSON.parse(JSON.stringify(t));return c.OverrideHelper.applyOverrides(n,r),n}function U(e,t){}Object.defineProperty(t,"__esModule",{value:!0});var j=a.getLogger("esri.symbols.cim.cimAnalyzer");t.analyzeCIMSymbol=C,t.analyzeCIMResource=E,t.applyCIMLayerProperties=U});