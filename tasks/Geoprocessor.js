// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../request","../core/asyncUtils","../core/compilerUtils","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators","../geometry/Extent","../geometry/SpatialReference","../geometry/support/normalizeUtils","../layers/support/Field","../layers/support/MapImage","./Task","./support/DataFile","./support/FeatureSet","./support/GPMessage","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],function(e,t,r,a,o,n,u,s,i,c,l,p,f,v,d,m,y,h,b,S,G,g,P,J,O,_){return function(t){function b(e){var r=t.call(this)||this;return r._timers=new Map,r.outSpatialReference=null,r.processExtent=null,r.processSpatialReference=null,r.returnFeatureCollection=!1,r.returnM=!1,r.returnZ=!1,r.url=null,r}return a(b,t),b.prototype.destroy=function(){this._timers.forEach(function(e){clearInterval(e)})},b.prototype.cancelJob=function(e,t){var a=this.parsedUrl,o=a.path,n=a.query,u=r({},this.requestOptions,t,{query:r({},n,{f:"json"})});return this._clearTimer(e),s(o+"/jobs/"+e+"/cancel",u).then(function(e){return P.fromJSON(e.data)})},b.prototype.checkJobStatus=function(e,t){var a=this.parsedUrl,o=a.path,n=a.query,u=r({},this.requestOptions,t,{query:r({},n,{f:"json"})});return s(o+"/jobs/"+e,u).then(function(e){return P.fromJSON(e.data)})},b.prototype.execute=function(e,t){var r=this;return this._constructRequest("execute",e,t).then(function(e){var t=e.data.results||[],a=e.data.messages||[];return{results:t.map(r._decode),messages:a.map(function(e){return g.fromJSON(e)})}})},b.prototype.getResultData=function(e,t,a){var o=this,n=this.parsedUrl,u=n.path,i=n.query,c=r({},this.requestOptions,a,{query:r({},i,{returnType:"data",f:"json"})});return s(u+"/jobs/"+e+"/results/"+t,c).then(function(e){return o._decode(e.data)})},b.prototype.getResultImage=function(e,t,a,o){var n=this,u=this.parsedUrl,i=r({},u.query,a.toJSON(),{f:"json"}),c=this._gpEncode(i),l=r({},this.requestOptions,o,{query:c}),p=u.path+"/jobs/"+e+"/results/"+t;return s(p,l).then(function(e){return n._decode(e.data)})},b.prototype.getResultMapImageLayer=function(t){return u(this,void 0,void 0,function(){var r,a,o,u,s,i,c,f;return n(this,function(n){switch(n.label){case 0:return r=this.parsedUrl,a=r.path,o=r.query,u=a.indexOf("/GPServer/"),s=a.substring(0,u),i=o?"?"+p.objectToQuery(o):"",c=s+"/MapServer/jobs/"+t+i,[4,l.create(function(t){return e(["../layers/MapImageLayer"],t)})];case 1:return f=n.sent(),[2,new f({url:c})]}})})},b.prototype.submitJob=function(e,t){return this._constructRequest("submitJob",e,t).then(function(e){return P.fromJSON(e.data)})},b.prototype.waitForJobCompletion=function(e,t){var r=this;void 0===t&&(t={});var a=t.interval,o=void 0===a?1e3:a,n=t.signal,u=t.statusCallback;return l.create(function(t,a){l.onAbort(n,function(){r._clearTimer(e),a(l.createAbortError())}),r._clearTimer(e);var s=setInterval(function(){r._timers.has(e)||a(l.createAbortError()),r._getJobStatus(e,r.requestOptions).then(function(o){var n=o.jobStatus;switch(n){case"job-succeeded":r._clearTimer(e),t(o);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":u&&u(o);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":r._clearTimer(e),a(o);break;default:c.neverReached(n)}})},o);r._timers.set(e,s)})},b.prototype._clearTimer=function(e){this._timers.has(e)&&(clearInterval(this._timers.get(e)),this._timers.delete(e))},b.prototype._constructRequest=function(e,t,a){var o=this,n={},u={},c=[];return this._collectGeometries(t,c,n),i.safeCast(m.normalizeCentralMeridian(c)).then(function(i){var c=o,l=c.outSpatialReference,p=c.parsedUrl,f=c.processExtent,v=c.processSpatialReference,d=c.returnFeatureCollection,m=c.returnM,y=c.returnZ;for(var h in n){var b=n[h];u[h]=i.slice(b[0],b[1])}var S=l?l.wkid||l:null,G=v?v.wkid||v:null,g=f?{context:{extent:f,outSR:S,processSR:G}}:{"env:outSR":S,"env:processSR":G},P=r({},p.query,g,t,{returnFeatureCollection:d,returnM:m,returnZ:y,f:"json"}),J=o._gpEncode(P,null,u),O=r({},o.requestOptions,a,{query:J}),_=p.path+"/"+e;return s(_,O)})},b.prototype._collectGeometries=function(e,t,r){for(var a in e){var o=e[a];if(o&&"object"==typeof o&&o instanceof G){var n=o.features;r[a]=[t.length,t.length+n.length],n.forEach(function(e){t.push(e.geometry)})}}},b.prototype._decode=function(e){var t=e.dataType,r=O.fromJSON(e);switch(t){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":return r;case"GPDate":r.value=new Date(r.value);break;case"GPDataFile":r.value=S.fromJSON(r.value);break;case"GPLinearUnit":r.value=J.fromJSON(r.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":var a=e.value.url;r.value=a?S.fromJSON(r.value):G.fromJSON(r.value);break;case"GPRasterData":case"GPRasterDataLayer":var o=e.value.mapImage;r.value=o?h.fromJSON(o):_.fromJSON(r.value);break;case"GPField":r.value=y.fromJSON(r.value);break;case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return r;case"GPMultiValue:GPDate":var n=r.value;r.value=n.map(function(e){return new Date(e)});break;case"GPMultiValue:GPDataFile":r.value=r.value.map(function(e){return S.fromJSON(e)});break;case"GPMultiValue:GPLinearUnit":r.value=r.value.map(function(e){return J.fromJSON(e)});break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":r.value=r.value.map(function(e){return G.fromJSON(e)});break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":r.value=r.value.map(function(e){return e?h.fromJSON(e):_.fromJSON(r.value)});break;case"GPMultiValue:GPField":r.value=r.value.map(function(e){return y.fromJSON(e)});break;default:c.neverReached(t)}return r},b.prototype._gpEncode=function(e,t,r){var a=this;for(var o in e){var n=e[o];Array.isArray(n)?e[o]=JSON.stringify(n.map(function(e){return a._gpEncode({item:e},!0).item},this)):n instanceof Date&&(e[o]=n.getTime())}return this._encode(e,t,r)},b.prototype._getJobStatus=function(e,t){var a=this.parsedUrl,o=a.path,n=a.query,u=o+"/jobs/"+e,i=r({},this.requestOptions,t,{query:r({},n,{f:"json"})});return s(u,i).then(function(e){return P.fromJSON(e.data)})},o([f.property({type:d})],b.prototype,"outSpatialReference",void 0),o([f.property({type:v})],b.prototype,"processExtent",void 0),o([f.property({type:d})],b.prototype,"processSpatialReference",void 0),o([f.property()],b.prototype,"returnFeatureCollection",void 0),o([f.property()],b.prototype,"returnM",void 0),o([f.property()],b.prototype,"returnZ",void 0),o([f.property()],b.prototype,"url",void 0),b=o([f.subclass("esri/tasks/Geoprocessor")],b)}(f.declared(b))});