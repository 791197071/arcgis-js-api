// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/generatorHelper","dojox/gfx/canvas","../kernel","../request","../core/asyncUtils","../core/jsonMap","../core/lang","../core/promiseUtils","../core/screenUtils","../core/urlUtils","../core/accessorSupport/decorators","../geometry/Polygon","../renderers/visualVariables/support/visualVariableUtils","./Geoprocessor","./Task","./support/fileFormat","./support/layoutTemplate","./support/printTaskUtils","./support/PrintTemplate","./support/Query"],function(e,t,r,a,i,n,s,o,l,u,c,p,y,d,f,h,m,g,S,b,v,_,L,O,w,x){function N(e){return e&&(e.path||"image/svg+xml"===e.contentType)}var T={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},J=new p.default({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),M=new p.default({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),D=new x({returnGeometry:!0});return function(e){function t(t){var r=e.call(this,t)||this;return r._ssExtent=null,r._legendLayers=[],r._legendLayerNameMap={},r._gpServerUrl=null,r._cimVersion=null,r._is11xService=!1,r._gpMetadata=null,r.updateDelay=1e3,r}return i(t,e),Object.defineProperty(t.prototype,"_geoprocessor",{get:function(){return new b({url:this.url})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){return this._gpMetadata&&this._gpMetadata.executionType?M.fromJSON(this._gpMetadata.executionType):"sync"},enumerable:!0,configurable:!0}),t.prototype.execute=function(e,t){var r=this,a=this.url,i=a.lastIndexOf("/GPServer/");return i>0&&(a=a.slice(0,i+9)),d.resolve().then(function(){return r._gpServerUrl===a?{data:r._gpMetadata}:(r._gpServerUrl=a,u(a,{query:{f:"json"}}))}).then(function(t){return r._gpMetadata=t.data,r._cimVersion=r._gpMetadata.cimVersion,r._is11xService=!!r._cimVersion,c.safeCast(r._getGpPrintParams(e))}).then(function(e){var a=function(e){return"sync"===r.mode?e.results&&e.results[0]&&e.results[0].value:r._geoprocessor.getResultData(e.jobId,"Output_File",t).then(function(e){return e.value})};return"async"===r.mode?r._geoprocessor.submitJob(e,t).then(function(e){return r._geoprocessor.waitForJobCompletion(e.jobId,{interval:r.updateDelay}).then(a)}):r._geoprocessor.execute(e,t).then(a)})},t.prototype._createOperationalLayers=function(e,t){return a(this,void 0,void 0,function(){var r,a,i,n,o,l,u,c,p,p;return s(this,function(s){switch(s.label){case 0:r=[],a={layerView:null,printTemplate:t,view:e},i=0,t.preserveScale&&(i=t.outScale||e.scale),n=O.getVisibleLayerViews(e,i),o=0,l=n,s.label=1;case 1:return o<l.length?(u=l[o],c=u.layer,!c.loaded||O.isGroupLayer(c)?[3,26]:(p=void 0,a.layerView=u,O.isBingMapsLayer(c)?(p=this._createBingMapsLayerJSON(c,a),[3,25]):[3,2])):[3,27];case 2:return O.isCSVLayer(c)?[4,this._createCSVLayerJSON(c,a)]:[3,4];case 3:return p=s.sent(),[3,25];case 4:return O.isFeatureLayer(c)?[4,this._createFeatureLayerJSON(c,a)]:[3,6];case 5:return p=s.sent(),[3,25];case 6:return O.isGraphicsLayer(c)?[4,this._createGraphicsLayerJSON(c,a)]:[3,8];case 7:return p=s.sent(),[3,25];case 8:return O.isImageryLayer(c)?(p=this._createImageryLayerJSON(c,a),[3,25]):[3,9];case 9:return O.isKMLLayer(c)?[4,this._createKMLLayerJSON(c,a)]:[3,11];case 10:return p=s.sent(),[3,25];case 11:return O.isMapImageLayer(c)?(p=this._createMapImageLayerJSON(c,a),[3,25]):[3,12];case 12:return O.isMapNotesLayer(c)?[4,this._createMapNotesLayerJSON(c,a)]:[3,14];case 13:return p=s.sent(),[3,25];case 14:return O.isOpenStreetMapLayer(c)?(p=this._createOpenStreetMapLayerJSON(c,a),[3,25]):[3,15];case 15:return O.isStreamLayer(c)?[4,this._createStreamLayerJSON(c,a)]:[3,17];case 16:return p=s.sent(),[3,25];case 17:return O.isTileLayer(c)?(p=this._createTileLayerJSON(c,a),[3,25]):[3,18];case 18:return O.isVectorTileLayer(c)?[4,this._createVectorTileLayerJSON(c,a)]:[3,20];case 19:return p=s.sent(),[3,25];case 20:return O.isWebTileLayer(c)?(p=this._createWebTileLayerJSON(c,a),[3,25]):[3,21];case 21:return O.isWMSLayer(c)?(p=this._createWMSLayerJSON(c,a),[3,25]):[3,22];case 22:return O.isWMTSLayer(c)?(p=this._createWMTSLayerJSON(c,a),[3,25]):[3,23];case 23:return[4,this._createScreenshotJSON(c,a)];case 24:p=s.sent(),s.label=25;case 25:p&&(Array.isArray(p)?r.push.apply(r,p):(p.id=c.id,p.title=this._legendLayerNameMap[c.id]||c.title,p.opacity=c.opacity,p.minScale=c.minScale||0,p.maxScale=c.maxScale||0,r.push(p))),s.label=26;case 26:return o++,[3,1];case 27:return i&&r.forEach(function(e){e.minScale=0,e.maxScale=0}),e.graphics&&e.graphics.length?[4,this._createFeatureCollectionJSON(null,e.graphics,t)]:[3,29];case 28:p=s.sent(),p&&r.push(p),s.label=29;case 29:return[2,r]}})})},t.prototype._createBingMapsLayerJSON=function(e,t){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}},t.prototype._createCSVLayerJSON=function(e,t){var r=t.layerView,i=t.printTemplate;return a(this,void 0,void 0,function(){var t,a;return s(this,function(n){switch(n.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),this._is11xService?(t={type:"CSV"},e.write(t,{origin:"web-map"}),delete t.popupInfo,delete t.layerType,t.showLabels=i.showLabels&&e.labelsVisible,[3,3]):[3,1];case 1:return[4,this._getGraphics(r)];case 2:return a=n.sent(),[2,this._createFeatureCollectionJSON(e,a,i)];case 3:return[2,t]}})})},t.prototype._createFeatureCollectionJSON=function(e,t,r){return a(this,void 0,void 0,function(){var a,i,n,o,l,u,c,p,y,d,f,h,m,S,b,v,_,L=this;return s(this,function(w){switch(w.label){case 0:a=e,i=O.createPolygonLayer(),n=O.createPolylineLayer(),o=O.createPointLayer(),l=O.createMultipointLayer(),u=O.createPointLayer(),u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,a&&("esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass?i.layerDefinition.name=n.layerDefinition.name=o.layerDefinition.name=l.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(t=a.graphics.items)),c=a&&a.renderer&&"esri.renderer.SimpleRenderer"===a.renderer.declaredClass,a&&a.renderer&&"function"!=typeof a.get("renderer.field")?(p=a.renderer.toJSON(),i.layerDefinition.drawingInfo.renderer=p,n.layerDefinition.drawingInfo.renderer=p,o.layerDefinition.drawingInfo.renderer=p,l.layerDefinition.drawingInfo.renderer=p):(delete i.layerDefinition.drawingInfo,delete n.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo),y=a&&a.fields,d=a&&a.renderer,f=[],d&&"function"!=typeof a.get("renderer.field")&&("class-breaks"===d.type?(y||(y=[{name:d.field,type:"esriFieldTypeDouble"}],d.normalizationField&&y.push({name:d.normalizationField,type:"esriFieldTypeDouble"})),d.field&&f.push(d.field),d.normalizationField&&f.push(d.normalizationField)):"unique-value"===d.type&&(y||(y=[{name:d.field,type:"esriFieldTypeString"}],d.field2&&y.push({name:d.field2,type:"esriFieldTypeString"}),d.field3&&y.push({name:d.field3,type:"esriFieldTypeString"})),d.field&&f.push(d.field),d.field2&&f.push(d.field2),d.field3&&f.push(d.field3))),y&&(i.layerDefinition.fields=y,n.layerDefinition.fields=y,o.layerDefinition.fields=y,l.layerDefinition.fields=y),h=t&&t.length,S=function(e){var c,p,y,d;return s(this,function(s){switch(s.label){case 0:return c=t[e]||t.getItemAt(e),!1!==c.visible&&c.geometry?(m=c.toJSON(),m.hasOwnProperty("popupTemplate")&&delete m.popupTemplate,m.geometry&&m.geometry.z&&delete m.geometry.z,m.symbol&&m.symbol.outline&&"esriCLS"===m.symbol.outline.type&&!b._is11xService?[2,"continue"]:(m.symbol&&m.symbol.outline&&m.symbol.outline.color&&m.symbol.outline.color[3]&&!b._is11xService&&(m.symbol.outline.color[3]=255),a&&a.renderer&&!m.symbol&&("function"==typeof a.renderer.field||a.renderer.compiledFunc||a.renderer.hasVisualVariables())?(p=a.renderer,[4,p.getSymbolAsync(c)]):[3,2])):[2,"continue"];case 1:if(!(y=s.sent()))return[2,"continue"];m.symbol=y.toJSON(),p.hasVisualVariables()&&O.applyVisualVariables(m.symbol,{renderer:p,graphic:c,symbol:y}),s.label=2;case 2:return m.symbol&&(m.symbol.angle||delete m.symbol.angle,N(m.symbol)?m.symbol=b._convertSvgToPictureMarkerSymbolJson(m.symbol):m.symbol.text&&delete m.attributes),r&&r.forceFeatureAttributes||(a&&a.renderer&&"simple"===a.renderer.type?delete m.attributes:f.length&&(d={},f.forEach(function(e){m.attributes&&m.attributes.hasOwnProperty(e)&&(d[e]=m.attributes[e])}),m.attributes=d)),"polygon"===c.geometry.type?i.featureSet.features.push(m):"polyline"===c.geometry.type?n.featureSet.features.push(m):"point"===c.geometry.type?m.symbol&&m.symbol.text?u.featureSet.features.push(m):o.featureSet.features.push(m):"multipoint"===c.geometry.type?l.featureSet.features.push(m):"extent"===c.geometry.type&&(m.geometry=g.fromExtent(c.geometry).toJSON(),i.featureSet.features.push(m)),[2]}})},b=this,v=0,w.label=1;case 1:return v<h?[5,S(v)]:[3,4];case 2:w.sent(),w.label=3;case 3:return v++,[3,1];case 4:return _=[i,n,l,o,u].filter(function(e){return e.featureSet.features.length>0}),_.forEach(function(e){var t=e.featureSet.features.every(function(e){return e.symbol});!t&&!c||r&&r.forceFeatureAttributes||e.featureSet.features.forEach(function(e){delete e.attributes}),t&&delete e.layerDefinition.drawingInfo,e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&L._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)}),[2,_.length?{featureCollection:{layers:_}}:null]}})})},t.prototype._createFeatureLayerJSON=function(e,t){return a(this,void 0,void 0,function(){var r,a,i,n,o,l,u,c,p,y;return s(this,function(s){switch(s.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),(a=e.renderer)&&"dot-density"===a.type?[2,this._createScreenshotJSON(e,t)]:(i=t.layerView,n=t.printTemplate,o=t.view,l=a&&("valueExpression"in a&&a.valueExpression||"hasVisualVariables"in a&&a.hasVisualVariables()),u=e.source&&"feature-layer"!==e.source.type,!this._is11xService&&l||e.featureReduction||u||!a||"field"in a&&null!=a.field&&("string"!=typeof a.field||!e.getField(a.field))?[3,1]:(r={},this._setURLandToken(r,e),e.write(r,{origin:"web-map"}),delete r.layerType,delete r.popupInfo,delete r.visibility,r.showLabels=n.showLabels&&e.labelsVisible,r.layerDefinition&&r.layerDefinition.drawingInfo&&r.layerDefinition.drawingInfo.renderer&&(this._convertSvgRenderer(r.layerDefinition.drawingInfo.renderer),"visualVariables"in a&&a.visualVariables&&a.visualVariables[0]&&(c=a.visualVariables[0],"size"===c.type&&c.maxSize&&"number"!=typeof c.maxSize&&c.minSize&&"number"!=typeof c.minSize&&(p=S.getSizeRangeAtScale(c,o.scale),r.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=p.minSize,r.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=p.maxSize))),[3,4]));case 1:return[4,this._getGraphics(i)];case 2:return y=s.sent(),[4,this._createFeatureCollectionJSON(e,y,n)];case 3:r=s.sent(),s.label=4;case 4:return[2,r]}})})},t.prototype._createGraphicsLayerJSON=function(e,t){var r=t.printTemplate;return a(this,void 0,void 0,function(){return s(this,function(t){return[2,this._createFeatureCollectionJSON(e,null,r)]})})},t.prototype._createImageryLayerJSON=function(e,t){this._legendLayers&&this._legendLayers.push({id:e.id});var r={bandIds:e.bandIds,compressionQuality:e.compressionQuality,format:e.format,interpolation:e.interpolation};return e.mosaicRule&&(r.mosaicRule=e.mosaicRule.toJSON()),e.renderingRule&&(r.renderingRule=e.renderingRule.toJSON()),this._setURLandToken(r,e),r},t.prototype._createKMLLayerJSON=function(e,t){return a(this,void 0,void 0,function(){var a,i,n,o,l,u,c;return s(this,function(s){switch(s.label){case 0:return a=t.printTemplate,this._is11xService?(i={type:"kml"},e.write(i,{origin:"web-map"}),delete i.layerType,i.url=h.normalize(e.url),[2,i]):(n=[],o=t.layerView,o.allVisibleMapImages.forEach(function(t,r){var a={id:e.id+"_image"+r,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:e.opacity,extent:t.extent};"data:image/png;base64,"===t.href.substr(0,22)?a.imageData=t.href.substr(22):a.url=t.href,n.push(a)}),l=o.allVisiblePoints.items.concat(o.allVisiblePolylines.items,o.allVisiblePolygons.items),c=[{id:e.id}],[4,this._createFeatureCollectionJSON(null,l,a)]);case 1:return u=r.apply(void 0,c.concat([s.sent()])),n.push(u),[2,n]}})})},t.prototype._createMapImageLayerJSON=function(e,t){var r,a=t.view,i={id:e.id,subLayerIds:[]},n=[],s=a.scale,o=function(e){var t=0===s,r=0===e.minScale||s<=e.minScale,a=0===e.maxScale||s>=e.maxScale;if(e.visible&&(t||r&&a))if(e.sublayers)e.sublayers.forEach(o);else{var l=e.toExportImageJSON().drawingInfo,u=e.toJSON();u.layerDefinition.drawingInfo=l,n.unshift(u),i.subLayerIds.push(e.id)}};return e.sublayers&&e.sublayers.forEach(o),n.length&&(n=n.map(function(e){return{id:e.id,name:e.name,layerDefinition:e.layerDefinition}}),r={layers:n,visibleLayers:i.subLayerIds},this._setURLandToken(r,e),this._legendLayers.push(i)),r},t.prototype._createMapNotesLayerJSON=function(e,t){var r=t.layerView,i=t.printTemplate;return a(this,void 0,void 0,function(){var e,t,a,n,o;return s(this,function(s){switch(s.label){case 0:e=[],t=0,a=r.graphicsViews,s.label=1;case 1:return t<a.length?(n=a[t],[4,this._createFeatureCollectionJSON(n,n.graphics,i)]):[3,4];case 2:o=s.sent(),o&&e.push.apply(e,o.featureCollection.layers),s.label=3;case 3:return t++,[3,1];case 4:return[2,{featureCollection:{layers:e}}]}})})},t.prototype._createOpenStreetMapLayerJSON=function(e,t){return{type:"OpenStreetMap"}},t.prototype._createScreenshotJSON=function(e,t){var r=t.printTemplate,i=t.view;return a(this,void 0,void 0,function(){var t,a,n,o,l,u,c,p,y,d;return s(this,function(s){switch(s.label){case 0:return t={type:"image"},a={format:"png",ignoreBackground:!0,layers:[e],rotation:0},n=this._ssExtent||i.extent.clone(),o=96,l=!0,u=!0,r.exportOptions&&(c=r.exportOptions,c.dpi>0&&(o=c.dpi),c.width>0&&(l=c.width%2==i.width%2),c.height>0&&(u=c.height%2==i.height%2)),"map-only"!==r.layout||!r.preserveScale||r.outScale&&r.outScale!==i.scale||96!==o||l&&u||(a.area={x:0,y:0,width:i.width,height:i.height},l||(a.area.width-=1),u||(a.area.height-=1),this._ssExtent||(p=i.toMap(f.createScreenPoint(a.area.width,a.area.height)),n.ymin=p.y,n.xmax=p.x,this._ssExtent=n)),t.extent=n.clone()._normalize(!0).toJSON(),[4,i.takeScreenshot(a)];case 1:return y=s.sent(),d=h.dataComponents(y.dataUrl),t.imageData=d.data,[2,t]}})})},t.prototype._createStreamLayerJSON=function(e,t){var r=t.layerView,i=t.printTemplate;return a(this,void 0,void 0,function(){var t;return s(this,function(a){switch(a.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),[4,this._getGraphics(r)];case 1:return t=a.sent(),[2,this._createFeatureCollectionJSON(e,t,i)]}})})},t.prototype._createTileLayerJSON=function(e,t){var r={};return this._setURLandToken(r,e),r},t.prototype._createVectorTileLayerJSON=function(e,t){return a(this,void 0,void 0,function(){var r,a,i;return s(this,function(n){return this._is11xService&&e.serviceUrl&&e.styleUrl&&(r=l.id&&l.id.findCredential(e.styleUrl),a=l.id&&l.id.findCredential(e.serviceUrl),!r&&!a||"2.1.0"!==this._cimVersion)?(i={type:"VectorTileLayer"},i.styleUrl=h.normalize(e.styleUrl),r&&(i.token=r.token),a&&a.token!==i.token&&(i.additionalTokens=[{url:e.serviceUrl,token:a.token}]),[2,i]):[2,this._createScreenshotJSON(e,t)]})})},t.prototype._createWebTileLayerJSON=function(e,t){var r=e.urlTemplate.replace(/\${/g,"{"),a={type:"WebTiledLayer",urlTemplate:r,credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(a.subDomains=e.subDomains),a},t.prototype._createWMSLayerJSON=function(e,t){var r,a=[],i=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(i):e.name&&a.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(i),a.length&&(r={type:"wms",transparentBackground:e.imageTransparency,visibleLayers:a,url:h.normalize(e.url),version:e.version}),r},t.prototype._createWMTSLayerJSON=function(e,t){var r=e.activeLayer;return{type:"wmts",format:r.imageFormat,layer:r.id,style:r.styleId,tileMatrixSet:r.tileMatrixSetId,url:h.normalize(e.url)}},t.prototype._setURLandToken=function(e,t){if(t.url){e.url=h.normalize(t.url);var r=l.id&&l.id.findCredential(t.url);r&&(e.token=r.token)}},t.prototype._convertSvgToPictureMarkerSymbolJson=function(e){this._canvasParent?(this._canvasSurface.clear(),this._canvasSurface.setDimensions(1024,1024)):(this._canvasParent=document.createElement("div"),this._canvasSurface=o.createSurface(this._canvasParent,1024,1024));var t;t="image/svg+xml"===e.contentType?this._canvasSurface.createObject(o.Image,{src:"data:image/svg+xml;base64,"+e.imageData,width:f.pt2px(e.width),height:f.pt2px(e.height),x:0,y:0}):this._canvasSurface.createObject(o.Path,e.path).setFill(e.color).setStroke(e.outline),"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var r=this._canvasSurface.rawNode.getContext("2d"),a=t.getBoundingBox(),i=Math.ceil(a.width+a.x),n=Math.ceil(a.height+a.y),s=r.getImageData(a.x,a.y,i,n);r.canvas.width=i,r.canvas.height=n,r.putImageData(s,0,0);return{type:"esriPMS",imageData:r.canvas.toDataURL("image/png").substr(22),angle:e.angle,contentType:"image/png",height:e.size?e.size:n-a.y,width:e.size?e.size:i-a.x,xoffset:e.xoffset,yoffset:e.yoffset}},t.prototype._convertSvgRenderer=function(e){var t=this,r=e.type;if("simple"===r&&N(e.symbol))e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol);else if("unique-value"===r||"class-breaks"===r){N(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol));var a="unique-value"===r?"uniqueValueInfos":"classBreakInfos",i=e[a];i&&i.forEach(function(e){N(e.symbol)&&(e.symbol=t._convertSvgToPictureMarkerSymbolJson(e.symbol))})}},t.prototype._getGraphics=function(e){return e.queryFeatures(D).then(function(e){return e.features})},t.prototype._getPrintDefinition=function(e,t){return a(this,void 0,void 0,function(){var r,a,i,n,o;return s(this,function(s){switch(s.label){case 0:return r=e.view,a=r.spatialReference,n={},[4,this._createOperationalLayers(r,t)];case 1:return n.operationalLayers=s.sent(),i=n,o=this._ssExtent||e.extent||r.extent,a&&a.isWrappable&&(o=o.clone()._normalize(!0),a=o.spatialReference),i.mapOptions={extent:o&&o.toJSON(),spatialReference:a&&a.toJSON(),showAttribution:t.attributionVisible},this._ssExtent=null,r.rotation&&(i.mapOptions.rotation=-r.rotation),t.preserveScale&&(i.mapOptions.scale=t.outScale||r.scale),[2,i]}})})},t.prototype._getGpPrintParams=function(e){return a(this,void 0,void 0,function(){var t,r,a,i,n,o,l,u,c,p,d,f,h,m,g,S,b,v,O,x=this;return s(this,function(s){switch(s.label){case 0:return t=e.template||new w,null==t.showLabels&&(t.showLabels=!0),r=t.exportOptions,i=L.toJSON(t.layout),r&&(n=r.dpi,a={dpi:n},"map_only"!==i.toLowerCase()&&""!==i||(o=r.width,l=r.height,a.outputSize=[o,l])),u=t.layoutOptions,u&&(p=void 0,d=void 0,"Miles"===u.scalebarUnit||"Kilometers"===u.scalebarUnit?(p="Kilometers",d="Miles"):"Meters"!==u.scalebarUnit&&"Feet"!==u.scalebarUnit||(p="Meters",d="Feet"),c={titleText:u.titleText,authorText:u.authorText,copyrightText:u.copyrightText,customTextElements:u.customTextElements,scaleBarOptions:{metricUnit:J.toJSON(p),metricLabel:T[p],nonMetricUnit:J.toJSON(d),nonMetricLabel:T[d]}}),f=null,u&&u.legendLayers&&(f=u.legendLayers.map(function(e){x._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t})),[4,this._getPrintDefinition(e,t)];case 1:return h=s.sent(),h.operationalLayers&&(g=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),S=/[\u0600-\u06FF]/,b=function(e){var t=e.text,r=e.font,a=r&&r.family&&r.family.toLowerCase();t&&r&&("arial"===a||"arial unicode ms"===a)&&(r.family=g.test(t)?"Arial Unicode MS":"Arial","normal"!==r.style&&S.test(t)&&(r.family="Arial Unicode MS"))},h.operationalLayers.forEach(function(e){e.featureCollection&&e.featureCollection.layers&&e.featureCollection.layers.forEach(function(e){e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&e.layerDefinition.drawingInfo.renderer.symbol&&(m=e.layerDefinition.drawingInfo.renderer,"esriTS"===m.symbol.type&&b(m.symbol)),e.featureSet&&e.featureSet.features&&e.featureSet.features.forEach(function(e){e.symbol&&"esriTS"===e.symbol.type&&b(e.symbol)})})})),e.outSpatialReference&&(h.mapOptions.spatialReference=e.outSpatialReference.toJSON()),y.mixin(h,{exportOptions:a,layoutOptions:c}),y.mixin(h.layoutOptions,{legendOptions:{operationalLayers:null!=f?f:this._legendLayers.slice()}}),this._legendLayers.length=0,v=JSON.stringify(h),O={Web_Map_as_JSON:v,Format:_.toJSON(t.format),Layout_Template:i},e.extraParameters&&y.mixin(O,e.extraParameters),[2,O]}})})},n([m.property({dependsOn:["url"]})],t.prototype,"_geoprocessor",null),n([m.property()],t.prototype,"_gpMetadata",void 0),n([m.property({dependsOn:["_gpMetadata"],readOnly:!0})],t.prototype,"mode",null),n([m.property()],t.prototype,"updateDelay",void 0),t=n([m.subclass("esri.tasks.PrintTask")],t)}(m.declared(v))});