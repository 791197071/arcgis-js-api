// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../Color","../../../Graphic","../../../core/Logger","../../support/utils","./sizeVariableUtils","../../../support/arcadeUtils"],function(e,a,i,r,n,t,l,s){function u(e,a,r){var n="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"color"===e.type})[0]:e;if(n){if("esri.renderers.visualVariables.ColorVariable"!==n.declaredClass)return void N.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");var t="number"==typeof a,l=t?null:a,u=l&&l.attributes,o=t?a:null,c=n.field,v=n.cache,f=v.ipData,p=v.hasExpression,d=n.cache.compiledFunc;if(!c&&!p){var b=n.stops;return b&&b[0]&&b[0].color}if("number"!=typeof o)if(p){var h=r&&{viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},V=s.getViewInfo(h),m=s.createExecContext(l,V);if(!d){var g=s.createSyntaxTree(n.valueExpression);d=s.createFunction(g),n.cache.compiledFunc=d}o=s.executeFunction(d,m)}else u&&(o=u[c]);var x=n.normalizationField,y=u?parseFloat(u[x]):void 0;if(null!=o&&(!x||t||!isNaN(y)&&0!==y)){isNaN(y)||t||(o/=y);var z=M(o,f);if(z){var w=z[0],S=z[1],F=w===S?n.stops[w].color:i.blendColors(n.stops[w].color,n.stops[S].color,z[2],r&&r.color);return new i(F)}}}}function o(e,a,i){var r="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"opacity"===e.type})[0]:e;if(r){if("esri.renderers.visualVariables.OpacityVariable"!==r.declaredClass)return void N.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");var n="number"==typeof a,t=n?null:a,l=t&&t.attributes,u=n?a:null,o=r.field,c=r.cache,v=c.ipData,f=c.hasExpression,p=r.cache.compiledFunc;if(!o&&!f){var d=r.stops;return d&&d[0]&&d[0].opacity}if("number"!=typeof u)if(f){var b=i&&{viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},h=s.getViewInfo(b),V=s.createExecContext(t,h);if(!p){var m=s.createSyntaxTree(r.valueExpression);p=s.createFunction(m),r.cache.compiledFunc=p}u=s.executeFunction(p,V)}else l&&(u=l[o]);var g=r.normalizationField,x=l?parseFloat(l[g]):void 0;if(null!=u&&(!g||n||!isNaN(x)&&0!==x)){isNaN(x)||n||(u/=x);var y=M(u,v);if(y){var z=y[0],w=y[1];if(z===w)return r.stops[z].opacity;var S=r.stops[z].opacity;return S+(r.stops[w].opacity-S)*y[2]}}}}function c(e,a,i){var r="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"rotation"===e.type})[0]:e;if(r){if("esri.renderers.visualVariables.RotationVariable"!==r.declaredClass)return void N.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");var n=r.axis||"heading",t="heading"===n&&"arithmetic"===r.rotationType?90:0,l="heading"===n&&"arithmetic"===r.rotationType?-1:1,u="number"==typeof a?null:a,o=u&&u.attributes,c=r.field,v=r.cache.hasExpression,f=r.cache.compiledFunc,p=0;if(!c&&!v)return p;if(v){var d=i&&{viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},b=s.getViewInfo(d),h=s.createExecContext(u,b);if(!f){var V=s.createSyntaxTree(r.valueExpression);f=s.createFunction(V),r.cache.compiledFunc=f}p=s.executeFunction(f,h)}else o&&(p=o[c]||0);return p="number"!=typeof p||isNaN(p)?null:t+l*p}}function v(e,a,i){var r="number"==typeof a,n=r?null:a,t=n&&n.attributes,u=r?a:null,o=e.cache.isScaleDriven,c=e.cache.compiledFunc;if(o){var v=i&&i.scale,p=i&&i.view;u=null==v||p&&"3d"===p.type?f(e):v}else if(!r)switch(e.inputValueType){case"expression":var d=i&&{viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},b=s.getViewInfo(d),h=s.createExecContext(n,b);if(!c){var V=s.createSyntaxTree(e.valueExpression);c=s.createFunction(V),e.cache.compiledFunc=c}u=s.executeFunction(c,h);break;case"field":t&&(u=t[e.field]);break;case"unknown":u=null}if(!l.isValidNumber(u))return null;if(r||!e.normalizationField)return u;var m=t?parseFloat(t[e.normalizationField]):null;return l.isValidNumber(m)&&0!==m?u/m:null}function f(e){var a=null,i=null,r=e.stops;return r?(a=r[0].value,i=r[r.length-1].value):(a=e.minDataValue||0,i=e.maxDataValue||0),(a+i)/2}function p(e,a,i){var r="visualVariables"in e&&e.visualVariables?e.visualVariables.filter(function(e){return"size"===e.type})[0]:e;if(r){if("esri.renderers.visualVariables.SizeVariable"!==r.declaredClass)return void N.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");var n=v(r,a,i),t=w(n,r,a,i,r.cache.ipData);return null===t||void 0===t||isNaN(t)?0:t}}function d(e,a,i){return null==e?null:l.isSizeVariable(e)?p(e,a,i):l.isValidNumber(e)?e:null}function b(e,a,i){return l.isValidNumber(i)&&e>i?i:l.isValidNumber(a)&&e<a?a:e}function h(e,a,i,r){return e+(d(a.minSize,i,r)||a.minDataValue)}function V(e,a,i){var r=e.stops,n=r&&r.length&&r[0].size;return null==n&&(n=e.minSize),d(n,a,i)}function m(e,a,i,r){var n=(e-a.minDataValue)/(a.maxDataValue-a.minDataValue),t=d(a.minSize,i,r),l=d(a.maxSize,i,r),s=r&&r.shape;if(e<=a.minDataValue)return t;if(e>=a.maxDataValue)return l;if("area"===a.scaleBy&&s){var u="circle"===s,o=u?D*Math.pow(t/2,2):t*t,c=u?D*Math.pow(l/2,2):l*l,v=o+n*(c-o);return u?2*Math.sqrt(v/D):Math.sqrt(v)}return t+n*(l-t)}function g(e,a,i,r){var n=r&&r.shape,t=e/a.minDataValue,l=d(a.minSize,i,r),s=d(a.maxSize,i,r),u=null;return u="circle"===n?2*Math.sqrt(t*Math.pow(l/2,2)):"square"===n||"diamond"===n||"image"===n?Math.sqrt(t*Math.pow(l,2)):t*l,b(u,l,s)}function x(e,a,i,r,n){var t=M(e,n),l=t[0],s=t[1],u=t[2];if(l===s)return d(a.stops[l].size,i,r);var o=d(a.stops[l].size,i,r);return o+(d(a.stops[s].size,i,r)-o)*u}function y(e,a,i,r){var n=r&&r.resolution?r.resolution:1,l=n*t.meterIn[a.valueUnit],s=d(a.minSize,i,r),u=d(a.maxSize,i,r),o=a.valueRepresentation,c=null;return c="area"===o?2*Math.sqrt(e/D)/l:"radius"===o||"distance"===o?2*e/l:e/l,b(c,s,u)}function z(e){return e}function w(e,a,i,r,n){switch(a.transformationType){case"additive":return h(e,a,i,r);case"constant":return V(a,i,r);case"clamped-linear":return m(e,a,i,r);case"proportional":return g(e,a,i,r);case"stops":return x(e,a,i,r,n);case"real-world-size":return y(e,a,i,r);case"identity":return z(e);case"unknown":return null}}function S(e,a,i){var r=e.cache.isScaleDriven,n=i&&"3d"===i.type;if(!(r&&n||a))return null;var t={scale:a,view:i},l=d(e.minSize,E,t),s=d(e.maxSize,E,t);if(null!=l||null!=s){if(l>s){var u=s;s=l,l=u}return{minSize:l,maxSize:s}}}function F(e,a,i){if(e.visualVariables){for(var r=[],n=[],t=[],l=[],s=[],v=0,f=e.visualVariables;v<f.length;v++){var d=f[v];switch(d.type){case"color":n.push(d);break;case"opacity":t.push(d);break;case"rotation":s.push(d);break;case"size":l.push(d)}}return n.forEach(function(e){var n=u(e,a,i);r.push({variable:e,value:n})}),t.forEach(function(e){var n=o(e,a,i);r.push({variable:e,value:n})}),s.forEach(function(e){var n=c(e,a,i);r.push({variable:e,value:n})}),l.forEach(function(e){var n=p(e,a,i);r.push({variable:e,value:n})}),r.filter(function(e){return null!=e.value})}}function M(e,a){if(a){var i=0,r=a.length-1;return a.some(function(a,n){return e<a?(r=n,!0):(i=n,!1)}),[i,r,(e-a[i])/(a[r]-a[i])]}}Object.defineProperty(a,"__esModule",{value:!0});var N=n.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),E=new r,D=Math.PI;a.getColor=u,a.getOpacity=o,a.getRotationAngle=c,a.getSize=p,a.getSizeFromNumberOrVariable=d,a.getSizeForValue=w,a.getSizeRangeAtScale=S,a.getVisualVariableValues=F});