// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/promiseUtils","../../utils","../../../../support/heatmapUtils","../../../../../support/arcadeOnDemand","../../../../../tasks/support/ClassBreaksDefinition","../../../../../tasks/support/generateRendererUtils"],function(e,a,n,t,r,i,o,l,u,s){function c(e,a){var n=e&&e.features,t=n&&n[0]&&n[0].attributes,r={};for(var i in t)r[i.replace(O,"").toLowerCase()]=t[i];return r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),a&&(["min","max","avg","stddev","sum","variance"].forEach(function(e){null!=r[e]&&(r[e]=Math.ceil(r[e]))}),r.min===r.max&&null!=r.min&&(r.avg=r.min,r.stddev=r.variance=0)),r}function m(e,a,r){return t(this,void 0,void 0,function(){var t,i;return n(this,function(n){switch(n.label){case 0:return[4,v(e,a)];case 1:return t=n.sent(),t=f(t,e.minValue,e.maxValue),i=d(t,!e.normalizationType),r&&["avg","stddev","variance"].forEach(function(e){null!=i[e]&&(i[e]=Math.ceil(i[e]))}),[2,i]}})})}function f(e,a,n){return a=null==a?-1/0:a,n=null==n?1/0:n,e.filter(function(e){return null!=e&&k(e)&&e>=a&&e<=n})}function v(e,a){return t(this,void 0,void 0,function(){var t,r,i,o,u,s,c,m,f,v,d;return n(this,function(n){switch(n.label){case 0:return t=e.field,r="function"==typeof t,i=e.valueExpression,o=e.normalizationType,u=e.normalizationField,s=e.normalizationTotal,c=[],m=e.view,f=null,v=null,i?G?[3,2]:[4,l.loadArcade()]:[3,3];case 1:d=n.sent().arcadeUtils,G=d,n.label=2;case 2:f=G.createFunction(i),v=m&&G.getViewInfo({viewingMode:"2d"===m.type?"map":m.viewingMode,scale:m.scale,spatialReference:m.spatialReference}),n.label=3;case 3:return a?(a.forEach(function(e){var a,n=e.attributes;if(i){var l=G.createExecContext(e,v);a=G.executeFunction(f,l)}else r?a=t.call(null,e):n&&(a=n[t]);if(o&&null!=a&&k(a)){var m=n&&parseFloat(n[u]);"log"===o&&0!==a?a=Math.log(a)*Math.LOG10E:"percent-of-total"===o&&k(s)&&0!==s?a=a/s*100:"field"===o&&k(m)&&0!==m&&(a/=m)}c.push(a)}),[2,c]):[2,c]}})})}function d(e,a){for(var n=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,r=null,i=null,o=null,l=null,u=0,s=e;u<s.length;u++){var c=s[u];r+=c,n=Math.min(n,c),t=Math.max(t,c)}var m=e.length;if(m){i=r/m;for(var f=0,v=0,d=e;v<d.length;v++){var c=d[v];f+=Math.pow(c-i,2)}l=a?m>1?f/(m-1):0:m>0?f/m:0,o=Math.sqrt(l)}else n=null,t=null;return{avg:i,count:m,max:t,min:n,stddev:o,sum:r,variance:l}}function h(e){var n;for(n in e)a.statisticTypes.indexOf(n)>-1&&(k(e[n])||(e[n]=null));return e}function p(e){var a=e.field,n=e.classificationMethod||A,t=e.normalizationType,r=e.normalizationField,i=new u;return i.classificationField=a,i.breakCount=e.breakCount,i.classificationMethod=n,i.standardDeviationInterval="standard-deviation"===n?e.standardDeviationInterval||P:void 0,i.normalizationType=t,i.normalizationField="field"===t?r:void 0,i}function x(e,a,n,t,r,i){void 0===a&&(a=10);for(var l=new Float64Array(r*i),u=o.createKernel(a),s=Math.round(3*a),c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,v=0,d=0,h=0,p=o.createValueFunction(t,n),x=0,g=e;x<g.length;x++)for(var V=g[x],F=V.geometry,b=V.attributes,y=F.x-s,T=F.y-s,z=Math.max(0,y),E=Math.max(0,T),M=Math.min(i,F.y+s),I=Math.min(r,F.x+s),S=+p(b),w=E;w<M;w++)for(var N=u[w-T],D=z;D<I;D++){var C=u[D-y],k=w*r+D,O=l[k];f=l[k]+=N*C*S;var q=f-O;v+=q,d+=q*q,f<c&&(c=f),f>m&&(m=f),h++}if(!h)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};var B=(m-c)/2;return{mean:v/h,stdDev:Math.sqrt((d-v*v/h)/h),min:c,max:m,mid:B,count:h}}function g(e,a){return t(this,void 0,void 0,function(){var t,r,i,o;return n(this,function(n){switch(n.label){case 0:return t=e.normalizationTotal,r=p({field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||U}),[4,v(e,a)];case 1:return i=n.sent(),i=f(i,e.minValue,e.maxValue),o=s.createGenerateRendererClassBreaks({definition:r,values:i,normalizationTotal:t}),[2,V(e,o)]}})})}function V(e,a){var n=a.classBreaks,t=n.length,r=n[0].minValue,i=n[t-1].maxValue,o="standard-deviation"===e.classificationMethod,l=L;return n=n.map(function(e){var a=e.label,n={minValue:e.minValue,maxValue:e.maxValue,label:a};if(o&&a){var t=a.match(l),r=t.map(function(e){return+e.trim()});2===r.length?(n.minStdDev=r[0],n.maxStdDev=r[1],r[0]<0&&r[1]>0&&(n.hasAvg=!0)):1===r.length&&(a.indexOf("<")>-1?(n.minStdDev=null,n.maxStdDev=r[0]):a.indexOf(">")>-1&&(n.minStdDev=r[0],n.maxStdDev=null))}return n}),{minValue:r,maxValue:i,classBreakInfos:n,normalizationTotal:a.normalizationTotal}}function F(e,a,n){for(var t,r=(a-e)/n,i=[],o=e,l=1;l<=n;l++)t=o+r,t=Number(t.toFixed(16)),i.push([o,t]),o=t;return i}function b(e){var a=[],n=e.classBreaks,t=n[0].minValue,r=n[n.length-1].maxValue;n.forEach(function(e){a.push([e.minValue,e.maxValue])});var i={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal};return{min:t,max:r,intervals:a,sqlExpr:y(i),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function y(e){var a=e.field,n=e.normalizationType,t=e.normalizationField,r=e.normalizationTotal,i=a;return"percent-of-total"===n?i="(("+a+" / "+r+") * 100)":"log"===n?i="(log("+a+") * "+_+")":"field"===n&&(i="("+a+" / "+t+")"),i}function T(e,a,r){return t(this,void 0,void 0,function(){var t,i,o,l,u,s,c,m,f,d,h;return n(this,function(n){switch(n.label){case 0:return t=a.min,i=a.max,o=a.normTotal,l=e.numBins||R,u=a.intervals||F(t,i,l),s=u.map(function(e,a){return{minValue:u[a][0],maxValue:u[a][1],count:0}}),[4,v(e,r)];case 1:for(c=n.sent(),m=0,f=c;m<f.length;m++)null!=(d=f[m])&&d>=t&&d<=i&&(h=z(u,d))>-1&&s[h].count++;return[2,{bins:s,minValue:t,maxValue:i,normalizationTotal:o}]}})})}function z(e,a){for(var n=-1,t=e.length-1;t>=0;t--){if(a>=e[t][0]){n=t;break}}return n}function E(e,a){var n;if(a=a.toLowerCase(),e)for(var t in e)if(t.toLowerCase()!==a){n=e[t];break}return n}function M(e,a){var n;if(a=a.toLowerCase(),e)for(var t in e)if(t.toLowerCase()===a){n=e[t];break}return n}function I(e,a,n,t,r){var i={};e&&e.features&&e.features.forEach(function(e){var a=e.attributes,n=E(a,"countOFExpr"),t=M(a,"countOFExpr");0!==n&&(i[n]=t)});var o=[];return F(a,n,t).forEach(function(e,a){var n=(a+1).toString();o.push({minValue:e[0],maxValue:e[1],count:i.hasOwnProperty(n)?i[n]:0})}),{bins:o,minValue:a,maxValue:n,normalizationTotal:r}}function S(e,a,n,t){var i=e&&e.features,o="countOF"+(n||"Expr"),l={},u=!1;if(i.forEach(function(e){var a=e.attributes,t=M(a,o),r=n?M(a,n):E(a,o);null===r&&0===t&&(u=!0),(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==l[r]?l[r]={count:t,data:r}:l[r].count=l[r].count+t}),n&&u){var s=n+" is NULL";return a.queryFeatureCount(s).then(function(e){return e=e||0,l.null.count=l.null.count+e,w(l,t)}).catch(function(){return w(l,t)})}return r.resolve(w(l,t))}function w(e,a){if(a)for(var n in e)e[n].label=a[n];return{count:e}}function N(e,a,n,t){var r=e.count,i=[];if(t&&n&&"coded-value"===n.type){n.codedValues.forEach(function(e){var a=e.code;r.hasOwnProperty(a)||(r[a]={data:a,count:0})})}for(var o in r){var l=r[o];i.push({value:l.data,count:l.count,label:l.label})}return{uniqueValueInfos:i}}function D(e,a,r){return t(this,void 0,void 0,function(){var t,i,o,l,u,s;return n(this,function(n){switch(n.label){case 0:return t=e.features?B:q,[4,v(e,a)];case 1:for(i=n.sent(),o={},l=0,u=i;l<u.length;l++)s=u[l],(null==s||"string"==typeof s&&""===s.trim())&&(s=null),null==o[s]?o[s]={count:1,data:s}:o[s].count++;return[2,N({count:o},t,r,e.returnAllCodedValues)]}})})}function C(e,a){return i.getDateDiffSQL(e,new Date(0),a,"milliseconds").sqlExpression}function k(e){return"number"==typeof e&&!isNaN(e)&&e!==1/0&&e!==-1/0}Object.defineProperty(a,"__esModule",{value:!0});var O=/_value$/i,q="features-in-memory",B="features",L=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,U=5,R=10,_=Math.LOG10E,A="equal-interval",P=1;a.statisticTypes=["min","max","avg","stddev","count","sum","variance"];var G=null;a.getSummaryStatisticsFromFeatureSet=c,a.calculateStatsFromMemory=m,a.getDataValues=v,a.processSummaryStatisticsResult=h,a.createCBDefn=p,a.calculateHeatmapStats=x,a.calculateClassBreaksFromMemory=g,a.resolveCBResult=V,a.getEqualIntervalBins=F,a.generateBinParams=b,a.getFieldExpr=y,a.calculateHistogramFromMemory=T,a.getHistogramFromFeatureSet=I,a.getUniqueValuesFromFeatureSet=S,a.createUVResult=N,a.calculateUniqueValuesFromMemory=D,a.msSinceUnixEpochSQL=C,a.isValidNumber=k});