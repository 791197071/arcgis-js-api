// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","./size","./type","./support/utils","../heuristics/outline","../statistics/predominantCategories","../statistics/summaryStatistics","../statistics/support/predominanceUtils","../support/utils","../symbology/predominance","../../support/AuthoringInfo","../../support/AuthoringInfoVisualVariable","../../support/numberUtils","../../visualVariables/OpacityVariable"],function(e,r,a,i,n,s,t,l,o,p,u,m,d,c,y,b,f,h,v,g,w,S){function T(e){return n(this,void 0,void 0,function(){var r,n,s,l,o,p,u;return i(this,function(i){switch(i.label){case 0:if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new t("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new t("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new t("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");if(r=a({},e),r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.includeOpacityVariable=e.includeOpacityVariable||!1,r.includeSizeVariable=e.includeSizeVariable||!1,r.sortBy=null==r.sortBy?"count":r.sortBy,n=[0,2,1,3],s=f.createLayerAdapter(r.layer,n),r.layer=s,!s)throw new t("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(n).join(", "));return[4,s.load()];case 1:if(i.sent(),l=s.geometryType,o=r.symbolType.indexOf("3d")>-1,r.outlineOptimizationEnabled="polygon"===l&&r.outlineOptimizationEnabled,"mesh"===l)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if(o&&("polyline"===l||"polygon"===l))throw new t("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new t("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(p=r.fields.map(function(e){return e.name}),u=m.verifyBasicFieldValidity(s,p,"predominance-renderer:invalid-parameters"))throw u;return[2,r]}})})}function V(e){return n(this,void 0,void 0,function(){var r,a,n,s,t;return i(this,function(i){switch(i.label){case 0:return r=e.predominanceScheme,a=null,n=null,[4,m.getBasemapInfo(e.basemap,e.view)];case 1:return s=i.sent(),(a=l.isSome(s.basemapId)?s.basemapId:null,n=l.isSome(s.basemapTheme)?s.basemapTheme:null,r)?[2,{scheme:h.cloneScheme(r),basemapId:a,basemapTheme:n}]:(t=h.getSchemes({basemap:a,basemapTheme:n,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view}),t&&(r=t.primaryScheme,a=t.basemapId,n=t.basemapTheme),[2,{scheme:r,basemapId:a,basemapTheme:n}])}})})}function x(e,r,a,t){return n(this,void 0,void 0,function(){var n,l,p,y,b,f,h,g,w,S,T,V,x,E,I,O,z,M,q,C,B,A,F,U,Q,W,j,k,H,L;return i(this,function(i){switch(i.label){case 0:return n=e.layer,l={layer:e.layer,view:e.view},h=(f=o).all,g=[c({layer:n,fields:t,view:e.view})],e.outlineOptimizationEnabled?[4,d(l)]:[3,2];case 1:return w=i.sent(),[3,3];case 2:w=null,i.label=3;case 3:return[4,h.apply(f,[g.concat([w])])];case 4:return p=i.sent(),y=p[0],b=p[1],S=y,y&&y.predominantCategoryInfos||(S={predominantCategoryInfos:t.map(function(e){return{value:e,count:0}})}),T=b&&b.opacity,[4,u.createRenderer({layer:n,basemap:e.basemap,valueExpression:r.valueExpression,valueExpressionTitle:s.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:a,statistics:{uniqueValueInfos:S.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view})];case 5:for(V=i.sent(),x=V.renderer,E=x.uniqueValueInfos,I={},O=0,z=e.fields;O<z.length;O++)M=z[O],q=n.getField(M.name),I[q.name]=M.label||q&&q.alias||M.name;for(C=0,B=E;C<B.length;C++)A=B[C],A.label=I[A.value];return e.includeSizeVariable&&(F=n.geometryType,U=null,"polygon"===F?(Q=a,W=Q.sizeScheme,j=W.background,x.backgroundFillSymbol=m.createSymbol(F,{type:e.symbolType,color:j.color,outline:m.getSymbolOutlineFromScheme(j,F,T)}),U=W.marker.size,F="point"):"polyline"===F?(k=a,U=k.width):(H=a,U=H.size),L=m.createColors(a.colors,E.length),E.forEach(function(r,i){r.symbol=m.createSymbol(F,{type:e.symbolType,color:L[i],size:U,outline:m.getSymbolOutlineFromScheme(a,F,T),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}})})),b&&b.visualVariables&&b.visualVariables.length&&(x.visualVariables=b.visualVariables.map(function(e){return e.clone()})),x.authoringInfo=new v({type:"predominance",fields:t.slice()}),[2,{renderer:x,predominantCategoryInfos:E,excludedCategoryInfos:V.excludedUniqueValueInfos,predominanceScheme:a,basemapId:V.basemapId,basemapTheme:V.basemapTheme}]}})})}function E(e,r,a){return p.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:r.valueExpression,sqlExpression:r.statisticsQuery.sqlExpression,sqlWhere:r.statisticsQuery.sqlWhere,sizeScheme:a,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:s.sumOfCategories},view:e.view})}function I(e,r){return n(this,void 0,void 0,function(){var a,n,t,l,o,p,u,m;return i(this,function(i){switch(i.label){case 0:return[4,y({layer:e.layer,valueExpression:r.valueExpression,sqlExpression:r.statisticsQuery.sqlExpression,sqlWhere:r.statisticsQuery.sqlWhere,view:e.view})];case 1:return a=i.sent(),n=null==a.avg||null==a.stddev,t=1/e.fields.length*100,l=n?100:a.avg+1.285*a.stddev,l>100&&(l=100),o=w.round([t,l],{strictBounds:!0}),p=new S({valueExpression:r.valueExpression,stops:[{value:o[0],opacity:.15},{value:o[1],opacity:1}],legendOptions:{title:s.strengthOfPredominance}}),u=new g({type:"opacity",minSliderValue:a.min,maxSliderValue:a.max}),m=new v({visualVariables:[u]}),[2,{visualVariable:p,statistics:a,defaultValuesUsed:n,authoringInfo:m}]}})})}function O(e){return n(this,void 0,void 0,function(){var r,a,n,s,t,l,p,u,m,d,c,y,f,h,v,g;return i(this,function(i){switch(i.label){case 0:return[4,T(e)];case 1:return r=i.sent(),a=r.layer,[4,V({basemap:r.basemap,geometryType:a.geometryType,numColors:r.fields.length,predominanceScheme:r.predominanceScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view})];case 2:return n=i.sent(),s=n.scheme,t=r.fields.map(function(e){return e.name}),l=b.getPredominanceExpressions(a,t),p=x(r,l.predominantCategory,s,t),u=r.includeSizeVariable?E(r,l.size,s.sizeScheme):null,m=r.includeOpacityVariable?I(r,l.opacity):null,[4,o.all([p,u,m])];case 3:return d=i.sent(),c=d[0],y=d[1],f=d[2],h=[],v=[],y&&(Array.prototype.push.apply(h,y.visualVariables.map(function(e){return e.clone()})),delete y.sizeScheme,c.size=y,Array.prototype.push.apply(v,y.authoringInfo.visualVariables.map(function(e){return e.clone()}))),f&&(h.push(f.visualVariable.clone()),c.opacity=f,Array.prototype.push.apply(v,f.authoringInfo.visualVariables.map(function(e){return e.clone()}))),h.length&&(g=c.renderer.visualVariables||[],Array.prototype.push.apply(g,h),c.renderer.visualVariables=g,c.renderer.authoringInfo.visualVariables=v),[2,c]}})})}Object.defineProperty(r,"__esModule",{value:!0}),r.createRenderer=O});