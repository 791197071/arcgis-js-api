// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../../../core/Error","../../../core/promiseUtils","./size","./type","./support/utils","../heuristics/outline","../statistics/summaryStatistics","../support/utils","../support/adapters/support/predominanceUtils","../symbology/predominance","../../support/AuthoringInfo","../../support/AuthoringInfoVisualVariable","../../support/numberUtils","../../visualVariables/OpacityVariable"],function(e,r,i,a,n,t,l,o,s,p,u,d,c,m,y,b,f,v,h,g){function w(e){return n(this,void 0,void 0,function(){var r,n,t,o,s,p,d;return a(this,function(a){switch(a.label){case 0:if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new l("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new l("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new l("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");if(r=i({},e),r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.includeOpacityVariable=e.includeOpacityVariable||!1,r.includeSizeVariable=e.includeSizeVariable||!1,r.sortBy=null==r.sortBy?"count":r.sortBy,n=[0,2,1,3],t=m.createLayerAdapter(r.layer,n),r.layer=t,!t)throw new l("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(n).join(", "));return[4,t.load()];case 1:if(a.sent(),o=t.geometryType,s=r.symbolType.indexOf("3d")>-1,r.outlineOptimizationEnabled="polygon"===o&&r.outlineOptimizationEnabled,"mesh"===o)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if(s&&("polyline"===o||"polygon"===o))throw new l("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new l("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(p=r.fields.map(function(e){return e.name}),d=u.verifyBasicFieldValidity(t,p,"predominance-renderer:invalid-parameters"))throw d;return[2,r]}})})}function S(e){var r=e.predominanceScheme,i=e.basemap;if(r)r=b.cloneScheme(r);else{var a=b.getSchemes({basemap:e.basemap,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view});r=a&&a.primaryScheme,i=a&&a.basemapId}return{scheme:r,basemapId:i}}function V(e,r,i,l){return n(this,void 0,void 0,function(){var n,s,c,m,y,b,f,v,h,g,w,S,V,x,E,T,O,z,I,M,q,C,B,A,F,U,P,Q,W,j;return a(this,function(a){switch(a.label){case 0:return n=e.layer,s={layer:e.layer,view:e.view},f=(b=o).all,v=[n.getPredominantCategories(l,e.view)],e.outlineOptimizationEnabled?[4,d(s)]:[3,2];case 1:return h=a.sent(),[3,3];case 2:h=null,a.label=3;case 3:return[4,f.apply(b,[v.concat([h])])];case 4:return c=a.sent(),m=c[0],y=c[1],g=m,m&&m.predominantCategoryInfos||(g={predominantCategoryInfos:l.map(function(e){return{value:e,count:0}})}),w=y&&y.opacity,[4,p.createRenderer({layer:n,basemap:e.basemap,valueExpression:r.valueExpression,valueExpressionTitle:t.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:i,statistics:{uniqueValueInfos:g.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view})];case 5:for(S=a.sent(),V=S.renderer,x=V.uniqueValueInfos,E={},T=0,O=e.fields;T<O.length;T++)z=O[T],I=n.getField(z.name),E[I.name]=z.label||I&&I.alias||z.name;for(M=0,q=x;M<q.length;M++)C=q[M],C.label=E[C.value];return e.includeSizeVariable&&(B=n.geometryType,A=null,"polygon"===B?(F=i,U=F.sizeScheme,P=U.background,V.backgroundFillSymbol=u.createSymbol(B,{type:e.symbolType,color:P.color,outline:u.getSymbolOutlineFromScheme(P,B,w)}),A=U.marker.size,B="point"):"polyline"===B?(Q=i,A=Q.width):(W=i,A=W.size),j=u.createColors(i.colors,x.length),x.forEach(function(r,a){r.symbol=u.createSymbol(B,{type:e.symbolType,color:j[a],size:A,outline:u.getSymbolOutlineFromScheme(i,B,w),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}})})),y&&y.visualVariables&&y.visualVariables.length&&(V.visualVariables=y.visualVariables.map(function(e){return e.clone()})),[2,{renderer:V,predominantCategoryInfos:x,excludedCategoryInfos:S.excludedUniqueValueInfos,predominanceScheme:i,basemapId:S.basemapId}]}})})}function x(e,r,i){return s.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:r.valueExpression,sqlExpression:r.statisticsQuery.sqlExpression,sqlWhere:r.statisticsQuery.sqlWhere,sizeScheme:i,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:t.sumOfCategories},view:e.view})}function E(e,r){return n(this,void 0,void 0,function(){var i,n,l,o,s,p,u,d;return a(this,function(a){switch(a.label){case 0:return[4,c({layer:e.layer,valueExpression:r.valueExpression,sqlExpression:r.statisticsQuery.sqlExpression,sqlWhere:r.statisticsQuery.sqlWhere,view:e.view})];case 1:return i=a.sent(),n=null==i.avg||null==i.stddev,l=1/e.fields.length*100,o=n?100:i.avg+1.285*i.stddev,o>100&&(o=100),s=h.round([l,o],{strictBounds:!0}),p=new g({valueExpression:r.valueExpression,stops:[{value:s[0],opacity:.15},{value:s[1],opacity:1}],legendOptions:{title:t.strengthOfPredominance}}),u=new v({type:"opacity",minSliderValue:i.min,maxSliderValue:i.max}),d=new f({visualVariables:[u]}),[2,{visualVariable:p,statistics:i,defaultValuesUsed:n,authoringInfo:d}]}})})}function T(e){return n(this,void 0,void 0,function(){var r,i,n,t,l,s,p,u,d,c,m,b,f,v,h;return a(this,function(a){switch(a.label){case 0:return[4,w(e)];case 1:return r=a.sent(),i=r.layer,n=S({basemap:r.basemap,geometryType:i.geometryType,numColors:r.fields.length,predominanceScheme:r.predominanceScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view}),t=n.scheme,l=r.fields.map(function(e){return e.name}),s=y.getPredominanceExpressions(i,l),p=V(r,s.predominantCategory,t,l),u=r.includeSizeVariable?x(r,s.size,t.sizeScheme):null,d=r.includeOpacityVariable?E(r,s.opacity):null,[4,o.all([p,u,d])];case 2:return c=a.sent(),m=c[0],b=c[1],f=c[2],v=[],b&&(Array.prototype.push.apply(v,b.visualVariables.map(function(e){return e.clone()})),delete b.sizeScheme,m.size=b),f&&(v.push(f.visualVariable),m.opacity=f),v.length&&(h=m.renderer.visualVariables||[],Array.prototype.push.apply(h,v),m.renderer.visualVariables=h),[2,m]}})})}Object.defineProperty(r,"__esModule",{value:!0}),r.createRenderer=T});