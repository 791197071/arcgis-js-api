// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../..","../../../core/Error","../../../core/promiseUtils","../../../geometry/support/scaleUtils","./support/dotDensityUtils","./support/utils","../heuristics/outline","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/utils","../symbology/dotDensity","../../support/AuthoringInfo"],function(e,t,r,i,n,a,s,l,o,u,d,c,p,y,m,f,v,b){function g(e){return i(this,void 0,void 0,function(){var t,i,a,o;return r(this,function(r){switch(r.label){case 0:if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new s("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new s("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");if(t=n({},e),i=[2,1],a=f.createLayerAdapter(t.layer,i),t.layer=a,t.dotBlendingEnabled=null==t.dotBlendingEnabled||t.dotBlendingEnabled,t.dotValueOptimizationEnabled=null==t.dotValueOptimizationEnabled||t.dotValueOptimizationEnabled,!a)throw new s("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(i).join(", "));return[4,l.all([t.view.when(),a.load()])];case 1:if(r.sent(),"polygon"!==(o=a.geometryType))throw new s("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return[2,t]}})})}function h(e){var t=e.dotDensityScheme,r=e.basemap;if(t)t=v.cloneScheme(t);else{var i=v.getSchemes({basemap:e.basemap,numColors:e.attributes.length});t=i&&i.primaryScheme,r=i&&i.basemapId}return{scheme:t,basemapId:r}}function w(e){return i(this,void 0,void 0,function(){var t,i,n,a,d,c,m,f,v,b,g,h;return r(this,function(r){switch(r.label){case 0:return t=e.view,i=e.layer,n=e.attributes,[4,i.getSampleFeatures({view:t,sampleSize:E})];case 1:return a=r.sent(),[4,l.all([p({features:a,geometryType:i.geometryType}),y({layer:i,attributes:n,view:t})])];case 2:if(d=r.sent(),c=d[0],m=d[1],f="avgSize"in c&&c.avgSize,v=m.avg,!f)throw new s("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!v)throw new s("dot-density-renderer:insufficient-info","Average attribute value is invalid");return b=o.getResolutionForScale(t.scale,t.spatialReference),g=f*f/(b*b)*.1,h=u.roundValue(v/g),[2,{dotValue:h||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:u.roundValue(v)}]}})})}function S(e){return i(this,void 0,void 0,function(){var t,i,n,a,l,d,c,p,y,v,b,g,h,w,S;return r(this,function(r){switch(r.label){case 0:for(t=e.view,i=e.layer,n=e.attributes,a=[],l=0,d=n;l<d.length;l++)c=d[l],a.push.apply(a,f.getFieldsList({field:c.field,valueExpression:c.valueExpression}));return[4,i.getSampleFeatures({view:t,sampleSize:E,requiredFields:a})];case 1:return p=r.sent(),[4,m(p,n,t)];case 2:if(y=r.sent(),!y.avgDensity||!y.minDensity||!y.maxDensity)throw new s("dot-density-renderer:insufficient-info","Invalid density values");return v=o.getResolutionForScale(t.scale,t.spatialReference),b=v*v,g=u.roundValue(y.minDensity*b),h=u.roundValue(y.maxDensity*b),w=10,S=u.roundValue(y.avgDensity*b*w)||1,S>h&&(S=h),[2,{dotValue:S,referenceScale:t.scale,minSliderValue:g,maxSliderValue:h}]}})})}function V(e){return i(this,void 0,void 0,function(){var t,i,n,o,u,p,y,m,f,v,V,E,D,x,z,O,F;return r(this,function(r){switch(r.label){case 0:return[4,g(e)];case 1:if(t=r.sent(),i=t.layer,n=i.geometryType,o=h(t),!(u=o&&o.scheme))throw new s("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");return p={layer:i,view:t.view,attributes:t.attributes},y={layer:t.layer,view:t.view},[4,l.all([t.trueDensity?S(p):w(p),t.outlineOptimizationEnabled?c(y):null])];case 2:return m=r.sent(),f=m[0],v=m[1],V=f.dotValue,E=f.referenceScale,D=f.minSliderValue,x=f.maxSliderValue,z=d.createColors(u.colors,t.attributes.length),O=t.attributes.map(function(e,t){return{field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:z[t]}}),F=new a.DotDensityRenderer({attributes:O,dotBlendingEnabled:t.dotBlendingEnabled,outline:v?d.getSymbolOutlineFromScheme(u,n,v.opacity):null,dotValue:V,referenceScale:t.dotValueOptimizationEnabled?E:null,legendOptions:t.legendOptions}),v&&v.visualVariables&&v.visualVariables.length&&(F.visualVariables=v.visualVariables.map(function(e){return e.clone()})),F.authoringInfo=new b({type:"dot-density",minSliderValue:D,maxSliderValue:x}),[2,{renderer:F,dotDensityScheme:u,basemapId:o.basemapId}]}})})}Object.defineProperty(t,"__esModule",{value:!0});var E=500;t.createRenderer=V});