// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../symbols","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../intl/date","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../support/utils","../../../support/numberUtils","../../../support/pointCloud/PointSizeSplatAlgorithm","../../../../views/support/colorUtils"],function(e,t,r,n,i,o,a,l,s,u,c,m,d,f,y,p,h,v,b,g){function w(e,t,r){if("string"==typeof e){var n=r.getField(e);if(n&&"date"===n.type)return n.alias||n.name}else if("number"==typeof e||e instanceof Date){var i=H.indexOf(t)>-1?"short-date-short-time":"short-date";return d.formatDate(e,d.convertDateFormatToIntlOptions(i))}return e}function S(e,t){return new u(e,t)}function D(e,t,r){var n,i,o=z({statistics:e,isDate:t});return o.defaultValuesUsed?(n=o.min,i=o.max):!r||null!=e.avg&&e.stddev||(n=e.min,i=e.max),null!=n?[n,i]:null}function z(e){var t=e&&e.statistics;t||(t={});var r,n;if(null==t.min)if(e.isDate){var i=x();r=i[0],n=i[1]}else r=0,n=100;else if(t.min===t.max)if(e.isDate){var o=x(t.min);r=o[0],n=o[1]}else t.min<0?(r=2*t.min,n=0):t.min>0?(r=0,n=2*t.min):(r=0,n=100);return{min:null!=r?r:t.min,max:null!=n?n:t.max,defaultValuesUsed:null!=r||null!=n}}function x(e){var t="number"==typeof e?new Date(e):new Date,r=t.getUTCFullYear(),n=Date.UTC(r,0,1,12,0,0,0),i=Date.UTC(r,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>i&&(i=e)),[n,i]}function L(e,t){for(var r=[],n=e.length,i=0;i<t;i++)r.push(new o(e[i%n]));return r}function U(e,t){void 0===t&&(t=!0);var r=e.avg,n=r-e.stddev,i=r+e.stddev;n<e.min&&(n=e.min),i>e.max&&(i=e.max),t&&(r=n+(i-n)/2);var o=v.round([n,i],{strictBounds:!0});return n=o[0],i=o[1],o=[n,n+(r-n)/2,r,r+(i-r)/2,i],v.round(o,{strictBounds:!0})}function F(e,t,r){switch(t){case"point":case"multipoint":return r?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return r?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;case"mesh":return;default:return void s.neverReached(t)}}function I(e,t,r){switch(t){case"point":case"multipoint":case"polygon":if(!("outline"in e))return null;var n={color:e.outline.color,width:e.outline.width};if(null!=r&&n.color){var i=n.color.clone();i.a=r,n.color=i}return n;case"polyline":case"mesh":return;default:return void s.neverReached(t)}}function T(e,t){var r,n=t.type,i=t.size,o=t.color,l=t.outline;switch(e){case"point":case"multipoint":if("2d"===n)r=new a.SimpleMarkerSymbol({color:o,size:i,outline:{color:l.color,width:l.width}});else if("3d-flat"===n)r=new a.PointSymbol3D({symbolLayers:[new a.IconSymbol3DLayer({size:i,resource:{primitive:"circle"},material:{color:o},outline:{color:l.color,size:l.width}})]});else if(n.indexOf("3d-volumetric")>-1){var s="3d-volumetric-uniform"===n,u=s?"sphere":"cylinder",c=new a.ObjectSymbol3DLayer({height:i,resource:{primitive:u},material:{color:o}});s||(c.width=t.widthAndDepth,c.depth=t.widthAndDepth),r=new a.PointSymbol3D({symbolLayers:[c]})}break;case"polyline":"2d"===n?r=new a.SimpleLineSymbol({color:o,width:i}):"3d-flat"===n?r=new a.LineSymbol3D({symbolLayers:[new a.LineSymbol3DLayer({size:i,material:{color:o}})]}):"3d-volumetric"===n&&(r=new a.LineSymbol3D({symbolLayers:[new a.PathSymbol3DLayer({size:i,material:{color:o}})]}));break;case"polygon":"2d"===n?r=new a.SimpleFillSymbol({color:o,outline:{color:l.color,width:l.width}}):"3d-flat"===n?r=new a.PolygonSymbol3D({symbolLayers:[new a.FillSymbol3DLayer({material:{color:o},outline:{color:l.color,size:l.width}})]}):"3d-volumetric"===n&&(r=new a.PolygonSymbol3D({symbolLayers:[new a.ExtrudeSymbol3DLayer({size:i,material:{color:o}})]}));break;case"mesh":var m=t.meshInfo&&t.meshInfo.colorMixMode,d=t.meshInfo&&t.meshInfo.edgesType;r=new a.MeshSymbol3D({symbolLayers:[new a.FillSymbol3DLayer({material:{color:o,colorMixMode:m},edges:null==d||"none"===d?null:{type:d,color:G}})]})}return r}function V(e,t,r){var n=k({layer:e,fields:t});if(n.length)return S(r,"Unknown fields: "+n.join(", ")+". You can only use fields defined in the layer schema");var i=B({layer:e,fields:t});return i.length?S(r,"Unsupported fields: "+i.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}function k(e){var t=e.layer;return e.fields.filter(function(e){return!t.getField(e)})}function B(e){var t=e.layer;return e.fields.filter(function(e){var r=t.getFieldUsageInfo(e);return!r||!r.supportsRenderer})}function C(e,t){return i(this,void 0,void 0,function(){var i,o,a,l,s,u,c;return n(this,function(n){switch(n.label){case 0:return i={layer:e.layer,view:e.view},[4,m.all([y(e),t?f(i):null])];case 1:return o=n.sent(),a=o[0],l=o[1],s=D({min:a.minValue,max:a.maxValue,avg:null,stddev:null},!1,!1),s?[4,y(r({},e,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:s[0],maxValue:s[1],normalizationTotal:s[0]+s[1]}))]:[3,3];case 2:return c=n.sent(),[3,4];case 3:c=a,n.label=4;case 4:return u=c,[2,{result:u,defaultValuesUsed:!!s,outlineResult:l}]}})})}function P(e){return l.safeCast(p(e))}function M(e,t){var r=e.minSize,n=e.maxSize;if("height"===t){r=((n-r)/2+r)/4.6,n*=2}return{minSize:r,maxSize:n}}function R(e){return E.test(e)}function A(e){var t=e.match(E),r=Number(t[1]);if("%"===t[3])return new b.default({scaleFactor:r/100})}function O(e,t,r,n){e.startTime=t instanceof Date?t.getTime():t,e.endTime=r instanceof Date?r.getTime():r,e.units=n,e.field="string"==typeof t?t:"string"==typeof r?r:null}function j(e,t){return i(this,void 0,void 0,function(){var r,i,o;return n(this,function(n){switch(n.label){case 0:return r=null,(i=null,e||t)?(!e&&t&&(e=t&&t.get("map.basemap")),e&&(r=h.getBasemapId(e,Y,!1))&&(o=h.getBasemapGroup(r),c.isSome(o)&&(i=o)),r||!t?[3,2]:[4,g.getBackgroundColorTheme(t)]):[2,{basemapId:r,basemapTheme:i}];case 1:i=n.sent(),c.isSome(i)&&(r="dark"===i?"dark-gray":"gray"),n.label=2;case 2:return[2,{basemapId:r,basemapTheme:i}]}})})}Object.defineProperty(t,"__esModule",{value:!0});var E=/^(\d+(\.\d+)?)\s*(%)$/i,G=[0,0,0,.4],H=["hours","minutes","seconds"],Y=[].concat(h.defaultBasemapGroups.light).concat(h.defaultBasemapGroups.dark);t.formatDate=w,t.createError=S,t.getDefaultDataRange=D,t.createColors=L,t.createStopValues=U,t.getSymbolSizeFromScheme=F,t.getSymbolOutlineFromScheme=I,t.createSymbol=T,t.verifyBasicFieldValidity=V,t.getClassBreaks=C,t.getSummaryStatistics=P,t.getSizeRangeForAxis=M,t.isValidPointSize=R,t.getPointSizeAlgorithm=A,t.updateAgeRendererAuthoringInfoVV=O,t.getBasemapInfo=j});