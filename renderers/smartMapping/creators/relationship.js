// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../../../core/Error","../../../core/lang","../../../core/promiseUtils","./type","./support/utils","../support/utils","../symbology/relationship","../../support/AuthoringInfo","../../support/AuthoringInfoClassBreakInfo","../../support/AuthoringInfoFieldInfo","../../../symbols/support/utils"],function(e,n,r,a,i,l,o,s,t,u,d,f,m,p,c,h,v){function y(e){return i(this,void 0,void 0,function(){var n,i,l,s,t,u,m,p,c;return a(this,function(a){switch(a.label){case 0:if(!(e&&e.layer&&e.view&&e.field1&&e.field2))throw new o("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");if(n=r({},e),n.symbolType=n.symbolType||"2d",n.defaultSymbolEnabled=null==n.defaultSymbolEnabled||n.defaultSymbolEnabled,n.classificationMethod=n.classificationMethod||"quantile",n.numClasses=n.numClasses||3,n.focus=n.focus||null,-1===k.indexOf(n.classificationMethod))throw new o("relationship-renderer:invalid-parameters","classification method "+n.classificationMethod+" is not supported");if(n.numClasses<2||n.numClasses>4)throw new o("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(e.focus&&-1===z.indexOf(e.focus))throw new o("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");if(i=[0,2,1,3],l=f.createLayerAdapter(n.layer,i),n.layer=l,!l)throw new o("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(i).join(", "));return[4,l.load()];case 1:if(a.sent(),s=l.geometryType,t=n.symbolType.indexOf("3d")>-1,n.outlineOptimizationEnabled="polygon"===s&&n.outlineOptimizationEnabled,"mesh"===s)n.symbolType="3d-volumetric",n.colorMixMode=n.colorMixMode||"replace",n.edgesType=n.edgesType||"none";else{if("3d-volumetric-uniform"===n.symbolType&&"point"!==s)throw new o("relationship-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(t&&"polygon"===s)throw new o("relationship-renderer:not-supported","3d symbols are not supported for polygon layers");if(n.symbolType.indexOf("3d-volumetric")>-1&&(!n.view||"3d"!==n.view.type))throw new o("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(u=n.field1,m=n.field2,p=[u.field,m.field],u.normalizationField&&p.push(u.normalizationField),m.normalizationField&&p.push(m.normalizationField),c=d.verifyBasicFieldValidity(l,p,"relationship-renderer:invalid-parameters"))throw c;return[2,n]}})})}function b(e){return i(this,void 0,void 0,function(){var n,r,i,l,s,t;return a(this,function(a){if(!(e&&e.renderer&&e.numClasses))throw new o("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");if(n=e.field1,r=e.field2,i=e.renderer,l=e.numClasses,s=e.colors,t=Math.pow(l,2),(n||r)&&!(n&&r&&n.field&&r.field))throw new o("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(n&&!n.classBreakInfos||r&&!r.classBreakInfos)throw new o("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!i.authoringInfo)throw new o("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");if(i.uniqueValueInfos.length!==t)throw new o("update-relationship-renderer:invalid-parameters","Renderer must have "+t+" unique value infos to support "+l+" classes");if(s&&s.length!==t)throw new o("update-relationship-renderer:invalid-parameters","The scheme must have "+t+" colors");return[2,e]})})}function w(e){var n=e.relationshipScheme,r=e.basemap;if(n)n=m.cloneScheme(n);else{var a=m.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});n=a&&a.primaryScheme,r=a&&a.basemapId}return{scheme:n,basemapId:r}}function g(e,n){var r=s.clone(T[e]);return m.flatten2DArray(r,n)}function I(e,n){return g(e,n).map(function(e){return{value:e,count:0}})}function M(e,n,r,a){var i=e.field,l=e.normalizationField,o=n.field,s=n.normalizationField,t=r.map(function(e){return[e.minValue,e.maxValue]}),u=a.map(function(e){return[e.minValue,e.maxValue]}),d=t.length,f=x[d];return"\n  var field1 = $feature['"+i+"'];\n  var field2 = $feature['"+o+"'];\n  var hasNormField1 = "+(l?"true":"false")+";\n  var hasNormField2 = "+(s?"true":"false")+";\n  var normField1 = "+(l?"$feature['"+l+"']":"null")+";\n  var normField2 = "+(s?"$feature['"+s+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||\n    (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))\n  ) {\n    return null;\n  }\n\n  var value1 = IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 = IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 = "+JSON.stringify(t)+";\n  var breaks2 = "+JSON.stringify(u)+";\n  var classCodes = "+JSON.stringify(f)+";\n\n  function getClassCode(value, breaks) {\n    var code = null;\n\n    for (var i in breaks) {\n      var info = breaks[i];\n      if (value >= info[0] && value <= info[1]) {\n        code = classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 = getClassCode(value1, breaks1);\n  var code2 = getClassCode(value2, breaks2);\n\n  var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}function F(e,n,s){return i(this,void 0,void 0,function(){var i,t,d,f,c,h,v,y,b,g,F,H,L,V,C,k,z,T,x,E,B;return a(this,function(a){switch(a.label){case 0:if(i=e.basemap,t=e.classificationMethod,d=e.field1,f=e.field2,c=e.focus,h=e.numClasses,v=e.layer,y=n.classBreakInfos,b=s.classBreakInfos,h!==y.length||y.length!==b.length)throw new o("relationship-renderer:error","incompatible class breaks");return g=I(h,c),F=M(e.field1,e.field2,y,b),H=w({basemap:i,geometryType:v.geometryType,theme:"default",relationshipScheme:e.relationshipScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view}),L=H.scheme,[4,u.createRenderer({layer:v,basemap:i,valueExpression:F,valueExpressionTitle:l.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:e.defaultSymbolEnabled,typeScheme:r({colors:m.getColors(L,h,c)},L),statistics:{uniqueValueInfos:g},legendOptions:e.legendOptions,outlineOptimizationEnabled:e.outlineOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view})];case 1:for(V=a.sent(),C=V.renderer,k=C.uniqueValueInfos,z=l.relationship,T=0,x=k;T<x.length;T++)E=x[T],E.label=z[E.value];return B=new p({type:"relationship",classificationMethod:t,numClasses:h,focus:c,field1:{field:d.field,normalizationField:d.normalizationField,classBreakInfos:y.map(S)},field2:{field:f.field,normalizationField:f.normalizationField,classBreakInfos:b.map(S)}}),C.authoringInfo=B,[2,{renderer:C,classBreaks:{field1:n,field2:s},uniqueValueInfos:V.uniqueValueInfos,relationshipScheme:L,basemapId:V.basemapId}]}})})}function H(e,n,r){var a=g(n,r);e.sort(function(e,n){var r=a.indexOf(e.value),i=a.indexOf(n.value),l=0;return r<i?l=-1:r>i&&(l=1),l})}function L(e,n){var r=e.authoringInfo;r.numClasses=n.numClasses,r.focus=n.focus||null,r.focus||delete r.focus;var a=n.field1,i=n.field2;r.field1=new h.default({field:a.field,normalizationField:a.normalizationField,classBreakInfos:a.classBreakInfos.map(function(e){return new c.default(S(e))})}),r.field2=new h.default({field:i.field,normalizationField:i.normalizationField,classBreakInfos:i.classBreakInfos.map(function(e){return new c.default(S(e))})}),e.authoringInfo=r}function V(e){return i(this,void 0,void 0,function(){var n,r,i,l,o,s,t,u,f;return a(this,function(a){switch(a.label){case 0:return[4,b(e)];case 1:return n=a.sent(),r=n.field1,i=n.field2,l=n.renderer,o=n.numClasses,s=n.focus,t=n.colors,u=l.clone(),u.valueExpression=M(r,i,r.classBreakInfos,i.classBreakInfos),H(u.uniqueValueInfos,o,s),t&&(f=d.createColors(t,t.length),u.uniqueValueInfos.forEach(function(e,n){return v.applyColorToSymbol(e.symbol,f[n])})),L(u,n),[2,u]}})})}function C(e){return i(this,void 0,void 0,function(){var n,r,i,l,s,u,f,m,p,c,h,v;return a(this,function(a){switch(a.label){case 0:return[4,y(e)];case 1:return n=a.sent(),r=n.layer,i=n.classificationMethod,l=n.field1,s=n.field2,u=n.numClasses,f=n.view,m={layer:r,classificationMethod:i,field:l.field,normalizationField:l.normalizationField,normalizationType:l.normalizationField?"field":null,minValue:l.minValue,maxValue:l.maxValue,analyzeData:!(null!=l.minValue&&null!=l.maxValue),numClasses:u,view:f},p={layer:r,classificationMethod:i,field:s.field,normalizationField:s.normalizationField,normalizationType:s.normalizationField?"field":null,minValue:s.minValue,maxValue:s.maxValue,analyzeData:!(null!=s.minValue&&null!=s.maxValue),numClasses:u,view:f},[4,t.all([d.getClassBreaks(m),d.getClassBreaks(p)])];case 2:if(c=a.sent(),h=c[0],v=c[1],!h||!v)throw new o("relationship-renderer:error","error when calculating class breaks");return[2,F(n,h.result,v.result)]}})})}Object.defineProperty(n,"__esModule",{value:!0});var k=["equal-interval","natural-breaks","quantile"],z=["HH","HL","LH","LL"],T={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},x={2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]},S=function(e){return{minValue:e.minValue,maxValue:e.maxValue}};n.updateRenderer=V,n.createRenderer=C});