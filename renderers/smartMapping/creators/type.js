// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.12/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../..","../../../pointCloudRenderers","../../../core/Error","../../../core/lang","../../../core/promiseUtils","./support/utils","../heuristics/outline","../statistics/uniqueValues","../support/utils","../symbology/type","../../support/LegendOptions","../../support/utils"],function(e,r,l,t,o,n,a,i,s,u,d,p,c,y,m,f,v,b){function h(e){return o(this,void 0,void 0,function(){var r,o,n,a,i,d;return t(this,function(t){switch(t.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new s("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new s("type-renderer:missing-parameters","View is required when 'valueExpression' is specified");if(r=l({},e),r.symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.sortEnabled=null==r.sortEnabled||r.sortEnabled,r.statistics=u.clone(r.statistics),o=[0,2,1,3],n=m.createLayerAdapter(r.layer,o),r.layer=n,!n)throw new s("type-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(o).join(", "));return[4,n.load()];case 1:if(t.sent(),a=n.geometryType,r.outlineOptimizationEnabled="polygon"===a&&r.outlineOptimizationEnabled,"mesh"===a)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==a)throw new s("type-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new s("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(i=m.getFieldsList({field:r.field,valueExpression:r.valueExpression}),d=p.verifyBasicFieldValidity(n,i,"type-renderer:invalid-parameters"))throw d;return[2,r]}})})}function g(e){if(!(e&&e.layer&&e.field))return d.reject(p.createError("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required"));var r=l({},e);r.statistics=u.clone(r.statistics);var t=[4],o=m.createLayerAdapter(r.layer,t);return r.layer=o,r.density=r.density||25,r.size=r.size||"100%",p.isValidPointSize(r.size)?o?o.load().then(function(){var e=m.getFieldsList({field:r.field}),l=p.verifyBasicFieldValidity(o,e,"type-point-cloud-class-renderer:invalid-parameters");return l?d.reject(l):r}):d.reject(p.createError("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+m.getLayerTypeLabels(t).join(", "))):d.reject(p.createError("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function w(e){var r=e.typeScheme,l=e.basemap;if(r)r=f.cloneScheme(r);else{var t=f.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});r=t&&t.primaryScheme,l=t&&t.basemapId}return{scheme:r,basemapId:l}}function T(e,r){return e.label<r.label?-1:e.label>r.label?1:0}function S(e,r){return e.value<r.value?-1:e.value>r.value?1:0}function E(e,r){var l=r.count-e.count;return 0===l&&(l=T(e,r)),l}function x(e,r){var l=r.count-e.count;return 0===l&&(l=S(e,r)),l}function V(e,r,l){var t;"count"===r?(t=x,l&&l.codedValues&&(t=E)):"value"===r&&(t=S,l&&l.codedValues&&(t=T)),t&&e.sort(t)}function I(e,r,t){var o,i=e.uniqueValueInfos,s=r.layer,u=r.field,d=u?s.getField(u):null,c=d?s.getFieldDomain(d.name):null,y=-1===r.numTypes?i.length:r.numTypes,m=s.geometryType,h=w({basemap:r.basemap,geometryType:m,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view}),g=h.scheme,T=new a.UniqueValueRenderer({field:u}),S=-1,E={value:null,domain:c,fieldInfo:d};if(i.forEach(function(e,r){E.value=e.value,e.label=b.createUniqueValueLabel(E),null===e.value&&(S=r)}),S>-1&&(o=i.splice(S,1)[0]),!1!==r.sortEnabled&&V(i,r.sortBy,c),d&&d.type===L){var x=i.filter(function(e,r){return r<y}),I=x.map(function(e){return e.value});E.dateFormatInterval=b.calculateDateFormatInterval(I)}var M=t&&t.opacity,q=p.createColors(g.colors,i.length),z=p.getSymbolSizeFromScheme(g,m),O=p.getSymbolOutlineFromScheme(g,m,M);i.forEach(function(e,l){E.value=e.value,e.label=b.createUniqueValueLabel(E),e.symbol=p.createSymbol(m,{type:r.symbolType,color:q[l],size:z,outline:O,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})}),r.valueExpression&&(T.valueExpression=r.valueExpression,T.valueExpressionTitle=r.valueExpressionTitle),r.legendOptions&&(T.legendOptions=new v.LegendOptions(r.legendOptions)),q=p.createColors(g.colors,y);for(var C=0;C<y;C++){var F=i[C];F&&T.addUniqueValueInfo({value:F.value,label:F.label,symbol:p.createSymbol(m,{type:r.symbolType,color:q[C],size:z,outline:O,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})})}r.defaultSymbolEnabled&&(T.defaultSymbol=p.createSymbol(m,{type:r.symbolType,color:g.noDataColor,size:z,outline:O,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),T.defaultLabel=n.other),o&&(o.symbol=p.createSymbol(m,{type:r.symbolType,color:g.noDataColor,size:z,outline:O,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),i.push(o));var j=[],U=T.uniqueValueInfos.length===i.length?-1:T.uniqueValueInfos.length;if(U>-1)for(var C=U;C<i.length;C++)j.push(l({},i[C]));return t&&t.visualVariables&&t.visualVariables.length&&(T.visualVariables=t.visualVariables.map(function(e){return e.clone()})),{renderer:T,uniqueValueInfos:i,excludedUniqueValueInfos:j,typeScheme:f.cloneScheme(g),basemapId:h.basemapId}}function M(e,r){var l=e.uniqueValueInfos,t=w({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r}),o=t&&t.scheme,n="point-cloud-class"===o.theme,a=n?o.colors:p.createColors(o.colors,l.length);return V(l,"value"),l.map(function(e,r){var l=e.value,t=null;return n?(t=a[l])||(t=a[a.length-1]):t=a[r],{values:[l],color:t,label:e.label}})}function q(e){return o(this,void 0,void 0,function(){var r,l,o,n,a,i;return t(this,function(t){switch(t.label){case 0:return[4,h(e)];case 1:return r=t.sent(),l={layer:r.layer,field:r.field,valueExpression:r.valueExpression,returnAllCodedValues:r.returnAllCodedValues,view:r.view},o={layer:r.layer,view:r.view},[4,d.all([null!=r.statistics?r.statistics:y(l),r.outlineOptimizationEnabled?c(o):null])];case 2:return n=t.sent(),a=n[0],i=n[1],[2,I(a,r,i)]}})})}function z(e){return g(e).then(function(e){return(null!=e.statistics?d.resolve(e.statistics):y({layer:e.layer,field:e.field})).then(function(r){return{renderer:new i.PointCloudUniqueValueRenderer({field:e.field,pointsPerInch:e.density,pointSizeAlgorithm:p.getPointSizeAlgorithm(e.size),colorUniqueValueInfos:M(r,e.typeScheme)})}})})}Object.defineProperty(r,"__esModule",{value:!0});var L="date";r.createRenderer=q,r.createPCClassRenderer=z});