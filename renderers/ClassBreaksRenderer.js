// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/next/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/assignHelper","../symbols","../symbols","../core/jsonMap","../core/lang","../core/Logger","../core/promiseUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","./support/ClassBreakInfo","./support/LegendOptions","../support/arcadeOnDemand","../symbols/support/jsonUtils"],function(e,t,r,o,a,n,s,l,i,u,p,c,f,d,y,m,h,b,g,v,k,I,B){var S=f.getLogger("esri.renderers.ClassBreaksRenderer"),x=new p.default({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),w=m.ensureType(v.ClassBreakInfo);return function(e){function t(t){var r=e.call(this)||this;return r.backgroundFillSymbol=null,r.classBreakInfos=null,r.defaultLabel=null,r.defaultSymbol=null,r.field=null,r.isMaxInclusive=!0,r.legendOptions=null,r.normalizationField=null,r.normalizationTotal=null,r.type="class-breaks",r.valueExpression=null,r.valueExpressionTitle=null,r._set("classBreakInfos",[]),r}r(t,e),p=t,Object.defineProperty(t.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!0,configurable:!0}),t.prototype.readClassBreakInfos=function(e,t,r){if(Array.isArray(e)){var o=t.minValue;return e.map(function(e){var t=new v.ClassBreakInfo;return t.read(e,r),null==t.minValue&&(t.minValue=o),null==t.maxValue&&(t.maxValue=t.minValue),o=t.maxValue,t})}},t.prototype.writeClassBreakInfos=function(e,t,r,o){var a=e.map(function(e){return e.write({},o)});this._areClassBreaksConsecutive()&&a.forEach(function(e){return delete e.classMinValue}),t[r]=a},t.prototype.readDefaultSymbol=function(e,t,r){return B.read(e,t,r)},t.prototype.writeDefaultSymbolWebScene=function(e,t,r,o){B.writeTarget(e,t,r,o)},t.prototype.writeDefaultSymbol=function(e,t,r,o){B.writeTarget(e,t,r,o)},t.prototype.castField=function(e){return null==e?e:"function"==typeof e?(S.error(".field: field must be a string value"),null):m.ensureString(e)},Object.defineProperty(t.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalizationType",{get:function(){var e=this._get("normalizationType"),t=!!this.normalizationField,r=null!=this.normalizationTotal;return t||r?(e=t&&"field"||r&&"percent-of-total"||null,t&&r&&S.warn("warning: both normalizationField and normalizationTotal are set!")):"field"!==e&&"percent-of-total"!==e||(e=null),e},set:function(e){this._set("normalizationType",e)},enumerable:!0,configurable:!0}),t.prototype.addClassBreakInfo=function(e,t,r){var o=null;o="number"==typeof e?new v.ClassBreakInfo({minValue:e,maxValue:t,symbol:r}):w(c.clone(e)),this.classBreakInfos.push(o),1===this.classBreakInfos.length&&this.notifyChange("minValue")},t.prototype.removeClassBreakInfo=function(e,t){for(var r=this.classBreakInfos.length,o=0;o<r;o++){var a=[this.classBreakInfos[o].minValue,this.classBreakInfos[o].maxValue];if(a[0]===e&&a[1]===t){this.classBreakInfos.splice(o,1);break}}},t.prototype.getBreakIndex=function(e,t){return this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)},t.prototype.getClassBreakInfo=function(e,t){return s(this,void 0,void 0,function(){var r,o,a;return n(this,function(n){switch(n.label){case 0:return r=t,this.valueExpression?[4,I.loadArcade()]:[3,2];case 1:o=n.sent().arcadeUtils,r=l({},r,{arcadeUtils:o}),n.label=2;case 2:return a=this.getBreakIndex(e,r),[2,-1!==a?this.classBreakInfos[a]:null]}})})},t.prototype.getSymbol=function(e,t){if(this.valueExpression&&(!t||!t.arcadeUtils))return void S.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");var r=this.getBreakIndex(e,t);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol},t.prototype.getSymbolAsync=function(e,t){return s(this,void 0,void 0,function(){var r,o,a;return n(this,function(n){switch(n.label){case 0:return r=t,this.valueExpression?[4,I.loadArcade()]:[3,2];case 1:o=n.sent().arcadeUtils,r=l({},r,{arcadeUtils:o}),n.label=2;case 2:return a=this.getBreakIndex(e,r),[2,a>-1?this.classBreakInfos[a].symbol:this.defaultSymbol]}})})},t.prototype.getSymbols=function(){var e=[];return this.classBreakInfos.forEach(function(t){t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(e,t){return e+t.getAttributeHash()},"")},t.prototype.getMeshHash=function(){var e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),r=this.normalizationField+"."+this.normalizationType+"."+this.normalizationTotal;return e+"."+t+"."+this.classBreakInfos.reduce(function(e,t){return e+t.getMeshHash()},"")+"."+r+"."+this.field+"."+this.valueExpression},t.prototype.clone=function(){return new p({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:c.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:c.clone(this.visualVariables),legendOptions:c.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},t.prototype.collectRequiredFields=function(e,t){return s(this,void 0,void 0,function(){var r;return n(this,function(o){switch(o.label){case 0:return r=this.getSymbols().map(function(r){return r.collectRequiredFields(e,t)}).concat([this.collectVVRequiredFields(e,t),h.collectArcadeFieldNames(e,t,this.valueExpression)]),h.collectField(e,t,this.field),h.collectField(e,t,this.normalizationField),[4,d.all(r)];case 1:return o.sent(),[2]}})})},t.prototype._getBreakIndexForExpression=function(e,t){var r=t.arcadeUtils,o=t.viewingMode,a=t.scale,n=t.spatialReference,s=this._cache.compiledFunc;if(!s){var l=r.createSyntaxTree(this.valueExpression);s=r.createFunction(l),this._cache.compiledFunc=s}var i=r.executeFunction(s,r.createExecContext(e,r.getViewInfo({viewingMode:o,scale:a,spatialReference:n})));return this._getBreakIndexfromInfos(i)},t.prototype._getBreakIndexForField=function(e){var t=this.field,r=e.attributes,o=this.normalizationType,a=parseFloat(r[t]);if(o){var n=this.normalizationTotal,s=parseFloat(r[this.normalizationField]);if("log"===o)a=Math.log(a)*Math.LOG10E;else if("percent-of-total"!==o||isNaN(n)){if("field"===o&&!isNaN(s)){if(isNaN(a)||isNaN(s))return-1;a/=s}}else a=a/n*100}return this._getBreakIndexfromInfos(a)},t.prototype._getBreakIndexfromInfos=function(e){var t=this.isMaxInclusive;if(null!=e&&"number"==typeof e&&!isNaN(e))for(var r=0;r<this.classBreakInfos.length;r++){var o=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(o[0]<=e&&(t?e<=o[1]:e<o[1]))return r}return-1},t.prototype._areClassBreaksConsecutive=function(){for(var e=this.classBreakInfos,t=e.length,r=1;r<t;r++)if(e[r-1].maxValue!==e[r].minValue)return!1;return!0};var p;return o([y.property({readOnly:!0,dependsOn:["valueExpression"]})],t.prototype,"_cache",null),o([y.property({types:{base:i.BaseSymbol,key:"type",typeMap:{"simple-fill":u.symbolTypesRenderer.typeMap["simple-fill"],"picture-fill":u.symbolTypesRenderer.typeMap["picture-fill"],"polygon-3d":u.symbolTypesRenderer.typeMap["polygon-3d"]}},json:{origins:{"web-scene":{type:i.PolygonSymbol3D,read:B.read,write:B.writeTarget}},read:B.read,write:B.writeTarget}})],t.prototype,"backgroundFillSymbol",void 0),o([y.property({type:[v.ClassBreakInfo]})],t.prototype,"classBreakInfos",void 0),o([y.reader("classBreakInfos")],t.prototype,"readClassBreakInfos",null),o([y.writer("classBreakInfos")],t.prototype,"writeClassBreakInfos",null),o([y.property({type:String,json:{write:!0}})],t.prototype,"defaultLabel",void 0),o([y.property({types:u.symbolTypesRenderer})],t.prototype,"defaultSymbol",void 0),o([y.reader("defaultSymbol")],t.prototype,"readDefaultSymbol",null),o([y.writer("web-scene","defaultSymbol",{defaultSymbol:{types:u.symbolTypesRenderer3D}})],t.prototype,"writeDefaultSymbolWebScene",null),o([y.writer("defaultSymbol")],t.prototype,"writeDefaultSymbol",null),o([y.property({type:String,json:{write:!0}})],t.prototype,"field",void 0),o([y.cast("field")],t.prototype,"castField",null),o([y.property({type:Boolean})],t.prototype,"isMaxInclusive",void 0),o([y.property({type:k.default,json:{write:!0}})],t.prototype,"legendOptions",void 0),o([y.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],t.prototype,"minValue",null),o([y.property({type:String,json:{write:!0}})],t.prototype,"normalizationField",void 0),o([y.property({type:Number,cast:function(e){return m.ensureNumber(e)},json:{write:!0}})],t.prototype,"normalizationTotal",void 0),o([y.property({type:x.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:x.jsonValues,read:x.read,write:x.write}})],t.prototype,"normalizationType",null),o([y.enumeration.serializable()({classBreaks:"class-breaks"})],t.prototype,"type",void 0),o([y.property({type:String,json:{write:!0}})],t.prototype,"valueExpression",void 0),o([y.property({type:String,json:{write:!0}})],t.prototype,"valueExpressionTitle",void 0),o([a(2,y.cast(u.ensureType))],t.prototype,"addClassBreakInfo",null),t=p=o([y.subclass("esri.renderers.ClassBreaksRenderer")],t)}(y.declared(g.VisualVariablesMixin(b)))});